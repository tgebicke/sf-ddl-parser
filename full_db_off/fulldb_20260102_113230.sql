create or replace database BUS_CYBER_RISK_MANAGEMENT COMMENT='A separate data repository that is structured to provide focused processing of raw CMS IT system security data sourced from the CMS Security Data Lake (SDL). The SDL ingests raw security sensor data, which requires necessary data transformation and processing to serve CMS business needs. The DW performs CMS IT unique asset matching, data parsing, data enrichment, data quality checks, and other processing that is necessary to support risk-based business operations, including supporting security and compliance dashboarding and reporting. The DW is deployed within the CMS ecosystem connected to the SDL. The DW extracts a subset of SDL data via Snowflake queries where it is then staged and processed. The DW also has a reporting process for business and stakeholder use.';

create or replace schema BACKUP COMMENT='Schema used to backup objects before major changes occur';

create or replace TABLE ASSET_SOFTWARE_240723_1611 (
	DW_SWAM_ID NUMBER(38,0),
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	INSERT_DATE TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	SWAM_CATEGORY VARCHAR(16777216),
	SWAM_SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216)
);
create or replace TABLE ASSET_SOFTWARE_250117 (
	DW_SWAM_ID NUMBER(38,0),
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	INSERT_DATE TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	SWAM_CATEGORY VARCHAR(16777216),
	SWAM_SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216)
);
create or replace TABLE DEVICETYPES_240729 (
	DEVICEROLE VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	IS_CANBETAGGEDWITHFISMAID BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	IS_WORKSTATIONORSERVER BOOLEAN,
	COMMENTS VARCHAR(16777216)
);
create or replace TABLE MISP_CROSSWALK_240605 (
	BOUNDARY_ENVIRONMENT VARCHAR(16777216),
	MISP_CONTRACTOR VARCHAR(16777216),
	MISP_TAG VARCHAR(16777216),
	MISP_TAGGING_POC VARCHAR(16777216)
);
create or replace TABLE REPORT_IDS_PRIOR_TO_ROLLOUT (
	REPORT_ID NUMBER(38,0),
	IS_ENDOFMONTH BOOLEAN,
	REPORT_DATE TIMESTAMP_LTZ(9),
	ASSETS_NOT_SCANNED_LAST3DAYS NUMBER(38,0),
	ASSETS_NEVER_SCANNED NUMBER(38,0),
	ASSETS_UNKNOWN_DEVICETYPE NUMBER(38,0),
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID NUMBER(38,0),
	DUPLICATE_DATACENTER_TATTOO_PAIR NUMBER(38,0),
	COMMENTS VARCHAR(16777216),
	ASSETS NUMBER(38,0),
	SYSTEMS_INITIATE NUMBER(38,0),
	SYSTEMS_OPERATE NUMBER(38,0),
	SYSTEMS_RETIRE NUMBER(38,0),
	SYSTEMS_DEVELOP NUMBER(38,0),
	VUL_FIXED_TODAY NUMBER(38,0),
	VUL_OPEN NUMBER(38,0),
	VUL_REOPENED NUMBER(38,0),
	VUL_CRITICAL NUMBER(38,0),
	VUL_MEDIUM NUMBER(38,0),
	VUL_HIGH NUMBER(38,0),
	VUL_LOW NUMBER(38,0),
	VUL_DELETED_TODAY NUMBER(38,0),
	VUL_INACTIVE_ASSET_TODAY NUMBER(38,0),
	ASSETS_CREATED_TODAY NUMBER(38,0),
	ASSETS_DELETED_TODAY NUMBER(38,0),
	ASSETS_AWS NUMBER(38,0),
	ASSETS_AWS_GOVCLOUD NUMBER(38,0),
	VUL_AWS NUMBER(38,0),
	VUL_GOVCLOUD NUMBER(38,0),
	PLUGINS_CREATED_TODAY NUMBER(38,0),
	PLUGINS_DELETED_TODAY NUMBER(38,0),
	PLUGINS_FIXED_TODAY NUMBER(38,0),
	PLUGINS_OPEN NUMBER(38,0),
	PLUGINS_REOPENED NUMBER(38,0),
	PLUGINS_CRITICAL NUMBER(38,0),
	PLUGINS_MEDIUM NUMBER(38,0),
	PLUGINS_HIGH NUMBER(38,0),
	PLUGINS_LOW NUMBER(38,0),
	PLUGINS_INACTIVE_ASSET_TODAY NUMBER(38,0),
	IS_VIABLE BOOLEAN
);
create or replace TABLE TEMP_ASSETSOFTWARE_250117_1714 (
	ID NUMBER(38,0),
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	SWAM_CATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216)
);
create or replace TABLE TEMP_HWAM (
	TEMP_HWAM_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID ARRAY,
	CLOUD_ID ARRAY,
	CLOUD_PROVIDER ARRAY,
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATECOMPLETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DEVICE_TYPE VARCHAR(16777216),
	DEVICEMODEL VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	ELAPSEDMILLISECONDSTOPROCESS NUMBER(38,0),
	ENVIRONMENT VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FQDN ARRAY,
	HOSTNAME ARRAY,
	INSTANCESTATUS VARCHAR(16777216),
	IPV4 ARRAY,
	IPV6 ARRAY,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTFOUND TIMESTAMP_LTZ(9),
	MACADDRESS ARRAY,
	MATCHMETHOD VARCHAR(16777216),
	MATCHORDER NUMBER(3,0),
	MOTHERBOARD VARCHAR(16777216),
	NETBIOSNAME ARRAY,
	OS VARCHAR(16777216),
	OS_TYPE_DISTRIBUTION_PREFERRED VARCHAR(16777216),
	OS_TYPE_PREFERRED VARCHAR(16777216),
	RAW_ID NUMBER(38,0),
	ROWDISPOSITION VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VIRTUAL_HOST ARRAY,
	FISMA_UUID VARCHAR(16777216),
	CMR_DW_ASSET_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	NORMALIZED_HOSTNAME ARRAY,
	NORMALIZED_MACADDRESS ARRAY,
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	CMR_MATCHMETHOD VARCHAR(16777216),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN
);
create or replace view VW_APP_ARCHER_ALLOCATEDCONTROL_250227_1401(
	ALLOCATION_STATUS,
	CONTROL_ELEMENT,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	HYBRID_CONTROL,
	INHERITABLE_BY_OTHER_SYSTEMS,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	RESPONSIBILITY,
	SHARED_IMP_UPDATED_DATE,
	SIGNIFICANT_CONTROL_CHANGE,
	SYSTEM_ID,
	TRACKING_ID
) COMMENT='APP_ARCHER (CFACTS) Parent level view of controls allocated to a system.'
 as 
SELECT
ac.ALLOCATION_STATUS[0]::varchar as ALLOCATION_STATUS
,ac.CONTROL as CONTROL_ELEMENT
--,ac.CONTROL_ELEMENT_NUMBER as CONTROL_ELEMENT_NUMBER -- Has enhancement e.g. PM-03a
,ac.CONTROL_FAMILY[0]::varchar as CONTROL_FAMILY
,ac.CONTROL_NAME as CONTROL_NAME
,ac.CONTROL_NUMBER as CONTROL_NUMBER
,ac.CONTROL_NUMBER_COMBO as CONTROL_NUMBER_COMBO
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER 
,ac.ALLOCATED__HYBRID_YES[0]::varchar as HYBRID_CONTROL
,ac.INHERITABLE[0]::varchar as INHERITABLE_BY_OTHER_SYSTEMS
,ac.LAST_ACT_DATE as LAST_ACT_DATE
,ac.ASSESSMENT_DATE as LAST_ASSESSMENT_DATE
,ac.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ac.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_SCA_DATE
,ac.OVERALL_CONTROL_STATUS[0]::varchar as OVERALL_CONTROL_STATUS
,ac.IMPLEMENTATION_LAST_UPDATED as PRIVATE_IMP_UPDATED_DATE
,ac.IMPLEMENTATION_DETAILS as PRIVATE_IMPLEMENTATION_DETAILS
,ac.RESPONSIBILITY as RESPONSIBILITY
,ac.SHARED_IMPLEMENTATION_DETAILS_UPDATED_ as SHARED_IMP_UPDATED_DATE
,ac.SIGNIFICANT_CONTROL_CHANGE[0]::varchar as SIGNIFICANT_CONTROL_CHANGE -- Y/N in APP_CFACTS
--,ac.SIGNIFICANT_CONTROL_CHANGE_DETAILS as SIGNIFICANT_CONTROL_CHANGE_DETAILS -- APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS
,ap.IDUID as SYSTEM_ID
,ac.TRACKING_ID as TRACKING_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac.FISMA_ID = ap.IDUID



;
create or replace view VW_APP_ARCHER_SYSTEMS_250226_0906(
	DUMMY,
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	AUTH_DECISION,
	AUTHORIZATION_PACKAGE_NAME,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_LEVEL,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_NAME,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	ISRA_STATUS,
	ISSO,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='APP_ARCHER (CFACTS) System detail'
 as
WITH
W_BO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CIO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_COMPRISK as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES -- Component Report POC
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),  
W_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DCISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSOCS as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SCA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SDM as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID)

SELECT
'DUMMY' as DUMMY
,ap.ACRONYM as ACRONYM
,ap.ACTUAL_DECOMMISION_DATE as ACTUAL_DECOMMISION_DATE
,ap._content_id as ARCHER_TRACKING_ID
,ap.ATO_IATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE
--,ap.ATO_REVIEW_DATE as ATO_REVIEW_DATE
--,ap.AUTH_COMMENTS as AUTH_COMMENTS
,ap.AUTHORIZATION_DECISION[0]::varchar as AUTH_DECISION
--,ap.AUTHORIZATION_MEMO_SIGNED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE
,ap.AUTHORIZATION_PACKAGE_NAME as AUTHORIZATION_PACKAGE_NAME
--,ap.BO_RECOMMENDATION_REVIEW_DATE as BO_RECOMMENDATION_REVIEW_DATE
--,ap.BO_REVIEW_DATE as BO_REVIEW_DATE
,bo.USER_NAMES as BUSINESS_OWNER
,cio.USER_NAMES as CIO
,ciso.USER_NAMES as CISO
,ra.CISO_REVIEW_DATE as CISO_REVIEW_DATE
--,ap.CLOUD_SERVICE_PROVIDER as CLOUD_SERVICE_PROVIDER
,ap.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,comp.DESCRIPTION as COMPONENT_DESCRIPTION
,ap.COMPONENT_NAME_ as COMPONENT_NAME
,cro.USER_NAMES as COMPONENT_RISK_REPORTS_OVERSIGHT
,ap.LAST_CONTINGENCY_PLAN_EXPIRATION_DATE as CONTINGENCYEXPIRATIONDATE
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,ap.LAST_CONTINGENCY_PLAN_TEST_DATE as CP_TEST_DATE
,ap.CONTINGENCY_PLAN_TEST_RESULTS[0]::varchar as CP_TEST_RESULTS
,cra.USER_NAMES as CRA
,ato.CRA_SUBMITTED_DATE as CRA_REVIEW_DATE
,pcra.USER_NAMES as CYBERVET -- This differs from CRA in CFACTS view. Is it same as DSPC_POC / Primary Cyber Risk Advisor (CRA)
,ato.PACKAGE_ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES
,ac.DATE_AUTHORIZATION_MEMO_SIGNED as DATE_AUTH_MEMO_SIGNED
,dciso.USER_NAMES as DCISO
,div.DIVISION_ACRONYM as DIVISION_ACRONYM
,div.DESCRIPTION as DIVISION_DESCRIPTION
,ap.DIVISION_NAME as DIVISION_NAME
,ra.DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,ato.DSPPO_APPROVED_DATE as DSPPO_REVIEW_DATE
--,ap.E_AUTH_EXP_DATE as E_AUTH_EXP_DATE
,ap.EAUTHENTICATION_LEVEL[0]::varchar as E_AUTH_LEVEL
--,ap.E_AUTH_RISK_ASSESSMENT_DATE as E_AUTH_RISK_ASSESSMENT_DATE
,ap.FINANCIAL_SYSTEM[0]::varchar as FINANCIAL_SYSTEM
,infotype.AVAILABILITY_RATING[0]::varchar as FIPS_199_AVAILABILITY_RATING
,infotype.CONFIDENTIALITY_RATING as FIPS_199_CONFIDENTIALITY_RATING
,infotype.INTEGRITY_RATING as FIPS_199_INTEGRITY_RATING
,infotype.CRITICALITY_RATING as FIPS_199_OVERALL_IMPACT_RATING
,ap.FIRST_PUBLISHED as FIRST_PUBLISHED_DATE
,ap.FISMA_REPORTABLE[0]::varchar as FISMA_SYSTEM
--,grp.GROUP_ACRONYM as GROUP_ACRONYM
--,grp.DESCRIPTION as GROUP_DESCRIPTION
,ap.GROUP_NAME as GROUP_NAME
--,ap.HVA_SCORE as HVA_SCORE
,ap.IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST[0]::varchar as HVASTATUS
,ap.INFORMATION_SYSTEM_TYPE[0]::varchar as INFORMATION_SYSTEM_TYPE
,ap.MARKETPLACE_SYSTEMS[0]::varchar as IS_MARKETPLACE
--,ap.IS_OA_READY as IS_OA_READY -- NO LONGER NEEDED BECAUSE SDW DETERMINES THIS
--,ap.ISRA_REVIEW_DATE as ISRA_REVIEW_DATE
,ap.ISRA_STATUS[0]::varchar as ISRA_STATUS
,isso.USER_NAMES as ISSO
--,ap.ISSO_COUNT as ISSO_COUNT
,ato.ISSO_REQUEST_REVIEW_DATE as ISSO_REVIEW_DATE
,ato.ISSO_SUBMITTED_DATE as ISSO_SUBMISSION_DATE
,issocs.USER_NAMES as ISSOCS
,ap.LAST_ACT_DATE as LAST_ACT_DATE
,ap.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,ap.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,ap.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,ap.LAST_PENTEST_DATE as LAST_PENTEST_DATE
--,ap.MEF as MEF
--,ap.MEF_CONTEXT as MEF_CONTEXT
,ap.NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE as NEXT_REQUIRED_CP_TEST_DATE
,ap.OA_STATUS[0]::varchar as OA_STATUS
,ap.OPERATED_BY[0]::varchar as OPERATED_BY
,ap.PACKAGE_TYPE[0]::varchar as PACKAGE_TYPE
,pia.PIA014__PII as PIA_014
,ap.PIA_EXPIRATION_DATE as PIA_EXPIRATION_DATE
,pisso.USER_NAMES as PRIMARY_ISSO
,ARRAY_TO_STRING(ap.OPERATING_LOCATION,',') as PRIMARY_OPERATING_LOCATION
,ato.REASON_FOR_ATO_REQUEST as REASON_FOR_ATO_REQUEST
,sca.USER_NAMES as SCA
,ap.SCA_DATE as SCA_DATE
,sdm.USER_NAMES as SDM
--,ap.SOP_REVIEW_DATE as SOP_REVIEW_DATE
,ap.STE_DATE as STE_DATE
,ap.SYSTEMDESCRIPTION_TRUNCATED as SYSTEM_DESCRIPTION
,ap.IDUID as SYSTEM_ID
,ap.TLC_PHASE[0]::varchar as TLC_PHASE
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT infotype on infotype._content_id = ap._CONTENT_ID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT ato on ato._content_id = ap._CONTENT_ID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac._content_id = ap._CONTENT_ID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_COMPONENT_REPORT comp on comp.component_acronym = ap.component_acronym
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT div on div.division = ap.division_name
--LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_GROUP_REPORT grp on grp.group_name = ap.group_name

LEFT OUTER JOIN W_BO bo on bo.IDUID = ap.IDUID
LEFT OUTER JOIN W_CIO cio on cio.IDUID = ap.IDUID
LEFT OUTER JOIN W_CISO ciso on ciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_COMPRISK cro on cro.IDUID = ap.IDUID
LEFT OUTER JOIN W_CRA cra on cra.IDUID = ap.IDUID
LEFT OUTER JOIN W_DCISO dciso on dciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSO isso on isso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSOCS issocs on issocs.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT pia on pia._CONTENT_ID = ap._CONTENT_ID
LEFT OUTER JOIN W_PRIMARY_CRA pcra on pcra.IDUID = ap.IDUID
LEFT OUTER JOIN W_PRIMARY_ISSO pisso on pisso.IDUID = ap.IDUID
LEFT OUTER JOIN W_SCA sca on sca.IDUID = ap.IDUID
LEFT OUTER JOIN W_SDM sdm on sdm.IDUID = ap.IDUID

LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_RISK_ACCEPTANCE_RBD_REPORT ra on ra.SYSTEM_TRACKING_ID = ap._content_id
WHERE ap.IDUID IS NOT NULL
;
create or replace view VW_APP_ARCHER_SYSTEMS_250227_1347(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_LEVEL,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='APP_ARCHER (CFACTS) System detail'
 as
WITH
W_ATO as (-- There can be multiple records per FISMA System so find the most current
    select t.*
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT t
    JOIN (select rank()over(partition by IDUID order by _content_id desc) TheRank,_content_id
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT) r1 on r1._content_id = t._content_id 
    WHERE r1.TheRank = 1),
W_BO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CIO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_COMPRISK as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES -- Component Report POC
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),  
W_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DCISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_INFOTYPES as (select infotypes.*,f.value:ContentId::string as system_contentId
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT infotypes
    join table(flatten(AUTHORIZATION_PACKAGE,outer=>true)) as f),
W_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSOCS as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SCA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SDM as (SELECT IDUID, listagg(u.DISPLAYNAME,',') as USER_NAMES
    from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
    JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID)

SELECT
--
-- TODO
-- Resolve multiple ATO records
-- Resolve multiple GROUP records
-- Resolve multiple __REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT records
-- Resolve CLOUD_SERVICE_PROVIDER
-- Resolve E_AUTH_EXP_DATE
-- Resolve E_AUTH_RISK_ASSESSMENT_DATE
-- Resolve HVA_SCORE
-- Resolve SOP_REVIEW_DATE
--
ap.ACRONYM as ACRONYM
,ap.ACTUAL_DECOMMISION_DATE as ACTUAL_DECOMMISION_DATE
,ap._content_id as ARCHER_TRACKING_ID
,ato.PACKAGE_ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE
,ato.ATO_MEMO_DATE as ATO_REVIEW_DATE
,ato.ATO_MEMO_TEXT as AUTH_COMMENTS
,ap.AUTHORIZATION_DECISION[0]::varchar as AUTH_DECISION
,ac.DATE_AUTHORIZATION_MEMO_SIGNED as AUTHORIZATION_MEMO_SIGNED_DATE
,ap.AUTHORIZATION_PACKAGE_NAME as AUTHORIZATION_PACKAGE_NAME
,ato.BUSINESS_OWNER_APPROVED_DATE as BO_RECOMMENDATION_REVIEW_DATE
,ra.BUSINESS_OWNER_REVIEW_DATE as BO_REVIEW_DATE
,bo.USER_NAMES as BUSINESS_OWNER
,cio.USER_NAMES as CIO
,ciso.USER_NAMES as CISO
,ra.CISO_REVIEW_DATE as CISO_REVIEW_DATE
--,ap.CLOUD_SERVICE_PROVIDER as CLOUD_SERVICE_PROVIDER -- Maybe __REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT.CONTROL_PROVIDER
,ap.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,comp.DESCRIPTION as COMPONENT_DESCRIPTION
,ap.COMPONENT_NAME_ as COMPONENT_NAME
,cro.USER_NAMES as COMPONENT_RISK_REPORTS_OVERSIGHT
,ap.LAST_CONTINGENCY_PLAN_EXPIRATION_DATE as CONTINGENCYEXPIRATIONDATE
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,ap.LAST_CONTINGENCY_PLAN_TEST_DATE as CP_TEST_DATE
,ap.CONTINGENCY_PLAN_TEST_RESULTS[0]::varchar as CP_TEST_RESULTS
,cra.USER_NAMES as CRA
,ato.CRA_SUBMITTED_DATE as CRA_REVIEW_DATE
,pcra.USER_NAMES as CYBERVET -- This differs from CRA in CFACTS view. Is it same as DSPC_POC / Primary Cyber Risk Advisor (CRA)
,ato.PACKAGE_ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES
,ac.DATE_AUTHORIZATION_MEMO_SIGNED as DATE_AUTH_MEMO_SIGNED
,dciso.USER_NAMES as DCISO
,div.DIVISION_ACRONYM as DIVISION_ACRONYM
,div.DESCRIPTION as DIVISION_DESCRIPTION
,ap.DIVISION_NAME as DIVISION_NAME
,ra.DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,ato.DSPPO_APPROVED_DATE as DSPPO_REVIEW_DATE
--,ap.E_AUTH_EXP_DATE as E_AUTH_EXP_DATE
,ap.EAUTHENTICATION_LEVEL[0]::varchar as E_AUTH_LEVEL
--,ap.E_AUTH_RISK_ASSESSMENT_DATE as E_AUTH_RISK_ASSESSMENT_DATE
,ap.FINANCIAL_SYSTEM[0]::varchar as FINANCIAL_SYSTEM
,infotype.AVAILABILITY_RATING[0]::varchar as FIPS_199_AVAILABILITY_RATING
,infotype.CONFIDENTIALITY_RATING[0]::varchar as FIPS_199_CONFIDENTIALITY_RATING
,infotype.INTEGRITY_RATING[0]::varchar as FIPS_199_INTEGRITY_RATING
,cedar.FINAL_SECURITY_CATEGORY[0]::varchar as FIPS_199_OVERALL_IMPACT_RATING
,ap.FIRST_PUBLISHED as FIRST_PUBLISHED_DATE
,ap.FISMA_REPORTABLE[0]::varchar as FISMA_SYSTEM
--,grp.GROUP_ACRONYM as GROUP_ACRONYM
--,grp.DESCRIPTION as GROUP_DESCRIPTION
,ap.GROUP_NAME as GROUP_NAME
,ap.BASELINE_HIGHEST_DEVICE_RISK_SCORE as HVA_SCORE
,ap.IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST[0]::varchar as HVASTATUS
,ap.INFORMATION_SYSTEM_TYPE[0]::varchar as INFORMATION_SYSTEM_TYPE
,ap.MARKETPLACE_SYSTEMS[0]::varchar as IS_MARKETPLACE
--,ap.IS_OA_READY as IS_OA_READY -- NO LONGER NEEDED BECAUSE SDW NOW DETERMINES THIS
,ap.LAST_ISRA_COMPLETION_DATE as ISRA_REVIEW_DATE
,ap.ISRA_STATUS[0]::varchar as ISRA_STATUS
,isso.USER_NAMES as ISSO
,array_size(INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) as ISSO_COUNT
,ato.ISSO_REQUEST_REVIEW_DATE as ISSO_REVIEW_DATE
,ato.ISSO_SUBMITTED_DATE as ISSO_SUBMISSION_DATE
,issocs.USER_NAMES as ISSOCS
,ap.LAST_ACT_DATE as LAST_ACT_DATE
,ap.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,ap.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,ap.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,ap.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ap.IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF[0]::varchar as MEF
,ap.MISSION_ESSENTIAL_FUNCTIONS_ as MEF_CONTEXT -- Multiple values possible
-- MEFStatus is determined in SP_CRM_PULL_CFACTS
,ap.NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE as NEXT_REQUIRED_CP_TEST_DATE
,ap.OA_STATUS[0]::varchar as OA_STATUS
,ap.OPERATED_BY[0]::varchar as OPERATED_BY
,ap.PACKAGE_TYPE[0]::varchar as PACKAGE_TYPE
,pia.PIA014__PII as PIA_014
,ap.PIA_EXPIRATION_DATE as PIA_EXPIRATION_DATE
,pisso.USER_NAMES as PRIMARY_ISSO
,ARRAY_TO_STRING(ap.OPERATING_LOCATION,',') as PRIMARY_OPERATING_LOCATION
,ato.REASON_FOR_ATO_REQUEST as REASON_FOR_ATO_REQUEST
,sca.USER_NAMES as SCA
,ap.SCA_DATE as SCA_DATE
,sdm.USER_NAMES as SDM
--,ap.SOP_REVIEW_DATE as SOP_REVIEW_DATE
,ap.STE_DATE as STE_DATE
,ap.SYSTEMDESCRIPTION_TRUNCATED as SYSTEM_DESCRIPTION
,ap.IDUID as SYSTEM_ID
,ap.TLC_PHASE[0]::varchar as TLC_PHASE
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CEDAR_EASI_INTEGRATION_NO_FILTERS_ cedar on cedar.IDUID = ap.IDUID
--LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT ato on ato.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac._content_id = ap._CONTENT_ID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_COMPONENT_REPORT comp on comp.component_acronym = ap.component_acronym
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT div on div.division = ap.division_name
--LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_GROUP_REPORT grp on grp.group_name = ap.group_name

LEFT OUTER JOIN W_ATO ato on ato.IDUID = ap.IDUID
LEFT OUTER JOIN W_BO bo on bo.IDUID = ap.IDUID
LEFT OUTER JOIN W_CIO cio on cio.IDUID = ap.IDUID
LEFT OUTER JOIN W_CISO ciso on ciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_COMPRISK cro on cro.IDUID = ap.IDUID
LEFT OUTER JOIN W_CRA cra on cra.IDUID = ap.IDUID
LEFT OUTER JOIN W_DCISO dciso on dciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_INFOTYPES infotype on infotype.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_ISSO isso on isso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSOCS issocs on issocs.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT pia on pia._CONTENT_ID = ap._CONTENT_ID
LEFT OUTER JOIN W_PRIMARY_CRA pcra on pcra.IDUID = ap.IDUID
LEFT OUTER JOIN W_PRIMARY_ISSO pisso on pisso.IDUID = ap.IDUID
LEFT OUTER JOIN W_SCA sca on sca.IDUID = ap.IDUID
LEFT OUTER JOIN W_SDM sdm on sdm.IDUID = ap.IDUID

LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_RISK_ACCEPTANCE_RBD_REPORT ra on ra.SYSTEM_TRACKING_ID = ap._content_id
WHERE ap.IDUID IS NOT NULL
;
create or replace view VW_APP_ARCHER_SYSTEMS_250304_0900(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='APP_ARCHER (CFACTS) System detail'
 as
WITH
/*
W_ATO as (-- There can be multiple records per FISMA System so find the most current
    select t.*
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT t
    JOIN (select rank()over(partition by IDUID order by _content_id desc) TheRank,_content_id
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT) r1 on r1._content_id = t._content_id 
    WHERE r1.TheRank = 1),
*/
W_ATO as (select INFORMATION_SYSTEM_OR_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT),    
W_BO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CIO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_COMPRISK as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- Component Report POC
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),  
W_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DCISO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DIVISION as (select division,component_acronym,component_name_,description,division_acronym,group_name
    ,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT
    join table(flatten(AUTHORIZATION_PACKAGES,outer=>true)) as f),
W_INFOTYPES as (select infotypes.*,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT infotypes
    join table(flatten(AUTHORIZATION_PACKAGE,outer=>true)) as f
    where infotypes.information_type = 'Public information' -- 250303 TEMPORARY WHILE TESTING
    ),
W_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- 250303 Sort
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSOCS as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PIA as (select AUTHORIZATION_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT),    
W_PRIMARY_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SCA as (SELECT IDUID ,listagg(GROUP_LIST.value:DisplayName::string,';') as GROUP_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Groups) GROUP_LIST
  GROUP BY IDUID),
W_SDM as (SELECT IDUID, listagg(u.DISPLAYNAME,',') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID)

SELECT
--
-- TODO
-- Resolve multiple ATO records
-- Resolve multiple GROUP records
-- Resolve multiple __REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT records
-- Resolve HVA_SCORE
--
ap.ACRONYM as ACRONYM
,ap.ACTUAL_DECOMMISION_DATE as ACTUAL_DECOMMISION_DATE
,ap._content_id as ARCHER_TRACKING_ID
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

,ato.ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

--,case when try_to_date(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') is not null then TO_DATE(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') Else null end as ATO_REVIEW_DATE
,ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1 as ATO_REVIEW_DATE

,ato.ATO_MEMO_TEXT as AUTH_COMMENTS
,ap.AUTHORIZATION_DECISION[0]::varchar as AUTH_DECISION
-- might be wrong ,ac.DATE_AUTHORIZATION_MEMO_SIGNED as AUTHORIZATION_MEMO_SIGNED_DATE
,ato.CIO_SUBMITTED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE

,ap.AUTHORIZATION_PACKAGE_NAME as AUTHORIZATION_PACKAGE_NAME
-- maybe wrong ,ato.BUSINESS_OWNER_APPROVED_DATE as BO_RECOMMENDATION_REVIEW_DATE

,ato.COPY_OF_BO_REQUEST_REVIEW__DUE_DATE as BO_RECOMMENDATION_REVIEW_DATE

-- maybe wrong ,ra.BUSINESS_OWNER_REVIEW_DATE as BO_REVIEW_DATE

,ato.BO_SUBMITTED_DATE as BO_REVIEW_DATE

,bo.USER_NAMES as BUSINESS_OWNER
,cio.USER_NAMES as CIO
,ciso.USER_NAMES as CISO
-- maybe wrong,ra.CISO_REVIEW_DATE as CISO_REVIEW_DATE

,ato.CISO_SUBMITTED_DATE as CISO_REVIEW_DATE

,array_to_string(ap.CLOUDSERVICEPROVIDERS,',') as CLOUD_SERVICE_PROVIDER -- 250303
,ap.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,comp.DESCRIPTION as COMPONENT_DESCRIPTION
,ap.COMPONENT_NAME_ as COMPONENT_NAME
,cro.USER_NAMES as COMPONENT_RISK_REPORTS_OVERSIGHT
,ap.LAST_CONTINGENCY_PLAN_EXPIRATION_DATE as CONTINGENCYEXPIRATIONDATE
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,ap.LAST_CONTINGENCY_PLAN_TEST_DATE as CP_TEST_DATE
,ap.CONTINGENCY_PLAN_TEST_RESULTS[0]::varchar as CP_TEST_RESULTS
,cra.USER_NAMES as CRA
,ato.CRA_SUBMITTED_DATE as CRA_REVIEW_DATE
,pcra.USER_NAMES as CYBERVET -- This differs from CRA in CFACTS view. Is it same as DSPC_POC / Primary Cyber Risk Advisor (CRA)
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES

,ato.ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES

-- maybe wrong,ac.DATE_AUTHORIZATION_MEMO_SIGNED as DATE_AUTH_MEMO_SIGNED
,ato.ATO_MEMO_DATE as DATE_AUTH_MEMO_SIGNED

,dciso.USER_NAMES as DCISO
,div.DIVISION_ACRONYM as DIVISION_ACRONYM
,div.DESCRIPTION as DIVISION_DESCRIPTION
,ap.DIVISION_NAME as DIVISION_NAME
,ra.DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
-- maybe wrong,ato.DSPC_SUBMITTED_DATE as DSPC_REVIEW_DATE

-- maybe wrong,ato.DSPPO_APPROVED_DATE as DSPPO_REVIEW_DATE

,ato.DSPPO_SUBMITTED_DATE as DSPPO_REVIEW_DATE
,ap.EAUTHENTICATION_EXPIRATION_DATE as E_AUTH_EXP_DATE -- 250303
,ap.EAUTHENTICATION_LEVEL[0]::varchar as E_AUTH_LEVEL
,ap.EAUTHENTICATION_DATE as E_AUTH_RISK_ASSESSMENT_DATE -- 250303
,ap.FINANCIAL_SYSTEM[0]::varchar as FINANCIAL_SYSTEM
,infotype.AVAILABILITY_RATING[0]::varchar as FIPS_199_AVAILABILITY_RATING
,infotype.CONFIDENTIALITY_RATING[0]::varchar as FIPS_199_CONFIDENTIALITY_RATING
,infotype.INTEGRITY_RATING[0]::varchar as FIPS_199_INTEGRITY_RATING
,cedar.FINAL_SECURITY_CATEGORY[0]::varchar as FIPS_199_OVERALL_IMPACT_RATING
,ap.FIRST_PUBLISHED as FIRST_PUBLISHED_DATE
,ap.FISMA_REPORTABLE[0]::varchar as FISMA_SYSTEM
--,grp.GROUP_ACRONYM as GROUP_ACRONYM
--,grp.DESCRIPTION as GROUP_DESCRIPTION
,ap.GROUP_NAME as GROUP_NAME
,ap.BASELINE_HIGHEST_DEVICE_RISK_SCORE as HVA_SCORE
,ap.IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST[0]::varchar as HVASTATUS
,ap.INFORMATION_SYSTEM_TYPE[0]::varchar as INFORMATION_SYSTEM_TYPE
,ap.MARKETPLACE_SYSTEMS[0]::varchar as IS_MARKETPLACE
--,ap.IS_OA_READY as IS_OA_READY -- NO LONGER NEEDED BECAUSE SDW NOW DETERMINES THIS
,ap.LAST_ISRA_COMPLETION_DATE as ISRA_REVIEW_DATE
,ap.ISRA_STATUS[0]::varchar as ISRA_STATUS
,isso.USER_NAMES as ISSO
,array_size(INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) as ISSO_COUNT
,ato.ISSO_REQUEST_REVIEW_DATE as ISSO_REVIEW_DATE
,ato.ISSO_SUBMITTED_DATE as ISSO_SUBMISSION_DATE
,issocs.USER_NAMES as ISSOCS
,ap.LAST_ACT_DATE as LAST_ACT_DATE
,ap.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,ap.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,ap.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,ap.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ap.IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF[0]::varchar as MEF
,ap.MISSION_ESSENTIAL_FUNCTIONS_[0]::varchar as MEF_CONTEXT -- Multiple values possible
-- MEFStatus is determined in SP_CRM_PULL_CFACTS
,ap.NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE as NEXT_REQUIRED_CP_TEST_DATE
,ap.OA_STATUS[0]::varchar as OA_STATUS
,ap.OPERATED_BY[0]::varchar as OPERATED_BY
,ap.PACKAGE_TYPE[0]::varchar as PACKAGE_TYPE
,pia.HELPER_PIA014[0]::varchar as PIA_014
,ap.PIA_EXPIRATION_DATE as PIA_EXPIRATION_DATE
,pisso.USER_NAMES as PRIMARY_ISSO
,ARRAY_TO_STRING(ap.OPERATING_LOCATION,',') as PRIMARY_OPERATING_LOCATION
,ato.REASON_FOR_ATO_REQUEST[0]::varchar as REASON_FOR_ATO_REQUEST
,sca.GROUP_NAMES as SCA
,ap.SCA_DATE as SCA_DATE
,sdm.USER_NAMES as SDM
,ato.SDM_REVIEW_DUE_DATE as SOP_REVIEW_DATE -- 250303 VW_CFACTS_SYSTEMS was using SDM_REVIEW_DUE_DATE
,ap.STE_DATE as STE_DATE
,ap.SYSTEMDESCRIPTION_TRUNCATED as SYSTEM_DESCRIPTION
,ap.IDUID as SYSTEM_ID
,ap.TLC_PHASE[0]::varchar as TLC_PHASE
FROM APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CEDAR_EASI_INTEGRATION_NO_FILTERS_ cedar on cedar.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac._content_id = ap._CONTENT_ID
--
-- ALERT: component_acronym is not unique and component_name is not unique
--
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_COMPONENT_REPORT comp on comp.component_acronym = ap.component_acronym
--
-- Division does appear to be unique
-- LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT div on div.division = ap.division_name
--
-- Alert: group_name is not unique and group_acronym is not unique
--
--LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_GROUP_REPORT grp on grp.group_name = ap.group_name

LEFT OUTER JOIN W_ATO ato on ato.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_BO bo on bo.IDUID = ap.IDUID
LEFT OUTER JOIN W_CIO cio on cio.IDUID = ap.IDUID
LEFT OUTER JOIN W_CISO ciso on ciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_COMPRISK cro on cro.IDUID = ap.IDUID
LEFT OUTER JOIN W_CRA cra on cra.IDUID = ap.IDUID
LEFT OUTER JOIN W_DCISO dciso on dciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_DIVISION div on div.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_INFOTYPES infotype on infotype.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_ISSO isso on isso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSOCS issocs on issocs.IDUID = ap.IDUID
LEFT OUTER JOIN W_PIA pia on pia.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_PRIMARY_CRA pcra on pcra.IDUID = ap.IDUID
LEFT OUTER JOIN W_PRIMARY_ISSO pisso on pisso.IDUID = ap.IDUID
LEFT OUTER JOIN W_SCA sca on sca.IDUID = ap.IDUID
LEFT OUTER JOIN W_SDM sdm on sdm.IDUID = ap.IDUID

LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_RISK_ACCEPTANCE_RBD_REPORT ra on ra.SYSTEM_TRACKING_ID = ap._content_id
WHERE ap.IDUID IS NOT NULL
;
create or replace view VW_APP_ARCHER_SYSTEMS_250304_1321(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	IS_OA_READY,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='APP_ARCHER (CFACTS) System detail'
 as
WITH
/*
W_ATO as (-- There can be multiple records per FISMA System so find the most current
    select t.*
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT t
    JOIN (select rank()over(partition by IDUID order by _content_id desc) TheRank,_content_id
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT) r1 on r1._content_id = t._content_id 
    WHERE r1.TheRank = 1),
*/
W_ATO as (select INFORMATION_SYSTEM_OR_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT),    
W_BO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CIO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CISO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_COMPRISK as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- Component Report POC
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),  
W_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DCISO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DIVISION as (select division,component_acronym,component_name_,description,division_acronym,group_name
    ,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT
    join table(flatten(AUTHORIZATION_PACKAGES,outer=>true)) as f),
W_INFOTYPES as (select infotypes.*,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT infotypes
    join table(flatten(AUTHORIZATION_PACKAGE,outer=>true)) as f
    where tracking_id = 220862 -- Financial, budgetary, commercial, proprietary and trade secret information
    ),
W_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- 250303 Sort
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSOCS as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PIA as (select AUTHORIZATION_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT),    
W_PRIMARY_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SCA as (SELECT IDUID ,listagg(GROUP_LIST.value:DisplayName::string,';') as GROUP_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Groups) GROUP_LIST
  GROUP BY IDUID),
W_SDM as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID)

SELECT
--
-- TODO
-- Resolve multiple ATO records
-- Resolve multiple GROUP records
-- Resolve multiple __REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT records
-- Resolve HVA_SCORE
--
ap.ACRONYM as ACRONYM
,ap.ACTUAL_DECOMMISION_DATE as ACTUAL_DECOMMISION_DATE
,ap._content_id as ARCHER_TRACKING_ID
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

,ato.ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

--,case when try_to_date(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') is not null then TO_DATE(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') Else null end as ATO_REVIEW_DATE
,ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1 as ATO_REVIEW_DATE

,ato.ATO_MEMO_TEXT as AUTH_COMMENTS
,ap.AUTHORIZATION_DECISION[0]::varchar as AUTH_DECISION
-- might be wrong ,ac.DATE_AUTHORIZATION_MEMO_SIGNED as AUTHORIZATION_MEMO_SIGNED_DATE
,ato.CIO_SUBMITTED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE

,ap.AUTHORIZATION_PACKAGE_NAME as AUTHORIZATION_PACKAGE_NAME
-- maybe wrong ,ato.BUSINESS_OWNER_APPROVED_DATE as BO_RECOMMENDATION_REVIEW_DATE

,ato.COPY_OF_BO_REQUEST_REVIEW__DUE_DATE as BO_RECOMMENDATION_REVIEW_DATE

-- maybe wrong ,ra.BUSINESS_OWNER_REVIEW_DATE as BO_REVIEW_DATE

,ato.BO_SUBMITTED_DATE as BO_REVIEW_DATE

,bo.USER_NAMES as BUSINESS_OWNER
,cio.USER_NAMES as CIO
,ciso.USER_NAMES as CISO
-- maybe wrong,ra.CISO_REVIEW_DATE as CISO_REVIEW_DATE

,ato.CISO_SUBMITTED_DATE as CISO_REVIEW_DATE

,array_to_string(ap.CLOUDSERVICEPROVIDERS,',') as CLOUD_SERVICE_PROVIDER -- 250303
,ap.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,comp.DESCRIPTION as COMPONENT_DESCRIPTION
,ap.COMPONENT_NAME_ as COMPONENT_NAME
,cro.USER_NAMES as COMPONENT_RISK_REPORTS_OVERSIGHT
,ap.LAST_CONTINGENCY_PLAN_EXPIRATION_DATE as CONTINGENCYEXPIRATIONDATE
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,ap.LAST_CONTINGENCY_PLAN_TEST_DATE as CP_TEST_DATE
,ap.CONTINGENCY_PLAN_TEST_RESULTS[0]::varchar as CP_TEST_RESULTS
,cra.USER_NAMES as CRA
,ato.CRA_SUBMITTED_DATE as CRA_REVIEW_DATE
,pcra.USER_NAMES as CYBERVET -- This differs from CRA in CFACTS view. Is it same as DSPC_POC / Primary Cyber Risk Advisor (CRA)
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES

,ato.ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES
,case when try_to_date(ato.ATO_MEMO_DATE,'MMMM DD, YYYY') is not null then TO_DATE(ato.ATO_MEMO_DATE,'MMMM DD, YYYY') Else null end as DATE_AUTH_MEMO_SIGNED
,dciso.USER_NAMES as DCISO
,div.DIVISION_ACRONYM as DIVISION_ACRONYM
,CORE.FN_CRM_CLEANSTRING(div.DESCRIPTION) as DIVISION_DESCRIPTION
,ap.DIVISION_NAME as DIVISION_NAME
-- maybe wrong,ra.DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,ato.DSPC_SUBMITTED_DATE as DSPC_REVIEW_DATE

-- maybe wrong,ato.DSPPO_APPROVED_DATE as DSPPO_REVIEW_DATE

,ato.DSPPO_SUBMITTED_DATE as DSPPO_REVIEW_DATE
,ap.EAUTHENTICATION_EXPIRATION_DATE as E_AUTH_EXP_DATE -- 250303
,ap.EAUTHENTICATION_LEVEL[0]::varchar as E_AUTH_LEVEL
,ap.EAUTHENTICATION_DATE as E_AUTH_RISK_ASSESSMENT_DATE -- 250303
,ap.FINANCIAL_SYSTEM[0]::varchar as FINANCIAL_SYSTEM
,infotype.AVAILABILITY_RATING[0]::varchar as FIPS_199_AVAILABILITY_RATING
,infotype.CONFIDENTIALITY_RATING[0]::varchar as FIPS_199_CONFIDENTIALITY_RATING
,infotype.INTEGRITY_RATING[0]::varchar as FIPS_199_INTEGRITY_RATING
,cedar.FINAL_SECURITY_CATEGORY[0]::varchar as FIPS_199_OVERALL_IMPACT_RATING
,ap.FIRST_PUBLISHED as FIRST_PUBLISHED_DATE
,ap.FISMA_REPORTABLE[0]::varchar as FISMA_SYSTEM
,'FAKE' as GROUP_ACRONYM
,'FAKE' as GROUP_DESCRIPTION
,ap.GROUP_NAME as GROUP_NAME
,ap.BASELINE_HIGHEST_DEVICE_RISK_SCORE as HVA_SCORE
,ap.IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST[0]::varchar as HVASTATUS
,ap.INFORMATION_SYSTEM_TYPE[0]::varchar as INFORMATION_SYSTEM_TYPE

,case IFNULL(ap.MARKETPLACE_SYSTEMS[0]::varchar,'0') When 'Yes' then '1' Else '0' End as IS_MARKETPLACE

,NULL as IS_OA_READY -- NO LONGER NEEDED BECAUSE SDW NOW DETERMINES THIS
,ap.LAST_ISRA_COMPLETION_DATE as ISRA_REVIEW_DATE
,ap.ISRA_STATUS[0]::varchar as ISRA_STATUS
,isso.USER_NAMES as ISSO
,array_size(INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) as ISSO_COUNT
,ato.ISSO_REQUEST_REVIEW_DATE as ISSO_REVIEW_DATE
,ato.ISSO_SUBMITTED_DATE as ISSO_SUBMISSION_DATE
,issocs.USER_NAMES as ISSOCS
,ap.LAST_ACT_DATE as LAST_ACT_DATE
,ap.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,ap.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,ap.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,ap.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ap.IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF[0]::varchar as MEF
,ap.MISSION_ESSENTIAL_FUNCTIONS_[0]::varchar as MEF_CONTEXT -- Multiple values possible
-- MEFStatus is determined in SP_CRM_PULL_CFACTS
,ap.NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE as NEXT_REQUIRED_CP_TEST_DATE
,ap.OA_STATUS[0]::varchar as OA_STATUS
,ap.OPERATED_BY[0]::varchar as OPERATED_BY
,ap.PACKAGE_TYPE[0]::varchar as PACKAGE_TYPE
,pia.HELPER_PIA014[0]::varchar as PIA_014
,ap.PIA_EXPIRATION_DATE as PIA_EXPIRATION_DATE
,pisso.USER_NAMES as PRIMARY_ISSO
,ARRAY_TO_STRING(ap.OPERATING_LOCATION,',') as PRIMARY_OPERATING_LOCATION
,ato.REASON_FOR_ATO_REQUEST[0]::varchar as REASON_FOR_ATO_REQUEST
,sca.GROUP_NAMES as SCA
,ap.SCA_DATE as SCA_DATE
,sdm.USER_NAMES as SDM
,ato.SDM_REVIEW_DUE_DATE as SOP_REVIEW_DATE -- 250303 VW_CFACTS_SYSTEMS was using SDM_REVIEW_DUE_DATE
,ap.STE_DATE as STE_DATE
,CORE.FN_CRM_CLEANSTRING(ap.SYSTEMDESCRIPTION_TRUNCATED) as SYSTEM_DESCRIPTION
,ap.IDUID as SYSTEM_ID
,ap.TLC_PHASE[0]::varchar as TLC_PHASE
FROM APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CEDAR_EASI_INTEGRATION_NO_FILTERS_ cedar on cedar.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac._content_id = ap._CONTENT_ID
--
-- ALERT: component_acronym is not unique and component_name is not unique
--
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_COMPONENT_REPORT comp on comp.component_acronym = ap.component_acronym
--
-- Division does appear to be unique
-- LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT div on div.division = ap.division_name
--
-- Alert: group_name is not unique and group_acronym is not unique
--
--LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_GROUP_REPORT grp on grp.group_name = ap.group_name

LEFT OUTER JOIN W_ATO ato on ato.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_BO bo on bo.IDUID = ap.IDUID
LEFT OUTER JOIN W_CIO cio on cio.IDUID = ap.IDUID
LEFT OUTER JOIN W_CISO ciso on ciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_COMPRISK cro on cro.IDUID = ap.IDUID
LEFT OUTER JOIN W_CRA cra on cra.IDUID = ap.IDUID
LEFT OUTER JOIN W_DCISO dciso on dciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_DIVISION div on div.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_INFOTYPES infotype on infotype.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_ISSO isso on isso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSOCS issocs on issocs.IDUID = ap.IDUID
LEFT OUTER JOIN W_PIA pia on pia.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_PRIMARY_CRA pcra on pcra.IDUID = ap.IDUID
LEFT OUTER JOIN W_PRIMARY_ISSO pisso on pisso.IDUID = ap.IDUID
LEFT OUTER JOIN W_SCA sca on sca.IDUID = ap.IDUID
LEFT OUTER JOIN W_SDM sdm on sdm.IDUID = ap.IDUID

LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_RISK_ACCEPTANCE_RBD_REPORT ra on ra.SYSTEM_TRACKING_ID = ap._content_id
WHERE ap.IDUID IS NOT NULL
;
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CFACTS"("P_REPORT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CFACTS data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_PULL_CFACTS'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean DEFAULT 0;
True boolean DEFAULT 1;
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

----------------------------------------------------------------------
--            CHECK TO SEE IF CFACTS DATA IS AVAILABLE AND CURRENT
----------------------------------------------------------------------

/****************************************************************************************************************************
THE BASELINE WAS ESTABLISHED 11/07/2024 WITH THE FOLLOWING:

CREATE TABLE EXPECTED_CFACTS_COLUMNS as
SELECT v.TABLE_CATALOG,v.TABLE_SCHEMA,v.TABLE_NAME,c.COLUMN_NAME,c.DATA_TYPE
FROM APP_CFACTS.INFORMATION_SCHEMA.VIEWS v
LEFT OUTER JOIN (select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,DATA_TYPE 
    from APP_CFACTS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = ''SHARED'' ) c on c.TABLE_CATALOG = v.TABLE_CATALOG 
    and c.TABLE_SCHEMA = v.TABLE_SCHEMA and c.TABLE_NAME = v.TABLE_NAME
WHERE v.TABLE_SCHEMA = ''SHARED'' and v.CREATED::date = current_date()
;

****************************************************************************************************************************/

--
-- 241105 CR1023
-- Ensure that all CFACTS data is available and current.
-- Check also helps to trap CFACTS field name changes or data type.
-- 241107 replaced LAST_ALTERED with CREATED
--
select count(1) INTO :RECORD_COUNT from CORE.EXPECTED_CFACTS_COLUMNS expected
LEFT OUTER JOIN (SELECT v.TABLE_CATALOG,v.TABLE_SCHEMA,v.TABLE_NAME,v.LAST_DDL,c.COLUMN_NAME,c.DATA_TYPE
    FROM APP_CFACTS.INFORMATION_SCHEMA.VIEWS v
    LEFT OUTER JOIN (select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,DATA_TYPE 
        from APP_CFACTS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = ''SHARED'' ) c on c.TABLE_CATALOG = v.TABLE_CATALOG 
        and c.TABLE_SCHEMA = v.TABLE_SCHEMA and c.TABLE_NAME = v.TABLE_NAME
     WHERE v.TABLE_SCHEMA = ''SHARED'' and v.CREATED::date = current_date()) cur on cur.TABLE_CATALOG = expected.TABLE_CATALOG 
        and cur.TABLE_SCHEMA = expected.TABLE_SCHEMA and cur.TABLE_NAME = expected.TABLE_NAME
        and cur.COLUMN_NAME = expected.COLUMN_NAME 
        and cur.DATA_TYPE = expected.DATA_TYPE
WHERE cur.COLUMN_NAME IS NULL;
   
IF (:RECORD_COUNT <> 0) THEN
    BEGIN
    --
    -- Send warning message to security-datalake-crm-sdw-alerts when not all CFACTS data is available
    --
    Msg := ''WARNING: APP_CFACTS.SHARED views are incomplete. '' || :RECORD_COUNT || '' columns are missing. SDW CFACTS data will remain unchanged.'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    
    select CORE.SF_SEND_SLACK_MESSAGE(:Msg);

    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
    END;
END IF;


----------------------------------------------------------------------
--            SYSTEMS
----------------------------------------------------------------------
BEGIN TRANSACTION;
MERGE INTO CORE.SYSTEMS t USING (
SELECT
	ACRONYM,
    ACTUAL_DECOMMISION_DATE, -- 231218
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	IS_OA_READY,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
    LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE, -- 230428 
	LAST_ACT_SCA_FINAL_REPORT_DATE,
    LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,  -- 230428 
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
    OPERATED_BY, -- 250103 CR1059
	PACKAGE_TYPE,
    PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	NULLIF(PRIMARY_OPERATING_LOCATION,'''') as PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
    CORE.FN_CRM_STRIPHTML(SYSTEM_DESCRIPTION) as SYSTEM_DESCRIPTION, -- 231012
	SYSTEM_ID,
	TLC_PHASE   
FROM CORE.VW_CFACTS_SYSTEMS    
)s ON (s.System_ID = t.System_ID)
WHEN MATCHED THEN UPDATE SET 
    t.ACRONYM = s.ACRONYM
    ,t.ACTUAL_DECOMMISION_DATE = s.ACTUAL_DECOMMISION_DATE -- 231218
	,t.ARCHER_TRACKING_ID = s.ARCHER_TRACKING_ID
    ,t.ATO_EXPIRATION_DATE = s.ATO_EXPIRATION_DATE
    ,t.ATO_REVIEW_DATE = s.ATO_REVIEW_DATE
	,t.AUTH_COMMENTS = s.AUTH_COMMENTS
	,t.AUTH_DECISION = s.AUTH_DECISION
    ,t.AUTHORIZATION_MEMO_SIGNED_DATE = s.AUTHORIZATION_MEMO_SIGNED_DATE
	,t.AUTHORIZATION_PACKAGE = s.AUTHORIZATION_PACKAGE_NAME
    ,t.BO_RECOMMENDATION_REVIEW_DATE = s.BO_RECOMMENDATION_REVIEW_DATE
    ,t.BO_REVIEW_DATE = s.BO_REVIEW_DATE
	,t.BUSINESS_OWNER = s.BUSINESS_OWNER
	,t.CIO = s.CIO
	,t.CISO = s.CISO
    ,t.CISO_REVIEW_DATE = s.CISO_REVIEW_DATE
	,t.CLOUD_SERVICE_PROVIDER = s.CLOUD_SERVICE_PROVIDER
    ,t.COMPONENT_ACRONYM = s.COMPONENT_ACRONYM
	,t.COMPONENT_DESCRIPTION = s.COMPONENT_DESCRIPTION
	,t.COMPONENT_NAME = s.COMPONENT_NAME
	,t.COMPONENT_RISK_REPORTS_OVERSIGHT = s.COMPONENT_RISK_REPORTS_OVERSIGHT
	,t.CONTINGENCYEXPIRATIONDATE = s.CONTINGENCYEXPIRATIONDATE
	,t.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID = s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,t.CP_TEST_DATE = s.CP_TEST_DATE
	,t.CP_TEST_RESULTS = s.CP_TEST_RESULTS
	,t.CRA = s.CRA
    ,t.CRA_REVIEW_DATE = s.CRA_REVIEW_DATE
	,t.CYBERVET = s.CYBERVET
	,t.DATE_AUTH_MEMO_EXPIRES = s.DATE_AUTH_MEMO_EXPIRES
	,t.DATE_AUTH_MEMO_SIGNED = s.DATE_AUTH_MEMO_SIGNED
	,t.DCISO = s.DCISO
    ,t.DIVISION_ACRONYM = s.DIVISION_ACRONYM
	,t.DIVISION_DESCRIPTION = s.DIVISION_DESCRIPTION
	,t.DIVISION_NAME = s.DIVISION_NAME
    ,t.DSPC_REVIEW_DATE = s.DSPC_REVIEW_DATE
    ,t.DSPPO_REVIEW_DATE = s.DSPPO_REVIEW_DATE
	,t.E_AUTH_EXP_DATE = s.E_AUTH_EXP_DATE
	,t.E_AUTH_LEVEL = s.E_AUTH_LEVEL
	,t.E_AUTH_RISK_ASSESSMENT_DATE = s.E_AUTH_RISK_ASSESSMENT_DATE
	,t.FINANCIAL_SYSTEM = s.FINANCIAL_SYSTEM
	,t.FIPS_199_AVAILABILITY_RATING = s.FIPS_199_AVAILABILITY_RATING
	,t.FIPS_199_CONFIDENTIALITY_RATING = s.FIPS_199_CONFIDENTIALITY_RATING
	,t.FIPS_199_INTEGRITY_RATING = s.FIPS_199_INTEGRITY_RATING
	,t.FIPS_199_OVERALL_IMPACT_RATING = s.FIPS_199_OVERALL_IMPACT_RATING
	,t.FIRST_PUBLISHED_DATE = s.FIRST_PUBLISHED_DATE
	,t.FISMA_SYSTEM = s.FISMA_SYSTEM
    ,t.GROUP_ACRONYM = s.GROUP_ACRONYM
	,t.GROUP_DESCRIPTION = s.GROUP_DESCRIPTION
	,t.GROUP_NAME = s.GROUP_NAME
	,t.HVA_SCORE = s.HVA_SCORE
	,t.HVASTATUS = s.HVASTATUS
	,t.INFORMATION_SYSTEM_TYPE = s.INFORMATION_SYSTEM_TYPE
	,t.IS_MARKETPLACE = s.IS_MARKETPLACE
	,t.IS_OA_READY = s.IS_OA_READY
	,t.ISRA_REVIEW_DATE = s.ISRA_REVIEW_DATE
	,t.ISRA_STATUS = s.ISRA_STATUS
	,t.ISSO = s.ISSO
	,t.ISSO_COUNT = s.ISSO_COUNT
    ,t.ISSO_REVIEW_DATE = s.ISSO_REVIEW_DATE
    ,t.ISSO_SUBMISSION_DATE = s.ISSO_SUBMISSION_DATE
	,t.ISSOCS = s.ISSOCS
	,t.LAST_ACT_DATE = s.LAST_ACT_DATE
    ,t.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE = s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,t.LAST_ACT_SCA_FINAL_REPORT_DATE = s.LAST_ACT_SCA_FINAL_REPORT_DATE
    ,t.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE = s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428    
	,t.LAST_PENTEST_DATE = s.LAST_PENTEST_DATE
	,t.MEF = s.MEF
	,t.MEF_CONTEXT = s.MEF_CONTEXT
	,t.NEXT_REQUIRED_CP_TEST_DATE = s.NEXT_REQUIRED_CP_TEST_DATE
	,t.OA_STATUS = s.OA_STATUS
    ,t.OPERATED_BY = s.OPERATED_BY -- 250103 CR1059
	,t.PACKAGE_TYPE = s.PACKAGE_TYPE
    ,t.PIA_014 = s.PIA_014 -- 230621
	,t.PIA_EXPIRATION_DATE = s.PIA_EXPIRATION_DATE
	,t.PRIMARY_ISSO = s.PRIMARY_ISSO
	,t.PRIMARY_OPERATING_LOCATION = s.PRIMARY_OPERATING_LOCATION
    ,t.REASON_FOR_ATO_REQUEST = s.REASON_FOR_ATO_REQUEST
	,t.SCA = s.SCA
	,t.SCA_DATE = s.SCA_DATE
	,t.SDM = s.SDM
    ,t.SOP_REVIEW_DATE = s.SOP_REVIEW_DATE
	,t.STE_DATE = s.STE_DATE
	,t.SYSTEM_DESCRIPTION = s.SYSTEM_DESCRIPTION
--	,t.SYSTEM_ID = s.SYSTEM_ID
	,t.TLC_PHASE = s.TLC_PHASE
WHEN NOT MATCHED THEN INSERT
    (ACRONYM
    ,ACTUAL_DECOMMISION_DATE -- 231218
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE
    ,ATO_REVIEW_DATE
	,AUTH_COMMENTS
	,AUTH_DECISION
    ,AUTHORIZATION_MEMO_SIGNED_DATE
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE
    ,BO_REVIEW_DATE
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE
    ,DSPPO_REVIEW_DATE
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,INSERT_DATE
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OA_READY
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE
    ,ISSO_SUBMISSION_DATE
	,ISSOCS
	,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230621
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
    ,REASON_FOR_ATO_REQUEST
	,PRIMARY_OPERATING_LOCATION_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE
	,STE_DATE
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
)
VALUES (
    s.ACRONYM
    ,s.ACTUAL_DECOMMISION_DATE -- 231218
	,s.ARCHER_TRACKING_ID
    ,s.ATO_EXPIRATION_DATE
    ,s.ATO_REVIEW_DATE
	,s.AUTH_COMMENTS
	,s.AUTH_DECISION
    ,s.AUTHORIZATION_MEMO_SIGNED_DATE
	,s.AUTHORIZATION_PACKAGE_NAME
    ,s.BO_RECOMMENDATION_REVIEW_DATE
    ,s.BO_REVIEW_DATE
	,s.BUSINESS_OWNER
	,s.CIO
	,s.CISO
    ,s.CISO_REVIEW_DATE
	,s.CLOUD_SERVICE_PROVIDER
    ,s.COMPONENT_ACRONYM
	,s.COMPONENT_DESCRIPTION
	,s.COMPONENT_NAME
	,s.COMPONENT_RISK_REPORTS_OVERSIGHT
	,s.CONTINGENCYEXPIRATIONDATE
	,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,s.CP_TEST_DATE
	,s.CP_TEST_RESULTS
	,s.CRA
    ,s.CRA_REVIEW_DATE
	,s.CYBERVET
	,s.DATE_AUTH_MEMO_EXPIRES
	,s.DATE_AUTH_MEMO_SIGNED
    ,NULL -- DATEDELETED
    ,NULL -- DATEMODIFIED
	,s.DCISO
    ,s.DIVISION_ACRONYM
	,s.DIVISION_DESCRIPTION
	,s.DIVISION_NAME
    ,s.DSPC_REVIEW_DATE
    ,s.DSPPO_REVIEW_DATE
	,s.E_AUTH_EXP_DATE
	,s.E_AUTH_LEVEL
	,s.E_AUTH_RISK_ASSESSMENT_DATE
	,s.FINANCIAL_SYSTEM
	,s.FIPS_199_AVAILABILITY_RATING
	,s.FIPS_199_CONFIDENTIALITY_RATING
	,s.FIPS_199_INTEGRITY_RATING
	,s.FIPS_199_OVERALL_IMPACT_RATING
	,s.FIRST_PUBLISHED_DATE
	,s.FISMA_SYSTEM
    ,s.GROUP_ACRONYM
	,s.GROUP_DESCRIPTION
	,s.GROUP_NAME
	,s.HVA_SCORE
	,s.HVASTATUS
    ,NULL -- IN_CMS_CLOUD
	,s.INFORMATION_SYSTEM_TYPE
    ,CURRENT_TIMESTAMP()
    ,:false -- IS_DATACENTER
	,:false -- IS_EXCLUDEFROMREPORTING
	,:false -- IS_HIGHRISKSYSTEM
	,s.IS_MARKETPLACE
	,s.IS_OA_READY
	,:false -- IS_OPERATIONALSYSTEM
	,:false -- IS_PHANTOMSYSTEM
	,:false -- IS_SECURITYHUB_ENABLED
	,s.ISRA_REVIEW_DATE
	,s.ISRA_STATUS
	,s.ISSO
	,s.ISSO_COUNT
    ,s.ISSO_REVIEW_DATE
    ,s.ISSO_SUBMISSION_DATE
	,s.ISSOCS
	,s.LAST_ACT_DATE
    ,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,s.LAST_ACT_SCA_FINAL_REPORT_DATE
    ,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428 
	,s.LAST_PENTEST_DATE
	,s.MEF
	,s.MEF_CONTEXT
    ,NULL -- MEFSTATUS
	,s.NEXT_REQUIRED_CP_TEST_DATE
	,s.OA_STATUS
    ,NULL -- OATO_CATEGORY
    ,s.OPERATED_BY -- 250103 CR1059
	,s.PACKAGE_TYPE
    ,s.PIA_014 -- 230621
	,s.PIA_EXPIRATION_DATE
    ,NULL -- PII_PHI
	,s.PRIMARY_ISSO
	,s.PRIMARY_OPERATING_LOCATION
    ,s.REASON_FOR_ATO_REQUEST
    ,NULL -- PRIMARY_OPERATING_LOCATION_ID
	,s.SCA
	,s.SCA_DATE
	,s.SDM
    ,s.SOP_REVIEW_DATE
	,s.STE_DATE
	,s.SYSTEM_DESCRIPTION
	,s.SYSTEM_ID
	,s.TLC_PHASE
    ,0 -- TOTALPOAMWITHAPPROVEDRBD
);

Msg := ''Merge SYSTEMS complete'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

select count(1) into :RECORD_COUNT FROM CORE.SYSTEMS GROUP BY SYSTEM_ID having count(1) > 1;
IF (coalesce(:RECORD_COUNT,0) > 1) THEN
	BEGIN
    -- THERE SHOULD NEVER BE TWO RECORDS WITH THE SAME SYSTEM_ID
    ExceptionMsg := ''DUPLICATE SYSTEM_ID IN SYSTEMS TABLE''; 
    raise CRM_logic_exception;
	END;
END IF;

--
-- Set IS_EXCLUDEFROMREPORTING Boolean to True as required.
-- CFACTS or Reporting teams (rarely) want to flag a CFACTS system to no
-- be included in FISMA Reporting. These are usually test records.
--
BEGIN TRANSACTION;
UPDATE CORE.SYSTEMS
set IS_EXCLUDEFROMREPORTING = 1
WHERE SYSTEM_ID IN
(
''11''
,''123456789101112131415''
,''N/A''
,''TBD''
);
COMMIT;

BEGIN TRANSACTION;
--
-- Initialize booleans that might change over time
--
UPDATE Systems
SET Is_OperationalSystem = :False
,Is_HighRiskSystem = :False;
       
-- Set Is_OperationalSystem to True to simplify reporting filters
--     
UPDATE Systems
SET Is_OperationalSystem = :True
where TLC_Phase = ''Operate''
and Package_Type = ''Information System''
and Information_System_Type IN 
(''Major Application''
,''General Support System''
,''Minor Application \\[Stand Alone\\]'' 
,''Minor Application \\[Child\\]'');
      
-- Set Is_HighRiskSystem to True to simply reporting filters
--
UPDATE Systems
SET Is_HighRiskSystem = :True
where Is_OperationalSystem = :True
and ((HVAStatus is not null and HVAStatus = ''Yes'') 
or (MEF_Context is not null and MEF_Context <> ''N/A'') 
or FIPS_199_Overall_Impact_Rating = ''High'');
  
-- Initialize fields that are re-evaluated each run
--
UPDATE Systems
SET In_CMS_Cloud = ''No''
,MEFStatus = NULL
,OATO_Category = 0
,PII_PHI = NULL
,TotalPOAMwithApprovedRBD = 0; 
   
UPDATE Systems
SET In_CMS_Cloud = ''Yes''
where Cloud_Service_Provider like ''%Amazon Web Services%''; 
            
UPDATE Systems
SET MEFStatus = ''Yes''
where MEF_Context IS NOT NULL 
and upper(MEF_Context) <> ''N/A''; -- 231013 added upper
      
UPDATE Systems upd -- Added upd 230531
SET PII_PHI = ''Yes''
FROM Systems s
JOIN (select distinct SYSTEM_ID
    FROM CORE.PII_SYSTEM_PII_TYPES st 
    WHERE UPPER(PII_Category) IN (''PII'',''PHI'')) p on p.SYSTEM_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID; -- Added where clause 230531
      
UPDATE Systems
SET OATO_Category = 3
WHERE (HVAStatus IS NOT NULL and HVAStatus = ''Yes'')
or (MEFStatus IS NOT NULL and MEFStatus = ''Yes'')
or (FIPS_199_Overall_Impact_Rating IS NOT NULL and FIPS_199_Overall_Impact_Rating = ''High'');

UPDATE Systems
SET OATO_Category = 2
WHERE OATO_Category = 0
and ((PII_PHI IS NOT NULL and PII_PHI = ''Yes'')
or (Financial_System IS NOT NULL and Financial_System = ''Yes'')
or (FIPS_199_Overall_Impact_Rating IS NOT NULL and FIPS_199_Overall_Impact_Rating = ''Moderate''));
      
-- As per Teresa, default to 1 to catch other possible issues
UPDATE Systems
SET OATO_Category = 1
WHERE OATO_Category = 0;
      
-- 210928 2153 TotalPOAMwithApprovedRBD used in CRMP metrics (V_CRMP_TotalNumberRiskAcceptance)
UPDATE Systems upd -- Added upd 230531
set TotalPOAMwithApprovedRBD = t.TotalPOAMwithApprovedRBD
FROM Systems s
JOIN (SELECT s.System_ID,count(1) as TotalPOAMwithApprovedRBD
    FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE a 
    INNER JOIN Systems s on s.SYSTEM_ID = a.IDUID
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs pa ON a.ContentId=pa.Authorization_Package_POAMs_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs p ON p.ContentId=pa.POAMs_Authorization_Package_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Risk_Acceptance_RBD_POAMs_x_Risk_Acceptance_RBD_POAMs pr ON p.ContentId=pr.POAMs_Risk_Acceptance_RBD_POAMs_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_Risk_Acceptance_RBD r on pr.Risk_Acceptance_RBD_POAMs_ContentId=r.ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_Risk_Acceptance_RBD_Overall_Status rs ON rs.ParentContentId=r.ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_enum_RBD_Overall_Status ers on rs.Value=ers.Id
    Where upper(ers.Value)=''APPROVED WITH SIGNATURE'' -- 231017 add upper; Also CFACTS changed on or about 7/28/23. value used to be plural (Approved with Signatures)
    group by s.System_ID) t on t.System_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID; -- Added where clause 230531

--
-- SYSTEM_COMMONNAME is a supplemental table that provides the Common Name used to reference a system.
-- This value is not contained in CFACTS as an official value. It is simply used in everyday language for convenience. 
-- When a new system is added then the CommonName is the same as the official Acronym until such time as a manual
-- change is made within this table
--
INSERT into CORE.SYSTEM_COMMONNAME (COMMONNAME,SYSTEM_ID)
SELECT s.ACRONYM, s.SYSTEM_ID
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
where c.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''SYSTEMS table updated'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

-- 230607
-- SecurityHub data is provided manually and so the SYSTEM_SECURITYHUB_ENABLED table is a simple list
-- of systems that have SecurityHub enabled
--
UPDATE Systems upd
SET IS_SECURITYHUB_ENABLED = 1
FROM Systems s
JOIN CORE.SYSTEM_SECURITYHUB_ENABLED sh on sh.SYSTEM_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID;
COMMIT;

Msg := ''SYSTEMS update complete'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------------------------------------------------
--            ALLOCATEDCONTROL
----------------------------------------------------------------------
TRUNCATE TABLE CORE.ALLOCATEDCONTROL;

BEGIN TRANSACTION;
INSERT INTO CORE.ALLOCATEDCONTROL
	(ALLOCATION_STATUS
	,CONTROL_ELEMENT
	,CONTROL_ELEMENT_NUMBER
	,CONTROL_FAMILY
	,CONTROL_NAME
	,CONTROL_NUMBER
	,CONTROL_NUMBER_COMBO
	,CONTROL_SET_VERSION_NUMBER
	,HYBRID_CONTROL
	,INHERITABLE_BY_OTHER_SYSTEMS
	,LAST_ACT_DATE
	,LAST_ASSESSMENT_DATE
	,LAST_PENTEST_DATE
	,LAST_SCA_DATE
	,OVERALL_CONTROL_STATUS
	,PRIVATE_IMP_UPDATED_DATE
    ,PRIVATE_IMPLEMENTATION_DETAILS -- 230622
    ,REPORT_ID
	,RESPONSIBILITY
	,SHARED_IMP_UPDATED_DATE
	,SIGNIFICANT_CONTROL_CHANGE
	,SIGNIFICANT_CONTROL_CHANGE_DETAILS
	,SYSTEM_ID
	,TRACKING_ID
)
SELECT
	ALLOCATION_STATUS
	,CONTROL_ELEMENT
	,CONTROL_ELEMENT_NUMBER
	,CONTROL_FAMILY
	,CONTROL_NAME
	,CONTROL_NUMBER
	,CONTROL_NUMBER_COMBO
	,CONTROL_SET_VERSION_NUMBER
	,HYBRID_CONTROL
	,INHERITABLE_BY_OTHER_SYSTEMS
	,LAST_ACT_DATE
	,LAST_ASSESSMENT_DATE
	,LAST_PENTEST_DATE
	,LAST_SCA_DATE
	,OVERALL_CONTROL_STATUS
	,PRIVATE_IMP_UPDATED_DATE
    ,PRIVATE_IMPLEMENTATION_DETAILS -- 230622
    ,:P_Report_ID as REPORT_ID
	,RESPONSIBILITY
	,SHARED_IMP_UPDATED_DATE
	,SIGNIFICANT_CONTROL_CHANGE
	,SIGNIFICANT_CONTROL_CHANGE_DETAILS
	,SYSTEM_ID
	,TRACKING_ID
FROM CORE.VW_CFACTS_ALLOCATEDCONTROL
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            CAATHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.CAATHIST
	(ACT_CAAT_FILEPROCESSEDDATE
	,ASSESSMENT_AUDIT_COMPANY
	,CAAT_ID
	,DATE_IDENTIFIED
	,FINDING_DESCRIPTION
	,FINDING_ID
	,FINDING_TITLE
	,RELATED_POAMS
    ,REPORT_ID
	,SOURCE_AUDIT_TYPE
	,SYSTEM_ID
	,TEST_METHOD
	,TEST_OBJECTIVE
	,TEST_RESULT
	,WEAKNESS_DESCRIPTION
)
SELECT
	ACT_CAAT_FILEPROCESSEDDATE
	,ASSESSMENTAUDIT_COMPANY
	,CAAT_ID
	,DATE_IDENTIFIED
	,FINDING_DESCRIPTION
	,FINDING_ID
	,FINDING_TITLE
	,RELATED_POAMS
    ,:P_Report_ID as REPORT_ID
	,SOURCE_AUDIT_TYPE_2
	,SYSTEM_ID
	,TEST_METHOD
	,TEST_OBJECTIVE
	,TEST_RESULT
	,WEAKNESS_DESCRIPTION
FROM CORE.VW_CFACTS_CAAT
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            CEDE_MVP_POAMS_CONTROLS
-- Added 230621
----------------------------------------------------------------------
TRUNCATE TABLE CORE.CEDE_MVP_POAMS_CONTROLS;

BEGIN TRANSACTION;
INSERT INTO CORE.CEDE_MVP_POAMS_CONTROLS (
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	POAM_ID,
	REPORT_ID,
    SYSTEM_ID,
	WEAKNESS_RISK_LEVEL
)
SELECT 
Alloc.Control_Number --as Allocated Control
,eOverallStatus.Value --as Overall Status 
,p.POAM_ID
,:P_Report_ID
,s.SYSTEM_ID
,eRiskLevel.Value --as Weakness Risk Level
FROM APP_CFACTS.SHARED.SEC_VW_POAMs p
INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs pa ON p.ContentId = pa.POAMs_Authorization_Package_ContentId
INNER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package a ON a.ContentId=pa.Authorization_Package_POAMs_ContentId
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.IDUID
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status pOverallStatus on pOverallStatus.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Status_9 eOverallStatus on eOverallStatus.Id = pOverallStatus.Value
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1 pRiskLevel on pRiskLevel.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1 eRiskLevel on eRiskLevel.ID = pRiskLevel.Value
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_POAM_x_POAMs_Allocated_Control pAlloc on pAlloc.POAMs_Allocated_Control_ContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards Alloc on Alloc.ContentId = pAlloc.Allocated_Controls_POAM_ContentId;
COMMIT;

----------------------------------------------------------------------
--            MILESTONEHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.MILESTONEHIST
	(ACTUAL_COMPLETION_DATE
	,CHANGES_TO_MILESTONE
	,ESTIMATED_COMPLETION_DATE
	,LAST_UPDATED
	,MILESTONE_DESCRIPTION
	,MILESTONE_ID
	,MILESTONE_NAME
	,MILESTONE_STATUS
	,POAM_ID
    ,REPORT_ID
	,SCHEDULED_COMPLETION_DATE
	,SYSTEM_ID
)
SELECT
	ACTUAL_COMP_DATE
	,CHANGES2MS
	,EST_COMP_DATE
	,LAST_UPDATED
	,MS_DESC
	,MS_ID
	,MS_NAME
	,MS_STATUS
	,POAM_ID
    ,:P_Report_ID as REPORT_ID
	,SCHED_COMP_DATE
	,SYSTEM_ID
FROM CORE.VW_CFACTS_MILESTONE
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            PIAHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.PIAHIST
	(DUE_DATE
    ,FINAL_APPROVER
    ,FINAL_APPROVER_DATE
    ,FINAL_APPROVER_STATUS
    ,HHS_PIA_REVIEW_DATE
    ,HHS_PIA_STATUS
    ,OVERALL_STATUS
    ,PIA_TRACKING_ID
    ,REPORT_ID
    ,REVIEW_DATE
    ,REVIEW_STATUS
    ,REVIEWER
    ,SUBMISSION_DATE
    ,SUBMISSION_STATUS
    ,SUBMITTER
    ,SYSTEM_ID
)
SELECT
    DUE_DATE
    ,FINAL_APPROVER
    ,FINAL_APPROVER_DATE
    ,FINAL_APPROVER_STATUS
    ,HHS_PIA_REVIEW_DATE
    ,HHS_PIA_STATUS
    ,OVERALL_STATUS
    ,PIA_TRACKING_ID
    ,:P_Report_ID as REPORT_ID
    ,REVIEW_DATE
    ,REVIEW_STATUS
    ,REVIEWER
    ,SUBMISSION_DATE
    ,SUBMISSION_STATUS
    ,SUBMITTER
    ,SYSTEM_ID
FROM CORE.VW_CFACTS_PIA
where SYSTEM_ID IS NOT NULL; -- 230317 added in SDL environment
COMMIT;

----------------------------------------------------------------------
--           POAMHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.POAMHIST
	(ACTUAL_COMPLETION_DATE,
	ACTUAL_LABOR_COST,
	CAAT,
	CAAT_ID,
    CVE,
	DAYS_OPEN,
	ESTIMATED_COMPLETION_DATE,
	FUNDING_SOURCE,
	LABOR_ESTIMATE,
	OVERALL_STATUS,
	POAM_CLOSED_DATE,
	POAM_ID,
	POAM_OWNER,
	POAM_REVIEWER,
    REPORT_ID,
	REVIEW_COMMENTS,
	REVIEW_DATE,
	REVIEW_STATUS,
	SCHEDULED_COMPLETION_DATE,
	SUBMISSION_STATUS,
	SYSTEM_ID,
	TARGET,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_ID,
	WEAKNESS_POC,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY
)
SELECT
	ACTUAL_COMPLETION_DATE
	,ACTUAL_LABOR_COST
	,CAAT
	,CAAT_ID   
    ,IFF(FINDING_ID LIKE ''KEV%'',REPLACE(FINDING_ID,''KEV'',''CVE''),IFF(FINDING_ID LIKE ''CVE%'',FINDING_ID,NULL)) as CVE --231019 CR#775
	,DAYS_OPEN
	,ESTIMATED_COMPLETION_DATE
	,FUNDING_SOURCE
	,LABOR_ESTIMATE
	,OVERALL_STATUS
	,POAM_CLOSED_DATE
	,POAM_ID
	,POAM_OWNER
	,POAM_REVIEWER
	,:P_Report_ID as REPORT_ID
	,REVIEW_COMMENTS
	,REVIEW_DATE
	,REVIEW_STATUS
	,SCHEDULED_COMPLETION_DATE
	,SUBMISSION_STATUS
	,SYSTEM_ID
	,TARGET
	,WEAKNESS_CREATION_DATE
	,WEAKNESS_ID
	,WEAKNESS_POC
	,WEAKNESS_RISK_LEVEL
	,WEAKNESS_SEVERITY
FROM CORE.VW_CFACTS_POAM
WHERE SYSTEM_ID IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Inserted into POAMHIST='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

----------------------------------------------------------------------
--           SYSTEMSHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;

INSERT INTO CORE.SYSTEMSHIST
    (ACRONYM
    ,ACTUAL_DECOMMISION_DATE --240904 CR965
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE --240904 CR965
    ,ATO_REVIEW_DATE --240904 CR965
	,AUTH_COMMENTS
	,AUTH_DECISION
    ,AUTHORIZATION_MEMO_SIGNED_DATE --240904 CR965
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE --240904 CR965
    ,BO_REVIEW_DATE --240904 CR965
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE --240904 CR965
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE --240904 CR965
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
    ,DIRECTOR_COMMENT --240904 CR965
    ,DIRECTOR_COMMENT2 --240904 CR965
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE --240904 CR965
    ,DSPPO_REVIEW_DATE --240904 CR965
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,IS_CCSQ --240904 CR965
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OA_READY
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE --240904 CR965
    ,ISSO_SUBMISSION_DATE --240904 CR965
	,ISSOCS
    ,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230623
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
	,PRIMARY_OPERATING_LOCATION_ID
    ,REASON_FOR_ATO_REQUEST --240904 CR965
	,REPORT_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE --240904 CR965
	,STE_DATE
    ,SYSTEM_CREATION_DATE --240904 CR965
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
)
SELECT
ACRONYM
    ,ACTUAL_DECOMMISION_DATE --240904 CR965
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE --240904 CR965
    ,ATO_REVIEW_DATE --240904 CR965
	,AUTH_COMMENTS
	,AUTH_DECISION
	,AUTHORIZATION_MEMO_SIGNED_DATE --240904 CR965
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE --240904 CR965
    ,BO_REVIEW_DATE --240904 CR965
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE --240904 CR965
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE --240904 CR965
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
    ,DIRECTOR_COMMENT --240904 CR965
    ,DIRECTOR_COMMENT2 --240904 CR965
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE --240904 CR965
    ,DSPPO_REVIEW_DATE --240904 CR965
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,IS_CCSQ --240904 CR965
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OA_READY
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE --240904 CR965
    ,ISSO_SUBMISSION_DATE --240904 CR965
	,ISSOCS
    ,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230623
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
	,PRIMARY_OPERATING_LOCATION_ID
    ,REASON_FOR_ATO_REQUEST --240904 CR965
	,:P_Report_ID as REPORT_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE --240904 CR965
	,STE_DATE
    ,INSERT_DATE AS SYSTEM_CREATION_DATE --240904 CR965
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Inserted into SYSTEMSHIST='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;


----------------------------------------------------------------------
--            CFACTS_USERMAPPING
----------------------------------------------------------------------
TRUNCATE TABLE CORE.CFACTS_USERMAPPING;

BEGIN TRANSACTION;
INSERT INTO CORE.CFACTS_USERMAPPING
	(ACRONYM
	,ROLE
	,SYSTEM_ID
	,USER_ID
)
SELECT
    ACRONYM
	,ROLE
	,SYSTEM_ID
	,USER_ID
FROM CORE.VW_CFACTS_USERMAPPING;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_MSGLOG_241029"("P_APPL" VARCHAR(16777216), "P_MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_WRITE_MSGLOG'';
ExceptionMsg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

BEGIN TRANSACTION;
insert into CORE.MSGLOG (APPL,MSG) VALUES(:P_APPL,:P_MSG);
COMMIT;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_MSGLOG_V2_ATTEMPT"("P_APPL" VARCHAR(16777216), "P_MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_WRITE_MSGLOG'';
ExceptionMsg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

BEGIN TRANSACTION;
-- 241029 add functions around msg
insert into CORE.MSGLOG (APPL,MSG) VALUES(:P_APPL,coalesce(NULLIF(:P_MSG,''''),''WARNING: FOUND NULL MSG''));
COMMIT;

--
-- 241029
-- There should never be a null msg so if one is found something is fundamentally wrong.
--
If (NULLIF(:P_MSG,'''') IS NULL) THEN
    BEGIN
    ExceptionMsg := ''ERROR: FOUND NULL MSG''; 
    raise CRM_logic_exception;
    END;
END IF;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
create or replace schema CEDE COMMENT='Contains views/tables needed by Reporting Team/Tableau';

create or replace view VW_CEDE_ALLOCATED_CONTROLS(
	REPORTDATE,
	OVERALL_CONTROL_STATUS,
	AUTHORIZATION_PACKAGE,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_ELEMENT,
	CONTROL_ELEMENT_NUMBER,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS
) COMMENT='Contains allocated controls details and Controls elements'
 as
SELECT 
(select Report_Date FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,Alloc.OVERALL_CONTROL_STATUS 
,s.Authorization_Package 
,Alloc.Control_Name 
,Alloc.Control_Number 
,Alloc.CONTROL_ELEMENT
,Alloc.control_element_number
,Alloc.Private_Imp_Updated_Date 
,Alloc.PRIVATE_IMPLEMENTATION_DETAILS 
FROM CORE.VW_Systems  s 
join CORE.ALLOCATEDCONTROL Alloc on Alloc.SYSTEM_ID = s.SYSTEM_ID
JOIN CORE.CORECONTROLS core on core.CONTROL = Alloc.CONTROL_NUMBER;
create or replace view VW_CEDE_AUTHORIZATION_PACKAGES(
	ACRONYM,
	BUSINESS_OWNER,
	COMPONENT_ACRONYM,
	CURRENTYEARHVASCORE,
	FIPS_199_OVERALL_IMPACT_RATING,
	FISMA_SYSTEM,
	AUTHORIZATION_PACKAGE,
	ISCURRENTYEARHVALIST,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEFSTATUS,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REPORTDATE,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	TLC_PHASE
) COMMENT='Contains system information'
 as
SELECT 
s.Acronym 
,s.Business_Owner 
,s.Component_Acronym 
,s.HVA_SCORE as CurrentYearHVAScore
,s.FIPS_199_Overall_Impact_Rating 
,s.FISMA_System 
,s.Authorization_Package 
,s.HVASTATUS as IscurrentyearHVAlist
,s.MEF as MissionEssentialFunctions_MEFs
,s.mefstatus
,s.PRIMARY_ISSO 
,s.Primary_Operating_Location 
,(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,s.SYSTEM_DESCRIPTION 
,s.SDM as SystemDeveloperMaintainer_SDM
,s.TLC_Phase 
FROM CORE.VW_Systems s 
;
create or replace view VW_CEDE_AUTHORIZATION_PACKAGES_240216(
	ACRONYM,
	BUSINESS_OWNER,
	COMPONENT_ACRONYM,
	CURRENTYEARHVASCORE,
	FIPS_199_OVERALL_IMPACT_RATING,
	FISMA_SYSTEM,
	AUTHORIZATION_PACKAGE,
	ISCURRENTYEARHVALIST,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REPORTDATE,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	TLC_PHASE
) COMMENT='Contains system information'
 as
SELECT 
s.Acronym 
,s.Business_Owner 
,s.Component_Acronym 
,s.HVA_SCORE as CurrentYearHVAScore
,s.FIPS_199_Overall_Impact_Rating 
,s.FISMA_System 
,s.Authorization_Package 
,s.HVASTATUS as IscurrentyearHVAlist
,s.MEF as MissionEssentialFunctions_MEFs
,s.PRIMARY_ISSO 
,s.Primary_Operating_Location 
,(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,s.SYSTEM_DESCRIPTION 
,s.SDM as SystemDeveloperMaintainer_SDM
,s.TLC_Phase 
FROM CORE.VW_Systems s 
;
create or replace view VW_CEDE_AUTHORIZATION_PACKAGES_POL(
	AUTHORIZATION_PACKAGE,
	PRIMARY_OPERATING_LOCATION,
	REPORTDATE
) COMMENT='Contains system primary location information'
 as
SELECT AUTHORIZATION_PACKAGE 
,PRIMARY_OPERATING_LOCATION 
,(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
FROM CORE.VW_SYSTEMS;
create or replace view VW_CEDE_CFACTS_USER_PERSMISSIONS(
	REPORTDATE,
	ACRONYM,
	AUTHORIZATION_PACKAGE,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	CFACTS_UID,
	USERNAME,
	ROLE
) COMMENT='Security view for user permission to CEDE dashboards'
 as
SELECT
(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,s.ACRONYM as Acronym
,s.AUTHORIZATION_PACKAGE as Authorization_Package
,s.COMPONENT_ACRONYM as Component_Acronym
,s.GROUP_ACRONYM as Group_Acronym
,s.TLC_PHASE as TLC_Phase
,case SUBSTRING(s.SYSTEM_ID,1,4)
	when '0000' then NULL
	Else s.SYSTEM_ID
End as CFACTS_UID
,um.USER_ID as UserName
,um.ROLE as Role
FROM CORE.VW_SYSTEMS s
JOIN CORE.CFACTS_USERMAPPING um on um.SYSTEM_ID = s.SYSTEM_ID
--WHERE ul.UserName = 'DSC6' -- Julianne
;
create or replace view VW_CEDE_CONTROL_DETAIL_WITH_POAM(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	PRIMARY_OPERATING_LOCATION,
	CURRENT_HVA_SYS,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEF_COUNT,
	BUSINESS_OWNER,
	FIPS_199_OVERALL_IMPACT_RATING,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	CONTROL_NUMBER,
	TIER,
	CONTROL_NAME,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_ELEMENT,
	POAM_ID,
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL,
	SYS_PII_LEVEL
) COMMENT='Contains system details, controls and POAM details'
 as
SELECT e.REPORTDATE
      ,d.AUTHORIZATION_PACKAGE
      ,e.ACRONYM
      ,e.FISMA_SYSTEM
      ,e.TLC_PHASE 
      ,e.COMPONENT_ACRONYM
	  ,k.PRIMARY_OPERATING_LOCATION     
      ,CASE when e.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end as CURRENT_HVA_SYS
      ,e.MISSIONESSENTIALFUNCTIONS_MEFS
	  ,CASE when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 365 then 2 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end AS MEF_COUNT
      ,e.BUSINESS_OWNER
      ,e.FIPS_199_OVERALL_IMPACT_RATING
      ,e.PRIMARY_ISSO
      ,e.SYSTEM_DESCRIPTION
      ,e.SYSTEMDEVELOPERMAINTAINER_SDM
      ,d.CONTROL_NUMBER
      ,CASE when d.CONTROL_NUMBER IN ('SC-08','SC-28') then 'Encryption' 
	        when d.CONTROL_NUMBER IN ('SC-12','SC-13','SC-17') then 'Encryption Support' 
	        when d.CONTROL_NUMBER IN ('AC-03','AC-06','AC-17','AU-06','IA-02','MP-02','SI-04') then 'Tier 1' 
	        when d.CONTROL_NUMBER IN ('AC-04','AC-20','AU-12','IA-05(02)','SC-07','SC-CMS-01') then 'Tier 2' 
	        when d.CONTROL_NUMBER IN ('AC-06(01)','AC-18','CA-07','CM-03','IA-02(12)','PM-12') then 'Tier 3' 
	  end AS Tier
      ,d.CONTROL_NAME
      ,j.OVERALL_CONTROL_STATUS
      ,j.PRIVATE_IMP_UPDATED_DATE
      ,j.PRIVATE_IMPLEMENTATION_DETAILS
      ,d.control_element_number
      ,d.control_element
      ,h.POAM_ID
      ,h.ALLOCATED_CONTROL
      ,h.OVERALL_STATUS
      ,h.WEAKNESS_RISK_LEVEL
	  ,Coalesce(l.SYS_PII_LEVEL,'Undetermined') as SYS_PII_LEVEL
  FROM (SELECT 
	c.CONTROL_NUMBER,
	c.CONTROL_NAME,
	b.AUTHORIZATION_PACKAGE,
    c.control_element_number
    ,c.control_element
	  FROM (SELECT CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element, authorization_package FROM CEDE.VW_CEDE_ALLOCATED_CONTROLS GROUP BY CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element, authorization_package) c 
	join  (SELECT AUTHORIZATION_PACKAGE FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes' GROUP BY AUTHORIZATION_PACKAGE) b on c.authorization_package = b.AUTHORIZATION_PACKAGE) d
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES e ON e.AUTHORIZATION_PACKAGE = d.AUTHORIZATION_PACKAGE
  LEFT JOIN (SELECT f.AUTHORIZATION_PACKAGE
      ,f.POAM_ID
      ,g.ALLOCATED_CONTROL
      ,f.OVERALL_STATUS
      ,f.WEAKNESS_RISK_LEVEL
	  FROM CEDE.VW_CEDE_POAM f 
	  LEFT JOIN CEDE.VW_CEDE_POAMS_CONTROLS g ON f.POAM_ID=g.POAM_ID
	  WHERE f.OVERALL_STATUS !='Completed' and f.OVERALL_STATUS !='Closed For System Disposition') h ON (d.AUTHORIZATION_PACKAGE = h.AUTHORIZATION_PACKAGE and h.ALLOCATED_CONTROL=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_ALLOCATED_CONTROLS j ON (j.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE and j.CONTROL_NUMBER=d.CONTROL_NUMBER and j.control_element_number = d.control_element_number)
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL k ON k.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL l ON d.AUTHORIZATION_PACKAGE=l.AUTHORIZATION_PACKAGE
  ;
create or replace view VW_CEDE_CONTROL_DETAIL_WITH_POAM_240212(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	PRIMARY_OPERATING_LOCATION,
	CURRENT_HVA_SYS,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEF_COUNT,
	BUSINESS_OWNER,
	FIPS_199_OVERALL_IMPACT_RATING,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	CONTROL_NUMBER,
	TIER,
	CONTROL_NAME,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	POAM_ID,
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL,
	SYS_PII_LEVEL
) COMMENT='Contains system details, controls and POAM details'
 as
SELECT e.REPORTDATE
      ,d.AUTHORIZATION_PACKAGE
      ,e.ACRONYM
      ,e.FISMA_SYSTEM
      ,e.TLC_PHASE 
      ,e.COMPONENT_ACRONYM
	  ,k.PRIMARY_OPERATING_LOCATION     
      ,CASE when e.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end as CURRENT_HVA_SYS
      ,e.MISSIONESSENTIALFUNCTIONS_MEFS
	  ,CASE when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 365 then 2 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end AS MEF_COUNT
      ,e.BUSINESS_OWNER
      ,e.FIPS_199_OVERALL_IMPACT_RATING
      ,e.PRIMARY_ISSO
      ,e.SYSTEM_DESCRIPTION
      ,e.SYSTEMDEVELOPERMAINTAINER_SDM
      ,d.CONTROL_NUMBER
      ,CASE when d.CONTROL_NUMBER IN ('SC-08','SC-28') then 'Encryption' 
	        when d.CONTROL_NUMBER IN ('SC-12','SC-13','SC-17') then 'Encryption Support' 
	        when d.CONTROL_NUMBER IN ('AC-03','AC-06','AC-17','AU-06','IA-02','MP-02','SI-04') then 'Tier 1' 
	        when d.CONTROL_NUMBER IN ('AC-04','AC-20','AU-12','IA-05(02)','SC-07','SC-CMS-01') then 'Tier 2' 
	        when d.CONTROL_NUMBER IN ('AC-06(01)','AC-18','CA-07','CM-03','IA-02(12)','PM-12') then 'Tier 3' 
	  end AS Tier
      ,d.CONTROL_NAME
      ,j.OVERALL_CONTROL_STATUS
      ,j.PRIVATE_IMP_UPDATED_DATE
      ,j.PRIVATE_IMPLEMENTATION_DETAILS
      ,h.POAM_ID
      ,h.ALLOCATED_CONTROL
      ,h.OVERALL_STATUS
      ,h.WEAKNESS_RISK_LEVEL
	  ,Coalesce(l.SYS_PII_LEVEL,'Undetermined') as SYS_PII_LEVEL
  FROM (SELECT 
	c.CONTROL_NUMBER,
	c.CONTROL_NAME,
	b.AUTHORIZATION_PACKAGE
	  FROM (SELECT CONTROL_NUMBER, CONTROL_NAME FROM CEDE.VW_CEDE_ALLOCATED_CONTROLS GROUP BY CONTROL_NUMBER, CONTROL_NAME) c, 
	  (SELECT AUTHORIZATION_PACKAGE FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes' GROUP BY AUTHORIZATION_PACKAGE) b) d
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES e ON e.AUTHORIZATION_PACKAGE = d.AUTHORIZATION_PACKAGE
  LEFT JOIN (SELECT f.AUTHORIZATION_PACKAGE
      ,f.POAM_ID
      ,g.ALLOCATED_CONTROL
      ,f.OVERALL_STATUS
      ,f.WEAKNESS_RISK_LEVEL
	  FROM CEDE.VW_CEDE_POAM f 
	  LEFT JOIN CEDE.VW_CEDE_POAMS_CONTROLS g ON f.POAM_ID=g.POAM_ID
	  WHERE f.OVERALL_STATUS !='Completed' and f.OVERALL_STATUS !='Closed For System Disposition') h ON (d.AUTHORIZATION_PACKAGE = h.AUTHORIZATION_PACKAGE and h.ALLOCATED_CONTROL=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_ALLOCATED_CONTROLS j ON (j.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE and j.CONTROL_NUMBER=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL k ON k.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL l ON d.AUTHORIZATION_PACKAGE=l.AUTHORIZATION_PACKAGE
  ;
create or replace view VW_CEDE_POAM(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	POAM_ID,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL
) COMMENT='Contains POAM Id/over all status/Weakness level'
 as
select 
r.REPORT_DATE as ReportDate
,p.AUTHORIZATION_PACKAGE 
,substring(p.POAM_ID,7)::number as POAM_ID
,p.OVERALL_STATUS 
,p.WEAKNESS_RISK_LEVEL 
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) as r
JOIN CORE.VW_POAMHist p on p.REPORT_ID = r.REPORT_ID
;
create or replace view VW_CEDE_POAMS_CONTROLS(
	ALLOCATED_CONTROL,
	AUTHORIZATION_PACKAGE,
	POAM_ID,
	REPORT_DATE
) COMMENT='Contains POAM related allocated controls'
 as
SELECT c.ALLOCATED_CONTROL 
	,s.AUTHORIZATION_PACKAGE 
	,c.POAM_ID 
    ,r.REPORT_DATE 
FROM CORE.CEDE_MVP_POAMS_Controls c
JOIN CORE.REPORT_IDS r on r.REPORT_ID = c.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = c.SYSTEM_ID
;
create or replace view VW_CEDE_PRIORITIZATION_DATA_SENSITIVITY(
	AUTHORIZATION_PACKAGE,
	MAX,
	MIN,
	NORM_DATA_SENSITIVITY
) COMMENT='Contains prioritization and data sensitivity data at org hierarchy level'
 as
/* About the view: Data sensitivity scoring is based on the type of data that is collected, processed, and stored by the systems, as reported in their PIA documents. 
Part of the score is based on a system's overall PII level. Sensitive systems get a score of 6, Combine-Context 4, Non-sensitive 2 and No PII 0.
The above score is also combined with a FIPS-199 score for the system, with the following scores: High 1, Moderate 0.05.
The basic data sensitivity score will range from 0 -7.  The higher the number, the higher the data sensitivity is.
The field 'norm_data_sensitivty' normalizes the scores across all systems from 0-1.*/
SELECT c.AUTHORIZATION_PACKAGE,
 MAX(c.pii_score + c.fips_score) OVER() as MAX,
 MIN(c.pii_score + c.fips_score) OVER() as MIN,
 ROUND(((c.pii_score + c.fips_score)-(MIN(c.pii_score + c.fips_score) OVER()))/((MAX(c.pii_score + c.fips_score) OVER())-(MIN(c.pii_score + c.fips_score) OVER())),3) as norm_data_sensitivity
FROM 
(SELECT a.AUTHORIZATION_PACKAGE
      ,a.FIPS_199_OVERALL_IMPACT_RATING
      ,b.SYS_PII_LEVEL
      ,CASE when b.SYS_PII_LEVEL='Sensitive PII' then 6
           when b.SYS_PII_LEVEL='Context-Combine PII' then 4
           when b.SYS_PII_LEVEL='Non-sensitive PII' then 2 
           when b.SYS_PII_LEVEL='No PII' then 0
      END AS pii_score
     ,CASE WHEN a.FIPS_199_OVERALL_IMPACT_RATING = 'Moderate' then .05
          when a.FIPS_199_OVERALL_IMPACT_RATING = 'High' then 1
          when a.FIPS_199_OVERALL_IMPACT_RATING = 'Low' then 0
      END as fips_score
 FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a
 LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL b ON a.AUTHORIZATION_PACKAGE = b.AUTHORIZATION_PACKAGE) c;
create or replace view VW_CEDE_PRIORITIZATION_SECURITY_POSTURE(
	AUTHORIZATION_PACKAGE,
	SECURITY_POSTURE_TOTAL,
	MAX,
	MIN,
	NORM_SECURITY_POSTURE
) COMMENT='Contains Security Posture and prioritization data at org hierarchy level'
 as
/* About the view: A control category is assigned to each of the twenty-four encryption controls along with a scoring valueusing the following logic: 
Encryption Controls +11, Encryption Support +8, Tier 1 +1.1, Tier 2 +0.8, Tier 3 +0.5.
The score is applied if the control is satisfied. The expected results for a system will range 0-61.5).  
The security controls scoring scale is opposite of the other criteria:  a lower score is a worse score and a higher priority
If a system in fact doesnt satisfy any controls, then its score is 0 which makes it a high priority system to address.
The field 'norm_security posture' simply normalizes the scores across all systems  from 0-1. */
SELECT 
a.AUTHORIZATION_PACKAGE,
sum(a.security_posture) as security_posture_total,
MAX(sum(a.security_posture)) OVER() as max,
MIN(sum(a.security_posture)) OVER() as min,
ROUND((sum(a.security_posture)-(MIN(sum(a.security_posture)) OVER()))/((MAX(sum(a.security_posture)) OVER())-(MIN(sum(a.security_posture)) OVER())),3) as norm_security_posture
FROM (SELECT AUTHORIZATION_PACKAGE,
        OVERALL_CONTROL_STATUS,
        TIER,
        CASE
            WHEN TIER = 'Encryption' THEN (count(distinct(CONTROL_NUMBER)) * 11)
            WHEN TIER = 'Encryption Support' THEN (count(distinct(CONTROL_NUMBER)) * 8)
            WHEN TIER = 'Tier 1' THEN count(distinct(CONTROL_NUMBER)) * 1.1
            WHEN TIER = 'Tier 2' THEN count(distinct(CONTROL_NUMBER)) * 0.8
            WHEN TIER = 'Tier 3' THEN count(distinct(CONTROL_NUMBER)) * 0.5
            ELSE 0
        END AS security_posture
FROM CEDE.VW_CEDE_CONTROL_DETAIL_WITH_POAM
where OVERALL_CONTROL_STATUS='Satisfied'
GROUP BY AUTHORIZATION_PACKAGE,OVERALL_CONTROL_STATUS, TIER) a
GROUP BY a.AUTHORIZATION_PACKAGE
;
create or replace view VW_CEDE_PRIORITIZATION_SYSTEM_CRITICALITY(
	AUTHORIZATION_PACKAGE,
	SYSTEM_CRITICALITY,
	MAX,
	MIN,
	NORM_SYSTEM_CRITICALITY
) COMMENT='Contains Systems Criticality  related information at org hierarchy level'
 as
/* About the view: Criticality is determined based on whether a system is designated as HVA and its MEF alignments.  
HVA systems are top priority, though should be closely aligned with MEFs.  
The Expected results range 0-5.5; Higher number = higher system criticality 
The scoring sums the following for each system: HVA= True 4, 1 MEF=1, 2 MEFs=1.5
The field 'norm_system_criticality' normalizes the scores across all systems from 0-1.*/
SELECT a.AUTHORIZATION_PACKAGE,
(a.hva_factor + a.mef_factor) as system_criticality,
MAX(a.hva_factor + a.mef_factor) OVER() as max,
MIN(a.hva_factor + a.mef_factor) OVER() as min
--,ROUND(((a.hva_factor + a.mef_factor)-(MIN(a.hva_factor + a.mef_factor) OVER()))/((MAX(a.hva_factor + a.mef_factor) OVER())-(MIN(a.hva_factor + a.mef_factor) OVER())),3) as norm_system_criticality
,ROUND(DIV0(((a.hva_factor + a.mef_factor)-(MIN(a.hva_factor + a.mef_factor) OVER())), ((MAX(a.hva_factor + a.mef_factor) OVER())-(MIN(a.hva_factor + a.mef_factor)) OVER())),3) as norm_system_criticality
FROM (SELECT AUTHORIZATION_PACKAGE
      ,CASE WHEN ISCURRENTYEARHVALIST='Yes' then 4 else 0 end as hva_factor
      ,CASE when len(MISSIONESSENTIALFUNCTIONS_MEFS) = 365 then 1.5 
	  when len(MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	  when len(MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	  else 0 end AS mef_factor
  FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES) a;
create or replace view VW_CEDE_PRIVACY_IMPACT_ASSESSMENT_PIA(
	AUTHORIZATION_PACKAGE,
	ATO_EXPIRATION_DATE,
	PIA_014,
	PII_TYPE,
	PII_CATEGORY,
	LEVEL,
	LEVEL_NUM,
	REPORTDATE
) COMMENT='Contains PIA category and sensitivity level at org hierarchy level'
 as
SELECT 
s.AUTHORIZATION_PACKAGE 
,s.ATO_EXPIRATION_DATE 
,s.PIA_014 
,dt.PII_TYPE 
,dc.PII_CATEGORY 
,dc.LEVEL 
,dc.LEVEL_NUM 
,(select TOP 1 REPORT_DATE from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
FROM CORE.VW_SYSTEMS s
JOIN CORE.PII_SYSTEM_PII_TYPES st on st.SYSTEM_ID = s.SYSTEM_ID
JOIN CORE.PII_DATATYPE dt on dt.PII_TYPE = st.PII_TYPE
JOIN CORE.PII_CATEGORY dc on dc.PII_CATEGORY = dt.PII_CATEGORY
;
create or replace view VW_CEDE_SYSTEM_DETAIL_WITH_PRIORITIZATION(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	CURRENT_HVA_SYS,
	MEF_COUNT,
	MEFSTATUS,
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	PRIMARY_OPERATING_LOCATION,
	SYSTEM_PII_LEVEL,
	NORM_DATA_SENSITIVITY,
	NORM_SECUIRTY_POSTURE2,
	NORM_SYSTEM_CRITICALITY,
	OVERALL_PRIORITIZATION
) COMMENT='Contains System information, PII level and aver all prioritization level'
 as
SELECT a.REPORTDATE
      ,a.AUTHORIZATION_PACKAGE
      ,a.ACRONYM
      ,a.FISMA_SYSTEM
      ,a.TLC_PHASE
      ,a.COMPONENT_ACRONYM
      ,CASE when a.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end AS current_hva_sys
	  ,CASE when len(a.MISSIONESSENTIALFUNCTIONS_MEFS)  = 365 then 2 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end as mef_count
      ,a.MEFSTATUS    
      ,a.BUSINESS_OWNER
      ,a.PRIMARY_ISSO
      ,a.SYSTEM_DESCRIPTION
      ,a.SYSTEMDEVELOPERMAINTAINER_SDM
      ,b.PRIMARY_OPERATING_LOCATION
	  ,coalesce(f.SYS_PII_LEVEL,'Undetermined') as system_pii_level
	  ,c.NORM_DATA_SENSITIVITY
	  ,coalesce(d.NORM_SECURITY_POSTURE,0) as norm_secuirty_posture2
	  ,e.NORM_SYSTEM_CRITICALITY
	  ,CASE WHEN c.NORM_DATA_SENSITIVITY>=0 and e.NORM_SYSTEM_CRITICALITY>=0 then 
	  ROUND((c.NORM_DATA_SENSITIVITY*.15) + ((1-coalesce(d.NORM_SECURITY_POSTURE,0)) *.7) + (e.NORM_SYSTEM_CRITICALITY *.15),3) END AS overall_prioritization
  FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL b on b.AUTHORIZATION_PACKAGE =a.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_DATA_SENSITIVITY c ON a.AUTHORIZATION_PACKAGE =c.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SECURITY_POSTURE d ON a.AUTHORIZATION_PACKAGE =d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SYSTEM_CRITICALITY e ON a.AUTHORIZATION_PACKAGE =e.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL f ON a.AUTHORIZATION_PACKAGE =f.AUTHORIZATION_PACKAGE
  WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes'
  ;
create or replace view VW_CEDE_SYSTEM_DETAIL_WITH_PRIORITIZATION_240216(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	CURRENT_HVA_SYS,
	MEF_COUNT,
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	PRIMARY_OPERATING_LOCATION,
	SYSTEM_PII_LEVEL,
	NORM_DATA_SENSITIVITY,
	NORM_SECUIRTY_POSTURE2,
	NORM_SYSTEM_CRITICALITY,
	OVERALL_PRIORITIZATION
) COMMENT='Contains System information, PII level and aver all prioritization level'
 as
SELECT a.REPORTDATE
      ,a.AUTHORIZATION_PACKAGE
      ,a.ACRONYM
      ,a.FISMA_SYSTEM
      ,a.TLC_PHASE
      ,a.COMPONENT_ACRONYM
      ,CASE when a.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end AS current_hva_sys
	  ,CASE when len(a.MISSIONESSENTIALFUNCTIONS_MEFS)  = 365 then 2 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end as mef_count
      ,a.BUSINESS_OWNER
      ,a.PRIMARY_ISSO
      ,a.SYSTEM_DESCRIPTION
      ,a.SYSTEMDEVELOPERMAINTAINER_SDM
      ,b.PRIMARY_OPERATING_LOCATION
	  ,coalesce(f.SYS_PII_LEVEL,'Undetermined') as system_pii_level
	  ,c.NORM_DATA_SENSITIVITY
	  ,coalesce(d.NORM_SECURITY_POSTURE,0) as norm_secuirty_posture2
	  ,e.NORM_SYSTEM_CRITICALITY
	  ,CASE WHEN c.NORM_DATA_SENSITIVITY>=0 and e.NORM_SYSTEM_CRITICALITY>=0 then 
	  ROUND((c.NORM_DATA_SENSITIVITY*.15) + ((1-coalesce(d.NORM_SECURITY_POSTURE,0)) *.7) + (e.NORM_SYSTEM_CRITICALITY *.15),3) END AS overall_prioritization
  FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL b on b.AUTHORIZATION_PACKAGE =a.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_DATA_SENSITIVITY c ON a.AUTHORIZATION_PACKAGE =c.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SECURITY_POSTURE d ON a.AUTHORIZATION_PACKAGE =d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SYSTEM_CRITICALITY e ON a.AUTHORIZATION_PACKAGE =e.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL f ON a.AUTHORIZATION_PACKAGE =f.AUTHORIZATION_PACKAGE
  WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes'
  ;
create or replace view VW_CEDE_SYSTEM_PII_LEVEL(
	AUTHORIZATION_PACKAGE,
	SYS_PII_LEVEL
) COMMENT='Contains System information, PII level and aver all prioritization level'
 as
SELECT Authorization_Package,sys_pii_level
FROM (SELECT s.Authorization_Package
    ,CASE 
	WHEN MIN(dc.Level_Num) OVER(PARTITION BY Authorization_Package)= 1 THEN 'Sensitive PII'
	WHEN MIN(dc.Level_Num) OVER(PARTITION BY Authorization_Package)= 2 THEN 'Context-Combine PII'
	WHEN MIN(dc.Level_Num) OVER(PARTITION BY Authorization_Package)= 3 THEN 'Non-sensitive PII'
	WHEN MIN(dc.Level_Num) OVER(PARTITION BY Authorization_Package)= 4 THEN 'No PII'
	ELSE 'Undetermined'
	END as sys_pii_level
FROM CORE.VW_SYSTEMS s
JOIN CORE.PII_SYSTEM_PII_TYPES st on st.SYSTEM_ID = s.SYSTEM_ID
JOIN CORE.PII_DATATYPE dt on dt.PII_TYPE = st.PII_TYPE
JOIN CORE.PII_CATEGORY dc on dc.PII_CATEGORY = dt.PII_CATEGORY) t  
--  FROM CEDE.VW_CEDE_Privacy_Impact_Assessment_PIA) a
GROUP by t.Authorization_Package,t.sys_pii_level
;
create or replace schema CORE COMMENT='Main schema for SDW/CRM';

create or replace sequence SEQ_TEMP_DW_ASSET_ID start with 1 increment by 1 order;
create or replace TABLE ALERTLOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	APPL VARCHAR(16777216),
	CUSTOM_ERRMSG VARCHAR(16777216),
	ERRTYPE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	SQLCODE VARCHAR(16777216),
	SQLERRM VARCHAR(16777216),
	SQLSTATE VARCHAR(16777216),
	primary key (ID)
)COMMENT='SQL Errors Messages captured for CRM tasks, e.g. Raised CRM_logic_exception.\t'
;
create or replace TABLE ALLOCATEDCONTROL (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ALLOCATION_STATUS VARCHAR(16777216),
	CONTROL_ELEMENT VARCHAR(16777216),
	CONTROL_ELEMENT_NUMBER VARCHAR(16777216),
	CONTROL_FAMILY VARCHAR(16777216),
	CONTROL_NAME VARCHAR(16777216),
	CONTROL_NUMBER VARCHAR(16777216),
	CONTROL_NUMBER_COMBO VARCHAR(16777216),
	CONTROL_SET_VERSION_NUMBER VARCHAR(16777216),
	HYBRID_CONTROL VARCHAR(16777216),
	INHERITABLE_BY_OTHER_SYSTEMS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	LAST_SCA_DATE TIMESTAMP_LTZ(9),
	OVERALL_CONTROL_STATUS VARCHAR(16777216),
	PRIVATE_IMP_UPDATED_DATE TIMESTAMP_LTZ(9),
	REPORT_ID NUMBER(38,0),
	RESPONSIBILITY VARCHAR(16777216),
	SHARED_IMP_UPDATED_DATE TIMESTAMP_LTZ(9),
	SIGNIFICANT_CONTROL_CHANGE VARCHAR(16777216),
	SIGNIFICANT_CONTROL_CHANGE_DETAILS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TRACKING_ID NUMBER(38,0),
	PRIVATE_IMPLEMENTATION_DETAILS VARCHAR(16777216),
	primary key (ID)
)COMMENT='System security controls from CFACT, based on FIPS level\t'
;
create or replace TABLE ASSET (
	DW_ASSET_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216) NOT NULL,
	ENVIRONMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	IS_APPLICABLE BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	SOURCE_TOOL_CREATE VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	DEVICEMODEL VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	IS_FROM_AWS_FEED BOOLEAN,
	CREATEDBY_SNAPSHOT_ID NUMBER(38,0),
	CREATEDBY_RAW_ID NUMBER(38,0),
	MODIFIEDBY_SNAPSHOT_ID NUMBER(38,0),
	MODIFIEDBY_RAW_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	CREATEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	MODIFIEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	OS_BUILD_NUMBER VARCHAR(16777216),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	PREV_SYSTEM_ID VARCHAR(16777216),
	DW_DERIVED_DEVICETYPE VARCHAR(16777216),
	FORESCOUT_DEVICETYPE VARCHAR(16777216),
	TENABLE_DEVICETYPE VARCHAR(16777216),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216),
	IS_ENDPOINT BOOLEAN,
	BETA_VULNRISKTOLERANCE NUMBER(10,2),
	primary key (DW_ASSET_ID)
)COMMENT='ASSET (MDR) Information including IDs asssigned by source tools, Datacener_ID, System_ID, create/modify/delete timestamp etc..\t'
;
create or replace TABLE ASSETHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSET_ID_TATTOO VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DEVICETYPE VARCHAR(16777216) NOT NULL,
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	ENVIRONMENT VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SOURCE_TOOL_CREATE VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	DEVICEMODEL VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	ASSET_DATECREATED TIMESTAMP_LTZ(9),
	TENANT_ID VARCHAR(16777216),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_FROM_AWS_FEED BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	OS_BUILD_NUMBER VARCHAR(16777216),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	PREV_SYSTEM_ID VARCHAR(16777216),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216),
	IS_ENDPOINT BOOLEAN,
	primary key (ID)
)COMMENT='History records of assets\t'
;
create or replace TABLE ASSETINTERFACECOALESCED (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IPV4 VARCHAR(16777216),
	IPV6 VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='Current coalesced asset interface table based on ASSETINTERFACE table for FQDN, HOSTNAME, IPv4, IPv6, MAC Address, NETBios Name\t'
;
create or replace TABLE ASSETINTERFACECOALESCEDHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	IPV6 VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	primary key (ID)
)COMMENT='History records of ASSETINTERFACECOALESCED\t'
;
create or replace TABLE ASSETINTERFACE_FQDN (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FQDN VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	NORMALIZED_FQDN VARCHAR(16777216),
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, FQDN and data source.\t'
;
create or replace TABLE ASSETINTERFACE_HOSTNAME (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	HOSTNAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	NORMALIZED_HOSTNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, HOSTNAME and data source.\t'
;
create or replace TABLE ASSETINTERFACE_IPV4 (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IPV4 VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, IPv4 and data source.\t'
;
create or replace TABLE ASSETINTERFACE_IPV6 (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IPV6 VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, IPv6 and data source.\t'
;
create or replace TABLE ASSETINTERFACE_MACADDRESS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	MACADDRESS VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	NORMALIZED_MACADDRESS VARCHAR(16777216),
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, MAC Address and data source.\t'
;
create or replace TABLE ASSETINTERFACE_NETBIOSNAME (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	NETBIOSNAME VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9) NOT NULL,
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='ASSET DW_ASSET_ID, NETBios Name and data source.\t'
;
create or replace TABLE ASSET_LOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	COMMENTS VARCHAR(16777216) NOT NULL,
	primary key (ID)
)COMMENT='ASSET (MDR) log for recording deletions, system_ID, other.\t'
;
create or replace TABLE ASSET_SNAPSHOT_LOG (
	ASSET_DATECREATED TIMESTAMP_LTZ(9),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	CREATEDBY_RAW_ID NUMBER(38,0),
	CREATEDBY_SNAPSHOT_ID NUMBER(38,0),
	CREATEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DEVICEMODEL VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	ENVIRONMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	IS_APPLICABLE BOOLEAN,
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	IS_FROM_AWS_FEED BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MODIFIEDBY_RAW_ID NUMBER(38,0),
	MODIFIEDBY_SNAPSHOT_ID NUMBER(38,0),
	MODIFIEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_BUILD_NUMBER VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	PREV_SYSTEM_ID VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL_CREATE VARCHAR(16777216),
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216),
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	TENANT_ID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216)
);
create or replace TABLE ASSET_SOFTWARE (
	DW_SWAM_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	SWAM_SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (DW_SWAM_ID)
)COMMENT='Software associated with an asset\t'
;
create or replace TABLE ASSET_SOFTWARE_TOMTEST (
	DW_SWAM_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	SWAM_SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	SOURCETOOL_ENHANCEMENT VARCHAR(16777216),
	SOFTWARE_NAME_ID NUMBER(38,0),
	primary key (DW_SWAM_ID)
)COMMENT='Software associated with an asset\t'
;
create or replace TABLE ASSET_TOMTEST (
	DW_ASSET_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216) NOT NULL,
	ENVIRONMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	IS_APPLICABLE BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	SOURCE_TOOL_CREATE VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	DEVICEMODEL VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	IS_FROM_AWS_FEED BOOLEAN,
	CREATEDBY_SNAPSHOT_ID NUMBER(38,0),
	CREATEDBY_RAW_ID NUMBER(38,0),
	MODIFIEDBY_SNAPSHOT_ID NUMBER(38,0),
	MODIFIEDBY_RAW_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	CREATEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	MODIFIEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	OS_BUILD_NUMBER VARCHAR(16777216),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	PREV_SYSTEM_ID VARCHAR(16777216),
	primary key (DW_ASSET_ID)
)COMMENT='ASSET (MDR) Information including IDs asssigned by source tools, Datacener_ID, System_ID, create/modify/delete timestamp etc..\t'
;
create or replace TABLE CAATHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACT_CAAT_FILEPROCESSEDDATE TIMESTAMP_LTZ(9),
	ASSESSMENT_AUDIT_COMPANY VARCHAR(16777216),
	CAAT_ID VARCHAR(16777216) NOT NULL,
	DATE_IDENTIFIED TIMESTAMP_LTZ(9),
	FINDING_DESCRIPTION VARCHAR(16777216),
	FINDING_ID VARCHAR(16777216),
	FINDING_TITLE VARCHAR(16777216),
	RELATED_POAMS VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SOURCE_AUDIT_TYPE VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TEST_METHOD VARCHAR(16777216),
	TEST_OBJECTIVE VARCHAR(16777216),
	TEST_RESULT VARCHAR(16777216),
	WEAKNESS_DESCRIPTION VARCHAR(16777216),
	primary key (ID)
)COMMENT='History records of system audit result, assessment, and assoicated POAMs. CAAT=CMS Assessment and Audit Tracking\t'
;
create or replace TABLE CEDE_MVP_POAMS_CONTROLS (
	ALLOCATED_CONTROL VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	POAM_ID NUMBER(38,0),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SYSTEM_ID VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216)
)COMMENT='POAMs and associated system security control status used ffor CEDE\t'
;
create or replace TABLE CFACTSLISTOFMARKETPLACEFISMASYSTEMSANDIDS_240730 (
	INFORMATIONSYSTEM VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	PRIMARYOPERATINGLOCATION VARCHAR(16777216),
	FISMAID VARCHAR(16777216)
);
create or replace TABLE CFACTS_COLUMN_NAMES (
	DBNAME VARCHAR(16777216),
	DBSCHEMA VARCHAR(16777216),
	TABLE_NAME VARCHAR(16777216),
	COLUMN_NAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9)
);
create or replace TABLE CFACTS_USERMAPPING (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACRONYM VARCHAR(16777216),
	ROLE VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	USER_ID VARCHAR(16777216),
	primary key (ID)
)COMMENT='User role mapping for each system in CFACTS.\t'
;
create or replace TABLE CMR_APP_ARCHER_SYSTEMS_250303 (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_NTZ(9),
	ARCHER_TRACKING_ID NUMBER(38,0),
	ATO_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_NTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_NTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_NTZ(9),
	BO_REVIEW_DATE TIMESTAMP_NTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_NTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_NTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_NTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_NTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_NTZ(9),
	DATE_AUTH_MEMO_SIGNED DATE,
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_NTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_NTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_NTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_NTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_NTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(4),
	GROUP_DESCRIPTION VARCHAR(4),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE FLOAT,
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(16777216),
	ISRA_REVIEW_DATE TIMESTAMP_NTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(9,0),
	ISSO_REVIEW_DATE TIMESTAMP_NTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_NTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_NTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_NTZ(9),
	OA_STATUS VARCHAR(16777216),
	OPERATED_BY VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_NTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_NTZ(9),
	STE_DATE TIMESTAMP_NTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CMR_APP_ARCHER_SYSTEMS_250304 (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_NTZ(9),
	ARCHER_TRACKING_ID NUMBER(38,0),
	ATO_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_NTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_NTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_NTZ(9),
	BO_REVIEW_DATE TIMESTAMP_NTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_NTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_NTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_NTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_NTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_NTZ(9),
	DATE_AUTH_MEMO_SIGNED DATE,
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_NTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_NTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_NTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_NTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_NTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(4),
	GROUP_DESCRIPTION VARCHAR(4),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE FLOAT,
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(16777216),
	ISRA_REVIEW_DATE TIMESTAMP_NTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(9,0),
	ISSO_REVIEW_DATE TIMESTAMP_NTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_NTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_NTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_NTZ(9),
	OA_STATUS VARCHAR(16777216),
	OPERATED_BY VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_NTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_NTZ(9),
	STE_DATE TIMESTAMP_NTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CMR_APP_CFACTS_SYSTEMS_250304 (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	ARCHER_TRACKING_ID VARCHAR(16777216),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(1),
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(18,0),
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	OPERATED_BY VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CMR_AUTHORIZATION_PACKAGE (
	_CONTENT_ID NUMBER(38,0),
	_APPLICATION_ALIAS VARCHAR(16777216),
	_APPLICATION_GUID VARCHAR(16777216),
	_LEVEL_ALIAS VARCHAR(16777216),
	_LEVEL_GUID VARCHAR(16777216),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	AUTHORIZATION_DECISION VARIANT,
	IDUID VARCHAR(16777216),
	CHIEF_INFORMATION_SECURITY_OFFICER_CISO VARIANT,
	COMPONENT_RISK_REPORTS_OVERSIGHT VARIANT,
	LAST_CONTINGENCY_PLAN_TEST_DATE TIMESTAMP_NTZ(9),
	INFORMATION_TYPE VARIANT,
	CONTROL_OWNER_CO VARIANT,
	DSPC_POC VARIANT,
	CYBER_RISK_ADVISOR_CRA VARIANT,
	FINANCIAL_SYSTEM VARIANT,
	FISMA_REPORTABLE VARIANT,
	INFORMATION_SYSTEM_ADMINISTRATOR_ISA VARIANT,
	INFORMATION_SYSTEM_OWNER_ISO VARIANT,
	PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI VARIANT,
	INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO VARIANT,
	ISSO_CONTRACTOR_SUPPORT_ISSOCS VARIANT,
	INFORMATION_SYSTEM_TYPE VARIANT,
	IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST VARIANT,
	MARKETPLACE_SYSTEMS VARIANT,
	MISSION_ESSENTIAL_FUNCTIONS_ VARIANT,
	OA_READY VARIANT,
	OA_STATUS VARIANT,
	OPERATED_BY VARIANT,
	OPERATING_LOCATION VARIANT,
	PACKAGE_TYPE VARIANT,
	PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR VARIANT,
	RECOMMENDED_SECURITY_CATEGORY VARIANT,
	SECURITY_CONTROL_ASSESSOR_SCA VARIANT,
	TLC_PHASE VARIANT,
	DOES_THE_SYSTEM_SUPPORT_THE_ACTIVITIES_O VARIANT,
	IS_THE_PII_THAT_THE_SYSTEM_COLLECTS_MAIN VARIANT,
	IS_THE_SYSTEM_PUBLIC_AKA_INTERNET_FACING VARIANT,
	ACTSCA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_NTZ(9),
	AMOUNT FLOAT,
	AUTHENTICATION_REQUIRED VARIANT,
	AUTHORIZATION_BOUNDARY_DESCRIPTION VARCHAR(16777216),
	AUTHORIZATION_PACKAGE_NAME_CALCULATED VARCHAR(16777216),
	BASELINE_CONTROLS_ALLOCATED_DATE TIMESTAMP_NTZ(9),
	BASELINE_CONTROLS_INHERITED_DATE TIMESTAMP_NTZ(9),
	CMS_PRIORITY FLOAT,
	COMMUNICATIONS FLOAT,
	COMPONENT_NAME_ VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPUTER_MATCHING_AGREEMENT_TEST_DATE TIMESTAMP_NTZ(9),
	CONCAT_CSP VARCHAR(16777216),
	CONDITIONS_MUST_BE_MET_BY_DATE TIMESTAMP_NTZ(9),
	CONDITIONAL_ATO_STATEMENT VARCHAR(16777216),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	COUNT_OF_ACTIVE_HARDWARE FLOAT,
	COUNT_OF_ALLOCATED_DETAILS_EMPTY FLOAT,
	COUNT_OF_ALLOCATED_DETAILS_NOT_EMPTY FLOAT,
	COUNT_OF_ALLOCATED_ELEMENTS FLOAT,
	COUNT_OF_ARCHIVED_CONTROLS FLOAT,
	COUNT_OF_ARS_50_ALLOCATED_CONTROL_EL FLOAT,
	COUNT_OF_ARS_50_ALLOCATED_CONTROLS FLOAT,
	COUNT_OF_ARS_50_NOT_ASSESSED_OTHER_ELEM FLOAT,
	COUNT_OF_ARS_50_NOT_ASSESSED_AND_OTHER_T FLOAT,
	COUNT_OF_ARS_50_CONTROL_ELEMENTS FLOAT,
	COUNT_OF_ARS_50_CONTROLS FLOAT,
	COUNT_OF_ARS_50_INHERITED_CONTROL_EL FLOAT,
	COUNT_OF_ARS_51_INHERITED__FEDRAMP_CONTR FLOAT,
	COUNT_OF_ARS_50_INHERITED_CONTROLS FLOAT,
	COUNT_OF_BASELI_ALLOCAT_CON_ELEM_WITH_PR FLOAT,
	COUNT_OF_BASE_ALL_CON_ELE_W_SHAR FLOAT,
	COUNT_OF_BASELINE_ALLOCAT_CON_EL_WO_P FLOAT,
	COUNT_OF_BASE_ALLOCA_CONT_ELE_WO_SHARE FLOAT,
	COUNT_OF_BASELINE_CONTROL_ELEMEN FLOAT,
	COUNT_OF_BASELINE_CONTROLS FLOAT,
	COUNT_OF_BASELINE_INHERITED_CONTROLS_WIT FLOAT,
	COUNT_OF_COMPLETED_POAMS FLOAT,
	COUNT_OF_CONTROLS_WITH_PII FLOAT,
	COUNT_OF_OVERDUE_POAMS FLOAT,
	COUNT_OF_FEDRAMP_REV4_CONTROLS FLOAT,
	COUNT_OF_HARDWARE FLOAT,
	COUNT_OF_INHERITED_CONTROLS_THAT_HAVE_BE FLOAT,
	COUNT_OF_INTERCONNECTIONS FLOAT,
	COUNT_OF_INTERNAL_INTERCONNECTIONS FLOAT,
	COUNT_OF_HIGH_RISK_LEVEL_POAMS FLOAT,
	COUNT_OF_LOW_RISK_LEVEL_POAMS FLOAT,
	COUNT_OF_OPEN_LOW_VULNERABILITIES FLOAT,
	COUNT_OF_SATISFIED_CONTROLS FLOAT,
	COUNT_OF_SOFTWARE FLOAT,
	COUNT_OF_SUPPLEMENTAL_CONTROL_EL FLOAT,
	COUNT_OF_SUPPLEMENTAL_CONTROLS FLOAT,
	COUNT_OF_TOTAL_PRIVILEGED_USER_POPULATIO FLOAT,
	CSPS VARCHAR(16777216),
	ATO_IATO_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	COPY_OF_ATO_DATE TIMESTAMP_NTZ(9),
	DAYS_SINCE_SYSTEM_RETIRED FLOAT,
	DAYS_TO_ACT_EXPIRATION FLOAT,
	DAYS_TO_ATO_EXPIRATION FLOAT,
	DAYS_TO_CONTINGENCY_PLAN_TEST_EXPIRATION FLOAT,
	DAYS_TO_NEXT_INCIDENT_RESPONSE_PLAN_REVI FLOAT,
	DAYS_TO_NEXT_REQU_INCIDE_RESPO_PLAN_TEST FLOAT,
	DAYS_TO_ISRA_EXPIRATION FLOAT,
	DAYS_TO_NEXT_ISSO_LETTER_EXPIRATION FLOAT,
	DAYS_TO_PENTEST_EXPIRATION FLOAT,
	DAYS_TO_PIA_EXPIRATION FLOAT,
	DIVISION_NAME VARCHAR(16777216),
	EAUTHENTICATION_LEVEL VARIANT,
	CLOUD_SERVICE_PROVIDERS_INHERITED_DATE TIMESTAMP_NTZ(9),
	FIRST_PUBLISHED TIMESTAMP_NTZ(9),
	FQDN_ADDED_DATE TIMESTAMP_NTZ(9),
	GROUP_NAME VARCHAR(16777216),
	HARDWARE_HOST_STATUS VARCHAR(16777216),
	SYSTEMDESCRIPTION_TRUNCATED VARCHAR(16777216),
	TYPE_OF_MULTIFACTOR_AUTHENTICATION_IN_US VARIANT,
	IMPLEMENTATION_DETAILS_COMPLETED_DATE TIMESTAMP_NTZ(9),
	INHERITED_LAST_ACT_DATE TIMESTAMP_NTZ(9),
	INHERITED_LAST_ASSESSMENT_DATE TIMESTAMP_NTZ(9),
	INHERITED_LAST_PENTEST_DATE TIMESTAMP_NTZ(9),
	INHERITED_LAST_SCA_DATE TIMESTAMP_NTZ(9),
	IS_THIS_SYSTEM_ACCESSED_BY_NONORGANIZATI VARIANT,
	JUSTIFICATION VARCHAR(16777216),
	LAST_ACT_CREATED_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_ASSESSMENT_DATE TIMESTAMP_NTZ(9),
	LAST_CERTIFICAITON_FORM_UPDATE_DATE TIMESTAMP_NTZ(9),
	LAST_COMPUTER_MATCHING_AGREEMENT_EXPIRAT TIMESTAMP_NTZ(9),
	LAST_CONTINGENCY_PLAN_COMPLETION_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_DATE TIMESTAMP_NTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_NTZ(9),
	LAST_CYBERSECURITY_CERTIFICATION_EXPIRAT TIMESTAMP_NTZ(9),
	LAST_ISRA_COMPLETION_DATE TIMESTAMP_NTZ(9),
	LAST_ISRA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LAST_ISSO_LETTER_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_NTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_NTZ(9),
	LAST_PIA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LAST_SAR_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LAST_SIA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LAST_VULN_SCAN_DATE TIMESTAMP_NTZ(9),
	ATO_IATO_DATE TIMESTAMP_NTZ(9),
	AUTHORIZATION_PACKAGE_SUBMIT_DATE TIMESTAMP_NTZ(9),
	LATEST_NUMBER_OF_DAYS_IN_ATO_REVIEW FLOAT,
	LATEST_NO_OF_DAYS_IN_BO_RECOMMEND FLOAT,
	LATEST_NO_OF_DAYS_IN_BO_REQUEST_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_CIO_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_CISO_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_CRA_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_DSPC_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_DSPPO_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_ISSO_REC_REV_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_ISSO_REQUEST_QUEUE FLOAT,
	LATEST_NO_OF_DAYS_IN_SDM_QUEUE FLOAT,
	MAXIMUM_TOLERABLE_DOWNTIME_MTD FLOAT,
	MOST_RECENT_FQDN_ADDED VARCHAR(16777216),
	LAST_CONTINGENCY_PLAN_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	NEXT_REQUIRED_CONTINGENCY_PLAN_NAME VARCHAR(16777216),
	NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE TIMESTAMP_NTZ(9),
	LAST_INCIDENT_RESPONSE_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	NEXT_REQUIRED_INCIDENT_RESPONSE_PLAN_TES TIMESTAMP_NTZ(9),
	NEXT_REQUIRED_ISRA_REVIEW_DATE TIMESTAMP_NTZ(9),
	NEXT_SCHEDULED_ACT_DATE TIMESTAMP_NTZ(9),
	NEXT_PENTEST_DATE TIMESTAMP_NTZ(9),
	NEXT_SCHEDULED_SCA_DATE TIMESTAMP_NTZ(9),
	NUMBER_OF_CONTROL_ELEMENTS_BEING_INHERIT FLOAT,
	NUMBER_OF_CONTROLS_BEING_INHERITED_BY_OT FLOAT,
	NUMBER_OF_POAMS_NOT_COMPLETED_ FLOAT,
	NUMBER_OF_VULNERABILITIES FLOAT,
	OM_XLC_PHASE_DATE_ TIMESTAMP_NTZ(9),
	OA_CANDIDATE_OVERRIDE_JUSTIFICATION VARCHAR(16777216),
	OPDIV_NAME VARCHAR(16777216),
	CURRENT_ATO_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	LATEST_ATO_APPROVAL_DATE TIMESTAMP_NTZ(9),
	LATEST_ATO_SUBMISSION_DATE TIMESTAMP_NTZ(9),
	PENTEST_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	PIA_011_LANGUAGE VARCHAR(16777216),
	PIA_COMPLETION_DATE TIMESTAMP_NTZ(9),
	PIA_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	PREASSESSMENT_PROGRESS_VIEW VARCHAR(16777216),
	PRE_ASSESSMENT_REVIEW_COMMENTS VARCHAR(16777216),
	PTA_COMPLETION_DATE TIMESTAMP_NTZ(9),
	RECORD_STATUS VARCHAR(16777216),
	RECOVERY_POINT_OBJECTIVE_RPO FLOAT,
	RECOVERY_TIME_OBJECTIVE_RTO FLOAT,
	MFA_AUTHORIZATION_PACKAGE VARIANT,
	SUBMISSION_DATE TIMESTAMP_NTZ(9),
	DECOMMISSION_REQUEST_DATE TIMESTAMP_NTZ(9),
	DECOMMISSION_APPROVAL_DATE TIMESTAMP_NTZ(9),
	DISPOSITION_XLC_PHASE_DATE_ TIMESTAMP_NTZ(9),
	SCA_DATE TIMESTAMP_NTZ(9),
	SECURITY_OPERATIONS_POC_NAME VARCHAR(16777216),
	STE_DATE TIMESTAMP_NTZ(9),
	ARS_50_STATUS VARCHAR(16777216),
	SYSTEM_FQDNS_ODA VARIANT,
	SYSTEMS_OF_RECORDS_NOTICE_SORN VARCHAR(16777216),
	SYSTEMDESC_HAS_TABLE VARCHAR(16777216),
	TARGET_DECOMMISSION_DATE TIMESTAMP_NTZ(9),
	TODAY TIMESTAMP_NTZ(9),
	TOTAL_COUNT_OF_NONORGANIZATIONAL_USERS FLOAT,
	TOTAL_COUNT_OF_ORGANIZATIONAL_USERS FLOAT,
	TOTAL_COUNT_OF_NONPRIVILEGED_ORGANIZATIO FLOAT,
	TOTAL_COUNT_OF_PRIVILEGED_ORGANIZATIONAL FLOAT,
	TOTAL_ASSET_COUNT FLOAT,
	COPY_OF_TOTAL_OM_CONTINGENCY_PLAN_EXPIRE FLOAT,
	TOTAL_CAAT_PEN_TEST_FINDINGS_HIGH FLOAT,
	TOTAL_SOFTWARE_ASSET_COUNT FLOAT,
	WORK_RECOVERY_TIME_WRT FLOAT,
	INHERITED_LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_NTZ(9),
	COUNT_OF_SYSTEM_FQDNS FLOAT,
	SYSTEM_OBSERVER VARIANT,
	GOVERNMENT_TECHNICAL_LEAD_GTL VARIANT,
	AUTHORIZING_OFFICIAL_AO VARIANT,
	DEPUTY_CHIEF_INFORMATION_OFFICER_DCIO VARIANT,
	DEFAULT_RECORD_PERMISSIONS VARIANT,
	CLOUDSERVICEPROVIDERS VARIANT,
	EAUTHENTICATION_EXPIRATION_DATE TIMESTAMP_NTZ(9),
	EAUTHENTICATION_DATE TIMESTAMP_NTZ(9),
	DIGITAL_IDENTITY_LEVEL VARIANT,
	_RELATIONSHIP_BUSINESS_UNIT VARIANT,
	_RELATIONSHIP_DIVISION VARIANT,
	_RELATIONSHIP_COMPANY VARIANT,
	_RELATIONSHIP_SYSTEM_FQDNS VARIANT,
	__UNIQUE_ROW_ID VARCHAR(16777216),
	__BATCH_ID VARCHAR(16777216),
	__BATCH_NUMBER NUMBER(38,0),
	__BATCH_TIMESTAMP TIMESTAMP_NTZ(9),
	__JOB_ID VARCHAR(16777216),
	__JOB_TIMESTAMP TIMESTAMP_NTZ(9),
	CONTINGENCY_PLAN_TEST_RESULTS VARIANT,
	BASELINE_HIGHEST_DEVICE_RISK_SCORE FLOAT,
	ISRA_STATUS VARIANT,
	IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF VARIANT
);
create or replace TABLE CMR_CFACTS_SYSTEMS (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	ARCHER_TRACKING_ID VARCHAR(16777216),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(1),
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(18,0),
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	OPERATED_BY VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CONFIG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	COMMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	PARMDATE TIMESTAMP_LTZ(9),
	PARMINT NUMBER(38,0),
	PARMNAME VARCHAR(16777216),
	PARMVARCHAR VARCHAR(16777216),
	primary key (ID)
)COMMENT='CRM stored procedure parameter list\t'
;
create or replace TABLE CORECONTROLS (
	CONTROL VARCHAR(16777216) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	primary key (CONTROL)
)COMMENT='Core system security controls (e.g. NIST 800-53)\t'
;
create or replace TABLE CORE_CONTROLS_OA (
	NUM NUMBER(38,0),
	CORE_CONTROL VARCHAR(16777216),
	CONTROL_DESCRIPTION VARCHAR(16777216),
	CSF_GOVERN VARCHAR(16777216),
	CSF_IDENTIFY VARCHAR(16777216),
	CSF_PROTECT VARCHAR(16777216),
	CSF_DETECT VARCHAR(16777216),
	CSF_RESPOND VARCHAR(16777216),
	CSF_RECOVER VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL
)COMMENT='Source: Core Controls White Paper (2025) v1.0_Final'
;
create or replace TABLE CRMP_METRICS (
	FISMASEVERITY VARCHAR(16777216) NOT NULL,
	IS_LEGACY BOOLEAN NOT NULL,
	LEVELNAME VARCHAR(16777216) NOT NULL,
	LEVELTYPE VARCHAR(16777216) NOT NULL,
	MITIGATIONSTATUS VARCHAR(16777216) NOT NULL,
	TOTAL NUMBER(38,0) NOT NULL
)COMMENT='High level Cyber Risk Management Performance Metrics per group, system. Component.\t'
;
create or replace TABLE DATACENTERSUMMARY (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSETS NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	HWAMRAWAWS NUMBER(38,0),
	HWAMRAWBIGFIX NUMBER(38,0),
	HWAMRAWFORESCOUT NUMBER(38,0),
	OPERATIONALSYSTEMS NUMBER(38,0),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SYSTEMS NUMBER(38,0),
	VULCRITICAL NUMBER(38,0),
	VULCRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT60DAYS NUMBER(38,0),
	VULCRITICAL_GTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE30DAYS NUMBER(38,0),
	VULDELETED NUMBER(38,0),
	VULHIGH NUMBER(38,0),
	VULHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULHIGH_GT60DAYS NUMBER(38,0),
	VULHIGH_LTE30DAYS NUMBER(38,0),
	VULLOW NUMBER(38,0),
	VULMEDIUM NUMBER(38,0),
	VULRAW NUMBER(38,0),
	VULRAW_CRITICAL NUMBER(38,0),
	VULRAW_HIGH NUMBER(38,0),
	VULRAW_LOW NUMBER(38,0),
	VULRAW_MEDIUM NUMBER(38,0),
	VULUNIQUECRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GTE15DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT60DAYS NUMBER(38,0),
	VULUNIQUELOW NUMBER(38,0),
	VULUNIQUEMEDIUM NUMBER(38,0),
	primary key (ID)
)COMMENT='Data Center Asset total count from different sources, overall vuln status for <30, 30-60, > 60 days\t'
;
create or replace TABLE DATACENTERSYSTEMSUMMARY (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSETS NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	HWAMRAWAWS NUMBER(38,0),
	HWAMRAWBIGFIX NUMBER(38,0),
	HWAMRAWFORESCOUT NUMBER(38,0),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	VULCRITICAL NUMBER(38,0),
	VULCRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT60DAYS NUMBER(38,0),
	VULCRITICAL_GTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE30DAYS NUMBER(38,0),
	VULDELETED NUMBER(38,0),
	VULHIGH NUMBER(38,0),
	VULHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULHIGH_GT60DAYS NUMBER(38,0),
	VULHIGH_LTE30DAYS NUMBER(38,0),
	VULLOW NUMBER(38,0),
	VULMEDIUM NUMBER(38,0),
	VULRAW NUMBER(38,0),
	VULRAW_CRITICAL NUMBER(38,0),
	VULRAW_HIGH NUMBER(38,0),
	VULRAW_LOW NUMBER(38,0),
	VULRAW_MEDIUM NUMBER(38,0),
	VULUNIQUECRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GTE15DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT60DAYS NUMBER(38,0),
	VULUNIQUELOW NUMBER(38,0),
	VULUNIQUEMEDIUM NUMBER(38,0),
	primary key (ID)
)COMMENT='Datacenter/FISMA System Asset total count from different sources, overall vuln status for <30, 30-60, > 60 days\t'
;
create or replace TABLE DEVICEROLES (
	DEVICEROLE VARCHAR(16777216) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	primary key (DEVICEROLE)
)COMMENT='Lists of device roles (e.g. endpoint, mobile, networking device, etc..)\t'
;
create or replace TABLE DEVICETYPES (
	DEVICEROLE VARCHAR(16777216) NOT NULL,
	DEVICETYPE VARCHAR(16777216) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_CANBETAGGEDWITHFISMAID BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	IS_WORKSTATIONORSERVER BOOLEAN,
	COMMENTS VARCHAR(16777216),
	FISMA_DEVICE_ID NUMBER(38,0),
	primary key (DEVICETYPE)
)COMMENT='Device roles and types mapping and whether tattooable or scannable, etc..\t'
;
create or replace TABLE EXPECTED_CFACTS_COLUMNS (
	TABLE_CATALOG VARCHAR(16777216),
	TABLE_SCHEMA VARCHAR(16777216),
	TABLE_NAME VARCHAR(16777216),
	COLUMN_NAME VARCHAR(16777216),
	DATA_TYPE VARCHAR(16777216)
);
create or replace TABLE FISMA_DEVICE_ID_241119_2130 (
	DEVICETYPE VARCHAR(16777216),
	FISMA_DEVICE_ID NUMBER(38,0)
);
create or replace TABLE FISMA_DEVICE_TYPES (
	FISMA_DEVICE_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DEVICE_ROLE VARCHAR(16777216),
	DEVICE_TYPE VARCHAR(16777216),
	primary key (FISMA_DEVICE_ID)
)COMMENT='Source: FY24_FISMA_CIO_Metrics_v1.0_FINAL_1'
;
create or replace TABLE INVALIDUIDS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATASOURCE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INVALIDUID VARCHAR(16777216),
	primary key (ID)
)COMMENT='List of IDs previously determined to be invalid and are used to generate error messages for asset records.\t'
;
create or replace TABLE KEV_CATALOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	AVGDAYSSINCEDISCOVERED NUMBER(38,0),
	BODDUEDATE TIMESTAMP_TZ(9) NOT NULL,
	CVE VARCHAR(16777216) NOT NULL,
	DATEADDEDTOCATALOG TIMESTAMP_TZ(9),
	DATEDELETED TIMESTAMP_TZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_DELETED BOOLEAN,
	LASTFOUND TIMESTAMP_TZ(9),
	NOTES VARCHAR(16777216),
	ORIG_DUEDATE TIMESTAMP_TZ(9),
	PRODUCT VARCHAR(16777216),
	REQUIREDACTION VARCHAR(16777216),
	SHORTDESCRIPTION VARCHAR(16777216),
	VENDORPROJECT VARCHAR(16777216),
	VULNERABILITYNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='Known Exploited Vulnerabilities Catalog from CISA\t'
;
create or replace TABLE KNOWN_MACADDRESS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ADDRESSPREFIX VARCHAR(16777216) NOT NULL,
	COMMENTS VARCHAR(16777216),
	ENDMACADDRESS VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	STARTMACADDRESS VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	primary key (ID)
)COMMENT='Known MAC Address to vendor mapping from NMAP\t'
;
create or replace TABLE LEGACY_ASSET (
	DW_ASSET_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DATACENTER_ID VARCHAR(16777216),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	IS_APPLICABLE BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	SOURCE_TOOL_CREATE VARCHAR(16777216),
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2)
)COMMENT='ASSET (MDR) Information including IDs asssigned by source tools, Datacener_ID, System_ID, create/modify/delete timestamp etc.. From Legacy\t'
;
create or replace TABLE LEGACY_ASSETHIST (
	DW_ASSET_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DEVICETYPE VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SOURCE_TOOL_CREATE VARCHAR(16777216),
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN
)COMMENT='ASSET (MDR) HISTORY Information including IDs asssigned by source tools, Datacener_ID, System_ID, create/modify/delete timestamp etc.. From Legacy\t'
;
create or replace TABLE LEGACY_POAMHIST (
	ACTUAL_COMPLETION_DATE TIMESTAMP_LTZ(9),
	CAAT VARCHAR(16777216),
	CAAT_ID VARCHAR(16777216),
	COST VARCHAR(16777216),
	DAYS_OPEN VARCHAR(16777216),
	ESTIMATED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	FUNDING_SOURCE VARCHAR(16777216),
	LABOR_ESTIMATE VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	POAM_CLOSED_DATE TIMESTAMP_LTZ(9),
	POAM_ID VARCHAR(16777216) NOT NULL,
	POAM_OWNER VARCHAR(16777216),
	POAM_REVIEWER VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	REVIEW_COMMENTS VARCHAR(16777216),
	REVIEW_DATE TIMESTAMP_LTZ(9),
	REVIEW_STATUS VARCHAR(16777216),
	SCHEDULED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	SUBMISSION_STATUS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TARGET VARCHAR(16777216),
	WEAKNESS_CREATION_DATE TIMESTAMP_LTZ(9),
	WEAKNESS_ID VARCHAR(16777216),
	WEAKNESS_POC VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216),
	WEAKNESS_SEVERITY VARCHAR(16777216),
	CVE VARCHAR(16777216)
)COMMENT='History of POAM. Tracks POAM including review date and status\t'
;
create or replace TABLE LEGACY_REPORTIDS (
	ID NUMBER(38,0),
	DATECREATED TIMESTAMP_NTZ(9),
	REPORTDATE TIMESTAMP_NTZ(9),
	IS_ENDOFMONTH NUMBER(38,0)
);
create or replace TABLE LEGACY_REPORTSNAPSHOTS (
	ID NUMBER(38,0),
	DATECREATED TIMESTAMP_NTZ(9),
	FK_REPORTID NUMBER(38,0),
	FK_SNAPSHOTID VARCHAR(16777216)
);
create or replace TABLE LEGACY_SNAPSHOTIDS (
	ID NUMBER(38,0),
	DATECREATED TIMESTAMP_NTZ(9),
	CFACTS_LEGACY_SNAPSHOTID VARCHAR(16777216),
	EARLIESTOFSNAPSHOTDATE VARCHAR(16777216),
	FK_DATACATEGORY NUMBER(38,0),
	LATESTOFSNAPSHOTDATE VARCHAR(16777216),
	SNAPSHOTDATE TIMESTAMP_NTZ(9),
	COMMENTS VARCHAR(16777216)
);
create or replace TABLE LEGACY_SYSTEMS (
	SYSTEM_ID VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE LEGACY_VULHIST (
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	DW_VUL_ID NUMBER(38,0),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	REPORT_ID NUMBER(38,0),
	REPORT_DATE TIMESTAMP_LTZ(9)
)COMMENT='History of vulnerability data from VULMASTER from Legacy database.\t'
;
create or replace TABLE LEGACY_VULMASTER (
	DW_VUL_ID NUMBER(38,0),
	CVE VARCHAR(16777216),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9)
);
create or replace TABLE MILESTONEHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACTUAL_COMPLETION_DATE VARCHAR(16777216),
	CHANGES_TO_MILESTONE VARCHAR(16777216),
	ESTIMATED_COMPLETION_DATE VARCHAR(16777216),
	LAST_UPDATED VARCHAR(16777216),
	MILESTONE_DESCRIPTION VARCHAR(16777216),
	MILESTONE_ID NUMBER(38,0) NOT NULL,
	MILESTONE_NAME VARCHAR(16777216),
	MILESTONE_STATUS VARCHAR(16777216),
	POAM_ID VARCHAR(16777216) NOT NULL,
	REPORT_ID NUMBER(38,0) NOT NULL,
	SCHEDULED_COMPLETION_DATE VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	primary key (ID)
)COMMENT='POAM Milestone status\t'
;
create or replace TABLE MISP_CROSSWALK (
	BOUNDARY_ENVIRONMENT VARCHAR(16777216),
	CHANGE_DATE DATE,
	MISP_CONTRACTOR VARCHAR(16777216),
	MISP_TAG VARCHAR(16777216),
	MISP_TAGGING_POC VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE MSGLOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	APPL VARCHAR(16777216) DEFAULT 'Default',
	ELAPSED_MILLISECONDS NUMBER(38,0) DEFAULT 0,
	INSERT_DATE TIMESTAMP_LTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	MSG VARCHAR(16777216),
	primary key (ID)
)COMMENT='CRM tasks steps/execution messages\t'
;
create or replace TABLE OATO_HWAM_MONTHLY_DATA (
	INSTANCEID VARCHAR(16777216),
	INSTANCESTATUS VARCHAR(16777216),
	ACCOUNT_NUMBER VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_NTZ(9),
	MONTH_END_DATE DATE
)COMMENT='Monthly HWAM summary for OATO; Provides instance IDs for multiple systems in AWS at months end\t'
;
create or replace TABLE OA_NEW (
	ACRONYM VARCHAR(16777216),
	"OA Ready" VARCHAR(16777216),
	OA_STATUS VARCHAR(16777216),
	"ResidualRisk" NUMBER(18,0),
	"TotalAssets" NUMBER(18,0),
	"Asset Risk Tolerance" NUMBER(8,2),
	OATO_CATEGORY NUMBER(1,0),
	HVASTATUS VARCHAR(16777216),
	MEFSTATUS VARCHAR(4),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	PII_PHI VARCHAR(4),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	COMPONENT VARCHAR(16777216),
	"DevSecOPS / CSM" VARCHAR(3),
	GROUP_ACRONYM VARCHAR(16777216),
	IN_CMS_CLOUD VARCHAR(3),
	LAST_ACT_DATE VARCHAR(16777216),
	LAST_ACT_SCA_FINAL_REPORT_DATE VARCHAR(16777216),
	LAST_PENTEST_DATE VARCHAR(16777216),
	IS_SECURITYHUB_ENABLED VARCHAR(2),
	SYSTEM VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	"Vuln Risk Tolerance" NUMBER(10,2),
	"Resiliency Score" NUMBER(14,0),
	"Is_MarketPlace" BOOLEAN
);
create or replace TABLE OA_OLD (
	ACRONYM VARCHAR(16777216),
	"OA Ready" VARCHAR(16777216),
	OA_STATUS VARCHAR(16777216),
	"ResidualRisk" NUMBER(18,0),
	"TotalAssets" NUMBER(18,0),
	"Asset Risk Tolerance" NUMBER(8,2),
	OATO_CATEGORY NUMBER(1,0),
	HVASTATUS VARCHAR(16777216),
	MEFSTATUS VARCHAR(4),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	PII_PHI VARCHAR(4),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	COMPONENT VARCHAR(16777216),
	"DevSecOPS / CSM" VARCHAR(3),
	GROUP_ACRONYM VARCHAR(16777216),
	IN_CMS_CLOUD VARCHAR(3),
	LAST_ACT_DATE VARCHAR(16777216),
	LAST_ACT_SCA_FINAL_REPORT_DATE VARCHAR(16777216),
	LAST_PENTEST_DATE VARCHAR(16777216),
	IS_SECURITYHUB_ENABLED VARCHAR(2),
	SYSTEM VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	"Vuln Risk Tolerance" NUMBER(10,2),
	"Resiliency Score" NUMBER(14,0),
	"Is_MarketPlace" BOOLEAN
);
create or replace TABLE OBSOLETE_ASSETSOFTWARE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
)COMMENT='Software associated with an asset\t'
;
create or replace TABLE PIAHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DUE_DATE TIMESTAMP_LTZ(9),
	FINAL_APPROVER VARCHAR(16777216),
	FINAL_APPROVER_DATE TIMESTAMP_LTZ(9),
	FINAL_APPROVER_STATUS VARCHAR(16777216),
	HHS_PIA_REVIEW_DATE TIMESTAMP_LTZ(9),
	HHS_PIA_STATUS VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	PIA_TRACKING_ID VARCHAR(16777216) NOT NULL,
	REPORT_ID NUMBER(38,0) NOT NULL,
	REVIEW_DATE TIMESTAMP_LTZ(9),
	REVIEW_STATUS VARCHAR(16777216),
	REVIEWER VARCHAR(16777216),
	SUBMISSION_DATE TIMESTAMP_LTZ(9),
	SUBMISSION_STATUS VARCHAR(16777216),
	SUBMITTER VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	primary key (ID)
)COMMENT='History of HHS Privacy Impact Assessment; Tracks HHS PIA status, review, and approval with point of contact or responsible individuals (submitters, reviewers)\t'
;
create or replace TABLE PII_CATEGORY (
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LEVEL VARCHAR(16777216),
	LEVEL_NUM NUMBER(38,0),
	PII_CATEGORY VARCHAR(16777216) NOT NULL,
	primary key (PII_CATEGORY)
)COMMENT='Table of Personal Identifiable Information (PII) Category. Maps PII level number to PII category \t'
;
create or replace TABLE PII_DATATYPE (
	HHS_POLICY_DESCRIPTION VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	PII_CATEGORY VARCHAR(16777216) NOT NULL,
	PII_TYPE VARCHAR(16777216) NOT NULL,
	TYPE_DEFINITION VARCHAR(16777216),
	primary key (PII_TYPE)
)COMMENT='Table of PII Data Types. Maps PII DataType (e.g., Name) to PII category \t'
;
create or replace TABLE PII_SYSTEM_PII_TYPES (
	PII_SYSTEM_PII_TYPES_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	PII_CATEGORY VARCHAR(16777216),
	PII_TYPE VARCHAR(16777216),
	RECORD_DATE TIMESTAMP_LTZ(9) NOT NULL,
	RECORD_SOURCE_DATA VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	primary key (PII_SYSTEM_PII_TYPES_ID)
)COMMENT='PII Data Types per System. Lists out the PII data Types and corrwsponding category in a system \t'
;
create or replace TABLE PLUGINS (
	DW_PLUGIN_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DESCRIPTION VARCHAR(16777216),
	FAMILYNAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	PLUGIN_ID VARCHAR(16777216),
	RAW_DESCRIPTION VARCHAR(16777216),
	RAW_FAMILYNAME VARCHAR(16777216),
	RAW_PLUGIN_ID VARCHAR(16777216),
	RAW_SIGNATURE VARCHAR(16777216),
	RAW_SOLUTION VARCHAR(16777216),
	SIGNATURE VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	primary key (DW_PLUGIN_ID)
)COMMENT='Currently Empty Table. Based on definition: table for Tenable Plugin with ID and description etc. \t'
;
create or replace TABLE POAMHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACTUAL_COMPLETION_DATE TIMESTAMP_LTZ(9),
	ACTUAL_LABOR_COST NUMBER(38,2),
	CAAT VARCHAR(16777216),
	CAAT_ID VARCHAR(16777216),
	COST VARCHAR(16777216),
	DAYS_OPEN VARCHAR(16777216),
	ESTIMATED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	FUNDING_SOURCE VARCHAR(16777216),
	LABOR_ESTIMATE VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	POAM_CLOSED_DATE TIMESTAMP_LTZ(9),
	POAM_ID VARCHAR(16777216) NOT NULL,
	POAM_OWNER VARCHAR(16777216),
	POAM_REVIEWER VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	REVIEW_COMMENTS VARCHAR(16777216),
	REVIEW_DATE TIMESTAMP_LTZ(9),
	REVIEW_STATUS VARCHAR(16777216),
	SCHEDULED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	SUBMISSION_STATUS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TARGET VARCHAR(16777216),
	WEAKNESS_CREATION_DATE TIMESTAMP_LTZ(9),
	WEAKNESS_ID VARCHAR(16777216),
	WEAKNESS_POC VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216),
	WEAKNESS_SEVERITY VARCHAR(16777216),
	CVE VARCHAR(16777216),
	primary key (ID)
)COMMENT='History of POAM. Tracks POAM including review date and status\t'
;
create or replace TABLE RAW_DATA (
	RAW_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	APPLICABILITYCODE VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	ASSET_ID_TAG_REASON VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216),
	BASESCORE NUMBER(38,1),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CUSTOM_SEVERITY VARCHAR(16777216),
	CVE ARRAY,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DATA_ERROR_ARRAY ARRAY,
	DATA_WARNING_ARRAY ARRAY,
	DATACENTER_ID VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	DEVICEMODEL VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	DW_COMPOSITE_KEY VARCHAR(16777216),
	DW_TEMP_ASSET_ID NUMBER(38,0),
	ENVIRONMENT VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	FISMA_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG_REASON VARCHAR(16777216),
	FISMA_UUID VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	FQDN ARRAY,
	FS_APPLIANCE_IP VARCHAR(16777216),
	FS_ASSET_ID_TAG_WINDOWSINST VARCHAR(16777216),
	FS_FISMA_ID_TAG_GROUPS VARCHAR(16777216),
	FS_FISMA_ID_TAG_WINDOWSINST VARCHAR(16777216),
	FS_GROUPS VARCHAR(16777216),
	FS_HWI_MOTHERBOARD VARCHAR(16777216),
	FS_HWI_PROCESSOR VARCHAR(16777216),
	FS_LABEL_LIST VARCHAR(16777216),
	FS_LINUX_ASSET_ID VARCHAR(16777216),
	FS_LINUX_FISMA_ID VARCHAR(16777216),
	FS_LINUX_HOSTNAME VARCHAR(16777216),
	FS_LINUX_OPERATING_SYSTEM VARCHAR(16777216),
	FS_LINUX_RUNNING_PROCESSES VARCHAR(16777216),
	FS_NETBIOS_DOMAIN VARCHAR(16777216),
	FS_SENDER_INFO VARCHAR(16777216),
	FS_SENDER_INFO_DATE TIMESTAMP_LTZ(9),
	FS_VA_OS VARCHAR(16777216),
	FS_VA_OS_CPE VARCHAR(16777216),
	FS_WINDOWS_APPLICATIONS_INSTALLED VARCHAR(16777216),
	HAS_BEEN_MITIGATED BOOLEAN,
	HOSTNAME ARRAY,
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INSTANCESTATUS VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPV4 ARRAY,
	IPV6 ARRAY,
	IS_DISTINCT_ASSET BOOLEAN,
	IS_FS_MANAGED VARCHAR(16777216),
	IS_SYSTEM_ID_DEFAULTED_TO_DC BOOLEAN,
	KEYDRIVERS VARCHAR(16777216),
	LAST_SEEN TIMESTAMP_LTZ(9),
	MACADDRESS ARRAY,
	MITIGATIONSTATUS VARCHAR(16777216),
	MOTHERBOARD VARCHAR(16777216),
	NETBIOSNAME ARRAY,
	NORMALIZED_ASSET_ID_TATTOO VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	NORMALIZED_HOSTNAME ARRAY,
	NORMALIZED_MACADDRESS ARRAY,
	NORMALIZED_MOTHERBOARD VARCHAR(16777216),
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	OS VARCHAR(16777216),
	OS_BUILD_NUMBER VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	PATCHPUB_DATE TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE TIMESTAMP_LTZ(9),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE TIMESTAMP_LTZ(9),
	PLUGIN_TAGS VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PRIMARY_FISMA_ID_DERIVED VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPORTDATE TIMESTAMP_LTZ(9),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	ROWDISPOSITION VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	SOLUTION VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	TENANT_ID VARCHAR(16777216),
	TEST_NUMBER NUMBER(38,0),
	TEST_VARCHAR VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VPRCONTEXT ARRAY,
	VULN_PUB_DATE TIMESTAMP_LTZ(9),
	VULNUNIQUENESS VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	XREF VARCHAR(16777216),
	primary key (RAW_ID)
)COMMENT='Table of raw CSM/HWAM/SWAM/VUL data.\t'
;
create or replace TABLE RAW_HWAM (
	RAW_HWAM_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_DATACENTER_ID VARCHAR(16777216),
	AWS_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	AXONIUS_ADAPTER_LIST_LENGTH NUMBER(38,0),
	AXONIUS_ADAPTERS ARRAY,
	AXONIUS_ADAPTERS_UUID ARRAY,
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID_TATTOO VARCHAR(16777216),
	BIGFIX_DATACENTER_ID VARCHAR(16777216),
	BIGFIX_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	BIOS_GUID ARRAY,
	CLOUD_ID ARRAY,
	CLOUD_PROVIDER ARRAY,
	COMPUTER_TYPE VARCHAR(16777216),
	CONNECTION_LABEL ARRAY,
	DATA_ERROR_ARRAY ARRAY,
	DATA_WARNING_ARRAY ARRAY,
	DATACENTER_ID VARCHAR(16777216),
	DATECOMPLETED TIMESTAMP_LTZ(9),
	DEVICE_MANUFACTURER ARRAY,
	DEVICE_TYPE VARCHAR(16777216),
	DOMAIN_PREFERRED VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	EVENTTIME TIMESTAMP_LTZ(9),
	FIRST_FETCH_TIME TIMESTAMP_LTZ(9),
	FORESCOUT_ASSET_ID_TATTOO VARCHAR(16777216),
	FORESCOUT_ASSIGNED_LABELS VARCHAR(16777216),
	FORESCOUT_DATACENTER_ID VARCHAR(16777216),
	FORESCOUT_PRIMARY_FISMA_ID VARCHAR(16777216),
	FQDN ARRAY,
	HOSTNAME ARRAY,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INSTANCESTATUS VARCHAR(16777216),
	IPV4 ARRAY,
	IPV6 ARRAY,
	IS_FS_MANAGED VARCHAR(16777216),
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	IS_WINDOWS_SERVER_PREFERRED VARCHAR(16777216),
	LABELS ARRAY,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LAST_USED_USERS_COMPANY_ASSOCIATION ARRAY,
	LAST_USED_USERS_DEPARTMENTS_ASSOCIATION ARRAY,
	MACADDRESS ARRAY,
	MOTHERBOARD VARCHAR(16777216),
	NETBIOSNAME ARRAY,
	OS VARCHAR(16777216),
	OS_BUILD_PREFERRED VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_DOTTED VARCHAR(16777216),
	OS_MAJOR VARCHAR(16777216),
	OS_MINOR VARCHAR(16777216),
	OS_TYPE_DISTRIBUTION_PREFERRED VARCHAR(16777216),
	OS_TYPE_PREFERRED VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	PRIMARY_FISMA_ID_DERIVED VARCHAR(16777216),
	PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	REPORTDATE TIMESTAMP_LTZ(9),
	ROWDISPOSITION VARCHAR(16777216),
	SITECODE_PREFERRED VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SUBNETS_PREFERRED ARRAY,
	SYSTEM_ACRONYM VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLE_ASSET_ID_TATTOO VARCHAR(16777216),
	TENABLE_ASSET_TAGS VARCHAR(16777216),
	TENABLE_DATACENTER_ID VARCHAR(16777216),
	TENABLE_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	TIME_ZONE ARRAY,
	VIRTUAL_HOST ARRAY,
	WINDOWS_PATCH_VERSION ARRAY,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS ARRAY,
	DEVICEMODEL VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FISMA_UUID VARCHAR(16777216),
	BIGFIX_ASSET_ID_DETAILS ARRAY,
	BIGFIX_ASSET_ID_TATTOO_DETAILS ARRAY,
	REPOSITORY_DESCRIPTION_DETAILS ARRAY,
	BIGFIX_DATACENTER_ID_DETAILS ARRAY,
	FORESCOUT_DATACENTER_ID_DETAILS ARRAY,
	FS_APPLIANCE_IP VARCHAR(16777216),
	FS_GROUPS VARCHAR(16777216),
	FS_HWI_MOTHERBOARD VARCHAR(16777216),
	FS_HWI_PROCESSOR VARCHAR(16777216),
	FS_LABEL_LIST VARCHAR(16777216),
	FS_LINUX_ASSET_ID VARCHAR(16777216),
	FS_LINUX_FISMA_ID VARCHAR(16777216),
	FS_LINUX_HOSTNAME VARCHAR(16777216),
	FS_LINUX_OPERATING_SYSTEM VARCHAR(16777216),
	FS_LINUX_RUNNING_PROCESSES VARCHAR(16777216),
	FS_NETBIOS_DOMAIN VARCHAR(16777216),
	FS_SENDER_INFO VARCHAR(16777216),
	FS_SENDER_INFO_DATE TIMESTAMP_LTZ(9),
	FS_VA_OS VARCHAR(16777216),
	FS_VA_OS_CPE VARCHAR(16777216),
	FS_WINDOWS_APPLICATIONS_INSTALLED VARCHAR(16777216),
	TENANT_ID VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0),
	TEMP_ASSET_KEY VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG VARCHAR(16777216),
	FS_ASSET_ID_TAG_WINDOWSINST VARCHAR(16777216),
	FS_FISMA_ID_TAG_WINDOWSINST VARCHAR(16777216),
	FS_FISMA_ID_TAG_GROUPS VARCHAR(16777216),
	IS_FOR_ASSET_MATCHING BOOLEAN,
	OS_BUILD_NUMBER VARCHAR(16777216),
	TEST_NUMBER NUMBER(38,0),
	TEST_VARCHAR VARCHAR(16777216),
	NORMALIZED_ASSET_ID_TATTOO VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	NORMALIZED_HOSTNAME ARRAY,
	NORMALIZED_MACADDRESS ARRAY,
	NORMALIZED_MOTHERBOARD VARCHAR(16777216),
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	primary key (RAW_HWAM_ID)
)COMMENT='Table of raw HWAM data. HWAM data with columns for AWS, Axonius, BigFix, and Forescout\t'
;
create or replace TABLE RAW_TENABLE_VUL (
	RAW_TENABLE_VUL_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	APPLICABILITYCODE VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	BASESCORE NUMBER(38,1),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CREDENTIALED_SCAN VARCHAR(16777216),
	CUSTOM_SEVERITY VARCHAR(16777216),
	CVE ARRAY,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATA_ERROR_ARRAY ARRAY,
	DATA_WARNING_ARRAY ARRAY,
	DATECOMPLETED TIMESTAMP_LTZ(9),
	DESCRIPTION VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	DW_DUP_NUMBER NUMBER(38,0),
	DW_VUL_ID NUMBER(38,0),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	HAS_BEEN_MITIGATED BOOLEAN,
	HOSTNAME VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	KEYDRIVERS VARCHAR(16777216),
	LAST_SEEN TIMESTAMP_LTZ(9),
	MACADDRESS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE TIMESTAMP_LTZ(9),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE TIMESTAMP_LTZ(9),
	PLUGINTEXT VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PRIMARY_FISMA_ID_DERIVED VARCHAR(16777216),
	PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPORTDATE TIMESTAMP_LTZ(9),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	ROWDISPOSITION VARCHAR(16777216),
	SCAN_POLICY_NAME VARCHAR(16777216),
	SCAN_POLICY_UID VARCHAR(16777216),
	SCAN_START_DATE TIMESTAMP_LTZ(9),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOLUTION VARCHAR(16777216),
	STATE VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE TIMESTAMP_LTZ(9),
	XREF VARCHAR(16777216),
	COMPLIANCE_CHECK_NAME VARCHAR(16777216),
	COMPLIANCE_ACTUAL_VALUE VARCHAR(16777216),
	COMPLIANCE_RESULT VARCHAR(16777216),
	COMPLIANCE_ERROR VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	PLUGIN_TAGS VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	NESSUS_VERSION VARCHAR(16777216),
	TATTOO_PLUGIN_ASSET_ID VARCHAR(16777216),
	TATTOO_PLUGIN_PRIMARY_FISMA_ID VARCHAR(16777216),
	VPRCONTEXT ARRAY,
	TENANT_ID VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0),
	TEMP_ASSET_KEY VARCHAR(16777216),
	TEST_NUMBER NUMBER(38,0),
	TEST_VARCHAR VARCHAR(16777216),
	NORMALIZED_ASSET_ID_TATTOO VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	NORMALIZED_HOSTNAME ARRAY,
	NORMALIZED_MACADDRESS ARRAY,
	NORMALIZED_MOTHERBOARD VARCHAR(16777216),
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216),
	primary key (RAW_TENABLE_VUL_ID)
)COMMENT='Table of raw Tenable data. Tenable data from scans of assets. From AWS security center and CCIC security center\t'
;
create or replace TABLE REPORTSNAPSHOTS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	REPORT_ID NUMBER(38,0) NOT NULL,
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	primary key (ID)
)COMMENT='Currently Empty Table. Based on definition: Table for Snapshot associated with Report ID\t'
;
create or replace TABLE REPORT_IDS (
	REPORT_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	IS_ENDOFMONTH BOOLEAN NOT NULL,
	REPORT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	ASSETS_NOT_SCANNED_LAST3DAYS NUMBER(38,0),
	ASSETS_NEVER_SCANNED NUMBER(38,0),
	ASSETS_UNKNOWN_DEVICETYPE NUMBER(38,0),
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID NUMBER(38,0),
	DUPLICATE_DATACENTER_TATTOO_PAIR NUMBER(38,0),
	COMMENTS VARCHAR(16777216),
	ASSETS NUMBER(38,0),
	SYSTEMS_INITIATE NUMBER(38,0),
	SYSTEMS_OPERATE NUMBER(38,0),
	SYSTEMS_RETIRE NUMBER(38,0),
	SYSTEMS_DEVELOP NUMBER(38,0),
	VUL_FIXED_TODAY NUMBER(38,0),
	VUL_OPEN NUMBER(38,0),
	VUL_REOPENED NUMBER(38,0),
	VUL_CRITICAL NUMBER(38,0),
	VUL_MEDIUM NUMBER(38,0),
	VUL_HIGH NUMBER(38,0),
	VUL_LOW NUMBER(38,0),
	VUL_DELETED_TODAY NUMBER(38,0),
	VUL_INACTIVE_ASSET_TODAY NUMBER(38,0),
	ASSETS_CREATED_TODAY NUMBER(38,0),
	ASSETS_DELETED_TODAY NUMBER(38,0),
	ASSETS_AWS NUMBER(38,0),
	ASSETS_AWS_GOVCLOUD NUMBER(38,0),
	VUL_AWS NUMBER(38,0),
	VUL_GOVCLOUD NUMBER(38,0),
	PLUGINS_CREATED_TODAY NUMBER(38,0),
	PLUGINS_DELETED_TODAY NUMBER(38,0),
	PLUGINS_FIXED_TODAY NUMBER(38,0),
	PLUGINS_OPEN NUMBER(38,0),
	PLUGINS_REOPENED NUMBER(38,0),
	PLUGINS_CRITICAL NUMBER(38,0),
	PLUGINS_MEDIUM NUMBER(38,0),
	PLUGINS_HIGH NUMBER(38,0),
	PLUGINS_LOW NUMBER(38,0),
	PLUGINS_INACTIVE_ASSET_TODAY NUMBER(38,0),
	IS_VIABLE BOOLEAN,
	ASSETS_TENABLE_CREDENTIALED_SCAN NUMBER(38,0),
	ASSETS_FORESCOUT_MANAGED NUMBER(38,0),
	ASSETS_SCANNABLE NUMBER(38,0),
	ENDPOINTS NUMBER(38,0),
	primary key (REPORT_ID)
)COMMENT='Enterprise level summary for each report ID (daily). Report ID is associated with date and a summary of data from assets, systems, and vuln\t'
;
create or replace TABLE REPORT_ID_728 (
	REPORT_ID NUMBER(38,0),
	IS_ENDOFMONTH BOOLEAN,
	REPORT_DATE TIMESTAMP_LTZ(9),
	ASSETS_NOT_SCANNED_LAST3DAYS NUMBER(38,0),
	ASSETS_NEVER_SCANNED NUMBER(38,0),
	ASSETS_UNKNOWN_DEVICETYPE NUMBER(38,0),
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID NUMBER(38,0),
	DUPLICATE_DATACENTER_TATTOO_PAIR NUMBER(38,0),
	COMMENTS VARCHAR(16777216),
	ASSETS NUMBER(38,0),
	SYSTEMS_INITIATE NUMBER(38,0),
	SYSTEMS_OPERATE NUMBER(38,0),
	SYSTEMS_RETIRE NUMBER(38,0),
	SYSTEMS_DEVELOP NUMBER(38,0),
	VUL_FIXED_TODAY NUMBER(38,0),
	VUL_OPEN NUMBER(38,0),
	VUL_REOPENED NUMBER(38,0),
	VUL_CRITICAL NUMBER(38,0),
	VUL_MEDIUM NUMBER(38,0),
	VUL_HIGH NUMBER(38,0),
	VUL_LOW NUMBER(38,0),
	VUL_DELETED_TODAY NUMBER(38,0),
	VUL_INACTIVE_ASSET_TODAY NUMBER(38,0),
	ASSETS_CREATED_TODAY NUMBER(38,0),
	ASSETS_DELETED_TODAY NUMBER(38,0),
	ASSETS_AWS NUMBER(38,0),
	ASSETS_AWS_GOVCLOUD NUMBER(38,0),
	VUL_AWS NUMBER(38,0),
	VUL_GOVCLOUD NUMBER(38,0),
	PLUGINS_CREATED_TODAY NUMBER(38,0),
	PLUGINS_DELETED_TODAY NUMBER(38,0),
	PLUGINS_FIXED_TODAY NUMBER(38,0),
	PLUGINS_OPEN NUMBER(38,0),
	PLUGINS_REOPENED NUMBER(38,0),
	PLUGINS_CRITICAL NUMBER(38,0),
	PLUGINS_MEDIUM NUMBER(38,0),
	PLUGINS_HIGH NUMBER(38,0),
	PLUGINS_LOW NUMBER(38,0),
	PLUGINS_INACTIVE_ASSET_TODAY NUMBER(38,0),
	IS_VIABLE BOOLEAN,
	ASSETS_TENABLE_CREDENTIALED_SCAN NUMBER(38,0),
	ASSETS_FORESCOUT_MANAGED NUMBER(38,0),
	ASSETS_SCANNABLE NUMBER(38,0),
	ENDPOINTS NUMBER(38,0)
);
create or replace TABLE SNAPSHOT_IDS (
	SNAPSHOT_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	COMMENTS VARCHAR(16777216),
	DATACATEGORY VARCHAR(16777216) NOT NULL,
	ERROR_COUNT NUMBER(38,0),
	MAX_DATE TIMESTAMP_LTZ(9),
	MIN_DATE TIMESTAMP_LTZ(9),
	RECORD_COUNT NUMBER(38,0),
	RECORDS_WITH_ERRORS NUMBER(38,0),
	RECORDS_WITH_WARNINGS NUMBER(38,0),
	SNAPSHOT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	WARNING_COUNT NUMBER(38,0),
	PARENT_DATACATEGORY VARCHAR(16777216),
	REPORT_ID NUMBER(38,0),
	UNASSIGNED_DW_ASSET_ID NUMBER(38,0),
	IS_FROM_AWS_FEED BOOLEAN,
	primary key (SNAPSHOT_ID)
)COMMENT='Metadata about Snapshot IDs for each data category (AWS HWAM/AWS VUL/AXONIUS/CCIC VUL). Each snapshot ID is associated with date and number of errors or warnings\t'
;
create or replace TABLE SOFTWARE_MASTER (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	CATEGORY VARCHAR(16777216) NOT NULL,
	EOL_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	RECOMMENDED_VERSION VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216),
	SOFTWAREINDEX VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
)COMMENT='Master list of software\t'
;
create or replace TABLE SYSTEMRISKCATEGORY (
	SYSTEMRISKCATEGORY_ID NUMBER(38,0) NOT NULL,
	DESCRIPTION VARCHAR(16777216) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	primary key (SYSTEMRISKCATEGORY_ID)
)COMMENT='Lookup Table of System Risk Category. Each category ID associated with description\t'
;
create or replace TABLE SYSTEMS (
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	ACRONYM VARCHAR(16777216),
	ARCHER_TRACKING_ID NUMBER(38,0),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_PACKAGE VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE NUMBER(28,10),
	HVASTATUS VARCHAR(16777216),
	IN_CMS_CLOUD VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_DATACENTER BOOLEAN,
	IS_EXCLUDEFROMREPORTING BOOLEAN,
	IS_HIGHRISKSYSTEM BOOLEAN,
	IS_MARKETPLACE BOOLEAN,
	IS_OA_READY BOOLEAN,
	IS_OPERATIONALSYSTEM BOOLEAN,
	IS_PHANTOMSYSTEM BOOLEAN,
	IS_SECURITYHUB_ENABLED BOOLEAN,
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(38,0),
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	MEFSTATUS VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PII_PHI VARCHAR(16777216),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION_ID VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	TOTALPOAMWITHAPPROVEDRBD NUMBER(38,0),
	PIA_014 VARCHAR(16777216),
	IS_CCSQ BOOLEAN,
	DIRECTOR_COMMENT VARCHAR(16777216),
	DIRECTOR_COMMENT2 VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	OPERATED_BY VARCHAR(16777216),
	primary key (SYSTEM_ID)
)COMMENT='Information about CFACTS Datacenters/Systems. Each system has acronym and ID as well as data on ATO Business Owner comments etc as well as division\t'
;
create or replace TABLE SYSTEMSAWSACCOUNTS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	AWS_ACCOUNTID VARCHAR(16777216) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	primary key (ID)
)COMMENT='Information about Aws systems. Maps AWS account number to System ID\t'
;
create or replace TABLE SYSTEMSHIST (
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	ACRONYM VARCHAR(16777216),
	ARCHER_TRACKING_ID NUMBER(38,0),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_PACKAGE VARCHAR(16777216),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE NUMBER(28,10),
	HVASTATUS VARCHAR(16777216),
	IN_CMS_CLOUD VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_DATACENTER BOOLEAN,
	IS_EXCLUDEFROMREPORTING BOOLEAN,
	IS_HIGHRISKSYSTEM BOOLEAN,
	IS_MARKETPLACE BOOLEAN,
	IS_OA_READY BOOLEAN,
	IS_OPERATIONALSYSTEM BOOLEAN,
	IS_PHANTOMSYSTEM BOOLEAN,
	IS_SECURITYHUB_ENABLED BOOLEAN,
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(38,0),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	MEFSTATUS VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PII_PHI VARCHAR(16777216),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION_ID VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	TOTALPOAMWITHAPPROVEDRBD NUMBER(38,0),
	PIA_014 VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	DIRECTOR_COMMENT VARCHAR(16777216),
	DIRECTOR_COMMENT2 VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	IS_CCSQ BOOLEAN,
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	SYSTEM_CREATION_DATE TIMESTAMP_LTZ(9),
	OPERATED_BY VARCHAR(16777216),
	primary key (SYSTEM_ID)
)COMMENT='History of the Systems table. Information about systems \t'
;
create or replace TABLE SYSTEMSUMMARY (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSETRISKTOLERANCE NUMBER(10,2),
	ASSETS NUMBER(38,0),
	HWAMRAWAWS NUMBER(38,0),
	HWAMRAWBIGFIX NUMBER(38,0),
	HWAMRAWFORESCOUT NUMBER(38,0),
	KEV_FIXED_MONTHTODATE NUMBER(38,0),
	KEV_FIXED_TODAY NUMBER(38,0),
	KEV_OPEN NUMBER(38,0),
	KEV_REOPENED NUMBER(38,0),
	PREVASSETS NUMBER(38,0),
	REPORT_ID NUMBER(38,0) NOT NULL,
	RESIDUALRISK NUMBER(38,0),
	RESILIENCYSCORE NUMBER(38,0),
	SCANNABLEASSETS NUMBER(38,0),
	SUM_ASSET_VULNRISKTOLERANCE NUMBER(10,2),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	VULCRITICAL NUMBER(38,0),
	VULCRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT60DAYS NUMBER(38,0),
	VULCRITICAL_GTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE15DAYS NUMBER(38,0),
	VULCRITICAL_LTE30DAYS NUMBER(38,0),
	VULCRITICALREMEDIATED NUMBER(38,0),
	VULDELETED NUMBER(38,0),
	VULHIGH NUMBER(38,0),
	VULHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULHIGH_GT60DAYS NUMBER(38,0),
	VULHIGH_LTE30DAYS NUMBER(38,0),
	VULHIGHREMEDIATED NUMBER(38,0),
	VULLOW NUMBER(38,0),
	VULMEDIUM NUMBER(38,0),
	VULNRISKTOLERANCE NUMBER(10,2),
	VULRAW NUMBER(38,0),
	VULRAW_CRITICAL NUMBER(38,0),
	VULRAW_HIGH NUMBER(38,0),
	VULRAW_LOW NUMBER(38,0),
	VULRAW_MEDIUM NUMBER(38,0),
	VULUNIQUECRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GTE15DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT60DAYS NUMBER(38,0),
	VULUNIQUELOW NUMBER(38,0),
	VULUNIQUEMEDIUM NUMBER(38,0),
	VUL_CRITICAL_FIXED_TODAY NUMBER(38,0),
	VUL_CRITICAL_OPEN NUMBER(38,0),
	VUL_CRITICAL_REOPENED NUMBER(38,0),
	VUL_DELETED_TODAY NUMBER(38,0),
	VUL_HIGH_FIXED_TODAY NUMBER(38,0),
	VUL_HIGH_OPEN NUMBER(38,0),
	VUL_HIGH_REOPENED NUMBER(38,0),
	VUL_INACTIVE_ASSET_TODAY NUMBER(38,0),
	VUL_LOW_FIXED_TODAY NUMBER(38,0),
	VUL_LOW_OPEN NUMBER(38,0),
	VUL_LOW_REOPENED NUMBER(38,0),
	VUL_MEDIUM_FIXED_TODAY NUMBER(38,0),
	VUL_MEDIUM_OPEN NUMBER(38,0),
	VUL_MEDIUM_REOPENED NUMBER(38,0),
	primary key (ID)
)COMMENT='Summary statistics for systems. For each system, gives total assets (AWS etc.) as well as critical and other vuln\t'
;
create or replace TABLE SYSTEM_COMMONNAME (
	COMMONNAME VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216)
)COMMENT='System Common Name Lookup Table. This is not an official CFACTS System Acronym but is used by various teams. Maps the System Common Name based on System ID\t'
;
create or replace TABLE SYSTEM_SECURITYHUB_ENABLED (
	SYSTEM_ID VARCHAR(16777216)
)COMMENT='List of Systems where Security Hub is Enabled. Only System ID is listed. \t'
;
create or replace TABLE TECHNOPEDIA_SOFTWARE_CATEGORIES_PROD_2024_0924 (
	PARENT_SOFTWARE_CATEGORY VARCHAR(16777216),
	SOFTWARE_CATEGORY VARCHAR(16777216)
);
create or replace TABLE TEMP_ACTIONABLE_VUL (
	DW_ASSET_ID NUMBER(38,0),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216),
	RAW_TENABLE_VUL_ID NUMBER(38,0)
)COMMENT='Temporary (?)Table for Actionable Vuln. 5 columns identifying DW Asset ID and Vuln ID and plugin with dates for actionable Vuln\t'
;
create or replace TABLE TEMP_ASSETINTERFACE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEMODIFIED TIMESTAMP_LTZ(9),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INTERFACEPARSEMETHOD VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	IPV6 VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	TEMP_HWAM_ID NUMBER(38,0) NOT NULL,
	primary key (ID)
)COMMENT='Currently Empty Table. Based on definition: Table giving temporary asset ID to HWAM assets along with other asset information\t'
;
create or replace TABLE TEMP_ASSETS_TO_DELETE (
	DW_ASSET_ID NUMBER(38,0),
	DELETIONREASON VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_PHYSICAL_DELETE BOOLEAN
)COMMENT='Temporary Table for Assets that will be deleted\t'
;
create or replace TABLE TEMP_ASSET_ISSUE (
	DW_ASSET_ID NUMBER(38,0),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	ISSUE_MSG VARCHAR(16777216)
)COMMENT='Temporary Table for Asset issues. e.g. duplicates\t'
;
create or replace TABLE TEMP_ASSET_METADATA (
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATA_ERROR_ARRAY ARRAY,
	DATA_WARNING_ARRAY ARRAY,
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	NESSUS_VERSION VARCHAR(16777216),
	PLUGINTEXT_EC2_INSTANCE_LINUX VARCHAR(16777216),
	PLUGINTEXT_EC2_INSTANCE_WINDOWS VARCHAR(16777216),
	PLUGINTEXT_ONPREM_TAG_LINUX VARCHAR(16777216),
	PLUGINTEXT_ONPREM_TAG_WINDOWS VARCHAR(16777216),
	PLUGINTEXT_NESSUS_SCAN_INFO VARCHAR(16777216),
	SCAN_POLICY_NAME VARCHAR(16777216),
	SCAN_POLICY_UID VARCHAR(16777216),
	SCAN_START_DATE TIMESTAMP_LTZ(9),
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	SYSTEM_ID VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0) NOT NULL,
	WINDOWS_INSTALLED_SOFTWARE_ASSET_ID VARCHAR(16777216),
	WINDOWS_INSTALLED_SOFTWARE_FISMA_ID VARCHAR(16777216),
	PLUGINTEXT_AZURE_INSTANCE_LINUX VARCHAR(16777216),
	PLUGINTEXT_AZURE_INSTANCE_WINDOWS VARCHAR(16777216)
)COMMENT='Temporary table for Asset metadata'
;
create or replace TABLE TEMP_ASSET_SOFTWARE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATA_WARNING_ARRAY ARRAY,
	DATEINSTALLED DATE,
	DW_ASSET_ID NUMBER(38,0),
	DW_SWAM_ID NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216),
	PRODUCT_NAME VARCHAR(16777216),
	RAW_DATEINSTALLED VARCHAR(16777216),
	RAW_PRODUCT VARCHAR(16777216),
	RAW_VERSION VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
)COMMENT='Temporary table containing Software associated with an asset\t'
;
create or replace TABLE TEMP_ASSET_SOFTWARE_TOMTEST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216),
	RAW_DATEINSTALLED VARCHAR(16777216),
	RAW_PRODUCT VARCHAR(16777216),
	RAW_SOFTWARE VARCHAR(16777216),
	RAW_VERSION VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	SWAM_CATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	SOFTWARE_NAME_ID NUMBER(38,0),
	primary key (ID)
);
create or replace TABLE TEMP_BOD (
	CVE VARCHAR(16777216),
	DATEADDED DATE,
	VULNERABILITYNAME VARCHAR(16777216)
)COMMENT='Temporary Table for ingestion of BOD template file and generation of BOD report'
;
create or replace TABLE TEMP_HWAM (
	TEMP_HWAM_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID ARRAY,
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATECOMPLETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DEVICE_TYPE VARCHAR(16777216),
	DEVICEMODEL VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	ENVIRONMENT VARCHAR(16777216),
	FQDN ARRAY,
	HOSTNAME ARRAY,
	INSTANCESTATUS VARCHAR(16777216),
	IPV4 ARRAY,
	IPV6 ARRAY,
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	MACADDRESS ARRAY,
	MATCHMETHOD VARCHAR(16777216),
	MATCHORDER NUMBER(3,0),
	MOTHERBOARD VARCHAR(16777216),
	NETBIOSNAME ARRAY,
	NORMALIZED_FQDN VARCHAR(16777216),
	NORMALIZED_HOSTNAME ARRAY,
	NORMALIZED_MACADDRESS ARRAY,
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	OS VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SYSTEM_ID VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0),
	TENABLEUUID VARCHAR(16777216),
	TENANT_ID VARCHAR(16777216),
	POPULATED_ELEMENTS VARCHAR(16777216),
	OS_BUILD_NUMBER VARCHAR(16777216),
	AZURE_SUBSCRIPTION_ID VARCHAR(16777216),
	primary key (TEMP_HWAM_ID)
)COMMENT='Temporary Table for HWAM matching/processing. HWAM and VUL are sources for this data. Target is to assign ASSET.DW_ASSET_ID to every record.\t'
;
create or replace TABLE TEMP_IPV4 (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ENDRANGE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IPV4 VARCHAR(16777216) NOT NULL,
	PATH VARCHAR(16777216),
	SEGMENTNAME VARCHAR(16777216),
	STARTRANGE VARCHAR(16777216),
	OCTET1 NUMBER(38,0),
	OCTET2 NUMBER(38,0),
	OCTET3 NUMBER(38,0),
	OCTET4 NUMBER(38,0),
	SEGMENTID NUMBER(38,0),
	primary key (ID)
)COMMENT='Temporary table to store IPV4 addresses generated by stored procedure.\t'
;
create or replace TABLE TEMP_SINGLE_ASSETINTERFACE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	IPV6 VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	REPORT_ID NUMBER(38,0),
	primary key (ID)
)COMMENT='Temporary Table for information on HWAM assets. Maps DW Asset ID to the asset information (FQDN, hostname, ipv4 etc.)\t'
;
create or replace TABLE TENABLE_REPOSITORYHIST (
	TENABLE_REPOSITORYHIST_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACENTER_ID VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LAST_SEEN TIMESTAMP_LTZ(9),
	REPOSITORY_NAME VARCHAR(16777216) NOT NULL,
	IS_FROM_AWS_FEED BOOLEAN,
	REPOSITORY_ID VARCHAR(16777216),
	RAW_TENABLE_VUL_COUNT NUMBER(38,0),
	primary key (TENABLE_REPOSITORYHIST_ID)
)COMMENT='History of Repositories seen in Tenable data. For each tenable Repository, the number of raw vuln is given as well as other information\t'
;
create or replace TABLE TRAL_LOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEIDENTIFIED DATE NOT NULL,
	DATEMITIGATED DATE,
	INITIALSCORE NUMBER(18,3),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	SUBSEQUENTSCORE NUMBER(18,3),
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TRAL_METRIC_ID NUMBER(38,0) NOT NULL,
	DATEMODIFIED TIMESTAMP_LTZ(9),
	primary key (ID)
)COMMENT='The log for the TRAL metrics. For each system ID and applicable TRAL ID, an initial score is identified\t'
;
create or replace TABLE TRAL_METRIC (
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	METRICNAME VARCHAR(16777216) NOT NULL,
	POTENTIALTHREATSOURCES VARCHAR(16777216) NOT NULL,
	TRAL_METRIC_ID NUMBER(38,0),
	TRIGGERDESCRIPTION VARCHAR(16777216),
	primary key (METRICNAME)
)COMMENT='TRAL metrics.Table of the 5 TRAL metrics including pen test, vul and asset risk tolerance. TRAL=Trigger Audit Log?\t'
;
create or replace TABLE TRAL_RISKSEVERITYLEVEL (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	IMPACT VARCHAR(16777216) NOT NULL,
	IMPACTEDCONTROLS VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LIKELIHOODADVERSEIMPACT VARCHAR(16777216) NOT NULL,
	LIKELIHOODINITIATION VARCHAR(16777216) NOT NULL,
	OVERALLLIKELIHOOD VARCHAR(16777216) NOT NULL,
	RISKRESPONSE VARCHAR(16777216),
	RISKSEVERITYLEVEL VARCHAR(16777216) NOT NULL,
	SYSTEMRISKCATEGORY_ID NUMBER(38,0) NOT NULL,
	THRESHOLD NUMBER(18,3),
	THRESHOLDDISPLAY VARCHAR(16777216),
	TRAL_METRIC_ID NUMBER(38,0) NOT NULL,
	primary key (ID)
)COMMENT='Severity Levels for the TRAL metrics. Identifies boundaries of scores to identify whether a TRAL metric is severe, etc.\t'
;
create or replace TABLE VULHIST (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	DW_VUL_ID NUMBER(38,0) NOT NULL,
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	REPORT_ID NUMBER(38,0) NOT NULL,
	CVE VARCHAR(16777216),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	EXTENDED_MITIGATIONSTATUS VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	IS_LEGACY BOOLEAN,
	NUMERIC_SEVERITY NUMBER(38,0),
	REPOSITORY_ID VARCHAR(16777216),
	VUL_DATECREATED TIMESTAMP_LTZ(9),
	primary key (ID)
)COMMENT='History of vulnerability data from VULMASTER.\t'
;
create or replace TABLE VULMASTER (
	DW_VUL_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	CVE VARCHAR(16777216) NOT NULL,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DATEREOPENED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	DELETIONREASON VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	EXPLOITAVAILABLE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_LEGACY BOOLEAN,
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	ORIG_FISMASEVERITY VARCHAR(16777216),
	ORIG_MITIGATIONSTATUS VARCHAR(16777216),
	PREV_FISMASEVERITY VARCHAR(16777216),
	PREV_MITIGATIONSTATUS VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	IS_PREV_DELETED BOOLEAN,
	IS_FROM_AWS_FEED BOOLEAN,
	REPOSITORY_ID VARCHAR(16777216),
	EXTENDED_MITIGATIONSTATUS VARCHAR(16777216),
	DELETED_PLUGIN_COUNT NUMBER(38,0),
	FIXED_PLUGIN_COUNT NUMBER(38,0),
	OPEN_PLUGIN_COUNT NUMBER(38,0),
	TOTAL_PLUGIN_COUNT NUMBER(38,0),
	MAX_PLUGIN_DATEMODIFIED TIMESTAMP_LTZ(9),
	DW_PLUGIN_VUL_ID_CREATE NUMBER(38,0),
	DW_PLUGIN_VUL_ID_MODIFY NUMBER(38,0),
	REOPENED_PLUGIN_COUNT NUMBER(38,0),
	primary key (DW_VUL_ID)
)COMMENT='Master list of the vulnerabilities by DW_ASSET_ID and CVE. Provides asset and current vuln as well as dates\t'
;
create or replace TABLE VULPLUGIN (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DESCRIPTION VARCHAR(16777216),
	DW_VUL_ID NUMBER(38,0) NOT NULL,
	FAMILY_NAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	LASTFOUND TIMESTAMP_LTZ(9),
	PATCHPUB_DATE TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216) NOT NULL,
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE TIMESTAMP_LTZ(9),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE TIMESTAMP_LTZ(9),
	SOLUTION VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VULN_PUB_DATE TIMESTAMP_LTZ(9),
	primary key (ID)
)COMMENT='Plugin Information for VULN. Together with VULNMASTER, provides information related to Plugins and solutions\t'
;
create or replace TABLE VULPLUGINS_COALESCED (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_VUL_ID NUMBER(38,0),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	PLUGIN_ID VARCHAR(16777216),
	PLUGINIDLINK VARCHAR(16777216),
	primary key (ID)
)COMMENT='Currently Empty Table. Based on definition: Coalesced (fewer column) table of vuln and definition links\t'
;
create or replace TABLE VULPLUGINS_MASTER (
	DW_PLUGIN_VUL_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	CREDENTIALED_SCAN VARCHAR(16777216),
	CVE ARRAY,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DATEREOPENED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	DELETIONREASON VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	EXPLOITAVAILABLE VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	HAS_BEEN_MITIGATED BOOLEAN,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_FROM_AWS_FEED BOOLEAN,
	IS_PREV_DELETED BOOLEAN,
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	NESSUS_VERSION VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	PATCHPUB_DATE TIMESTAMP_LTZ(9),
	PLUGIN_ID VARCHAR(16777216) NOT NULL,
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE TIMESTAMP_LTZ(9),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE TIMESTAMP_LTZ(9),
	PORT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	SCAN_POLICY_NAME VARCHAR(16777216),
	SCAN_POLICY_UID VARCHAR(16777216),
	SCAN_START_DATE TIMESTAMP_LTZ(9),
	SNAPSHOT_ID NUMBER(38,0),
	SOLUTION VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VULN_PUB_DATE TIMESTAMP_LTZ(9),
	primary key (DW_PLUGIN_VUL_ID)
)COMMENT='Vulnerabilities as represented by PLUGIN_ID\t'
;
create or replace secure view SEC_VW_CDM_VISIBILITY_APP_CFACTS(
	SYSTEM_ID,
	HWAM_VISIBLE,
	SWAM_VISIBLE,
	VUL_VISIBLE,
	HARDWARE_DATACENTERS,
	HARDWARE_HOST_STATUS,
	AWS_SECHUB_ENABLED,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL
) as
WITH LAST_SEEN AS (
    SELECT 
        S.SYSTEM_ID,
        MAX(VS.LASTSEEN_HWAM)::DATE AS LASTSEEN_HWAM,
        MAX(VS.LASTSEEN_SWAM)::DATE AS LASTSEEN_SWAM,
        MAX(VS.LASTSEEN_VUL)::DATE AS LASTSEEN_VUL,
        ARRAY_AGG(DISTINCT VS.DATACENTER_ACRONYM) 
            WITHIN GROUP (ORDER BY VS.DATACENTER_ACRONYM ASC) AS HARDWARE_DATACENTERS,
        ARRAY_AGG(DISTINCT VS.DATACENTER_ID) AS HARDWARE_DATACENTER_IDS
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS S
    LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_ASSETS VS ON S.SYSTEM_ID = VS.SYSTEM_ID
    GROUP BY S.SYSTEM_ID
    ORDER BY S.SYSTEM_ID
), 
HARDWARE_STATUS AS (
    SELECT 
        SYSTEM_ID, 
        ARRAY_SIZE(HARDWARE_DATACENTER_IDS) AS DATACENTER_COUNT,
        SUM(AWS_PRESENCE_ID) AS AWS_DATACENTER_COUNT
    FROM (
        SELECT 
            SYSTEM_ID,
            HARDWARE_DATACENTER_IDS,
            DC_ID.VALUE,
            CASE 
                WHEN DC_ID.VALUE IN ('56FFF52E-175B-4E48-9B38-669C8BC74899', '5d8a99a8db672340f99cfd721f96190d') 
                THEN 1 
                ELSE 0 
            END AS AWS_PRESENCE_ID
        FROM LAST_SEEN,
        LATERAL FLATTEN(INPUT => HARDWARE_DATACENTER_IDS) AS DC_ID
    ) 
    GROUP BY SYSTEM_ID, HARDWARE_DATACENTER_IDS
)
SELECT 
    L.SYSTEM_ID,
    CASE WHEN LASTSEEN_HWAM IS NOT NULL THEN 'Y' ELSE 'N' END AS HWAM_VISIBLE,
    CASE WHEN LASTSEEN_SWAM IS NOT NULL THEN 'Y' ELSE 'N' END AS SWAM_VISIBLE,
    CASE WHEN LASTSEEN_VUL IS NOT NULL THEN 'Y' ELSE 'N' END AS VUL_VISIBLE,
    HARDWARE_DATACENTERS,
    CASE
        WHEN H.AWS_DATACENTER_COUNT = 0 THEN 'Not HWAM AWS Hosted'
        WHEN H.DATACENTER_COUNT > 0 AND H.DATACENTER_COUNT = H.AWS_DATACENTER_COUNT 
            THEN 'Fully HWAM AWS Hosted'
        WHEN H.AWS_DATACENTER_COUNT > 0 AND H.AWS_DATACENTER_COUNT < H.DATACENTER_COUNT 
            THEN 'Multi HWAM AWS Hosted'
        ELSE 'Not HWAM AWS Hosted'
    END AS HARDWARE_HOST_STATUS,
    CASE WHEN S.SYSTEM_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS AWS_SECHUB_ENABLED,
    LASTSEEN_HWAM,
    LASTSEEN_SWAM,
    LASTSEEN_VUL
FROM LAST_SEEN L 
LEFT JOIN HARDWARE_STATUS H 
    ON L.SYSTEM_ID = H.SYSTEM_ID 
LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS S 
    ON S.SYSTEM_ID = L.SYSTEM_ID 
    AND S.COMPONENT_ACRONYM = 'OIT' 
    AND S.AWS_ACCOUNTIDS IS NOT NULL;


;;;;
create or replace secure view SEC_VW_MARKETPLACE_VUL_BUS_MARKETPLACE_MSI_V2(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	TLC_PHASE,
	REPORT_ID,
	REPORT_DATE,
	IS_ENDOFMONTH,
	DW_VUL_ID,
	CVE,
	DAYSSINCEDISCOVERY,
	IS_BOD,
	BODDUEDATE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	EPSS,
	EPSS_PERCENTILE,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	DATEMITIGATED,
	FIRSTSEEN,
	LASTFOUND,
	VUL_DATECREATED,
	PLUGIN_ID,
	FAMILY_NAME,
	SIGNATURE,
	SOLUTION,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	BIOS_GUID,
	COMPUTER_TYPE,
	DEVICETYPE,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	OS,
	OS_VERSION,
	SOURCE_TOOL_LASTSEEN,
	TENABLEUUID,
	VULNRISKTOLERANCE,
	POAM_ID,
	OVERALL_STATUS
) COMMENT='Provides overdue vulns and related asset details for Marketplace Systems only (Historical)'
 as
--
-- Modeled after CORE.VW_VULN_ROLLING60DAYS which is used to create RPT.TEMP_VULN_FV_ROLLING60DAYS which is then
-- used by RPT.VW_VULN_ROLLING60DAYS
--
with 
w_mkpl_systems as (select 
    COMPONENT_ACRONYM
    ,ACRONYM as SYSTEM_ACRONYM
    ,SYSTEM_ID
    ,HVASTATUS
    ,IS_MARKETPLACE
    ,MEFSTATUS
    ,OATO_CATEGORY
    ,TLC_PHASE
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS where IS_MARKETPLACE = true and COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO')),
w_report_ids as (-- Obtain REPORT_ID for the most recent end-of-month data and REPORT_ID for todays data
    (SELECT TOP 1 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH 
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)
    UNION ALL
    (SELECT TOP 1 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH 
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 0 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)
    ),
w_assethist as (select 
    ah.DW_ASSET_ID
    ,ah.ASSET_ID_TATTOO
    ,ah.BIOS_GUID
    ,ah.COMPUTER_TYPE
    ,ah.DATACENTER_ID
    ,ah.DEVICETYPE
    ,ah.ENVIRONMENT
    ,r.IS_ENDOFMONTH
    ,ah.OS
    ,ah.OS_VERSION
    ,r.REPORT_DATE
    ,ah.REPORT_ID
    ,ah.SOURCE_TOOL_LASTSEEN
    ,ah.SYSTEM_ID
    ,ah.TENABLEUUID
    ,ah.VULNRISKTOLERANCE
    FROM w_report_ids r
    join BUS_CYBER_RISK_MANAGEMENT.CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID)
SELECT
--
-- SYSTEM
--
sys.COMPONENT_ACRONYM
,dc.ACRONYM as DATACENTER_ACRONYM
,ah.DATACENTER_ID
,sys.SYSTEM_ACRONYM
,sys.SYSTEM_ID
,sys.HVASTATUS
,sys.IS_MARKETPLACE
,sys.MEFSTATUS
,sys.OATO_CATEGORY
,sys.TLC_PHASE
--
-- REPORT_DATE (Snapshot)
--
,ah.REPORT_ID
,ah.REPORT_DATE
,ah.IS_ENDOFMONTH
--
-- VUL
--
,vh.DW_VUL_ID
,vh.CVE
,DATEDIFF(day,vh.FIRSTSEEN,vh.LASTFOUND) as DAYSSINCEDISCOVERY
,case when coalesce(bodcat.Is_Deleted,1) = 0 then 'Yes' else 'No' end as IS_BOD
,bodcat.BODDUEDATE
,vh.CVSSV2BASESCORE
,vh.CVSSV3BASESCORE
,epss.EPSS
--,case 
--    when epss.EPSS <= 0 then '<=0%'
--    when epss.EPSS > 0 and epss.EPSS <= 0.25 then '> 0% and <= 25%'
--    when epss.EPSS > 0.25 and epss.EPSS <= 0.50 then '> 25% and <= 50%'
--    when epss.EPSS > 0.50 and epss.EPSS <= 0.75 then '> 50% and <= 75%'
--    when epss.EPSS > 0.75 and epss.EPSS <= 1 then '> 75% and <= 100%'
--    ELSE 'NULL'
--    end as EPSS_FILTER
,epss.PERCENTILE as EPSS_PERCENTILE
,vh.EXPLOITAVAILABLE
,vh.FISMASEVERITY
,vh.MITIGATIONSTATUS
,vh.DATEMITIGATED
,vh.FIRSTSEEN
,vh.LASTFOUND
,vh.VUL_DATECREATED
--
-- PLUGIN
--
,plug.PLUGIN_ID
,plug.FAMILY_NAME
,plug.SYNOPSIS as SIGNATURE
,plug.SOLUTION
--
-- ASSET
--
,ah.DW_ASSET_ID
,ah.ASSET_ID_TATTOO
,ah.BIOS_GUID
,ah.COMPUTER_TYPE
,ah.DEVICETYPE
,ah.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,aic.IPV4
,aic.IPV6
,aic.MACADDRESS
,aic.NETBIOSNAME
,ah.OS
,ah.OS_VERSION
,ah.SOURCE_TOOL_LASTSEEN
,ah.TENABLEUUID
,ah.VULNRISKTOLERANCE
--
-- POAM
--
,pom.POAM_ID
,pom.OVERALL_STATUS
FROM w_mkpl_systems sys
join w_assethist ah on ah.SYSTEM_ID = sys.SYSTEM_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.ASSETINTERFACECOALESCEDHIST aic on aic.REPORT_ID = ah.REPORT_ID and aic.DW_ASSET_ID = ah.DW_ASSET_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VULHIST vh on vh.REPORT_ID = ah.REPORT_ID and vh.DW_ASSET_ID = ah.DW_ASSET_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID and vm.DELETIONREASON IS NULL
left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.KEV_CATALOG bodcat on bodcat.CVE = vh.CVE and bodcat.IS_DELETED = 0
--
-- There can be/are multiple PLUGIN_IDs per CVE but only one has traditionally been displayed
--
left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VULPLUGIN vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vh.DW_VUL_ID)
left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.VULPLUGIN plug on plug.ID = plugs.MAX_VULPLUGIN_ID

left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.POAMHIST pom on pom.REPORT_ID = ah.REPORT_iD and pom.CVE = vh.CVE and pom.SYSTEM_ID = ah.SYSTEM_ID
left outer join REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vh.CVE
WHERE (vh.MitigationStatus in ('open', 'reopened') or (vh.MitigationStatus = 'fixed' 
    and vh.datemitigated > DATEADD(day,-60, ah.REPORT_DATE) and vh.datemitigated <= ah.REPORT_DATE))
;
create or replace secure view SEC_VW_VUL_RISK_TOLERANCE(
	SYSTEM_ID,
	DW_ASSET_ID,
	CVE,
	FIRSTSEEN,
	LASTFOUND,
	ASSET_AGE,
	CVSS,
	SYSTEM_CATEGORY,
	ENVIRONMENT,
	EPSS_PERCENTILE,
	BASESCORE,
	ENV_FACTOR,
	EPSS_MULTIPLIER,
	VULRISKFACTOR
) as
WITH RAW_VALUES AS (
SELECT
v.SYSTEM_ID,
a.DW_ASSET_ID,
V.CVE,
v.firstseen,
v.lastfound,
v.DaysSinceDiscovery as ASSET_age,
v.CVSSV3BASESCORE as cvss,
s.OATO_Category as system_category,
 case 
 when UPPER(LEFT(A.ENVIRONMENT,3)) = 'PRO' THEN 'PROD'
 when UPPER(LEFT(A.ENVIRONMENT,1)) = 'S' THEN 'SANDBOX'
 ELSE
 'DEV'
 END AS ENVIRONMENT,
 E.PERCENTILE AS EPSS_PERCENTILE
FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VW_VulMaster v
LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_Systems s on s.SYSTEM_ID = v.SYSTEM_ID 
LEFT JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES E ON E.CVE_ID = V.CVE
LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_ASSETS A ON V.DW_ASSET_ID = A.DW_ASSET_ID and A.Is_Scannable=1 and LOWER(v.MitigationStatus) IN ('open','reopened')
), BASESCORE AS (

SELECT
R.*,
(R.ASSET_age * R.CVSS * system_category) AS BASESCORE
FROM RAW_VALUES R
    
), EF AS (
SELECT 
*,
CASE 
WHEN ENVIRONMENT = 'PROD' THEN 1
WHEN ENVIRONMENT = 'DEV' THEN .3
WHEN ENVIRONMENT = 'SANDBOX' THEN .1
ELSE
1
END AS ENV_FACTOR
FROM BASESCORE

), EPSS_MULTI AS (

SELECT 
*,
CASE
WHEN EPSS_PERCENTILE BETWEEN 0 AND .24 THEN 1
WHEN EPSS_PERCENTILE BETWEEN .25 AND .74 THEN 2
WHEN EPSS_PERCENTILE > .75 THEN 3
END AS EPSS_MULTIPLIER
FROM EF
)
SELECT *, (BASESCORE * ENV_FACTOR * EPSS_MULTIPLIER) AS VULRISKFACTOR
FROM EPSS_MULTI
order by SYSTEM_ID, DW_ASSET_ID, CVE
;
create or replace view VW_ALLOCATEDCONTROL(
	ID,
	CONTROL_NUMBER,
	CONTROL_ELEMENT_NUMBER,
	ACRONYM,
	ALLOCATION_STATUS,
	AUTHORIZATION_PACKAGE,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	HYBRID_CONTROL,
	INHERITABLE_BY_OTHER_SYSTEMS,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	SHARED_IMP_UPDATED_DATE,
	TRACKING_ID,
	ALLOCATED_CONTROL_SYSTEM_ID,
	SYSTEM_ID,
	CONTROL_ELEMENT,
	RESPONSIBILITY,
	SIGNIFICANT_CONTROL_CHANGE,
	SIGNIFICANT_CONTROL_CHANGE_DETAILS
) COMMENT='Return all Allocated controls from CFACTS.'
 as
SELECT ac.ID
--,ac.INSERT_DATE
,ac.Control_Number
,ac.Control_Element_Number
,s.Acronym
,ac.Allocation_Status
,s.Authorization_Package
,ac.Control_Family
,ac.Control_Name
,ac.Control_Number_Combo
,ac.Control_Set_Version_Number
,ac.hybrid_control
,ac.Inheritable_by_other_systems
,ac.Last_ACT_Date
,ac.Last_Assessment_Date
,ac.Last_Pentest_Date
,ac.Last_SCA_Date
,ac.Overall_Control_Status
,ac.Private_Imp_Updated_Date
,ac.Shared_Imp_Updated_Date
,ac.Tracking_ID
,ac.SYSTEM_ID as Allocated_control_system_id
,s.SYSTEM_ID
,ac.Control_Element
,ac.Responsibility
,ac.Significant_Control_Change
,ac.Significant_Control_Change_Details
FROM CORE.AllocatedControl ac
JOIN CORE.VW_Systems s on s.SYSTEM_ID = ac.SYSTEM_ID;
create or replace view VW_APP_ARCHER_ALLOCATEDCONTROL(
	ALLOCATION_STATUS,
	CONTROL_ELEMENT,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	HYBRID_CONTROL,
	INHERITABLE_BY_OTHER_SYSTEMS,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	RESPONSIBILITY,
	SHARED_IMP_UPDATED_DATE,
	SIGNIFICANT_CONTROL_CHANGE,
	SYSTEM_ID,
	TRACKING_ID
) COMMENT='APP_ARCHER (CFACTS) Parent level view of controls allocated to a system.'
 as 
SELECT
ac.ALLOCATION_STATUS[0]::varchar as ALLOCATION_STATUS
,ac.CONTROL as CONTROL_ELEMENT -- Long description
--,ac.CONTROL_ELEMENT_NUMBER as CONTROL_ELEMENT_NUMBER -- Has enhancement e.g. PM-03a
,ac.CONTROL_FAMILY[0]::varchar as CONTROL_FAMILY
,ac.CONTROL_NAME as CONTROL_NAME
,ac.CONTROL_NUMBER as CONTROL_NUMBER
,ac.CONTROL_NUMBER_COMBO as CONTROL_NUMBER_COMBO
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER 
,ac.ALLOCATED__HYBRID_YES[0]::varchar as HYBRID_CONTROL
,ac.INHERITABLE[0]::varchar as INHERITABLE_BY_OTHER_SYSTEMS
,ac.LAST_ACT_DATE as LAST_ACT_DATE
,ac.ASSESSMENT_DATE as LAST_ASSESSMENT_DATE
,ac.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ac.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_SCA_DATE
,ac.OVERALL_CONTROL_STATUS[0]::varchar as OVERALL_CONTROL_STATUS
,ac.IMPLEMENTATION_LAST_UPDATED as PRIVATE_IMP_UPDATED_DATE
,ac.IMPLEMENTATION_DETAILS as PRIVATE_IMPLEMENTATION_DETAILS
,ac.RESPONSIBILITY as RESPONSIBILITY
,ac.SHARED_IMPLEMENTATION_DETAILS_UPDATED_ as SHARED_IMP_UPDATED_DATE
,ac.SIGNIFICANT_CONTROL_CHANGE[0]::varchar as SIGNIFICANT_CONTROL_CHANGE -- Y/N in APP_CFACTS
--,ac.SIGNIFICANT_CONTROL_CHANGE_DETAILS as SIGNIFICANT_CONTROL_CHANGE_DETAILS -- APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS
,ap.IDUID as SYSTEM_ID
,ac.TRACKING_ID as TRACKING_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac.FISMA_ID = ap.IDUID


-- __REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT.SIGNIFICANT_CONTROL_CHANGE_DETAILS
-- __REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT.CONTROL_ELEMENT_NUMBER

;
create or replace view VW_APP_ARCHER_ALLOCATEDCONTROL_TEST(
	ALLOCATION_STATUS,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	RESPONSIBILITY,
	SHARED_IMP_UPDATED_DATE,
	SIGNIFICANT_CONTROL_CHANGE_DETAILS,
	SYSTEM_ID,
	TRACKING_ID
) COMMENT='APP_ARCHER (CFACTS) Parent level view of controls allocated to a system.'
 as 
SELECT
ac.ALLOCATION_STATUS[0]::varchar as ALLOCATION_STATUS
-- NEWQ,ac.CONTROL as CONTROL_ELEMENT -- Long description
,ac.CONTROL_ELEMENT_NUMBER as CONTROL_ELEMENT_NUMBER -- Has enhancement e.g. PM-03a
,ac.CONTROL_FAMILY[0]::varchar as CONTROL_FAMILY
,ac.CONTROL_NAME as CONTROL_NAME
,ac.CONTROL_NUMBER as CONTROL_NUMBER
,ac.CONTROL_ELEMENT_NUMBER_COMBO as CONTROL_NUMBER_COMBO
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER 
-- NEWQ ,ac.ALLOCATED__HYBRID_YES[0]::varchar as HYBRID_CONTROL
-- NEWQ ,ac.INHERITABLE[0]::varchar as INHERITABLE_BY_OTHER_SYSTEMS
,ac.LAST_ACT_DATE as LAST_ACT_DATE
,ac.LAST_ASSESSMENT_DATE as LAST_ASSESSMENT_DATE
,ac.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ac.LAST_ACTSCA_FINAL_REPORT_DATE as LAST_SCA_DATE
,ac.OVERALL_CONTROL_ELEMENT_STATUS[0]::varchar as OVERALL_CONTROL_STATUS
,ac.IMPLEMENTATION_DETAILS_LAST_UPDATED as PRIVATE_IMP_UPDATED_DATE
,ac.PRIVATE_ALLOCATED_IMPLEMENTATION_DETAILS as PRIVATE_IMPLEMENTATION_DETAILS
,ac.RESPONSIBILITY as RESPONSIBILITY
,ac.SHARED_IMPLEMENTATION_DETAILS_UPDATED_DA as SHARED_IMP_UPDATED_DATE
-- NEWQ ,ac.SIGNIFICANT_CONTROL_CHANGE[0]::varchar as SIGNIFICANT_CONTROL_CHANGE -- Y/N in APP_CFACTS
,ac.SIGNIFICANT_CONTROL_CHANGE_DETAILS as SIGNIFICANT_CONTROL_CHANGE_DETAILS -- APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS
,ap.IDUID as SYSTEM_ID
,ac.TRACKING_ID as TRACKING_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT ac on ac.FISMA_ID = ap.IDUID


-- __REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT.SIGNIFICANT_CONTROL_CHANGE_DETAILS
-- __REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT.CONTROL_ELEMENT_NUMBER

;
create or replace view VW_APP_ARCHER_ALLOCATEDCONTROL_V2(
	ALLOCATION_STATUS,
	CONTROL_ELEMENT,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	HYBRID_CONTROL,
	INHERITABLE_BY_OTHER_SYSTEMS,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	RESPONSIBILITY,
	SHARED_IMP_UPDATED_DATE,
	SIGNIFICANT_CONTROL_CHANGE,
	SIGNIFICANT_CONTROL_CHANGE_DETAILS,
	SYSTEM_ID,
	TRACKING_ID
) COMMENT='APP_ARCHER (CFACTS) Parent level view of controls allocated to a system.'
 as 
SELECT
ac.ALLOCATION_STATUS[0]::varchar as ALLOCATION_STATUS
,ac.CONTROL as CONTROL_ELEMENT -- Long description
,ace.CONTROL_ELEMENT_NUMBER as CONTROL_ELEMENT_NUMBER -- Has enhancement e.g. PM-03a
,ac.CONTROL_FAMILY[0]::varchar as CONTROL_FAMILY
,ac.CONTROL_NAME as CONTROL_NAME
,ac.CONTROL_NUMBER as CONTROL_NUMBER
,ac.CONTROL_NUMBER_COMBO as CONTROL_NUMBER_COMBO
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER 
,ac.ALLOCATED__HYBRID_YES[0]::varchar as HYBRID_CONTROL
,ac.INHERITABLE[0]::varchar as INHERITABLE_BY_OTHER_SYSTEMS
,ac.LAST_ACT_DATE as LAST_ACT_DATE
,ac.ASSESSMENT_DATE as LAST_ASSESSMENT_DATE
,ac.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ac.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_SCA_DATE
,ac.OVERALL_CONTROL_STATUS[0]::varchar as OVERALL_CONTROL_STATUS
,ac.IMPLEMENTATION_LAST_UPDATED as PRIVATE_IMP_UPDATED_DATE
,ac.IMPLEMENTATION_DETAILS as PRIVATE_IMPLEMENTATION_DETAILS
,ac.RESPONSIBILITY as RESPONSIBILITY
,ac.SHARED_IMPLEMENTATION_DETAILS_UPDATED_ as SHARED_IMP_UPDATED_DATE
,ac.SIGNIFICANT_CONTROL_CHANGE[0]::varchar as SIGNIFICANT_CONTROL_CHANGE -- Y/N in APP_CFACTS
,ace.SIGNIFICANT_CONTROL_CHANGE_DETAILS as SIGNIFICANT_CONTROL_CHANGE_DETAILS -- APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS
,ap.IDUID as SYSTEM_ID
,ac.TRACKING_ID as TRACKING_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac.FISMA_ID = ap.IDUID
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_ELEMENTS_REPORT ace on ace.FISMA_ID = ap.IDUID
and ace.CONTROL_NUMBER = ac.CONTROL_NUMBER
;
create or replace view VW_APP_ARCHER_CAAT(
	ACT_CAAT_FILEPROCESSEDDATE,
	ASSESSMENTAUDIT_COMPANY,
	CAAT_ID,
	DATE_IDENTIFIED,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FINDING_TITLE,
	RELATED_POAMS,
	SOURCE_AUDIT_TYPE_2,
	SYSTEM_ID,
	TEST_METHOD,
	TEST_OBJECTIVE,
	TEST_RESULT,
	WEAKNESS_DESCRIPTION
) COMMENT='APP_ARCHER (CFACTS) Parent level view of CMS Assessment and Audit Tracking for a system.'
 as
SELECT
cat.ACT_SCA_PROCESSED_FILE_DATE as ACT_CAAT_FILEPROCESSEDDATE
,cat.CONTRACTOR as ASSESSMENTAUDIT_COMPANY
,cat.TRACKING_ID as CAAT_ID
,cat.DATE_IDENTIFIED as DATE_IDENTIFIED
,cat.FINDING_DESCRIPTION as FINDING_DESCRIPTION
,cat.FINDING_ID as FINDING_ID
,cat.FINDING_TITLE as FINDING_TITLE
,p.POAM_ID as RELATED_POAMS
,cat.AUDIT_TYPE_2[0]::varchar as SOURCE_AUDIT_TYPE_2
,ap.IDUID as SYSTEM_ID
,cat.TEST_METHOD[0]::varchar as TEST_METHOD
,cat.TEST_OBJECTIVE as TEST_OBJECTIVE
,cat.TEST_RESULTS[0]::varchar as TEST_RESULT
,cat.WEAKNESS_DESCRIPTION as WEAKNESS_DESCRIPTION
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_CMS_ASSESSMENT_AUDIT_TRACKING_CAAT_REPORT cat on cat.information_system_or_program_name[0]:ContentId = ap._content_id
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_POA_M_REPORT p on p.CAAT_ID = cat._content_id
/*
,p.SUBMITTER:Users[0]:FirstName::varchar || ' ' || p.SUBMITTER:Users[0]:LastName::varchar as SUBMITTER
,ap.IDUID as SYSTEM_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT p on p.name_of_component[0]:ContentId = ap._content_id;
*/
;
create or replace view VW_APP_ARCHER_MILESTONE(
	ACTUAL_COMP_DATE,
	CHANGES2MS,
	EST_COMP_DATE,
	LAST_UPDATED,
	MS_DESC,
	MS_ID,
	MS_NAME,
	MS_STATUS,
	POAM_ID,
	SCHED_COMP_DATE,
	SYSTEM_ID
) COMMENT='APP_ARCHER (CFACTS) Parent level view of POAM Milestones for a system.'
 as 
SELECT
m.ACTUAL_COMPLETION_DATE as ACTUAL_COMP_DATE
,m.CHANGES_TO_MILESTONE as CHANGES2MS
,m.ESTIMATED_COMPLETION_DATE as EST_COMP_DATE
,m.LAST_UPDATED as LAST_UPDATED
,m.MILESTONE_DESCRIPTION as MS_DESC
,m.TRACKING_ID as MS_ID
,m.MILESTONE_NAME as MS_NAME
,m.MILESTONE_STATUS_1[0]::varchar as MS_STATUS
,p.POAM_ID as POAM_ID
,m.SCHEDULED_COMPLETION_DATE as SCHED_COMP_DATE
,ap.IDUID as SYSTEM_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_POA_M_REPORT p on p.FISMA_ID = ap.IDUID
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_MILESTONES_REPORT m on m.POAMS_MILESTONE[0]:ContentId = p._content_id;
create or replace view VW_APP_ARCHER_PIA(
	DUE_DATE,
	FINAL_APPROVER,
	FINAL_APPROVER_DATE,
	FINAL_APPROVER_STATUS,
	HHS_PIA_REVIEW_DATE,
	HHS_PIA_STATUS,
	OVERALL_STATUS,
	PIA_TRACKING_ID,
	REVIEW_DATE,
	REVIEW_STATUS,
	REVIEWER,
	SUBMISSION_DATE,
	SUBMISSION_STATUS,
	SUBMITTER,
	SYSTEM_ID
) COMMENT='APP_ARCHER (CFACTS) Detail Privacy Impact Assessment (PIA).'
 as
SELECT
p.DUE_DATE as DUE_DATE
,p.FINAL_APPROVER__NEW:Users[0]:FirstName::varchar || ' ' || p.FINAL_APPROVER__NEW:Users[0]:LastName::varchar as FINAL_APPROVER
,p.FINAL_APPROVER_DATE as FINAL_APPROVER_DATE
,p.FINAL_APPROVER_STATUS[0]::varchar as FINAL_APPROVER_STATUS
,p.HHS_PIA_STATUS_DATE_ as HHS_PIA_REVIEW_DATE
,p.HSDW_ as HHS_PIA_STATUS
,p.OVERALL_STATUS[0]::varchar as OVERALL_STATUS
,p.PIA_ID as PIA_TRACKING_ID
,p.FINAL_APPROVER_DATE as REVIEW_DATE
,p.REVIEW_STATUS_1[0]::varchar as REVIEW_STATUS
,p.FINAL_APPROVER__NEW:Users[0]:FirstName::varchar || ' ' || p.FINAL_APPROVER__NEW:Users[0]:LastName::varchar as REVIEWER
,p.SUBMIT_DATE as SUBMISSION_DATE
,p.SUBMISSION_STATUS[0]::varchar as SUBMISSION_STATUS
,p.SUBMITTER:Users[0]:FirstName::varchar || ' ' || p.SUBMITTER:Users[0]:LastName::varchar as SUBMITTER
,ap.IDUID as SYSTEM_ID
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT p on p.name_of_component[0]:ContentId = ap._content_id;
create or replace view VW_APP_ARCHER_POAM(
	ACTUAL_COMPLETION_DATE,
	ACTUAL_LABOR_COST,
	CAAT,
	CAAT_ID,
	DAYS_OPEN,
	ESTIMATED_COMPLETION_DATE,
	FINDING_ID,
	FUNDING_SOURCE,
	LABOR_ESTIMATE,
	OVERALL_STATUS,
	POAM_CLOSED_DATE,
	POAM_ID,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_COMMENTS,
	REVIEW_DATE,
	REVIEW_STATUS,
	SCHEDULED_COMPLETION_DATE,
	SOURCE_AUDIT_TYPE_2,
	SUBMISSION_STATUS,
	SYSTEM_ID,
	TARGET,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_ID,
	WEAKNESS_POC,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY
) COMMENT='APP_ARCHER (CFACTS) Parent level view of POAMs for a system.'
 as
SELECT
p.ACTUAL_COMPLETION_DATE as ACTUAL_COMPLETION_DATE
,p.ACTUAL_LABOR_COST as ACTUAL_LABOR_COST
,'CAAT-' || p.CAAT_ID as CAAT
,p.CAAT_ID as CAAT_ID
,p.DAYS_OPEN as DAYS_OPEN
,p.ESTIMATED_COMPLETION_DATE as ESTIMATED_COMPLETION_DATE
,p.FINDING_ID as FINDING_ID
,p.FUNDING_SOURCE[0]::varchar as FUNDING_SOURCE
,p.LABOR_ESTIMATE as LABOR_ESTIMATE
,p.OVERALL_STATUS[0]::varchar as OVERALL_STATUS
,p.POAM_CLOSED_DATE as POAM_CLOSED_DATE
,p.POAM_ID as POAM_ID
,p.POAM_OWNER_1:Users[0]:FirstName::varchar || ' ' || p.POAM_OWNER_1:Users[0]:LastName::varchar as POAM_OWNER
,p.POAM_REVIEWER:Users[0]:FirstName::varchar || ' ' || p.POAM_REVIEWER:Users[0]:LastName::varchar as POAM_REVIEWER
,p.REVIEW_COMMENTS as REVIEW_COMMENTS
,p.REVIEW_DATE as REVIEW_DATE
,p.REVIEW_STATUS[0]::varchar as REVIEW_STATUS
,p.SCHEDULED_COMPLETION_DATE as SCHEDULED_COMPLETION_DATE
,p.SOURCE_AUDIT_TYPE_2 as SOURCE_AUDIT_TYPE_2
,p.SUBMISSION_STATUS[0]::varchar as SUBMISSION_STATUS
,ap.IDUID as SYSTEM_ID
,p.CONTROL_NUMBER as TARGET
,p.CFACTS_10_WEAKNESS_CREATION_DATE as WEAKNESS_CREATION_DATE
,p.WEAKNESS_ID_NUMBER as WEAKNESS_ID
,p.WEAKNESS_POC_ROLE:Users[0]:FirstName::varchar || ' ' || p.WEAKNESS_POC_ROLE:Users[0]:LastName::varchar as WEAKNESS_POC
,p.WEAKNESS_RISK_LEVEL_1[0]::varchar as WEAKNESS_RISK_LEVEL
,p.WEAKNESS_SEVERITY[0]::varchar as WEAKNESS_SEVERITY
FROM APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
JOIN APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_POA_M_REPORT p on p.FISMA_ID = ap.IDUID;
create or replace view VW_APP_ARCHER_SYSTEMS(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	IS_OA_READY,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='APP_ARCHER (CFACTS) System detail'
 as
WITH
/*
W_ATO as (-- There can be multiple records per FISMA System so find the most current
    select t.*
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT t
    JOIN (select rank()over(partition by IDUID order by _content_id desc) TheRank,_content_id
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT) r1 on r1._content_id = t._content_id 
    WHERE r1.TheRank = 1),
*/
W_ATO as (select INFORMATION_SYSTEM_OR_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ATO_REQUEST_REPORT),    
W_BO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CIO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_CISO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_COMPRISK as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- Component Report POC
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),  
W_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DCISO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_DIVISION as (select division,component_acronym,component_name_,description,division_acronym,group_name
    ,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT
    join table(flatten(AUTHORIZATION_PACKAGES,outer=>true)) as f),
W_INFOTYPES as (select infotypes.*,f.value:ContentId::string as system_contentId
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT infotypes
    join table(flatten(AUTHORIZATION_PACKAGE,outer=>true)) as f
    where tracking_id = 220862 -- Financial, budgetary, commercial, proprietary and trade secret information
    ),
W_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES -- 250303 Sort
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_ISSOCS as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PIA as (select AUTHORIZATION_PACKAGE[0].ContentId::varchar as system_contentId, *
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_PRIVACY_IMPACT_ASSESSMENT_PIA_REPORT),    
W_PRIMARY_CRA as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_PRIMARY_ISSO as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID),
W_SCA as (SELECT IDUID ,listagg(GROUP_LIST.value:DisplayName::string,';') as GROUP_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Groups) GROUP_LIST
  GROUP BY IDUID),
W_SDM as (SELECT IDUID, listagg(u.DISPLAYNAME,';') WITHIN GROUP (order by u.DISPLAYNAME) as USER_NAMES
    from APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
    LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
    JOIN APP_ARCHER.PRIVATE.__META_USERS u on u.username = USER_LIST.value:UserName::string
    GROUP BY IDUID)

SELECT
--
-- TODO
-- Resolve multiple ATO records
-- Resolve multiple GROUP records
-- Resolve multiple __REPORT_CONTENT_CFACTS_SDL_INFORMATION_TYPES_REPORT records
-- Resolve HVA_SCORE
--
ap.ACRONYM as ACRONYM
,ap.ACTUAL_DECOMMISION_DATE as ACTUAL_DECOMMISION_DATE
,ap._content_id as ARCHER_TRACKING_ID
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

,ato.ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE

--,case when try_to_date(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') is not null then TO_DATE(ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1,'MMMM DD, YYYY') Else null end as ATO_REVIEW_DATE
,ato.COPY_OF_BO_REQUEST_REVIEW_DATE_1 as ATO_REVIEW_DATE

,ato.ATO_MEMO_TEXT as AUTH_COMMENTS
,ap.AUTHORIZATION_DECISION[0]::varchar as AUTH_DECISION
-- might be wrong ,ac.DATE_AUTHORIZATION_MEMO_SIGNED as AUTHORIZATION_MEMO_SIGNED_DATE
,ato.CIO_SUBMITTED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE

,ap.AUTHORIZATION_PACKAGE_NAME as AUTHORIZATION_PACKAGE_NAME
-- maybe wrong ,ato.BUSINESS_OWNER_APPROVED_DATE as BO_RECOMMENDATION_REVIEW_DATE

,ato.COPY_OF_BO_REQUEST_REVIEW__DUE_DATE as BO_RECOMMENDATION_REVIEW_DATE

-- maybe wrong ,ra.BUSINESS_OWNER_REVIEW_DATE as BO_REVIEW_DATE

,ato.BO_SUBMITTED_DATE as BO_REVIEW_DATE

,bo.USER_NAMES as BUSINESS_OWNER
,cio.USER_NAMES as CIO
,ciso.USER_NAMES as CISO
-- maybe wrong,ra.CISO_REVIEW_DATE as CISO_REVIEW_DATE

,ato.CISO_SUBMITTED_DATE as CISO_REVIEW_DATE

,array_to_string(ap.CLOUDSERVICEPROVIDERS,',') as CLOUD_SERVICE_PROVIDER -- 250303
,ap.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,comp.DESCRIPTION as COMPONENT_DESCRIPTION
,ap.COMPONENT_NAME_ as COMPONENT_NAME
,cro.USER_NAMES as COMPONENT_RISK_REPORTS_OVERSIGHT
,ap.LAST_CONTINGENCY_PLAN_EXPIRATION_DATE as CONTINGENCYEXPIRATIONDATE
,ap.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,ap.LAST_CONTINGENCY_PLAN_TEST_DATE as CP_TEST_DATE
,ap.CONTINGENCY_PLAN_TEST_RESULTS[0]::varchar as CP_TEST_RESULTS
,cra.USER_NAMES as CRA
,ato.CRA_SUBMITTED_DATE as CRA_REVIEW_DATE
,pcra.USER_NAMES as CYBERVET -- This differs from CRA in CFACTS view. Is it same as DSPC_POC / Primary Cyber Risk Advisor (CRA)
-- maybe wrong,ato.PACKAGE_ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES

,ato.ATO_EXPIRATION_DATE as DATE_AUTH_MEMO_EXPIRES
,case when try_to_date(ato.ATO_MEMO_DATE,'MMMM DD, YYYY') is not null then TO_DATE(ato.ATO_MEMO_DATE,'MMMM DD, YYYY') Else null end as DATE_AUTH_MEMO_SIGNED
,dciso.USER_NAMES as DCISO
,div.DIVISION_ACRONYM as DIVISION_ACRONYM
,CORE.FN_CRM_CLEANSTRING(div.DESCRIPTION) as DIVISION_DESCRIPTION
,ap.DIVISION_NAME as DIVISION_NAME
-- maybe wrong,ra.DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,ato.DSPC_SUBMITTED_DATE as DSPC_REVIEW_DATE

-- maybe wrong,ato.DSPPO_APPROVED_DATE as DSPPO_REVIEW_DATE

,ato.DSPPO_SUBMITTED_DATE as DSPPO_REVIEW_DATE
,ap.EAUTHENTICATION_EXPIRATION_DATE as E_AUTH_EXP_DATE -- 250303
,ap.EAUTHENTICATION_LEVEL[0]::varchar as E_AUTH_LEVEL
,ap.EAUTHENTICATION_DATE as E_AUTH_RISK_ASSESSMENT_DATE -- 250303
,ap.FINANCIAL_SYSTEM[0]::varchar as FINANCIAL_SYSTEM
,infotype.AVAILABILITY_RATING[0]::varchar as FIPS_199_AVAILABILITY_RATING
,infotype.CONFIDENTIALITY_RATING[0]::varchar as FIPS_199_CONFIDENTIALITY_RATING
,infotype.INTEGRITY_RATING[0]::varchar as FIPS_199_INTEGRITY_RATING
,cedar.FINAL_SECURITY_CATEGORY[0]::varchar as FIPS_199_OVERALL_IMPACT_RATING
,ap.FIRST_PUBLISHED as FIRST_PUBLISHED_DATE
,ap.FISMA_REPORTABLE[0]::varchar as FISMA_SYSTEM
,'FAKE' as GROUP_ACRONYM
,'FAKE' as GROUP_DESCRIPTION
,ap.GROUP_NAME as GROUP_NAME
,ap.BASELINE_HIGHEST_DEVICE_RISK_SCORE as HVA_SCORE
,ap.IS_THIS_SYSTEM_ON_THE_HVA_TRACKING_LIST[0]::varchar as HVASTATUS
,ap.INFORMATION_SYSTEM_TYPE[0]::varchar as INFORMATION_SYSTEM_TYPE

,case IFNULL(ap.MARKETPLACE_SYSTEMS[0]::varchar,'0') When 'Yes' then '1' Else '0' End as IS_MARKETPLACE

,NULL as IS_OA_READY -- NO LONGER NEEDED BECAUSE SDW NOW DETERMINES THIS

,ato.DATE_ISRA_LAST_UPDATED_OR_REVIEWED as ISRA_REVIEW_DATE

-- maybe wrong,,ap.LAST_ISRA_COMPLETION_DATE as ISRA_REVIEW_DATE
,ap.ISRA_STATUS[0]::varchar as ISRA_STATUS
,isso.USER_NAMES as ISSO
,array_size(INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) as ISSO_COUNT
,ato.ISSO_REVIEW_DUE_DATE as ISSO_REVIEW_DATE
,ato.ISSO_SUBMITTED_DATE as ISSO_SUBMISSION_DATE
,issocs.USER_NAMES as ISSOCS
,ap.LAST_ACT_DATE as LAST_ACT_DATE
,ap.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,ap.LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,ap.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,ap.LAST_PENTEST_DATE as LAST_PENTEST_DATE
,ap.IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF[0]::varchar as MEF
,ap.MISSION_ESSENTIAL_FUNCTIONS_[0]::varchar as MEF_CONTEXT -- Multiple values possible
-- MEFStatus is determined in SP_CRM_PULL_CFACTS
,ap.NEXT_REQUIRED_CONTINGENCY_PLAN_TEST_DATE as NEXT_REQUIRED_CP_TEST_DATE
,ap.OA_STATUS[0]::varchar as OA_STATUS
,ap.OPERATED_BY[0]::varchar as OPERATED_BY
,ap.PACKAGE_TYPE[0]::varchar as PACKAGE_TYPE
,pia.HELPER_PIA014[0]::varchar as PIA_014
,ap.PIA_EXPIRATION_DATE as PIA_EXPIRATION_DATE
,pisso.USER_NAMES as PRIMARY_ISSO
,ARRAY_TO_STRING(ap.OPERATING_LOCATION,',') as PRIMARY_OPERATING_LOCATION
,ato.REASON_FOR_ATO_REQUEST[0]::varchar as REASON_FOR_ATO_REQUEST
,sca.GROUP_NAMES as SCA
,ap.SCA_DATE as SCA_DATE
,sdm.USER_NAMES as SDM
,ato.SDM_REVIEW_DUE_DATE as SOP_REVIEW_DATE -- 250303 VW_CFACTS_SYSTEMS was using SDM_REVIEW_DUE_DATE
,ap.STE_DATE as STE_DATE
,CORE.FN_CRM_CLEANSTRING(ap.SYSTEMDESCRIPTION_TRUNCATED) as SYSTEM_DESCRIPTION
,ap.IDUID as SYSTEM_ID
,ap.TLC_PHASE[0]::varchar as TLC_PHASE
FROM APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT ap
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CEDAR_EASI_INTEGRATION_NO_FILTERS_ cedar on cedar.IDUID = ap.IDUID
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_ALLOCATED_CONTROLS_REPORT ac on ac._content_id = ap._CONTENT_ID
--
-- ALERT: component_acronym is not unique and component_name is not unique
--
LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_COMPONENT_REPORT comp on comp.component_acronym = ap.component_acronym
--
-- Division does appear to be unique
-- LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_DIVISION_REPORT div on div.division = ap.division_name
--
-- Alert: group_name is not unique and group_acronym is not unique
--
--LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_GROUP_REPORT grp on grp.group_name = ap.group_name

LEFT OUTER JOIN W_ATO ato on ato.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_BO bo on bo.IDUID = ap.IDUID
LEFT OUTER JOIN W_CIO cio on cio.IDUID = ap.IDUID
LEFT OUTER JOIN W_CISO ciso on ciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_COMPRISK cro on cro.IDUID = ap.IDUID
LEFT OUTER JOIN W_CRA cra on cra.IDUID = ap.IDUID
LEFT OUTER JOIN W_DCISO dciso on dciso.IDUID = ap.IDUID
LEFT OUTER JOIN W_DIVISION div on div.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_INFOTYPES infotype on infotype.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_ISSO isso on isso.IDUID = ap.IDUID
LEFT OUTER JOIN W_ISSOCS issocs on issocs.IDUID = ap.IDUID
LEFT OUTER JOIN W_PIA pia on pia.system_contentId = ap._CONTENT_ID
LEFT OUTER JOIN W_PRIMARY_CRA pcra on pcra.IDUID = ap.IDUID
LEFT OUTER JOIN W_PRIMARY_ISSO pisso on pisso.IDUID = ap.IDUID
LEFT OUTER JOIN W_SCA sca on sca.IDUID = ap.IDUID
LEFT OUTER JOIN W_SDM sdm on sdm.IDUID = ap.IDUID

LEFT OUTER JOIN APP_ARCHER.PRIVATE.__REPORT_CONTENT_CFACTS_SDL_RISK_ACCEPTANCE_RBD_REPORT ra on ra.SYSTEM_TRACKING_ID = ap._content_id
WHERE ap.IDUID IS NOT NULL
;
create or replace view VW_APP_ARCHER_USERMAPPING(
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ROLE,
	SYSTEM_ID,
	USER_ID,
	USER_LEVEL_ROLE
) COMMENT='Map APP_ARCHER (CFACTS) users to system, component, group and role'
 as
SELECT s.ACRONYM
,s.COMPONENT_ACRONYM 
,s.GROUP_ACRONYM
,user_sys.ROLE
,s.SYSTEM_ID
,u.username as USER_ID
,r.name as USER_LEVEL_ROLE
FROM APP_ARCHER.DEV_PRIVATE.__META_USERS u
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__META_ROLE_MEMBERSHIPS rm on rm.USERID = u.ID
LEFT OUTER JOIN APP_ARCHER.DEV_PRIVATE.__META_ROLES r on r.ID = rm.ROLEID
LEFT OUTER JOIN (

SELECT IDUID as FISMA_ID, 'CISO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => CHIEF_INFORMATION_SECURITY_OFFICER_CISO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'BO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => CONTROL_OWNER_CO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'Component Report POC' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => COMPONENT_RISK_REPORTS_OVERSIGHT:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'CRA' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => CYBER_RISK_ADVISOR_CRA:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'Primary CRA' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => DSPC_POC:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'SDM' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => INFORMATION_SYSTEM_ADMINISTRATOR_ISA:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'Deputy CISO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => INFORMATION_SYSTEM_OWNER_ISO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'ISSO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'ISSOCS' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => ISSO_CONTRACTOR_SUPPORT_ISSOCS:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'Primary ISSO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'SA' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => SECURITY_CONTROL_ASSESSOR_SCA:Users) USER_LIST
--
-- Additional tables added 2/25/25
--
UNION ALL
SELECT IDUID as FISMA_ID, 'SRO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => SYSTEM_OBSERVER:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'CIO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => AUTHORIZING_OFFICIAL_AO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'DCIO' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => DEPUTY_CHIEF_INFORMATION_OFFICER_DCIO:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'GTL' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => GOVERNMENT_TECHNICAL_LEAD_GTL:Users) USER_LIST
UNION ALL
SELECT IDUID as FISMA_ID, 'Default Record Permissions' ROLE, USER_LIST.value:UserName::string as USER_ID
from APP_ARCHER.DEV_PRIVATE.__REPORT_CONTENT_CFACTS_SDL_AUTHORIZATION_PACKAGE_REPORT,
LATERAL FLATTEN(input => DEFAULT_RECORD_PERMISSIONS:Users) USER_LIST
--
-- Group/User relationship
--
UNION ALL
SELECT NULL as FISMA_ID, 'TESTGROUP: ISPG Fed Staff' ROLE, u.username  as USER_ID
FROM APP_ARCHER.DEV_PRIVATE.__META_GROUP_MEMBERSHIPS gm
JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.ID = gm.userid
WHERE gm.GROUPID = 102
UNION ALL
SELECT NULL as FISMA_ID, 'TESTGROUP: ISPG Contractor Staff' ROLE, u.username  as USER_ID
FROM APP_ARCHER.DEV_PRIVATE.__META_GROUP_MEMBERSHIPS gm
JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.ID = gm.userid
WHERE gm.GROUPID = 216
UNION ALL
SELECT NULL as FISMA_ID, 'TESTGROUP: CMS Read Only' ROLE, u.username  as USER_ID
FROM APP_ARCHER.DEV_PRIVATE.__META_GROUP_MEMBERSHIPS gm
JOIN APP_ARCHER.DEV_PRIVATE.__META_USERS u on u.ID = gm.userid
WHERE gm.GROUPID = 130

) user_sys on user_sys.USER_ID = u.username
left outer join CORE.VW_SYSTEMS s on s.SYSTEM_ID = user_sys.FISMA_ID
WHERE u.ACCOUNTSTATUS in (1) -- 1,2,3

/*
--
-- FROM Jen
--
CHIEF_INFORMATION_SECURITY_OFFICER_CISO	Chief Information Security Officer (CISO)
CONTROL_OWNER_CO	Business Owner (BO)
COMPONENT_RISK_REPORTS_OVERSIGHT	Component Risk Reports Oversight
CYBER_RISK_ADVISOR_CRA	Cyber Risk Advisor (CRA)
DSPC_POC	Primary Cyber Risk Advisor (CRA)
INFORMATION_SYSTEM_ADMINISTRATOR_ISA	System Developer Maintainer (SDM)
INFORMATION_SYSTEM_OWNER_ISO	Deputy Chief Information Security Officer (DCISO)
INFORMATION_SYSTEM_SECURITY_OFFICER_ISSO	Information System Security Officer (ISSO)
ISSO_CONTRACTOR_SUPPORT_ISSOCS	ISSO Contractor Support (ISSOCS)
PRIMARY_INFORMATION_SYSTEM_SECURITY_OFFI	Primary Information System Security Offiver (ISSO)
SECURITY_CONTROL_ASSESSOR_SCA	Security Assessor (SA)
	
Added to integration	
SYSTEM_OBSERVER	System Read Only (SRO)
AUTHORIZING_OFFICIAL_AO	Chief Information Officer (CIO)
DEPUTY_CHIEF_INFORMATION_OFFICER_DCIO	Deputy Chief Information Officer (DCIO)
GOVERNMENT_TECHNICAL_LEAD_GTL	Government Technical Lead (GTL)
DEFAULT_RECORD_PERMISSIONS	Default Record Permissions
--------------------------------------------
select ROLE,count(1) Total from vw_cfacts_usermapping GROUP BY ROLE ORDER BY ROLE
ROLE	TOTAL
BO	351
CIO	384
CISO	384
CMS Read Only	140
CRA	257
Component Report POC	2819
Deputy CISO	384
ISPG Contractor Staff	114
ISPG Fed Staff	48
ISSO	1403
ISSO CS	1040
Primary CRA	586
Primary ISSO	346
SDM	337
*/

;
create or replace view VW_ASSETAGE_BYDEVICETYPE(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DEVICETYPE,
	ASSETS_BT0AND3,
	ASSETS_BT0AND7,
	ASSETS_BT4AND30,
	ASSETS_BT31AND90,
	ASSETS_GT90,
	ASSETS_VULBT0AND3,
	ASSETS_VULBT0AND7,
	ASSETS_VULBT4AND30,
	ASSETS_VULBT31AND90,
	ASSETS_VULGT90
) COMMENT='Shows total assets of multiple age group based on last_confirmed_time and Lastseen_VUL group by devicetype.'
 as
select dc.DataCenter_Acronym
,dc.System_Acronym
,dc.DeviceType
,coalesce(bt0and3.TotalAssets,0) as Assets_bt0and3
,coalesce(bt0and7.TotalAssets,0) as Assets_bt0and7
,coalesce(bt4and30.TotalAssets,0) as Assets_bt4and30
,coalesce(bt31and90.TotalAssets,0) as Assets_bt31and90
,coalesce(gt90.TotalAssets,0) as Assets_gt90
,coalesce(Vulbt0and3.TotalAssets,0) as Assets_Vulbt0and3
,coalesce(Vulbt0and7.TotalAssets,0) as Assets_Vulbt0and7
,coalesce(Vulbt4and30.TotalAssets,0) as Assets_Vulbt4and30
,coalesce(Vulbt31and90.TotalAssets,0) as Assets_Vulbt31and90
,coalesce(Vulgt90.TotalAssets,0) as Assets_Vulgt90

FROM (SELECT DataCenter_Acronym,System_Acronym,DeviceType
	FROM CORE.VW_Assets
	group by DataCenter_Acronym,System_Acronym,DeviceType) dc

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) between 0 and 3
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) bt0and3 on bt0and3.DataCenter_Acronym = dc.DataCenter_Acronym and bt0and3.System_Acronym = dc.System_Acronym and bt0and3.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) between 0 and 7
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) bt0and7 on bt0and7.DataCenter_Acronym = dc.DataCenter_Acronym and bt0and7.System_Acronym = dc.System_Acronym and bt0and7.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) between 4 and 30
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) bt4and30 on bt4and30.DataCenter_Acronym = dc.DataCenter_Acronym and bt4and30.System_Acronym = dc.System_Acronym and bt4and30.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) between 31 and 90
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) bt31and90 on bt31and90.DataCenter_Acronym = dc.DataCenter_Acronym and bt31and90.System_Acronym = dc.System_Acronym and bt31and90.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets 
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) > 90
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) gt90 on gt90.DataCenter_Acronym = dc.DataCenter_Acronym and gt90.System_Acronym = dc.System_Acronym and gt90.DeviceType = dc.DeviceType
------------------------------------------------------------------------------------------------------------------------------
LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,Lastseen_VUL,getdate()) between 0 and 3
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) Vulbt0and3 on Vulbt0and3.DataCenter_Acronym = dc.DataCenter_Acronym and Vulbt0and3.System_Acronym = dc.System_Acronym and Vulbt0and3.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,last_confirmed_time,getdate()) between 0 and 7
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) Vulbt0and7 on Vulbt0and7.DataCenter_Acronym = dc.DataCenter_Acronym and Vulbt0and7.System_Acronym = dc.System_Acronym and Vulbt0and7.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,Lastseen_VUL,getdate()) between 4 and 30
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) Vulbt4and30 on Vulbt4and30.DataCenter_Acronym = dc.DataCenter_Acronym and Vulbt4and30.System_Acronym = dc.System_Acronym and Vulbt4and30.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets
	FROM CORE.VW_Assets
	where DATEDIFF(d,Lastseen_VUL,getdate()) between 31 and 90
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) Vulbt31and90 on Vulbt31and90.DataCenter_Acronym = dc.DataCenter_Acronym and Vulbt31and90.System_Acronym = dc.System_Acronym and Vulbt31and90.DeviceType = dc.DeviceType

LEFT OUTER JOIN (SELECT DataCenter_Acronym,System_Acronym,DeviceType,count(1) TotalAssets 
	FROM CORE.VW_Assets
	where DATEDIFF(d,Lastseen_VUL,getdate()) > 90
	group by DataCenter_Acronym
	,System_Acronym,DeviceType) Vulgt90 on Vulgt90.DataCenter_Acronym = dc.DataCenter_Acronym and Vulgt90.System_Acronym = dc.System_Acronym and Vulgt90.DeviceType = dc.DeviceType

order by dc.DataCenter_Acronym
,dc.System_Acronym
,dc.DeviceType;
create or replace view VW_ASSETAGE_BYSYSTEM(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSETS_BT0AND3,
	ASSETS_BT0AND7,
	ASSETS_BT4AND30,
	ASSETS_BT31AND90,
	ASSETS_GT90,
	ASSETS_VULBT0AND3,
	ASSETS_VULBT0AND7,
	ASSETS_VULBT4AND30,
	ASSETS_VULBT31AND90,
	ASSETS_VULGT90
) COMMENT='Shows multiple age groups total assets of systems, based on last_confirmed_time and Lastseen_VUL .'
 as
select DataCenter_Acronym
,System_Acronym
,SUM(Assets_bt0and3) as Assets_bt0and3
,SUM(Assets_bt0and7) as Assets_bt0and7
,SUM(Assets_bt4and30) as Assets_bt4and30
,SUM(Assets_bt31and90) as Assets_bt31and90
,SUM(Assets_gt90) as Assets_gt90
,SUM(Assets_Vulbt0and3) as Assets_Vulbt0and3
,SUM(Assets_Vulbt0and7) as Assets_Vulbt0and7
,SUM(Assets_Vulbt4and30) as Assets_Vulbt4and30
,SUM(Assets_Vulbt31and90) as Assets_Vulbt31and90
,SUM(Assets_Vulgt90) as Assets_Vulgt90
FROM CORE.VW_AssetAge_ByDeviceType
group by DataCenter_Acronym
,System_Acronym
order by DataCenter_Acronym
,System_Acronym;
create or replace view VW_ASSETHIST(
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_INSTANCESTATUS,
	AZURE_SUBSCRIPTION_ID,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ACCOUNT_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	ASSETHIST_ID,
	ASSET_DATECREATED,
	IPV4,
	IPV6,
	IS_ENDPOINT,
	IS_FORESCOUT_MANAGED,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	REPORT_DATE,
	REPORT_ID,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) COMMENT='Shows detail asset history '
 as
SELECT 
ah.ASSET_ID_TATTOO
,ah.AWS_ACCOUNTID -- 240624 CR913 added to ASSETHIST but need to coordinate wt Reporting Team for view change
,ah.AWS_INSTANCESTATUS
,ah.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,ah.BIGFIX_ASSET_ID
,ah.BIOS_GUID
,coalesce(ah.AWS_ACCOUNTID,ah.AZURE_SUBSCRIPTION_ID) as CLOUD_ACCOUNT_ID -- 241125 CR1038
,ah.COMPUTER_TYPE
,dc.ACRONYM as DATACENTER_ACRONYM
,dc.COMMONNAME as DATACENTER_COMMONNAME
,ah.DATACENTER_ID
,ah.DATEMODIFIED
,dr.DEVICEROLE
,dt.DEVICETYPE
,ah.DW_ASSET_ID
,ah.ENVIRONMENT
,aich.FQDN
,aich.HOSTNAME
,ah.ID as ASSETHIST_ID
,ah.ASSET_DATECREATED -- 240624 CR913 was a.INSERT_DATE
,aich.IPV4
,aich.IPV6
,ah.IS_ENDPOINT -- 241212 CR1052
,ah.IS_FORESCOUT_MANAGED -- 241011 CR1001
,ah.IS_SCANNABLE
,ah.IS_TATTOOABLE
,ah.IS_TENABLE_CREDENTIALED_SCAN -- 241011 CR1001
,ah.LAST_CONFIRMED_TIME
,ah.LASTASSETUPDATE
,ah.LASTSEEN_CSM
,ah.LASTSEEN_HWAM
,ah.LASTSEEN_SWAM
,ah.LASTSEEN_VUL
,aich.MACADDRESS
,ah.MOTHERBOARD
,aich.NETBIOSNAME
,ah.OS
,ah.OS_CPE
,ah.OS_VERSION
,r.REPORT_DATE
,r.REPORT_ID
,ah.SOURCE_TOOL_CREATE
,ah.SOURCE_TOOL_CSM
,ah.SOURCE_TOOL_HWAM
,ah.SOURCE_TOOL_LASTSEEN
,ah.SOURCE_TOOL_SWAM
,ah.SOURCE_TOOL_VUL
,s.ACRONYM as SYSTEM_ACRONYM
,s.COMMONNAME as SYSTEM_COMMONNAME
,ah.SYSTEM_ID -- 241024 CR-EBF was s.SYSTEM_ID which yielded null when system retired
,ah.TENABLEUUID
-- ,ah.TENANT_ID -- 240624 CR913 added to ASSETHIST but need to coordinate wt Reporting Team for view change
,ah.VULNRISKTOLERANCE
FROM CORE.REPORT_IDS r
JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
-- 240624 CR913 left outer join CORE.ASSET a on a.DW_ASSET_ID = ah.DW_ASSET_ID
left outer join CORE.DEVICETYPES dt on dt.DEVICETYPE = ah.DEVICETYPE
left outer join CORE.DEVICEROLES dr on dr.DEVICEROLE = dt.DEVICEROLE
left outer join CORE.ASSETINTERFACECOALESCEDHIST aich on aich.REPORT_ID = ah.REPORT_ID and aich.DW_ASSET_ID = ah.DW_ASSET_ID
left outer join CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
left outer join CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
;
create or replace view VW_ASSETINTERFACE(
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	IS_DATACENTER,
	DATACENTER_ID,
	DATECREATED,
	DATEMODIFIED,
	DEVICEROLE,
	DEVICETYPE,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	LAST_CONFIRMED_TIME,
	MOTHERBOARD_SN,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SYSTEM_ACRONYM,
	PRIMARY_FISMA_ID,
	IPV4,
	IPV6,
	MAC,
	TENABLEUUID,
	SOURCE_TOOL_CREATE,
	DEPENDENT_FISMA_ID
) COMMENT='Shows  active assets with combile interfaces (IPv4,Hostname,FQDN,MacAddress etc.)'
 as
SELECT 
Asset.DW_Asset_ID
--,Asset.asset_id_derived
,Asset.asset_id_tattoo
,Asset.bigfix_asset_id
,Asset.bios_guid
--,Asset.Val_asset_uid as cms_asset_uid
,Asset.computer_type
,cd.Acronym as DataCenter_Acronym
,cd.Is_DataCenter
--,cd.Is_PhantomSystem as DataCenter_Is_Phantom
,cd.SYSTEM_ID as datacenter_id
,Asset.INSERT_DATE as datecreated
,Asset.dateModified
,dr.DeviceRole
,dt.DeviceType
,Asset.environment
,ai.fqdn
,ai.hostname
,Asset.last_confirmed_time
,Asset.motherboard as motherboard_sn
,ai.netbiosname
,Asset.os
,Asset.os_cpe
,Asset.os_version
,cf.Acronym as System_Acronym
--,cf.Is_PhantomSystem as System_Is_Phantom
,cf.SYSTEM_ID as primary_fisma_id
,ai.IPv4
,ai.IPv6
,ai.Macaddress as Mac
,Asset.TenableUUID
--,Asset.DataSourceID_ins
--,Asset.DataSourceID_upd
--,Asset.source_tool
,Asset.source_tool_create
,NULL as dependent_fisma_id 
--,Asset.datacenter_id
--,Asset.primary_fisma_id
FROM CORE.VW_Assets Asset
JOIN CORE.VW_Systems cd on cd.SYSTEM_ID = Asset.datacenter_id
JOIN CORE.VW_Systems cf on cf.SYSTEM_ID = Asset.SYSTEM_ID
JOIN DeviceTypes dt on dt.DEVICETYPE = Asset.DeviceType 
JOIN DeviceRoles dr on dr.DEVICEROLE = dt.DeviceRole
LEFT OUTER JOIN CORE.ASSETINTERFACECOALESCED ai on ai.DW_Asset_ID = Asset.DW_Asset_ID;
create or replace view VW_ASSETS(
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_INSTANCESTATUS,
	AZURE_SUBSCRIPTION_ID,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ACCOUNT_ID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_FORESCOUT_MANAGED,
	IS_FROM_AWS_FEED,
	IS_ENDPOINT,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_BUILD_NUMBER,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	VULNRISKTOLERANCE
) COMMENT='CRITICAL; View reports active assets from ASSET (MDR) table. It is used throughout CRM\t'
 as
SELECT 
a.ASSET_ID_TATTOO
,a.AWS_ACCOUNTID -- 240530 CR902
,a.AWS_INSTANCESTATUS
,a.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,coalesce(a.AWS_ACCOUNTID,a.AZURE_SUBSCRIPTION_ID) as CLOUD_ACCOUNT_ID -- 241122 CR1038
,a.CLOUD_ID
,a.COMPUTER_TYPE
,dc.ACRONYM as DATACENTER_ACRONYM
,dc.COMMONNAME as DATACENTER_COMMONNAME
,a.DATACENTER_ID
,a.DATEMODIFIED
,a.DEVICEMODEL
,dr.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,a.INSERT_DATE
,aic.IPV4
,aic.IPV6
,a.IS_APPLICABLE
,a.IS_FORESCOUT_MANAGED -- 240709 CR931
,a.IS_FROM_AWS_FEED -- 240709 CR931
,a.IS_ENDPOINT -- 241212 CR1052
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.IS_TENABLE_CREDENTIALED_SCAN -- 240709 CR931
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,aic.MACADDRESS
,a.MOTHERBOARD
,aic.NETBIOSNAME
,a.OS
,a.OS_BUILD_NUMBER -- 240821 CR958
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,s.ACRONYM as SYSTEM_ACRONYM
,s.COMMONNAME as SYSTEM_COMMONNAME
,s.SYSTEM_ID
,a.TENABLEUUID
,a.TENANT_ID -- CR880 DRaaS Tenant_ID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID

Where a.Is_Applicable = 1;
create or replace view VW_ASSET_SOFTWARE(
	DW_SWAM_ID,
	ASSET_ID_TATTOO,
	DATEINSTALLED,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DEVICETYPE,
	DW_ASSET_ID,
	FIRSTSEEN,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_FORESCOUT_MANAGED,
	IS_SCANNABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SWAM_SUBCATEGORY,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	VENDOR,
	VERSION
) COMMENT='Software associated with each asset\t'
 as
select
soft.DW_SWAM_ID
,a.ASSET_ID_TATTOO
,TO_CHAR(soft.DATEINSTALLED,'MM/DD/YYYY') as DATEINSTALLED
,a.DATACENTER_ACRONYM
,a.DATACENTER_ID
,a.DEVICETYPE
,soft.DW_ASSET_ID
,TO_CHAR(soft.FIRSTSEEN,'MM/DD/YYYY') as FIRSTSEEN
,TO_CHAR(soft.INSERT_DATE,'MM/DD/YYYY') as INSERT_DATE
,a.IS_FROM_AWS_FEED -- 240709 CR931
,a.IS_FORESCOUT_MANAGED -- 240709 CR931
,a.IS_SCANNABLE -- 240709 CR931
,a.IS_TENABLE_CREDENTIALED_SCAN -- 240709 CR931
,TO_CHAR(soft.LASTSEEN,'MM/DD/YYYY') as LASTSEEN
,soft.MAJOR
,soft.MINOR
--,soft.PRODUCTNAME
,soft.SOFTWARENAME
,soft.SOURCE_TOOL
,soft.SWAM_CATEGORY
,soft.SWAM_SUBCATEGORY
,a.SYSTEM_ACRONYM
,a.SYSTEM_ID
,soft.VENDOR
,soft.VERSION
FROM CORE.VW_ASSETS a
JOIN CORE.ASSET_SOFTWARE soft on soft.DW_ASSET_ID = a.DW_ASSET_ID
;
create or replace view VW_ASSET_SOFTWARE_BUS_MARKETPLACE_MSI(
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	TLC_PHASE,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	DATE_ASSET_CREATED,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	IS_SCANNABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN_HWAM,
	MACADDRESS,
	NETBIOSNAME,
	OS,
	OS_VERSION,
	SOURCE_TOOL_LASTSEEN,
	DATE_SOFTWARE_CREATED,
	DATE_INSTALLED,
	DW_SWAM_ID,
	FIRSTSEEN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SWAM_SUBCATEGORY,
	VENDOR,
	VERSION
) COMMENT='Software associated with each Marketplace asset\t'
 as
select
--
-- System identifying data
--
s.COMPONENT_ACRONYM
,s.GROUP_ACRONYM
,s.HVASTATUS
,s.IS_MARKETPLACE
,s.MEFSTATUS
,s.OATO_CATEGORY
,s.TLC_PHASE
,a.SYSTEM_ACRONYM
,a.SYSTEM_ID
--
-- Asset identifying data
--
,a.ASSET_ID_TATTOO
,a.AWS_INSTANCESTATUS
,TO_CHAR(a.INSERT_DATE,'MM/DD/YYYY') as DATE_ASSET_CREATED
,a.DATACENTER_ACRONYM
,a.DATACENTER_ID
,a.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,upper(a.environment) as ENVIRONMENT
,a.FQDN
,a.HOSTNAME
,a.IPV4
,a.IPV6
,a.IS_SCANNABLE
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.LASTSEEN_HWAM
,a.MACADDRESS
,a.NETBIOSNAME
,a.OS
,a.OS_VERSION
,a.SOURCE_TOOL_LASTSEEN
--
-- Software
--
,TO_CHAR(soft.INSERT_DATE,'MM/DD/YYYY') as DATE_SOFTWARE_CREATED
,TO_CHAR(soft.DATEINSTALLED,'MM/DD/YYYY') as DATE_INSTALLED
,soft.DW_SWAM_ID -- Unique ID representing one Asset/Software
,TO_CHAR(soft.FIRSTSEEN,'MM/DD/YYYY') as FIRSTSEEN
,TO_CHAR(soft.LASTSEEN,'MM/DD/YYYY') as LASTSEEN
,soft.MAJOR
,soft.MINOR
--,soft.PRODUCTNAME
,soft.SOFTWARENAME
,soft.SOURCE_TOOL
,soft.SWAM_CATEGORY
,soft.SWAM_SUBCATEGORY
,soft.VENDOR
,soft.VERSION
FROM CORE.VW_ASSETS a
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.ASSET_SOFTWARE soft on soft.DW_ASSET_ID = a.DW_ASSET_ID
;
create or replace view VW_ASSET_SOFTWARE_TEST(
	DW_SWAM_ID,
	ASSET_ID_TATTOO,
	DATEINSTALLED,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DEVICETYPE,
	DW_ASSET_ID,
	FIRSTSEEN,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_FORESCOUT_MANAGED,
	IS_SCANNABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SWAM_SUBCATEGORY,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	VENDOR,
	VERSION
) COMMENT='Software associated with each asset\t'
 as
select
soft.DW_SWAM_ID
,a.ASSET_ID_TATTOO
,TO_CHAR(soft.DATEINSTALLED,'MM/DD/YYYY') as DATEINSTALLED
,a.DATACENTER_ACRONYM
,a.DATACENTER_ID
,a.DEVICETYPE
,soft.DW_ASSET_ID
,TO_CHAR(soft.FIRSTSEEN,'MM/DD/YYYY') as FIRSTSEEN
,TO_CHAR(soft.INSERT_DATE,'MM/DD/YYYY') as INSERT_DATE
,a.IS_FROM_AWS_FEED -- 240709 CR931
,a.IS_FORESCOUT_MANAGED -- 240709 CR931
,a.IS_SCANNABLE -- 240709 CR931
,a.IS_TENABLE_CREDENTIALED_SCAN -- 240709 CR931
,TO_CHAR(soft.LASTSEEN,'MM/DD/YYYY') as LASTSEEN
,soft.MAJOR
,soft.MINOR
--,soft.PRODUCTNAME
,soft.SOFTWARENAME
,soft.SOURCE_TOOL
,soft.SWAM_CATEGORY
,soft.SWAM_SUBCATEGORY
,a.SYSTEM_ACRONYM
,a.SYSTEM_ID
,soft.VENDOR
,soft.VERSION
FROM CORE.VW_ASSETS a
JOIN CORE.ASSET_SOFTWARE soft on soft.DW_ASSET_ID = a.DW_ASSET_ID
WHERE datediff(d,soft.LASTSEEN,current_timestamp()) <= 15
;
create or replace view VW_AWS_CAMPDB_LOOKUP(
	DATE,
	DATA_CENTER,
	FISMA,
	SYSTEM_ACRONYM,
	ACCOUNT_NUMBER,
	VERIFIED_DATA_CENTER,
	VERIFIED_FISMA,
	VERIFIED_SYSTEM_ACRONYM,
	VERIFIED_COMMONNAME,
	DATACENTER_ID,
	SYSTEM_ID
) COMMENT='CRITICAL; Replacement for SEC_VW_FISMA_LOOKUPS which comes from CAMP DB. Validates/Resolves SYSTEM_ACRONYM if common-name\t'
 as
SELECT 
--
-- CAMP DB (source) can have errors due to case.
-- We use UPPER function to improve the odds of matching DATACENTER_ID and SYSTEM_ID.
--
flu.DATE
,flu.DATA_CENTER
,flu.FISMA
,flu.SYSTEM_ACRONYM
,flu.ACCOUNT_NUMBER
,dc.SYSTEM_ID as Verified_DATA_CENTER
,s.SYSTEM_ID as Verified_FISMA
,sa.ACRONYM as Verified_SYSTEM_ACRONYM
,sc.ACRONYM as Verified_COMMONNAME
,coalesce(dc.SYSTEM_ID,'CAMPDB has invalid DATA_CENTER') as DATACENTER_ID -- This is the fieldname used throughout SDW
,coalesce(s.SYSTEM_ID,sa.SYSTEM_ID,sc.SYSTEM_ID,'Cant determine CAMPDB SYSTEM_ID') as SYSTEM_ID -- This is the fieldname used throughout SDW
FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS flu
LEFT OUTER JOIN CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(flu.DATA_CENTER)
LEFT OUTER JOIN CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(flu.FISMA)
LEFT OUTER JOIN CORE.VW_SYSTEMS sa on upper(sa.ACRONYM) = upper(flu.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.VW_SYSTEMS sc on upper(sc.COMMONNAME) = upper(flu.SYSTEM_ACRONYM)
;
create or replace view VW_AWS_CAMPDB_LOOKUP_V2(
	DATE,
	ACCOUNT_NUMBER,
	DATACENTER_ID,
	DATACENTER_ACRONYM,
	CAMP_SYSTEM_ACRONYM,
	VERIFIED_SYSTEM_ACRONYM,
	VERIFIED_SYSTEM_ID,
	VERIFIED_TLC_PHASE,
	SEC_VW_FISMA_LOOKUPS_FISMA,
	APP_PHASE_NAME,
	ACCOUNT_NAME,
	ACCOUN_TYPE,
	LONG_APP_NAME,
	SHORT_APP_NAME,
	APP_LIVE_STATUS,
	ADO_TECH_MANAGER_EMAIL,
	ENV_NAME,
	MARKETPLACE,
	MEDIC_OE_EFFECT,
	OE_EFFECT,
	PLATFORM_NAME,
	PROJ_PHASE,
	ID,
	FILE_NAME,
	FILE_LAST_MODIFIED
) COMMENT='CRITICAL; Replacement for SEC_VW_FISMA_CAMP which comes from CAMP DB. Validates/Resolves SYSTEM_ACRONYM if common-name\t'
 as
SELECT 
--
-- SEC_VW_FISMA_CAMP has following critical columns:
-- a) ACCOUNT_NUMBER (AWS account number and MAG SUBSCRIPTION_ID)
--    Use upper function on ACCOUNT_NUMBER to resolve case issues i.e. Normalize the ACCOUNT_NUMBER
-- b) SYSTEM_ACRONYM which is not the preferred column for identifying FISMA System because of human inconsistencies (e.g. case or use of common acronym)
--    Instead we will join SEC_VW_FISMA_CAMP to SEC_VW_FISMA_LOOKUPS based on ACCOUNT_NUMBER to obtain the FISMA (ID)
--
-- SEC_VW_FISMA_LOOKUPS contains DATA_CENTER (ID)
--
-- CAMP DB (source) can have/has user induced errors. Plan is to send CFACTS data to CAMP DB to obtain consistency.
-- We use UPPER function to improve the odds of matching DATACENTER_ID and SYSTEM_ID.
--
camp.DATE
,camp.ACCOUNT_NUMBER
,lua.DATACENTER_ID
,lua.DATACENTER_ACRONYM
,camp.SYSTEM_ACRONYM as CAMP_SYSTEM_ACRONYM
,lua.VERIFIED_SYSTEM_ACRONYM
,lua.VERIFIED_SYSTEM_ID
,lua.VERIFIED_TLC_PHASE
,lua.SEC_VW_FISMA_LOOKUPS_FISMA
,camp.APP_PHASE_NAME
,camp.ACCOUNT_NAME
,camp.ACCOUN_TYPE
,camp.LONG_APP_NAME
,camp.SHORT_APP_NAME
,camp.APP_LIVE_STATUS
,camp.ADO_TECH_MANAGER_EMAIL
,camp.ENV_NAME
,camp.MARKETPLACE
,camp.MEDIC_OE_EFFECT
,camp.OE_EFFECT
,camp.PLATFORM_NAME
,camp.PROJ_PHASE
,camp.ID
,camp.FILE_NAME
,camp.FILE_LAST_MODIFIED
FROM REF_LOOKUPS.PUBLIC.SEC_VW_FISMA_CAMP camp

LEFT OUTER JOIN (select DISTINCT flu.ACCOUNT_NUMBER,flu.DATA_CENTER as DATACENTER_ID
    ,dc.ACRONYM as DATACENTER_ACRONYM
    ,flu.FISMA as SEC_VW_FISMA_LOOKUPS_FISMA
    ,coalesce(s.ACRONYM,sa.ACRONYM,sc.ACRONYM,'Cant determine CAMPDB SYSTEM_ACRONYM') as VERIFIED_SYSTEM_ACRONYM
    ,coalesce(s.SYSTEM_ID,sa.SYSTEM_ID,sc.SYSTEM_ID,'Cant determine CAMPDB SYSTEM_ID') as VERIFIED_SYSTEM_ID
    ,coalesce(s.TLC_PHASE,sa.TLC_PHASE,sc.TLC_PHASE,'Cant determine CAMPDB TLC_PHASE') as VERIFIED_TLC_PHASE
    FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS flu
    LEFT OUTER JOIN CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(flu.DATA_CENTER)
    LEFT OUTER JOIN CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(flu.FISMA)
    LEFT OUTER JOIN CORE.VW_SYSTEMS sa on upper(sa.ACRONYM) = upper(flu.SYSTEM_ACRONYM)
    LEFT OUTER JOIN CORE.VW_SYSTEMS sc on upper(sc.COMMONNAME) = upper(flu.SYSTEM_ACRONYM)) lua on upper(lua.ACCOUNT_NUMBER) = upper(camp.ACCOUNT_NUMBER)
/*
 LEFT OUTER JOIN (select DISTINCT flu.ACCOUNT_NUMBER,flu.DATA_CENTER as DATACENTER_ID
    ,dc.ACRONYM as DATACENTER_ACRONYM
    ,flu.FISMA as SEC_VW_FISMA_LOOKUPS_FISMA
    ,coalesce(s.ACRONYM,sa.ACRONYM,sc.ACRONYM,'Cant determine CAMPDB SYSTEM_ACRONYM') as VERIFIED_SYSTEM_ACRONYM
    ,coalesce(s.SYSTEM_ID,sa.SYSTEM_ID,sc.SYSTEM_ID,'Cant determine CAMPDB SYSTEM_ID') as VERIFIED_SYSTEM_ID
    ,coalesce(s.TLC_PHASE,sa.TLC_PHASE,sc.TLC_PHASE,'Cant determine CAMPDB TLC_PHASE') as VERIFIED_TLC_PHASE
    FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS flu
    LEFT OUTER JOIN CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(flu.DATA_CENTER)
    LEFT OUTER JOIN CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(flu.FISMA)
    LEFT OUTER JOIN CORE.VW_SYSTEMS sa on upper(sa.ACRONYM) = upper(flu.SYSTEM_ACRONYM)
    LEFT OUTER JOIN CORE.VW_SYSTEMS sc on upper(sc.COMMONNAME) = upper(flu.SYSTEM_ACRONYM)) lus on upper(lus.VERIFIED_SYSTEM_ACRONYM) = upper(camp.SYSTEM_ACRONYM) 
    */
;
create or replace view VW_BOD_22_01(
	DATACENTER,
	CVE,
	VENDOR_PROJECT,
	PRODUCT,
	VULNERABILITYNAME,
	DATEADDEDTOCATALOG,
	SHORTDESCRIPTION,
	BODDUEDATE,
	TOTAL
) COMMENT='Return total assets affected by BOD or KEV for eatch datacent.'
 as
SELECT 
dc.Acronym as DataCenter
,vm.CVE
,bod.VendorProject as Vendor_Project
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date AS DateAddedToCatalog -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date as BODDueDate -- 270328 chg to date type
,count(1) Total
FROM CORE.VW_Assets a
join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = vm.DATACENTER_ID
JOIN CORE.KEV_CATALOG bod on bod.CVE = vm.cve
WHERE vm.MitigationStatus <> 'fixed' 
and bod.Is_Deleted = 0
group by dc.Acronym
,vm.CVE
,bod.VendorProject
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date -- 270328 chg to date type
order by dc.Acronym
,vm.CVE
,bod.VendorProject 
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date -- 270328 chg to date type;
;
create or replace view VW_BOD_22_01_SYSTEMBREAKDOWN(
	DATACENTER,
	SYSTEM,
	CVE,
	VENDOR_PROJECT,
	PRODUCT,
	VULNERABILITYNAME,
	DATEADDEDTOCATALOG,
	SHORTDESCRIPTION,
	BODDUEDATE,
	TOTAL
) COMMENT='Return total assets affected by BOD or KEV for each system.'
 as
SELECT 
dc.Acronym as DataCenter
,s.Acronym as System
,vm.CVE
,bod.VendorProject as Vendor_Project
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date as DateAddedToCatalog -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date as BODDueDate -- 270328 chg to date type
,count(1) Total
FROM CORE.VW_Assets a
JOIN CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
JOIN CORE.TEMP_BOD tb on tb.CVE = vm.CVE -- 240319 CR855
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = vm.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.KEV_CATALOG bod on bod.CVE = vm.cve
WHERE vm.MitigationStatus <> 'fixed' 
and bod.Is_Deleted = 0
group by dc.Acronym
,s.Acronym
,vm.CVE
,bod.VendorProject
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date -- 270328 chg to date type
order by dc.Acronym
,s.Acronym
,vm.CVE
,bod.VendorProject 
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog::date -- 270328 chg to date type
,bod.ShortDescription
,bod.BODDueDate::date -- 270328 chg to date type;
;
create or replace view VW_BOD_22_01_TEMPLATE_WORKSHEET_V2(
	CVE,
	"Date Added",
	"Vulnerability Name",
	"Total Findings",
	"Challenges and Constraints",
	"Finding Justification",
	"Estimated Completion Date",
	DELETECOLUMNS,
	COUNT_OF_OPEN_POAMS,
	CURRENT_DATE_PLUS_30,
	PREV_POAM_ACTUAL_COMPLETION_DATE
) COMMENT='Return results needed for BOD Template Worksheet.'
 as
--
-- 240731 CR918 - New version
--
-- OVERALL_STATUS values found in CFACTS POAMS data:
-- Closed for System Retired
-- Completed
-- Delayed
-- Draft
-- Ongoing
-- Pending Verification
-- Risk Accepted
-- 
select
sbod.CVE as "CVE"
,sbod.DATEADDED as "Date Added"
,sbod.VULNERABILITYNAME as "Vulnerability Name"
,coalesce(v.Total,0) as "Total Findings"
,'' as "Challenges and Constraints"
,'' as "Finding Justification"
,case coalesce(v.Total,0) 
    when 0 then ''
    Else 
        case coalesce(est.COUNT_OF_OPEN_POAMS,0)
            when 0 THEN TO_CHAR(dateadd(d,30,current_date()),'MM/DD/YYYY')
            Else TO_CHAR(est.MAX_ESTIMATED_COMPLETION_DATE,'MM/DD/YYYY')
        End
End as "Estimated Completion Date"
,'DELETE THIS COLUMN AND EVERY COLUMN TO THE RIGHT' as DELETECOLUMNS
,coalesce(est.COUNT_OF_OPEN_POAMS,0) as COUNT_OF_OPEN_POAMS
,TO_CHAR(dateadd(d,30,current_date()),'MM/DD/YYYY') as CURRENT_DATE_PLUS_30
,TO_CHAR(completedPoam.MAX_ACTUAL_COMPLETION_DATE,'MM/DD/YYYY') as PREV_POAM_ACTUAL_COMPLETION_DATE
FROM CORE.TEMP_BOD sbod
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.cve = sbod.cve
LEFT OUTER JOIN (select CVE,SUM(Total) as Total
    FROM CORE.VW_BOD_22_01_SYSTEMBREAKDOWN
    GROUP BY CVE) v on v.CVE = sbod.CVE
LEFT OUTER JOIN (select CVE,count(1) COUNT_OF_OPEN_POAMS,MAX(ESTIMATED_COMPLETION_DATE) as MAX_ESTIMATED_COMPLETION_DATE
    FROM CORE.VW_POAMS
    WHERE CVE IS NOT NULL and OVERALL_STATUS NOT IN ('Completed','Closed for System Retired')
    GROUP BY CVE) est on est.CVE = sbod.CVE

LEFT OUTER JOIN (select CVE,MAX(ACTUAL_COMPLETION_DATE) as MAX_ACTUAL_COMPLETION_DATE
    FROM CORE.VW_POAMS
    WHERE CVE IS NOT NULL and OVERALL_STATUS IN ('Completed','Closed for System Retired','Risk Accepted')
    GROUP BY CVE) completedPoam on completedPoam.CVE = sbod.CVE

ORDER BY sbod.DATEADDED::date desc, sbod.CVE
;
create or replace view VW_BOD_ED_22_02_CVEUNREMEDIATED_REPORTING_TEMPLATE(
	CVE,
	"Date Added",
	"Vulnerability Name",
	"Total Findings",
	"Challenges and Constraints",
	"Finding Justification",
	"Estimated Completion Date"
) COMMENT='Used for CMS IMT biweekly BOD report showing total finding for eatch BOD CVE.'
 as
SELECT bod.CVE as "CVE"
,bod.DateAddedToCatalog as "Date Added"
,bod.VulnerabilityName as "Vulnerability Name"
,coalesce(vm.TotalUnremediatedAssets,0) as "Total Findings"
,'' as "Challenges and Constraints"
,'' as "Finding Justification"
,'' as "Estimated Completion Date"
FROM CORE.KEV_Catalog bod
LEFT OUTER JOIN (select vm.cve, count(1) TotalUnremediatedAssets
	FROM CORE.VW_ASSETS a
	JOIN CORE.VW_VulMaster vm on vm.DW_Asset_ID = a.DW_Asset_ID
	WHERE vm.MitigationStatus <> 'fixed' 
	group by vm.cve) vm on vm.cve = bod.CVE
where bod.Is_Deleted = 0
order by bod.CVE
,bod.VulnerabilityName;
create or replace view VW_BOD_ED_22_02_CVEUNREMEDIATED_REPORTING_TEMPLATE_220812_1300(
	CVE,
	DATE_ADDED,
	VULNERABILITY_NAME,
	TOTAL_FINDINGS_UNREMEDIATED_ASSETS,
	CHALLENGES_CONSTRAINTS,
	FINDING_JUSTIFICATION,
	ESTIMATED_REMEDIATION_DATE
) COMMENT='Old version of \"VW_BOD_ED_22_02_CVEUNREMEDIATED_REPORTING_TEMPLATE\"'
 as
SELECT  bod.CVE
,bod.DateAddedToCatalog as Date_Added
,bod.VulnerabilityName as Vulnerability_Name
,coalesce(vm.TotalUnremediatedAssets,0) as Total_Findings_Unremediated_Assets
,'' as Challenges_Constraints
,'' as Finding_Justification
,'' as Estimated_Remediation_Date
FROM CORE.KEV_CATALOG bod
LEFT OUTER JOIN (select vm.cve, count(1) as TotalUnremediatedAssets
	FROM CORE.VW_Assets a
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	WHERE vm.MitigationStatus <> 'fixed' 
    -- and a.Is_Applicable = 1
    -- and vm.DeletionReason IS NULL
	group by vm.cve) vm on vm.cve = bod.CVE
where bod.Is_Deleted = 0
order by bod.CVE
,bod.VulnerabilityName;
create or replace view VW_BOD_ED_22_02_CVEUNREMEDIATED_REPORTING_TEMPLATE_221012_1224(
	CVE_ID,
	VENDOR_PROJECT,
	PRODUCT,
	VULNERABILITY_NAME,
	DATE_ADDED,
	SHORT_DESCRIPTION,
	REQUIRED_ACTION,
	DUE_DATE,
	TOTAL_FINDINGS_UNREMEDIATED_ASSETS,
	CHALLENGES_CONSTRAINTS_FINDING_JUSTIFICATION,
	ESTIMATED_REMEDIATION_DATE
) COMMENT='Old version of \"VW_BOD_ED_22_02_CVEUNREMEDIATED_REPORTING_TEMPLATE\"'
 as
SELECT  bod.CVE as CVE_ID
,bod.VendorProject as Vendor_Project
,bod.Product
,bod.VulnerabilityName as Vulnerability_Name
,bod.DateAddedToCatalog as Date_Added
,bod.ShortDescription as Short_Description
,bod.RequiredAction as Required_Action
,bod.BODDueDate as Due_Date
,coalesce(vm.TotalUnremediatedAssets,0) as Total_Findings_Unremediated_Assets
,'' as Challenges_Constraints_Finding_Justification
,'' as Estimated_Remediation_Date
FROM CORE.KEV_CATALOG bod
LEFT OUTER JOIN (select vm.cve, count(1) TotalUnremediatedAssets
	FROM CORE.VW_Assets a
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	WHERE vm.MitigationStatus <> 'fixed' 
	-- and a.Is_Applicable = 1
	-- and vm.DeletionReason IS NULL
	group by vm.cve) vm on vm.cve = bod.CVE
where bod.Is_Deleted = 0
order by bod.CVE
,bod.VulnerabilityName
;
create or replace view VW_CAATHIST(
	ID,
	REPORTID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	ASSESSMENT_AUDIT_COMPANY,
	AUTHORIZATION_PACKAGE,
	CAAT_ID,
	DATE_IDENTIFIED,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FINDING_TITLE,
	RELATED_POAMS,
	SOURCE_AUDIT_TYPE,
	TEST_METHOD,
	TEST_OBJECTIVE,
	TEST_RESULT,
	WEAKNESS_DESCRIPTION,
	SYSTEM_ID
) COMMENT='Current CAAT records taken from core.CAAThist table'
 as
SELECT caat.ID
,rep.Report_ID as ReportID
,rep.Report_Date as ReportDate
,s.Archer_Tracking_ID
,caat.Assessment_Audit_Company
,s.Authorization_Package
,caat.CAAT_ID
,caat.Date_Identified
,caat.Finding_Description
,caat.Finding_ID
,caat.Finding_Title
,caat.Related_POAMS
,caat.SOURCE_AUDIT_TYPE
,caat.Test_Method
,caat.Test_Objective
,caat.Test_Result
,caat.Weakness_Description
,s.SYSTEM_ID
FROM CORE.CAATHist caat
join TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) rep on rep.Report_ID = caat.REPORT_ID 
LEFT OUTER JOIN CORE.VW_Systems s on s.SYSTEM_ID = caat.SYSTEM_ID;
create or replace view VW_CEDE_CFACTS_USER_PERSMISSIONS(
	REPORTDATE,
	ACRONYM,
	AUTHORIZATION_PACKAGE,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	SYSTEM_ID,
	CFACTS_USER_ID,
	ROLE
) COMMENT='Current CFACTS users mapping to system and role for CEDE'
 as
SELECT
snap.SNAPSHOT_DATE as ReportDate -- This date can be different from ReportDate associated with SystemHist
,s.Acronym
,s.Authorization_Package
,s.Component_Acronym 
,s.Group_Acronym 
,s.TLC_Phase
,case SUBSTRING(s.SYSTEM_ID,1,4)
	when '0000' then NULL
	Else s.SYSTEM_ID
End as SYSTEM_ID
,ul.user_id as CFACTS_USER_ID
,um.Role
FROM RPT.V_CFACTS_USERLIST ul -- 231027 was CORE.VW_CFACTS_UserList ul
JOIN CORE.VW_CFACTS_UserMapping um on um.USER_ID = ul.USER_ID
--JOIN CORE.REPORTSNAPSHOTS rs on rs.report_id = um.report_id
JOIN CORE.VW_Systems s on s.SYSTEM_ID = um.SYSTEM_ID -- and s.Is_ExcludeFromReporting = 0 and s.Is_PhantomSystem = 0
JOIN CORE.VW_CAATHist caat on s.SYSTEM_ID = caat.SYSTEM_ID
JOIN CORE.VW_REPORTSNAPSHOTS rs on caat.REPORTID = (select MAX(RS.REPORT_ID) from CORE.VW_REPORTSNAPSHOTS RS WHERE RS.SnapShot_ID = snap.SNAPSHOT_ID)
JOIN CORE.SNAPSHOT_IDS snap on snap.SNAPSHOT_ID = rs.Snapshot_ID;
create or replace view VW_CEDE_POAMS(
	REPORTDATE,
	"Authorization_Package",
	POAM_ID,
	"Allocated_Control",
	"POA&M Owner",
	"Overall_Status",
	"Days Open",
	"Scheduled Completion Date",
	"Actual Completion Date",
	"Audit Status",
	"Audit Review Date",
	"Business Owner (BO)",
	"CMS Assessment / Audit Tracking",
	"Count of Milestones",
	"Count of Completed Milestones",
	"# of Not Completed Milestones",
	"Component",
	"Cost",
	"Date Identified",
	"Estimated Completion Date",
	"Final POA&M Comparison Date",
	"Final POA&M Weakness Creation Date",
	"Final PO&AM Weakness ID",
	"Finding Description",
	"Finding Title",
	"FIPS 199 Overall Impact Rating",
	"Fiscal Year",
	"Funding Source",
	"POA&M Reviewer",
	"POA&M Status",
	"POA&M Status Indicator",
	"Primary Information_System Security Officer (ISSO)",
	"Recommended Corrective Action(s)",
	"RBD Overall_Status",
	"Priority",
	"Related Risk Acceptance (RBD)",
	"Review Date",
	"Review Status",
	"Review Comments",
	"Required Remediation Date",
	"Remediation Evidence",
	"Source",
	"Weakness Creation Date",
	"Weakness Description",
	"Weakness ID",
	"Weakness POC",
	"Weakness_Risk_Level",
	"Weakness Severity"
) COMMENT='Current POAMs with associated CAAT and Milestone info used for CEDE '
 as
SELECT 
csnap.REPORT_DATE as ReportDate
,sh.Authorization_Package  as "Authorization_Package"
,ph.POAM_ID
,NULL as "Allocated_Control"
,ph.POAM_Owner  as "POA&M Owner"
,ph.Overall_Status  as "Overall_Status"
,ph.Days_Open  as "Days Open"
,ph.Scheduled_Completion_Date  as "Scheduled Completion Date"
,ph.Actual_Completion_Date  as "Actual Completion Date"
,NULL as "Audit Status"
,NULL as "Audit Review Date"
,sh.Business_Owner  as "Business Owner (BO)"
,NULL as "CMS Assessment / Audit Tracking"
,coalesce(mt.Total,0)  as "Count of Milestones"
,coalesce(mc.Total,0)  as "Count of Completed Milestones"
,(coalesce(mt.Total,0) - coalesce(mc.Total,0))  as "# of Not Completed Milestones"
,s.Component_Name as "Component"
,ph.Cost  as "Cost"
,caat.Date_Identified  as "Date Identified"
,ph.Estimated_Completion_Date  as "Estimated Completion Date"
,NULL as "Final POA&M Comparison Date"
,NULL as "Final POA&M Weakness Creation Date"
,NULL as "Final PO&AM Weakness ID"
,caat.Finding_Description  as "Finding Description"
,caat.Finding_Title  as "Finding Title"
,sh.FIPS_199_Overall_Impact_Rating  as "FIPS 199 Overall Impact Rating"
,NULL as "Fiscal Year"
,ph.Funding_Source  as "Funding Source"
,ph.POAM_Reviewer  as "POA&M Reviewer"
,NULL as "POA&M Status"
,NULL as "POA&M Status Indicator"
,sh.Primary_ISSO  as "Primary Information_System Security Officer (ISSO)"
,NULL as "Recommended Corrective Action(s)"
,NULL as "RBD Overall_Status"
,NULL as "Priority"
,NULL as "Related Risk Acceptance (RBD)"
,ph.Review_Date  as "Review Date"
,ph.Review_Status  as "Review Status"
,ph.Review_Comments  as "Review Comments"
,NULL as "Required Remediation Date"
,NULL as "Remediation Evidence"
,caat.SOURCE_AUDIT_TYPE  as "Source"
,ph.Weakness_Creation_Date  as "Weakness Creation Date"
,caat.Weakness_Description  as "Weakness Description"
,ph.Weakness_ID  as "Weakness ID"
,ph.Weakness_POC  as "Weakness POC"
,ph.Weakness_Risk_Level  as "Weakness_Risk_Level"
,ph.Weakness_Severity  as "Weakness Severity"
from table(CORE.FN_CRM_GET_REPORT_ID(0)) csnap
JOIN CORE.SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = sh.SYSTEM_ID 
  
JOIN POAMHist ph on ph.REPORT_ID = csnap.REPORT_ID and ph.SYSTEM_ID = sh.SYSTEM_ID
JOIN CAATHist caat on caat.REPORT_ID = csnap.REPORT_ID 
	and caat.CAAT_ID = ph.CAAT 
	and caat.SYSTEM_ID = sh.SYSTEM_ID
LEFT OUTER JOIN (SELECT REPORT_ID,SYSTEM_ID,POAM_ID,COUNT(1) as Total 
	FROM CORE.MilestoneHist
	GROUP BY REPORT_ID,SYSTEM_ID,POAM_ID) mt on mt.REPORT_ID = csnap.REPORT_ID and mt.SYSTEM_ID = sh.SYSTEM_ID and mt.POAM_ID = ph.POAM_ID
LEFT OUTER JOIN (SELECT REPORT_ID,SYSTEM_ID,POAM_ID,COUNT(1) as Total 
	FROM CORE.MilestoneHist
	WHERE Milestone_Status IS NOT NULL and Milestone_Status = 'Completed'
	GROUP BY REPORT_ID,SYSTEM_ID,POAM_ID) mc on mt.REPORT_ID = csnap.REPORT_ID and mc.SYSTEM_ID = sh.SYSTEM_ID and mt.POAM_ID = ph.POAM_ID;
create or replace view VW_CEDE_PRIVACY_IMPACT_ASSESSMENT(
	REPORTDATE,
	"Authorization_Package",
	"Tracking ID",
	"Administrators Explanation",
	"ATO Expiration Date",
	"Authorization_Package: ISSO - ISSOCS",
	"CMS Final Approver",
	"CMS Final Approver Date",
	"CMS Final Approver Review Status",
	"CMS SOP",
	"Component",
	"Contractors Explanation",
	"CRA Review Status",
	"CRA Reviewer",
	"Created By",
	"Default Record Permissions",
	"Developers Explanation",
	"Does the PIA have an Expiration Date?",
	"Form Date",
	"Helper PIA-014",
	"Helper XLC Phase = Disposition for Notifications",
	"HHS PIA Review Date",
	"HHS PIA Review Status",
	"HHS PIA Reviewer",
	"HHS PIA Tracker Comments",
	"Inherited Record Permissions",
	"Is this a PIA Renewal?",
	"ISSO Submitter",
	"Last Updated",
	"Original - PIA-014",
	"Other - Collects PII?",
	"Other Federal Agency/Agencies Explanation",
	"Others Explanation",
	"Overall_Status",
	"Persistent Cookies - Collects PII?",
	"PIA Expiration Date",
	"PIA-001",
	"PIA-002",
	"PIA-002a",
	"PIA-003",
	"PIA-003a",
	"PIA-003b",
	"PIA-004",
	"PIA-005",
	"PIA-006a",
	"PIA-006b",
	"PIA-006c",
	"PIA-006d",
	"PIA-006e",
	"PIA-007",
	"PIA-008",
	"PIA-008a",
	"PIA-008b",
	"PIA-009",
	"PIA-010",
	"PIA-011",
	"PIA-012",
	"PIA-013",
	"PIA-014",
	"PIA-015",
	"PIA-016",
	"PIA-017",
	"PIA-018",
	"PIA-019",
	"PIA-020",
	"PIA-020a",
	"PIA-021",
	"PIA-022",
	"PIA-022a",
	"PIA-022ai",
	"PIA-023",
	"PIA-023a",
	"PIA-023ii",
	"PIA-023iii",
	"PIA-024",
	"PIA-024a",
	"PIA-024b",
	"PIA-024c",
	"PIA-025",
	"PIA-026",
	"PIA-027",
	"PIA-028",
	"PIA-029",
	"PIA-030",
	"PIA-031",
	"PIA-032",
	"PIA-033",
	"PIA-034",
	"PIA-035",
	"PIA-036",
	"PIA-037",
	"PIA-038",
	"PIA-039",
	"PIA-040",
	"PIA-040a",
	"PIA-041",
	"PIA-041a",
	"PIA-042",
	"PIA-042a",
	"PIA-043",
	"PIA-043a",
	"PIARev-001",
	"PIARev-002",
	"PIARev-003",
	"PIARev-004",
	"PIARev-005",
	"PIARev-006",
	"PIARev-007",
	"PIARev-008",
	"PIARev-009",
	"PIARev-010",
	"PIARev-011",
	"PIARev-012",
	"Privacy Threshold Analysis (PTA)",
	"Private Sector Explanation",
	"Recent Date of Return to CMS by Department",
	"Recent Date of Submittal by CMS",
	"Record Status",
	"Require HHS PIA Status Field Trigger",
	"Review Date",
	"Session Cookies - Collects PII?",
	"State or Local Agency/Agencies Explanation",
	"Submission Status",
	"Submit Date",
	"Users Explanation",
	"Web Beacons - Collects PII?",
	"Web Bugs - Collects PII?",
	"Within HHS Explanation"
) COMMENT='Current Privacy Impact Assessment(PIA) gather from core.PIAhist table for CEDE '
 as
SELECT 
csnap.REPORT_DATE as ReportDate 
,CFACTS_System.Authorization_Package  as "Authorization_Package"
,CFACTS_PIA.PIA_Tracking_ID  as "Tracking ID"
,NULL as "Administrators Explanation"
,NULL as "ATO Expiration Date"
,NULL as "Authorization_Package: ISSO - ISSOCS"
,CFACTS_PIA.Final_Approver  as "CMS Final Approver"
,CFACTS_PIA.Final_Approver_Date  as "CMS Final Approver Date"
,CFACTS_PIA.Final_Approver_Status  as "CMS Final Approver Review Status"
,NULL as "CMS SOP"
,NULL as "Component"
,NULL as "Contractors Explanation"
,CFACTS_PIA.Review_Status  as "CRA Review Status"
,CFACTS_PIA.Reviewer  as "CRA Reviewer"
,NULL as "Created By"
,NULL as "Default Record Permissions"
,NULL as "Developers Explanation"
,NULL as "Does the PIA have an Expiration Date?"
,NULL as "Form Date"
,NULL as "Helper PIA-014"
,NULL as "Helper XLC Phase = Disposition for Notifications"
,CFACTS_PIA.HHS_PIA_Review_Date  as "HHS PIA Review Date"
,CFACTS_PIA.HHS_PIA_Status  as "HHS PIA Review Status"
,NULL as "HHS PIA Reviewer"
,NULL as "HHS PIA Tracker Comments"
,NULL as "Inherited Record Permissions"
,NULL as "Is this a PIA Renewal?"
,NULL as "ISSO Submitter"
,NULL as "Last Updated"
,NULL as "Original - PIA-014"
,NULL as "Other - Collects PII?"
,NULL as "Other Federal Agency/Agencies Explanation"
,NULL as "Others Explanation"
,CFACTS_PIA.Overall_Status  as "Overall_Status"
,NULL as "Persistent Cookies - Collects PII?"
,NULL as "PIA Expiration Date"
,NULL as "PIA-001"
,NULL as "PIA-002"
,NULL as "PIA-002a"
,NULL as "PIA-003"
,NULL as "PIA-003a"
,NULL as "PIA-003b"
,NULL as "PIA-004"
,NULL as "PIA-005"
,NULL as "PIA-006a"
,NULL as "PIA-006b"
,NULL as "PIA-006c"
,NULL as "PIA-006d"
,NULL as "PIA-006e"
,NULL as "PIA-007"
,NULL as "PIA-008"
,NULL as "PIA-008a"
,NULL as "PIA-008b"
,NULL as "PIA-009"
,NULL as "PIA-010"
,NULL as "PIA-011"
,NULL as "PIA-012"
,NULL as "PIA-013"
,NULL as "PIA-014"
,NULL as "PIA-015"
,NULL as "PIA-016"
,NULL as "PIA-017"
,NULL as "PIA-018"
,NULL as "PIA-019"
,NULL as "PIA-020"
,NULL as "PIA-020a"
,NULL as "PIA-021"
,NULL as "PIA-022"
,NULL as "PIA-022a"
,NULL as "PIA-022ai"
,NULL as "PIA-023"
,NULL as "PIA-023a"
,NULL as "PIA-023ii"
,NULL as "PIA-023iii"
,NULL as "PIA-024"
,NULL as "PIA-024a"
,NULL as "PIA-024b"
,NULL as "PIA-024c"
,NULL as "PIA-025"
,NULL as "PIA-026"
,NULL as "PIA-027"
,NULL as "PIA-028"
,NULL as "PIA-029"
,NULL as "PIA-030"
,NULL as "PIA-031"
,NULL as "PIA-032"
,NULL as "PIA-033"
,NULL as "PIA-034"
,NULL as "PIA-035"
,NULL as "PIA-036"
,NULL as "PIA-037"
,NULL as "PIA-038"
,NULL as "PIA-039"
,NULL as "PIA-040"
,NULL as "PIA-040a"
,NULL as "PIA-041"
,NULL as "PIA-041a"
,NULL as "PIA-042"
,NULL as "PIA-042a"
,NULL as "PIA-043"
,NULL as "PIA-043a"
,NULL as "PIARev-001"
,NULL as "PIARev-002"
,NULL as "PIARev-003"
,NULL as "PIARev-004"
,NULL as "PIARev-005"
,NULL as "PIARev-006"
,NULL as "PIARev-007"
,NULL as "PIARev-008"
,NULL as "PIARev-009"
,NULL as "PIARev-010"
,NULL as "PIARev-011"
,NULL as "PIARev-012"
,NULL as "Privacy Threshold Analysis (PTA)"
,NULL as "Private Sector Explanation"
,NULL as "Recent Date of Return to CMS by Department"
,NULL as "Recent Date of Submittal by CMS"
,NULL as "Record Status"
,NULL as "Require HHS PIA Status Field Trigger"
,NULL as "Review Date"
,NULL as "Session Cookies - Collects PII?"
,NULL as "State or Local Agency/Agencies Explanation"
,CFACTS_PIA.Submission_Status  as "Submission Status"
,CFACTS_PIA.Submission_Date  as "Submit Date"
,NULL as "Users Explanation"
,NULL as "Web Beacons - Collects PII?"
,NULL as "Web Bugs - Collects PII?"
,NULL as "Within HHS Explanation"
from table(CORE.FN_CRM_GET_REPORT_ID(0)) csnap
JOIN CORE.SystemsHist CFACTS_System on CFACTS_System.REPORT_ID = csnap.REPORT_ID
JOIN PIAHist CFACTS_PIA on CFACTS_PIA.REPORT_ID = csnap.REPORT_ID and CFACTS_PIA.SYSTEM_ID = CFACTS_System.SYSTEM_ID
;
create or replace view VW_CFACTS_ALLOCATEDCONTROL(
	ALLOCATION_STATUS,
	CONTROL_ELEMENT,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_FAMILY,
	CONTROL_NAME,
	CONTROL_NUMBER,
	CONTROL_NUMBER_COMBO,
	CONTROL_SET_VERSION_NUMBER,
	HYBRID_CONTROL,
	INHERITABLE_BY_OTHER_SYSTEMS,
	LAST_ACT_DATE,
	LAST_ASSESSMENT_DATE,
	LAST_PENTEST_DATE,
	LAST_SCA_DATE,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	RESPONSIBILITY,
	SHARED_IMP_UPDATED_DATE,
	SIGNIFICANT_CONTROL_CHANGE,
	SIGNIFICANT_CONTROL_CHANGE_DETAILS,
	SYSTEM_ID,
	TRACKING_ID
) COMMENT='CFACTS Parent level view of controls allocated to a system. Child views are joined to form a coherent record'
 as 
SELECT
APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATION_STATUS.Value as Allocation_Status
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS.Control_Element
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS.Control_Element_Number
,APP_CFACTS.SHARED.SEC_VW_enum_Control_Family.Value as Control_Family
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Control_Name as Control_Name
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Control_Number as Control_Number
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Control_Number_Combo as Control_Number_Combo
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Helper_Control_Set_Version_Number_2 as Control_Set_Version_Number
,APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATED__HYBRID_YES.value as hybrid_control
,APP_CFACTS.SHARED.SEC_VW_ENUM_INHERITABLE2.Value as Inheritable_by_other_systems
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_ACT_Date, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_ACT_Date, ' ', 2))) as Last_ACT_Date
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Inherited_Last_Assessment_Date, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Inherited_Last_Assessment_Date, ' ', 2))) as Last_Assessment_Date
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_Pentest_Date, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_Pentest_Date, ' ', 2))) as Last_Pentest_Date
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_SCA_Date, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Last_SCA_Date, ' ', 2))) as Last_SCA_Date
,APP_CFACTS.SHARED.SEC_VW_enum_Overall_Control_Status.Value as Overall_Control_Status
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information.Last_Updated_Date, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information.Last_Updated_Date, ' ', 2))) as Private_Imp_Updated_Date
,APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information.PRIVATE_IMPLEMENTATION_DETAILS -- 230622
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS.Responsibility
,timestamp_ntz_from_parts(to_date(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Shared_Implementation_Details_Updated_, ' ', 1)), 
to_time(SPLIT_PART(APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Shared_Implementation_Details_Updated_, ' ', 2))) as Shared_Imp_Updated_Date
,APP_CFACTS.SHARED.SEC_VW_enum_GVL_Yes__No__Default_No.Value as Significant_Control_Change
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Significant_Control_Change_Details
,CORE.SYSTEMS.SYSTEM_ID as SYSTEM_ID
,APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.Tracking_ID as Tracking_ID
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE
JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_ALLOCATED_CONTROLS ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_ALLOCATED_CONTROLS.Authorization_Package_Allocated_Controls_ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS on APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId = APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_ALLOCATED_CONTROLS.Allocated_Controls_Authorization_Package_ContentId

JOIN CORE.SYSTEMS on CORE.SYSTEMS.SYSTEM_ID=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.FISMA_ID
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELE_X_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELEMENTS on APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELE_X_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELEMENTS.Allocated_Controls_Allocated_Control_Elements_ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS on APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS.ContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_ELEMENTS_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELE_X_ALLOCATED_CONTROLS_ALLOCATED_CONTROL_ELEMENTS.Allocated_Controls_Elements_Allocated_Controls_Allocated_Control_Ele_ContentId

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATION_STATUS ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATION_STATUS.ParentContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATION_STATUS ON APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATION_STATUS.Id=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATION_STATUS.Value

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_INHERITABLE ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_INHERITABLE.ParentContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_INHERITABLE2 ON APP_CFACTS.SHARED.SEC_VW_ENUM_INHERITABLE2.Id=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_INHERITABLE.Value

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_CONTROL_FAMILY ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_CONTROL_FAMILY.ParentContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Control_Family ON APP_CFACTS.SHARED.SEC_VW_enum_Control_Family.Id=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_CONTROL_FAMILY.Value

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATED__HYBRID_YES ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATED__HYBRID_YES.ParentContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATED__HYBRID_YES ON APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATED__HYBRID_YES.Id=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_ALLOCATED__HYBRID_YES.Value

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_OVERALL_CONTROL_STATUS ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_OVERALL_CONTROL_STATUS.ParentContentId=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Overall_Control_Status ON APP_CFACTS.SHARED.SEC_VW_enum_Overall_Control_Status.ID=APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS_OVERALL_CONTROL_STATUS.Value

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information_Allocated_Controls_Private_x_Allocated_Controls_Private_Implementation_Details_CR ON APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId= APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information_Allocated_Controls_Private_x_Allocated_Controls_Private_Implementation_Details_CR.Allocated_Controls_Private_Implementation_Details_CR_ContentId 
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information ON  APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information_Allocated_Controls_Private_x_Allocated_Controls_Private_Implementation_Details_CR.Private_Allocated_Control_Information_Allocated_Controls_Private_Implementatio_ContentId = APP_CFACTS.SHARED.SEC_VW_Private_Allocated_Control_Information.ContentId

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Significant_Control_Change on APP_CFACTS.SHARED.SEC_VW_ALLOCATED_CONTROLS_CONTROL_STANDARDS.ContentId=APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Significant_Control_Change.ParentContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_GVL_Yes__No__Default_No on APP_CFACTS.SHARED.SEC_VW_enum_GVL_Yes__No__Default_No.id=APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Significant_Control_Change.Value
;
create or replace view VW_CFACTS_CAAT(
	ACT_CAAT_FILEPROCESSEDDATE,
	ASSESSMENTAUDIT_COMPANY,
	CAAT_ID,
	DATE_IDENTIFIED,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FINDING_TITLE,
	RELATED_POAMS,
	SOURCE_AUDIT_TYPE_2,
	SYSTEM_ID,
	TEST_METHOD,
	TEST_OBJECTIVE,
	TEST_RESULT,
	WEAKNESS_DESCRIPTION
) COMMENT='CFACTS Parent level view of CMS Assessment and Audit Tracking for a system. Child views are joined to form a coherent record'
 as
(
WITH
cattm_1 as (SELECT APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Method.ParentContentId as ParentContentId, listagg(APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location.Value,';') AS text
	FROM APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Method
	LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location on APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location.Id = APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Method.Value
	Group by APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Method.ParentContentId
)  
SELECT DISTINCT 
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking.Created_Date) as ACT_CAAT_FileProcessedDate -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.AssessmentAudit_Company
,'CAAT-' || cast(APP_CFACTS.SHARED.SEC_VW_POAMs.CAAT_ID as varchar) as CAAT_ID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking.Date_Identified) as Date_Identified -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.Finding_Description
,APP_CFACTS.SHARED.SEC_VW_POAMs.Finding_ID
,APP_CFACTS.SHARED.SEC_VW_POAMs.Finding_Title_
,'POA&M-' || cast(APP_CFACTS.SHARED.SEC_VW_POAMs.POAM_ID as varchar) as Related_POAMs
,APP_CFACTS.SHARED.SEC_VW_POAMs.Source_Audit_Type_2
,CORE.SYSTEMS.SYSTEM_ID as SYSTEM_ID
,cattm_1.text as Test_Method
,APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking.Test_Objective
,APP_CFACTS.SHARED.SEC_VW_enum_Assessment_Status.Value as Test_Result
,APP_CFACTS.SHARED.SEC_VW_POAMs.Weakness_Description
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package
JOIN CORE.SYSTEMS on CORE.SYSTEMS.SYSTEM_ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.IDUID
JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_Related_POAMs_x_Authorization_Package_Related_POAMs on APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_Related_POAMs_x_Authorization_Package_Related_POAMs.Authorization_Package_Related_POAMs_ContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_POAMs ON APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId = APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_Related_POAMs_x_Authorization_Package_Related_POAMs.POAMs_Authorization_Package_Related_POAMs_ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking on APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking.ContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.CAAT_ID
JOIN APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Results on APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Results.ParentContentId = APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking.ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_enum_Assessment_Status on APP_CFACTS.SHARED.SEC_VW_enum_Assessment_Status.Id = APP_CFACTS.SHARED.SEC_VW_CMS_Audit_Tracking_Test_Results.Value
-- RESEARCH           
LEFT OUTER JOIN cattm_1 on cattm_1.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
)
;
create or replace view VW_CFACTS_KEV(
	CVE,
	DW_VUL_ID,
	PRIMARY_FISMA_ID,
	FIRSTSEEN,
	SIGNATURE,
	SOLUTION,
	DESCRIPTION,
	FISMASEVERITY,
	BODDUEDATE
) COMMENT='No Row'
 as
SELECT bod.CVE as "CVE"
,vm.DW_VUL_ID as dw_vul_id  -- changed vm.ID to vm.DW_VUL_ID
,s.SYSTEM_ID as primary_fisma_id 
,vm.firstSeen
,plugs.signature
,plugs.solution
,plugs.Description
,vm.FISMAseverity
,bod.BODDueDate 
FROM CORE.KEV_CATALOG bod
join CORE.VW_VulMaster vm on vm.cve = bod.CVE
JOIN CORE.VW_Assets a on vm.DW_ASSET_ID = a.DW_ASSET_ID	
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID 
JOIN (select DW_VUL_ID,max(ID) as plugin_ID -- Desc for plugins change over time and create new master records
	FROM CORE.VulPlugin
	group by DW_VUL_ID) vsp  on vsp.DW_VUL_ID = vm.DW_VUL_ID  -- changed vsp.ID to vsp.DW_VUL_ID
JOIN CORE.Plugins plugs on plugs.DW_PLUGIN_ID = vsp.plugin_ID
WHERE  vm.MitigationStatus <> 'fixed' 
and bod.Is_Deleted = 0;
create or replace view VW_CFACTS_MILESTONE(
	ACTUAL_COMP_DATE,
	CHANGES2MS,
	EST_COMP_DATE,
	LAST_UPDATED,
	MS_DESC,
	MS_ID,
	MS_NAME,
	MS_STATUS,
	POAM_ID,
	SCHED_COMP_DATE,
	SYSTEM_ID
) COMMENT='CFACTS Parent level view of POAM Milestones for a system. Child views are joined to form a coherent record'
 as 
(SELECT
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Milestone.Actual_Completion_Date) as Actual_Comp_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_Milestone.Changes_To_Milestone as Changes2MS
--,CMS_ISCM_DW.dbo.StripHTML(APP_CFACTS.SHARED.SEC_VW_Milestone.Changes_To_Milestone) as Changes2MS
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Milestone.Estimated_Completion_Date) as Est_Comp_Date -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Milestone.Last_Updated_Date) as Last_Updated -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_Milestone.Milestone_Description as MS_Desc
--,CMS_ISCM_DW.dbo.StripHTML(APP_CFACTS.SHARED.SEC_VW_Milestone.Milestone_Description) as MS_Desc
,APP_CFACTS.SHARED.SEC_VW_Milestone.Tracking_ID as MS_ID
,RTRIM(LTRIM(Replace(Replace(Replace(APP_CFACTS.SHARED.SEC_VW_Milestone.Milestone_Name,char(9),char(32)),'  ',' '),'"',''''))) as MS_Name
,APP_CFACTS.SHARED.SEC_VW_enum_Milestone_Status_1.Value as MS_Status
,'POA&M-'||APP_CFACTS.SHARED.SEC_VW_POAMs.POAM_ID as POAM_ID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Milestone.Scheduled_Completion_Date) as Sched_Comp_Date -- 230801 function was in PUBLIC schema
,s.System_ID as System_ID
from APP_CFACTS.SHARED.SEC_VW_POAMs 
inner join APP_CFACTS.SHARED.SEC_VW_Milestone_POAMs_Milestone_x_POAMs_Milestone  on APP_CFACTS.SHARED.SEC_VW_Milestone_POAMs_Milestone_x_POAMs_Milestone.POAMs_Milestone_ContentId=APP_CFACTS.SHARED.SEC_VW_POAMs.contentid
inner join APP_CFACTS.SHARED.SEC_VW_Milestone on APP_CFACTS.SHARED.SEC_VW_Milestone.ContentId=APP_CFACTS.SHARED.SEC_VW_Milestone_POAMs_Milestone_x_POAMs_Milestone.Milestone_POAMs_Milestone_ContentId

inner join APP_CFACTS.SHARED.SEC_VW_Milestone_Milestone_Status on APP_CFACTS.SHARED.SEC_VW_Milestone_Milestone_Status.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Milestone.ContentId
inner join APP_CFACTS.SHARED.SEC_VW_enum_Milestone_Status_1 on APP_CFACTS.SHARED.SEC_VW_enum_Milestone_Status_1.Id=APP_CFACTS.SHARED.SEC_VW_Milestone_Milestone_Status.Value

inner JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status on APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
inner JOIN APP_CFACTS.SHARED.SEC_VW_enum_Status_9 on APP_CFACTS.SHARED.SEC_VW_enum_Status_9.Id =  APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status.Value

left join CORE.SYSTEMS s on s.SYSTEM_ID=APP_CFACTS.SHARED.SEC_VW_POAMs.FISMA_ID
where APP_CFACTS.SHARED.SEC_VW_enum_Status_9.Value in ('Delayed','Ongoing','Draft'))
;
create or replace view VW_CFACTS_PIA(
	DUE_DATE,
	FINAL_APPROVER,
	FINAL_APPROVER_DATE,
	FINAL_APPROVER_STATUS,
	HHS_PIA_REVIEW_DATE,
	HHS_PIA_STATUS,
	OVERALL_STATUS,
	PIA_TRACKING_ID,
	REVIEW_DATE,
	REVIEW_STATUS,
	REVIEWER,
	SUBMISSION_DATE,
	SUBMISSION_STATUS,
	SUBMITTER,
	SYSTEM_ID
) COMMENT='Detail  PIA ( Assessment and Audit Tracking) from CFACTS.'
 as
(
WITH
subitter_1 as
	(select ParentContentId as ParentContentId, listagg(substring(DisplayName,charindex(',',DisplayName)+2,len(DisplayName))||' '||substring(DisplayName,1,charindex(',',DisplayName)-1),';') as DisplayName
from APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Submitter 
	group by ParentContentId) ,
revr_1 as
	(select ParentContentId as ParentContentId, listagg(substring(DisplayName,charindex(',',DisplayName)+2,len(DisplayName))||' '||substring(DisplayName,1,charindex(',',DisplayName)-1),';') as DisplayName
	from APP_CFACTS.SHARED.SEC_VW_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_REVIEWER 
	group by ParentContentId
) 
SELECT
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.Due_Date) as Due_Date -- 230801 function was in PUBLIC schema
-- Research why FinalApprover is always null
,substring(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.DisplayName,charindex(',',APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.DisplayName)+2,len(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.DisplayName)) || ' ' || substring(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.DisplayName,1,charindex(',',APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.DisplayName)-1) as Final_Approver
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.Final_Approver_Date) as Final_Approver_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Final_Approver_Status.Value as Final_Approver_Status
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.HHS_PIA_Status_Date_) as HHS_PIA_Review_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_HSDW_.Value as HHS_PIA_Status
,APP_CFACTS.SHARED.SEC_VW_enum_Overall_Status.Value as Overall_Status
,APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId as PIA_Tracking_ID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.Review_Date) as Review_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Review_Status_1.Value as Review_Status
,revr_1.DisplayName as Reviewer
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.Submit_Date) as Submission_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status.Value as Submission_Status
,subitter_1.DisplayName as submitter
,CORE.SYSTEMS.System_ID as SYSTEM_ID
from APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE
inner join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Privacy_Impact_Assessment_PIA_NEW_Author_x_Privacy_Impact_Assessment_PIA_NEW_Authorization_Package
    on APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId=APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Privacy_Impact_Assessment_PIA_NEW_Author_x_Privacy_Impact_Assessment_PIA_NEW_Authorization_Package.Authorization_Package_Privacy_Impact_Assessment_PIA_NEW_Author_ContentId
inner join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW 
    on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId=APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Privacy_Impact_Assessment_PIA_NEW_Author_x_Privacy_Impact_Assessment_PIA_NEW_Authorization_Package.Privacy_Impact_Assessment_PIA_NEW_Authorization_Package_ContentId

left join CORE.SYSTEMS on CORE.SYSTEMS.SYSTEM_ID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID

left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New  on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver__New.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId
left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver_Status  on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver_Status.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId
left join APP_CFACTS.SHARED.SEC_VW_enum_Final_Approver_Status  on APP_CFACTS.SHARED.SEC_VW_enum_Final_Approver_Status.ID=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Final_Approver_Status.value

left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_HSDW_  on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_HSDW_.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId
left join APP_CFACTS.SHARED.SEC_VW_enum_HSDW_  on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_HSDW_.Value=APP_CFACTS.SHARED.SEC_VW_enum_HSDW_.Id

left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Overall_Status  on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Overall_Status.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId
left join APP_CFACTS.SHARED.SEC_VW_enum_Overall_Status on APP_CFACTS.SHARED.SEC_VW_enum_Overall_Status.Id=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Overall_Status.Value

left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Review_Status_1 on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Review_Status_1.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId
left join APP_CFACTS.SHARED.SEC_VW_enum_Review_Status_1 on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Review_Status_1.Value=APP_CFACTS.SHARED.SEC_VW_enum_Review_Status_1.Id

left join APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Submission_Status on APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Submission_Status.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId 
left join APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status on APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status.Id= APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW_Submission_Status.Value
left join subitter_1 on subitter_1.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId -- RESEARCH, WAS INNER JOIN
left join revr_1 on revr_1.ParentContentId=APP_CFACTS.SHARED.SEC_VW_Privacy_Impact_Assessment_PIA_NEW.ContentId) -- RESEARCH, WAS INNER JOIN
;
create or replace view VW_CFACTS_POAM(
	ACTUAL_COMPLETION_DATE,
	ACTUAL_LABOR_COST,
	CAAT,
	CAAT_ID,
	DAYS_OPEN,
	ESTIMATED_COMPLETION_DATE,
	FINDING_ID,
	FUNDING_SOURCE,
	LABOR_ESTIMATE,
	OVERALL_STATUS,
	POAM_CLOSED_DATE,
	POAM_ID,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_COMMENTS,
	REVIEW_DATE,
	REVIEW_STATUS,
	SCHEDULED_COMPLETION_DATE,
	SOURCE_AUDIT_TYPE_2,
	SUBMISSION_STATUS,
	SYSTEM_ID,
	TARGET,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_ID,
	WEAKNESS_POC,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY
) COMMENT='CFACTS Parent level view of POAMs for a system. Child views are joined to form a coherent record'
 as
(
with 
poamOwner_1 as
	(select ParentContentId as ParentContentId, listagg(DisplayName, ';') as displayname
	from APP_CFACTS.SHARED.SEC_VW_POAMs_POAM_Owner_1 
	group by ParentContentId),
poamReviewer_1 as
	(select ParentContentId as ParentContentId, listagg(DisplayName,';') as DisplayName
	FROM APP_CFACTS.SHARED.SEC_VW_POAMs_POAM_Reviewer 
	Group by ParentContentId),
weaknessPOC_1 as
	(select ParentContentId as ParentContentId, listagg(DisplayName,';') as DisplayName
	FROM APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_POC_Role 
	group by ParentContentId
)
SELECT
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.Actual_Completion_Date) as Actual_Completion_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.Actual_Labor_Cost
,'CAAT-' || cast(APP_CFACTS.SHARED.SEC_VW_POAMs.CAAT_ID as varchar) CAAT   -- DONT NEED THIS
,APP_CFACTS.SHARED.SEC_VW_POAMs.CAAT_ID
,APP_CFACTS.SHARED.SEC_VW_POAMs.Days_Open
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.Scheduled_Completion_Date) as Estimated_Completion_Date -- Reversed in CFACTS_DPS; -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.FINDING_ID
,APP_CFACTS.SHARED.SEC_VW_enum_Funding_Source.Value Funding_Source
,APP_CFACTS.SHARED.SEC_VW_POAMs.Labor_Estimate
,APP_CFACTS.SHARED.SEC_VW_enum_Status_9.value Overall_Status
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.POAM_Closed_Date) as POAM_Closed_Date -- 230801 function was in PUBLIC schema
,'POA&M-' || cast(APP_CFACTS.SHARED.SEC_VW_POAMs.POAM_ID as varchar) as POAM_ID
,poamOwner_1.displayname as POAM_Owner
,poamReviewer_1.DisplayName as POAM_Reviewer
,APP_CFACTS.SHARED.SEC_VW_POAMs.Review_Comments Review_Comments
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.Review_Date) as Review_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Risk_Review_Status.Value Review_Status
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.Estimated_Completion_Date) as Scheduled_Completion_Date -- Reversed in CFACTS_DPS; -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.SOURCE_AUDIT_TYPE_2
,APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status.Value Submission_Status
,CORE.SYSTEMS.SYSTEM_ID as SYSTEM_ID
,'Allocated Control: ' || APP_CFACTS.SHARED.SEC_VW_POAMs.Control_Number_1 Target
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_POAMs.First_Published_Date) as Weakness_Creation_Date -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_POAMs.Weakness_ID_Number Weakness_ID
,weaknessPOC_1.DisplayName as Weakness_POC
,APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1.Value Weakness_Risk_Level
,APP_CFACTS.SHARED.SEC_VW_enum_Weakness_Severity.Value Weakness_Severity
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE 
LEFT OUTER JOIN CORE.SYSTEMS on CORE.SYSTEMS.SYSTEM_ID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID
INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs ON APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId=APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs.Authorization_Package_POAMs_ContentId
INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs ON APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId=APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs.POAMs_Authorization_Package_ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1 on APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1 on APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1.ID = APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1.Value
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status ON APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status.ParentContentId=APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Status_9  ON APP_CFACTS.SHARED.SEC_VW_enum_Status_9.Id=APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Review_Status on APP_CFACTS.SHARED.SEC_VW_POAMs_Review_Status.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Review_Status  on APP_CFACTS.SHARED.SEC_VW_enum_Risk_Review_Status.Id=APP_CFACTS.SHARED.SEC_VW_POAMs_Review_Status.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Submission_Status on APP_CFACTS.SHARED.SEC_VW_POAMs_Submission_Status.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status  on APP_CFACTS.SHARED.SEC_VW_enum_Risk_Submission_Status.Id = APP_CFACTS.SHARED.SEC_VW_POAMs_Submission_Status.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Severity on APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Severity.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Weakness_Severity  on APP_CFACTS.SHARED.SEC_VW_enum_Weakness_Severity.Id = APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Severity.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Funding_Source  on APP_CFACTS.SHARED.SEC_VW_POAMs_Funding_Source.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Funding_Source  on APP_CFACTS.SHARED.SEC_VW_enum_Funding_Source.Id = APP_CFACTS.SHARED.SEC_VW_POAMs_Funding_Source.Value
LEFT join poamOwner_1 on poamOwner_1.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId 
LEFT join poamReviewer_1 on poamReviewer_1.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId 
LEFT join weaknessPOC_1  on weaknessPOC_1.ParentContentId = APP_CFACTS.SHARED.SEC_VW_POAMs.ContentId
);
create or replace view VW_CFACTS_SYSTEMS(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	IS_OA_READY,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE
) COMMENT='Systems detail directly from CFACTS.'
 as
WITH aControlOwner as (
SELECT ParentContentId, listagg(DisplayName,',')  as text
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Control_Owner_CO
Group by ParentContentId
),
CloudServiceProviders as (
SELECT APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cloud_Service_Provider_1.ParentContentId, 
TRIM(listagg(APP_CFACTS.SHARED.SEC_VW_enum_Cloud_Service_Provider_1.Value, ';')) AS text -- 231012 added TRIM
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cloud_Service_Provider_1 
JOIN APP_CFACTS.SHARED.SEC_VW_enum_Cloud_Service_Provider_1  on APP_CFACTS.SHARED.SEC_VW_enum_Cloud_Service_Provider_1.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cloud_Service_Provider_1.Value
Group by APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cloud_Service_Provider_1.ParentContentId
),
e_csp as (
SELECT distinct APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, CloudServiceProviders.text as CloudServiceProviders
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join CloudServiceProviders on (CloudServiceProviders.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId)
),
CRROs as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text -- 231012 added ;
FROM (SELECT ParentContentId, DisplayName 
    FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Component_Risk_Reports_Oversight
    order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
), 
ap_crro as (
SELECT distinct APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, CRROs.text as CRROs
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package  join CRROs on (CRROs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId)
),
CRAs as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text -- 231012 added ;
FROM (SELECT ParentContentId, DisplayName 
    FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_DSPC_POC
    order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
),
ap_cras as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, CRAs.text as CRAs
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join CRAs on CRAs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
CyberVets as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text
FROM (SELECT ParentContentId, DisplayName 
        FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cyber_Risk_Advisor_CRA
        order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
),
ap_cybervet as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, CyberVets.text as CyberVets
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join CyberVets on CyberVets.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
ISSOs as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text
FROM (SELECT ParentContentId, DisplayName 
        FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Security_Officer_ISSO
        order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
),
ap_isso as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, ISSOs.text as ISSOs
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join ISSOs on ISSOs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
ISSOCS as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text
FROM (SELECT ParentContentId, DisplayName 
        FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_ISSO_Contractor_Support_ISSOCS
        order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
),
ap_issocs as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, ISSOCS.text as ISSOCS
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package  join ISSOCS on issocs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
MEFs as (
SELECT APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Mission_Essential_Functions_.ParentContentId, listagg(APP_CFACTS.SHARED.SEC_VW_enum_Mission_Essential_Functions_.Value,',') AS text
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Mission_Essential_Functions_ 
JOIN APP_CFACTS.SHARED.SEC_VW_enum_Mission_Essential_Functions_  on APP_CFACTS.SHARED.SEC_VW_enum_Mission_Essential_Functions_.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Mission_Essential_Functions_.Value
group by APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Mission_Essential_Functions_.ParentContentId
),
e_mefs as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, MEFs.text as MEFs
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join MEFs on MEFs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
pol as (
select APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operating_Location.ParentContentId, listagg(APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location.Value,',') as Value
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operating_Location  
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location on (APP_CFACTS.SHARED.SEC_VW_enum_Operating_Location.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operating_Location.Value)
group by APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operating_Location.ParentContentId
),
SCAs as (
select r.ParentContentId, listagg(r.DisplayName,';') AS text
FROM (SELECT ParentContentId, DisplayName 
        FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Security_Control_Assessor_SCA
        order by ParentContentId, lower(DisplayName)) r -- 231012 added sort
group by r.ParentContentId
),
ap_sca as (
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId, SCAs.text as SCAs
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package join SCAs on  SCAs.ParentContentId = APP_CFACTS.SHARED.SEC_VW_Authorization_Package.ContentId
),
aISA as (
select ParentContentId, listagg(DisplayName, ',') as DispLayName
from APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Administrator_ISA
group by ParentContentId
),
isso_count as (
SELECT ParentContentId,count(1) as ISSO_Count
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Security_Officer_ISSO			
GROUP BY ParentContentId
)
SELECT
APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Acronym as ACRONYM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ACTUAL_DECOMMISION_DATE) as ACTUAL_DECOMMISION_DATE -- 231218
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Tracking_ID as ARCHER_TRACKING_ID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.ATO_EXPIRATION_DATE) as ATO_EXPIRATION_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.COPY_OF_BO_REQUEST_REVIEW_DATE_1) as ATO_REVIEW_DATE -- 230801 function was in PUBLIC schema
,CORE.FN_CRM_CLEANSTRING(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Authorization_Comments) as AUTH_COMMENTS -- 231013 add FN_CRM_CLEANSTRING
,APP_CFACTS.SHARED.SEC_VW_enum_Authorization_Decision.Value as AUTH_DECISION
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.CIO_SUBMITTED_DATE) as AUTHORIZATION_MEMO_SIGNED_DATE -- 230801 function was in PUBLIC schema
,RTRIM(CORE.FN_CRM_CLEANSTRING(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Authorization_Package_Name)) as AUTHORIZATION_PACKAGE_NAME -- 231013 add FN_CRM_CLEANSTRING
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.COPY_OF_BO_REQUEST_REVIEW__DUE_DATE) as BO_RECOMMENDATION_REVIEW_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.BO_SUBMITTED_DATE) as BO_REVIEW_DATE -- 230801 function was in PUBLIC schema
,aControlOwner.text as BUSINESS_OWNER
,APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Chief_Information_Officer_Inherited.DisplayName as CIO
,APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Chief_Information_Security_Officer_CISO.DisplayName as CISO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.CISO_SUBMITTED_DATE) as CISO_REVIEW_DATE -- 230801 function was in PUBLIC schema
,e_csp.CloudServiceProviders as CLOUD_SERVICE_PROVIDER
,tdcg.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,CORE.FN_CRM_CLEANSTRING(tdcg.COMPONENT_DESCRIPTION) as COMPONENT_DESCRIPTION -- 231013 add FN_CRM_CLEANSTRING
,tdcg.COMPONENT_NAME as COMPONENT_NAME
,ap_crro.CRROs as COMPONENT_RISK_REPORTS_OVERSIGHT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Last_Contingency_Plan_Expiration_Date) as CONTINGENCYEXPIRATIONDATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Control_Set_Version_Number_System_Provid as CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Contingency_Plan_Status_Date) as CP_TEST_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Contingency_Plan_Test_Results.Value as CP_TEST_RESULTS
,ap_cras.CRAs as CRA
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.CRA_SUBMITTED_DATE) as CRA_REVIEW_DATE -- 230801 function was in PUBLIC schema
,ap_cybervet.CyberVets as CYBERVET 
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ATO_IATO_Expiration_Date) as DATE_AUTH_MEMO_EXPIRES -- 230801 function was in PUBLIC schema 
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ATO_IATO_Date) as DATE_AUTH_MEMO_SIGNED -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Owner_ISO.DisplayName as DCISO
,tdcg.DIVISION_ACRONYM as DIVISION_ACRONYM
,CORE.FN_CRM_CLEANSTRING(tdcg.DIVISION_DESCRIPTION) as DIVISION_DESCRIPTION -- 231013 add FN_CRM_CLEANSTRING
,TRIM(tdcg.DIVISION_NAME) as DIVISION_NAME -- 231012 added TRIM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.DSPC_SUBMITTED_DATE) as DSPC_REVIEW_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.DSPPO_SUBMITTED_DATE) as DSPPO_REVIEW_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.EAuthentication_Expiration_Date) as E_AUTH_EXP_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_EAuthentication_Level.Value as E_AUTH_LEVEL
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.EAuthentication_Date)  as E_AUTH_RISK_ASSESSMENT_DATE -- 230801 function was in PUBLIC schema      
,APP_CFACTS.SHARED.SEC_VW_enum_Financial_System.Value as FINANCIAL_SYSTEM
,ap_FIPS_avail.Value as FIPS_199_AVAILABILITY_RATING
,ap_FIPS_Confident.Value as FIPS_199_CONFIDENTIALITY_RATING
,ap_FIPS_integ.Value as FIPS_199_INTEGRITY_RATING
,ap_FIPS_Overall.Value as FIPS_199_OVERALL_IMPACT_RATING 
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.First_Published_Date)  as FIRST_PUBLISHED_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_FISMA_Reportable.Value as FISMA_SYSTEM
,tdcg.GROUP_ACRONYM as GROUP_ACRONYM
,CORE.FN_CRM_CLEANSTRING(tdcg.GROUP_DESCRIPTION) as GROUP_DESCRIPTION -- 231013 add FN_CRM_CLEANSTRING
,TRIM(tdcg.GROUP_NAME) as GROUP_NAME -- 231012 added TRIM
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.HVA_Score  as HVA_SCORE
,IFNULL(APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo.Value,'No') as HVASTATUS 
,APP_CFACTS.SHARED.SEC_VW_enum_Information_System_Type.Value as INFORMATION_SYSTEM_TYPE
,case IFNULL(APP_CFACTS.SHARED.SEC_VW_enum_Marketplace_Systems.Value,'0') When 'Yes' then '1' Else '0' End as IS_MARKETPLACE
,case IFNULL(APP_CFACTS.SHARED.SEC_VW_enum_OA_Ready.Value,'0') When 'Yes' then '1' Else '0' End as IS_OA_READY
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ISRA_Review_Date)  as ISRA_REVIEW_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_ISRA_Status.Value as ISRA_STATUS
,ap_isso.ISSOs as ISSO
,isso_count.ISSO_Count as ISSO_COUNT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.ISSO_REVIEW_DUE_DATE) as ISSO_REVIEW_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.ISSO_SUBMITTED_DATE) as ISSO_SUBMISSION_DATE -- 230801 function was in PUBLIC schema
,ap_issocs.ISSOCS as ISSOCS         
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Last_ACT_Date) as LAST_ACT_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE) as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428; -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Last_ACT_SCA_Final_Report_Date) as LAST_ACT_SCA_FINAL_REPORT_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE) as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428; -- 230801 function was in PUBLIC schema 
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Last_Pentest_Date) as LAST_PENTEST_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_Is_this_HVA_necessary_to_perform_MEF.Value as MEF
,e_mefs.MEFs as MEF_CONTEXT 
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Next_Required_Contingency_Plan_Test_Date) as NEXT_REQUIRED_CP_TEST_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_enum_OA_Status2.value as OA_STATUS
,APP_CFACTS.SHARED.SEC_VW_ENUM_OPERATED_BY.value as OPERATED_BY -- 250103 Tersa needs this for FISMA Report
,APP_CFACTS.SHARED.SEC_VW_enum_Package_Type.Value as PACKAGE_TYPE
,PIA014.PIA_014 as PIA_014
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.PIA_Expiration_Date) as PIA_EXPIRATION_DATE -- 230801 function was in PUBLIC schema
,APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Primary_Information_System_Security_Offi.DisplayName as PRIMARY_ISSO -- PRIMARY INFORMATION SYSTEM SECURITY OFFICER (ISSO)
,TRIM(pol.Value) as PRIMARY_OPERATING_LOCATION -- 231012 added TRIM
,APP_CFACTS.SHARED.SEC_VW_ENUM_REASON_FOR_ATO_REQUEST.VALUE as REASON_FOR_ATO_REQUEST
,ap_sca.SCAs as SCA
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.SCA_Date) as SCA_DATE -- 230801 function was in PUBLIC schema
,aISA.DisplayName as SDM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.SDM_REVIEW_DUE_DATE) as SOP_REVIEW_DATE -- 230801 function was in PUBLIC schema
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.STE_Date) as STE_DATE -- 230801 function was in PUBLIC schema
,CORE.FN_CRM_CLEANSTRING(APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.SystemDescription_Truncated) as SYSTEM_DESCRIPTION -- 231013 add FN_CRM_CLEANSTRING
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID as SYSTEM_ID       
,APP_CFACTS.SHARED.SEC_VW_enum_XLC_Phase.Value as TLC_PHASE
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE 
LEFT OUTER JOIN (
SELECT
APP_CFACTS.SHARED.SEC_VW_DIVISION.DIVISION_ACRONYM as DIVISION_ACRONYM
,APP_CFACTS.SHARED.SEC_VW_DIVISION.DESCRIPTION as DIVISION_DESCRIPTION
,APP_CFACTS.SHARED.SEC_VW_DIVISION.DIVISION as DIVISION_NAME
,APP_CFACTS.SHARED.SEC_VW_GROUP.GROUP_ACRONYM as GROUP_ACRONYM
,APP_CFACTS.SHARED.SEC_VW_GROUP.DESCRIPTION as GROUP_DESCRIPTION
,APP_CFACTS.SHARED.SEC_VW_GROUP.GROUP_NAME as GROUP_NAME
,APP_CFACTS.SHARED.SEC_VW_COMPONENT.COMPONENT_ACRONYM as COMPONENT_ACRONYM
,APP_CFACTS.SHARED.SEC_VW_COMPONENT.DESCRIPTION as COMPONENT_DESCRIPTION
,APP_CFACTS.SHARED.SEC_VW_COMPONENT.COMPONENT_NAME as COMPONENT_NAME
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID as SYSTEM_ID
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE  
JOIN APP_CFACTS.SHARED.SEC_VW_DIVISION_AUTHORIZATION_PACKAGES_X_AUTHORIZATION_PACKAGE_OFFICE  
on APP_CFACTS.SHARED.SEC_VW_DIVISION_AUTHORIZATION_PACKAGES_X_AUTHORIZATION_PACKAGE_OFFICE.Authorization_Package_Office_ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_DIVISION on APP_CFACTS.SHARED.SEC_VW_DIVISION.ContentId = APP_CFACTS.SHARED.SEC_VW_DIVISION_AUTHORIZATION_PACKAGES_X_AUTHORIZATION_PACKAGE_OFFICE.Division_Authorization_Packages_ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_GROUP_DIVISION_X_DIVISION_GROUP on APP_CFACTS.SHARED.SEC_VW_GROUP_DIVISION_X_DIVISION_GROUP.Division_Group_ContentId = APP_CFACTS.SHARED.SEC_VW_DIVISION.ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_GROUP on APP_CFACTS.SHARED.SEC_VW_GROUP.ContentId = APP_CFACTS.SHARED.SEC_VW_GROUP_DIVISION_X_DIVISION_GROUP.Group_Division_ContentId
JOIN APP_CFACTS.SHARED.SEC_VW_COMPONENT on APP_CFACTS.SHARED.SEC_VW_COMPONENT.Component_Acronym = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Component_Acronym
) tdcg 
on tdcg.SYSTEM_ID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_TLC_Phase 
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_TLC_Phase.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_XLC_Phase on APP_CFACTS.SHARED.SEC_VW_enum_XLC_Phase.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_TLC_Phase.Value  

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_FISMA_Reportable 
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_FISMA_Reportable.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_FISMA_Reportable 
on APP_CFACTS.SHARED.SEC_VW_enum_FISMA_Reportable.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_FISMA_Reportable.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list 
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo  
on APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_EAuthentication_Level  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_EAuthentication_Level.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_EAuthentication_Level  
on APP_CFACTS.SHARED.SEC_VW_enum_EAuthentication_Level.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_EAuthentication_Level.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Primary_Information_System_Security_Offi
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Primary_Information_System_Security_Offi.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operated_by  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operated_by.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Operated_by 
on APP_CFACTS.SHARED.SEC_VW_enum_Operated_by.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Operated_by.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_HVA_necessary_to_perform_MEF  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_HVA_necessary_to_perform_MEF.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Is_this_HVA_necessary_to_perform_MEF  
on APP_CFACTS.SHARED.SEC_VW_enum_Is_this_HVA_necessary_to_perform_MEF.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_HVA_necessary_to_perform_MEF.Value

LEFT OUTER JOIN e_mefs on e_mefs.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Authorization_Decision  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Authorization_Decision.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Authorization_Decision 
on APP_CFACTS.SHARED.SEC_VW_enum_Authorization_Decision.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Authorization_Decision.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Contingency_Plan_Test_Results  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Contingency_Plan_Test_Results.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Contingency_Plan_Test_Results  
on APP_CFACTS.SHARED.SEC_VW_enum_Contingency_Plan_Test_Results.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Contingency_Plan_Test_Results.Value

LEFT OUTER JOIN e_csp on e_csp.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN ap_crro on ap_crro.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Chief_Information_Security_Officer_CISO  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Chief_Information_Security_Officer_CISO.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Chief_Information_Officer_Inherited  
on APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_Chief_Information_Officer_Inherited.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN ap_cybervet on ap_cybervet.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Owner_ISO  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Owner_ISO.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Package_Type  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Package_Type.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Package_Type  
ON APP_CFACTS.SHARED.SEC_VW_enum_Package_Type.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Package_Type.Value

LEFT OUTER JOIN ap_sca on ap_sca.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN ap_isso on ap_isso.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN isso_count on isso_count.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN ap_issocs on ap_issocs.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Financial_System  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Financial_System.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Financial_System  
ON APP_CFACTS.SHARED.SEC_VW_enum_Financial_System.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Financial_System.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_ISRA_Status  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_ISRA_Status.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_ISRA_Status  
ON APP_CFACTS.SHARED.SEC_VW_enum_ISRA_Status.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_ISRA_Status.Value

LEFT OUTER JOIN ap_cras on ap_cras.ContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN (
select APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Confidentiality_Control_Cate.ParentContentId,APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.Value
from APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Confidentiality_Control_Cate 
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Security_Category  
on APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Confidentiality_Control_Cate.Value 
) ap_FIPS_Confident
on ap_FIPS_Confident.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN (
select APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Integirty_Control_Category.ParentContentId,APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.Value
from APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Integirty_Control_Category 
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Security_Category  
on APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Integirty_Control_Category.Value 
) ap_FIPS_integ
on ap_FIPS_integ.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN (
select APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Availability_Control_Categor.ParentContentId,APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.Value
from APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Availability_Control_Categor 
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Security_Category  
on APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Availability_Control_Categor.Value 
) ap_FIPS_avail
on ap_FIPS_avail.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN (
select APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category.ParentContentId,APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.Value
from APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category 
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Security_Category  
on APP_CFACTS.SHARED.SEC_VW_enum_Security_Category.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category.Value 
) ap_FIPS_Overall
on ap_FIPS_Overall.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Type  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Type.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Information_System_Type  
on APP_CFACTS.SHARED.SEC_VW_enum_Information_System_Type.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Information_System_Type.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Ready  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Ready.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_OA_Ready  
on APP_CFACTS.SHARED.SEC_VW_enum_OA_Ready.Id = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Ready.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Status  
on APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Status.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_OA_Status2  
ON APP_CFACTS.SHARED.SEC_VW_enum_OA_Status2.ID=APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Status.value -- 231102 0947 CFACTS used enum_OA_Status prior to 10/27

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Marketplace_Systems  
ON APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Marketplace_Systems.ParentContentId=APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Marketplace_Systems  
ON APP_CFACTS.SHARED.SEC_VW_enum_Marketplace_Systems.ID=APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Marketplace_Systems.Value

LEFT JOIN aControlOwner on ( APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId= aControlOwner.ParentContentId ) 		
LEFT JOIN pol on (pol.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId) 
LEFT JOIN aISA on (APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId = aISA.ParentContentId)

LEFT JOIN (
select AUTHORIZATION_PACKAGE_ATO_RED_FOLDER_INFORMATION_SYSTEM_OR_PAC_CONTENTID as AP_CONTENTID
,max(ATO_RED_FOLDER_INFORMATION_SYSTEM_OR_PACKAGE_CONTENTID) as FOLDER_CONTENTID
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_ATO_RED_FOLDER_INFORMATION_SYSTEM_OR_PAC_X_ATO_RED_FOLDER_INFORMATION_SYSTEM_OR_PACKAGE
GROUP BY AUTHORIZATION_PACKAGE_ATO_RED_FOLDER_INFORMATION_SYSTEM_OR_PAC_CONTENTID
) ato_x 
ON APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.CONTENTID=ato_x.AP_CONTENTID

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER ON APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.CONTENTID=ato_x.FOLDER_CONTENTID

LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER_REASON_FOR_ATO_REQUEST  
ON APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER_REASON_FOR_ATO_REQUEST.PARENTCONTENTID=APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER.CONTENTID
LEFT JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_REASON_FOR_ATO_REQUEST  
ON APP_CFACTS.SHARED.SEC_VW_ENUM_REASON_FOR_ATO_REQUEST.ID=APP_CFACTS.SHARED.SEC_VW_ATO_RED_FOLDER_REASON_FOR_ATO_REQUEST.VALUE

LEFT OUTER JOIN (
-- 230705 found more than one record in VW_AUTHORIZATION_PACKAGE_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR_X_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHORIZATION_PACKAGE but ultimately
-- VW_ENUM_HELPER_PIA014 always had one distinct PIA value per System
SELECT DISTINCT APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.contentid,APP_CFACTS.SHARED.SEC_VW_ENUM_HELPER_PIA014.VALUE as PIA_014
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE 
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR_X_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHORIZATION_PACKAGE on APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR_X_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHORIZATION_PACKAGE.AUTHORIZATION_PACKAGE_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR_CONTENTID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.CONTENTID -- 230621
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_HELPER_PIA014  
on APP_CFACTS.SHARED.SEC_VW_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_HELPER_PIA014.PARENTCONTENTID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHOR_X_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHORIZATION_PACKAGE.PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_AUTHORIZATION_PACKAGE_CONTENTID -- 230621
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_HELPER_PIA014  on APP_CFACTS.SHARED.SEC_VW_ENUM_HELPER_PIA014.ID = APP_CFACTS.SHARED.SEC_VW_PRIVACY_IMPACT_ASSESSMENT_PIA_NEW_HELPER_PIA014.VALUE
) PIA014 
on PIA014.contentid = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.contentid

WHERE APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID IS NOT NULL
;
create or replace view VW_CFACTS_SYSTEMS_INFORMATION_TYPES_TEST(
	ACRONYM,
	AP_CONTENTID,
	VALUE,
	CONTENTID,
	TRACKING_ID,
	FIRST_PUBLISHED_DATE,
	FIRST_PUBLISHED_USERNAME,
	FIRST_PUBLISHED_DISPLAYNAME,
	LAST_UPDATED_DATE,
	LAST_UPDATED_USERNAME,
	LAST_UPDATED_DISPLAYNAME,
	INFORMATION_TYPE,
	DESCRIPTION,
	RECORD_STATUS,
	CLASSIFICATION_RATING_JUST,
	NEXT_ASSESSMENT_DATE,
	UCF_RECORD_ID,
	RETENTION_EVENT,
	HELPER__PUBLIC_INFORMATION
) as
SELECT
APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Acronym as ACRONYM
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.CONTENTID as AP_CONTENTID
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.VALUE
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.*

FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE 

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE
on APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentID

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES 
ON APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.CONTENTID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.value

/*
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES
on APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.contentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.tracking_id
*/
WHERE APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID IS NOT NULL
;
create or replace view VW_CFACTS_SYSTEMS_INFORMATION_TYPES_TEST2(
	ACRONYM,
	AP_CONTENTID,
	INFORMATION_TYPE,
	FIRST_PUBLISHED_DATE,
	LAST_UPDATED_DATE,
	DESCRIPTION,
	RECORD_STATUS,
	PARENTCONTENTID,
	VALUE,
	OTHERTEXT
) as
SELECT
APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.Acronym as ACRONYM
,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.CONTENTID as AP_CONTENTID
--,APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.VALUE
--,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE.*
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.INFORMATION_TYPE
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.FIRST_PUBLISHED_DATE
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.LAST_UPDATED_DATE
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.DESCRIPTION
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.RECORD_STATUS
,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_DIGITAL_IDENTITY.*
--,APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_INTEGRITY_RATING.*

FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE 

JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE 
on APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE.AUTHORIZATION_PACKAGE_INFORMATION_TYPE_CONTENTID = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentId

--LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE
--on APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.ParentContentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.ContentID

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES 
ON APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.CONTENTID = 
APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE.INFORMATION_TYPES_AUTHORIZATION_PACKAGE_CONTENTID

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_DIGITAL_IDENTITY on APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_DIGITAL_IDENTITY.PARENTCONTENTID = APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE.INFORMATION_TYPES_AUTHORIZATION_PACKAGE_CONTENTID

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_INTEGRITY_RATING on APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_INTEGRITY_RATING.PARENTCONTENTID = APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_INFORMATION_TYPE.INFORMATION_TYPES_AUTHORIZATION_PACKAGE_CONTENTID


--APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE.value

/*
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES
on APP_CFACTS.SHARED.SEC_VW_INFORMATION_TYPES.contentId = APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.tracking_id
*/
WHERE APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE.IDUID IS NOT NULL
;
create or replace view VW_CFACTS_USERMAPPING(
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ROLE,
	SYSTEM_ID,
	USER_ID
) COMMENT='Map CFACTS users to system, component, group and role'
 as
SELECT ule.ACRONYM
,CORE.VW_SYSTEMS.Component_Acronym 
,CORE.VW_SYSTEMS.Group_Acronym 
,ule.ROLE
,CORE.VW_SYSTEMS.SYSTEM_ID
,ule.USER_ID
FROM (SELECT 
CASE APP_CFACTS.SHARED.SEC_VW_USERLIST.ACRONYM
    when 'PS&amp;R' then 'PS&R' -- 240506 CR886 EBF - workaround
    else ACRONYM
END as ACRONYM
,APP_CFACTS.SHARED.SEC_VW_USERLIST.ROLE
,APP_CFACTS.SHARED.SEC_VW_USERLIST.userid as USER_ID
FROM APP_CFACTS.SHARED.SEC_VW_USERLIST) ule
LEFT OUTER JOIN CORE.VW_SYSTEMS on upper(CORE.VW_SYSTEMS.ACRONYM) = upper(ule.ACRONYM);
create or replace view VW_CRMP_AVGDAYSDELAYEDCRITICALHIGH(
	ACRONYM,
	TOTALDELAYEDPOAMS,
	AVGDELAYCRITICAL,
	AVGDELAYHIGH
) COMMENT='Shows total critical and high POAM with delayed status used for CRMP'
 as
with CriticalPoam AS (
SELECT 
s.Acronym
,COUNT(1) TotalDelayedPOAMs
,SUM(DATEDIFF(DAY,p.Scheduled_Completion_Date,GETDATE()))/COUNT(1) AS AvgDelayInDays
FROM CORE.VW_POAMHist p 
JOIN CORE.VW_Systems s ON p.System_ID=s.System_ID
WHERE p.Overall_Status='Delayed' and p.Weakness_Risk_Level ='Critical'
and p.REPORT_ID=(SELECT REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.Acronym 
),
HighPoam AS (
SELECT 
s.Acronym
,COUNT(1) TotalDelayedPOAMs
,SUM(DATEDIFF(DAY,p.Scheduled_Completion_Date,GETDATE()))/COUNT(1) AS AvgDelayInDays
FROM CORE.VW_POAMHist p
JOIN CORE.VW_Systems s ON p.System_ID=s.System_ID
WHERE p.Overall_Status='Delayed' and p.Weakness_Risk_Level ='High'
and p.REPORT_ID=(SELECT REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.Acronym
)
SELECT coalesce(c.Acronym,h.Acronym) AS Acronym, coalesce(c.TotalDelayedPOAMs,h.TotalDelayedPOAMs) AS TotalDelayedPOAMs 
,coalesce(c.AvgDelayInDays,0) AS AvgDelayCritical,coalesce(h.AvgDelayInDays,0) AS AvgDelayHigh
 FROM CriticalPoam c full join HighPoam h ON c.Acronym=h.Acronym;
create or replace view VW_CRMP_HIGHRISKSYSTEMS_WT_UP_TO_DATE_DR_PLAN(
	COMPONENT_ACRONYM,
	HIGHRISKSYSTEMSUPTODATE,
	HIGHRISKSYSTEMS,
	PCT_HIGHRISK_UPTODATE_DR_PLAN
) COMMENT='Shows total highrisk systems and percentage of uptodate dr plan by component used for CRMP.'
 as
SELECT d.Component_Acronym
,coalesce(n.HighRiskSystemsUpToDate,0) as HighRiskSystemsUpToDate
,d.HighRiskSystems
,CAST((((coalesce(n.HighRiskSystemsUpToDate,0) * 1.0) / (d.HighRiskSystems * 1.0)) * 100.0) as decimal(5,2)) as Pct_HighRisk_UpToDate_DR_Plan
FROM (SELECT s.Component_Acronym,count(1) HighRiskSystems
	FROM CORE.VW_Systems  s
	where s.Is_OperationalSystem = 1 and s.Is_HighRiskSystem = 1
	GROUP BY s.Component_Acronym) d
LEFT OUTER JOIN (SELECT s.Component_Acronym,count(1) HighRiskSystemsUpToDate
	FROM CORE.VW_Systems  s
	where s.Is_OperationalSystem = 1 and s.Is_HighRiskSystem = 1
	and DATEDIFF(month,CURRENT_TIMESTAMP,s.ContingencyExpirationDate) > 6
	GROUP BY s.Component_Acronym) n on n.Component_Acronym = d.Component_Acronym;
create or replace view VW_CRMP_HIGHRISKSYSTEM_PENTEST(
	ACRONYM,
	WEAKNESS_RISK_LEVEL,
	TOTAL
) COMMENT='Shows total high and critical poam with audit type pentest for systems.'
 as
select s.ACRONYM, p."Weakness_Risk_Level",count(1) total
FROM CORE.VW_Systems s
JOIN RPT.V_CRMP_Pentest P on s.Acronym=p."Acronym"
where s.Is_OperationalSystem = 1 and s.Is_HighRiskSystem = 1
and p."Weakness_Risk_Level" in ('Critical','High') 
group by s.acronym,p."Weakness_Risk_Level";
create or replace view VW_CRMP_MEANTIMETOREMEDIATE(
	ID,
	DATACENTERACRONYM,
	SNAPSHOT_DATE,
	SYSTEMACRONYM,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	OS,
	SOURCE_TOOL_LASTSEEN,
	DATACENTER_ID,
	FISMA_ID,
	GROUP_ACRONYM,
	COMPONENT_ACRONYM,
	IS_LEGACY
) COMMENT='Shows  high and critical fixed vulnerability of high risk systems assets used for CRMP.'
 as
SELECT 
vm.DW_VUL_ID as ID
--,vm.INSERT_DATE
,dc.Acronym as DataCenterAcronym
,(select REPORT_DATE from table(CORE.FN_CRM_GET_REPORT_ID(0))) as SNAPSHOT_DATE
,s.Acronym as SystemAcronym
,a.asset_id_tattoo
,vm.cve
,vm.CVSSV2BASESCORE -- 231027 renamed
,vm.CVSSV3BASESCORE -- 231027 renamed
,vm.DaysSinceDiscovery
,vm.exploitAvailable
,vm.firstSeen
,vm.FISMAseverity
,vm.lastFound
,vm.MitigationStatus
,a.OS
,vm.LASTFOUND as source_tool_lastseen -- IS THIS OK??????
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.Group_Acronym 
,s.Component_Acronym 
,vm.Is_Legacy
from CORE.VW_VulMaster vm 
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
where s.Is_OperationalSystem = 1 and s.Is_HighRiskSystem = 1 
and lower(vm.MitigationStatus) = 'fixed'
and lower(vm.FISMAseverity) IN ('critical','high')
;
create or replace view VW_CRMP_OATO_SYSTEMS_NEW(
	ACRONYM,
	OA_READY,
	OA_STATUS,
	RESIDUALRISK,
	"Asset Risk Tolerance",
	TOTALASSETS,
	OATO_CATEGORY,
	HVASTATUS,
	MEFSTATUS,
	FIPS_199_OVERALL_IMPACT_RATING,
	PII_PHI,
	FINANCIAL_SYSTEM,
	COMPONENT,
	"DevSecOPS / CSM",
	GROUP_ACRONYM,
	IN_CMS_CLOUD,
	LAST_ACT_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_DATE,
	IS_SECURITYHUB_ENABLED,
	SYSTEM,
	TLC_PHASE,
	"Vuln Risk Tolerance",
	"Resiliency Score"
) COMMENT='Shows detail of OATO systems used for CRMP'
 as
SELECT 
s.Acronym
,IFF(s.Is_OA_Ready=1,'Yes','No') as OA_Ready
,s.OA_Status
,s.TotalPOAMwithApprovedRBD ResidualRisk
,ss.AssetRiskTolerance as "Asset Risk Tolerance" 
,ss.Assets as TotalAssets
,s.OATO_Category
,s.HVAStatus
,s.MEFStatus
,s.FIPS_199_Overall_Impact_Rating
,s.PII_PHI
,s.Financial_System
,s.Component_Acronym as Component
,'TBD' as "DevSecOPS / CSM"
,s.Group_Acronym
,coalesce(s.In_CMS_Cloud,'No') as In_CMS_Cloud
,s.Last_ACT_Date
,s.Last_ACT_SCA_Final_Report_Date -- 211019 1903
,s.Last_Pentest_Date
,IFF(s.Is_SecurityHub_Enabled=1,'Yes','No') Is_SecurityHub_Enabled
,s.Authorization_Package System
,s.TLC_Phase
,ss.VulnRiskTolerance as "Vuln Risk Tolerance" 
,ss.ResiliencyScore as "Resiliency Score" 
FROM CORE.VW_Systems  s
JOIN CORE.SystemSummary ss on ss.SYSTEM_ID = s.SYSTEM_ID and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
where s.Is_OperationalSystem = 1;
create or replace view VW_CRMP_OPERATIONALSYSTEMS(
	SNAPSHOT_ID,
	COMPONENT_ACRONYM,
	SYSTEM_ID,
	HVASTATUS
) COMMENT='Shows only operational system with HVA status used for CRMP.'
 as
SELECT 
(SELECT TOP 1 REPORT_ID FROM TABLE(FN_CRM_GET_REPORT_ID(0))) as SNAPSHOT_ID
,s.Component_Acronym,s.SYSTEM_ID,s.HVAStatus
FROM CORE.VW_SYSTEMS s
where s.IS_OPERATIONALSYSTEM = 1
;
create or replace view VW_CRMP_PCTCRITICALCLOSEDLEGACY(
	SYSTEMNAME,
	OPENEDLEGACY,
	CLOSEDLEGACY,
	PERCENTAGECLOSED
) COMMENT='Shows total critical legacy vulnerability combine all systems open,closed and percentage closed  used for CRMP.'
 as
Select 
LevelName AS SystemName
,NotClosedTimely AS OpenedLegacy
,TotalClosed AS ClosedLegacy
,PercentageClosed
from TABLE(CORE.FN_CRM_METRICS('System','Critical',TRUE));
create or replace view VW_CRMP_PCTCRITICALCLOSEDWITHIN30DAYS(
	SYSTEMNAME,
	OPENORCLOSEBEYOND30DAYS,
	CLOSEDBY30DAYS,
	PERCENTAGECLOSED
) COMMENT='Shows percentage critical vulnerability combine all systems  closed within 30 days, used for CRMP.'
 as
Select 
LevelName AS SystemName
,NotClosedTimely AS OpenOrCloseBeyond30Days
,TotalClosed AS ClosedBy30Days
,PercentageClosed
from TABLE(CORE.FN_CRM_METRICS('System','Critical',FALSE))
--from TABLE(CORE.FN_CRM_METRICS('System','High',FALSE))
;
create or replace view VW_CRMP_PCTHIGHCLOSEDLEGACY(
	SYSTEMNAME,
	OPENEDLEGACY,
	CLOSEDLEGACY,
	PERCENTAGECLOSED
) COMMENT='Shows total high legacy vulnerability combine all systems open,closed and percentage closed,  used for CRMP.'
 as
Select 
LevelName AS SystemName
,NotClosedTimely AS OpenedLegacy
,TotalClosed AS ClosedLegacy
,PercentageClosed
from TABLE(CORE.FN_CRM_METRICS('System','High',TRUE))
;
create or replace view VW_CRMP_PCTHIGHCLOSEDWITHIN60DAYS(
	SYSTEMNAME,
	OPENORCLOSEBEYOND60DAYS,
	CLOSEDBY60DAYS,
	PERCENTAGECLOSED
) COMMENT='Shows percentage high vulnerability combine all systems  closed within 60 days, used for CRMP.'
 as
Select 
LevelName AS SystemName
,NotClosedTimely AS OpenOrCloseBeyond60Days
,TotalClosed AS ClosedBy60Days
,PercentageClosed
from TABLE(CORE.FN_CRM_METRICS('System','High',FALSE))
;
create or replace view VW_CRMP_PCTMANAGEDASSETS(
	ACRONYM,
	LASTTOTAL,
	CURTOTAL,
	PERCENTAGE
) COMMENT='Compare percentage assets chaged by system between today and last CRR'
 as
With CurTotalAssets AS (
SELECT s.Acronym,Count(1) CurTotal FROM CORE.VW_AssetHist c 
join CORE.VW_Systems s ON c.system_id=s.SYSTEM_ID 
where c.Report_ID=(SELECT MAX(Report_ID) FROM TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.Acronym
),
LastTotalAssets AS (
SELECT s.Acronym,Count(1) lastTotal FROM CORE.VW_AssetHist c 
join CORE.VW_Systems s ON c.system_id=s.SYSTEM_ID 
where c.Report_ID=IFF((SELECT  MAX(REPORT_ID) FROM CORE.VW_REPORTSNAPSHOTS)=(SELECT MAX(Report_ID) FROM TABLE(FN_CRM_GET_REPORT_ID(1))),
(SELECT top 1 REPORT_ID FROM (SELECT top 2 REPORT_ID FROM CORE.VW_REPORTSNAPSHOTS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc),
(SELECT MAX(Report_ID) FROM TABLE(FN_CRM_GET_REPORT_ID(1))))
GROUP BY s.Acronym
)
select coalesce(c.Acronym,l.Acronym) as Acronym, coalesce(l.lastTotal,0) as LastTotal,coalesce(c.CurTotal,0) as CurTotal,
cast((coalesce(c.CurTotal,0)-coalesce(l.lastTotal,0))*100.00/IFF(lastTotal=0,NULL,lastTotal) as decimal(8,2)) as Percentage from CurTotalAssets c full join LastTotalAssets l on c.Acronym=l.Acronym;
create or replace view VW_CRMP_PCTPOAMSRELATEDTOCORECONTROLS(
	ACRONYM,
	TOTALPOAM,
	COREPOAM,
	PARCENTAGECORE
) COMMENT='Shows percentage of POAM for core controls for every system, used for CRMP.'
 as
With CorePoam AS (
SELECT 
s.Acronym
,count(1) CorePoam
FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHist p on p.REPORT_ID = r.REPORT_ID
INNER JOIN CORE.VW_Systems s ON s.SYSTEM_ID=p.SYSTEM_ID
WHERE p.Overall_Status in ('Delayed', 'Ongoing', 'Draft')
and REPLACE(p.Target,'Allocated_Control: ','') in  
('AC-1','AC-2','AC-3','AC-5','AC-6','AC-17','CA-3','CM-2','CM-3','CM-6','CM-7','CP-2','CP-3','CP-4','CP-4(1)','IA-2','IA-5','IR-5','IR-6','IR-6(1)','PL-2','SC-7','SC-8','SC-13','SI-2','HVA Additional Controls','AU-6','CA-5','IA-5(1)')
group by s.Acronym
),
TotalPoam AS(
SELECT 
s.Acronym
,count(1) TotalPoam
FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHist p on p.REPORT_ID = r.REPORT_ID
INNER JOIN CORE.VW_Systems s ON s.SYSTEM_ID=p.SYSTEM_ID
WHERE p.Overall_Status in ('Delayed', 'Ongoing', 'Draft')
group by s.Acronym
)
Select tp.Acronym, tp.TotalPoam,coalesce(cp.CorePoam,0) as CorePoam,cast (coalesce(cp.CorePoam,0)*100.00/tp.TotalPoam as decimal(6,2)) as ParcentageCore From TotalPoam tp left join CorePoam cp ON tp.Acronym=cp.Acronym
;
create or replace view VW_CRMP_SYSTEM_SUMMARY(
	REPORT_DATE,
	ACRONYM,
	AUTHORIZATION_PACKAGE,
	COMPONENT_ACRONYM,
	FINANCIAL_SYSTEM,
	FIPS_199_OVERALL_IMPACT_RATING,
	GROUP_ACRONYM,
	HVASTATUS,
	IN_CMS_CLOUD,
	IS_SECURITYHUB_ENABLED,
	MEFSTATUS,
	OATO_CATEGORY,
	PII_PHI,
	TLC_PHASE,
	VULCRITICALREMEDIATED,
	VULCRITICAL,
	VULHIGHREMEDIATED,
	VULHIGH
) COMMENT='shows every systems total high and critical vulnerability and total remediated, used for CRMP.'
 as
SELECT 
r.REPORT_DATE
,s.Acronym
,s.Authorization_Package
,s.Component_Acronym 
,s.Financial_System
,s.FIPS_199_Overall_Impact_Rating
,s.Group_Acronym 
,s.HVAStatus
,s.In_CMS_Cloud
,s.Is_SecurityHub_Enabled
,s.MEFStatus
,s.OATO_Category
,s.PII_PHI
,s.TLC_Phase
,ss.VulCriticalRemediated
,ss.VULCRITICAL
,ss.VulHighRemediated
,ss.VULHIGH
FROM CORE.VW_Systems  s
JOIN CORE.SystemSummary ss on ss.SYSTEM_ID = s.SYSTEM_ID
JOIN CORE.REPORT_IDS r on r.REPORT_ID = ss.REPORT_ID
where s.Is_OperationalSystem = 1;
create or replace view VW_CRMP_TOTALDELAYEDHIGHCRITICALPENTESTFINDINGS(
	ACRONYM,
	WEAKNESS_RISK_LEVEL,
	TOTALDELAYED
) COMMENT='Shows total high and critical POAMs with delayed status and pentest audit type,used for CRMP.'
 as
SELECT s.Acronym, p.Weakness_Risk_Level,count(1) TotalDelayed
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and P.Overall_Status = 'Delayed' 
and p.Weakness_Risk_Level in ('Critical','High')
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym,p.Weakness_Risk_Level;
create or replace view VW_CRMP_TOTALNUMBERRISKACCEPTANCE(
	ACRONYM,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='Show Risk acceptance for every systems, used for CRMP.'
 as
SELECT Acronym, TotalPOAMwithApprovedRBD FROM CORE.VW_Systems;
create or replace view VW_CRMP_TOTALOPENHIGHCRITICALPENTESTFINDINGS(
	ACRONYM,
	TOTALCRITICALOPEN,
	TOTALHIGHOPEN
) COMMENT='No Row'
 as
WITH OpenCritical AS (
SELECT s.Acronym,count(1) TotalOpen
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON  p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and  s.Is_OperationalSystem = 1
and P.Overall_Status IN ('Pending Verification','Ongoing','Delayed','Draft')  
and p.Weakness_Risk_Level = 'Critical'
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym
),
OpenHigh AS(
SELECT s.Acronym,count(1) as TotalOpen
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON  p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and  s.Is_OperationalSystem = 1
and P.Overall_Status IN ('Pending Verification','Ongoing','Delayed','Draft')  
and p.Weakness_Risk_Level = 'High'
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym
)
Select COALESCE(c.Acronym,h.Acronym) AS Acronym 
,coalesce(c.TotalOpen,0) AS TotalCriticalOpen 
,coalesce(h.TotalOpen,0) AS TotalHighOpen
FROM OpenCritical c FULL JOIN OpenHigh h ON c.Acronym=h.Acronym;
create or replace view VW_CRMP_TOTALVULCOUNTCRITICALCOMPARE(
	ACRONYM,
	LASTMONTHCRITICAL,
	CURRENTMONTHCRITICAL,
	CURRENTCOMPARETOLASTMONTHCRITICAL
) COMMENT='Compare current and last month critical vuln count by system, used for CRMP.'
 as
With CurVul AS (
SELECT System_ID,VulCritical     
FROM CORE.VW_SystemSummary where Report_ID=(SELECT MAX(Report_ID) FROM CORE.REPORT_IDS where Is_endOfMonth=1)
),
LastVul AS (
SELECT System_ID,VulCritical     
FROM CORE.VW_SystemSummary
where Report_ID=(SELECT top 1 Report_ID FROM (SELECT top 2 Report_ID FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc)
)
SELECT s.Acronym,l.VulCritical as LastMonthCritical,c.VulCritical as CurrentMonthCritical,c.VulCritical-l.VulCritical as CurrentCompareToLastMonthCritical 
FROM CurVul c inner join LastVul l on c.System_ID=l.System_ID inner join CORE.VW_Systems s on s.System_ID=c.System_ID 
where l.VulCritical<>0 or c.VulCritical<>0;
create or replace view VW_CRMP_TOTALVULCOUNTHIGHCOMPARE(
	ACRONYM,
	LASTMONTHHIGH,
	CURRENTMONTHHIGH,
	CURRENTCOMPARETOLASTMONTHHIGH
) COMMENT='Compare current and last month high vuln count by system, used for CRMP.'
 as
With CurVul AS (
SELECT System_ID,VulHigh     
FROM CORE.VW_SystemSummary where Report_ID=(SELECT MAX(Report_ID) FROM CORE.VW_REPORTSNAPSHOTS where Is_endOfMonth=1)
),
LastVul AS (
SELECT System_ID,VulHigh     
FROM CORE.VW_SystemSummary
where Report_ID=(SELECT top 1 Report_ID FROM (SELECT top 2 Report_ID FROM CORE.VW_REPORTSNAPSHOTS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc)
)
SELECT s.Acronym,l.VulHigh as LastMonthHigh,c.VulHigh as CurrentMonthHigh,c.VulHigh-l.VulHigh as CurrentCompareToLastMonthHigh 
FROM CurVul c inner join LastVul l on c.System_ID=l.System_ID inner join CORE.VW_Systems s on s.System_ID=c.System_ID 
where l.VulHigh<>0 or c.VulHigh<>0;
create or replace view VW_CRMP_VULAWARESCORE(
	ACRONYM,
	VULNRISKTOLERANCE
) COMMENT='Calculate VULNRISKTOLERANCE=VULAWARESCORE of every system, used for CRMP'
 as
SELECT s.Acronym
,cast(SUM(IFF(v.exploitAvailable='Yes',2*(v.DaysSinceDiscovery*cast(v.CVSSV2BASESCORE as float)*S.OATO_Category),(v.DaysSinceDiscovery*cast(v.CVSSV2BASESCORE as float)*S.OATO_Category)))/IFF(count(1)=0,1,count(1)) as decimal(8,2)) as VulnRiskTolerance
from CORE.VW_VulMaster v inner JOIN CORE.VW_Systems s on s.SYSTEM_ID=v.SYSTEM_ID
group by s.Acronym;
create or replace view VW_CRMP_WEAKNESSRISKSCORE(
	ACRONYM,
	RESILIENCYSCORE
) COMMENT='Calculate RESILIENCYSCORE=WEAKNESSRISKSCORE of every system, used for CRMP'
 as 
SELECT 
s.Acronym
,SUM(IFF(p.Weakness_Risk_Level='Critical',45,IFF(p.Weakness_Risk_Level='High',30,IFF(p.Weakness_Risk_Level='Moderate',15,IFF(p.Weakness_Risk_Level='Low',10,1))))) ResiliencyScore
FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHist p on p.REPORT_ID = r.REPORT_ID
INNER JOIN CORE.VW_Systems s ON p.SYSTEM_ID=s.SYSTEM_ID
WHERE p.Overall_Status in ('Delayed', 'Ongoing', 'Draft')
GROUP BY s.Acronym;
create or replace view VW_CRRCHECKER(
	"View Name",
	TOTALSYSTEMS,
	ASSETS,
	"TotalCritical+High",
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulCritical_gte15days",
	"VulLow"
) COMMENT='Compare output of CyberRisk related views.'
 as
with Detail AS(
select FISMAseverity, count(1) as Total  from RPT.V_CyberRisk_VUL_Detail group by FISMAseverity
)
select 
    'rpt.V_CyberRisk_Month_Trend' as "View Name",
    "TotalSystems",
    "Assets",
    "TotalCritical+High",
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulCritical_gte15days",
	null as "VulLow" -- 230829 legacy had SUM([VulLow])  [VulRaw]
from RPT.V_CyberRisk_Month_Trend where "ReportDate"= (SELECT cast(REPORT_DATE as date) FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)))
UNION ALL
select 
'rpt.V_CyberRisk_DataCenter_Summary' as "View Name"
,SUM("TotalSystems") as "TotalSystems"
,SUM("TotalAssets") as "Assets"
,SUM("TotalCritical+High") as "TotalCritical+High"
,SUM("Critical Vulnerabilities") as "Critical Vulnerabilities"
,SUM("Critical: <= 15 days") as "Critical: <= 15 days"
,SUM("Unique Critical: > 15 <= 60 days") as "Unique Critical: > 15 <= 60 days"
,SUM("Critical: <= 30 days") as "Critical: <= 30 days"
,SUM("Unique Critical: > 30 <= 60 days") as "Unique Critical: > 30 <= 60 days"
,SUM("Critical: > 30 <= 60 days") as "Critical: > 30 <= 60 days"
,SUM("Unique Critical: > 60 days") as "Unique Critical: > 60 days"
,SUM("Critical: > 60 days") as "Critical: > 60 days"
,SUM("High Vulnerabilities") as "High Vulnerabilities"
,SUM("High: <= 30 days") as "High: <= 30 days"
,SUM("Unique High: > 30 <= 60 days") as "Unique High: > 30 <= 60 days"
,SUM("High: > 30 <= 60 days") as "High: > 30 <= 60 days"
,SUM("Unique High: > 60 days") as "Unique High: > 60 days"
,SUM("High: > 60 days") as "High: > 60 days"
,SUM("VulCritical_gte15days") as "VulCritical_gte15days" -- 230829 in legacy it is;;;null as "VulCritical_gte15days" -- 230829 in legacy it is: SUM([VulMedium])  [VulCritical_gte15days]
,SUM("VulLow") as "VulLow" -- 230829 in legacy the alias was VulRaw
from RPT.V_CyberRisk_DataCenter_Summary 
UNION ALL
select 
'rpt.V_CyberRisk_System_Summary' as "View Name"
,null  "TotalSystems"
,SUM("Total Assets") as "Assets"
,null  "TotalCritical+High"
,SUM("Critical Vulnerabilities") as "Critical Vulnerabilities"
,SUM("Critical: <= 15 days") as "Critical: <= 15 days"
,SUM("Unique Critical: > 15 <= 60 days") as "Unique Critical: > 15 <= 60 days"
,SUM("Critical: <= 30 days") as "Critical: <= 30 days"
,SUM("Unique Critical: > 30 <= 60 days") as "Unique Critical: > 30 <= 60 days"
,SUM("Critical: > 30 <= 60 days") as "Critical: > 30 <= 60 days"
,SUM("Unique Critical: > 60 days") as "Unique Critical: > 60 days"
,SUM("Critical: > 60 days") as "Critical: > 60 days"
,SUM("High Vulnerabilities") as "High Vulnerabilities"
,SUM("High: <= 30 days") as "High: <= 30 days"
,SUM("Unique High: > 30 <= 60 days") as "Unique High: > 30 <= 60 days"
,SUM("High: > 30 <= 60 days") as "High: > 30 <= 60 days"
,SUM("Unique High: > 60 days") as "Unique High: > 60 days"
,SUM("High: > 60 days") as "High: > 60 days"
,SUM("VulCritical_gte15days") as "VulCritical_gte15days" -- 230829 in legacy it is: SUM([VulMedium])  [VulCritical_gte15days]
,SUM("VulLow") as "VulLow" -- 230829 in legacy the alias was VulRaw
from RPT.V_CyberRisk_System_Summary 
UNION ALL
select 
'CORE.VW_CyberRisk_System_DataCenter_Summary' as "View Name"
,null  "TotalSystems"
,SUM("Total_Assets") as "Assets"
,null  "TotalCritical+High"
,SUM("Critical_Vulnerabilities") as "Critical Vulnerabilities"
,null  "Critical: <= 15 days"
,null  "Unique Critical: > 15 <= 60 days"
,null  "Critical: <= 30 days"
,null "Unique Critical: > 30 <= 60 days"
,null "Critical: > 30 <= 60 days"
,null "Unique Critical: > 60 days"
,null  "Critical: > 60 days"
,SUM("High_Vulnerabilities") as "High Vulnerabilities"
,null "High: <= 30 days"
,null  "Unique High: > 30 <= 60 days"
,null "High: > 30 <= 60 days"
,null "Unique High: > 60 days"
,null "High: > 60 days"
,null  "VulCritical_gte15days"
,null  "VulLow"
from core.VW_CyberRisk_System_DataCenter_Summary 
UNION ALL
select 
'rpt.V_CyberRisk_System_Devices' as "View Name"
,null  "TotalSystems"
,SUM(TotalAssets) as "Assets"
,null  "TotalCritical+High"
,null  "Critical Vulnerabilities"
,null  "Critical: <= 15 days"
,null  "Unique Critical: > 15 <= 60 days"
,null  "Critical: <= 30 days"
,null  "Unique Critical: > 30 <= 60 days"
,null  "Critical: > 30 <= 60 days"
,null  "Unique Critical: > 60 days"
,null  "Critical: > 60 days"
,null  "High Vulnerabilities"
,null  "High: <= 30 days"
,null  "Unique High: > 30 <= 60 days"
,null  "High: > 30 <= 60 days"
,null  "Unique High: > 60 days"
,null  "High: > 60 days"
,null  "VulCritical_gte15days"
,null  "VulLow" -- 230829 was VulRaw
from RPT.V_CyberRisk_System_Devices 
UNION ALL
select 
'rpt.V_CyberRisk_VUL_Detail' as "View Name"
,null  "TotalSystems"
,null  "Assets"
,null  "TotalCritical+High"
,(select Total from Detail where FISMAseverity='Critical') as "Critical Vulnerabilities"
,null  "Critical: <= 15 days"
,null  "Unique Critical: > 15 <= 60 days"
,null  "Critical: <= 30 days"
,null "Unique Critical: > 30 <= 60 days"
,null "Critical: > 30 <= 60 days"
,null "Unique Critical: > 60 days"
,null  "Critical: > 60 days"
,(select Total from Detail where FISMAseverity='High') as "High Vulnerabilities"
,null "High: <= 30 days"
,null  "Unique High: > 30 <= 60 days"
,null "High: > 30 <= 60 days"
,null "Unique High: > 60 days"
,null "High: > 60 days"
,null "VulCritical_gte15days" -- 230829 was (select Total from Detail where FISMAseverity='Medium') as "VulCritical_gte15days"
,(select Total from Detail where FISMAseverity='Low') as "VulLow";
create or replace view VW_CYBERRISK_SYSTEM_DATACENTER_SUMMARY(
	GROUP_ACRONYM,
	COMPONENT_ACRONYM,
	"System",
	DATACENTERACRONYM,
	TLC_PHASE,
	"Total_Assets",
	"Total_Vulnerabilites",
	"Critical_Vulnerabilities",
	"High_Vulnerabilities",
	PRIMARY_FISMA_ID,
	DATACENTER_ID,
	SYSTEM_ID,
	PRIMARY_OPERATING_LOCATION
) COMMENT='Shows total assets, vuln, high and critical vuln group by datacenter and system for current end of month, used for CRR.'
 as
select 
s.Group_Acronym 
,s.Component_Acronym 
,s.Acronym as "System"
,dc.Acronym as DataCenterAcronym
,s.TLC_Phase
,ss.Assets as "Total_Assets"
--,ss.AdjAssets as TotalAdjAssets
,(ss.VulCritical + ss.VulHigh) as "Total_Vulnerabilites"
,ss.VulCritical as "Critical_Vulnerabilities"
,ss.VulHigh as "High_Vulnerabilities"
,s.SYSTEM_ID as primary_fisma_id
,dc.SYSTEM_ID as DATACENTER_ID
,s.SYSTEM_ID
,s.Primary_Operating_Location 
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
JOIN CORE.DataCenterSystemSummary ss on ss.report_id = r.REPORT_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = ss.DATACENTER_ID 
JOIN CORE.VW_Systems s on s.SYSTEM_ID = ss.SYSTEM_ID
ORDER BY s.Acronym
,dc.Acronym;
create or replace view VW_DAILY_CRR_DATACENTER_SUMMARY(
	DATACENTERACRONYM,
	COMMONNAME,
	TOTALSYSTEMS,
	TOTALASSETS,
	TOTALCRITICAL_HIGH,
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	DATACENTER_ID
) COMMENT='Returns multiple vuln catagory daily summary for every datacenter.'
 as
select 
dc.acronym as DataCenterAcronym
,dc.CommonName
,dcs.Systems as TotalSystems
--,dcs.AdjSystems as TotalAdjSystems
,dcs.Assets as TotalAssets
--,dcs.AdjAssets as TotalAdjAssets
,(dcs.VulCritical + dcs.VulHigh) as TotalCritical_High
,dcs.VulCritical as "Critical Vulnerabilities"
,dcs.VulCritical_lte15days as "Critical: <= 15 days" -- 200821 0945
,dcs.VulUniqueCritical_gt15_lte60days as "Unique Critical: > 15 <= 60 days" -- 200821 0945
,dcs.VulCritical_lte30days as "Critical: <= 30 days"
,dcs.VulUniqueCritical_gt30_lte60days as "Unique Critical: > 30 <= 60 days"
,dcs.VulCritical_gt30_lte60days as "Critical: > 30 <= 60 days"
,dcs.VulUniqueCritical_gt60days as "Unique Critical: > 60 days"
,dcs.VulCritical_gt60days as "Critical: > 60 days"
,dcs.VulHigh as "High Vulnerabilities"
,dcs.VulHigh_lte30days as "High: <= 30 days"
,dcs.VulUniqueHigh_gt30_lte60days as "Unique High: > 30 <= 60 days"
,dcs.VulHigh_gt30_lte60days as "High: > 30 <= 60 days"
,dcs.VulUniqueHigh_gt60days as "Unique High: > 60 days"
,dcs.VulHigh_gt60days as "High: > 60 days"
,dc.SYSTEM_ID as datacenter_id
FROM CORE.VW_Systems  dc
JOIN CORE.DataCenterSummary dcs on dcs.DATACENTER_ID = dc.SYSTEM_ID and dcs.REPORT_ID = (select REPORT_ID from table(CORE.FN_CRM_GET_REPORT_ID(0))) 
ORDER BY dc.CommonName;
create or replace view VW_DAILY_CRR_SYSTEM_DATACENTER_SUMMARY(
	GROUP_ACRONYM,
	COMPONENT_ACRONYM,
	"System",
	DATACENTERACRONYM,
	TLC_PHASE,
	"Total Assets",
	"Total Vulnerabilites",
	"Critical Vulnerabilities",
	"High Vulnerabilities",
	DATACENTER_ID,
	PRIMARY_FISMA_ID,
	SYSTEM_ID,
	PRIMARY_OPERATING_LOCATION
) COMMENT='Returns multiple vuln catagory daily summary for every system and datacenter combine.'
 as
select 
s.Group_Acronym 
,s.Component_Acronym 
,s.Acronym as "System"
,dc.Acronym as DataCenterAcronym
,s.TLC_Phase
,ss.Assets as "Total Assets"
--,ss.AdjAssets as TotalAdjAssets
,(ss.VulCritical + ss.VulHigh) as "Total Vulnerabilites"
,ss.VulCritical as "Critical Vulnerabilities"
,ss.VulHigh as "High Vulnerabilities"
,dc.SYSTEM_ID as datacenter_id
,s.SYSTEM_ID as primary_fisma_id
,s.SYSTEM_ID
,s.Primary_Operating_Location 
FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
join CORE.DataCenterSystemSummary ss on ss.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = ss.DATACENTER_ID
JOIN (SELECT SYSTEM_ID,Acronym,TLC_Phase,Primary_Operating_Location,Group_Acronym,Component_Acronym
	    FROM CORE.VW_Systems) s ON s.SYSTEM_ID = ss.SYSTEM_ID
	--WHERE Is_ExcludeFromReporting = 0 and Is_PhantomSystem = 0) 
;
create or replace view VW_DAILY_CRR_VUL_DETAIL(
	ID,
	DATECREATED,
	DATACENTER_ID,
	DATACENTERACRONYM,
	COMMONNAME,
	PRIMARY_FISMA_ID,
	ACRONYM,
	ASSET_ID_TATTOO,
	IP,
	CVE,
	DNSNAME,
	MACADDRESS,
	FISMASEVERITY,
	SIGNATURE,
	CVSS3BASESCORE,
	NETBIOSNAME,
	FAMILYNAME,
	EXPLOITAVAILABLE,
	DATASOURCE,
	ROWDISPOSITION,
	FIRSTSEEN,
	LASTFOUND,
	DAYSSINCEDISCOVERY,
	OS,
	PLUGINID,
	DESCRIPTION,
	SOLUTION,
	MITIGATIONSTATUS,
	VULN_STAGEDC_ID,
	VULN_STAGEDC_DATECREATED,
	REPORTID,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED
) COMMENT='Returns current detail  of all vulnerability.'
 as
SELECT v.ID
,v.FIRSTSEEN as dateCreated
,dc.SYSTEM_ID as datacenter_id
,dc.Acronym as DataCenterAcronym
,dc.CommonName
,pf.SYSTEM_ID as primary_fisma_id
,pf.Acronym
,a.asset_id_tattoo
,a.IPv4 as ip
,v.cve
,a.fqdn as dnsName
,a.macAddress
,v.FISMAseverity
,NULL as signature 
,v.CVSSV3BASESCORE as cvss3basescore
,a.netbiosname
,NULL as familyName 
,v.exploitAvailable
,NULL as dataSource 
,NULL as RowDisposition 
,v.firstSeen
,v.lastFound
,v.DaysSinceDiscovery
,a.OS
,plugs.PLUGIN_ID as pluginid
,NULL as Description 
,NULL as Solution 
,v.mitigationstatus
,NULL as VULN_StageDC_ID 
,NULL as VULN_StageDC_dateCreated 
--,v.datacenter_id
--,v.SYSTEM_ID as primary_fisma_Id
,snap.Report_ID as ReportID
,case coalesce(cast(bodcat.ID as varchar),'No')
	when 'No' then 'No'
	Else 'Yes' 
End as Is_BOD 
,bodcat.BODDueDate 
,vm.datemitigated 
FROM CORE.VW_VulHist v
join TABLE(FN_CRM_GET_REPORT_ID(0)) snap on snap.Report_ID = v.Report_ID
JOIN CORE.VW_Assets a on a.dw_asset_id = v.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = v.datacenter_id
JOIN CORE.VW_Systems pf on pf.SYSTEM_ID = v.SYSTEM_ID
JOIN CORE.VW_VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID -- and vm.DeletionReason IS NULL  
LEFT OUTER JOIN CORE.KEV_Catalog bodcat on bodcat.CVE = vm.cve 
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
where LOWER(v.MitigationStatus) IN ('open','reopened')
and v.FISMAseverity IN ('Critical','High');
create or replace view VW_DATACENTERS(
	SYSTEM_ID,
	ACRONYM,
	COMMONNAME,
	IS_DATACENTER,
	TOTALSYSTEMSINCFACTS,
	TOTALSYSTEMSINDISPOSITION,
	TOTALSYSTEMSREPORTED,
	TOTALASSETSREPORTED,
	"Critical Vulnerabilities",
	"High Vulnerabilities",
	CFACTS_AUTHORIZATION_PACKAGE,
	CFACTS_PRIMARY_OPERATING_LOCATION,
	CFACTS_CLOUD_SERVICE_PROVIDER
) COMMENT='Returns total systems, retire systems, assets and other datacenter summary based on primary operating location.'
 as
SELECT
dc.system_id
,dc.Acronym
,dc.CommonName
,dc.Is_DataCenter
,coalesce(dcSys.TotalSystems,0) as TotalSystemsInCFACTS
,coalesce(dcSysDecom.TotalSystems,0) as TotalSystemsInDisposition
,coalesce(cds."TotalSystems",0) as TotalSystemsReported
,coalesce(cds."TotalAssets",0) as TotalAssetsReported
,coalesce(cds."Critical Vulnerabilities",0) as "Critical Vulnerabilities"
,coalesce(cds."High Vulnerabilities",0) as "High Vulnerabilities"
,dc.Authorization_Package as CFACTS_Authorization_Package
,dc.Primary_Operating_Location as CFACTS_Primary_Operating_Location
,dc.Cloud_Service_Provider as CFACTS_Cloud_Service_Provider

FROM CORE.VW_Systems dc

LEFT OUTER JOIN (select Primary_Operating_Location as datacenter_id,count(1) as TotalSystems
	FROM Systems
	GROUP BY Primary_Operating_Location) dcSys on dcSys.datacenter_id = dc.SYSTEM_ID

LEFT OUTER JOIN (select Primary_Operating_Location as datacenter_id,count(1) as TotalSystems
	FROM Systems
	WHERE TLC_Phase = 'Retire'
	GROUP BY Primary_Operating_Location) dcSysDecom on dcSysDecom.datacenter_id = dc.SYSTEM_ID

LEFT OUTER JOIN rpt.V_CyberRisk_DataCenter_Summary cds on cds."datacenter_id" = dc.SYSTEM_ID --CFACTS_UID

WHERE dc.Is_DataCenter = 1
ORDER BY dc.Acronym;
create or replace view VW_DATACENTERSUMMARY(
	REPORT_ID,
	DATACENTER_ID,
	REPORTDATE,
	ACRONYM,
	COMMONNAME,
	OPERATIONALSYSTEMS,
	SYSTEMS,
	ASSETS,
	VULCRITICAL,
	VULCRITICAL_LTE15DAYS,
	VULUNIQUECRITICAL_GT15_LTE60DAYS,
	VULCRITICAL_LTE30DAYS,
	VULUNIQUECRITICAL_GT30_LTE60DAYS,
	VULCRITICAL_GT30_LTE60DAYS,
	VULUNIQUECRITICAL_GT60DAYS,
	VULCRITICAL_GT60DAYS,
	VULHIGH,
	VULHIGH_LTE30DAYS,
	VULUNIQUEHIGH_GT30_LTE60DAYS,
	VULHIGH_GT30_LTE60DAYS,
	VULUNIQUEHIGH_GT60DAYS,
	VULHIGH_GT60DAYS,
	VULRAW,
	VULRAW_CRITICAL,
	VULRAW_HIGH,
	VULRAW_LOW,
	VULRAW_MEDIUM,
	HWAMRAWAWS,
	HWAMRAWBIGFIX,
	HWAMRAWFORESCOUT
) COMMENT='Returns history of datacenter summary.'
 as
SELECT
dcs.REPORT_ID
,dcs.DATACENTER_ID
,cast(r.REPORT_DATE as date) as ReportDate
,dc.Acronym
,dc.CommonName
,dcs.OperationalSystems
,dcs.Systems
--,dcs.AdjSystems
,dcs.Assets
--,dcs.AdjAssets
,dcs.VulCritical
,dcs.VulCritical_lte15days
,dcs.VulUniqueCritical_gt15_lte60days
,dcs.VulCritical_lte30days
,dcs.VulUniqueCritical_gt30_lte60days
,dcs.VulCritical_gt30_lte60days
,dcs.VulUniqueCritical_gt60days
,dcs.VulCritical_gt60days
,dcs.VulHigh
,dcs.VulHigh_lte30days
,dcs.VulUniqueHigh_gt30_lte60days
,dcs.VulHigh_gt30_lte60days
,dcs.VulUniqueHigh_gt60days
,dcs.VulHigh_gt60days
,dcs.VulRaw
,dcs.VulRaw_Critical
,dcs.VulRaw_High
,dcs.VulRaw_Low
,dcs.VulRaw_Medium
-- HWAM
,dcs.HWAMRawAWS
,dcs.HWAMRawBigFix
,dcs.HWAMRawForeScout
FROM CORE.DataCenterSummary dcs
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = dcs.DATACENTER_ID
JOIN CORE.REPORT_IDS r on r.REPORT_ID = dcs.REPORT_ID
ORDER BY r.REPORT_DATE desc
,dc.Acronym;
create or replace view VW_DATACENTER_COUNTCHECK(
	REPORT_ID,
	DATACENTER_ID,
	ACRONYM,
	COMMONNAME,
	MIN_SYSTEMS,
	MAX_SYSTEMS,
	AVG_SYSTEMS,
	MIN_VULASSETS,
	MAX_VULASSETS,
	AVG_VULASSETS,
	MIN_VULCRITICAL,
	MAX_VULCRITICAL,
	AVG_VULCRITICAL,
	MIN_VULHIGH,
	MAX_VULHIGH,
	AVG_VULHIGH,
	MIN_VULRAW,
	MAX_VULRAW,
	AVG_VULRAW,
	MIN_VULRAW_CRITICAL,
	MAX_VULRAW_CRITICAL,
	AVG_VULRAW_CRITICAL,
	MIN_VULRAW_HIGH,
	MAX_VULRAW_HIGH,
	AVG_VULRAW_HIGH,
	MIN_HWAMRAWAWS,
	MAX_HWAMRAWAWS,
	AVG_HWAMRAWAWS,
	MIN_HWAMRAWBIGFIX,
	MAX_HWAMRAWBIGFIX,
	AVG_HWAMRAWBIGFIX,
	MIN_HWAMRAWFORESCOUT,
	MAX_HWAMRAWFORESCOUT,
	AVG_HWAMRAWFORESCOUT
) COMMENT='Returns history of datacenter min/max/avg metrics about  hwam,vuln, asset and system.'
 as
SELECT 
dcs.REPORT_ID
,dcs.DATACENTER_ID
,dc.Acronym
,dc.CommonName
-- Systems
,Min(dcs.Systems) as Min_Systems
,Max(dcs.Systems) as Max_Systems
,Avg(dcs.Systems) as Avg_Systems
-- Assets
,Min(dcs.Assets) as Min_VulAssets
,Max(dcs.Assets) as Max_VulAssets
,Avg(dcs.Assets) as Avg_VulAssets
-- VUL
,Min(dcs.VulCritical) as Min_VulCritical
,Max(dcs.VulCritical) as Max_VulCritical
,Avg(dcs.VulCritical) as Avg_VulCritical
,Min(dcs.VulHigh) as Min_VulHigh
,Max(dcs.VulHigh) as Max_VulHigh
,Avg(dcs.VulHigh) as Avg_VulHigh
,Min(dcs.VulRaw) as Min_VulRaw
,Max(dcs.VulRaw) as Max_VulRaw
,Avg(dcs.VulRaw) as Avg_VulRaw
,Min(dcs.VulRaw_Critical) as Min_VulRaw_Critical
,Max(dcs.VulRaw_Critical) as Max_VulRaw_Critical
,Avg(dcs.VulRaw_Critical) as Avg_VulRaw_Critical
,Min(dcs.VulRaw_High) as Min_VulRaw_High
,Max(dcs.VulRaw_High) as Max_VulRaw_High
,Avg(dcs.VulRaw_High) as Avg_VulRaw_High
-- HWAM
,Min(dcs.HWAMRawAWS) as Min_HWAMRawAWS
,Max(dcs.HWAMRawAWS) as Max_HWAMRawAWS
,Avg(dcs.HWAMRawAWS) as Avg_HWAMRawAWS
,Min(dcs.HWAMRawBigFix) as Min_HWAMRawBigFix
,Max(dcs.HWAMRawBigFix) as Max_HWAMRawBigFix
,Avg(dcs.HWAMRawBigFix) as Avg_HWAMRawBigFix
,Min(dcs.HWAMRawForeScout) as Min_HWAMRawForeScout
,Max(dcs.HWAMRawForeScout) as Max_HWAMRawForeScout
,Avg(dcs.HWAMRawForeScout) as Avg_HWAMRawForeScout
FROM CORE.DataCenterSummary dcs
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = dcs.DATACENTER_ID
JOIN CORE.VW_REPORTSNAPSHOTS r on r.REPORT_ID = dcs.REPORT_ID
GROUP BY dcs.REPORT_ID
,dcs.DATACENTER_ID
,dc.SYSTEM_ID
,dc.Acronym
,dc.CommonName
ORDER BY dcs.REPORT_ID desc
,dc.Acronym
,dc.CommonName;
create or replace view VW_DESIRABEL_METADATA_PLUGINS(
	PLUGINID,
	PLUGINNAME,
	OS
) COMMENT='CRITICAL; View specifies Tenable plugins that represent metadata that is desireable\t'
 as
SELECT COLUMN1 as PluginID, COLUMN2 as PluginName,COLUMN3 as OS
FROM VALUES
('11936','OS Identification','All')
,('19506','Nessus Scan Information','All')
,('20811','Microsoft Windows Installed Software Enumeration (credentialed check)','Windows')
,('22869','Software Enumeration (SSH)','Linux')
,('25251','OS Identification : Unix uname','Linux') -- 230523 None found
,('45590','Common Platform Enumeration (CPE)','All')
,('90191','Amazon Web Services EC2 Instance Metadata Enumeration (Unix)','Unix')
,('90427','Amazon Web Services EC2 Instance Metadata Enumeration (Windows)','Windows')
,('1032381','Not seen on Nessus site. Perhaps a version of 1218405. Written in house?','Unknown')
,('1218405','Check for Empty FISMA Tattoo files. (Written in house)','Linux')
,('1221295','Print out FISMA registry keys. (Written in house)','Windows')
;
create or replace view VW_DEVICETYPEDETAIL(
	DATACENTER_ACRONYM,
	DEVICETYPE,
	OS,
	OS_TYPE,
	ASSETTATTOOPRESENT,
	TOTAL
) COMMENT='Shows total asset across DATACENTER_ACRONYM,DEVICETYPE,OS,OS_TYPE,ASSETTATTOOPRESENT.'
 as
SELECT 
a.DataCenter_Acronym,a.DeviceType,a.OS,os.OS_Type
,CASE coalesce(a.asset_id_tattoo,'ITSNULL')
	when 'ITSNULL' then 'No'
	Else 'Yes'
End assetTattooPresent
,COUNT(1) as Total
FROM CORE.VW_Assets a
LEFT OUTER JOIN (
select distinct OS 
,case OS
	when 'Amazon Linux' then 'Linux'
	when 'Amazon Linux AMI' then 'Linux'
	when 'Debian GNU/Linux' then 'Linux'
	when 'Linux Red Hat Enterprise Server 6.10 (2.6.32-696.30.1.el6.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 6.10 (2.6.32-754.27.1.el6.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 6.10 (2.6.32-754.35.1.el6.s390x)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 6.10 (2.6.32-754.35.1.el6.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.4 (3.10.0-693.11.6.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.5 (3.10.0-862.14.4.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.6 (3.10.0-957.21.2.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.6 (3.10.0-957.27.2.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.7 (3.10.0-1062.1.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.7 (3.10.0-1062.12.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.7 (3.10.0-1062.9.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.7 (3.10.0-957.27.2.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.8 (3.10.0-1062.12.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.8 (3.10.0-1127.13.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.8 (3.10.0-1127.19.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.8 (3.10.0-1127.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.8 (3.10.0-957.21.2.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.9 (3.10.0-1160.2.1.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.9 (3.10.0-1160.2.2.el7.x86_64)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.9 (3.10.0-1160.6.1.el7.s390x)' then 'Linux'
	when 'Linux Red Hat Enterprise Server 7.9 (3.10.0-1160.6.1.el7.x86_64)' then 'Linux'
	when 'Mac OS X 10.13.6 (17G14033)' then 'Mac'
	when 'Mac OS X 10.13.6 (17G14042)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G103)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G3020)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G4032)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G5033)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G6020)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G6032)' then 'Mac'
	when 'Mac OS X 10.14.6 (18G6042)' then 'Mac'
	when 'Mac OS X 10.15.3 (19D76)' then 'Mac'
	when 'Mac OS X 10.15.4 (19E287)' then 'Mac'
	when 'Mac OS X 10.15.6 (19G2021)' then 'Mac'
	when 'Mac OS X 10.15.7 (19H15)' then 'Mac'
	when 'Mac OS X 10.15.7 (19H2)' then 'Mac'
	when 'Mac OS X 10.16 (20B29)' then 'Mac'
	when 'Microsoft Windows Server 2012 R2 Standard' then 'Windows'
	when 'Microsoft Windows Server 2016 Datacenter' then 'Windows'
	when 'Microsoft Windows Server 2019 Datacenter' then 'Windows'
	when 'Red Hat Enterprise Linux Server' then 'Linux'
	when 'SunOS 5.10 (Generic_150400-69)' then 'SunOS'
	when 'SunOS 5.10 (Generic_153153-01)' then 'SunOS'
	when 'SunOS 5.10 (Generic_Virtual)' then 'SunOS'
	when 'SunOS 5.11 (11.3)' then 'SunOS'
	when 'SunOS 5.11 (11.4.24.75.2)' then 'SunOS'
	when 'SunOS 5.11 (11.4.26.75.4)' then 'SunOS'
	when 'Ubuntu' then 'Ubuntu'
	when 'Win10 10.0.14393.2791 (1607)' then 'Windows'
	when 'Win10 10.0.15063.2106 (1703)' then 'Windows'
	when 'Win10 10.0.15063.2253 (1703)' then 'Windows'
	when 'Win10 10.0.15063.2375 (1703)' then 'Windows'
	when 'Win10 10.0.17134.1006 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1009 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1184 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1246 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1276 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1304 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1365 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1425 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1488 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1550 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1553 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1610 (1803)' then 'Windows'
	when 'Win10 10.0.17134.165 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1667 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1726 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1792 (1803)' then 'Windows'
	when 'Win10 10.0.17134.1845 (1803)' then 'Windows'
	when 'Win10 10.0.18362.1016 (1909)' then 'Windows'
	when 'Win10 10.0.18362.1082 (1909)' then 'Windows'
	when 'Win10 10.0.18362.1139 (1903)' then 'Windows'
	when 'Win10 10.0.18362.418 (1909)' then 'Windows'
	when 'Win10 10.0.18362.959 (1903)' then 'Windows'
	when 'Win10 10.0.18363.1016 (1909)' then 'Windows'
	when 'Win10 10.0.18363.1198 (1909)' then 'Windows'
	when 'Win2008 6.0.6003' then 'Windows'
	when 'Win2008R2 6.1.7601' then 'Windows'
	when 'Win2012 6.2.9200' then 'Windows'
	when 'Win2012R2 6.3.9600' then 'Windows'
	when 'Win2016 10.0.14393.3866 (1607)' then 'Windows'
	when 'Win2016 10.0.14393.3930 (1607)' then 'Windows'
	when 'Win2016 10.0.14393.3986 (1607)' then 'Windows'
	when 'Win2016 10.0.14393.4046 (1607)' then 'Windows'
	when 'Win2019 10.0.17763.1282 (1809)' then 'Windows'
	when 'Win2019 10.0.17763.1518 (1809)' then 'Windows'
	when 'Win2019 10.0.17763.1554 (1809)' then 'Windows'
	when 'Win2019 10.0.17763.1577 (1809)' then 'Windows'
	when 'Win7 6.1.7601' then 'Windows'
	when 'Win8.1 6.3.9600' then 'Windows'
Else 'UNKNOWN'
End as OS_Type
from CORE.VW_Assets
) os on os.os = a.OS
GROUP BY a.DataCenter_Acronym,a.DeviceType,a.OS,os.OS_Type
,CASE coalesce(a.asset_id_tattoo,'ITSNULL')
	when 'ITSNULL' then 'No'
	Else 'Yes'
End 
order by a.DataCenter_Acronym,a.DeviceType,a.OS,os.OS_Type
,CASE coalesce(a.asset_id_tattoo,'ITSNULL')
	when 'ITSNULL' then 'No'
	Else 'Yes'
End;
create or replace view VW_DEVICETYPES(
	DEVICETYPE,
	DEVICEROLE,
	INSERT_DATE,
	IS_CANBETAGGEDWITHFISMAID,
	IS_WORKSTATIONORSERVER,
	TOTALASSETS
) COMMENT='Shows total assets by device types with device roles.'
 as
SELECT 
dt.DEVICETYPE
,dr.DeviceRole 
,dt.INSERT_DATE
,dt.Is_CanBeTaggedWithFismaID
,dt.Is_WorkstationOrServer
,coalesce(a.TotalAssets,0) as TotalAssets
FROM CORE.DeviceRoles dr
JOIN CORE.DeviceTypes dt on dt.DEVICEROLE = dr.DEVICEROLE
LEFT OUTER JOIN (select DEVICETYPE,count(1) as TotalAssets
	FROM CORE.VW_Assets 
	--where Is_Applicable = 1
	GROUP BY DEVICETYPE) a on a.DEVICETYPE = dt.DEVICETYPE
order by dt.DeviceType;
create or replace view VW_DIAG_VRT(
	SNAPSHOT_ID,
	DW_ASSET_ID,
	ASSET_VRT,
	CALC_VRT
) COMMENT='Compare current VRT of an asset with  pervious history VRT for same asset.'
 as
select v.snapshot_ID, mdr.dw_asset_id, mdr.VulnRiskTolerance as Asset_VRT,v.VRT as Calc_VRT
from CORE.VW_Assets mdr 
JOIN (select snap.snapshot_ID
,a.DW_ASSET_ID as AssetID
,cast(SUM(IFF(v.ID is null,0,v.DaysSinceDiscovery*cast(v.CVSSV2BASESCORE as float)* s.OATO_Category*IFF(v.exploitAvailable='Yes',2,1)))/IFF(count(1)=0,1,count(1)) as decimal(10,2)) as VRT
FROM VW_REPORTSNAPSHOTS snap
join CORE.VW_VulHist v on v.REPORT_ID = snap.REPORT_ID
	and v.MitigationStatus IN ('Open','Reopened')
	and snap.SNAPSHOT_ID = 5974 
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = v.DW_ASSET_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
WHERE a.Is_Scannable=1 and a.DW_ASSET_ID = 5432
group by a.DW_ASSET_ID,snap.snapshot_ID) v ON v.AssetID=mdr.dw_asset_id;
create or replace view VW_HWAM_AWS_V2(
	ACCOUNT_NUMBER,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	COMPUTER_TYPE,
	DATACENTER_ID,
	DEVICE_TYPE,
	ENVIRONMENT,
	FISMA_UUID,
	FQDN,
	HOSTNAME,
	INSTANCEID,
	INSTANCESTATUS,
	IPV4,
	IPV6,
	LAST_CONFIRMED_TIME,
	MAC,
	MOTHERBOARD_SN,
	NETBIOS_HN,
	OS,
	OS_CPE,
	OS_VERSION,
	SYSTEM_ID,
	REPORT_TIME,
	SOURCE_TOOL,
	SYSTEM_ACRONYM
) COMMENT='CRITICAL; Replacement for APP_CDM.SHARED.SEC_VW_HWAM_AWS for missing PRIMARY_FISMA_ID_DERIVED and invalid SYSTEM_ACRONYM\t'
 as
--
-- 240724 CR940
--
select
h.ACCOUNT_NUMBER
,h.BIGFIX_ASSET_ID
,h.BIOS_GUID
,h.COMPUTER_TYPE
,h.DATACENTER_ID_DERIVED as DATACENTER_ID
,h.DEVICE_TYPE
,h.ENVIRONMENT
,h.FISMA_UUID -- What is the purpose of this column? It doesn't match PRIMARY_FISMA_ID_DERIVED
,h.FQDN
,h.HOSTNAME
,h.INSTANCEID
,h.INSTANCESTATUS
,h.IPV4
,h.IPV6
,h.LAST_CONFIRMED_TIME
,h.MAC
,h.MOTHERBOARD_SN
,h.NETBIOS_HN
,h.OS
,h.OS_CPE
,h.OS_VERSION
-- 240528 added SYSTEM_ACRONYM for visibility of invalid acronyms like UNDECIDED
,coalesce(h.PRIMARY_FISMA_ID_DERIVED,s.SYSTEM_ID,com.SYSTEM_ID,h.SYSTEM_ACRONYM) as SYSTEM_ID
--,h.PRIMARY_FISMA_ID_TATTOO -- Is always NULL
,h.REPORT_TIME
,h.SOURCE_TOOL
,coalesce(s.ACRONYM,com.ACRONYM,h.SYSTEM_ACRONYM) as SYSTEM_ACRONYM
FROM APP_CDM.SHARED.SEC_VW_HWAM_AWS h
LEFT OUTER JOIN CORE.VW_SYSTEMS s on upper(s.ACRONYM) = upper(h.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.VW_SYSTEMS com on upper(com.COMMONNAME) = upper(h.SYSTEM_ACRONYM)
;
create or replace view VW_IUSG_CUMULATIVE_VULNS(
	ACCEPT_RISK_RULE_COMMENT,
	ACCEPTRISK,
	ACCOUNTID,
	ACRSCORE,
	ASSETEXPOSURESCORE,
	BASESCORE,
	BID,
	CHECKTYPE,
	CPE,
	CVE,
	CVSSV3BASESCORE,
	CVSSV3TEMPORALSCORE,
	CVSSV3VECTOR,
	CVSSVECTOR,
	DATACENTER_ID,
	DESCRIPTION,
	DNSNAME,
	EXPLOIT_AVAILABLE,
	EXPLOITEASE,
	EXPLOITFRAMEWORKS,
	FAMILY_ID,
	FAMILY_NAME,
	FAMILY_TYPE,
	FIRST_SEEN,
	HAS_BEEN_MITIGATED,
	HOSTUNIQUENESS,
	HOSTUUID,
	INSTANCEID,
	IP,
	IPS,
	KEYDRIVERS,
	LAST_SEEN,
	MACADDRESS,
	NETBIOSNAME,
	OPERATING_SYSTEM,
	PATCHPUB_DATE,
	PLUGIN_ID,
	PLUGIN_INFO,
	PLUGIN_MOD_DATE,
	PLUGIN_NAME,
	PLUGIN_PUB_DATE,
	PLUGINTEXT,
	PORT,
	PROTOCOL,
	RECASTRISK,
	RECASTRISKRULECOMMENT,
	REPOSITORY_DATAFORMAT,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RISKFACTOR,
	SEEALSO,
	SEVERITY_DESCRIPTION,
	SEVERITY_ID,
	SEVERITY_NAME,
	SOLUTION,
	STIGSEVERITY,
	SYNOPSIS,
	SYSTEM_ID,
	TEMPORAL_SCORE,
	UNIQUENESS,
	UUID,
	VERSION,
	VPR_SCORE,
	VPRCONTEXT,
	VULN_PUB_DATE,
	VULNUNIQUENESS,
	VULNUUID,
	XREF,
	FILENAME,
	S3_FILE_CREATE,
	SF_FILE_LOAD,
	RAW_VULNS
) COMMENT='CRITICAL; Replacement for APP_CDM.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS for missing InstanceID and AccountID\t'
 as
--
-- 240724 CR940
--
-- UUID can be Empty/Null
-- Some ACCOUNTID are not in SEC_VW_FISMA_LOOKUPS e.g. 491375690626
-- 90191 Amazon Web Services EC2 Instance Metadata Enumeration (Unix)
-- 90427 Amazon Web Services EC2 Instance Metadata Enumeration (Windows)
-- 90191/90427 has 'instance-id' and/or 'instanceId'
-- Use SEC_VW_HWAM_AWS instead of SEC_VW_FISMA_LOOKUPS
-- Not all instanceID from SEC_VW_IUSG_TENABLE_PLUGIN_METADATA are in SEC_VW_HWAM_AWS based on instanceID
--  so also try to find instanceID in SEC_VW_HWAM_AWS based on DNSNAME
-- There is no date filter on SEC_VW_IUSG_TENABLE_PLUGIN_METADATA so we were joining on history going back to Jan/2024
--
select DISTINCT
vstage.ACCEPT_RISK_RULE_COMMENT
,vstage.ACCEPTRISK
,hwam.ACCOUNT_NUMBER as ACCOUNTID 
,vstage.ACRSCORE
,vstage.ASSETEXPOSURESCORE
,vstage.BASESCORE
,vstage.BID
,vstage.CHECKTYPE
,vstage.CPE
,vstage.CVE
,vstage.CVSSV3BASESCORE
,vstage.CVSSV3TEMPORALSCORE
,vstage.CVSSV3VECTOR
,vstage.CVSSVECTOR
,hwam.DATACENTER_ID
,vstage.DESCRIPTION
,vstage.DNSNAME
,vstage.EXPLOIT_AVAILABLE
,vstage.EXPLOITEASE
,vstage.EXPLOITFRAMEWORKS
,vstage.FAMILY_ID
,vstage.FAMILY_NAME
,vstage.FAMILY_TYPE
,vstage.FIRST_SEEN
,vstage.HAS_BEEN_MITIGATED
,vstage.HOSTUNIQUENESS
,vstage.HOSTUUID
,met.instance_id as INSTANCEID 
,vstage.IP
,vstage.IPS
,vstage.KEYDRIVERS
,vstage.LAST_SEEN
,vstage.MACADDRESS
,vstage.NETBIOSNAME
,vstage.OPERATING_SYSTEM
,vstage.PATCHPUB_DATE
,vstage.PLUGIN_ID
,vstage.PLUGIN_INFO
,vstage.PLUGIN_MOD_DATE
,vstage.PLUGIN_NAME
,vstage.PLUGIN_PUB_DATE
,vstage.PLUGINTEXT
,vstage.PORT
,vstage.PROTOCOL
,vstage.RECASTRISK
,vstage.RECASTRISKRULECOMMENT
,vstage.REPOSITORY_DATAFORMAT
,vstage.REPOSITORY_DESCRIPTION
,vstage.REPOSITORY_ID
,vstage.REPOSITORY_NAME
,vstage.RISKFACTOR
,vstage.SEEALSO
,vstage.SEVERITY_DESCRIPTION
,vstage.SEVERITY_ID
,vstage.SEVERITY_NAME
,vstage.SOLUTION
,vstage.STIGSEVERITY
,vstage.SYNOPSIS
,hwam.SYSTEM_ID
,vstage.TEMPORAL_SCORE
,vstage.UNIQUENESS
,vstage.UUID
,vstage.VERSION
,vstage.VPR_SCORE
,vstage.VPRCONTEXT
,vstage.VULN_PUB_DATE 
,vstage.VULNUNIQUENESS 
,vstage.VULNUUID 
,vstage.XREF
,vstage.FILENAME
,vstage.S3_FILE_CREATE 
,vstage.SF_FILE_LOAD 
,vstage.RAW_VULNS 
from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS_STAGING vstage

-- Added s3_file_create_date
-- Currently, repositoryid is always 1
JOIN (select replace(uuid,CHAR(10),'') as UUID, replace(accountID,CHAR(10),'') as accountID, NULLIF(replace(instanceid,CHAR(10),''),'') as instance_id
    , replace(dnsname,CHAR(10),'') as dnsname, replace(ip,CHAR(10),'') as IP, replace(repositoryid,CHAR(10),'') as repositoryid
    , s3_file_create::date as s3_file_create_date
    from APP_TENABLE.SHARED.SEC_VW_IUSG_TENABLE_PLUGIN_METADATA where ip is not null and instance_id is not null
    group by uuid, accountid, instanceid, dnsname, ip, repositoryid, s3_file_create_date) met 
    on met.repositoryid = vstage.repository_id and coalesce(NULLIF(met.dnsname,''),'ITSNULL') = coalesce(NULLIF(vstage.dnsname,''),'ITSNULL') and met.ip = vstage.ip

/* THE FOLLOWING RETURNED AN INSTANCEID THAT WAS DIFFERENT FROM THE METATDATA
LEFT OUTER JOIN (SELECT h1.instanceid,f.value::string as One_Hostname
    FROM CORE.VW_SEC_VW_HWAM_AWS_WORKAROUND_V2 h1
    join table(flatten(HOSTNAME,outer=>true)) as f
    where NULLIF(f.value::string,'') is not null
    GROUP BY h1.instanceid,f.value::string) hwamDNS on hwamDNS.One_Hostname = met.dnsname and NULLIF(met.dnsname,'') IS NOT NULL
LEFT OUTER JOIN CORE.VW_SEC_VW_HWAM_AWS_WORKAROUND_V2 hwam on hwam.instanceid = coalesce(met.instanceiD,hwamDNS.instanceiD)
*/
JOIN CORE.VW_HWAM_AWS_V2 hwam on hwam.instanceid = met.instance_id
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = hwam.DATACENTER_ID -- 240726 CR928
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = hwam.SYSTEM_ID -- 240726 CR928
WHERE met.s3_file_create_date = vstage.s3_file_create::DATE
and NULLIF(met.instance_id,'''') IS NOT NULL; -- 240726 CR928
;
create or replace view VW_IUSG_MAG_LOOKUP_TEST(
	SUBSCRIPTION_ID,
	DATE,
	ACCOUNT_NUMBER,
	SYSTEM_ACRONYM,
	APP_PHASE_NAME,
	ACCOUNT_NAME,
	ACCOUN_TYPE,
	LONG_APP_NAME,
	SHORT_APP_NAME,
	APP_LIVE_STATUS,
	ADO_TECH_MANAGER_EMAIL,
	ENV_NAME,
	MARKETPLACE,
	MEDIC_OE_EFFECT,
	OE_EFFECT,
	PLATFORM_NAME,
	PROJ_PHASE,
	ID,
	FILE_NAME,
	FILE_LAST_MODIFIED
) as
SELECT DISTINCT
v.SUBSCRIPTION_ID
,flu.*

FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS v
--LEFT OUTER JOIN REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS flu on upper(flu.account_number) = upper(v.SUBSCRIPTION_ID)
--LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_VW_FISMA_LOOKUPS_ALL flu on upper(flu.account_number) = upper(v.SUBSCRIPTION_ID)
--LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_VW_FISMA_CAMP flu on upper(flu.account_number) = upper(v.SUBSCRIPTION_ID)
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_VW_FISMA_CAMP flu on upper(flu.account_number) = upper(v.SUBSCRIPTION_ID)
WHERE S3_FILE_CREATE::date = current_date()
;
create or replace view VW_IUSG_MAG_TATTOO_TEST(
	ASSET_ID_TATTOO,
	AVAILABLITY_ZONE,
	AWS_ACCOUNTID,
	AWS_INSTANCE_ID,
	COMPLIANCE_ACTUAL_VALUE,
	COMPLIANCE_RESULT,
	DNSNAME,
	HOSTUNIQUENESS,
	IP,
	IS_IN_CAMP_DB,
	MACADDRESS,
	NETBIOSNAME,
	PLUGINTEXT,
	PORT,
	REGION,
	S3_FILE_CREATE,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	SEVERITY_ID,
	SOURCE,
	SYSTEM_ID,
	UUID,
	VERIFIED_SYSTEM_ID
) COMMENT='CRITICAL; Workaround obtaining uniform tattoo plugin data for IUSG_MAG\t'
 as
SELECT
t.ASSET_ID_TATTOO
,t.AVAILABLITY_ZONE
,t.AWS_ACCOUNTID
,t.AWS_INSTANCE_ID
,t.COMPLIANCE_ACTUAL_VALUE
,t.COMPLIANCE_RESULT
,t.DNSNAME
,t.HOSTUNIQUENESS
,t.IP
,t.IS_IN_CAMP_DB
,t.MACADDRESS
,t.NETBIOSNAME
,t.PLUGIN_ID
--,t.PLUGINTEXT -- Uncomment for diagnostics
,t.PORT
,t.REGION
,t.S3_FILE_CREATE
,t.REPOSITORY_DESCRIPTION
,t.REPOSITORY_ID
,t.SEVERITY_ID
,t.SOURCE
,t.SYSTEM_ID_TAG as SYSTEM_ID
,t.UUID
,s.SYSTEM_ID as VERIFIED_SYSTEM_ID
FROM ( 
select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'availabilityZone: ',2),' ',1),CHR(10),'') AVAILABLITY_ZONE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'accountId: ',2),' ',1),CHR(10),'') AWS_ACCOUNTID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'instanceId: ',2),' ',1),CHR(10),'') AWS_INSTANCE_ID
,NULL as COMPLIANCE_VALUE_POS1
,NULL as COMPLIANCE_VALUE_POS2
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_RESULT_POS1
,NULL as COMPLIANCE_RESULT_POS2
,NULL as COMPLIANCE_RESULT
,NULL as ASSET_ID_TATTOO
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,case(coalesce(flu.SYSTEM_ID,'ITSNULL'))
    when 'ITSNULL' then 0
    Else 1
End as IS_IN_CAMP_DB
,v.MACADDRESS
,v.NETBIOSNAME
,v.PLUGIN_ID
,v.PLUGINTEXT
,v.PORT
,REPLACE(split_part(split_part(v.PLUGINTEXT,'region: ',2),' ',1),CHR(10),'') REGION
,v.S3_FILE_CREATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.SEVERITY_ID
,'SEC_VW_IUSG_MAG_CUMULATIVE_VULNS' as SOURCE
,flu.SYSTEM_ID as SYSTEM_ID_TAG
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS v
LEFT OUTER JOIN CORE.VW_AWS_CAMPDB_LOOKUP flu on flu.account_number = AWS_ACCOUNTID
WHERE v.PLUGIN_ID IN
(
'90191' -- Amazon Web Services EC2 Instance Metadata Enumeration (Unix)
,'90427' -- Amazon Web Services EC2 Instance Metadata Enumeration (Windows)
)

UNION ALL

select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'availabilityZone: ',2),' ',1),CHR(10),'') AVAILABLITY_ZONE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'accountId: ',2),' ',1),CHR(10),'') AWS_ACCOUNTID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'instanceId: ',2),' ',1),CHR(10),'') AWS_INSTANCE_ID
,NULL as COMPLIANCE_VALUE_POS1
,NULL as COMPLIANCE_VALUE_POS2
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_RESULT_POS1
,NULL as COMPLIANCE_RESULT_POS2
,NULL as COMPLIANCE_RESULT
,NULL as ASSET_ID_TATTOO
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,case(coalesce(flu.SYSTEM_ID,'ITSNULL'))
    when 'ITSNULL' then 0
    Else 1
End as IS_IN_CAMP_DB
,v.MACADDRESS
,v.NETBIOSNAME
,v.PLUGIN_ID
,v.PLUGINTEXT
,v.PORT
,REPLACE(split_part(split_part(v.PLUGINTEXT,'region: ',2),' ',1),CHR(10),'') REGION
,v.S3_FILE_CREATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.SEVERITY_ID
,'SEC_VW_IUSG_MAG_MITIGATED_VULNS' as SOURCE
,flu.SYSTEM_ID as SYSTEM_ID_TAG
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_MITIGATED_VULNS v
LEFT OUTER JOIN CORE.VW_AWS_CAMPDB_LOOKUP flu on flu.account_number = AWS_ACCOUNTID
WHERE v.PLUGIN_ID IN
(
'90191' -- Amazon Web Services EC2 Instance Metadata Enumeration (Unix)
,'90427' -- Amazon Web Services EC2 Instance Metadata Enumeration (Windows)
)

UNION ALL

select DISTINCT
NULL as AVAILABLITY_ZONE
,NULL as AWS_ACCOUNTID
,NULL as AWS_INSTANCE_ID
,POSITION('<cm:compliance-actual-value>',v.PLUGINTEXT) as COMPLIANCE_VALUE_POS1
,POSITION('</cm:compliance-actual-value>',v.PLUGINTEXT) as COMPLIANCE_VALUE_POS2
,SUBSTRING(v.PLUGINTEXT,(COMPLIANCE_VALUE_POS1 + 28),COMPLIANCE_VALUE_POS2 - COMPLIANCE_VALUE_POS1 - 28) as COMPLIANCE_ACTUAL_VALUE
,POSITION('<cm:compliance-result>',v.PLUGINTEXT) as COMPLIANCE_RESULT_POS1
,POSITION('</cm:compliance-result>',v.PLUGINTEXT) as COMPLIANCE_RESULT_POS2
,SUBSTRING(v.PLUGINTEXT,(COMPLIANCE_RESULT_POS1 + 22),COMPLIANCE_RESULT_POS2 - COMPLIANCE_RESULT_POS1 - 22) as COMPLIANCE_RESULT
,coalesce(NULLIF(REPLACE(split_part(split_part(COMPLIANCE_ACTUAL_VALUE,'The Asset_ID is ',2),CHR(10),1),CHR(10),''),''),'No Asset_ID tag') as ASSET_ID_TATTOO
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,case(coalesce(flu.SYSTEM_ID,'ITSNULL'))
    when 'ITSNULL' then 0
    Else 1
End as IS_IN_CAMP_DB
,v.MACADDRESS
,v.NETBIOSNAME
,v.PLUGIN_ID
,v.PLUGINTEXT
,v.PORT
,NULL as REGION
,v.S3_FILE_CREATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.SEVERITY_ID
,'SEC_VW_IUSG_MAG_CUMULATIVE_VULNS' as SOURCE
,coalesce(NULLIF(split_part(split_part(split_part(COMPLIANCE_ACTUAL_VALUE,'The Primary_FISMA_ID is ',2),'<',1),CHR(10),1),''),'No Primary_FISMA_ID tag') as SYSTEM_ID_TAG
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS v
LEFT OUTER JOIN CORE.VW_AWS_CAMPDB_LOOKUP flu on flu.SYSTEM_ID = SYSTEM_ID_TAG
WHERE v.PLUGIN_ID = '1221295' -- Print out FISMA registry keys. (Windows)

UNION ALL

select DISTINCT
NULL as AVAILABLITY_ZONE
,NULL as AWS_ACCOUNTID
,NULL as AWS_INSTANCE_ID
,POSITION('<cm:compliance-actual-value>',v.PLUGINTEXT) as COMPLIANCE_VALUE_POS1
,POSITION('</cm:compliance-actual-value>',v.PLUGINTEXT) as COMPLIANCE_VALUE_POS2
,SUBSTRING(v.PLUGINTEXT,(COMPLIANCE_VALUE_POS1 + 28),COMPLIANCE_VALUE_POS2 - COMPLIANCE_VALUE_POS1 - 28) as COMPLIANCE_ACTUAL_VALUE
,POSITION('<cm:compliance-result>',v.PLUGINTEXT) as COMPLIANCE_RESULT_POS1
,POSITION('</cm:compliance-result>',v.PLUGINTEXT) as COMPLIANCE_RESULT_POS2
,SUBSTRING(v.PLUGINTEXT,(COMPLIANCE_RESULT_POS1 + 22),COMPLIANCE_RESULT_POS2 - COMPLIANCE_RESULT_POS1 - 22) as COMPLIANCE_RESULT
,coalesce(NULLIF(REPLACE(split_part(split_part(COMPLIANCE_ACTUAL_VALUE,'/var/CMS/FISMA/Asset_ID/',2),CHR(10),1),CHR(10),''),''),'No Asset_ID tag') as ASSET_ID_TATTOO
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,case(coalesce(flu.SYSTEM_ID,'ITSNULL'))
    when 'ITSNULL' then 0
    Else 1
End as IS_IN_CAMP_DB
,v.MACADDRESS
,v.NETBIOSNAME
,v.PLUGIN_ID
,v.PLUGINTEXT
,v.PORT
,NULL as REGION
,v.S3_FILE_CREATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.SEVERITY_ID
,'SEC_VW_IUSG_MAG_CUMULATIVE_VULNS' as SOURCE
,coalesce(NULLIF(split_part(split_part(split_part(COMPLIANCE_ACTUAL_VALUE,'/var/CMS/FISMA/Primary_FISMA_ID/',2),'<',1),CHR(10),1),''),'No Primary_FISMA_ID tag') as SYSTEM_ID_TAG
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS v
LEFT OUTER JOIN CORE.VW_AWS_CAMPDB_LOOKUP flu on flu.SYSTEM_ID = SYSTEM_ID_TAG
WHERE v.PLUGIN_ID = '1218405' -- Check for Empty FISMA Tattoo files. (Linux)
) t
LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = t.SYSTEM_ID_TAG
;
create or replace view VW_IUSG_MITIGATED_VULNS(
	ACCEPT_RISK_RULE_COMMENT,
	ACCEPTRISK,
	ACCOUNTID,
	ACRSCORE,
	ASSETEXPOSURESCORE,
	BASESCORE,
	BID,
	CHECKTYPE,
	CPE,
	CVE,
	CVSSV3BASESCORE,
	CVSSV3TEMPORALSCORE,
	CVSSV3VECTOR,
	CVSSVECTOR,
	DATACENTER_ID,
	DESCRIPTION,
	DNSNAME,
	EXPLOIT_AVAILABLE,
	EXPLOITEASE,
	EXPLOITFRAMEWORKS,
	FAMILY_ID,
	FAMILY_NAME,
	FAMILY_TYPE,
	FIRST_SEEN,
	HAS_BEEN_MITIGATED,
	HOSTUNIQUENESS,
	HOSTUUID,
	INSTANCEID,
	IP,
	IPS,
	KEYDRIVERS,
	LAST_SEEN,
	MACADDRESS,
	NETBIOSNAME,
	OPERATING_SYSTEM,
	PATCHPUB_DATE,
	PLUGIN_ID,
	PLUGIN_INFO,
	PLUGIN_MOD_DATE,
	PLUGIN_NAME,
	PLUGIN_PUB_DATE,
	PLUGINTEXT,
	PORT,
	PROTOCOL,
	RECASTRISK,
	RECASTRISKRULECOMMENT,
	REPOSITORY_DATAFORMAT,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RISKFACTOR,
	SEEALSO,
	SEVERITY_DESCRIPTION,
	SEVERITY_ID,
	SEVERITY_NAME,
	SOLUTION,
	STIGSEVERITY,
	SYNOPSIS,
	SYSTEM_ID,
	TEMPORAL_SCORE,
	UNIQUENESS,
	UUID,
	VERSION,
	VPR_SCORE,
	VPRCONTEXT,
	VULN_PUB_DATE,
	VULNUNIQUENESS,
	VULNUUID,
	XREF,
	FILENAME,
	S3_FILE_CREATE,
	SF_FILE_LOAD,
	RAW_VULNS
) COMMENT='CRITICAL; Replacement for APP_CDM.SHARED.SEC_VW_IUSG_MITIGATED_VULNS for missing InstanceID and AccountID\t'
 as
--
-- 240724 CR940
--
-- SEE NOTES IN CORE.VW_IUSG_CUMULATIVE_VULNS
--
select DISTINCT
vstage.ACCEPT_RISK_RULE_COMMENT
,vstage.ACCEPTRISK
,hwam.ACCOUNT_NUMBER as ACCOUNTID 
,vstage.ACRSCORE
,vstage.ASSETEXPOSURESCORE
,vstage.BASESCORE
,vstage.BID
,vstage.CHECKTYPE
,vstage.CPE
,vstage.CVE
,vstage.CVSSV3BASESCORE
,vstage.CVSSV3TEMPORALSCORE
,vstage.CVSSV3VECTOR
,vstage.CVSSVECTOR
,hwam.DATACENTER_ID
,vstage.DESCRIPTION
,vstage.DNSNAME
,vstage.EXPLOIT_AVAILABLE
,vstage.EXPLOITEASE
,vstage.EXPLOITFRAMEWORKS
,vstage.FAMILY_ID
,vstage.FAMILY_NAME
,vstage.FAMILY_TYPE
,vstage.FIRST_SEEN
,vstage.HAS_BEEN_MITIGATED
,vstage.HOSTUNIQUENESS
,vstage.HOSTUUID
,met.instance_id as INSTANCEID 
,vstage.IP
,vstage.IPS
,vstage.KEYDRIVERS
,vstage.LAST_SEEN
,vstage.MACADDRESS
,vstage.NETBIOSNAME
,vstage.OPERATING_SYSTEM
,vstage.PATCHPUB_DATE
,vstage.PLUGIN_ID
,vstage.PLUGIN_INFO
,vstage.PLUGIN_MOD_DATE
,vstage.PLUGIN_NAME
,vstage.PLUGIN_PUB_DATE
,vstage.PLUGINTEXT
,vstage.PORT
,vstage.PROTOCOL
,vstage.RECASTRISK
,vstage.RECASTRISKRULECOMMENT
,vstage.REPOSITORY_DATAFORMAT
,vstage.REPOSITORY_DESCRIPTION
,vstage.REPOSITORY_ID
,vstage.REPOSITORY_NAME
,vstage.RISKFACTOR
,vstage.SEEALSO
,vstage.SEVERITY_DESCRIPTION
,vstage.SEVERITY_ID
,vstage.SEVERITY_NAME
,vstage.SOLUTION
,vstage.STIGSEVERITY
,vstage.SYNOPSIS
,hwam.SYSTEM_ID
,vstage.TEMPORAL_SCORE
,vstage.UNIQUENESS
,vstage.UUID
,vstage.VERSION
,vstage.VPR_SCORE
,vstage.VPRCONTEXT
,vstage.VULN_PUB_DATE 
,vstage.VULNUNIQUENESS 
,vstage.VULNUUID 
,vstage.XREF
,vstage.FILENAME
,vstage.S3_FILE_CREATE 
,vstage.SF_FILE_LOAD 
,vstage.RAW_VULNS 
from APP_TENABLE.SHARED.SEC_VW_IUSG_MITIGATED_VULNS_STAGING vstage

-- Added s3_file_create_date
-- Currently, repositoryid is always 1
JOIN (select replace(uuid,CHAR(10),'') as UUID, replace(accountID,CHAR(10),'') as accountID, NULLIF(replace(instanceid,CHAR(10),''),'') as instance_id
    , replace(dnsname,CHAR(10),'') as dnsname, replace(ip,CHAR(10),'') as IP, replace(repositoryid,CHAR(10),'') as repositoryid
    , s3_file_create::date as s3_file_create_date
    from APP_TENABLE.SHARED.SEC_VW_IUSG_TENABLE_PLUGIN_METADATA where ip is not null and instance_id is not null
    group by uuid, accountid, instanceid, dnsname, ip, repositoryid, s3_file_create_date) met 
    on met.repositoryid = vstage.repository_id and coalesce(NULLIF(met.dnsname,''),'ITSNULL') = coalesce(NULLIF(vstage.dnsname,''),'ITSNULL') and met.ip = vstage.ip

JOIN CORE.VW_HWAM_AWS_V2 hwam on hwam.instanceid = met.instance_id
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = hwam.DATACENTER_ID -- 240726 CR928
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = hwam.SYSTEM_ID -- 240726 CR928
WHERE met.s3_file_create_date = vstage.s3_file_create::DATE
and NULLIF(met.instance_id,'''') IS NOT NULL; -- 240726 CR928
;
create or replace view VW_LOG4J(
	DATEVULMASTERCREATED,
	SNAPSHOT_DATE,
	PLUGIN_ID,
	CVE,
	MITIGATIONSTATUS,
	DATEMITIGATED,
	DATEREOPENED,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	TENABLEUUID,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	NETBIOSNAME,
	IPV4,
	DEVICETYPE,
	SOURCE_TOOL_CREATE,
	OS,
	LASTSEEN_HWAM,
	LASTSEEN_VUL,
	DAYS_BTW_HWAM_AND_VUL,
	LAST_CONFIRMED_TIME,
	DAYSSINCELASTCONFIRMED,
	DW_ASSET_ID,
	DW_VUL_ID
) COMMENT='Shows all assets affected by LOG4j vuln (CVE-2021-44228)'
 as
select TOP 100000 *
FROM 
(
SELECT 
vm.INSERT_DATE dateVulMasterCreated
,(select MAX(SNAPSHOT_DATE) FROM CORE.SNAPSHOT_IDS where DataCategory = 'VUL') as SNAPSHOT_DATE
,plugs.plugin_ID
,vm.cve
,vm.MitigationStatus
,vm.datemitigated
,vm.dateReopened
,a.DataCenter_Acronym
,a.System_Acronym
,a.TenableUUID
,a.asset_id_tattoo
,a.fqdn
,a.hostname
,a.netbiosname
,a.IPv4
,a.DeviceType
,a.source_tool_create
,a.os
,a.LastSeen_HWAM 
,a.lastSeen_VUL 
,DATEDIFF(d,a.lastSeen_VUL, a.LastSeen_HWAM) Days_Btw_HWAM_and_VUL 
,a.last_confirmed_time
,DATEDIFF(d,a.last_confirmed_time, CURRENT_TIMESTAMP) DaysSinceLastConfirmed 
,a.dw_asset_id
,vm.DW_VUL_ID
FROM CORE.VULPLUGINS_COALESCED plugs  -- VulPlugins plugs
join CORE.VW_VulMaster vm on vm.DW_VUL_ID = plugs.DW_VUL_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = vm.DATACENTER_ID
JOIN CORE.VW_Assets a on a.dw_asset_id = vm.DW_ASSET_ID -- and a.Is_Applicable = 1
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID -- PRIMARY_FISMA_ID

where vm.CVE = 'CVE-2021-44228' --and vm.DeletionReason IS NULL
) x

ORDER BY x.DataCenter_Acronym
,x.System_Acronym
,x.fqdn;
create or replace view VW_MILESTONEHIST(
	REPORTDATE,
	ID,
	ACTUAL_COMPLETION_DATE,
	AUTHORIZATION_PACKAGE,
	CHANGES_TO_MILESTONE,
	ESTIMATED_COMPLETION_DATE,
	LAST_UPDATED,
	MILESTONE_DESCRIPTION,
	MILESTONE_NAME,
	MILESTONE_STATUS,
	MILESTONE_ID,
	POAM_ID,
	SCHEDULED_COMPLETION_DATE,
	SYSTEM_ID
) COMMENT='Return Milestone history ingested from CFACTS for every report_id. '
 as
SELECT 
r.REPORT_DATE as ReportDate
,m.ID
,m.Actual_Completion_Date
,s.Authorization_Package
,m.Changes_To_Milestone
,m.Estimated_Completion_Date
,m.Last_Updated
,m.Milestone_Description
,m.Milestone_Name
,m.Milestone_Status
,m.Milestone_ID
,m.POAM_ID
,m.Scheduled_Completion_Date
,s.SYSTEM_ID
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.MILESTONEHIST m on m.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = m.SYSTEM_ID
;
create or replace view VW_NESSUS_SCAN_INFORMATION(
	BACKPORTS,
	CREDENTIALED_CHECK_DETAIL,
	CREDENTIALED_CHECK,
	DNSNAME,
	HOSTUNIQUENESS,
	IP,
	MACADDRESS,
	NESSUS_BUILD,
	NESSUS_VERSION,
	NETBIOSNAME,
	PATCH_MANAGEMENT_CHECKS,
	PLUGIN_FEED_VERSION,
	PLUGIN_ID,
	PORT,
	REPORTDATE,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	SCAN_NAME,
	SCAN_POLICY_USED,
	SCAN_START_DATE,
	SCAN_TYPE,
	SCANNER_OS,
	SEVERITY_ID,
	SOURCE,
	UUID
) COMMENT='CRITICAL; Capture Nessus Scan Information using PLUGIN_ID = 19506\t'
 as
SELECT t.*
/*
t.CREDENTIALED_CHECK_DETAIL
,t.NESSUS_VERSION
,t.PATCH_MANAGEMENT_CHECKS
,t.PLUGIN_FEED_VERSION
,t.PLUGIN_ID
,t.SCANNER_OS
*/
FROM ( 
select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'Backports : ',2),CHR(10),1),CHR(10),'') BACKPORTS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Credentialed checks : ',2),CHR(10),1),CHR(10),'') CREDENTIALED_CHECK_DETAIL
,SUBSTRING(CREDENTIALED_CHECK_DETAIL,1,3) CREDENTIALED_CHECK
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,v.MACADDRESS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus build : ',2),CHR(10),1),CHR(10),'') NESSUS_BUILD
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus version : ',2),CHR(10),1),CHR(10),'') NESSUS_VERSION
,v.NETBIOSNAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Patch management checks : ',2),CHR(10),1),CHR(10),'') PATCH_MANAGEMENT_CHECKS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Plugin feed version : ',2),CHR(10),1),CHR(10),'') PLUGIN_FEED_VERSION
,v.PLUGIN_ID
--,v.PLUGINTEXT
,v.PORT
,v.REPORTDATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan name : ',2),CHR(10),1),CHR(10),'') SCAN_NAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan policy used :',2),CHR(10),1),CHR(10),'') SCAN_POLICY_USED
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan Start Date : ',2),CHR(10),1),CHR(10),'') SCAN_START_DATE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan type : ',2),CHR(10),1),CHR(10),'') SCAN_TYPE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scanner OS : ',2),CHR(10),1),CHR(10),'') SCANNER_OS
,v.SEVERITY_ID
,'SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO' as SOURCE
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO v
WHERE v.PLUGIN_ID = '19506' -- Nessus Scan Information

UNION ALL

select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'Backports : ',2),CHR(10),1),CHR(10),'') BACKPORTS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Credentialed checks : ',2),CHR(10),1),CHR(10),'') CREDENTIALED_CHECK_DETAIL
,SUBSTRING(CREDENTIALED_CHECK_DETAIL,1,3) CREDENTIALED_CHECK
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,v.MACADDRESS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus build : ',2),CHR(10),1),CHR(10),'') NESSUS_BUILD
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus version : ',2),CHR(10),1),CHR(10),'') NESSUS_VERSION
,v.NETBIOSNAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Patch management checks : ',2),CHR(10),1),CHR(10),'') PATCH_MANAGEMENT_CHECKS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Plugin feed version : ',2),CHR(10),1),CHR(10),'') PLUGIN_FEED_VERSION
,v.PLUGIN_ID
--,v.PLUGINTEXT
,v.PORT
,v.REPORTDATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan name : ',2),CHR(10),1),CHR(10),'') SCAN_NAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan policy used :',2),CHR(10),1),CHR(10),'') SCAN_POLICY_USED
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan Start Date : ',2),CHR(10),1),CHR(10),'') SCAN_START_DATE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan type : ',2),CHR(10),1),CHR(10),'') SCAN_TYPE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scanner OS : ',2),CHR(10),1),CHR(10),'') SCANNER_OS
,v.SEVERITY_ID
,'SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS' as SOURCE
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS v
WHERE v.PLUGIN_ID = '19506' -- Nessus Scan Information

UNION ALL

select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'Backports : ',2),CHR(10),1),CHR(10),'') BACKPORTS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Credentialed checks : ',2),CHR(10),1),CHR(10),'') CREDENTIALED_CHECK_DETAIL
,SUBSTRING(CREDENTIALED_CHECK_DETAIL,1,3) CREDENTIALED_CHECK
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,v.MACADDRESS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus build : ',2),CHR(10),1),CHR(10),'') NESSUS_BUILD
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus version : ',2),CHR(10),1),CHR(10),'') NESSUS_VERSION
,v.NETBIOSNAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Patch management checks : ',2),CHR(10),1),CHR(10),'') PATCH_MANAGEMENT_CHECKS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Plugin feed version : ',2),CHR(10),1),CHR(10),'') PLUGIN_FEED_VERSION
,v.PLUGIN_ID
--,v.PLUGINTEXT
,v.PORT
,v.REPORTDATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan name : ',2),CHR(10),1),CHR(10),'') SCAN_NAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan policy used :',2),CHR(10),1),CHR(10),'') SCAN_POLICY_USED
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan Start Date : ',2),CHR(10),1),CHR(10),'') SCAN_START_DATE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan type : ',2),CHR(10),1),CHR(10),'') SCAN_TYPE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scanner OS : ',2),CHR(10),1),CHR(10),'') SCANNER_OS
,v.SEVERITY_ID
,'SEC_VW_CCIC_TENABLE_MITIGATED_INFO' as SOURCE
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_MITIGATED_INFO v
WHERE v.PLUGIN_ID = '19506' -- Nessus Scan Information

UNION ALL

select DISTINCT
REPLACE(split_part(split_part(v.PLUGINTEXT,'Backports : ',2),CHR(10),1),CHR(10),'') BACKPORTS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Credentialed checks : ',2),CHR(10),1),CHR(10),'') CREDENTIALED_CHECK_DETAIL
,SUBSTRING(CREDENTIALED_CHECK_DETAIL,1,3) CREDENTIALED_CHECK
,v.DNSNAME
,v.HOSTUNIQUENESS
,v.IP
,v.MACADDRESS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus build : ',2),CHR(10),1),CHR(10),'') NESSUS_BUILD
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Nessus version : ',2),CHR(10),1),CHR(10),'') NESSUS_VERSION
,v.NETBIOSNAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Patch management checks : ',2),CHR(10),1),CHR(10),'') PATCH_MANAGEMENT_CHECKS
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Plugin feed version : ',2),CHR(10),1),CHR(10),'') PLUGIN_FEED_VERSION
,v.PLUGIN_ID
--,v.PLUGINTEXT
,v.PORT
,v.REPORTDATE
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan name : ',2),CHR(10),1),CHR(10),'') SCAN_NAME
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan policy used :',2),CHR(10),1),CHR(10),'') SCAN_POLICY_USED
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan Start Date : ',2),CHR(10),1),CHR(10),'') SCAN_START_DATE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scan type : ',2),CHR(10),1),CHR(10),'') SCAN_TYPE
,REPLACE(split_part(split_part(v.PLUGINTEXT,'Scanner OS : ',2),CHR(10),1),CHR(10),'') SCANNER_OS
,v.SEVERITY_ID
,'SEC_VW_CCIC_TENABLE_MITIGATED_VULNS' as SOURCE
,v.UUID
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_MITIGATED_VULNS v
WHERE v.PLUGIN_ID = '19506' -- Nessus Scan Information

) t
;
create or replace secure view VW_OAPRGMRPT_DASHDATA(
	ACRONYM,
	"OA Ready",
	OA_STATUS,
	"ResidualRisk",
	"TotalAssets",
	"Asset Risk Tolerance",
	OATO_CATEGORY,
	HVASTATUS,
	MEFSTATUS,
	FIPS_199_OVERALL_IMPACT_RATING,
	PII_PHI,
	FINANCIAL_SYSTEM,
	COMPONENT,
	"DevSecOPS / CSM",
	GROUP_ACRONYM,
	IN_CMS_CLOUD,
	LAST_ACT_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_DATE,
	IS_SECURITYHUB_ENABLED,
	SYSTEM,
	TLC_PHASE,
	"Vuln Risk Tolerance",
	"Resiliency Score",
	"Is_MarketPlace"
) COMMENT='Gather system info directly from CFACTS table and same view on rpt schema is used for OA dashbord'
 as(
WITH ResiliencyScoreCte as (select a.TRACKING_ID,
          SUM(IFF(eRiskLevel.Value='Critical',45,IFF(eRiskLevel.Value='High',30,IFF(eRiskLevel.Value='Moderate',15,IFF(eRiskLevel.Value='Low',10,1))))) as ResiliencyScore										
          FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE a												
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_POAMS as pa on a.ContentId=pa.Authorization_Package_POAMs_ContentId												
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS as p ON p.ContentId=pa.POAMs_Authorization_Package_ContentId												
          LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS_WEAKNESS_RISK_LEVEL_1 as pRiskLevel on pRiskLevel.ParentContentId = p.ContentId												
          LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_RISK_LEVEL_1 as eRiskLevel on eRiskLevel.ID = pRiskLevel.Value
          LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS_OVERALL_STATUS as ps ON ps.ParentContentId=p.ContentId												
          LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_STATUS_9 as eps ON eps.Id=ps.Value						
          where eps.Value in ('Delayed', 'Ongoing', 'Draft') GROUP BY a.TRACKING_ID),
    CurAWSAssetTotalCte as (select count(distinct VW.INSTANCEID) awsAssetTotal, VW.PRIMARY_FISMA_ID_DERIVED
                              from APP_CDM.SHARED.SEC_VW_HWAM_AWS VW
                              where VW.InstanceStatus not like '%stop%'
                              group by VW.PRIMARY_FISMA_ID_DERIVED),
    LastMonthAssetTotalCte as (select SS.PRIMARY_FISMA_ID, count(distinct SS.INSTANCEID) as lstMnthTotCnt
           from CORE.OATO_HWAM_MONTHLY_DATA SS
           where SS.InstanceStatus not like '%stop%'
           and SS.MONTH_END_DATE=last_day(dateadd('MONTH', -1, current_date()),'month')
           GROUP BY SS.PRIMARY_FISMA_ID),
    MefStatusCte as (select distinct ap.ContentId, listagg(e_ap_MEF.value,',') as mefstatus
          FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap
          left join APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_MISSION_ESSENTIAL_FUNCTIONS_ ap_mef on ap_mef.ParentContentId=ap.ContentId
          left join APP_CFACTS.SHARED.SEC_VW_ENUM_MISSION_ESSENTIAL_FUNCTIONS_ e_ap_MEF on e_ap_MEF.Id=ap_mef.value
          group by ap.ContentId),
    PackageTypeCte as (select ap.ContentId, e_ap_pt.Value as packagetype
          FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap
          left join APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_PACKAGE_TYPE ap_pt on ap_pt.ParentContentId = ap.ContentId
          left join APP_CFACTS.SHARED.SEC_VW_ENUM_PACKAGE_TYPE e_ap_pt ON e_ap_pt.Id = ap_pt.value
          group by ap.ContentId, e_ap_pt.Value),		  
    InfoSysTypeCte as (select ap.ContentId, e_ap_ist.Value as infosystype
          FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap
          left join APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_INFORMATION_SYSTEM_TYPE ap_ist on ap_ist.ParentContentId = ap.ContentId
          left join APP_CFACTS.SHARED.SEC_VW_ENUM_INFORMATION_SYSTEM_TYPE e_ap_ist on e_ap_ist.Id = ap_ist.value
          group by ap.ContentId, e_ap_ist.Value),
	TotalPOAMSRBDCte as (select ap.ContentId, count(*) as residualRisk
          FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap 
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS_AUTHORIZATION_PACKAGE_X_AUTHORIZATION_PACKAGE_POAMS pa ON pa.Authorization_Package_POAMs_ContentId=ap.ContentId
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS p ON p.ContentId=pa.POAMs_Authorization_Package_ContentId
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMS_RISK_ACCEPTANCE_RBD_POAMS_X_RISK_ACCEPTANCE_RBD_POAMS pr ON p.ContentId=pr.POAMs_Risk_Acceptance_RBD_POAMs_ContentId
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_RISK_ACCEPTANCE_RBD r on r.ContentId=pr.Risk_Acceptance_RBD_POAMs_ContentId
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_RISK_ACCEPTANCE_RBD_OVERALL_STATUS rs ON rs.ParentContentId=r.ContentId
          INNER JOIN APP_CFACTS.SHARED.SEC_VW_ENUM_RBD_OVERALL_STATUS ers on rs.Value=ers.Id
          Where ers.Value='Approved with Signatures'
          group by ap.ContentId),    
    GroupAcronymCte as (SELECT ap.Acronym, g.Group_Acronym as groupacronym
          FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package ap
          JOIN APP_CFACTS.SHARED.SEC_VW_Division_Authorization_Packages_x_Authorization_Package_Office dapcx on dapcx.Authorization_Package_Office_ContentId = ap.ContentId
          JOIN APP_CFACTS.SHARED.SEC_VW_Division div on div.ContentId = dapcx.Division_Authorization_Packages_ContentId
          JOIN APP_CFACTS.SHARED.SEC_VW_Group_Division_x_Division_Group gdx on gdx.Division_Group_ContentId = div.ContentId
          JOIN APP_CFACTS.SHARED.SEC_VW_group g on g.ContentId = gdx.Group_Division_ContentId
          JOIN APP_CFACTS.SHARED.SEC_VW_Component c on c.Component_Acronym = ap.Component_Acronym),
    OACategoryCte as (select ap.Acronym Acronym,
                    (IFF(((ehvalst.value IS NOT NULL and ehvalst.value = 'Yes')
                    or (Len(IFF(contains(mefstatusTbl.mefstatus, 'N/A'),'',(iff(len(mefstatusTbl.mefstatus)>0,'Yes','')))) > 0)
                    or (ersc.value IS NOT NULL and ersc.value = 'High')), 3,
                    IFF((((PIIMainEnum.value IS NOT NULL AND PIIMainEnum.value='Yes') OR 
                          (PHIMainEnum.value IS NOT NULL AND PHIMainEnum.value='Yes'))
                  or (efs.value IS NOT NULL and efs.value = 'Yes')
                  or (ersc.value IS NOT NULL and ersc.value = 'Moderate')),2,1))) as OATO_Category
         from APP_CFACTS.SHARED.SEC_VW_Authorization_Package as ap
         left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category as aprsc on aprsc.ParentContentId=ap.ContentId
         left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list as aphvalst on aphvalst.ParentContentId=ap.ContentId
         left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Financial_System as apfs on apfs.ParentContentId=ap.ContentId 
         left join APP_CFACTS.SHARED.SEC_VW_enum_Security_Category as ersc on ersc.Id = aprsc.value 
         left join APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo as ehvalst on ehvalst.Id = aphvalst.value
         left join MefStatusCte as mefStatusTbl on mefStatusTbl.contentId=ap.contentId
         LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_the_PII_that_the_system_collects_main PIIMain ON PIIMain.ParentContentId=ap.ContentId
         LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Does_the_system_support_the_activities_o PHIMain ON PHIMain.ParentContentId=ap.ContentId
         LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Is_the_PII_that_the_system_collects_main PIIMainEnum ON PIIMainEnum.Id=PIIMain.Value
         LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Does_the_system_support_the_activities_o PHIMainEnum ON PHIMainEnum.Id=PHIMain.Value
         left join APP_CFACTS.SHARED.SEC_VW_enum_Financial_System as efs on efs.Id = apfs.value),
   AVulnRiskToleranceCte as (SELECT VW.PRIMARY_FISMA_ID_DERIVED,V.INSTANCEID,
                  CAST(SUM(IFF((v.exploitAvailable='Yes'), (2*(datediff(days, v.firstseen, v.lastseen))*(IFF(v.BASESCORE='',1,to_double(v.BASESCORE)))*OATO_Category),
             ((datediff(days, v.firstseen, v.lastseen))*(IFF(v.BASESCORE='',1,to_double(v.BASESCORE)))*OATO_Category))) / (IFF(COUNT(1)=0,1,COUNT(1))) AS DECIMAL(8,2)) as AVRT
            FROM (select distinct INSTANCEID,CVE,BASESCORE,min(FIRSTSEEN) FIRSTSEEN,max(LASTSEEN) LASTSEEN,EXPLOITAVAILABLE 
                    from APP_TENABLE.SHARED.SEC_VW_VULN_WKFINDINGS -- 230824 changed DB name from TENABLE to APP_TENABLE 
                    where SEVERITY_NAME !='Info' and cve is not null 
                    group by INSTANCEID,cve,basescore,EXPLOITAVAILABLE) v
          JOIN APP_CDM.SHARED.SEC_VW_HWAM_AWS VW using(INSTANCEID)
          JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE AP on AP.IDUID=VW.PRIMARY_FISMA_ID_DERIVED
          JOIN OACategoryCte OA on OA.Acronym = AP.Acronym
          WHERE VW.InstanceStatus not like '%stop%'
          GROUP BY VW.PRIMARY_FISMA_ID_DERIVED,v.INSTANCEID),
    VulnRiskToleranceCte as (SELECT AV.PRIMARY_FISMA_ID_DERIVED
                  ,cast(AV.total_avrt/IFF(CA.awsAssetTotal=0,1,CA.awsAssetTotal) as decimal(10,2)) as VRT 
          FROM (select PRIMARY_FISMA_ID_DERIVED,SUM(IFNULL(AVRT,0)) total_avrt from AVulnRiskToleranceCte GROUP BY PRIMARY_FISMA_ID_DERIVED) AV
          JOIN CurAWSAssetTotalCte CA using(PRIMARY_FISMA_ID_DERIVED)
          ),
    CloudSrvProviderCte as (select ap.ContentId, concat('[',listagg(ecsp1.value,', ') within group (order by ap.ContentId), ']') as CldSrvcPrvd
              from APP_CFACTS.SHARED.SEC_VW_Authorization_Package as ap 
                    left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Cloud_Service_Provider_1 as apcsp1 on apcsp1.ParentContentId=ap.ContentId 
                    left join APP_CFACTS.SHARED.SEC_VW_enum_Cloud_Service_Provider_1 as ecsp1 on ecsp1.Id = apcsp1.value     
              group by ap.ContentId)          
SELECT 
       ap.Acronym Acronym    
    ,eoardy.value as "OA Ready"
    ,eoastat.value OA_Status
	,IFNULL(totalPoamsRBDTbl.residualRisk, 0) as "ResidualRisk"
    ,(IFNULL(cAWSAsstTbl.awsAssetTotal,0)) as "TotalAssets"
    ,CAST(((IFNULL(lstMnthAsstTbl.lstMnthTotCnt,0) - IFNULL(cAWSAsstTbl.awsAssetTotal,0))*100.00)/IFNULL(lstMnthAsstTbl.lstMnthTotCnt,1) AS DECIMAL(8,2)) as "Asset Risk Tolerance"
    ,OACategoryTbl.OATO_Category as OATO_Category
    ,ehvalst.value as HVAStatus
    ,IFF(contains(mefstatusTbl.mefstatus, 'N/A'),'NULL',(iff(len(mefstatusTbl.mefstatus)>0,'Yes','NULL'))) as MEFStatus
    ,ersc.value as FIPS_199_Overall_Impact_Rating   
    ,IFF((PIIMainEnum.value IS NOT NULL AND PIIMainEnum.value='Yes') OR 
         (PHIMainEnum.value IS NOT NULL AND PHIMainEnum.value='Yes'), 'Yes', 'NULL') as PII_PHI
    ,efs.value as Financial_System
    ,ap.component_acronym as Component
    ,'TBD' as "DevSecOPS / CSM"
    ,grpAcronymTbl.groupAcronym as Group_Acronym
    ,IFF(CONTAINS(cloudSrvcPrvdTbl.CldSrvcPrvd,'Amazon Web Services'),'Yes','No') as In_CMS_Cloud        
    ,ap.Last_ACT_Date as Last_ACT_Date
    ,ap.Last_ACT_SCA_Final_Report_Date as Last_ACT_SCA_Final_Report_Date
    ,ap.Last_Pentest_Date as Last_Pentest_Date
    ,'No' as Is_SecurityHub_Enabled
    ,ap.Authorization_Package_Name as System
    ,etlcph.value as TLC_Phase
    ,IFNULL(vulnRTTbl.VRT,0) as "Vuln Risk Tolerance"
    ,IFNULL(rtbl.ResiliencyScore,0) as "Resiliency Score"
    ,0 as "Is_MarketPlace" 

 from APP_CFACTS.SHARED.SEC_VW_Authorization_Package as ap
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Ready as apoardy on apoardy.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_OA_Ready as eoardy on eoardy.Id = apoardy.value
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Ready_With_Hosting as apoardywh on apoardywh.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_OA_Ready_With_Hosting as eoardywh on eoardywh.Id = apoardywh.value
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_OA_Status as apoastat on apoastat.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_OA_Status as eoastat on eoastat.Id = apoastat.value
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list as aphvalst on aphvalst.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo as ehvalst on ehvalst.Id = aphvalst.value
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_TLC_Phase as aptlcph on aptlcph.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_XLC_Phase as etlcph on etlcph.Id = aptlcph.value      
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Financial_System as apfs on apfs.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_Financial_System as efs on efs.Id = apfs.value
      left join APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category as aprsc on aprsc.ParentContentId=ap.ContentId 
      left join APP_CFACTS.SHARED.SEC_VW_enum_Security_Category as ersc on ersc.Id = aprsc.value      
      LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_the_PII_that_the_system_collects_main PIIMain ON PIIMain.ParentContentId=ap.ContentId
      LEFT JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Does_the_system_support_the_activities_o PHIMain ON PHIMain.ParentContentId=ap.ContentId
      LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Is_the_PII_that_the_system_collects_main PIIMainEnum ON PIIMainEnum.Id=PIIMain.Value
      LEFT JOIN APP_CFACTS.SHARED.SEC_VW_enum_Does_the_system_support_the_activities_o PHIMainEnum ON PHIMainEnum.Id=PHIMain.Value
	  left join TotalPOAMSRBDCte as totalPoamsRBDTbl on totalPoamsRBDTbl.contentId=ap.contentId
      left join GroupAcronymCte as grpAcronymTbl on grpAcronymTbl.acronym=ap.acronym
      left join OACategoryCte as OACategoryTbl on OACategoryTbl.acronym=ap.acronym
      left join VulnRiskToleranceCte as vulnRTTbl on vulnRTTbl.PRIMARY_FISMA_ID_DERIVED=ap.iduid
      left join ResiliencyScoreCte as rtbl on rtbl.Tracking_id = ap.tracking_id
      left join CurAWSAssetTotalCte as cAWSAsstTbl on cAWSAsstTbl.PRIMARY_FISMA_ID_DERIVED= ap.iduid
      left join LastMonthAssetTotalCte as lstMnthAsstTbl on lstMnthAsstTbl.PRIMARY_FISMA_ID=ap.iduid
      left join MefStatusCte as mefStatusTbl on mefStatusTbl.contentId=ap.contentId
      left join PackageTypeCte as PackageTypeTbl on PackageTypeTbl.contentId=ap.contentId
      left join InfoSysTypeCte as InfoSysTypeTbl on InfoSysTypeTbl.contentId=ap.contentId
      left join CloudSrvProviderCte as cloudSrvcPrvdTbl on cloudSrvcPrvdTbl.contentId=ap.contentId
    where ((etlcph.value = 'Operate' and PackageTypeTbl.packagetype = 'Information System' 
                and (InfoSysTypeTbl.infosystype IN 
                      ('Major Application'
                      ,'General Support System'
                      ,'Minor Application [Stand Alone]'
                      ,'Minor Application [Child]'))))

);
create or replace view VW_PIAHIST(
	ID,
	REPORTID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	AUTHORIZATION_PACKAGE,
	DUE_DATE,
	FINAL_APPROVER,
	FINAL_APPROVER_DATE,
	FINAL_APPROVER_STATUS,
	HHS_PIA_REVIEW_DATE,
	HHS_PIA_STATUS,
	OVERALL_STATUS,
	PIA_TRACKING_ID,
	REVIEW_DATE,
	REVIEW_STATUS,
	REVIEWER,
	SUBMISSION_DATE,
	SUBMISSION_STATUS,
	SUBMITTER,
	SYSTEM_ID
) COMMENT='Return PIA history ingested from CFACTS for every report_id. '
 as
SELECT pia.ID
,csnap.REPORT_ID as ReportID
,csnap.REPORT_DATE as ReportDate
,s.Archer_Tracking_ID
,s.Authorization_Package
,pia.Due_Date
,pia.Final_Approver
,pia.Final_Approver_Date
,pia.Final_Approver_Status
,pia.HHS_PIA_Review_Date
,pia.HHS_PIA_Status
,pia.Overall_Status
,pia.PIA_Tracking_ID
,pia.Review_Date
,pia.Review_Status
,pia.Reviewer
,pia.Submission_Date
,pia.Submission_Status
,pia.Submitter
,pia.SYSTEM_ID
FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) csnap
JOIN CORE.PIAHist pia on pia.REPORT_ID = csnap.REPORT_ID
LEFT OUTER JOIN CORE.VW_Systems s on s.SYSTEM_ID = pia.SYSTEM_ID;
create or replace view VW_PII_SYSTEM_PII_TYPES(
	SYSTEMID,
	AUTHORIZATION_PACKAGE,
	PII_TYPE,
	RECORD_DATE,
	RECORD_SOURCE_DATA,
	PII_CATEGORY,
	LEVEL,
	LEVEL_NUM,
	TYPE_DEFINITION,
	HHS_POLICY_DESCRIPTION
) COMMENT='Shows the type of PII associated with a system.'
 as
SELECT st.SYSTEM_ID as SystemID
,s.Authorization_Package
,dt.PII_Type
,st.record_date
,st.record_source_data
,dc.PII_Category
,dc.Level
,dc.Level_Num
,dt.Type_Definition
,dt.HHS_Policy_Description
FROM CORE.PII_System_PII_Types st
JOIN CORE.PII_DataType dt on dt.PII_TYPE = st.PII_TYPE
JOIN CORE.PII_Category dc on dc.PII_CATEGORY = dt.PII_Category
JOIN CORE.VW_Systems s on s.SYSTEM_ID = st.SYSTEM_ID;
create or replace view VW_POAMHIST(
	ID,
	ACTUAL_COMPLETION_DATE,
	ACTUAL_LABOR_COST,
	ARCHER_TRACKING_ID,
	AUTHORIZATION_PACKAGE,
	CAAT,
	CAAT_ID,
	COST,
	CVE,
	DAYS_OPEN,
	ESTIMATED_COMPLETION_DATE,
	FUNDING_SOURCE,
	LABOR_ESTIMATE,
	OVERALL_STATUS,
	POAM_CLOSED_DATE,
	POAM_ID,
	POAM_OWNER,
	POAM_REVIEWER,
	REPORT_ID,
	REPORT_DATE,
	REVIEW_COMMENTS,
	REVIEW_DATE,
	REVIEW_STATUS,
	SCHEDULED_COMPLETION_DATE,
	SUBMISSION_STATUS,
	SYSTEM_ID,
	TARGET,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_ID,
	WEAKNESS_POC,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_RISK_LEVEL_WEIGHT,
	WEAKNESS_SEVERITY
) COMMENT='Return POAM history ingested from CFACTS for every report_id. '
 as
SELECT
p.ID
,p.ACTUAL_COMPLETION_DATE
,p.ACTUAL_LABOR_COST
,s.ARCHER_TRACKING_ID
,s.AUTHORIZATION_PACKAGE
,p.CAAT
,p.CAAT_ID
,p.COST
,p.CVE
,p.DAYS_OPEN
,p.ESTIMATED_COMPLETION_DATE
,p.FUNDING_SOURCE
,p.LABOR_ESTIMATE
,p.OVERALL_STATUS
,p.POAM_CLOSED_DATE
,p.POAM_ID
,p.POAM_OWNER
,p.POAM_REVIEWER
,p.REPORT_ID
,r.REPORT_DATE
,p.REVIEW_COMMENTS
,p.REVIEW_DATE
,p.REVIEW_STATUS
,p.SCHEDULED_COMPLETION_DATE
,p.SUBMISSION_STATUS
,p.SYSTEM_ID
,p.TARGET
,p.WEAKNESS_CREATION_DATE
,p.WEAKNESS_ID
,p.WEAKNESS_POC
,p.WEAKNESS_RISK_LEVEL
,CASE p.WEAKNESS_RISK_LEVEL
    when 'Critical' then 45
    when 'High' then 30
    when 'Moderate' then 15
    when 'Low' then 10
    Else 0
END as WEAKNESS_RISK_LEVEL_WEIGHT
,p.WEAKNESS_SEVERITY
FROM CORE.POAMHist p
JOIN CORE.REPORT_IDS r on r.REPORT_ID = p.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = p.SYSTEM_ID;
create or replace view VW_POAMS(
	ID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	SYSTEM_ID,
	POAM_ID,
	DAYS_OPEN,
	OVERALL_STATUS,
	AUTHORIZATION_PACKAGE,
	ESTIMATED_COMPLETION_DATE,
	SCHEDULED_COMPLETION_DATE,
	ACTUAL_COMPLETION_DATE,
	CAAT_ID,
	CAAT,
	COST,
	CVE,
	LABOR_ESTIMATE,
	FUNDING_SOURCE,
	POAM_CLOSED_DATE,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_STATUS,
	REVIEW_DATE,
	REVIEW_COMMENTS,
	TARGET,
	SUBMISSION_STATUS,
	WEAKNESS_ID,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY,
	WEAKNESS_POC
) COMMENT='Return all current POAMs.'
 as
SELECT p.ID
,r.Report_Date
,p.Archer_Tracking_ID -- 231102 was from VW_Systems
,p.SYSTEM_ID
,p.POAM_ID
,p.Days_Open
,p.Overall_Status
,p.Authorization_Package -- 231102 was from VW_Systems
,p.Estimated_Completion_Date
,p.Scheduled_Completion_Date
,p.Actual_Completion_Date
,p.CAAT_ID
,p.CAAT
,p.Cost
,p.CVE -- 240731 1641 CR918
,p.Labor_Estimate
,p.Funding_Source
,p.POAM_Closed_Date
,p.POAM_Owner
,p.POAM_Reviewer
,p.Review_Status
,p.Review_Date
,p.Review_Comments
,p.Target
,p.Submission_Status
,p.Weakness_ID
,p.Weakness_Creation_Date
,p.Weakness_Risk_Level
,p.Weakness_Severity
,p.Weakness_POC
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHist p on p.REPORT_ID = r.REPORT_ID
/* 231102 The following was pulling all poam history when all we wanted was the most current shanpshot
ALSO, VW_POAMHist contains Archer_Tracking_ID, Authorization_Package so VW_Systems is not needed
FROM CORE.VW_POAMHist p
join CORE.REPORT_IDS csnap on csnap.REPORT_ID = p.Report_ID 
JOIN CORE.VW_Systems s on s.SYSTEM_ID = p.SYSTEM_ID
*/
;
create or replace view VW_POAMS_OPEN(
	ID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	SYSTEM_ID,
	POAM_ID,
	DAYS_OPEN,
	COMPUTEDDAYSOPEN_TESTING,
	OVERALL_STATUS,
	AUTHORIZATION_PACKAGE,
	ESTIMATED_COMPLETION_DATE,
	SCHEDULED_COMPLETION_DATE,
	ACTUAL_COMPLETION_DATE,
	CAAT_ID,
	CAAT,
	COST,
	LABOR_ESTIMATE,
	FUNDING_SOURCE,
	POAM_CLOSED_DATE,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_STATUS,
	REVIEW_DATE,
	REVIEW_COMMENTS,
	TARGET,
	SUBMISSION_STATUS,
	WEAKNESS_ID,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY,
	WEAKNESS_POC
) COMMENT='Return all current not completed or closed POAMS'
 as
SELECT p.ID
,p.ReportDate
,p.Archer_Tracking_ID
,p.SYSTEM_ID
,p.POAM_ID
,p.Days_Open
,DATEDIFF(d,Weakness_Creation_Date,CURRENT_TIMESTAMP) as ComputedDaysOpen_TESTING
,p.Overall_Status
,p.Authorization_Package
,p.Estimated_Completion_Date
,p.Scheduled_Completion_Date
,p.Actual_Completion_Date
,p.CAAT_ID
,p.CAAT
,p.Cost
,p.Labor_Estimate
,p.Funding_Source
,p.POAM_Closed_Date
,p.POAM_Owner
,p.POAM_Reviewer
,p.Review_Status
,p.Review_Date
,p.Review_Comments
,p.Target
,p.Submission_Status
,p.Weakness_ID
,p.Weakness_Creation_Date
,p.Weakness_Risk_Level
,p.Weakness_Severity
,p.Weakness_POC
FROM CORE.VW_POAMS p
where p.Overall_Status NOT IN -- 250123 CR1071
(
'Closed for System Retired'
,'Completed'
,'Pending Verification'
,'Risk Accepted'
);
create or replace view VW_POAMS_OVERDUE(
	ID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	SYSTEM_ID,
	POAM_ID,
	DAYS_OPEN,
	DAYS_OVERDUE,
	OVERALL_STATUS,
	AUTHORIZATION_PACKAGE,
	ESTIMATED_COMPLETION_DATE,
	SCHEDULED_COMPLETION_DATE,
	ACTUAL_COMPLETION_DATE,
	CAAT_ID,
	CAAT,
	COST,
	LABOR_ESTIMATE,
	FUNDING_SOURCE,
	POAM_CLOSED_DATE,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_STATUS,
	REVIEW_DATE,
	REVIEW_COMMENTS,
	TARGET,
	SUBMISSION_STATUS,
	WEAKNESS_ID,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY,
	WEAKNESS_POC
) COMMENT='Return all current POAMS that passed the estimated Completion Date'
 as
SELECT p.ID
,p.ReportDate
,p.Archer_Tracking_ID
,p.SYSTEM_ID
,p.POAM_ID
,p.Days_Open
,DATEDIFF(d,p.Estimated_Completion_Date,CURRENT_TIMESTAMP) as Days_Overdue
,p.Overall_Status
,p.Authorization_Package
,p.Estimated_Completion_Date
,p.Scheduled_Completion_Date
,p.Actual_Completion_Date
,p.CAAT_ID
,p.CAAT
,p.Cost
,p.Labor_Estimate
,p.Funding_Source
,p.POAM_Closed_Date
,p.POAM_Owner
,p.POAM_Reviewer
,p.Review_Status
,p.Review_Date
,p.Review_Comments
,p.Target
,p.Submission_Status
,p.Weakness_ID
,p.Weakness_Creation_Date
,p.Weakness_Risk_Level
,p.Weakness_Severity
,p.Weakness_POC
FROM CORE.VW_POAMS_Open p
where DATEDIFF(d,p.Estimated_Completion_Date,CURRENT_TIMESTAMP) > 0
;
create or replace view VW_QUARTERLY_FISMA_REPORT_VUL(
	DATACENTER,
	SYSTEM,
	ASSET_ID_TATTOO,
	FQDN,
	NETBIOSNAME,
	CVE,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	INSERT_DATE,
	FIRSTSEEN,
	LASTFOUND,
	DAYSSINCEDISCOVERY,
	DW_ASSET_ID,
	DW_VUL_ID
) COMMENT='Shows all fixed vulnerabilities detail.'
 as
SELECT -- top 1000000 231027 Not needed in SnowFlake. It was necessary in SQL Server when doing sorts
dc.Acronym as DataCenter
,s.Acronym as System
,a.asset_id_tattoo
,aic.fqdn
,aic.netbiosname
,vm.cve
,vm.exploitAvailable
,vm.FISMAseverity
,vm.MitigationStatus
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,vm.INSERT_DATE
,vm.firstSeen
,vm.lastfound
,vm.DaysSinceDiscovery
,a.DW_ASSET_ID
,vm.dw_vul_id
FROM CORE.VW_Assets a
JOIN CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
where lower(vm.MitigationStatus) <> 'fixed' -- and a.Is_Applicable = 1 and vm.DeletionReason IS NULL  
order by dc.Acronym
,s.Acronym
,a.DW_ASSET_ID 
,vm.cve;
create or replace view VW_RAW_HWAM(
	RAW_HWAM_ID,
	VAL_DATACENTER_ACRONYM,
	VAL_SYSTEM_ACRONYM,
	COMMONNAME,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_DATACENTER_ID,
	AWS_PRIMARY_FISMA_ID_TATTOO,
	AWS_INSTANCE_ID,
	AXONIUS_ADAPTER_LIST_LENGTH,
	AXONIUS_ADAPTERS,
	AXONIUS_ADAPTERS_UUID,
	AXONIUS_INTERNAL_AXONIUS_ID,
	BIGFIX_ASSET_ID,
	BIGFIX_ASSET_ID_TATTOO,
	BIGFIX_DATACENTER_ID,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO,
	BIOS_GUID,
	CLOUD_ID,
	CLOUD_PROVIDER,
	COMPUTER_TYPE,
	CONNECTION_LABEL,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DEVICE_MANUFACTURER,
	DEVICE_TYPE,
	DOMAIN_PREFERRED,
	ENVIRONMENT,
	EVENTTIME,
	FIRST_FETCH_TIME,
	FORESCOUT_ASSET_ID_TATTOO,
	FORESCOUT_DATACENTER_ID,
	FORESCOUT_PRIMARY_FISMA_ID,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	INSTANCESTATUS,
	IPV4,
	IPV6,
	IS_FS_MANAGED,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	IS_WINDOWS_SERVER_PREFERRED,
	LABELS,
	LAST_CONFIRMED_TIME,
	LAST_USED_USERS_COMPANY_ASSOCIATION,
	LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_BUILD_PREFERRED,
	OS_CPE,
	OS_DOTTED,
	OS_MAJOR,
	OS_MINOR,
	OS_TYPE_DISTRIBUTION_PREFERRED,
	OS_TYPE_PREFERRED,
	OS_VERSION,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	REPORTDATE,
	ROWDISPOSITION,
	SITECODE_PREFERRED,
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	SOURCE_TOOL,
	SUBNETS_PREFERRED,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TENABLE_ASSET_ID_TATTOO,
	TENABLE_ASSET_TAGS,
	TENABLE_DATACENTER_ID,
	TENABLE_PRIMARY_FISMA_ID_TATTOO,
	TIME_ZONE,
	VIRTUAL_HOST,
	WINDOWS_PATCH_VERSION
) COMMENT='Shows all raw HWAM (AWS,Axonious) feed by snapshot date. '
 as
SELECT
rh.RAW_HWAM_ID
,dc.acronym as VAL_DATACENTER_ACRONYM
,s.acronym as VAL_SYSTEM_ACRONYM
,s.COMMONNAME
,rh.ASSET_ID_TATTOO
,rh.AWS_ACCOUNTID
,rh.AWS_DATACENTER_ID
,rh.AWS_PRIMARY_FISMA_ID_TATTOO
,rh.AWS_INSTANCE_ID
,rh.AXONIUS_ADAPTER_LIST_LENGTH
,rh.AXONIUS_ADAPTERS
,rh.AXONIUS_ADAPTERS_UUID
,rh.AXONIUS_INTERNAL_AXONIUS_ID
,rh.BIGFIX_ASSET_ID
,rh.BIGFIX_ASSET_ID_TATTOO
,rh.BIGFIX_DATACENTER_ID
,rh.BIGFIX_PRIMARY_FISMA_ID_TATTOO
--,rh.BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS
,rh.BIOS_GUID
,rh.CLOUD_ID
,rh.CLOUD_PROVIDER
,rh.COMPUTER_TYPE
,rh.CONNECTION_LABEL
,rh.DATA_ERROR_ARRAY
,rh.DATA_WARNING_ARRAY
,rh.DATACENTER_ID
,rh.DATECOMPLETED
,rh.DEVICE_MANUFACTURER
,rh.DEVICE_TYPE
,rh.DOMAIN_PREFERRED
,rh.ENVIRONMENT
,rh.EVENTTIME
,rh.FIRST_FETCH_TIME
,rh.FORESCOUT_ASSET_ID_TATTOO
--,rh.FORESCOUT_ASSIGNED_LABELS
,rh.FORESCOUT_DATACENTER_ID
,rh.FORESCOUT_PRIMARY_FISMA_ID
,rh.FQDN
,rh.HOSTNAME
,rh.INSERT_DATE
,rh.INSTANCESTATUS
,rh.IPV4
,rh.IPV6
,rh.IS_FS_MANAGED
,rh.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,rh.IS_WINDOWS_SERVER_PREFERRED
,rh.LABELS
,rh.LAST_CONFIRMED_TIME
,rh.LAST_USED_USERS_COMPANY_ASSOCIATION
,rh.LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,rh.MACADDRESS
,rh.MOTHERBOARD
,rh.NETBIOSNAME
,rh.OS
,rh.OS_BUILD_PREFERRED
,rh.OS_CPE
,rh.OS_DOTTED
,rh.OS_MAJOR
,rh.OS_MINOR
,rh.OS_TYPE_DISTRIBUTION_PREFERRED
,rh.OS_TYPE_PREFERRED
,rh.OS_VERSION
,rh.PRIMARY_FISMA_ID_DERIVED
,rh.PRIMARY_FISMA_ID_TATTOO
,rh.REPORTDATE
,rh.ROWDISPOSITION
,rh.SITECODE_PREFERRED
,snap.SNAPSHOT_DATE
,rh.SNAPSHOT_ID
,rh.SOURCE_TOOL
,rh.SUBNETS_PREFERRED
,rh.SYSTEM_ACRONYM
,rh.SYSTEM_ID
,rh.TENABLE_ASSET_ID_TATTOO
,rh.TENABLE_ASSET_TAGS
,rh.TENABLE_DATACENTER_ID
,rh.TENABLE_PRIMARY_FISMA_ID_TATTOO
,rh.TIME_ZONE
,rh.VIRTUAL_HOST
,rh.WINDOWS_PATCH_VERSION
FROM CORE.RAW_HWAM rh
LEFT OUTER JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = rh.DATACENTER_ID
LEFT OUTER JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = rh.SYSTEM_ID
LEFT OUTER JOIN CORE.SNAPSHOT_IDS snap on snap.SNAPSHOT_ID = rh.SNAPSHOT_ID
;
create or replace view VW_RAW_TENABLE_VUL(
	RAW_TENABLE_VUL_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ACCEPT_RISK_RULE_COMMENT,
	ACCEPTRISK,
	ACRSCORE,
	APPLICABILITYCODE,
	ASSET_ID_TATTOO,
	ASSETEXPOSURESCORE,
	AWS_ACCOUNTID,
	AZURE_SUBSCRIPTION_ID,
	BASESCORE,
	BID,
	CHECKTYPE,
	CPE,
	CREDENTIALED_SCAN,
	CUSTOM_SEVERITY,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	CVSSV3TEMPORALSCORE,
	CVSSV3VECTOR,
	CVSSVECTOR,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_DUP_NUMBER,
	DW_VUL_ID,
	EXPLOIT_AVAILABLE,
	EXPLOITEASE,
	EXPLOITFRAMEWORKS,
	FAMILY_ID,
	FAMILY_NAME,
	FAMILY_TYPE,
	FIRST_SEEN,
	FISMASEVERITY,
	HAS_BEEN_MITIGATED,
	HOSTNAME,
	HOSTUNIQUENESS,
	HOSTUUID,
	INSERT_DATE,
	IP,
	IPS,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	KEYDRIVERS,
	LAST_SEEN,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	NUMERIC_SEVERITY,
	OPERATING_SYSTEM,
	PATCHPUB_DATE,
	PLUGIN_ID,
	PLUGIN_INFO,
	PLUGIN_MOD_DATE,
	PLUGIN_NAME,
	PLUGIN_PUB_DATE,
	PLUGINTEXT,
	PORT,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	PROTOCOL,
	RECASTRISK,
	RECASTRISKRULECOMMENT,
	REPORTDATE,
	REPOSITORY_DATAFORMAT,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RISKFACTOR,
	ROWDISPOSITION,
	SCAN_POLICY_NAME,
	SCAN_POLICY_UID,
	SCAN_START_DATE,
	SEEALSO,
	SEVERITY_DESCRIPTION,
	SEVERITY_ID,
	SEVERITY_NAME,
	SNAPSHOT_DATACATEGORY,
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	SOLUTION,
	STATE,
	STIGSEVERITY,
	SYNOPSIS,
	SYSTEM_ID,
	TEMPORAL_SCORE,
	TENABLEUUID,
	UNIQUENESS,
	VERSION,
	VPR_SCORE,
	VPRCONTEXT,
	VULN_PUB_DATE,
	XREF
) COMMENT='shows all raw vulnerability from TENABLE  by snapshot date. '
 as
SELECT
v.RAW_TENABLE_VUL_ID
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,v.APPLICABILITYCODE
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,v.AWS_ACCOUNTID
,v.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,v.BASESCORE
,v.BID
,v.CHECKTYPE
,v.CPE
,v.CREDENTIALED_SCAN
,v.CUSTOM_SEVERITY
,v.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,v.DATA_ERROR_ARRAY
,v.DATA_WARNING_ARRAY
,v.DATACENTER_ID
,v.DATECOMPLETED
,v.DESCRIPTION
,v.DNSNAME
,v.DW_ASSET_ID
,v.DW_DUP_NUMBER
-- 231027 ,v.DW_PLUGIN_ID
,v.DW_VUL_ID
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN
,v.FISMASEVERITY
,v.HAS_BEEN_MITIGATED
,v.HOSTNAME
,v.HOSTUNIQUENESS
,v.HOSTUUID
,v.INSERT_DATE
,v.IP
,v.IPS
,v.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,v.KEYDRIVERS
,v.LAST_SEEN
,v.MACADDRESS
,v.MITIGATIONSTATUS
,v.NETBIOSNAME
,v.NUMERIC_SEVERITY
,v.OPERATING_SYSTEM
,v.PATCHPUB_DATE
,v.PLUGIN_ID
,v.PLUGIN_INFO
,v.PLUGIN_MOD_DATE
,v.PLUGIN_NAME
,v.PLUGIN_PUB_DATE
,v.PLUGINTEXT
,v.PORT
,v.PRIMARY_FISMA_ID_DERIVED
,v.PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,v.RECASTRISKRULECOMMENT
,v.REPORTDATE
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,v.ROWDISPOSITION
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,v.SCAN_START_DATE
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,snap.DATACATEGORY as SNAPSHOT_DATACATEGORY
,snap.SNAPSHOT_DATE
,v.SNAPSHOT_ID
,v.SOLUTION
,v.STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,v.SYSTEM_ID
,v.TEMPORAL_SCORE
,v.TENABLEUUID
,v.UNIQUENESS
-- 231027,v.VAL_ASSET_ID_TATTOO
,v.VERSION
,v.VPR_SCORE
,v.VPRCONTEXT
,v.VULN_PUB_DATE
,v.XREF
FROM CORE.RAW_TENABLE_VUL v
LEFT OUTER JOIN CORE.SNAPSHOT_IDS snap on snap.SNAPSHOT_ID = v.SNAPSHOT_ID
LEFT OUTER JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = v.DATACENTER_ID
LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = v.SYSTEM_ID
;
create or replace view VW_RAW_TENABLE_VUL_CASES(
	SNAPSHOT_ID,
	SNAPSHOT_DATE,
	DATACATEGORY,
	DATACENTER_ID,
	IP,
	MACADDRESS,
	DNSNAME,
	TENABLEUUID,
	NETBIOSNAME,
	PRIMARY_FISMA_ID_TATTOO,
	ASSET_ID_TATTOO,
	HOSTNAME,
	TOTAL
) COMMENT='Returns history of total raw tenable records based on diferrent cobination of fields (e.g. datacenter_id, IPv4) data provided or not. '
 as
SELECT 
snap.snapshot_id
,snap.snapshot_date::date as SNAPSHOT_DATE
,snap.datacategory
,case coalesce(NULLIF(r.DATACENTER_ID,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as DATACENTER_ID
,case coalesce(NULLIF(r.IP,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as IP
,case coalesce(NULLIF(r.MACADDRESS,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as MACADDRESS
,case coalesce(NULLIF(r.DNSNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as DNSNAME
,case coalesce(NULLIF(r.TENABLEUUID,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as TENABLEUUID
,case coalesce(NULLIF(r.NETBIOSNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as NETBIOSNAME
,case coalesce(NULLIF(r.PRIMARY_FISMA_ID_TATTOO,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as PRIMARY_FISMA_ID_TATTOO
,case coalesce(NULLIF(r.ASSET_ID_TATTOO,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as ASSET_ID_TATTOO
,case coalesce(NULLIF(r.HOSTNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End as HOSTNAME
,count(1) Total
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
--WHERE r.temp_dw_asset_id = 0
--where r.compliance_check_name IS NOT NULL
--Where r.SNAPSHOT_ID = 250 and r.APPLICABILITYCODE <> 'Excluding AWS VUL from CCIC VUL FEED'
GROUP BY
snap.snapshot_id
,snap.snapshot_date::date -- SNAPSHOT_DATE
,snap.datacategory
,case coalesce(NULLIF(r.DATACENTER_ID,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- DATACENTER_ID
,case coalesce(NULLIF(r.IP,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- IP
,case coalesce(NULLIF(r.MACADDRESS,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- MACADDRESS
,case coalesce(NULLIF(r.DNSNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- DNSNAME
,case coalesce(NULLIF(r.TENABLEUUID,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- TENABLEUUID
,case coalesce(NULLIF(r.NETBIOSNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- NETBIOSNAME
,case coalesce(NULLIF(r.PRIMARY_FISMA_ID_TATTOO,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- PRIMARY_FISMA_ID_TATTOO
,case coalesce(NULLIF(r.ASSET_ID_TATTOO,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- ASSET_ID_TATTOO
,case coalesce(NULLIF(r.HOSTNAME,''),'ItsNull')
    when 'ItsNull' then '0'
    Else '1'
End -- HOSTNAME
ORDER BY snap.snapshot_date::date desc
,snap.snapshot_id desc
,snap.datacategory
,count(1) desc;
create or replace view VW_REPORTSNAPSHOTS(
	REPORTSNAPSHOTID,
	DATACATEGORY,
	REPORT_ID,
	REPORT_DATE,
	IS_ENDOFMONTH,
	SNAPSHOT_ID,
	SNAPSHOT_DATE
) COMMENT='Show all report_id and snapshot_id relation with datetime and datacatagory. '
 as
SELECT t.REPORT_ID as ReportSnapshotID
,t.DATACATEGORY
,t.REPORT_ID
,t.REPORT_DATE
,t.IS_ENDOFMONTH
,t.REPORT_ID as SNAPSHOT_ID
,t.REPORT_DATE as SNAPSHOT_DATE
--,snap.MIN_DATE
--,snap.MAX_DATE
FROM 
(
select REPORT_ID,REPORT_DATE,Is_endOfMonth,'CFACTS' as DATACATEGORY from CORE.REPORT_IDS where IS_VIABLE = 1 -- 240607 EBF
UNION ALL
select REPORT_ID,REPORT_DATE,Is_endOfMonth,'HWAM' as DATACATEGORY from CORE.REPORT_IDS where IS_VIABLE = 1 -- 240607 EBF
UNION ALL
select REPORT_ID,REPORT_DATE,Is_endOfMonth,'VUL' as DATACATEGORY from CORE.REPORT_IDS where IS_VIABLE = 1 -- 240607 EBF
) t
order by t.REPORT_ID desc;
create or replace view VW_SYSTEMS(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='CRITICAL; View reports FISMA system/datacenter information from CFACTS. It is used throughout CRM\t'
 as
SELECT
s.ACRONYM
,s.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,s.AUTH_COMMENTS
,s.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,s.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
--,(select substring(LISTAGG(distinct ', ' || acc.AWS_ACCOUNTID , ''),2) FROM CORE.SYSTEMSAWSACCOUNTS acc WHERE acc.SYSTEM_ID = s.SYSTEM_ID) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,s.BUSINESS_OWNER
,s.CIO
,s.CISO
,s.CISO_REVIEW_DATE
,s.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_DESCRIPTION
,s.COMPONENT_NAME
,s.COMPONENT_RISK_REPORTS_OVERSIGHT
,s.CONTINGENCYEXPIRATIONDATE
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,s.CP_TEST_DATE
,s.CP_TEST_RESULTS
,s.CRA
,s.CRA_REVIEW_DATE
,s.CYBERVET
,s.DATE_AUTH_MEMO_EXPIRES
,s.DATE_AUTH_MEMO_SIGNED
,s.DATEDELETED
,s.DATEMODIFIED
,s.DCISO
,s.DIVISION_ACRONYM
,s.DIVISION_DESCRIPTION
,s.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,s.E_AUTH_EXP_DATE
,s.E_AUTH_LEVEL
,s.E_AUTH_RISK_ASSESSMENT_DATE
,s.FINANCIAL_SYSTEM
,s.FIPS_199_AVAILABILITY_RATING
,s.FIPS_199_CONFIDENTIALITY_RATING
,s.FIPS_199_INTEGRITY_RATING
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.FIRST_PUBLISHED_DATE
,s.FISMA_SYSTEM
,s.GROUP_ACRONYM
,s.GROUP_DESCRIPTION
,s.GROUP_NAME
,s.HVA_SCORE
,s.HVASTATUS
,s.IN_CMS_CLOUD
,s.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,s.IS_DATACENTER
,s.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_HIGHRISKSYSTEM
,s.IS_MARKETPLACE
,s.IS_OA_READY
,s.IS_OPERATIONALSYSTEM
,s.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_SECURITYHUB_ENABLED
,s.ISRA_REVIEW_DATE
,s.ISRA_STATUS
,s.ISSO
,s.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,s.ISSOCS
,s.LAST_ACT_DATE
,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_ACT_SCA_FINAL_REPORT_DATE
,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_PENTEST_DATE
,s.MEF
,s.MEF_CONTEXT
,s.MEFSTATUS
,s.NEXT_REQUIRED_CP_TEST_DATE
,s.OA_STATUS
,s.OATO_CATEGORY
,s.OPERATED_BY -- 250103 CR1059
,s.PACKAGE_TYPE
,s.PIA_014 -- 230621
,s.PIA_EXPIRATION_DATE
,s.PII_PHI
,s.PRIMARY_ISSO
,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,s.SCA
,s.SCA_DATE
,s.SDM
,s.SOP_REVIEW_DATE
,s.STE_DATE
,s.SYSTEM_DESCRIPTION
,s.SYSTEM_ID
,s.TLC_PHASE
,coalesce(a.TOTALASSETS,0) -- 231017 added coalesce
,s.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
WHERE s.IS_PHANTOMSYSTEM = 0 and (s.IS_EXCLUDEFROMREPORTING = 0 or (s.Is_ExcludeFromReporting = 1 and s.Acronym = 'HVA' and a.TotalAssets > 0));
create or replace view VW_SYSTEMSUMMARY(
	ID,
	ACRONYM,
	ASSETRISKTOLERANCE,
	ASSETS,
	HWAMRAWAWS,
	HWAMRAWBIGFIX,
	HWAMRAWFORESCOUT,
	IS_ENDOFMONTH,
	KEV_FIXED_MONTHTODATE,
	KEV_FIXED_TODAY,
	KEV_OPEN,
	KEV_REOPENED,
	PREVASSETS,
	REPORT_DATE,
	REPORT_ID,
	RESIDUALRISK,
	RESILIENCYSCORE,
	SCANNABLEASSETS,
	SUM_ASSET_VULNRISKTOLERANCE,
	SYSTEM_ID,
	VUL_CRITICAL_FIXED_TODAY,
	VUL_CRITICAL_OPEN,
	VUL_CRITICAL_REOPENED,
	VUL_DELETED_TODAY,
	VUL_HIGH_FIXED_TODAY,
	VUL_HIGH_OPEN,
	VUL_HIGH_REOPENED,
	VUL_INACTIVE_ASSET_TODAY,
	VUL_LOW_FIXED_TODAY,
	VUL_LOW_OPEN,
	VUL_LOW_REOPENED,
	VUL_MEDIUM_FIXED_TODAY,
	VUL_MEDIUM_OPEN,
	VUL_MEDIUM_REOPENED,
	VULCRITICAL,
	VULCRITICAL_GT15_LTE60DAYS,
	VULCRITICAL_GT30_LTE60DAYS,
	VULCRITICAL_GT60DAYS,
	VULCRITICAL_GTE15DAYS,
	VULCRITICAL_LTE15DAYS,
	VULCRITICAL_LTE30DAYS,
	VULDELETED,
	VULHIGH,
	VULHIGH_GT30_LTE60DAYS,
	VULHIGH_GT60DAYS,
	VULHIGH_LTE30DAYS,
	VULLOW,
	VULMEDIUM,
	VULNRISKTOLERANCE,
	VULRAW,
	VULRAW_CRITICAL,
	VULRAW_HIGH,
	VULRAW_LOW,
	VULRAW_MEDIUM,
	VULUNIQUECRITICAL_GT15_LTE60DAYS,
	VULUNIQUECRITICAL_GT30_LTE60DAYS,
	VULUNIQUECRITICAL_GT60DAYS,
	VULUNIQUECRITICAL_GTE15DAYS,
	VULUNIQUEHIGH_GT30_LTE60DAYS,
	VULUNIQUEHIGH_GT60DAYS,
	VULUNIQUELOW,
	VULUNIQUEMEDIUM
) COMMENT='Return system level total for all report_id to show history of system summary changes.'
 as
SELECT
ss.ID
,s.ACRONYM
,ss.ASSETRISKTOLERANCE
,ss.ASSETS
,ss.HWAMRAWAWS
,ss.HWAMRAWBIGFIX
,ss.HWAMRAWFORESCOUT
,r.IS_ENDOFMONTH
,ss.KEV_FIXED_MONTHTODATE
,ss.KEV_FIXED_TODAY
,ss.KEV_OPEN
,ss.KEV_REOPENED
,ss.PREVASSETS
,r.REPORT_DATE
,ss.REPORT_ID
,ss.RESIDUALRISK
,ss.RESILIENCYSCORE
,ss.SCANNABLEASSETS
,ss.SUM_ASSET_VULNRISKTOLERANCE
,ss.SYSTEM_ID
,ss.VUL_CRITICAL_FIXED_TODAY -- 240222 CR840 
,ss.VUL_CRITICAL_OPEN -- 240222 CR840 
,ss.VUL_CRITICAL_REOPENED -- 240222 CR840 
,ss.VUL_DELETED_TODAY -- 240222 CR840 
,ss.VUL_HIGH_FIXED_TODAY -- 240222 CR840 
,ss.VUL_HIGH_OPEN -- 240222 CR840 
,ss.VUL_HIGH_REOPENED -- 240222 CR840 
,ss.VUL_INACTIVE_ASSET_TODAY -- 240222 CR840 
,ss.VUL_LOW_FIXED_TODAY -- 240222 CR840 
,ss.VUL_LOW_OPEN -- 240222 CR840 
,ss.VUL_LOW_REOPENED -- 240222 CR840 
,ss.VUL_MEDIUM_FIXED_TODAY -- 240222 CR840 
,ss.VUL_MEDIUM_OPEN -- 240222 CR840 
,ss.VUL_MEDIUM_REOPENED -- 240222 CR840 
-- 240222 CR840 ,ss.VULCRITICAL
,(ss.VUL_CRITICAL_OPEN + ss.VUL_CRITICAL_REOPENED) as VULCRITICAL -- 240222 CR840
,ss.VULCRITICAL_GT15_LTE60DAYS
,ss.VULCRITICAL_GT30_LTE60DAYS
,ss.VULCRITICAL_GT60DAYS
,ss.VULCRITICAL_GTE15DAYS
,ss.VULCRITICAL_LTE15DAYS
,ss.VULCRITICAL_LTE30DAYS
-- 240222 CR840 ,ss.VULCRITICALREMEDIATED -- was never set by SP_CRM_WRITE_SUMMARY_TABLES use VUL_CRITICAL_FIXED_TODAY
,ss.VULDELETED
-- 240222 CR840 ,ss.VULHIGH
,(ss.VUL_HIGH_OPEN + ss.VUL_HIGH_REOPENED) as VULHIGH -- 240222 CR840
,ss.VULHIGH_GT30_LTE60DAYS
,ss.VULHIGH_GT60DAYS
,ss.VULHIGH_LTE30DAYS
-- 240222 CR840 ,ss.VULHIGHREMEDIATED -- was never set by SP_CRM_WRITE_SUMMARY_TABLES use VUL_HIGH_FIXED_TODAY
-- 240222 CR840 ,ss.VULLOW
,(ss.VUL_LOW_OPEN + ss.VUL_LOW_REOPENED) as VULLOW -- 240222 CR840
-- 240222 CR840 ,ss.VULMEDIUM
,(ss.VUL_MEDIUM_OPEN + ss.VUL_MEDIUM_REOPENED) as VULMEDIUM -- 240222 CR840
,ss.VULNRISKTOLERANCE
,ss.VULRAW
,ss.VULRAW_CRITICAL
,ss.VULRAW_HIGH
,ss.VULRAW_LOW
,ss.VULRAW_MEDIUM
,ss.VULUNIQUECRITICAL_GT15_LTE60DAYS
,ss.VULUNIQUECRITICAL_GT30_LTE60DAYS
,ss.VULUNIQUECRITICAL_GT60DAYS
,ss.VULUNIQUECRITICAL_GTE15DAYS
,ss.VULUNIQUEHIGH_GT30_LTE60DAYS
,ss.VULUNIQUEHIGH_GT60DAYS
,ss.VULUNIQUELOW
,ss.VULUNIQUEMEDIUM
FROM CORE.SYSTEMSUMMARY ss
JOIN CORE.SYSTEMS s on s.SYSTEM_ID = ss.SYSTEM_ID
JOIN CORE.REPORT_IDS r on r.REPORT_ID = ss.REPORT_ID
;
create or replace view VW_SYSTEMS_HHS_DATACALL_CHRIS(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) as
SELECT
s.ACRONYM
,s.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,s.AUTH_COMMENTS
,s.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,s.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,s.BUSINESS_OWNER
,s.CIO
,s.CISO
,s.CISO_REVIEW_DATE
,s.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_DESCRIPTION
,s.COMPONENT_NAME
,s.COMPONENT_RISK_REPORTS_OVERSIGHT
,s.CONTINGENCYEXPIRATIONDATE
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,s.CP_TEST_DATE
,s.CP_TEST_RESULTS
,s.CRA
,s.CRA_REVIEW_DATE
,s.CYBERVET
,s.DATE_AUTH_MEMO_EXPIRES
,s.DATE_AUTH_MEMO_SIGNED
,s.DATEDELETED
,s.DATEMODIFIED
,s.DCISO
,s.DIVISION_ACRONYM
,s.DIVISION_DESCRIPTION
,s.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,s.E_AUTH_EXP_DATE
,s.E_AUTH_LEVEL
,s.E_AUTH_RISK_ASSESSMENT_DATE
,s.FINANCIAL_SYSTEM
,s.FIPS_199_AVAILABILITY_RATING
,s.FIPS_199_CONFIDENTIALITY_RATING
,s.FIPS_199_INTEGRITY_RATING
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.FIRST_PUBLISHED_DATE
,s.FISMA_SYSTEM
,s.GROUP_ACRONYM
,s.GROUP_DESCRIPTION
,s.GROUP_NAME
,s.HVA_SCORE
,s.HVASTATUS
,s.IN_CMS_CLOUD
,s.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,s.IS_DATACENTER
,s.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_HIGHRISKSYSTEM
,s.IS_MARKETPLACE
,s.IS_OA_READY
,s.IS_OPERATIONALSYSTEM
,s.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_SECURITYHUB_ENABLED
,s.ISRA_REVIEW_DATE
,s.ISRA_STATUS
,s.ISSO
,s.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,s.ISSOCS
,s.LAST_ACT_DATE
,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_ACT_SCA_FINAL_REPORT_DATE
,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_PENTEST_DATE
,s.MEF
,s.MEF_CONTEXT
,s.MEFSTATUS
,s.NEXT_REQUIRED_CP_TEST_DATE
,s.OA_STATUS
,s.OATO_CATEGORY
,s.PACKAGE_TYPE
,s.PIA_014 -- 230621
,s.PIA_EXPIRATION_DATE
,s.PII_PHI
,s.PRIMARY_ISSO
,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,s.SCA
,s.SCA_DATE
,s.SDM
,s.SOP_REVIEW_DATE
,s.STE_DATE
,s.SYSTEM_DESCRIPTION
,s.SYSTEM_ID
,s.TLC_PHASE
,coalesce(a.TOTALASSETS,0) as TOTALASSETS-- 231017 added coalesce
,s.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
;
create or replace view VW_SYSTEMS_WORKAROUND(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='CRITICAL; View reports FISMA system/datacenter information from CFACTS. It is used throughout CRM\t'
 as
SELECT
s.ACRONYM
,sh.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,sh.AUTH_COMMENTS
,sh.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,sh.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
--,(select substring(LISTAGG(distinct ', ' || acc.AWS_ACCOUNTID , ''),2) FROM CORE.SYSTEMSAWSACCOUNTS acc WHERE acc.SYSTEM_ID = s.SYSTEM_ID) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,sh.BUSINESS_OWNER
,sh.CIO
,sh.CISO
,s.CISO_REVIEW_DATE
,sh.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,sh.COMPONENT_ACRONYM
,sh.COMPONENT_DESCRIPTION
,sh.COMPONENT_NAME
,sh.COMPONENT_RISK_REPORTS_OVERSIGHT
,sh.CONTINGENCYEXPIRATIONDATE
,sh.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,sh.CP_TEST_DATE
,sh.CP_TEST_RESULTS
,sh.CRA
,s.CRA_REVIEW_DATE
,sh.CYBERVET
,sh.DATE_AUTH_MEMO_EXPIRES
,sh.DATE_AUTH_MEMO_SIGNED
,sh.DATEDELETED
,sh.DATEMODIFIED
,sh.DCISO
,sh.DIVISION_ACRONYM
,sh.DIVISION_DESCRIPTION
,sh.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,sh.E_AUTH_EXP_DATE
,sh.E_AUTH_LEVEL
,sh.E_AUTH_RISK_ASSESSMENT_DATE
,sh.FINANCIAL_SYSTEM
,sh.FIPS_199_AVAILABILITY_RATING
,sh.FIPS_199_CONFIDENTIALITY_RATING
,sh.FIPS_199_INTEGRITY_RATING
,sh.FIPS_199_OVERALL_IMPACT_RATING
,sh.FIRST_PUBLISHED_DATE
,sh.FISMA_SYSTEM
,sh.GROUP_ACRONYM
,sh.GROUP_DESCRIPTION
,sh.GROUP_NAME
,sh.HVA_SCORE
,sh.HVASTATUS
,sh.IN_CMS_CLOUD
,sh.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,sh.IS_DATACENTER
,sh.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,sh.IS_HIGHRISKSYSTEM
,sh.IS_MARKETPLACE
,sh.IS_OA_READY
,sh.IS_OPERATIONALSYSTEM
,sh.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,sh.IS_SECURITYHUB_ENABLED
,sh.ISRA_REVIEW_DATE
,sh.ISRA_STATUS
,sh.ISSO
,sh.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,sh.ISSOCS
,sh.LAST_ACT_DATE
,sh.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,sh.LAST_ACT_SCA_FINAL_REPORT_DATE
,sh.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,sh.LAST_PENTEST_DATE
,sh.MEF
,sh.MEF_CONTEXT
,sh.MEFSTATUS
,sh.NEXT_REQUIRED_CP_TEST_DATE
,sh.OA_STATUS
,sh.OATO_CATEGORY
,sh.PACKAGE_TYPE
,sh.PIA_014 -- 230621
,sh.PIA_EXPIRATION_DATE
,sh.PII_PHI
,sh.PRIMARY_ISSO
,sh.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,sh.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,sh.SCA
,sh.SCA_DATE
,sh.SDM
,s.SOP_REVIEW_DATE
,sh.STE_DATE
,sh.SYSTEM_DESCRIPTION
,sh.SYSTEM_ID
,sh.TLC_PHASE
,coalesce(a.TOTALASSETS,0) -- 231017 added coalesce
,sh.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
JOIN CORE.SYSTEMSHIST sh on sh.report_id = 593 and sh.system_id = s.system_id
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
WHERE s.IS_PHANTOMSYSTEM = 0 and (s.IS_EXCLUDEFROMREPORTING = 0 or (s.Is_ExcludeFromReporting = 1 and s.Acronym = 'HVA' and a.TotalAssets > 0));
create or replace view VW_TENABLE_REPOSITORY_HIST(
	DATACENTER_ID,
	IS_PLUGIN_1218405_RCVD,
	IS_PLUGIN_1221295_RCVD,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	SNAPSHOT_DATACATEGORY,
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	TOTALROWS
) COMMENT='Returns history of total Tenable events received from every datacenter/repository with info of pluginid 1218405 and 1221295'
 as
SELECT 
r.DATACENTER_ID,
coalesce(p1218405.IS_PLUGIN_1218405_RCVD,0) as IS_PLUGIN_1218405_RCVD,
coalesce(p1221295.IS_PLUGIN_1221295_RCVD,0) as IS_PLUGIN_1221295_RCVD,
r.REPOSITORY_DESCRIPTION,
r.REPOSITORY_ID,
r.REPOSITORY_NAME,
snap.DATACATEGORY as SNAPSHOT_DATACATEGORY,
snap.SNAPSHOT_DATE,
r.SNAPSHOT_ID,
count(1) TOTALROWS
FROM CORE.RAW_TENABLE_VUL r
LEFT OUTER JOIN CORE.SNAPSHOT_IDS snap on snap.SNAPSHOT_ID = r.SNAPSHOT_ID
LEFT OUTER JOIN (select SNAPSHOT_ID,REPOSITORY_NAME,1 as IS_PLUGIN_1218405_RCVD
    FROM CORE.RAW_TENABLE_VUL where PLUGIN_ID = '1218405'
    GROUP BY SNAPSHOT_ID,REPOSITORY_NAME) as p1218405 on p1218405.SNAPSHOT_ID = r.SNAPSHOT_ID and p1218405.REPOSITORY_NAME = r.REPOSITORY_NAME
LEFT OUTER JOIN (select SNAPSHOT_ID,REPOSITORY_NAME,1 as IS_PLUGIN_1221295_RCVD
    FROM CORE.RAW_TENABLE_VUL where PLUGIN_ID = '1221295'
    GROUP BY SNAPSHOT_ID,REPOSITORY_NAME) as p1221295 on p1221295.SNAPSHOT_ID = r.SNAPSHOT_ID and p1221295.REPOSITORY_NAME = r.REPOSITORY_NAME
GROUP BY r.DATACENTER_ID,
coalesce(p1218405.IS_PLUGIN_1218405_RCVD,0),
coalesce(p1221295.IS_PLUGIN_1221295_RCVD,0),
r.REPOSITORY_DESCRIPTION,
r.REPOSITORY_ID,
r.REPOSITORY_NAME,
snap.DATACATEGORY,
snap.SNAPSHOT_DATE,
r.SNAPSHOT_ID
;
create or replace view VW_TEST_RAW_TENABLE_VUL(
	RAW_TENABLE_VUL_ID,
	TEMP_DW_ASSET_ID,
	ASSET_ID_TATTOO,
	DATACENTER_ID,
	DNSNAME,
	HOSTNAME,
	IP,
	MACADDRESS,
	NETBIOSNAME,
	PRIMARY_FISMA_ID_TATTOO,
	REPOSITORY_NAME,
	SNAPSHOT_ID,
	SYSTEM_ID,
	TENABLEUUID,
	COMPLIANCE_CHECK_NAME,
	COMPLIANCE_ACTUAL_VALUE
) COMMENT='Temporary view to test tenable vuln.'
 as
SELECT 
r.RAW_TENABLE_VUL_ID
--,r.APPLICABILITYCODE
,r.TEMP_DW_ASSET_ID
,r.ASSET_ID_TATTOO
,r.DATACENTER_ID
--,r.DATACENTER_ID_DERIVED
,r.DNSNAME
,r.HOSTNAME
--,r.HOSTUNIQUENESS
--,r.HOSTUUID
,r.IP
,r.MACADDRESS
,r.NETBIOSNAME
--,r.PLUGIN_ID
--,r.PRIMARY_FISMA_ID_DERIVED
,r.PRIMARY_FISMA_ID_TATTOO
,r.REPOSITORY_NAME
,r.SNAPSHOT_ID
,r.SYSTEM_ID
--,r.UNIQUENESS
,r.TENABLEUUID
,r.COMPLIANCE_CHECK_NAME
,r.COMPLIANCE_ACTUAL_VALUE

FROM CORE.RAW_TENABLE_VUL r
Where r.SNAPSHOT_ID = 250 and r.APPLICABILITYCODE <> 'Excluding AWS VUL from CCIC VUL FEED';
create or replace view VW_TRAL_LOG(
	DATE_IDENTIFIED,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	SYSTEM_RISK_LEVEL,
	DESCRIPTION,
	OA_READY,
	OA_STATUS,
	SEVERITY,
	IMPACTED_CONTROLS,
	RISK_RESPONSE,
	THRESHOLD,
	INITIALSCORE,
	DATEMITIGATED,
	SUBSEQUENTSCORE
) COMMENT='Returns the log for the TRAL metrics with initial and subsequent score  '
 as
--
-- Author: Chris Rollman, IronVine
-- Date created: 4/5/22
SELECT 
tl.dateIdentified::date as Date_Identified
,s.Acronym
,s.Authorization_Package as FISMA_System
,s.TLC_Phase 
,src.Description || '(' || cast(src.SYSTEMRISKCATEGORY_ID as varchar) || ')' as System_Risk_Level
,tm.TriggerDescription as Description
,coalesce(s.Is_OA_Ready=1,'Yes','No') OA_Ready
,s.OA_Status
,case tsl.RiskSeverityLevel
	when 'High' then tsl.RiskSeverityLevel || '(3)'
	when 'Moderate' then tsl.RiskSeverityLevel || '(2)'
	when 'Low' then tsl.RiskSeverityLevel || '(1)'
	Else tsl.RiskSeverityLevel
End as Severity
,tsl.ImpactedControls as Impacted_Controls
,tsl.RiskResponse as Risk_Response
,tsl.ThresholdDisplay as Threshold
,tl.InitialScore
,tl.dateMitigated
,tl.SubsequentScore
FROM CORE.VW_SYSTEMS s 
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_Log tl on tl.System_ID = s.System_ID
JOIN CORE.TRAL_Metric tm on tm.TRAL_Metric_ID = tl.TRAL_Metric_ID
JOIN CORE.TRAL_RiskSeverityLevel tsl  on tsl.SystemRiskCategory_ID = src.SYSTEMRISKCATEGORY_ID and tsl.TRAL_Metric_ID = tl.TRAL_Metric_ID
where s.TLC_Phase <> 'Retire'
ORDER BY s.Acronym, tl.dateIdentified;
create or replace view VW_TRAL_RISKSEVERITYLEVEL(
	SYSTEMRISKCATEGORY,
	DESCRIPTION,
	METRICID,
	METRICNAME,
	TRIGGERDESCRIPTION,
	THRESHOLDDISPLAY,
	THRESHOLD,
	POTENTIALTHREATSOURCES,
	IMPACT,
	LIKELIHOODINITIATION,
	LIKELIHOODADVERSEIMPACT,
	OVERALLLIKELIHOOD,
	RISKSEVERITYLEVEL,
	IMPACTEDCONTROLS,
	RISKRESPONSE
) COMMENT='Returns risk severity, risk category, likelyhood and other TRAL metrics information. '
 as
SELECT src.SYSTEMRISKCATEGORY_ID as SystemRiskCategory
,src.Description
,tm.TRAL_METRIC_ID as MetricID
,tm.MetricName
,tm.TriggerDescription
,tsl.ThresholdDisplay
,tsl.Threshold
,tm.PotentialThreatSources
,tsl.Impact
,tsl.LikelihoodInitiation
,tsl.LikelihoodAdverseImpact
,tsl.OverallLikelihood
,tsl.RiskSeverityLevel
,tsl.ImpactedControls
,tsl.RiskResponse
FROM CORE.SystemRiskCategory src 
JOIN CORE.TRAL_RiskSeverityLevel tsl on tsl.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on tm.TRAL_METRIC_ID = tsl.TRAL_METRIC_ID
ORDER BY src.SYSTEMRISKCATEGORY_ID,tsl.RiskSeverityLevel,tm.TRAL_METRIC_ID;
create or replace view VW_VULHIST(
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	GROUP_NAME,
	ID,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGIN_ID,
	REPORT_DATE,
	REPORT_ID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='Return open/reopened historical vulnerability for all report_id.'
 as
SELECT 
ah.ASSET_ID_TATTOO
,kev.BODDUEDATE
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,v.CVE -- 240625 CR916 was pulling from VulMaster
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
,dc.Acronym as DATACENTERACRONYM
,v.DATEMITIGATED -- 240625 CR916 was pulling from VulMaster
,DATEDIFF(day,v.firstseen,v.lastFound) as DAYSSINCEDISCOVERY -- 240625 CR916 was pulling from VulMaster
,NULL as DESCRIPTION
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,v.DW_VUL_ID -- 240625 CR916 was pulling from VulMaster
,v.EXPLOITAVAILABLE
,NULL as FAMILYNAME
,v.FIRSTSEEN -- 240625 CR916 was pulling from VulMaster
,v.FISMASEVERITY
,s.GROUP_ACRONYM -- 230623
,s.GROUP_NAME
,v.ID
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,v.LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,plugs.PLUGIN_ID
,r.REPORT_DATE
,r.REPORT_ID
,NULL as SIGNATURE
,NULL as SOLUTION
,'Tenable' as SOURCE_TOOL -- 230623
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM CORE.REPORT_IDS r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
-- 240625 CR916 JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = v.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = v.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
where v.MitigationStatus IN ('open','reopened');
create or replace view VW_VULHIST_UNFILTERED(
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	GROUP_NAME,
	ID,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGIN_ID,
	REPORT_DATE,
	REPORT_ID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='Unfiltered Vulnerability History. RESEARCH WHERE VW_VULHIST IS USED TO SEE IF IT CAN SERVE THE SAME PURPOSE\t'
 as
SELECT 
ah.ASSET_ID_TATTOO
,kev.BODDUEDATE
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
,dc.Acronym as DATACENTERACRONYM
,vm.DATEMITIGATED
,DATEDIFF(day,vm.firstseen,v.lastFound) as DAYSSINCEDISCOVERY
,NULL as DESCRIPTION
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,vm.DW_VUL_ID
,v.EXPLOITAVAILABLE
,NULL as FAMILYNAME
,vm.FIRSTSEEN
,v.FISMASEVERITY
,s.GROUP_ACRONYM -- 230623
,s.GROUP_NAME
,v.ID
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,v.LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,plugs.PLUGIN_ID
,r.REPORT_DATE
,r.REPORT_ID
,NULL as SIGNATURE
,NULL as SOLUTION
,'Tenable' as SOURCE_TOOL -- 230623
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM CORE.REPORT_IDS r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
;
create or replace view VW_VULMASTER(
	BODDUEDATE,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATEMITIGATED,
	DATEMODIFIED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	EXTENDED_MITIGATIONSTATUS,
	FIRSTSEEN,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_KEV,
	IS_LEGACY,
	LASTFOUND,
	MITIGATIONSTATUS,
	NUMERIC_SEVERITY,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	SYSTEM_ID
) COMMENT='CRITICAL; View reports Tenable vulnerabilities from VULMASTER table. Related asset must be active (not logically deleted). It is used throughout CRM\t'
 as
SELECT
kev.BODDUEDATE
,vm.CVE
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,a.DATACENTER_ID
,vm.DATEMITIGATED
,vm.DATEMODIFIED
,vm.DATEREOPENED
,vm.DAYSSINCEDISCOVERY
,vm.DW_ASSET_ID
,vm.DW_VUL_ID
,vm.EXPLOITAVAILABLE
,vm.EXTENDED_MITIGATIONSTATUS -- 240625 CR916
,vm.FIRSTSEEN
,vm.FISMASEVERITY
,vm.INSERT_DATE
,vm.IS_FROM_AWS_FEED -- 230719
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,vm.IS_LEGACY
,vm.LASTFOUND
,vm.MITIGATIONSTATUS
,vm.NUMERIC_SEVERITY -- 230719
,vm.REPOSITORY_ID -- 230720
,trh.REPOSITORY_LASTSEEN -- 230720
,vm.REPOSITORY_NAME -- 230719
,a.SYSTEM_ID
FROM CORE.VULMASTER vm
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE and kev.IS_DELETED = 0
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vm.REPOSITORY_ID
WHERE vm.DELETIONREASON IS NULL;
create or replace view VW_VULMASTER_EPSS_TEST(
	BODDUEDATE,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATEMITIGATED,
	DATEMODIFIED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	DW_ASSET_ID,
	DW_VUL_ID,
	EPSS,
	EPSS_PERCENTILE,
	EPSS_CVE_DATE,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_KEV,
	IS_LEGACY,
	LASTFOUND,
	MITIGATIONSTATUS,
	NUMERIC_SEVERITY,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	SYSTEM_ID
) COMMENT='CRITICAL; View reports Tenable vulnerabilities from VULMASTER table. Related asset must be active (not logically deleted). It is used throughout CRM\t'
 as
SELECT
kev.BODDUEDATE
,vm.CVE
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,a.DATACENTER_ID
,vm.DATEMITIGATED
,vm.DATEMODIFIED
,vm.DATEREOPENED
,vm.DAYSSINCEDISCOVERY
,vm.DW_ASSET_ID
,vm.DW_VUL_ID
,epss.EPSS -- 240214
,epss.PERCENTILE as EPSS_PERCENTILE -- 240214
,epss.CVE_DATE as EPSS_CVE_DATE -- 240214
,vm.EXPLOITAVAILABLE
,vm.FIRSTSEEN
,vm.FISMASEVERITY
,vm.INSERT_DATE
,vm.IS_FROM_AWS_FEED -- 230719
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,vm.IS_LEGACY
,vm.LASTFOUND
,vm.MITIGATIONSTATUS
,vm.NUMERIC_SEVERITY -- 230719
,vm.REPOSITORY_ID -- 230720
,trh.REPOSITORY_LASTSEEN -- 230720
,vm.REPOSITORY_NAME -- 230719
,a.SYSTEM_ID
FROM CORE.VULMASTER vm
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE and kev.IS_DELETED = 0
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vm.REPOSITORY_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vm.cve
WHERE vm.DELETIONREASON IS NULL;
create or replace view VW_VULN_DASHBOARD_TRENDING(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Used to populate RPT.Temp_Vuln_Trending from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
with ReportIDs as(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS ORDER BY REPORT_ID DESC) 
UNION ALL
(SELECT TOP 12 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE,  IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
),
snap as (
select a.RANKK,a.REPORT_ID,a.REPORT_DATE,a.IS_ENDOFMONTH
,IFF(a.RANKK=1,'MTD',IFF(a.RANKK=2,'EOM','EOM-' || (a.RANKK-2)::VARCHAR )) as MTDVSEOM 
,IFF(a.RANKK=1,b.REPORT_DATE,a.REPORT_DATE) as CurrentMTDStart 
,IFF(a.RANKK in (1,2),(Select REPORT_DATE from ReportIDs  where RANKK=3 ),IFNULL(b.REPORT_DATE,a.REPORT_DATE))  as PrevEOMStart
from ReportIDs a left join ReportIDs b on a.RANKK=b.RANKK-1 
),
vulh as (
select  
s.SYSTEM_ID -- 241107 CR1026 was using upper function
,s.Component_Acronym
,count(vh.cve) as cvecount
,count(Distinct vh.cve) as UniqueCVECount
,ah.DATACENTER_ID
,vh.VUL_DATECREATED as datecreated
,vh.DATEMITIGATED
,sum(datediff(day,vh.FIRSTSEEN,vh.LASTFOUND)) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,IFF(bodcat.Is_Deleted = 0,'Yes','No') as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
,snap.REPORT_ID
from snap
join CORE.ASSETHIST ah on ah.REPORT_ID = snap.REPORT_ID -- 240806 CR946
join CORE.VULHIST vh on vh.REPORT_ID = snap.REPORT_ID and vh.DW_ASSET_ID = ah.DW_ASSET_ID -- 240806 CR946
join CORE.SYSTEMS s on s.system_id = ah.system_id -- 240806 CR946 Dont use view. As time moves on a system might be retired and we would not show the history
left join CORE.KEV_CATALOG bodcat on bodcat.CVE = vh.CVE
group by
snap.REPORT_ID
,s.SYSTEM_ID
,s.Component_Acronym
,ah.DATACENTER_ID
,vh.VUL_DATECREATED
,vh.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
)
select distinct
s.Acronym
,s.Component_Acronym
,coalesce(vh.cvecount,0) as "CVE Count" -- 241107 CR1026 add coalesce
,coalesce(vh.UniqueCVECount,0) as "Unique CVE Count" -- 241107 CR1026 add coalesce
,snap.CurrentMTDStart
,IFNULL(dc.datacenter_acronym,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name --Datacenter from assets or primary oploc.
,vh.datecreated
,vh.DATEMITIGATED
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,vh.HVASTATUS
,vh.is_bod
,vh.IS_MARKETPLACE
,vh.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,snap.PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,vh.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
right join CORE.VW_SYSTEMS s on s.system_id = ss.system_id
left join (select a.system_id,a.datacenter_id,b.acronym as datacenter_acronym from
    (select distinct system_id, datacenter_id from CORE.VW_ASSETS --All datacenters for active assets.
    union
    select distinct system_id, datacenter_id from vulh) a  -- Datacenters for some inactive assets
    join CORE.VW_SYSTEMS b on a.datacenter_id = b.system_id
    ) dc on dc.system_id = s.system_id
left join vulh vh on vh.REPORT_ID = ss.REPORT_ID and vh.SYSTEM_ID = dc.SYSTEM_ID and vh.datacenter_id = dc.datacenter_id
;
create or replace view VW_VULN_DASHBOARD_TRENDING_NEW(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Used to populate RPT.Temp_Vuln_Trending from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
with ReportIDs as(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS ORDER BY REPORT_ID DESC) 
UNION ALL
(SELECT TOP 12 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE,  IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
),
snap as (
select a.RANKK,a.REPORT_ID,a.REPORT_DATE,a.IS_ENDOFMONTH
,IFF(a.RANKK=1,'MTD',IFF(a.RANKK=2,'EOM','EOM-' || (a.RANKK-2)::VARCHAR )) as MTDVSEOM 
,IFF(a.RANKK=1,b.REPORT_DATE,a.REPORT_DATE) as CurrentMTDStart 
,IFF(a.RANKK in (1,2),(Select REPORT_DATE from ReportIDs  where RANKK=3 ),IFNULL(b.REPORT_DATE,a.REPORT_DATE))  as PrevEOMStart
from ReportIDs a left join ReportIDs b on a.RANKK=b.RANKK-1 
),
vulh as (
select  
 upper(s.SYSTEM_ID) as SYSTEM_ID
,s.Component_Acronym
,count(vh.cve) as cvecount
,count(Distinct vh.cve) as UniqueCVECount
,ah.DATACENTER_ID
,vh.VUL_DATECREATED as datecreated
,vh.DATEMITIGATED
,sum(datediff(day,vh.FIRSTSEEN,vh.LASTFOUND)) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,IFF(bodcat.Is_Deleted = 0,'Yes','No') as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
,snap.REPORT_ID
from snap
join CORE.ASSETHIST ah on ah.REPORT_ID = snap.REPORT_ID
join CORE.VULHIST vh on vh.REPORT_ID = snap.REPORT_ID and vh.DW_ASSET_ID = ah.DW_ASSET_ID
join CORE.SYSTEMS s on s.system_id = ah.system_id -- Dont use view. As time moves on a system might be retired and we would not show the history
left join CORE.KEV_CATALOG bodcat on bodcat.CVE = vh.CVE
group by
snap.REPORT_ID
,s.SYSTEM_ID
,s.Component_Acronym
,ah.DATACENTER_ID
,vh.VUL_DATECREATED
,vh.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
)
select distinct
s.Acronym
,s.Component_Acronym
,vh.cvecount as "CVE Count"
,vh.UniqueCVECount as "Unique CVE Count"
,snap.CurrentMTDStart
,IFNULL(dc.datacenter_acronym,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name --Datacenter from assets or primary oploc.
,vh.datecreated
,vh.DATEMITIGATED
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,vh.HVASTATUS
,vh.is_bod
,vh.IS_MARKETPLACE
,vh.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,snap.PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,vh.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
right join CORE.VW_SYSTEMS s on s.system_id = ss.system_id
left join (select a.system_id,a.datacenter_id,b.acronym as datacenter_acronym from
    (select distinct system_id, datacenter_id from CORE.VW_ASSETS --All datacenters for active assets.
    union
    select distinct system_id, datacenter_id from vulh) a  -- Datacenters for some inactive assets
    join CORE.VW_SYSTEMS b on a.datacenter_id = b.system_id
    ) dc on dc.system_id = s.system_id
left join vulh vh on vh.REPORT_ID = ss.REPORT_ID and vh.SYSTEM_ID = dc.SYSTEM_ID and vh.datacenter_id = dc.datacenter_id
;
create or replace view VW_VULN_ROLLING60DAYS(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) COMMENT='Used to populate RPT.Temp_Vuln_FV_Rolling60Days from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
--
-- V5 replace Snapshots CTE and POAMHIST REPORT_ID (using FN_CRM_GET_REPORT_ID(0)) and mitigation filter at bottom not at join
--
--
-- The only difference between rpt.v_systems and core.rpt.wv_systems is alias names
--
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(0))
    UNION ALL
    select 2 as RANKK, REPORT_ID, 'EOM' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(1))
)
select sys.ACRONYM as v_acr,sys.COMPONENT_ACRONYM as v_comp_acr ,sys.TLC_Phase v_tlc_phase,sys.HVAStatus as v_hva_stat,sys.IS_MARKETPLACE as v_is_mrkt_plc,sys.MEFSTATUS as v_mef_status,
case when vuln.ACRONYM is null then concat(sys.ACRONYM,'*') else sys.ACRONYM end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS sys

left outer join
(
select
'1' as filter
,vh.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,vh.DATACENTER_ID as FK_DATACENTER_ID
,vh.id
,vh.DW_VUL_ID as FK_dw_vul_number
,vh.cve
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.firstseen
,vh.fismaseverity
,vh.lastfound
,vh.mitigationstatus
,vh.REPORT_ID as fk_snapshotid
,s.ACRONYM
,substring(s.ACRONYM, 1, 1) || '***' as Acr_Alias -- 231103 changed from + to ||
,s.COMPONENT_ACRONYM
,s.IS_DATACENTER
,s.IS_MARKETPLACE
,s.TLC_PHASE
,A.Is_Scannable
--,vh.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,s.HVASTATUS
,s.MEFSTATUS
,data_center.ACRONYM as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
--,dense_rank()over(order by vh.REPORT_ID desc) as rankk -- 231201
,snap.RANKK as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,vh.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,s.OATO_CATEGORY
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED vh on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN SnapShots snap on vh.REPORT_ID = snap.REPORT_ID
--and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON vh.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join CORE.VW_SYSTEMS data_center ON data_center.SYSTEM_ID = vh.datacenter_id
left outer JOIN CORE.VW_SYSTEMS s ON s.SYSTEM_ID = vh.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat on bodcat.CVE = vh.cve

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT p.SYSTEM_ID,p.POAM_ID,CVE,p.Overall_Status
    FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.POAMHist p on p.REPORT_ID = r.REPORT_ID
    where p.CVE IS NOT NULL) pom on pom.CVE=vh.CVE and pom.SYSTEM_ID=vh.SYSTEM_ID
    
where (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
) vuln on vuln.FK_PRIMARY_FISMA_ID = sys.SYSTEM_ID   -- 231103 (vuln."Acronym" = vh."Acronym" and vuln."Component_Acronym" = vh."Component_Acronym" )

where sys.COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO') -- 231103 and "Is_ExcludeFromReporting" = 0
;
create or replace view VW_VULPLUGINS_MASTER(
	DW_VUL_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DW_ASSET_ID,
	PLUGIN_ID,
	CVE,
	PLUGIN_MITIGATIONSTATUS,
	CVE_MITIGATIONSTATUS,
	EXTENDED_MITIGATIONSTATUS,
	PLUGIN_DELETIONREASON,
	TOTAL_PLUGIN_COUNT,
	OPEN_PLUGIN_COUNT,
	DELETED_PLUGIN_COUNT,
	FIXED_PLUGIN_COUNT,
	BODDUEDATE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATEMITIGATED,
	DATEMODIFIED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_KEV,
	IS_LEGACY,
	LASTFOUND,
	NUMERIC_SEVERITY,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	SYSTEM_ID
) COMMENT='View reports Tenable vulnerabilities from VULPLUGINS_MASTER and VULMASTER table.\t'
 as
SELECT
vm.dw_vul_id
,a.datacenter_acronym
,a.system_acronym
,vm.DW_ASSET_ID
,vpm.PLUGIN_ID 
,vm.CVE
,vpm.mitigationstatus as Plugin_MitigationStatus
,vm.MITIGATIONSTATUS as CVE_Mitigationstatus
,vm.extended_mitigationstatus
,vpm.DELETIONREASON as Plugin_DELETIONREASON
,vm.total_plugin_count
,vm.open_plugin_count
,vm.deleted_plugin_count
,vm.fixed_plugin_count
,kev.BODDUEDATE
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,a.DATACENTER_ID
,vm.DATEMITIGATED
,vm.DATEMODIFIED
,vm.DATEREOPENED
,vm.DAYSSINCEDISCOVERY
,vm.EXPLOITAVAILABLE
,vm.FIRSTSEEN
,vm.FISMASEVERITY
,vm.INSERT_DATE
,vm.IS_FROM_AWS_FEED -- 230719
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,vm.IS_LEGACY
,vm.LASTFOUND
,vm.NUMERIC_SEVERITY -- 230719
,vm.REPOSITORY_ID -- 230720
,trh.REPOSITORY_LASTSEEN -- 230720
,vm.REPOSITORY_NAME -- 230719
,a.SYSTEM_ID
FROM CORE.VULMASTER vm
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
LEFT OUTER JOIN 
(SELECT f.value::string as Plugin_CVE,v.* exclude CVE
--v.dw_asset_id,v.plugin_id,f.value::string as CVE,v.mitigationstatus,v.DELETIONREASON
    FROM CORE.VULPLUGINS_MASTER v
    join table(flatten(cve,outer=>true)) as f) vpm on vpm.DW_ASSET_ID = vm.DW_ASSET_ID and Plugin_CVE = vm.CVE
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE and kev.IS_DELETED = 0
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vm.REPOSITORY_ID
WHERE vm.DELETIONREASON IS NULL;
create or replace view VW_VULPLUGINS_MASTER_FLATTENED(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DW_ASSET_ID,
	DW_PLUGIN_VUL_ID,
	PLUGIN_ID,
	PLUGIN_NAME,
	CVE,
	MITIGATIONSTATUS,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FAMILY_NAME,
	FIRSTSEEN,
	LASTFOUND,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_TENABLE_CREDENTIALED_SCAN,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	NETBIOSNAME,
	MACADDRESS,
	IPV4,
	PORT,
	IS_KEV,
	KEV_DUEDATE,
	KEV_SHORTDESCRIPTION,
	KEV_VENDORPROJECT,
	KEV_VULNERABILITYNAME,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	PATCHPUB_DATE,
	VULN_PUB_DATE,
	DESCRIPTION,
	SOLUTION,
	SYNOPSIS,
	VERSION
) COMMENT='CRITICAL; View reports Tenable vulnerabilities from VULPLUGINS_MASTER table flattening CVE array. Related asset must be active.\t'
 as
SELECT
a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,vpm.DW_ASSET_ID
,vpm.DW_PLUGIN_VUL_ID
,vpm.PLUGIN_ID
,vpm.PLUGIN_NAME
,f.value::string as CVE
,vpm.MITIGATIONSTATUS
,vpm.CVSSV2BASESCORE
,vpm.CVSSV3BASESCORE
,vpm.DAYSSINCEDISCOVERY
,vpm.EXPLOITAVAILABLE
,vpm.FAMILY_NAME
,vpm.FIRSTSEEN::date as FIRSTSEEN
,vpm.LASTFOUND::date as LASTFOUND
,vpm.FISMASEVERITY
,vpm.INSERT_DATE::date as INSERT_DATE
,vpm.IS_FROM_AWS_FEED
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.asset_id_tattoo
,a.fqdn
,a.hostname
,a.netbiosname
,a.macaddress
,a.ipv4
,vpm.PORT
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,kev.BODDUEDATE::date as KEV_DUEDATE
,kev.SHORTDESCRIPTION as KEV_SHORTDESCRIPTION
,kev.VENDORPROJECT as KEV_VENDORPROJECT
,kev.VULNERABILITYNAME as KEV_VULNERABILITYNAME
,vpm.REPOSITORY_ID
,trh.REPOSITORY_LASTSEEN::date as REPOSITORY_LASTSEEN
,vpm.REPOSITORY_NAME
,vpm.PATCHPUB_DATE::date as PATCHPUB_DATE
,vpm.VULN_PUB_DATE::date as VULN_PUB_DATE
,vpm.DESCRIPTION
,vpm.SOLUTION
,vpm.SYNOPSIS
,vpm.VERSION
FROM CORE.VULPLUGINS_MASTER vpm
join table(flatten(cve,outer=>true)) as f
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = f.value::string and kev.IS_DELETED = 0
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vpm.DW_ASSET_ID
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vpm.REPOSITORY_ID
WHERE vpm.DELETIONREASON IS NULL and vpm.MITIGATIONSTATUS <> 'fixed'
and f.value::string = 'CVE-2023-41993'
order by a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,f.value::string
;
CREATE OR REPLACE FUNCTION "FN_CRM_CHARACTER_SEVERITY"("P_NUMERIC_SEVERITY" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return character FISMA Severity based on pre-determined numeric severity'
AS '
--
-- Created 241106
--
CASE P_NUMERIC_SEVERITY
    WHEN 4 THEN ''Critical''
    WHEN 3 THEN ''High''
    WHEN 2 THEN ''Medium''
    WHEN 1 THEN ''Low''
    ELSE ''Info''
END
';
CREATE OR REPLACE FUNCTION "FN_CRM_CLEANSTRING"("P_InString" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Remove unwanted characters from a varchar field.  DO NOT USE FOR dateTime FIELDS BECAUSE RESOLUTION IS REDUCED. e.g. seconds'
AS '
     CASE
        -- empty strings
        WHEN (P_InString IS NULL) THEN NULL
        WHEN (LEN(P_InString) = 0) THEN NULL
        WHEN (P_InString = ''~NoData~'') THEN NULL
        
        -- remove all non-ASCII charaters and any leading spaces, single quotes, or double quotes
        ELSE LTRIM(LTRIM(LTRIM(RTRIM(RTRIM(RTRIM(regexp_replace(P_InString, ''[^[:ascii:]]'', ''''), '' ''), CHAR(34)), CHAR(39)), ''  ''), CHAR(34)), CHAR(39))
    END
';
CREATE OR REPLACE FUNCTION "FN_CRM_CLEANSTRING_CHRIS"("P_InString" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Remove unwanted characters from a varchar field.  DO NOT USE FOR dateTime FIELDS BECAUSE RESOLUTION IS REDUCED. e.g. seconds'
AS '
     CASE
        -- empty strings
        WHEN (P_InString IS NULL) THEN NULL
        WHEN (LEN(P_InString) = 0) THEN NULL
        WHEN (P_InString = ''~NoData~'') THEN NULL
        
        -- remove all non-ASCII charaters and any leading spaces, single quotes, or double quotes
        ELSE LTRIM(LTRIM(LTRIM(RTRIM(RTRIM(RTRIM(regexp_replace(P_InString, ''[^[:ascii:]]'', ''$FOUND''), '' ''), CHAR(34)), CHAR(39)), ''  ''), CHAR(34)), CHAR(39))
    END
';
CREATE OR REPLACE FUNCTION "FN_CRM_CLEAN_FORESCOUT_STRING"("P_Instring" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Remove unwanted strings/characters from a Forescout varchar field.'
AS '
     CASE
        WHEN (P_Instring IS NULL) THEN NULL
        WHEN (P_Instring = '''') THEN NULL -- empty strings
        WHEN (P_Instring = ''default_cpe'') THEN NULL
        WHEN (P_Instring = ''Irresolvable'') THEN NULL
        WHEN (P_Instring = ''None'') THEN NULL
        WHEN (P_Instring = ''Unknown'') THEN NULL
        ELSE TRIM(P_Instring)
    END
';
CREATE OR REPLACE FUNCTION "FN_CRM_DISCOVER_PATTERN"("P_STRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Replace alphas and numbers with $ to yield adata pattern'
AS '
--
-- Replace alphas and numbers with $
-- remaining characters represent a format pattern when special
-- characters are included in the string
--
REGEXP_REPLACE(upper(P_STRING),''[A-Z0-9]+'',''$'')  
  
';
CREATE OR REPLACE FUNCTION "FN_CRM_FISMASEVERITY"("P_CVSS_VERSION" VARCHAR(16777216), "P_CVSS" NUMBER(38,1))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return character FISMA Severity appropriate to CVSS_VERSION'
AS '
CASE P_CVSS_VERSION
    WHEN ''3.0'' THEN
    CASE 
        WHEN P_CVSS BETWEEN 9.0 AND 10.0 THEN ''Critical''
        WHEN P_CVSS BETWEEN 7.0 AND 8.9 THEN ''High''
        WHEN P_CVSS BETWEEN 4.0 AND 6.9 THEN ''Medium''
        WHEN P_CVSS BETWEEN 0.1 AND 3.9 THEN ''Low''
        WHEN P_CVSS = 0.0 THEN ''Informational''
        ELSE ''Unknown''
    END
    WHEN ''2.0'' THEN
    CASE 
        WHEN P_CVSS = 10.0 THEN ''Critical''
        WHEN P_CVSS BETWEEN 7.0 AND 9.9 THEN ''High''
        WHEN P_CVSS BETWEEN 4.0 AND 6.9 THEN ''Medium''
        WHEN P_CVSS BETWEEN 0.1 AND 3.9 THEN ''Low''
        WHEN P_CVSS = 0.0 THEN ''Informational''
        ELSE ''Unknown''
    END
        WHEN ''0'' THEN -- Tenable integer severity number
    CASE 
        WHEN P_CVSS = 4 THEN ''Critical''
        WHEN P_CVSS = 3 THEN ''High''
        WHEN P_CVSS = 2 THEN ''Medium''
        WHEN P_CVSS = 1 THEN ''Low''
        WHEN P_CVSS = 0 THEN ''Informational''
        ELSE ''Unknown''
    END
END
';
CREATE OR REPLACE FUNCTION "FN_CRM_FORMAT_BOOLEAN"("P_BOOLEAN" BOOLEAN, "P_FORMAT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return varchar with format of boolean indicated by P_FORMAT. Where Yes=Yes/No, True-True/False'
AS '
     CASE
        WHEN (lower(P_FORMAT) = ''true'' and P_BOOLEAN=0) THEN ''No''
        WHEN (lower(P_FORMAT) = ''true'' and P_BOOLEAN=1) THEN ''Yes''
        WHEN (lower(P_FORMAT) = ''yes'' and P_BOOLEAN=0) THEN ''No''
        WHEN (lower(P_FORMAT) = ''yes'' and P_BOOLEAN=1) THEN ''Yes''
        ELSE P_BOOLEAN::varchar
    END
';
CREATE OR REPLACE FUNCTION "FN_CRM_FORMAT_VARCHAR_DATE"("P_STRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Given format Tue Aug 22 06:52:26 2023, yield 08/22/2023 06:52:26'
AS '

case upper(SUBSTRING(P_STRING,5,3))
    when ''JAN'' then ''01''
    when ''JAN'' then ''01''
	when ''FEB'' then ''02''
	when ''MAR'' then ''03''
	when ''APR'' then ''04''
	when ''MAY'' then ''05''
	when ''JUN'' then ''06''
	when ''JUL'' then ''07''
	when ''AUG'' then ''08''
	when ''SEP'' then ''09''
	when ''OCT'' then ''10''
	when ''NOV'' then ''11''
	when ''DEC'' then ''12''
end || ''/'' || SUBSTRING(P_STRING,9,2) || ''/'' || SUBSTRING(P_STRING,21,4) 
|| SUBSTRING(P_STRING,11,9)

';
CREATE OR REPLACE FUNCTION "FN_CRM_GETUID_DEFAULT"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return dummy system id \"0000000-Default-0000000\" representing default'
AS '
''0000000-Default-0000000''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GETUID_NOTPROVIDED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return dummy system id \"0000000-NOTPROVIDED-0000000\" representing NOTPROVIDED'
AS '
''0000000-NotProvided-0000000''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GETUID_NOTVALID"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return dummy system id \"0000000-NOTVALID-0000000\" representing NOTVALID'
AS '
''0000000-NotValid-0000000''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GETUID_UNASSIGNED_OPLOC"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return dummy system id \"0000000-UnAssigned-OpLoc-0000000\" representing UnAssigned-Operation Location'
AS '
''0000000-UnAssigned-OpLoc-0000000''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GETUID_UNLINKED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return a dummy system_id \"0000000-UnlinkedTrackID-0000000\" that does not have Tracking ID'
AS '
''0000000-UnlinkedTrackID-0000000''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_INDICATOR_ACTIONALABLE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating record is actionable'
AS '
''Actionable''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_INDICATOR_INITIAL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating initialization of a record'
AS '
''Initial''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_MITIGATIONSTATUS_FIXED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating mitigation status is fixed'
AS '
''fixed''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_MITIGATIONSTATUS_OPEN"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating mitigation status is open'
AS '
''open''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_MITIGATIONSTATUS_REOPENED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating mitigation status is reopened'
AS '
''reopened''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_REPORT_ID"("P_IS_ENDOFMONTH" NUMBER(38,0))
RETURNS TABLE ("REPORT_ID" NUMBER(38,0), "REPORT_DATE" TIMESTAMP_LTZ(9), "IS_ENDOFMONTH" BOOLEAN)
LANGUAGE SQL
COMMENT='Return current REPORT_ID and REPORT_DATE for most current time or most current end-of-month'
AS '
--
-- 240416 CR873 Only return REPORT_ID if morning processes completed successfully
--
SELECT REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE REPORT_ID = (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS where ((P_IS_ENDOFMONTH = 1 and IS_ENDOFMONTH = 1) or (coalesce(P_IS_ENDOFMONTH,0) <> 1)) and IS_VIABLE = 1)
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_REPORT_ID_HIST"("P_NUM_OF_ENDOFMONTH_SNAPSHOTS" NUMBER(38,0), "P_NUM_OF_DAILY_SNAPSHOTS" NUMBER(38,0))
RETURNS TABLE ("REPORT_ID" NUMBER(38,0), "REPORT_DATE" TIMESTAMP_LTZ(9), "IS_ENDOFMONTH" BOOLEAN)
LANGUAGE SQL
COMMENT='Return current REPORT_ID and REPORT_DATE for most current time daily and last 12 end-of-month snapshots'
AS '
--
-- 240416 CR873 Only return REPORT_ID if morning processes completed successfully
--
(SELECT TOP 12 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 1 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 0 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)

';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_REPORT_ID_HIST_TEST"()
RETURNS TABLE ("RANKK" NUMBER(38,0), "REPORT_ID" NUMBER(38,0), "REPORT_DATE" DATE, "MTDVSEOM" VARCHAR(16777216), "IS_ENDOFMONTH" BOOLEAN)
LANGUAGE SQL
COMMENT='Return current REPORT_ID and REPORT_DATE for most current time (daily) and last 12 end-of-month snapshots'
AS '

SELECT t.RANKK, t.REPORT_ID, t.REPORT_DATE, t.MTDVSEOM, t.IS_ENDOFMONTH FROM
(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''MTD'' as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 0 ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM'' as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 2 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 3 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 4 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 5 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 6 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 7 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 8 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 9 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 10 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 11 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 12 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
) t
GROUP BY t.RANKK, t.REPORT_ID, t.REPORT_DATE, t.MTDVSEOM, t.IS_ENDOFMONTH
ORDER BY t.RANKK

';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_REPORT_ID_VULN_DASHBOARD_TRENDING"()
RETURNS TABLE ("RANKK" NUMBER(38,0), "REPORT_ID" NUMBER(38,0), "REPORT_DATE" DATE, "MTDVSEOM" VARCHAR(16777216), "IS_ENDOFMONTH" BOOLEAN)
LANGUAGE SQL
COMMENT='Return current REPORT_ID and REPORT_DATE for most current time (daily) and last 12 end-of-month snapshots'
AS '

SELECT t.RANKK, t.REPORT_ID, t.REPORT_DATE, t.MTDVSEOM, t.IS_ENDOFMONTH FROM
(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''MTD'' as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 0 ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM'' as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 2 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 3 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 4 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 5 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 6 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 7 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 8 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 9 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 10 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 11 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
UNION ALL
(SELECT TOP 1 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, ''EOM-'' || (dense_rank()over(order by REPORT_ID desc) - 1)::VARCHAR as MTDVSEOM, IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and REPORT_ID IN (SELECT TOP 12 REPORT_ID FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC) ORDER BY REPORT_ID ASC)
) t
GROUP BY t.RANKK, t.REPORT_ID, t.REPORT_DATE, t.MTDVSEOM, t.IS_ENDOFMONTH
ORDER BY t.RANKK

';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_ROWDISPOSITION_CLEANED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating record has been cleaned and is ready for further processing'
AS '
''Cleaned''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_ROWDISPOSITION_ERROR"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating record has an error'
AS '
''Error''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating record is not needed'
AS '
''Not Needed''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_ROWDISPOSITION_VIABLE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Return string indicating record is viable'
AS '
''Viable''
';
CREATE OR REPLACE FUNCTION "FN_CRM_GET_SNAPSHOT_ID"("P_DATACATEGORY" VARCHAR(16777216))
RETURNS NUMBER(38,0)
LANGUAGE SQL
COMMENT='Return current snapshot id of datacatagory specified'
AS '
SELECT MAX(SNAPSHOT_ID) FROM CORE.SNAPSHOT_IDS where UPPER(DATACATEGORY) = UPPER(P_DATACATEGORY)
';
CREATE OR REPLACE FUNCTION "FN_CRM_IS_IPV4ADDRESS"("P_IPv4Address" VARCHAR(16777216))
RETURNS BOOLEAN
LANGUAGE SQL
COMMENT='Return true for a correct IPv4 format'
AS '
CASE
WHEN (P_IPv4Address = '''' or P_IPv4Address IS NULL) THEN
    FALSE
WHEN ((TRY_TO_NUMBER(split_part(P_IPv4Address,''.'',1)) IS NOT NULL) AND 
      (TRY_TO_NUMBER(split_part(P_IPv4Address,''.'',2)) IS NOT NULL) AND 
      (TRY_TO_NUMBER(split_part(P_IPv4Address,''.'',3)) IS NOT NULL) AND 
      (TRY_TO_NUMBER(split_part(P_IPv4Address,''.'',4)) IS NOT NULL)) 
THEN
    TRUE
ELSE
    FALSE
END    
';
CREATE OR REPLACE FUNCTION "FN_CRM_IS_IPV6ADDRESS"("P_IPv6Address" VARCHAR(16777216))
RETURNS BOOLEAN
LANGUAGE SQL
COMMENT='Return true for a correct IPv6 format'
AS '
CASE
    WHEN (P_IPv6Address = '''' or P_IPv6Address= '''') THEN FALSE
    
    -- :: (implies all 8 segments are zero)
    WHEN (P_IPv6Address = ''::'') THEN TRUE
    
    -- Format is y:y:y:y:y:y:y:y where y is any hexadecimal value between 0 and FFFF
    WHEN ((CONTAINS(P_IPv6Address,''.'') = FALSE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',5) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',6) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',7) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',8) REGEXP ''[0-9,a-f,A-F]{1,4}''))  THEN TRUE
    
    -- Format is y:y:y::y:y:y (implies that the middle two segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = FALSE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',4)= '''') AND (split_part(P_IPv6Address,'':'',5) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',-0) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (RIGHT(P_IPv6Address,1) REGEXP ''[0-9,a-f,A-F]'') )   THEN TRUE
    
    -- Format is y:y::y:y (implies that the middle four segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = FALSE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3)= '''') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',5) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',-0) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (RIGHT(P_IPv6Address,1) REGEXP ''[0-9,a-f,A-F]'') )   THEN TRUE
        
    -- Format is y:y:: (implies that the last six segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = FALSE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (RIGHT(P_IPv6Address,2)= ''::'') AND (RIGHT(P_IPv6Address,3) != '':::'')  )   THEN TRUE
        
    -- Format is ::y:y (implies that the first six segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = FALSE) AND (LEFT(P_IPv6Address,2)= ''::'') AND (split_part(P_IPv6Address,'':'',3) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (RIGHT(P_IPv6Address,1) REGEXP ''[0-9,a-f,A-F]'')) THEN TRUE
        
    -- Format is y:y:y:y:y:y:x.x.x.x  where y is any hexadecimal value between 0 and FFFF, x is any number between 0 and 255
    WHEN ((CONTAINS(P_IPv6Address,''.'') = TRUE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',5) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',6) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(split_part(P_IPv6Address,'':'',7),''.'',1) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',7),''.'',2) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',7),''.'',3) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',7),''.'',4) REGEXP ''[0-9]{1,3}'')  )  THEN  TRUE
        
    -- Format is y:y::y:y:5.6.7.8 (implies that the middle two IPv6 segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = TRUE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3)= '''') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',5) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(split_part(P_IPv6Address,'':'',6),''.'',1) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',6),''.'',2) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',6),''.'',3) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',6),''.'',4) REGEXP ''[0-9]{1,3}'')  )  THEN  TRUE
    
    -- Format is ::y:y:91.123.4.56 (implies that the first four IPv6 segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = TRUE) AND (LEFT(P_IPv6Address,2)= ''::'') AND (split_part(P_IPv6Address,'':'',3) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',4) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(split_part(P_IPv6Address,'':'',5),''.'',1) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',5),''.'',2) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',5),''.'',3) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',5),''.'',4) REGEXP ''[0-9]{1,3}'') ) THEN TRUE
    
    -- Format is y:y::123.123.123.123 (implies that the last four IPv6 segments are zero)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = TRUE) AND (split_part(P_IPv6Address,'':'',1) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',2) REGEXP ''[0-9,a-f,A-F]{1,4}'') AND (split_part(P_IPv6Address,'':'',3)= '''') AND (split_part(split_part(P_IPv6Address,'':'',4),''.'',1) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',4),''.'',2) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',4),''.'',3) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',4),''.'',4) REGEXP ''[0-9]{1,3}'') ) THEN  TRUE
    
    -- Format is ::11.22.33.44 (implies all six IPv6 segments are zero with a IPv4 ending)
    WHEN ((CONTAINS(P_IPv6Address,''.'') = TRUE) AND (LEFT(P_IPv6Address,2)= ''::'') AND (split_part(split_part(P_IPv6Address,'':'',3),''.'',1) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',3),''.'',2) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',3),''.'',3) REGEXP ''[0-9]{1,3}'') AND (split_part(split_part(P_IPv6Address,'':'',3),''.'',4) REGEXP ''[0-9]{1,3}'') ) THEN TRUE

    ELSE FALSE
END    
';
CREATE OR REPLACE FUNCTION "FN_CRM_IS_MACADDRESS"("P_MACADDRESS" VARCHAR(16777216))
RETURNS BOOLEAN
LANGUAGE SQL
COMMENT='Return true for a valid MACADDRESS format'
AS '
CASE
WHEN (P_MACADDRESS = '''' or P_MACADDRESS IS NULL) THEN
    FALSE
WHEN (P_MACADDRESS REGEXP  ''[0-9,a-f,A-F]{2}:[0-9,a-f,A-F]{2}:[0-9,a-f,A-F]{2}:[0-9,a-f,A-F]{2}:[0-9,a-f,A-F]{2}:[0-9,a-f,A-F]{2}''
   or P_MACADDRESS REGEXP  ''[0-9,a-f,A-F]{2}-[0-9,a-f,A-F]{2}-[0-9,a-f,A-F]{2}-[0-9,a-f,A-F]{2}-[0-9,a-f,A-F]{2}-[0-9,a-f,A-F]{2}''
   or P_MACADDRESS REGEXP  ''[0-9,a-f,A-F]{2} [0-9,a-f,A-F]{2} [0-9,a-f,A-F]{2} [0-9,a-f,A-F]{2} [0-9,a-f,A-F]{2} [0-9,a-f,A-F]{2}''
   or P_MACADDRESS REGEXP  ''[0-9,a-f,A-F]{3}.[0-9,a-f,A-F]{3}.[0-9,a-f,A-F]{3}.[0-9,a-f,A-F]{3}''  -- nor really valid, but present in DB
   or P_MACADDRESS REGEXP  ''[0-9,a-f,A-F]{12}'') THEN
    TRUE
ELSE
    FALSE
END    
';
CREATE OR REPLACE FUNCTION "FN_CRM_IS_VALID_ASSET_ID_TATTOO"("P_ASSET_ID_TATTOO" VARCHAR(16777216))
RETURNS BOOLEAN
LANGUAGE SQL
COMMENT='Return true for a valid ASSET_ID_TATTOO format'
AS '
CASE
WHEN (P_ASSET_ID_TATTOO = '''' or P_ASSET_ID_TATTOO IS NULL) THEN
    FALSE
WHEN (P_ASSET_ID_TATTOO IN (''User-defined error: not set''
				,''User-defined error: missing folder''
				,''*.sharepointapps.cms.gov''			
				,''*.sharepointapps.cms.cmstest''
				,''*.sharepointapps.cms.cmsval''
				,''~uneval''
				,''~unk''
				,''<not reported>''
				,''Singular expression refers to non-unique object.''
				,''<not reported>''
				,''Fixlet not found error evaluating property.''
                ,''missing folder'' -- 230731
				,''NULL''
				,''Property not found.''
				,''Unknown error while evaluating property.''
				,''User-defined error: missing folder''
				,''User-defined error: not set''
                ,''/var/CMS/FISMA/Asset_ID'' -- 240827 CR-TBD new
				)
        or P_ASSET_ID_TATTOO LIKE ''%counteract_svc_act%password:%''
	    or P_ASSET_ID_TATTOO LIKE ''%error while evaluating property%''
	    or upper(P_ASSET_ID_TATTOO) LIKE ''%NO SUCH FILE OR DIRECTORY%'' -- 240827 CR-TBD chg to upper
	    or upper(P_ASSET_ID_TATTOO) LIKE ''%PERMISSION DENIED%'' -- 240827 CR-TBD chg to upper
        or upper(P_ASSET_ID_TATTOO) LIKE ''%OPERATION NOT PERMITTED%'' -- 240827 CR-TBD new
        or upper(P_ASSET_ID_TATTOO) LIKE ''%NOT FOUND%'' -- 240827 CR-TBD new
      )
THEN
    FALSE
ELSE
    TRUE
END    
';
CREATE OR REPLACE FUNCTION "FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO"("P_ASSET_ID_TATTOO" VARCHAR(16777216))
RETURNS BOOLEAN
LANGUAGE SQL
COMMENT='Return true when valid DRaaS-CACHE Tenant Tag/ASSET_ID_TATTOO format (CR978)'
AS '
CASE
WHEN (P_ASSET_ID_TATTOO IS NOT NULL and upper(P_ASSET_ID_TATTOO) NOT like ''%-%-MISP%'') THEN
    FALSE
ELSE
    TRUE
END    
';
CREATE OR REPLACE FUNCTION "FN_CRM_LOOKUP_ACRONYM"("P_SYSTEM_ACRONYM" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Find SYSTEM_ID based on System Acronym (Official or Common Name)'
AS '
SELECT distinct r.SYSTEM_ID
FROM (
select SYSTEM_ID FROM CORE.SYSTEMS where upper(acronym) = upper(P_SYSTEM_ACRONYM)
UNION ALL
select SYSTEM_ID FROM CORE.SYSTEM_COMMONNAME where upper(COMMONNAME) = upper(P_SYSTEM_ACRONYM)
) r
';
CREATE OR REPLACE FUNCTION "FN_CRM_METRICS"("P_Level" VARCHAR(16777216), "P_FISMAseverity" VARCHAR(16777216), "P_Is_Legacy" BOOLEAN)
RETURNS TABLE ("LEVELNAME" VARCHAR(16777216), "NOTCLOSEDTIMELY" NUMBER(38,0), "TOTALCLOSED" NUMBER(38,0), "PERCENTAGECLOSED" NUMBER(5,2))
LANGUAGE SQL
COMMENT='Returns Metrics Table'
AS '
    WITH
    o as (
        SELECT TOP 1 LevelName, Total
        from CORE.CRMP_Metrics 
        where LevelType=COALESCE(P_Level,''Datacenter'') and FISMAseverity=COALESCE(P_FISMAseverity,''Critical'') and MitigationStatus=''All'' and Is_Legacy=P_Is_Legacy 
    ),
    f as (
        SELECT TOP 1 LevelName, Total
        from CORE.CRMP_Metrics 
        where LevelType=COALESCE(P_Level,''Datacenter'') and FISMAseverity=COALESCE(P_FISMAseverity,''Critical'') and MitigationStatus=''Fixed'' and Is_Legacy=P_Is_Legacy 
    )
    select 
     COALESCE(o.LevelName,f.LevelName) LevelName
    ,COALESCE(o.Total,0) as NotClosedTimely
    ,COALESCE(f.Total,0) TotalClosed
    ,cast(COALESCE(f.Total,0)*100.00/(COALESCE(o.Total,0)+COALESCE(f.Total,0)) as decimal(5,2)) as PercentageClosed
    from o full join f on o.LevelName=f.LevelName      
';
CREATE OR REPLACE FUNCTION "FN_CRM_NUMERIC_SEVERITY"("P_CVSS_VERSION" VARCHAR(16777216), "P_CVSS" VARCHAR(16777216))
RETURNS NUMBER(38,0)
LANGUAGE SQL
COMMENT='Return number of FISMA Severity appropriate to CVSS_VERSION and CVSS'
AS '
--
-- Created 241106
-- Upstream views define P_CVSS as varchar and as such some rows have null or empty-string in the field
--
CASE P_CVSS_VERSION
    WHEN ''3.0'' THEN
    IFF(coalesce(nullif(P_CVSS,''''),0) >= 9.0,4,IFF(coalesce(nullif(P_CVSS,''''),0) >= 7.0,3,IFF(coalesce(nullif(P_CVSS,''''),0) >= 4.0,2,IFF(coalesce(nullif(P_CVSS,''''),0) >= 0.1,1,0))))
    WHEN ''2.0'' THEN
    IFF(coalesce(nullif(P_CVSS,''''),0) = 10.0,4,IFF(coalesce(nullif(P_CVSS,''''),0) >= 7.0,3,IFF(coalesce(nullif(P_CVSS,''''),0) >= 4.0,2,IFF(coalesce(nullif(P_CVSS,''''),0) >= 0.1,1,0))))
    ELSE 0
END
';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO"("P_ASSET_TAG" VARCHAR(16777216))
RETURNS TABLE ("ASSET_ID_TATTOO" VARCHAR(16777216), "DATACENTER_ID" VARCHAR(16777216), "TENANT_ID" VARCHAR(16777216))
LANGUAGE SQL
COMMENT='Return ASSET_ID_TATTOO,DATACENTER_ID,TENANT_ID after parsing P_ASSET_TAG'
AS '
--
-- 240827 create common function for all datastreams that must parse a DRAAS tag
--
SELECT split_part(upper(P_ASSET_TAG),''-'',1) as ASSET_ID_TATTOO
,SUBSTRING(P_ASSET_TAG, (POSITION(''-'',P_ASSET_TAG) + 1), (POSITION(''-MISP'',upper(P_ASSET_TAG)) - LEN(split_part(P_ASSET_TAG,''-'',1)) - 2)) as DATACENTER_ID
,upper(SUBSTRING(P_ASSET_TAG,(POSITION(''-MISP'',upper(P_ASSET_TAG)) + 1),20)) as TENANT_ID
';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_FORESCOUT_ASSET_ID"("P_FORESCOUT_ASSIGNED_LABELS" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse AXONIUS FORESCOUT_ASSIGNED_LABELS to yield FORESCOUT_ASSET_ID_TATTOO'
AS '
-- Note: CHR(92)||CHR(110) is 

TRIM(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(

(CASE 
    WHEN ( CHARINDEX(''/var/CMS/FISMA/Asset_ID/'',P_FORESCOUT_ASSIGNED_LABELS,1) > 0 ) THEN 
        split_part(SUBSTRING(P_FORESCOUT_ASSIGNED_LABELS, CHARINDEX(''/var/CMS/FISMA/Asset_ID/'',P_FORESCOUT_ASSIGNED_LABELS,1), 500),'','',1)
    WHEN ( CHARINDEX(''Asset_ID NEEDS TO BE DEVELOPED FOR WINDOWS'',P_FORESCOUT_ASSIGNED_LABELS,1) > 0 ) THEN 
        split_part(SUBSTRING(P_FORESCOUT_ASSIGNED_LABELS, CHARINDEX(''Asset_ID'',P_FORESCOUT_ASSIGNED_LABELS,1), 500),''CHR(92)||CHR(110)'',1)
    ELSE NULL 
END)

,''/var/CMS/FISMA/Asset_ID/'',''''),CHR(92)||CHR(110),''''),''Asset_ID'',''''),''"'',''''),''['',''''),'']'',''''))

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2"("P_STRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse Forescout string to yield ASSET_ID'
AS '

NULLIF(
TRIM(
REVERSE(SUBSTRING(REVERSE(substring(P_STRING,1,(POSITION(''Version: Asset_ID'',P_STRING) - 1))),1,((POSITION('':emaN'',REVERSE(substring(P_STRING,1,(POSITION(''Version: Asset_ID'',P_STRING) - 1))))) - 1)))
)
,'''') -- NULLIF

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_FORESCOUT_DATACENTER_ID"("P_FORESCOUT_ASSIGNED_LABELS" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse AXONIUS FORESCOUT_ASSIGNED_LABELS to yield FORESCOUT_DATACENTER_ID'
AS '
-- Found some records where DC terminates in semicolon instead of comma. Added replace of (;  Windows)
TRIM(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(

(CASE 
    WHEN ( CHARINDEX(''DC-'',P_FORESCOUT_ASSIGNED_LABELS,1) > 0 ) THEN
        substring(split_part(SUBSTRING(P_FORESCOUT_ASSIGNED_LABELS, CHARINDEX(''DC-'',P_FORESCOUT_ASSIGNED_LABELS,1), 500),'','',1),1,39)
    ELSE NULL 
END)

,'';  Windows'',''''),'';  Endpoint'',''''),''DC-'',''''),''"'',''''),''['',''''),'']'',''''))

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_FORESCOUT_FISMA_ID"("P_FORESCOUT_ASSIGNED_LABELS" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse AXONIUS FORESCOUT_ASSIGNED_LABELS to yield FORESCOUT_PRIMARY_FISMA_ID'
AS '
-- Note: CHR(92)||CHR(110) is 

TRIM(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
REPLACE(

(CASE 
    WHEN ( CHARINDEX(''/var/CMS/FISMA/Primary_FISMA_ID/'',P_FORESCOUT_ASSIGNED_LABELS,1) > 0 ) THEN 
        split_part(SUBSTRING(P_FORESCOUT_ASSIGNED_LABELS, CHARINDEX(''/var/CMS/FISMA/Primary_FISMA_ID/'',P_FORESCOUT_ASSIGNED_LABELS,1), 500),'','',1)
    WHEN ( CHARINDEX(''FD-'',P_FORESCOUT_ASSIGNED_LABELS,1) > 0 ) THEN 
        split_part(SUBSTRING(P_FORESCOUT_ASSIGNED_LABELS, CHARINDEX(''FD-'',P_FORESCOUT_ASSIGNED_LABELS,1), 500),'','',1)
    ELSE NULL 
END)

,''/var/CMS/FISMA/Primary_FISMA_ID/'',''''),CHR(92)||CHR(110),''''),''FD-'',''''),''"'',''''),''['',''''),'']'',''''))

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_FORESCOUT_FISMA_ID_V2"("P_STRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse Forescout string to yield Primary_FISMA_ID'
AS '

NULLIF(
TRIM(
REVERSE(SUBSTRING(REVERSE(substring(P_STRING,1,(POSITION(''Version: Primary_FISMA_ID'',P_STRING) - 1))),1,((POSITION('':emaN'',REVERSE(substring(P_STRING,1,(POSITION(''Version: Primary_FISMA_ID'',P_STRING) - 1))))) - 1)))
)
,'''') -- NULLIF

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_PLUGIN_TAGS"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse Tenable plugintext to yield entire tag string for Plugin_id 1221295 (Windows), Plugin_id 1218405 (Linux)'
AS ' 
/*

NOTE: CHAR(10) is a line-feed
NOTE: The order in which Asset_ID and Primary_FISMA_ID appear can vary


WINDOWS (plugin_id = 1221295)

<cm:compliance-check-name>Print out FISMA registry keys.</cm:compliance-check-name>
<cm:compliance-actual-value>The Asset_ID is TheActualValue
The Primary_FISMA_ID is TheActualValue</cm:compliance-actual-value>

LINUX (plugin_id = 1218405)

<cm:compliance-check-name>Check for Empty FISMA Tattoo files.</cm:compliance-check-name>
<cm:compliance-actual-value>The command returned : 

/var/CMS/FISMA/Asset_ID/TheActualValue
/var/CMS/FISMA/Primary_FISMA_ID/TheActualValue</cm:compliance-actual-value>
*/

TRIM(
RTRIM(
NULLIF(
REPLACE(
substring(P_TENABLE_PLUGINTEXT,(charindex(''<cm:compliance-actual-value>'',P_TENABLE_PLUGINTEXT,1) + 28)
,(charindex(''</cm:compliance-actual-value>'',P_TENABLE_PLUGINTEXT,1) - charindex(''<cm:compliance-actual-value>'',P_TENABLE_PLUGINTEXT,1) - 28))
,(''The command returned : '' || char(10) || char(10)),''''
)
,'''')
,CHAR(10))
)

-- POSSIBLE USE FOR RESULT e.g. PASSED/ERROR
-- || '';'' || substring(P_TENABLE_PLUGINTEXT,(charindex(''<cm:compliance-result>'',P_TENABLE_PLUGINTEXT,1) + 22)
--,(charindex(''</cm:compliance-result>'',P_TENABLE_PLUGINTEXT,1) - charindex(''<cm:compliance-result>'',P_TENABLE_PLUGINTEXT,1) - 22))
--



';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_ASSET_ID"("P_TENABLE_ASSET_TAGS" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE_ASSET_TAGS to yield ASSET_ID'
AS '

TRIM(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
(CASE CHARINDEX(''[version Asset_ID]'',split_part(P_TENABLE_ASSET_TAGS,'','',1),1) -- First
    WHEN 0 THEN 
        CASE CHARINDEX(''[version Asset_ID]'',split_part(P_TENABLE_ASSET_TAGS,'','',2),1) -- Second
            WHEN 0 THEN NULL
            ELSE split_part(P_TENABLE_ASSET_TAGS,'','',2)
        END
    ELSE split_part(P_TENABLE_ASSET_TAGS,'','',1)   
    END)
,''[version Asset_ID]'',''''),''"'',''''),''['',''''),'']'',''''))



';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_AWS_ACCOUNTID"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT from plugins 90191 or 90427 to yield AWS ACCOUNTID; 90191 Amazon Web Services EC2 Instance Metadata Enumeration (Unix), 90427 Amazon Web Services EC2 Instance Metadata Enumeration (Windows)'
AS '

CASE CHARINDEX(''accountId: '',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN NULL
    ELSE split_part(SUBSTRING(P_TENABLE_PLUGINTEXT,(CHARINDEX(''accountId: '',P_TENABLE_PLUGINTEXT,1) + 11),20),CHAR(10),1)
    END

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_AWS_INSTANCEID"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT from plugins 90191 or 90427 to yield AWS INSTANCEID; 90191 Amazon Web Services EC2 Instance Metadata Enumeration (Unix), 90427 Amazon Web Services EC2 Instance Metadata Enumeration (Windows)'
AS '

CASE CHARINDEX(''instanceId: '',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN NULL
    ELSE split_part(SUBSTRING(P_TENABLE_PLUGINTEXT,(CHARINDEX(''instanceId: '',P_TENABLE_PLUGINTEXT,1) + 12),20),CHAR(10),1)
    END

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_AZURE_INSTANCEID"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT from plugins 99171 or 99172 to yield AZURE INSTANCEID; \n99172 Microsoft Azure Instance Metadata Enumeration (Windows) -- 241021 Elliot suggested this as a possibility\n99171 Microsoft Azure Instance Metadata Enumeration (Unix) -- 241021 Elliot suggested this as a possibility\n'
AS '
CASE CHARINDEX(''- azure-instanceName:'',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN NULL
    ELSE TRIM(SUBSTRING(P_TENABLE_PLUGINTEXT,(POSITION(''- azure-instanceName:'',P_TENABLE_PLUGINTEXT) + 21),POSITION(''- azure-vmId'',P_TENABLE_PLUGINTEXT) - POSITION(''- azure-instanceName:'',P_TENABLE_PLUGINTEXT) - 21))
    END
   
';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_CREDENTIALED_SCAN"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT to yield CREDENTIALED_SCAN'
AS '

CASE CHARINDEX(''Credentialed_Scan'',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN ''FALSE''
    ELSE split_part(SUBSTRING(P_TENABLE_PLUGINTEXT,(CHARINDEX(''Credentialed_Scan:'',P_TENABLE_PLUGINTEXT,1) + 18),10),CHAR(10),1)
    END

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_CREDENTIALED_SCAN_V2"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT to yield CREDENTIALED_SCAN'
AS '
--
-- 241112 CR1028
-- Use Credentialed Checks parameter instead of Credentialed_Scan.
-- Elliot and Will confirmed that this (new) parameter is more consistent accross Nessus versions and OS.
-- The results can contain a qualified answer indicating how it was credential scanned but we are only interested in true or false

--
-- 123456789012345678901
-- Credentialed Checks :
--
-- Found the following distinct values among three months of data:
-- yes
-- noP
-- no 
--
CASE POSITION(''Credentialed checks :'',P_TENABLE_PLUGINTEXT)
    WHEN 0 THEN ''0''
    ELSE case SUBSTRING(P_TENABLE_PLUGINTEXT,(POSITION(''Credentialed checks :'',P_TENABLE_PLUGINTEXT) + 22),3)
        when ''yes'' then ''1''
        Else ''0''
        End
    END
';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_FISMA_ID"("P_TENABLE_ASSET_TAGS" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE_ASSET_TAGS to yield FISMA_ID'
AS '

TRIM(
REPLACE(
REPLACE(
REPLACE(
REPLACE(
(CASE CHARINDEX(''[version Primary_FISMA_ID]'',split_part(P_TENABLE_ASSET_TAGS,'','',1),1) -- First
    WHEN 0 THEN 
        CASE CHARINDEX(''[version Primary_FISMA_ID]'',split_part(P_TENABLE_ASSET_TAGS,'','',2),1) -- Second
            WHEN 0 THEN NULL
            ELSE split_part(P_TENABLE_ASSET_TAGS,'','',2)
        END
    ELSE split_part(P_TENABLE_ASSET_TAGS,'','',1)   
    END)
,''[version Primary_FISMA_ID]'',''''),''"'',''''),''['',''''),'']'',''''))



';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_NESSUS_VERSION"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT to yield NESSUS_VERSION'
AS '

CASE CHARINDEX(''Nessus version : '',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN NULL
    ELSE split_part(SUBSTRING(P_TENABLE_PLUGINTEXT,(CHARINDEX(''Nessus version : '',P_TENABLE_PLUGINTEXT,1) + 17),20),CHAR(10),1)
    END

';
CREATE OR REPLACE FUNCTION "FN_CRM_PARSE_TENABLE_SCAN_START_DATE"("P_TENABLE_PLUGINTEXT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Parse TENABLE PLUGINTEXT to yield SCAN_START_DATE'
AS '

CASE CHARINDEX(''Scan Start Date : '',P_TENABLE_PLUGINTEXT,1)
    WHEN 0 THEN ''1900-01-01''
    ELSE REPLACE(SUBSTRING(split_part(SUBSTRING(P_TENABLE_PLUGINTEXT,(CHARINDEX(''Scan Start Date : '',P_TENABLE_PLUGINTEXT,1) + 18),20),CHAR(10),1),1,16),''/'',''-'')
    END

';
CREATE OR REPLACE FUNCTION "FN_CRM_REMOVE_BRACKETS"("P_INSTRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Remove brackets and quotes from string'
AS '

REPLACE(
REPLACE(
REPLACE(P_INSTRING,''"'',''''),''['',''''),'']'','''')
   
';
CREATE OR REPLACE FUNCTION "FN_CRM_STRIPHTML"("P_HTMLText" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Remove unneeded characters from HTML address - any characters from < to > inclusive - like <p> or </p>'
AS '
-- 231016 added split_part for 11 thru 60, added trim
select TRIM(SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',1),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',2),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',3),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',4),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',5),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',6),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',7),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',8),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',9),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',10),''<'',1)
|| SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',11),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',12),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',13),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',14),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',15),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',16),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',17),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',18),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',19),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',20),''<'',1)
|| SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',21),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',22),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',23),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',24),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',25),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',26),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',27),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',28),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',29),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',30),''<'',1)
|| SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',31),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',32),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',33),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',34),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',35),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',36),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',37),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',38),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',39),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',40),''<'',1)
|| SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',41),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',42),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',43),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',44),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',45),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',46),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',47),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',48),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',49),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',50),''<'',1)
|| SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',51),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',52),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',53),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',54),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',55),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',56),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',57),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',58),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',59),''<'',1) || SPLIT_PART(SPLIT_PART(P_HTMLText,''>'',60),''<'',1))

';
CREATE OR REPLACE FUNCTION "SF_SEND_SLACK_MESSAGE"("MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION_CRM)
SECRETS = ('crm_sdw_url'=SLACK_CRM_SDW_WEBHOOK_URL)
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import date

def main(msg): 
    # Retrieve the Webhook URL from the SECRET object
    webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    
    slack_data = {
     "text": f"Snowflake alert: {msg}"
    }

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"
';
CREATE OR REPLACE PROCEDURE "SP_CRM_ASSETAGING"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Delete asset (device) from MDR (Asset table) when there has been no CDM activity in over x days.'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_ASSETAGING'';
DataCategory varchar;
RECORD_COUNT number;
AssetAgingDefaultCutoff number;
AssetAgingCloudCutoff number;
DeletionReason varchar;
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

AssetAgingDefaultCutoff := (select PARMINT FROM CORE.Config where ParmName = ''AssetAgingDefaultCutoff'');
AssetAgingCloudCutoff := (select PARMINT FROM CORE.Config where ParmName = ''AssetAgingCloudCutoff'');

IF (:AssetAgingDefaultCutoff = 0 or :AssetAgingCloudCutoff = 0) THEN
    Msg := ''WARNING: Config parameter not available'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    return Msg;
END IF;

--
-- Write all deletion candidates to the TEMP_ASSETS_TO_DELETE table
--

BEGIN TRANSACTION;
--
-- We expect the AWS datastream to always have the most current list of assets.
-- To be certain, if there was no change to LAST_CONFIRMED_TIME delete this AWS asset.
--
DeletionReason := ''AWS Asset deleted (not seen in latest download)'';
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE) -- 240816 CR-TBD add IS_PHYSICAL_DELETE
SELECT DW_ASSET_ID,:DeletionReason,CURRENT_TIMESTAMP,0 FROM ASSET
WHERE Is_Applicable = 1 and IS_FROM_AWS_FEED = TRUE and PREV_LAST_CONFIRMED_TIME = LAST_CONFIRMED_TIME;
RECORD_COUNT := SQLROWCOUNT;
Msg := DeletionReason || ''='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Age cloud assets
--
DeletionReason := ''AWS Asset deleted (last_confirmed_time >'' || :AssetAgingCloudCutoff || '' days)'';
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE) -- 240816 CR-TBD add IS_PHYSICAL_DELETE
SELECT DW_ASSET_ID,:DeletionReason,CURRENT_TIMESTAMP,0 FROM ASSET
WHERE DATEDIFF(day,last_confirmed_time,current_date()) > :AssetAgingCloudCutoff and Is_Applicable = 1 and IS_FROM_AWS_FEED = TRUE;
RECORD_COUNT := SQLROWCOUNT;
Msg := DeletionReason || ''='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Age on-prem assets or default
--
DeletionReason := ''On-Prem Asset deleted (last_confirmed_time >'' || :AssetAgingDefaultCutoff || '' days)'';
BEGIN TRANSACTION;
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE) -- 240816 CR-TBD add IS_PHYSICAL_DELETE
SELECT DW_ASSET_ID,:DeletionReason,CURRENT_TIMESTAMP,0 FROM ASSET
WHERE DATEDIFF(day,last_confirmed_time,current_date()) > :AssetAgingDefaultCutoff and Is_Applicable = 1 and IS_FROM_AWS_FEED = FALSE;

RECORD_COUNT := SQLROWCOUNT;
Msg := DeletionReason || ''='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- 240818 CR-TBD
--
-- Physically delete (in-active) AWS or on-prem assets more than 20 days old
--
DeletionReason := ''AWS/On-Prem (In-active) Asset deleted (last_confirmed_time > 20 days)'';
BEGIN TRANSACTION;
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT DW_ASSET_ID,:DeletionReason,CURRENT_TIMESTAMP,1 FROM ASSET
WHERE DATEDIFF(day,last_confirmed_time,current_date()) > 20 and Is_Applicable = 0;

RECORD_COUNT := SQLROWCOUNT;
Msg := DeletionReason || ''='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


CALL CORE.SP_CRM_DELETE_ASSET(); -- 240816 CR-TBD NEW


CALL CORE.SP_CRM_END_PROCEDURE(:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_ASSET_SOFTWARE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Populate CORE.ASSET_SOFTWARE table'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_ASSET_SOFTWARE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL SP_CRM_PULL_TENABLE_SOFTWARE_V2(CORE.FN_CRM_GET_SNAPSHOT_ID(''CCIC VUL''));
CALL SP_CRM_PULL_TENABLE_SOFTWARE_V2(CORE.FN_CRM_GET_SNAPSHOT_ID(''AWS VUL''));

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_AWS_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS (IUSG) HWAM, update/insert Master Device Record(MDR)'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_AWS_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_PULL_AWS_HWAM_V2(); -- 240730 CR942
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''AWS HWAM'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240726 CR928
CALL CORE.SP_CRM_PREP_RAW_HWAM_V2(:SNAPSHOT_ID); -- 240726 CR928
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_AXONIUS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AXONIUS (HIGLAS) HWAM, update/insert Master Device Record(MDR)'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_AXONIUS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);
--
-- 240917 CR981; creation of this stored procedure
--
CALL CORE.SP_CRM_PULL_AXONIUS();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''AXONIUS'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID);
CALL CORE.SP_CRM_PREP_RAW_HWAM_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CALCULATE_ASSET"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Calculate Asset procedure'
EXECUTE AS OWNER
AS 'DECLARE
Appl varchar := ''SP_CRM_CALCULATE_ASSET'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Unknown varchar := ''Unknown''; -- CR1037 241125
RECORD_COUNT number;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);



--
-- CR1037 241125 Merged SP_CRM_DETERMINE_DEVICETYPE_V2 into this stored procedure
--
----------------------------------------------------------------------------------------------
--
--          DETERMINE DW_DERIVED_DEVICETYPE
--
----------------------------------------------------------------------------------------------

BEGIN TRANSACTION;
--
-- Always re-evaluate DW_DERIVED_DEVICETYPE since OS or other factors may change
--
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = :Unknown
where Is_Applicable=1;
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE  = ''Firewall''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown
and NULLIF(OS,'''') is not null -- OS
and lower(OS) like ''%pan-os%'';
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE  = ''Laptop''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown 
and NULLIF(OS,'''') is not null -- OS
and (lower(OS) like ''%windows 10%'' 
-- 241125 CR1037    or lower(DEVICEMODEL) like ''%macbookpro%'' or lower(DEVICEMODEL) like ''%latitude%''
-- 241121 CR1037    or lower(OS) = ''windows'' 
-- 241121 CR1037    or lower(OS) = ''microsoft windows'' 
    or lower(OS) = ''microsoft windows 7'' or lower(OS) = ''microsoft windows 98''
    or lower(OS) = ''microsoft windows vista''
    or lower(OS) like ''%windows 11%''
    or OS = ''Sonoma (14)'' -- MacOS
    or lower(OS) like ''%apple macos%''
    or OS = ''Mac OS X 10.4''
    or OS = ''Sequoia (15)'' -- MacOS
    );
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = ''Load Balancer''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown
    and NULLIF(OS,'''') is not null -- OS
    and (lower(OS) like ''%f5 networks big-ip%'' or OS = ''Citrix NetScaler''
        or OS = ''F5 BIG-IP Local Traffic Manager load balancer''
        );
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = ''Router or Switch''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown
and NULLIF(OS,'''') is not null -- OS
and (lower(OS) like ''%cisco%'' or lower(OS) like ''%brocade switch%'' or lower(OS) like ''%fortios%'');
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = ''Server''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown
and (
    (NULLIF(OS,'''') is not null -- OS
        and (lower(OS) like ''%server%'' or lower(OS) like ''%aix%'' or lower(OS) like ''%centos%'' or lower(OS) like ''%freebsd%''
            or lower(OS) like ''%redhat%'' or lower(OS) like ''%red hat%'' or lower(OS) like ''%linux%'' or lower(OS) like ''%esxi%'' 
            or lower(OS) like ''%solaris%'' or lower(OS) = ''unix''
            or lower(OS) like ''%win2016 10%'' or lower(OS) like ''%win2019 10%'' or lower(OS) like ''%windows nt%''
            or lower(OS) like ''%microsoft windows 2000%''
            or lower(OS) = ''suse''
            or lower(OS) like ''%hp-ux%''
            or lower(OS) like ''ubuntu%''
            )
    )
    OR
    (NULLIF(OS_CPE,'''') is not null -- OS_CPE
        and (lower(OS_CPE) like ''%server%''
            )
    )
    OR 
    (NULLIF(DEVICEMODEL,'''') is not null -- DEVICEMODEL
        and (lower(DEVICEMODEL) like ''%ucsc-c220-m%'' or lower(DEVICEMODEL) like ''%ucsc-c240-m%'' or lower(DEVICEMODEL) like ''%poweredge%''
        )
    )
    OR
    (NULLIF(OS_VERSION,'''') is not null -- OS_VERSION
        and (lower(OS_VERSION) like ''%server%'' 
        )
    )
);
COMMIT;
  
BEGIN TRANSACTION;
--
-- 241122 CR1038 as per Teresa, Taggable assets are considered Endpoints but Vulnerability scan data does not necessarily indicate Endpoint
--
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = ''Unknown endpoint''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown and NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL;
-- 241122 CR1038 and (NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL or LASTSEEN_VUL IS NOT NULL);
COMMIT;

BEGIN TRANSACTION;
update CORE.ASSET
set DW_DERIVED_DEVICETYPE = ''Unknown Windows''
where Is_Applicable=1 and DW_DERIVED_DEVICETYPE = :Unknown and lower(OS) like ''%windows%'';
COMMIT;

----------------------------------------------------------------------------------------------
--
--          DETERMINE DEVICETYPE
--
----------------------------------------------------------------------------------------------

BEGIN TRANSACTION;
--
-- When ASSET.DEVICETYPE is not in DEVICETYPES (master) set to Unknown
--
update CORE.ASSET upd
set DEVICETYPE = :Unknown
FROM CORE.ASSET a
LEFT OUTER JOIN (select DISTINCT DEVICETYPE FROM CORE.DEVICETYPES) dt on dt.DEVICETYPE = a.DEVICETYPE
where a.Is_Applicable=1 and a.dw_asset_id = upd.dw_asset_id and dt.DEVICETYPE is null;
COMMIT;
--
-- Set DEVICETYPE to DW_DERIVED_DEVICETYPE when DEVICETYPE is any form of unknown (See DeviceTypes table)
--
BEGIN TRANSACTION;
update CORE.ASSET
set DEVICETYPE = DW_DERIVED_DEVICETYPE
where Is_Applicable=1 and lower(DEVICETYPE) like ''%unknown%'' and DW_DERIVED_DEVICETYPE <> :Unknown;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''DeviceType changes made='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


/******************     FUTURE: USE FORESCOUT_DEVICETYPE,TENABLE_DEVICETYPE  
************************************************************************/








----------------------------------------------------------------------------------------------
--
--            CALCULATE BOOLEANS
--
----------------------------------------------------------------------------------------------

BEGIN TRANSACTION;

UPDATE CORE.ASSET t
set Is_Scannable = 1
FROM CORE.ASSET a
join CORE.DEVICETYPES dt on dt.DEVICETYPE = a.DEVICETYPE
where t.DW_ASSET_ID = a.DW_ASSET_ID and a.Is_Applicable = 1 and a.Is_Scannable = 0 and (dt.Is_Scannable = 1 or a.LastSeen_VUL IS NOT NULL);

UPDATE CORE.ASSET t
set Is_Tattooable = 1
FROM CORE.ASSET a
join CORE.DEVICETYPES dt on dt.DEVICETYPE = a.DEVICETYPE
where t.DW_ASSET_ID = a.DW_ASSET_ID and a.Is_Applicable = 1 and a.Is_Tattooable = 0 and (dt.Is_Tattooable = 1 or a.asset_id_tattoo IS NOT NULL);

-- 241127 TESTING PROOF OF CONCEPT
UPDATE CORE.ASSET
set IS_ENDPOINT = 1
WHERE Is_Applicable = 1 and asset_id_tattoo IS NOT NULL;

COMMIT;


----------------------------------------------------------------------------------------------
--
--          CALCULATE NUMERICAL VALUES
--
----------------------------------------------------------------------------------------------

BEGIN TRANSACTION;

-- 231012 changed from CVSSV2BASESCORE to CVSSV3BASESCORE
Update CORE.ASSET
set VulnRiskTolerance = v.NUMERATOR / v.DENOMINATOR
FROM (select a.DW_ASSET_ID
    ,SUM(IFF(v.DW_VUL_ID is null,0,v.DaysSinceDiscovery * v.CVSSV3BASESCORE * s.OATO_Category * IFF(v.exploitAvailable=''Yes'',2,1)))::FLOAT as NUMERATOR
    ,(IFF(count(1)=0,1,count(1)))::float as DENOMINATOR
    FROM CORE.VW_ASSETS a 
    LEFT JOIN CORE.VW_VulMaster v on a.DW_ASSET_ID = v.DW_ASSET_ID and LOWER(v.MitigationStatus) IN (''open'',''reopened'')
    LEFT JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
    WHERE a.Is_Scannable=1 
    group by a.DW_ASSET_ID) v
WHERE v.DW_ASSET_ID = CORE.ASSET.DW_ASSET_ID;

COMMIT;

BEGIN TRANSACTION;
--250226 - ADD BETA_VulnRiskTolerance FROM  BUS_CYBER_RISK_MANAGEMENT.CORE.SEC_VW_VUL_RISK_TOLERANCE VIEW

UPDATE BUS_CYBER_RISK_MANAGEMENT.CORE.ASSET A
SET A.BETA_VulnRiskTolerance = V.VULRISKFACTOR
FROM  (
    SELECT
        a.DW_ASSET_ID,
        SUM(v.VULRISKFACTOR) AS VULRISKFACTOR
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.SEC_VW_VUL_RISK_TOLERANCE v
    LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_ASSETS a ON a.DW_ASSET_ID = v.DW_ASSET_ID
    GROUP BY a.DW_ASSET_ID
) V
WHERE V.DW_ASSET_ID = A.DW_ASSET_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END';
CREATE OR REPLACE PROCEDURE "SP_CRM_CCIC_TENABLE_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CCIC Tenable Vulnerability data, update/insert Master Device Record(MDR), update/insert Vulnerability Master'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_CCIC_TENABLE_VUL'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_PULL_CCIC_VUL_V2(); -- 240710 CR928
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''CCIC VUL'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240727 CR928
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS_TEST(:SNAPSHOT_ID); -- 240924 CR-TBD
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID); -- 250129 CR1077
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241025 CR1012
--
-- Now that metadata has been assigned (above) reset TEMP_DW_ASSET_ID and TEMP_ASSET_KEY then
-- call SP_CRM_IDENTIFY_RAW_ASSETS to assign new values based on available metatdata
--
UPDATE RAW_TENABLE_VUL set TEMP_DW_ASSET_ID = NULL,TEMP_ASSET_KEY = NULL WHERE SNAPSHOT_ID = :SNAPSHOT_ID; COMMIT; -- 240823 CR-TBD
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240823 CR-TBD
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928
CALL CORE.SP_CRM_LOAD_VULPLUGINS_MASTER(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LOAD_VULPLUGIN(:SNAPSHOT_ID); -- 230419 TEMPORARY UNTIL WE CAN DECOMMISSION CORE.VULPLUGIN

CALL CORE.SP_CRM_PULL_CCIC_VUL_MITIGATED();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''CCIC VUL MITIGATED'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240727 CR928
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS_TEST(:SNAPSHOT_ID); -- 240924 CR-TBD
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID); -- 250129 CR1077
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241025 CR1012

--
-- Now that metadata has been assigned (above) reset TEMP_DW_ASSET_ID and TEMP_ASSET_KEY then
-- call SP_CRM_IDENTIFY_RAW_ASSETS to assign new values based on available metatdata
--
UPDATE RAW_TENABLE_VUL set TEMP_DW_ASSET_ID = NULL,TEMP_ASSET_KEY = NULL WHERE SNAPSHOT_ID = :SNAPSHOT_ID; COMMIT; -- 240823 CR-TBD
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240823 
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928
CALL CORE.SP_CRM_UPDATE_VULPLUGINS_MASTER(:SNAPSHOT_ID);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CHECK_ASSETS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Check for asset issues e.g. duplicates'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CHECK_ASSETS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;
SNAPSHOT_ID NUMBER;
DATACATEGORY VARCHAR;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE CORE.TEMP_ASSET_ISSUE;


BEGIN TRANSACTION;
-- Search for duplicate DATACENTER_ID/ASSET_ID_TATTOO pairs
-- Oldest is Rank=1
INSERT INTO CORE.TEMP_ASSET_ISSUE(DW_ASSET_ID,INSERT_DATE,ISSUE_MSG)
SELECT r2.DW_ASSET_ID,CURRENT_TIMESTAMP,''Duplicate DATACENTER_ID/ASSET_ID_TATTOO pair''
    FROM (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID
        FROM CORE.ASSET r1
        JOIN (select DATACENTER_ID,ASSET_ID_TATTOO 
        FROM CORE.ASSET WHERE ASSET_ID_TATTOO is not null
        GROUP BY DATACENTER_ID,ASSET_ID_TATTOO
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO) r2 where r2.TheRank > 1;
    
RECORD_COUNT := SQLROWCOUNT;
If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF; 
COMMIT;

BEGIN TRANSACTION;
-- Search for duplicate DATACENTER_ID/NORMALIZED_FQDN pairs
-- Retain Asset record that has ASSET_ID_TATTOO
INSERT INTO CORE.TEMP_ASSET_ISSUE(DW_ASSET_ID,INSERT_DATE,ISSUE_MSG)
SELECT r2.DW_ASSET_ID,CURRENT_TIMESTAMP,''Duplicate DATACENTER_ID/NORMALIZED_FQDN pair''
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_FQDN order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID,r1.ASSET_ID_TATTOO
        FROM CORE.ASSET r1
        JOIN ASSETINTERFACE_FQDN f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_FQDN 
            FROM CORE.ASSET a
            JOIN ASSETINTERFACE_FQDN f0 on f0.dw_asset_id = a.dw_asset_id
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_FQDN
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_FQDN = f1.NORMALIZED_FQDN) r2 
where r2.TheRank > 1 and r2.ASSET_ID_TATTOO is null;

RECORD_COUNT := SQLROWCOUNT;
If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/NORMALIZED_FQDN='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF; 
COMMIT;


/***********
BEGIN TRANSACTION;
-- Search for duplicate DATACENTER_ID/NORMALIZED_HOSTNAME pairs
INSERT INTO CORE.TEMP_ASSET_ISSUE(DW_ASSET_ID,INSERT_DATE,ISSUE_MSG)
SELECT r2.DW_ASSET_ID,CURRENT_TIMESTAMP,''Duplicate (Active) DATACENTER_ID/NORMALIZED_HOSTNAME pair''
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_HOSTNAME order by r1.LAST_CONFIRMED_TIME desc,r1.DW_ASSET_ID desc) TheRank,r1.LAST_CONFIRMED_TIME,r1.DW_ASSET_ID
        FROM CORE.ASSET r1
        JOIN ASSETINTERFACE_HOSTNAME f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME 
            FROM CORE.ASSET a
            JOIN ASSETINTERFACE_HOSTNAME f0 on f0.dw_asset_id = a.dw_asset_id
            WHERE a.IS_APPLICABLE = 1
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_HOSTNAME = f1.NORMALIZED_HOSTNAME and r1.IS_APPLICABLE = 1) r2 where r2.TheRank > 1;

RECORD_COUNT := SQLROWCOUNT;
If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/NORMALIZED_HOSTNAME='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;
COMMIT;
**************/

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CONCLUDE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Complete remaining stored procedures to make CRM data ready for reporting'
EXECUTE AS CALLER
AS '

DECLARE
Appl varchar := ''SP_CRM_CONCLUDE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
TASK_NAME varchar;
STATE varchar;
ERROR_CODE varchar;
SCHEDULED_TIME datetime;
QUERY_START_TIME datetime;
COMPLETED_TIME datetime;
IS_ALL_TASKS_SUCCEEDED boolean := 1; -- 240607

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

--
-- Retrieve REPORT_ID generated by SP_CRM_INITIATE
--
REPORT_ID := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS);
Msg := ''REPORT_ID:'' || :REPORT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

--------------------------------------------------------------------------------------------------------------------
--
-- Check to ensure all upstream tasks have been completed - Abort this process if the tasks were not successful
--
--------------------------------------------------------------------------------------------------------------------

TASK_NAME := ''TSK_CRM_INITIATE'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_AWS_HWAM'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' ''); 
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_FORESCOUT_HWAM'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_KEV_CATALOG'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_CCIC_TENABLE_VUL'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

-- 240828 CR-TBD
TASK_NAME := ''TSK_CRM_CROWDSTRIKE'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_IUSG_TENABLE_VUL'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;


-- 241105 CR1024 deleted check for TSK_CRM_MAG_TENABLE_VUL
-- 241024 CR1012 added check for TSK_CRM_MAG_TENABLE_VUL


--
-- 240917 CR981 TSK_CRM_AXONIUS runs at 11:30 am after CONCLUDE so we cannot fail CONCLUDE if it didnt run yesterday
--
TASK_NAME := ''TSK_CRM_AXONIUS'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   

   
If (:IS_ALL_TASKS_SUCCEEDED = 0) THEN
    BEGIN
    ExceptionMsg := ''WARNING: One or more tasks failed to complete''; 
    raise CRM_logic_exception;
    END;
END IF;

--------------------------------------------------------------------------------------------------------------------
--
--                                  END CHECK OF UPSTREAM TASKS
--
--------------------------------------------------------------------------------------------------------------------

CALL CORE.SP_CRM_DATAFEED_CHECKER(); -- 240416 CR873

--
-- VUL (Update VULMASTER using VULPLUGINS_MASTER as the driver)
-- We do not pass the snapshot_ID because we are re-evaluating all VULPLUGINS_MASTER records
-- to update the VULMASTER table
--
CALL CORE.SP_CRM_UPDATE_VULCVE_MASTER(); -- Run only one time in the main process
 
CALL CORE.SP_CRM_UPDATE_KEV_CATALOG(); -- Must run after VULMASTER is updated
CALL CORE.SP_CRM_ASSETAGING();

CALL CORE.SP_CRM_CALCULATE_ASSET();
CALL CORE.SP_CRM_WRITE_ASSETINTERFACECOALESCED();
CALL CORE.SP_CRM_WRITE_SUMMARY_TABLES(:REPORT_ID);
CALL CORE.SP_CRM_CRMP_METRICS();
CALL CORE.SP_CRM_TRAL_EVALUATION();

-- 
-- Set REPORT_IDS.Is_EndOfMonth = 1 on the first of the month for the generation of Cyber Risk Reports
--
If (day(current_timestamp()) = 3) then -- For Feb 2025
    BEGIN
    BEGIN TRANSACTION;
    
    UPDATE REPORT_IDS
    set Is_EndOfMonth = 1  -- True
    WHERE REPORT_ID = :REPORT_ID;

    Msg := ''REPORT_IDS.IS_ENDOFMONTH set to TRUE'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

    COMMIT;
    END; 
END IF;

CALL CORE.SP_CRM_WRITE_ASSETHIST(:REPORT_ID); -- Added 230428
CALL CORE.SP_CRM_WRITE_VULHIST(:REPORT_ID); -- Added 230424
-- 240507 Moved CALL CORE.SP_CRM_WRITE_REPORTINGTABLES(); -- Added 230606
CALL CORE.SP_CRM_ASSET_SOFTWARE(); -- 240923 CR985
CALL CORE.SP_CRM_UPDATE_REPORT_IDS(); -- Added 231130
CALL CORE.SP_CRM_HEALTH_CHECKER(); -- Added 230726

BEGIN TRANSACTION; -- 240416 CR873 Set REPORT_IDS.IS_VIABLE to TRUE indicating successful completion of all stored procedures
UPDATE CORE.REPORT_IDS
set IS_VIABLE = 1 -- TRUE
WHERE REPORT_ID = :REPORT_ID;

Msg := ''REPORT_IDS.IS_VIABLE set to TRUE'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

CALL CORE.SP_CRM_WRITE_REPORTINGTABLES(); -- 240507

--
-- 240918 1151
-- Send success message to security-datalake-crm-sdw-alerts
--
select CORE.SF_SEND_SLACK_MESSAGE(''(SDW)SP_CRM_CONCLUDE completed successfully'');


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CREATE_ASSET_V1"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Process TEMP_HWAM data into ASSET table using unmatched records'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''CORE.SP_CRM_CREATE_ASSET_V1'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
UnknownDeviceType varchar := ''Unknown'';
DATACATEGORY varchar;
RECORD_COUNT NUMBER;
IS_FROM_AWS_FEED BOOLEAN;
ASSETS_CREATED number;

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which datastream we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


BEGIN TRANSACTION;
--
-- 240827 CR-TBD Separate create of Asset using DATACENTER_ID,ASSET_ID_TATTOO
--
INSERT INTO CORE.ASSET (
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,AWS_INSTANCESTATUS
    ,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,BIGFIX_ASSET_ID
	,BIOS_GUID
	,COMPUTER_TYPE
    ,CREATEDBY_SNAPSHOT_ID
    ,CREATEDBY_TEMP_DW_ASSET_ID -- 240705 CR928
 	,DATACENTER_ID
	,DATEDELETED
	,DATEMODIFIED
	,DELETIONREASON
    ,DEVICEMODEL
    ,DEVICETYPE
	,ENVIRONMENT
	,INSERT_DATE
	,IS_APPLICABLE
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
	,IS_FROM_AWS_FEED
	,IS_PRIMARY_FISMA_ID_DERIVED
	,IS_SCANNABLE
	,IS_TATTOOABLE
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,LAST_CONFIRMED_TIME
	,LASTASSETUPDATE
    ,MODIFIEDBY_SNAPSHOT_ID
    ,MODIFIEDBY_TEMP_DW_ASSET_ID -- 240705 CR928   
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
	,PREV_DATEDELETED 
	,PREV_LAST_CONFIRMED_TIME
	,SOURCE_TOOL_CREATE
	,SOURCE_TOOL_LASTSEEN
	,SYSTEM_ID
	,TENABLEUUID
	,VULNRISKTOLERANCE
)
SELECT
	src.ASSET_ID_TATTOO
	,src.AWS_ACCOUNTID
	,src.AWS_INSTANCESTATUS
    ,src.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,NULL -- BIGFIX_ASSET_ID
	,NULL -- BIOS_GUID
	,src.COMPUTER_TYPE
    ,:P_SNAPSHOT_ID
    ,src.TEMP_DW_ASSET_ID -- 240705 CR928 CREATEDBY_TEMP_DW_ASSET_ID
	,src.DATACENTER_ID
	,NULL -- DATEDELETED
	,NULL -- DATEMODIFIED
	,NULL -- DELETIONREASON,
    ,src.DEVICEMODEL
    ,coalesce(src.DEVICE_TYPE,:UnknownDeviceType) -- DEVICETYPE
	,src.ENVIRONMENT
	,CURRENT_TIMESTAMP() -- INSERT_DATE 
	,TRUE -- IS_APPLICABLE
    ,coalesce(src.IS_FORESCOUT_MANAGED,0) -- 240730 CR931
 	,:IS_FROM_AWS_FEED
	,FALSE -- IS_PRIMARY_FISMA_ID_DERIVED
	,FALSE -- IS_SCANNABLE
	,FALSE -- IS_TATTOOABLE
    ,coalesce(src.IS_TENABLE_CREDENTIALED_SCAN,0) -- 240730 CR931
	,src.LAST_CONFIRMED_TIME
	,CURRENT_TIMESTAMP() -- LASTASSETUPDATE
    ,:P_SNAPSHOT_ID -- 230927 MODIFIEDBY_SNAPSHOT_ID
    ,src.TEMP_DW_ASSET_ID -- 240705 CR928 MODIFIEDBY_TEMP_DW_ASSET_ID 
	,src.MOTHERBOARD
	,src.OS
    ,src.OS_BUILD_NUMBER -- 240821 CR958
 	,null -- PREV_DATEDELETED 
 	,''1900-01-01 01:00''::datetime -- PREV_LAST_CONFIRMED_TIME
	,src.SOURCE_TOOL -- SOURCE_TOOL_CREATE
	,src.SOURCE_TOOL -- SOURCE_TOOL_LASTSEEN
	,src.SYSTEM_ID
	,src.TENABLEUUID
	,0 -- VULNRISKTOLERANCE
FROM (
SELECT th.ASSET_ID_TATTOO
	,th.AWS_ACCOUNTID
 	,th.INSTANCESTATUS as AWS_INSTANCESTATUS
    ,th.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,th.COMPUTER_TYPE
	,th.DATACENTER_ID
    ,th.DEVICEMODEL
    ,th.DEVICE_TYPE
	,th.ENVIRONMENT
    ,th.IS_FORESCOUT_MANAGED -- 240730 CR931
    ,th.IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,th.LAST_CONFIRMED_TIME
	,th.MOTHERBOARD
	,th.OS
    ,th.OS_BUILD_NUMBER -- 240821 CR958
    ,th.TEMP_DW_ASSET_ID
	,th.SOURCE_TOOL
	,th.SYSTEM_ID
    ,th.TENABLEUUID
FROM CORE.TEMP_HWAM th
JOIN (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.LAST_CONFIRMED_TIME desc,r1.TEMP_HWAM_ID desc) TheRank,r1.TEMP_HWAM_ID
        FROM CORE.TEMP_HWAM r1
        JOIN (select DISTINCT DATACENTER_ID,ASSET_ID_TATTOO 
            FROM CORE.TEMP_HWAM 
            WHERE snapshot_id = :P_SNAPSHOT_ID and ASSET_ID_TATTOO IS NOT NULL) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO
        WHERE r1.snapshot_id = :P_SNAPSHOT_ID and r1.ASSET_ID_TATTOO IS NOT NULL) r2 
        WHERE r2.TheRank = 1 and r2.TEMP_HWAM_ID = th.TEMP_HWAM_ID and th.SNAPSHOT_ID = :P_SNAPSHOT_ID and th.DW_ASSET_ID IS NULL) src;
    
ASSETS_CREATED := SQLROWCOUNT;
Msg := ''ASSET (ASSET_ID_TATTOO) Insert='' || :ASSETS_CREATED;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

BEGIN TRANSACTION;
--
-- Update TEMP_HWAM with newly created DW_ASSET_ID
--
UPDATE TEMP_HWAM upd
set DW_ASSET_ID = a.DW_ASSET_ID
,DATEMODIFIED = current_timestamp()
,MATCHMETHOD = :Appl
FROM TEMP_HWAM th
JOIN ASSET a on a.MODIFIEDBY_SNAPSHOT_ID = th.SNAPSHOT_ID and a.MODIFIEDBY_TEMP_DW_ASSET_ID = th.TEMP_DW_ASSET_ID
WHERE upd.TEMP_HWAM_ID = th.TEMP_HWAM_ID and upd.DW_ASSET_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT = ASSETS_CREATED) THEN
    BEGIN
    Msg := ''TEMP_HWAM updated with DW_ASSET_ID (ASSET_ID_TATTOO) of new assets='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
ELSE
    BEGIN
    Msg := ''WARNING: Updated TEMP_HWAM.DW_ASSET_ID (ASSET_ID_TATTOO) differs from Assets Created(Delta)='' || (ASSETS_CREATED - :RECORD_COUNT);
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;
COMMIT;

BEGIN TRANSACTION;
INSERT INTO CORE.ASSET (
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,AWS_INSTANCESTATUS
    ,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,BIGFIX_ASSET_ID
	,BIOS_GUID
	,COMPUTER_TYPE
    ,CREATEDBY_SNAPSHOT_ID
    ,CREATEDBY_TEMP_DW_ASSET_ID -- 240705 CR928
 	,DATACENTER_ID
	,DATEDELETED
	,DATEMODIFIED
	,DELETIONREASON
    ,DEVICEMODEL
    ,DEVICETYPE
	,ENVIRONMENT
	,INSERT_DATE
	,IS_APPLICABLE
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
	,IS_FROM_AWS_FEED
	,IS_PRIMARY_FISMA_ID_DERIVED
	,IS_SCANNABLE
	,IS_TATTOOABLE
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,LAST_CONFIRMED_TIME
	,LASTASSETUPDATE
    ,MODIFIEDBY_SNAPSHOT_ID
    ,MODIFIEDBY_TEMP_DW_ASSET_ID -- 240705 CR928   
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
	,PREV_DATEDELETED 
	,PREV_LAST_CONFIRMED_TIME
	,SOURCE_TOOL_CREATE
	,SOURCE_TOOL_LASTSEEN
	,SYSTEM_ID
	,TENABLEUUID
	,VULNRISKTOLERANCE
)
SELECT
	src.ASSET_ID_TATTOO
	,src.AWS_ACCOUNTID
	,src.AWS_INSTANCESTATUS
    ,src.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,NULL -- BIGFIX_ASSET_ID
	,NULL -- BIOS_GUID
	,src.COMPUTER_TYPE
    ,:P_SNAPSHOT_ID
    ,src.TEMP_DW_ASSET_ID -- 240705 CR928 CREATEDBY_TEMP_DW_ASSET_ID
	,src.DATACENTER_ID
	,NULL -- DATEDELETED
	,NULL -- DATEMODIFIED
	,NULL -- DELETIONREASON,
    ,src.DEVICEMODEL
    ,coalesce(src.DEVICE_TYPE,:UnknownDeviceType) -- DEVICETYPE
	,src.ENVIRONMENT
	,CURRENT_TIMESTAMP() -- INSERT_DATE 
	,TRUE -- IS_APPLICABLE
    ,coalesce(src.IS_FORESCOUT_MANAGED,0) -- 240730 CR931
 	,:IS_FROM_AWS_FEED
	,FALSE -- IS_PRIMARY_FISMA_ID_DERIVED
	,FALSE -- IS_SCANNABLE
	,FALSE -- IS_TATTOOABLE
    ,coalesce(src.IS_TENABLE_CREDENTIALED_SCAN,0) -- 240730 CR931
	,src.LAST_CONFIRMED_TIME
	,CURRENT_TIMESTAMP() -- LASTASSETUPDATE
    ,:P_SNAPSHOT_ID -- 230927 MODIFIEDBY_SNAPSHOT_ID
    ,src.TEMP_DW_ASSET_ID
	,src.MOTHERBOARD
	,src.OS
    ,src.OS_BUILD_NUMBER -- 240821 CR958
 	,null -- PREV_DATEDELETED 
 	,''1900-01-01 01:00''::datetime -- PREV_LAST_CONFIRMED_TIME
	,src.SOURCE_TOOL -- SOURCE_TOOL_CREATE
	,src.SOURCE_TOOL -- SOURCE_TOOL_LASTSEEN
	,src.SYSTEM_ID
	,src.TENABLEUUID
	,0 -- VULNRISKTOLERANCE
FROM (SELECT
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,INSTANCESTATUS as AWS_INSTANCESTATUS
    ,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
	,COMPUTER_TYPE
	,DATACENTER_ID
    ,DEVICEMODEL
    ,DEVICE_TYPE
	,ENVIRONMENT
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,LAST_CONFIRMED_TIME
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
    ,TEMP_DW_ASSET_ID
	,SOURCE_TOOL
	,SYSTEM_ID
    ,TENABLEUUID
FROM CORE.TEMP_HWAM
where SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_ASSET_ID IS NULL) src;
    
ASSETS_CREATED := SQLROWCOUNT;
Msg := ''ASSET Insert='' || :ASSETS_CREATED;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;


BEGIN TRANSACTION; -- 240501
--
-- Update TEMP_HWAM with newly created DW_ASSET_ID
--
UPDATE TEMP_HWAM upd
set DW_ASSET_ID = a.DW_ASSET_ID
,DATEMODIFIED = current_timestamp()
,MATCHMETHOD = :Appl -- 240501 1441 to help diagnostics
FROM TEMP_HWAM th
JOIN ASSET a on a.MODIFIEDBY_SNAPSHOT_ID = th.SNAPSHOT_ID and a.MODIFIEDBY_TEMP_DW_ASSET_ID = th.TEMP_DW_ASSET_ID
WHERE upd.TEMP_HWAM_ID = th.TEMP_HWAM_ID and upd.DW_ASSET_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT = ASSETS_CREATED) THEN
    BEGIN
    Msg := ''TEMP_HWAM updated with DW_ASSET_ID of new assets='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
ELSE
    BEGIN
    Msg := ''WARNING: Updated TEMP_HWAM.DW_ASSET_ID differs from Assets Created(Delta)='' || (ASSETS_CREATED - :RECORD_COUNT);
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;
COMMIT; -- 240501

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CREATE_ASSET_V1_TEST"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Process TEMP_HWAM data into ASSET table using unmatched records'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''CORE.SP_CRM_CREATE_ASSET_V1'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
UnknownDeviceType varchar := ''Unknown'';
AWS_HWAMDataStream varchar := ''AWS HWAM'';
AWS_TENABLEDataStream varchar := ''AWS VUL'';
DATACATEGORY varchar;
RECORD_COUNT NUMBER;
IS_FROM_AWS_FEED BOOLEAN;
ASSETS_CREATED number;

BEGIN

select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


BEGIN TRANSACTION;
--
-- 240826 CR-TBD Separate create of Asset using DATACENTER_ID,ASSET_ID_TATTOO
--
INSERT INTO CORE.ASSET (
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,AWS_INSTANCESTATUS
	,BIGFIX_ASSET_ID
	,BIOS_GUID
	,COMPUTER_TYPE
    ,CREATEDBY_SNAPSHOT_ID
    ,CREATEDBY_TEMP_DW_ASSET_ID -- 240705 CR928
 	,DATACENTER_ID
	,DATEDELETED
	,DATEMODIFIED
	,DELETIONREASON
    ,DEVICEMODEL
    ,DEVICETYPE
	,ENVIRONMENT
	,INSERT_DATE
	,IS_APPLICABLE
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
	,IS_FROM_AWS_FEED
	,IS_PRIMARY_FISMA_ID_DERIVED
	,IS_SCANNABLE
	,IS_TATTOOABLE
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,LAST_CONFIRMED_TIME
	,LASTASSETUPDATE
    ,MODIFIEDBY_SNAPSHOT_ID
    ,MODIFIEDBY_TEMP_DW_ASSET_ID -- 240705 CR928   
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
	,PREV_DATEDELETED 
	,PREV_LAST_CONFIRMED_TIME
	,SOURCE_TOOL_CREATE
	,SOURCE_TOOL_LASTSEEN
	,SYSTEM_ID
	,TENABLEUUID
	,VULNRISKTOLERANCE
)
SELECT
	src.ASSET_ID_TATTOO
	,src.AWS_ACCOUNTID
	,src.AWS_INSTANCESTATUS
	,NULL -- BIGFIX_ASSET_ID
	,NULL -- BIOS_GUID
	,src.COMPUTER_TYPE
    ,:P_SNAPSHOT_ID
    ,src.MAX_TEMP_DW_ASSET_ID -- 240705 CR928 CREATEDBY_TEMP_DW_ASSET_ID
	,src.DATACENTER_ID
	,NULL -- DATEDELETED
	,NULL -- DATEMODIFIED
	,NULL -- DELETIONREASON,
    ,src.DEVICEMODEL
    ,coalesce(src.DEVICE_TYPE,:UnknownDeviceType) -- DEVICETYPE
	,src.ENVIRONMENT
	,CURRENT_TIMESTAMP() -- INSERT_DATE 
	,TRUE -- IS_APPLICABLE
    ,coalesce(src.IS_FORESCOUT_MANAGED,0) -- 240730 CR931
 	,:IS_FROM_AWS_FEED
	,FALSE -- IS_PRIMARY_FISMA_ID_DERIVED
	,FALSE -- IS_SCANNABLE
	,FALSE -- IS_TATTOOABLE
    ,coalesce(src.IS_TENABLE_CREDENTIALED_SCAN,0) -- 240730 CR931
	,src.LAST_CONFIRMED_TIME
	,CURRENT_TIMESTAMP() -- LASTASSETUPDATE
    ,:P_SNAPSHOT_ID -- 230927 MODIFIEDBY_SNAPSHOT_ID
    ,src.MAX_TEMP_DW_ASSET_ID -- 240705 CR928 MODIFIEDBY_TEMP_DW_ASSET_ID 
	,src.MOTHERBOARD
	,src.OS
    ,src.OS_BUILD_NUMBER -- 240821 CR958
 	,null -- PREV_DATEDELETED 
 	,''1900-01-01 01:00''::datetime -- PREV_LAST_CONFIRMED_TIME
	,src.SOURCE_TOOL -- SOURCE_TOOL_CREATE
	,src.SOURCE_TOOL -- SOURCE_TOOL_LASTSEEN
	,src.SYSTEM_ID
	,src.TENABLEUUID
	,0 -- VULNRISKTOLERANCE
FROM (
SELECT th.ASSET_ID_TATTOO
	,th.AWS_ACCOUNTID
	,th.INSTANCESTATUS as AWS_INSTANCESTATUS
	,th.COMPUTER_TYPE
	,th.DATACENTER_ID
    ,th.DEVICEMODEL
    ,th.DEVICE_TYPE
	,th.ENVIRONMENT
    ,th.IS_FORESCOUT_MANAGED -- 240730 CR931
    ,th.IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,th.LAST_CONFIRMED_TIME
	,th.MOTHERBOARD
	,th.OS
    ,th.OS_BUILD_NUMBER -- 240821 CR958
    ,th.TEMP_DW_ASSET_ID
	,th.SOURCE_TOOL
	,th.SYSTEM_ID
    ,th.TENABLEUUID
FROM CORE.TEMP_HWAM th
JOIN (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.LAST_CONFIRMED_TIME desc,r1.TEMP_HWAM_ID desc) TheRank,r1.TEMP_HWAM_ID
        FROM CORE.TEMP_HWAM r1
        JOIN (select DISTINCT DATACENTER_ID,ASSET_ID_TATTOO 
            FROM CORE.TEMP_HWAM 
            WHERE snapshot_id = :P_SNAPSHOT_ID and ASSET_ID_TATTOO IS NOT NULL) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO
        WHERE r1.snapshot_id = :P_SNAPSHOT_ID and r1.ASSET_ID_TATTOO IS NOT NULL) r2 
        where r2.TheRank = 1 and r2.TEMP_HWAM_ID = th.TEMP_HWAM_ID and th.SNAPSHOT_ID = :P_SNAPSHOT_ID and th.DW_ASSET_ID IS NULL) src;
    
ASSETS_CREATED := SQLROWCOUNT;
Msg := ''ASSET (ASSET_ID_TATTOO) Insert='' || :ASSETS_CREATED;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;


--------------

BEGIN TRANSACTION;

INSERT INTO CORE.ASSET (
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,AWS_INSTANCESTATUS
	,BIGFIX_ASSET_ID
	,BIOS_GUID
	,COMPUTER_TYPE
    ,CREATEDBY_SNAPSHOT_ID
    ,CREATEDBY_TEMP_DW_ASSET_ID -- 240705 CR928
 	,DATACENTER_ID
	,DATEDELETED
	,DATEMODIFIED
	,DELETIONREASON
    ,DEVICEMODEL
    ,DEVICETYPE
	,ENVIRONMENT
	,INSERT_DATE
	,IS_APPLICABLE
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
	,IS_FROM_AWS_FEED
	,IS_PRIMARY_FISMA_ID_DERIVED
	,IS_SCANNABLE
	,IS_TATTOOABLE
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,LAST_CONFIRMED_TIME
	,LASTASSETUPDATE
    ,MODIFIEDBY_SNAPSHOT_ID
    ,MODIFIEDBY_TEMP_DW_ASSET_ID -- 240705 CR928   
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
	,PREV_DATEDELETED 
	,PREV_LAST_CONFIRMED_TIME
	,SOURCE_TOOL_CREATE
	,SOURCE_TOOL_LASTSEEN
	,SYSTEM_ID
	,TENABLEUUID
	,VULNRISKTOLERANCE
)
SELECT
	src.ASSET_ID_TATTOO
	,src.AWS_ACCOUNTID
	,src.AWS_INSTANCESTATUS
	,NULL -- BIGFIX_ASSET_ID
	,NULL -- BIOS_GUID
	,src.COMPUTER_TYPE
    ,:P_SNAPSHOT_ID
    ,src.MAX_TEMP_DW_ASSET_ID -- 240705 CR928 CREATEDBY_TEMP_DW_ASSET_ID
	,src.DATACENTER_ID
	,NULL -- DATEDELETED
	,NULL -- DATEMODIFIED
	,NULL -- DELETIONREASON,
    ,src.DEVICEMODEL
    ,coalesce(src.DEVICE_TYPE,:UnknownDeviceType) -- DEVICETYPE
	,src.ENVIRONMENT
	,CURRENT_TIMESTAMP() -- INSERT_DATE 
	,TRUE -- IS_APPLICABLE
    ,coalesce(src.IS_FORESCOUT_MANAGED,0) -- 240730 CR931
 	,:IS_FROM_AWS_FEED
	,FALSE -- IS_PRIMARY_FISMA_ID_DERIVED
	,FALSE -- IS_SCANNABLE
	,FALSE -- IS_TATTOOABLE
    ,coalesce(src.IS_TENABLE_CREDENTIALED_SCAN,0) -- 240730 CR931
	,src.LAST_CONFIRMED_TIME
	,CURRENT_TIMESTAMP() -- LASTASSETUPDATE
    ,:P_SNAPSHOT_ID -- 230927 MODIFIEDBY_SNAPSHOT_ID
    ,src.MAX_TEMP_DW_ASSET_ID -- 240705 CR928 MODIFIEDBY_TEMP_DW_ASSET_ID 
	,src.MOTHERBOARD
	,src.OS
    ,src.OS_BUILD_NUMBER -- 240821 CR958
 	,null -- PREV_DATEDELETED 
 	,''1900-01-01 01:00''::datetime -- PREV_LAST_CONFIRMED_TIME
	,src.SOURCE_TOOL -- SOURCE_TOOL_CREATE
	,src.SOURCE_TOOL -- SOURCE_TOOL_LASTSEEN
	,src.SYSTEM_ID
	,src.TENABLEUUID
	,0 -- VULNRISKTOLERANCE
FROM (
SELECT DISTINCT
	ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,INSTANCESTATUS as AWS_INSTANCESTATUS
	,COMPUTER_TYPE
	,DATACENTER_ID
    ,DEVICEMODEL
    ,DEVICE_TYPE
	,ENVIRONMENT
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,MAX(TO_TIMESTAMP_LTZ(LAST_CONFIRMED_TIME)) as LAST_CONFIRMED_TIME
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
    ,MAX(TEMP_DW_ASSET_ID) as MAX_TEMP_DW_ASSET_ID
	,SOURCE_TOOL
	,SYSTEM_ID
    ,TENABLEUUID
FROM CORE.TEMP_HWAM
where SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_ASSET_ID IS NULL -- 240621 CR930 and ASSET_ID_TATTOO IS NULL
group by ASSET_ID_TATTOO
	,AWS_ACCOUNTID
	,INSTANCESTATUS
	,COMPUTER_TYPE
	,DATACENTER_ID
    ,DEVICEMODEL
    ,DEVICE_TYPE
	,ENVIRONMENT
    ,IS_FORESCOUT_MANAGED -- 240730 CR931
    ,IS_TENABLE_CREDENTIALED_SCAN -- 240730 CR931
	,MOTHERBOARD
	,OS
    ,OS_BUILD_NUMBER -- 240821 CR958
    ,SOURCE_TOOL
	,SYSTEM_ID
    ,TENABLEUUID) src;
    
ASSETS_CREATED := SQLROWCOUNT;
Msg := ''ASSET Insert='' || :ASSETS_CREATED;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION; -- 240501
--
-- Update TEMP_HWAM with newly created DW_ASSET_ID
--
UPDATE TEMP_HWAM upd
set DW_ASSET_ID = a.DW_ASSET_ID
,DATEMODIFIED = current_timestamp()
,MATCHMETHOD = :Appl -- 240501 1441 to help diagnostics
FROM TEMP_HWAM th
JOIN ASSET a on a.MODIFIEDBY_SNAPSHOT_ID = th.SNAPSHOT_ID and a.MODIFIEDBY_TEMP_DW_ASSET_ID = th.TEMP_DW_ASSET_ID
WHERE upd.TEMP_HWAM_ID = th.TEMP_HWAM_ID and upd.DW_ASSET_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT = ASSETS_CREATED) THEN
    BEGIN
    Msg := ''TEMP_HWAM was updated with DW_ASSET_ID of new assets='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
ELSE
    BEGIN
    Msg := ''WARNING: Updated TEMP_HWAM.DW_ASSET_ID differs from Assets Created(Delta)='' || (ASSETS_CREATED - :RECORD_COUNT);
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;
COMMIT; -- 240501

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRMP_METRICS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write most current vulnerability counts to CORE.CRMP_METRICS table'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRMP_METRICS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
NotSpecified varchar := ''Not specified'';
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


Truncate table CORE.CRMP_Metrics; 
------Datacenter
--------------------------------------------Critical/System-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 30
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 30
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

----------------------------------------------High/System-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 60
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 60
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''System'' as LevelType
,t.Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.Acronym, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Acronym;

------Component
--------------------------------------------Critical/Component-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 30
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 30
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

----------------------------------------------High/Component-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 60
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 60
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''Component'' as LevelType
,t.Component_Acronym as LevelName
,count(1) as Total 
from (
SELECT sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.COMPONENT_ACRONYM, vm.DW_ASSET_ID, vm.CVE
) t
GROUP BY t.Component_Acronym;

------Group
--------------------------------------------Critical/Group-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 30
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 30
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''Critical'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''critical'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

----------------------------------------------High/Group-------------------------------------------------------------
INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,0 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''fixed'',''open'',''reopened'') 
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery > 60
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,0 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 0 and vm.DaysSinceDiscovery <= 60
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''All'' as MitigationStatus
,1 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) IN (''open'',''reopened'') 
and vm.Is_Legacy = 1 
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

INSERT into CORE.CRMP_METRICS (FISMASEVERITY,MITIGATIONSTATUS,IS_LEGACY,LEVELTYPE,LEVELNAME,TOTAL)  
select ''High'' as FISMAseverity 
,''Fixed'' as MitigationStatus
,1 as Is_Legacy
,''Group'' as LevelType
,coalesce(t.Group_Acronym,:NotSpecified) as LevelName
,count(1) as Total 
from (
SELECT sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
FROM CORE.VW_VULMASTER vm
INNER JOIN CORE.VW_SYSTEMS sf ON sf.SYSTEM_ID = vm.DATACENTER_ID and sf.Is_OperationalSystem = 1
WHERE LOWER(vm.FISMAseverity)=''high'' and LOWER(vm.MitigationStatus) = ''fixed''
and vm.Is_Legacy = 1 
GROUP BY sf.Group_Acronym,VM.DW_ASSET_ID,vm.CVE
) t
GROUP BY t.Group_Acronym;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CROWDSTRIKE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CROWDSTRIKE HWAM, update/insert Master Device Record(MDR)'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CROWDSTRIKE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);
--
-- 240821 CR958; creation of this stored procedure
--
CALL CORE.SP_CRM_PULL_CROWDSTRIKE();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''CROWDSTRIKE'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID);
CALL CORE.SP_CRM_PREP_RAW_HWAM_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_DATAFEED_CHECKER"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Check freshness of datastream feeds'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_DATAFEED_CHECKER'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
CCIC_TENABLE_CUMULATIVE_VULNS_COUNT NUMBER;
CCIC_TENABLE_CUMULATIVE_INFO_COUNT NUMBER;
CCIC_TENABLE_MITIGATED_VULNS_COUNT NUMBER;
IUSG_CUMULATIVE_VULNS_COUNT NUMBER;
IUSG_MITIGATED_VULNS_COUNT NUMBER;
HWAM_AWS_COUNT NUMBER;
SDL_FORESCOUT_ASSETS_COUNT NUMBER;

CCIC_TENABLE_CUMULATIVE_VULNS_LASTSEEN DATETIME;
CCIC_TENABLE_CUMULATIVE_INFO_LASTSEEN DATETIME;
CCIC_TENABLE_MITIGATED_VULNS_LASTSEEN DATETIME;
IUSG_CUMULATIVE_VULNS_LASTSEEN DATETIME;
IUSG_MITIGATED_VULNS_LASTSEEN DATETIME;
HWAM_AWS_LASTSEEN DATETIME;
SDL_FORESCOUT_ASSETS_LASTSEEN DATETIME;

RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- We expect data every day but start 10 days back in case of back-to-back weekend failures

/*
select max(REPORTDATE),count(1) INTO CCIC_TENABLE_CUMULATIVE_VULNS_LASTSEEN,CCIC_TENABLE_CUMULATIVE_VULNS_COUNT 
    from APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS WHERE REPORTDATE::date > (current_date() - 10)::date;
*/
select m.REPORTDATE,count(1) INTO CCIC_TENABLE_CUMULATIVE_VULNS_LASTSEEN,CCIC_TENABLE_CUMULATIVE_VULNS_COUNT 
FROM (select max(REPORTDATE) as REPORTDATE
    from APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS WHERE REPORTDATE::date > (current_date() - 10)::date) m
JOIN APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS v on v.REPORTDATE::date = m.REPORTDATE::date
group by m.REPORTDATE;

Msg := ''SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS: Lastseen:'' || substring(:CCIC_TENABLE_CUMULATIVE_VULNS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :CCIC_TENABLE_CUMULATIVE_VULNS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select max(REPORTDATE),count(1) INTO CCIC_TENABLE_CUMULATIVE_INFO_LASTSEEN,CCIC_TENABLE_CUMULATIVE_INFO_COUNT 
    from APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO WHERE REPORTDATE::date > (current_date() - 10)::date;

Msg := ''SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO: Lastseen:'' || substring(:CCIC_TENABLE_CUMULATIVE_INFO_LASTSEEN::varchar,1,16) 
    || '', Count='' || :CCIC_TENABLE_CUMULATIVE_INFO_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select max(REPORTDATE),count(1) INTO CCIC_TENABLE_MITIGATED_VULNS_LASTSEEN,CCIC_TENABLE_MITIGATED_VULNS_COUNT
    from APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_MITIGATED_VULNS WHERE REPORTDATE::date > (current_date() - 10)::date;

Msg := ''SEC_VW_CCIC_TENABLE_MITIGATED_VULNS: Lastseen:'' || substring(:CCIC_TENABLE_MITIGATED_VULNS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :CCIC_TENABLE_MITIGATED_VULNS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select max(S3_FILE_CREATE),count(1) INTO IUSG_CUMULATIVE_VULNS_LASTSEEN,IUSG_CUMULATIVE_VULNS_COUNT
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS WHERE S3_FILE_CREATE::date > (current_date() - 10)::date;

Msg := ''SEC_VW_IUSG_CUMULATIVE_VULNS: Lastseen:'' || substring(:IUSG_CUMULATIVE_VULNS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :IUSG_CUMULATIVE_VULNS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select max(S3_FILE_CREATE),count(1) INTO IUSG_MITIGATED_VULNS_LASTSEEN,IUSG_MITIGATED_VULNS_COUNT
    from APP_TENABLE.SHARED.SEC_VW_IUSG_MITIGATED_VULNS WHERE S3_FILE_CREATE::date > (current_date() - 10)::date;

Msg := ''SEC_VW_IUSG_MITIGATED_VULNS: Lastseen:'' || substring(:IUSG_MITIGATED_VULNS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :IUSG_MITIGATED_VULNS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    
select max(LAST_CONFIRMED_TIME),count(1) INTO HWAM_AWS_LASTSEEN,HWAM_AWS_COUNT
    from APP_CDM.SHARED.SEC_VW_HWAM_AWS; -- Always assumed to return most current data

Msg := ''SEC_VW_HWAM_AWS: Lastseen:'' || substring(:HWAM_AWS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :HWAM_AWS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

 select max(S3_FILE_TS),count(1) INTO SDL_FORESCOUT_ASSETS_LASTSEEN,SDL_FORESCOUT_ASSETS_COUNT
    from APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS::date > (current_date() - 10)::date;

Msg := ''SDL_FORESCOUT_ASSETS: Lastseen:'' || substring(:SDL_FORESCOUT_ASSETS_LASTSEEN::varchar,1,16) 
    || '', Count='' || :SDL_FORESCOUT_ASSETS_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_DELETE_ASSET"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Delete assets from ASSET table and dependent tables using TEMP_ASSETS_TO_DELETE as driver'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_DELETE_ASSET'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--
-- UNTIL CR IS CREATED TO DO PHYSICAL DELETIONS IN ALL CASES, USE TEMP_ASSETS_TO_DELETE.IS_PHYSICAL_DELETE TO DETERMINE LOGICAL/PHYSICAL
--

BEGIN TRANSACTION;
--
-- Logically Delete Asset
--
UPDATE CORE.ASSET upd
set Is_Applicable = 0
,dateDeleted = t.INSERT_DATE
,DeletionReason = t.DeletionReason
FROM CORE.TEMP_ASSETS_TO_DELETE t
WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.IS_PHYSICAL_DELETE = 0;
COMMIT;

BEGIN TRANSACTION;
Delete from CORE.ASSET_SOFTWARE where DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1); -- 250117
Delete from CORE.ASSETINTERFACECOALESCED WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSETINTERFACE_FQDN WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSETINTERFACE_HOSTNAME WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSETINTERFACE_IPV4 WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSETINTERFACE_IPV6 WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSETINTERFACE_MACADDRESS WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);;
Delete from CORE.ASSETINTERFACE_NETBIOSNAME WHERE DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.TEMP_SINGLE_ASSETINTERFACE where DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.VULMASTER where DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.VULPLUGINS_MASTER where DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
Delete from CORE.ASSET where DW_ASSET_ID IN (select DISTINCT DW_ASSET_ID from CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1);
COMMIT;

BEGIN TRANSACTION;
--
-- Write to ASSET_LOG all assets that have been deleted.
-- This is needed for audit purposes.
--
INSERT INTO CORE.ASSET_LOG (DW_ASSET_ID,COMMENTS,INSERT_DATE)
SELECT DW_ASSET_ID,(''Logical deletion: '' || DELETIONREASON),CURRENT_TIMESTAMP
FROM CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 0;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Logical Asset deletions='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

INSERT INTO CORE.ASSET_LOG (DW_ASSET_ID,COMMENTS,INSERT_DATE)
SELECT DW_ASSET_ID,(''Physical deletion: '' || DELETIONREASON),CURRENT_TIMESTAMP
FROM CORE.TEMP_ASSETS_TO_DELETE where IS_PHYSICAL_DELETE = 1;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Physical Asset deletions='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

TRUNCATE TABLE CORE.TEMP_ASSETS_TO_DELETE; -- 240927 CR-TBD

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_DELETE_DUPLICATE_ASSETS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Delete duplicate assets'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_DELETE_DUPLICATE_ASSETS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);
--
--
-- Since there can be overlap when determining duplicates we will execute SP_CRM_DELETE_ASSET after each population is found
--
--
BEGIN TRANSACTION;
--
-- Search for duplicate DATACENTER_ID/ASSET_ID_TATTOO pairs
-- Rank(1) is most current
-- Delete the Asset record if created after 240905 (when CR974 was completed)
--
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT r2.DW_ASSET_ID,''Duplicate DATACENTER_ID/ASSET_ID_TATTOO pair(Created after CR974)'',CURRENT_TIMESTAMP,1
    FROM (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.insert_date asc) TheRank,r1.DW_ASSET_ID,r1.INSERT_DATE
        FROM CORE.ASSET r1
        JOIN (select DATACENTER_ID,ASSET_ID_TATTOO 
        FROM CORE.ASSET WHERE ASSET_ID_TATTOO is not null
        GROUP BY DATACENTER_ID,ASSET_ID_TATTOO
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO) r2 
where r2.TheRank > 1 and r2.insert_date::date > ''2024-09-05''::date;
    
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/ASSET_ID_TATTOO(After CR974)='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_DELETE_ASSET();
    END;
END IF; 

BEGIN TRANSACTION;
--
-- Search for duplicate DATACENTER_ID/ASSET_ID_TATTOO pairs
-- Rank(1) is oldest
--
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT r2.DW_ASSET_ID,''Duplicate DATACENTER_ID/ASSET_ID_TATTOO pair'',CURRENT_TIMESTAMP,1
    FROM (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID
        FROM CORE.ASSET r1
        JOIN (select DATACENTER_ID,ASSET_ID_TATTOO 
        FROM CORE.ASSET WHERE ASSET_ID_TATTOO is not null
        GROUP BY DATACENTER_ID,ASSET_ID_TATTOO
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO) r2 where r2.TheRank > 1;
    
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_DELETE_ASSET();
    END;
END IF; 

BEGIN TRANSACTION;
--
-- Search for duplicate DATACENTER_ID/NORMALIZED_FQDN pairs, retaining Asset record that has ASSET_ID_TATTOO
-- Rank(1) is most current
--
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT r2.DW_ASSET_ID,''Duplicate DATACENTER_ID/NORMALIZED_FQDN pair, retain ASSET_ID_TATTOO'',CURRENT_TIMESTAMP,1
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_FQDN order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID,r1.ASSET_ID_TATTOO
        FROM CORE.ASSET r1
        JOIN ASSETINTERFACE_FQDN f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_FQDN 
            FROM CORE.ASSET a
            JOIN ASSETINTERFACE_FQDN f0 on f0.dw_asset_id = a.dw_asset_id
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_FQDN
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_FQDN = f1.NORMALIZED_FQDN) r2 
where r2.TheRank > 1 and r2.ASSET_ID_TATTOO is null;

RECORD_COUNT := SQLROWCOUNT;
COMMIT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/NORMALIZED_FQDN(retain ASSET_ID_TATTOO)='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_DELETE_ASSET();
    END;
END IF; 

BEGIN TRANSACTION;
--
-- Search for duplicate DATACENTER_ID/NORMALIZED_FQDN pairs
-- Since we already deleted the duplicate FQDN while retaining ASSET_ID_TATTOO we now want to delete any FQDN 
-- AWS (56FFF52E-175B-4E48-9B38-669C8BC74899) is exempt
-- Q-NET (DB0B74DC-610A-4D35-B645-B16059B5D64A) is exempt
-- AWS GovCloud (5d8a99a8db672340f99cfd721f96190d) is exempt
--
-- Rank(1) is oldest
--
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT r2.DW_ASSET_ID,''Duplicate DATACENTER_ID/NORMALIZED_FQDN pair'',CURRENT_TIMESTAMP,1
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_FQDN order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID
        FROM CORE.ASSET r1
        JOIN ASSETINTERFACE_FQDN f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_FQDN 
            FROM CORE.ASSET a
            JOIN ASSETINTERFACE_FQDN f0 on f0.dw_asset_id = a.dw_asset_id
        WHERE a.DATACENTER_ID NOT IN (''56FFF52E-175B-4E48-9B38-669C8BC74899'',''5d8a99a8db672340f99cfd721f96190d'',''DB0B74DC-610A-4D35-B645-B16059B5D64A'')
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_FQDN
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_FQDN = f1.NORMALIZED_FQDN) r2 
where r2.TheRank > 1;

RECORD_COUNT := SQLROWCOUNT;
COMMIT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/NORMALIZED_FQDN='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_DELETE_ASSET();
    END;
END IF; 

BEGIN TRANSACTION;
--
-- Search for duplicate DATACENTER_ID/NORMALIZED_HOSTNAME pairs, retaining Asset record that has ASSET_ID_TATTOO
-- AWS (56FFF52E-175B-4E48-9B38-669C8BC74899) is exempt
-- Q-NET (DB0B74DC-610A-4D35-B645-B16059B5D64A) is exempt
-- AWS GovCloud (5d8a99a8db672340f99cfd721f96190d) is exempt
--
-- TheRank > 0 is to obtain all duplicates
--
INSERT INTO CORE.TEMP_ASSETS_TO_DELETE (DW_ASSET_ID,DELETIONREASON,INSERT_DATE,IS_PHYSICAL_DELETE)
SELECT r2.DW_ASSET_ID,''Duplicate DATACENTER_ID/NORMALIZED_HOSTNAME pair, retain ASSET_ID_TATTOO'',CURRENT_TIMESTAMP,1
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_HOSTNAME order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID,r1.ASSET_ID_TATTOO
        FROM CORE.ASSET r1
        JOIN ASSETINTERFACE_HOSTNAME f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME 
            FROM CORE.ASSET a
            JOIN ASSETINTERFACE_HOSTNAME f0 on f0.dw_asset_id = a.dw_asset_id
            where a.DATACENTER_ID NOT IN (''56FFF52E-175B-4E48-9B38-669C8BC74899'',''5d8a99a8db672340f99cfd721f96190d'',''DB0B74DC-610A-4D35-B645-B16059B5D64A'')
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_HOSTNAME = f1.NORMALIZED_HOSTNAME) r2 
where r2.TheRank > 1 and r2.ASSET_ID_TATTOO is null;

RECORD_COUNT := SQLROWCOUNT;
COMMIT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Duplicate DATACENTER_ID/NORMALIZED_HOSTNAME='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_DELETE_ASSET();
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_END_PROCEDURE"("P_APPL" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write End of Application message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_END_PROCEDURE'';
ExceptionMsg varchar := ''Default'';
StartOfProcedure datetime;
ELAPSED_MILLISECONDS NUMBER;
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

ELAPSED_MILLISECONDS := 0; -- 240429 timestampdiff(millisecond,StartOfProcedure,CURRENT_TIMESTAMP());

BEGIN TRANSACTION;
insert into CORE.MSGLOG (APPL,ELAPSED_MILLISECONDS,MSG) VALUES(:P_APPL,:ELAPSED_MILLISECONDS,''Ending Application'');
COMMIT;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_FISMAREPORT"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='Create quarterly fisma audit report'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_FismaReport'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number := 0;

d int; 
mindate  date; 
maxdate date; 
today date;
res RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

DROP TABLE IF EXISTS CORE.FismaReportTemp1;
DROP TABLE IF EXISTS CORE.FismaReportTemp2; 
DROP TABLE IF EXISTS CORE.FismaReportTemp3;

CREATE OR REPLACE TEMPORARY TABLE CORE.FismaReportTemp2(
    DW_ASSET_ID NUMBER(38,0) NOT NULL,
    DeviceRole VARCHAR(16777216) NULL,
    DeviceType VARCHAR(16777216) NOT NULL,
    Scanned int DEFAULT 0
);

CREATE TEMPORARY TABLE CORE.FismaReportTemp1 AS
SELECT * FROM CORE.Asset  
where Is_Applicable = 1 
and DATACENTER_ID in (select SYSTEM_ID from CORE.systems where ACRONYM IN (''EDC4'',''CDS VDC GSS'',''HIGLAS'',''NGS VDC'',''Q-Net'',''PESVDC'',''CMS-ESSM''));
--and (LASTMODIFIEDBY_FORESCOUT is not null or UPPER(SOURCE_TOOL_CREATE) = ''FORESCOUT'' or UPPER(SOURCE_TOOL_HWAM)=''FORESCOUT'');

INSERT INTO CORE.FismaReportTemp2(DW_ASSET_ID,DeviceRole,DeviceType)
with a as (
SELECT a.DW_ASSET_ID, dr.DeviceRole,a.os,a.os_cpe,
IFF(UPPER(a.DeviceType) in (''DESKTOP'',''SERVER'',''WORKSTATION'') OR (UPPER(dr.DeviceRole)<>''NETWORKING DEVICE'' AND UPPER(a.DeviceType)=''COMPUTER''),''Non-Portable Computers'',
IFF(UPPER(a.DeviceType) in (''LAPTOP''),''Laptops and Netbooks'',
IFF(UPPER(a.DeviceType) in (''HYPERVISOR''),''Addressable Virtual Machines'',
IFF(UPPER(a.DeviceType) in (''IP PHONE''),''Smartphones'',
IFF(UPPER(a.DeviceType) in (''ROUTER OR SWITCH'',''ROUTER'',''SWITCH'',''NETWORKING'',''NETWORK DEVICE'',''LOAD BALANCER'',''NAT'',''FIREWALL'') or (UPPER(dr.DeviceRole)=''NETWORKING DEVICE'' and UPPER(a.DeviceType)=''COMPUTER''),''Networking Devices'',
IFF(UPPER(a.DeviceType) in (''VOIP'',''ROUTER'',''NETWORK ACCESS CONTROL'',''WIRELESS ACCESS POINT'',''NETWORK MANAGEMENT'',''APPLIANCE''),''Other Communication Devices'',
IFF(UPPER(a.DeviceType) in (''PRINTER'',''NETWORK ATTACHED STORAGE''),''Other Input/Output Devices (with their own address)'',
IFF(UPPER(a.DeviceType) in (''STORAGE''),''Other Addressable Devices on the Network'',	
a.DeviceType)))))))) DeviceType
FROM CORE.FismaReportTemp1 a
left outer join CORE.DeviceTypes dr on upper(dr.DEVICETYPE) = upper(a.DEVICETYPE) 
),
b as (
SELECT a.DW_ASSET_ID, a.DeviceRole,
IFF(UPPER(a.DeviceType) not in (
 ''Addressable Virtual Machines''
,''Laptops and Netbooks''
,''Non-Portable Computers''
,''Smartphones''
,''Other Addressable Devices on the Network''
,''Other Input/Output Devices (with their own address)''
,''Networking Devices''
,''Other Communication Devices''	
),
IFF(UPPER(os_cpe) like ''%WINDOWS%'' or UPPER(os_cpe) like ''%REDHAT%'' or UPPER(os) like ''%WINDOWS%'' or UPPER(os) like ''%WIN%[1-9][1-9]%'' or UPPER(os) like ''%RED%HAT%'' 
or UPPER(os) like ''%UNIX%'' or UPPER(os) like ''%APPLE%OS%''  or UPPER(os) like ''%LINUX%'' or UPPER(os) like ''%UBUNTU%'' or UPPER(os) like ''%FEDORA%''
or UPPER(os) like ''%CENTOS%''  or UPPER(os) like ''%FREEBSD%'',	''Non-Portable Computers'',
IFF(UPPER(os) like ''%JUNOS%'' or UPPER(os) like ''%CISCO%'',''Networking Devices'',
IFF(UPPER(a.DeviceType) in (''Other'',''Not Provided'',''~NoData~''),''Unknown'',
a.DeviceType))),
a.DeviceType) DeviceType
FROM a 
)
select DW_ASSET_ID,
IFF( DeviceType in (''Non-Portable Computers'',''Laptops and Netbooks'',''Addressable Virtual Machines''), ''Endpoint'',
IFF( DeviceType in (''Smartphones''), ''Endpoints (Mobile Assets)'',
IFF( DeviceType in (''Networking Devices'',''Other Communication Devices''), ''Networking Devices'',
IFF( DeviceType in (''Other Input/Output Devices (with their own address)'',''Other Addressable Devices on the Network''), ''Input/Output Devices'',
IFF(DeviceRole in (''Other''),''Unknown'',
DeviceRole))))) DeviceRole
,DeviceType
from b;

set today:=(select max(report_date)::DATE  FROM CORE.Report_IDs);

FOR i IN 1 TO 3 DO
    SET d:=IFF(i=1,7,IFF(i=2,14,30));
    SET maxdate:=today;	
     
    CREATE OR REPLACE TEMPORARY TABLE  CORE.FismaReportTemp3 AS
    select DW_ASSET_ID from CORE.FismaReportTemp2;

    FOR r IN 1 TO 3 DO
        set mindate:=DATEADD(day,-d,maxdate);

        delete from CORE.FismaReportTemp3  
        WHERE DW_ASSET_ID not in
        (
         select t.DW_ASSET_ID  from CORE.AssetHist  ah join CORE.FismaReportTemp3 t on ah.DW_ASSET_ID = t.DW_ASSET_ID 
         WHERE ah.last_confirmed_time between :mindate and :maxdate group by t.DW_ASSET_ID 
        );

        SET maxdate:=mindate;

    END FOR;

    UPDATE CORE.FismaReportTemp2 t2
    set Scanned=BITOR(Scanned,IFF(:i=3,4,:i))
    FROM CORE.FismaReportTemp3 t3 WHERE t2.DW_ASSET_ID=t3.DW_ASSET_ID;

END FOR;

res:= (
with a AS(
SELECT DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2 
group by DeviceRole ,DeviceType 
), 
c AS (
SELECT DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,0)=1
group by DeviceRole ,DeviceType 
),
d AS (
SELECT DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,1)=1
group by DeviceRole ,DeviceType 
),
e AS (
SELECT DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,2)=1
group by DeviceRole ,DeviceType 
)
select a.*,IFNULL(c.Total,0) day7, IFNULL(d.Total,0) day14,IFNULL(e.Total,0) day30 from a 
left join c on a.DeviceRole=c.DeviceRole and a.DeviceType=c.DeviceType
left join d on a.DeviceRole=d.DeviceRole and a.DeviceType=d.DeviceType
left join e on a.DeviceRole=e.DeviceRole and a.DeviceType=e.DeviceType
);

DROP TABLE IF EXISTS CORE.FismaReportTemp1;
DROP TABLE IF EXISTS CORE.FismaReportTemp2; 
DROP TABLE IF EXISTS CORE.FismaReportTemp3;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

RETURN TABLE(res);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_FISMAREPORTWITHDC"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='Create quarterly fisma audit report with DC'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_FismaReportWithDC'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number := 0;

d int; 
mindate  date; 
maxdate date; 
today date;
res RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


CREATE OR REPLACE TEMPORARY TABLE CORE.FismaReportTemp2(
    DW_ASSET_ID NUMBER(38,0) NOT NULL,
    DeviceRole VARCHAR(16777216) NULL,
    DeviceType VARCHAR(16777216) NOT NULL,
    DATACENTER_ID VARCHAR(16777216) NOT NULL,
    Scanned int DEFAULT 0
);

CREATE TEMPORARY TABLE CORE.FismaReportTemp1 AS
SELECT * FROM CORE.Asset  
where Is_Applicable = 1
and DATACENTER_ID in (select SYSTEM_ID from CORE.systems where ACRONYM IN (''EDC4'',''CDS VDC GSS'',''HIGLAS'',''NGS VDC'',''Q-Net'',''PESVDC'',''CMS-ESSM''));
--and (LASTMODIFIEDBY_FORESCOUT is not null or UPPER(SOURCE_TOOL_CREATE) = ''FORESCOUT'' or UPPER(SOURCE_TOOL_HWAM)=''FORESCOUT'');

INSERT INTO CORE.FismaReportTemp2(DW_ASSET_ID,DeviceRole,DeviceType,DATACENTER_ID)
with a as (
SELECT a.DW_ASSET_ID, dr.DeviceRole,a.os,a.os_cpe,DATACENTER_ID,
IFF(UPPER(a.DeviceType) in (''DESKTOP'',''SERVER'',''WORKSTATION'') OR (UPPER(dr.DeviceRole)<>''NETWORKING DEVICE'' AND UPPER(a.DeviceType)=''COMPUTER''),''Non-Portable Computers'',
IFF(UPPER(a.DeviceType) in (''LAPTOP''),''Laptops and Netbooks'',
IFF(UPPER(a.DeviceType) in (''HYPERVISOR''),''Addressable Virtual Machines'',
IFF(UPPER(a.DeviceType) in (''IP PHONE''),''Smartphones'',
IFF(UPPER(a.DeviceType) in (''ROUTER OR SWITCH'',''ROUTER'',''SWITCH'',''NETWORKING'',''NETWORK DEVICE'',''LOAD BALANCER'',''NAT'',''FIREWALL'') or (UPPER(dr.DeviceRole)=''NETWORKING DEVICE'' and UPPER(a.DeviceType)=''COMPUTER''),''Networking Devices'',
IFF(UPPER(a.DeviceType) in (''VOIP'',''ROUTER'',''NETWORK ACCESS CONTROL'',''WIRELESS ACCESS POINT'',''NETWORK MANAGEMENT'',''APPLIANCE''),''Other Communication Devices'',
IFF(UPPER(a.DeviceType) in (''PRINTER'',''NETWORK ATTACHED STORAGE''),''Other Input/Output Devices (with their own address)'',
IFF(UPPER(a.DeviceType) in (''STORAGE''),''Other Addressable Devices on the Network'',	
a.DeviceType)))))))) DeviceType
FROM CORE.FismaReportTemp1 a
left outer join CORE.DeviceTypes dr on upper(dr.DEVICETYPE) = upper(a.DEVICETYPE) 
),
b as (
SELECT a.DW_ASSET_ID, a.DeviceRole,DATACENTER_ID,
IFF(a.DeviceType not in (
 ''Addressable Virtual Machines''
,''Laptops and Netbooks''
,''Non-Portable Computers''
,''Smartphones''
,''Other Addressable Devices on the Network''
,''Other Input/Output Devices (with their own address)''
,''Networking Devices''
,''Other Communication Devices''	
),
IFF(UPPER(os_cpe) like ''%WINDOWS%'' or UPPER(os_cpe) like ''%REDHAT%'' or UPPER(os) like ''%WINDOWS%'' or UPPER(os) like ''%WIN%[1-9][1-9]%'' or UPPER(os) like ''%RED%HAT%'' 
or UPPER(os) like ''%UNIX%'' or UPPER(os) like ''%APPLE%OS%''  or UPPER(os) like ''%LINUX%'' or UPPER(os) like ''%UBUNTU%'' or UPPER(os) like ''%FEDORA%''
or UPPER(os) like ''%CENTOS%''  or UPPER(os) like ''%FREEBSD%'',	''Non-Portable Computers'',
IFF(UPPER(os) like ''%JUNOS%'' or UPPER(os) like ''%CISCO%'',''Networking Devices'',
IFF(a.DeviceType in (''Other'',''Not Provided'',''~NoData~''),''Unknown'',
a.DeviceType))),
a.DeviceType) DeviceType
FROM a 
)
select DW_ASSET_ID,
IFF( DeviceType in (''Non-Portable Computers'',''Laptops and Netbooks'',''Addressable Virtual Machines''), ''Endpoint'',
IFF( DeviceType in (''Smartphones''), ''Endpoints (Mobile Assets)'',
IFF( DeviceType in (''Networking Devices'',''Other Communication Devices''), ''Networking Devices'',
IFF( DeviceType in (''Other Input/Output Devices (with their own address)'',''Other Addressable Devices on the Network''), ''Input/Output Devices'',
IFF(DeviceRole in (''Other''),''Unknown'',
DeviceRole))))) DeviceRole
,DeviceType
,DATACENTER_ID
from b;

set today:=(select max(report_date)::DATE  FROM CORE.Report_IDs);

FOR i IN 1 TO 3 DO
    SET d:=IFF(i=1,7,IFF(i=2,14,30));
    SET maxdate:=today;	

    CREATE OR REPLACE TEMPORARY TABLE CORE.FismaReportTemp3 AS
    select DW_ASSET_ID from CORE.FismaReportTemp2;

    FOR r IN 1 TO 3 DO
        set mindate:=DATEADD(day,-d,maxdate);

        delete from CORE.FismaReportTemp3  
        where DW_ASSET_ID not in
        (
         select t.DW_ASSET_ID from CORE.AssetHist  ah join CORE.FismaReportTemp3 t on ah.DW_ASSET_ID = t.DW_ASSET_ID 
         where ah.last_confirmed_time between :mindate and :maxdate group by t.DW_ASSET_ID
        );

        SET maxdate:=mindate;

    END FOR;

    UPDATE CORE.FismaReportTemp2 fa
    SET Scanned=BITOR(Scanned,IFF(:i=3,4,:i))
    FROM CORE.FismaReportTemp3 t WHERE fa.DW_ASSET_ID=t.DW_ASSET_ID;

END FOR;

res:=(
with a AS(
SELECT DATACENTER_ID, DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2 
group by DATACENTER_ID, DeviceRole ,DeviceType 
), 
c AS (
SELECT DATACENTER_ID, DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,0)=1
group by DATACENTER_ID, DeviceRole ,DeviceType 
),
d AS (
SELECT DATACENTER_ID, DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,1)=1
group by DATACENTER_ID, DeviceRole ,DeviceType 
),
e AS (
SELECT DATACENTER_ID, DeviceRole ,DeviceType,count(1) Total FROM CORE.FismaReportTemp2
where GETBIT(Scanned,2)=1
group by DATACENTER_ID, DeviceRole ,DeviceType 
),
f AS (
select a.*,IFNULL(c.Total,0) day7, IFNULL(d.Total,0) day14,IFNULL(e.Total,0) day30 from a 
left join c on a.DATACENTER_ID=c.DATACENTER_ID and a.DeviceRole=c.DeviceRole and a.DeviceType=c.DeviceType
left join d on a.DATACENTER_ID=d.DATACENTER_ID and a.DeviceRole=d.DeviceRole and a.DeviceType=d.DeviceType
left join e on a.DATACENTER_ID=e.DATACENTER_ID and a.DeviceRole=e.DeviceRole and a.DeviceType=e.DeviceType
)
select s.ACRONYM,f.DeviceRole,f.DeviceType,f.Total,f.day7,f.day14,f.day30
from f join CORE.SYSTEMS s on s.SYSTEM_ID=f.DATACENTER_ID order by s.ACRONYM,f.DeviceRole,f.DeviceType
);

DROP TABLE IF EXISTS CORE.FismaReportTemp1;
DROP TABLE IF EXISTS CORE.FismaReportTemp2; 
DROP TABLE IF EXISTS CORE.FismaReportTemp3;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

RETURN TABLE(res);
EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;

END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_FORESCOUT_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull Forescout HWAM, update/insert Master Device Record(MDR)'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_FORESCOUT_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_PULL_FORESCOUT_V3(); -- 240726 CR928
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''FORESCOUT'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240726 CR928
CALL CORE.SP_CRM_PREP_RAW_HWAM_V2(:SNAPSHOT_ID); -- 260726 CR928
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_GENERATE_IPV4S"("P_SEGMENTID" NUMBER(38,0), "P_STARTINGIP" VARCHAR(16777216), "P_ENDINGIP" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Generate list of IPV4s based on Starting/Ending range'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_GENERATE_IPV4S'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
STARTINGIP_OCTET1 NUMBER;
STARTINGIP_OCTET2 NUMBER;
STARTINGIP_OCTET3 NUMBER;
STARTINGIP_OCTET4 NUMBER;
ENDINGIP_OCTET1 NUMBER;
ENDINGIP_OCTET2 NUMBER;
ENDINGIP_OCTET3 NUMBER;
ENDINGIP_OCTET4 NUMBER;
PTR_OCTET1 NUMBER;
PTR_OCTET2 NUMBER;
PTR_OCTET3 NUMBER;
CTR_OCTET1 NUMBER;
CTR_OCTET2 NUMBER;
CTR_OCTET3 NUMBER;
CTR_OCTET4 NUMBER;
NEWIP VARCHAR;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

If (:P_STARTINGIP IS NULL or :P_ENDINGIP IS NULL or :P_STARTINGIP not like ''%.%.%.%'' or :P_ENDINGIP not like ''%.%.%.%'') THEN
	BEGIN
	ExceptionMsg := ''Invalid Start/End IP'';
    raise CRM_logic_exception;
	END;
END IF;

PTR_OCTET1 := CHARINDEX(''.'',:P_STARTINGIP,1);
PTR_OCTET2 := CHARINDEX(''.'',:P_STARTINGIP,:PTR_OCTET1 + 1);
PTR_OCTET3 := CHARINDEX(''.'',:P_STARTINGIP,:PTR_OCTET2 + 1);
Msg := ''PTR_OCTET1='' || PTR_OCTET1 || '',PTR_OCTET2='' || PTR_OCTET2 || '',PTR_OCTET3='' || PTR_OCTET3;
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

STARTINGIP_OCTET1 := SUBSTRING(:P_STARTINGIP,1,PTR_OCTET1 - 1);
STARTINGIP_OCTET2 := SUBSTRING(:P_STARTINGIP,:PTR_OCTET1 + 1,:PTR_OCTET2 - :PTR_OCTET1 - 1);
STARTINGIP_OCTET3 := SUBSTRING(:P_STARTINGIP,:PTR_OCTET2 + 1,:PTR_OCTET3 - :PTR_OCTET2 - 1);
STARTINGIP_OCTET4 := SUBSTRING(:P_STARTINGIP,:PTR_OCTET3 + 1,LEN(:P_STARTINGIP) - :PTR_OCTET3 + 1);

Msg := ''STARTINGIP_OCTET1='' || STARTINGIP_OCTET1 || '',STARTINGIP_OCTET2='' || STARTINGIP_OCTET2 || '',STARTINGIP_OCTET3='' || STARTINGIP_OCTET3 || '',STARTINGIP_OCTET4='' || STARTINGIP_OCTET4;
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);


PTR_OCTET1 := CHARINDEX(''.'',:P_ENDINGIP,1);
PTR_OCTET2 := CHARINDEX(''.'',:P_ENDINGIP,:PTR_OCTET1 + 1);
PTR_OCTET3 := CHARINDEX(''.'',:P_ENDINGIP,:PTR_OCTET2 + 1);

ENDINGIP_OCTET1 := SUBSTRING(:P_ENDINGIP,1,:PTR_OCTET1 - 1);
ENDINGIP_OCTET2 := SUBSTRING(:P_ENDINGIP,:PTR_OCTET1 + 1,:PTR_OCTET2 - :PTR_OCTET1 - 1);
ENDINGIP_OCTET3 := SUBSTRING(:P_ENDINGIP,:PTR_OCTET2 + 1,:PTR_OCTET3 - :PTR_OCTET2 - 1);
ENDINGIP_OCTET4 := SUBSTRING(:P_ENDINGIP,:PTR_OCTET3 + 1,LEN(:P_ENDINGIP) - :PTR_OCTET3 + 1);

Msg := ''ENDINGIP_OCTET1='' || ENDINGIP_OCTET1 || '',ENDINGIP_OCTET2='' || ENDINGIP_OCTET2 || '',ENDINGIP_OCTET3='' || ENDINGIP_OCTET3 || '',ENDINGIP_OCTET4='' || ENDINGIP_OCTET4;
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);


CTR_OCTET1 := STARTINGIP_OCTET1;

WHILE (:CTR_OCTET1 <= :ENDINGIP_OCTET1) DO
	BEGIN
	CTR_OCTET2 := STARTINGIP_OCTET2;

	WHILE (CTR_OCTET2 <= :ENDINGIP_OCTET2) DO
		BEGIN
		CTR_OCTET3 := STARTINGIP_OCTET3;

		WHILE (CTR_OCTET3 <= :ENDINGIP_OCTET3) DO
			BEGIN
			CTR_OCTET4 := STARTINGIP_OCTET4;

			WHILE (CTR_OCTET4 <= :ENDINGIP_OCTET4) DO
				BEGIN
                NEWIP := CTR_OCTET1::varchar || ''.'' || CTR_OCTET2::varchar || ''.'' || CTR_OCTET3::varchar || ''.'' || CTR_OCTET4::varchar;

INSERT INTO CORE.TEMP_IPV4 (ENDRANGE,INSERT_DATE,IPV4,OCTET1,OCTET2,OCTET3,OCTET4,PATH,SEGMENTID,SEGMENTNAME,STARTRANGE)
VALUES(:P_ENDINGIP,CURRENT_TIMESTAMP(),:NEWIP,:CTR_OCTET1,:CTR_OCTET2,:CTR_OCTET3,:CTR_OCTET4,NULL,:P_SEGMENTID,NULL,:P_STARTINGIP);

				CTR_OCTET4 := CTR_OCTET4 + 1;
                END;
				END WHILE; -- 4

			CTR_OCTET3 := CTR_OCTET3 + 1;
            END;
			END WHILE; -- 3

		CTR_OCTET2 := CTR_OCTET2 + 1;
        END;
		END WHILE; -- 2

    CTR_OCTET1 := CTR_OCTET1 + 1;
    END;
	END WHILE; -- 1


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_GENERATE_REPORT_ID"()
RETURNS NUMBER(38,0)
LANGUAGE SQL
COMMENT='Generate next sequential REPORT_ID'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_GENERATE_REPORT_ID'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
NEW_REPORT_ID NUMBER;

BEGIN

-- 240416 CR873 The IS_VIABLE flag is initially created as FALSE. When morning processes complete successfully it sets IS_VIABLE = TRUE

BEGIN TRANSACTION;
insert into CORE.REPORT_IDS (IS_ENDOFMONTH,REPORT_DATE,IS_VIABLE) VALUES(0,CURRENT_TIMESTAMP(),0); -- 240416 CR873
COMMIT;

SELECT MAX(REPORT_ID) INTO :NEW_REPORT_ID FROM CORE.REPORT_IDS;

Msg := ''Created REPORT_ID:'' || :NEW_REPORT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

RETURN :NEW_REPORT_ID;

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_GENERATE_SNAPSHOT_ID"("P_DATACATEGORY" VARCHAR(16777216))
RETURNS NUMBER(38,0)
LANGUAGE SQL
COMMENT='Generate next sequential SNAPSHOT_ID for DataCategory'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_GENERATE_SNAPSHOT_ID'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
NEW_SNAPSHOT_ID NUMBER;
REPORT_ID NUMBER;
PARENT_DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;

BEGIN

SELECT MAX(REPORT_ID) INTO :REPORT_ID FROM CORE.REPORT_IDS;

SELECT CASE UPPER(:P_DATACATEGORY)
    WHEN ''AWS HWAM'' THEN ''HWAM''
    WHEN ''AWS VUL'' THEN ''VUL''
    WHEN ''AWS VUL MITIGATED'' THEN ''VUL''
    WHEN ''AWS'' THEN ''HWAM''
    WHEN ''AXONIUS'' THEN ''HWAM''
    WHEN ''CCIC VUL'' THEN ''VUL''
    WHEN ''CCIC VUL MITIGATED'' THEN ''VUL''
    WHEN ''CROWDSTRIKE'' THEN ''HWAM'' -- 240820 CR958
    WHEN ''FORESCOUT'' THEN ''HWAM'' -- 240226
    WHEN ''MAG VUL'' THEN ''VUL'' -- 241015 CR-TBD
    WHEN ''MAG VUL MITIGATED'' THEN ''VUL'' -- 241015 CR-TBD
    WHEN ''VUL'' THEN ''VUL''
    ELSE ''UNKNOWN''
END INTO :PARENT_DATACATEGORY;

If (coalesce(NULLIF(:PARENT_DATACATEGORY,''''),''UNKNOWN'') = ''UNKNOWN'') THEN
    BEGIN
    ExceptionMsg := ''P_DATACATEGORY is invalid('' || coalesce(NULLIF(:P_DATACATEGORY,''''),''NULL'') || '')'';
    raise CRM_logic_exception;
    END;
END IF;

-- 240115
SELECT CASE UPPER(:P_DATACATEGORY)
    WHEN ''AWS HWAM'' THEN TRUE
    WHEN ''AWS VUL'' THEN TRUE
    WHEN ''AWS VUL MITIGATED'' THEN TRUE
    WHEN ''AWS'' THEN TRUE
    ELSE FALSE
END INTO :IS_FROM_AWS_FEED;

BEGIN TRANSACTION;
insert into CORE.SNAPSHOT_IDS (COMMENTS,DATACATEGORY,IS_FROM_AWS_FEED,MAX_DATE,MIN_DATE,PARENT_DATACATEGORY,RECORD_COUNT,REPORT_ID,SNAPSHOT_DATE)
VALUES(NULL,:P_DATACATEGORY,:IS_FROM_AWS_FEED,NULL,NULL,:PARENT_DATACATEGORY,NULL,:REPORT_ID,CURRENT_TIMESTAMP());
COMMIT;

SELECT MAX(SNAPSHOT_ID) INTO :NEW_SNAPSHOT_ID FROM CORE.SNAPSHOT_IDS WHERE DATACATEGORY = :P_DATACATEGORY;

Msg := ''Created SnapshotID:'' || :NEW_SNAPSHOT_ID || '', ('' || :P_DATACATEGORY || '')'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

RETURN :NEW_SNAPSHOT_ID;

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_HEALTH_CHECKER"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Check CYBER_RISK_MANAGEMENT DB for various inconsistencies'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_HEALTH_CHECKER'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
--CURRENT_REPORT_ID NUMBER := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS);
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--select count(1) into :RECORD_COUNT
--   FROM (select AXONIUS_INTERNAL_AXONIUS_ID 
--    from asset where AXONIUS_INTERNAL_AXONIUS_ID is not null
--    group by AXONIUS_INTERNAL_AXONIUS_ID having count(1) > 1);
--
--Msg := ''Duplicate AXONIUS_INTERNAL_AXONIUS_ID='' || :RECORD_COUNT;
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

--
-- Check for AssetInterface records with no associated Asset record.  THIS SHOULD NOT BE
--
select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_FQDN ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_FQDN without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_HOSTNAME ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_HOSTNAME without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_IPV4 ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_IPV4 without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_IPV6 ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_IPV6 without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_MACADDRESS ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_MACADDRESS without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.ASSETINTERFACE_NETBIOSNAME ai
left outer join CORE.ASSET a on a.dw_asset_id = ai.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''ASSETINTERFACE_NETBIOSNAME without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT
from CORE.VULMASTER vm
left outer join CORE.ASSET a on a.dw_asset_id = vm.dw_asset_id
where a.dw_asset_id is null;

If (:RECORD_COUNT > 0) THEN -- 231130
    BEGIN
    Msg := ''VULMASTER without ASSET='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT from INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA = ''CORE'' AND COMMENT IS NULL; -- 231213
If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''CORE.Functions needing comment='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT from INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA = ''CORE'' AND COMMENT IS NULL; -- 231213
If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''CORE.Procedures needing comment='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

-- 240110 The TABLES view seems to also contain VIEWS
select count(1) into :RECORD_COUNT from INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = ''CORE'' AND COMMENT IS NULL; -- 231213
If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''CORE.Tables needing comment='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

--240113
select count(1) into :RECORD_COUNT
    from CORE.VW_ASSETS a
    left outer join CORE.SYSTEMS s on s.system_id = a.system_id
    where s.system_id is null;

If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''WARNING: Asset table has invalid SYSTEM_ID='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

--240113
select count(1) into :RECORD_COUNT
    from CORE.VW_ASSETS a
    left outer join CORE.SYSTEMS dc on dc.system_id = a.datacenter_id
    where dc.system_id is null;

If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''WARNING: Asset table has invalid DATACENTER_ID='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

select count(1) into :RECORD_COUNT from CORE.VULPLUGINS_MASTER where mitigationstatus <> ''fixed'';

If (:RECORD_COUNT > 0) THEN 
    BEGIN
    Msg := ''VULPLUGINS_MASTER still open='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

-- 240611
SELECT COUNT(1) into :RECORD_COUNT FROM (select DW_ASSET_ID,NORMALIZED_FQDN from ASSETINTERFACE_FQDN group by DW_ASSET_ID,NORMALIZED_FQDN having count(1) > 1);

-- If (:RECORD_COUNT > 0) THEN 
--     BEGIN
    Msg := ''ASSETINTERFACE_FQDN duplicates='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--     END;
-- End if;

-- 240611
SELECT COUNT(1) into :RECORD_COUNT FROM (select DW_ASSET_ID,NORMALIZED_NETBIOSNAME from ASSETINTERFACE_NETBIOSNAME group by DW_ASSET_ID,NORMALIZED_NETBIOSNAME having count(1) > 1);

-- If (:RECORD_COUNT > 0) THEN 
--     BEGIN
    Msg := ''ASSETINTERFACE_NETBIOSNAME duplicates='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--     END;
-- End if;

-- 240611
SELECT COUNT(1) into :RECORD_COUNT FROM (select DW_ASSET_ID,NORMALIZED_HOSTNAME from ASSETINTERFACE_HOSTNAME group by DW_ASSET_ID,NORMALIZED_HOSTNAME having count(1) > 1);

-- If (:RECORD_COUNT > 0) THEN 
--     BEGIN
    Msg := ''ASSETINTERFACE_HOSTNAME duplicates='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--     END;
-- End if;


-- 240110 select count(1) into :RECORD_COUNT from INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA = ''CORE'' AND COMMENT IS NULL; -- 231213
-- 240110 If (:RECORD_COUNT > 0) THEN 
-- 240110     BEGIN
-- 240110     Msg := ''CORE.Views needing comment='' || :RECORD_COUNT;
-- 240110     CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
-- 240110     END;
-- 240110 End if;

--231222
-- 240113 select count(1) into :RECORD_COUNT from (select distinct instanceid from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS where s3_file_create::date = current_date()); -- 240102 added current_date()
-- 240113 If (:RECORD_COUNT > 0) THEN 
-- 240113     BEGIN
-- 240113     Msg := ''SEC_VW_IUSG_CUMULATIVE_VULNS Assets='' || :RECORD_COUNT;
-- 240113     CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
-- 240113     END;
-- 240113 End if;

--231222
-- 240113 select count(1) into :RECORD_COUNT from (select distinct instanceid from APP_TENABLE.SHARED.SEC_VW_VULN_AWS where report_date::date = current_date()); -- 240102 added current_date()
-- 240113 If (:RECORD_COUNT > 0) THEN 
-- 240113     BEGIN
-- 240113     Msg := ''SEC_VW_VULN_AWS Assets='' || :RECORD_COUNT;
-- 240113     CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
-- 240113     END;
-- 240113 End if;



CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IDENTIFY_RAW_ASSETS"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Identify distinct assets and assign temporary DW_ASSET_ID to RAW_HWAM or RAW_TENABLE_VUL'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_IDENTIFY_RAW_ASSETS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
HWAM varchar := ''HWAM'';
RECORD_COUNT NUMBER;
DATACATEGORY varchar;
PARENT_DATACATEGORY varchar;

BEGIN
select DATACATEGORY,PARENT_DATACATEGORY into :DATACATEGORY,:PARENT_DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    --
    -- 240813 1957 CR-EBF
    -- 
    UPDATE CORE.RAW_HWAM upd
    set TEMP_ASSET_KEY = DATACENTER_ID || '';'' || ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- 240828 Remove IPV4,IPV6
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEMP_ASSET_KEY =
    (coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(FQDN,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(HOSTNAME,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(NETBIOSNAME,'',''),''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY not based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEMP_ASSET_KEY =
    (coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(FQDN,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(HOSTNAME,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(NETBIOSNAME,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV4,'',''),''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV6,'',''),''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY not based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
   END;
Else
    BEGIN -- TENABLE
    BEGIN TRANSACTION;
    --
    -- 240813 1957 CR-EBF
    -- 
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEMP_ASSET_KEY = DATACENTER_ID || '';'' || ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- 240830 Remove IP
    -- 240823 Remove MACADDRESS,TENABLEUUID
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEMP_ASSET_KEY =
    (coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';'' || coalesce(NULLIF(DNSNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(HOSTNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(NETBIOSNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY not based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;

   BEGIN TRANSACTION;
    --
    -- 240823 Remove MACADDRESS,TENABLEUUID
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEMP_ASSET_KEY =
    (coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';'' || coalesce(NULLIF(DNSNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(HOSTNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(IP,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(NETBIOSNAME,''''),''ITSNULL'')
    || '';'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_ASSET_KEY IS NULL and NULLIF(ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_KEY not based on ASSET_ID_TATTOO='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    END;
END IF;


IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_HWAM upd
    set TEMP_DW_ASSET_ID = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEMP_ASSET_KEY,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEMP_ASSET_KEY
            FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_DW_ASSET_ID IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEMP_ASSET_KEY = seq.TEMP_ASSET_KEY and upd.TEMP_DW_ASSET_ID IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
Else
    BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEMP_DW_ASSET_ID = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEMP_ASSET_KEY,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEMP_ASSET_KEY
            FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_DW_ASSET_ID IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEMP_ASSET_KEY = seq.TEMP_ASSET_KEY and upd.TEMP_DW_ASSET_ID IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
END IF;

Msg := ''TEMP_DW_ASSET_ID assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_DW_ASSET_ID IS NULL;
    END;
Else
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEMP_DW_ASSET_ID IS NULL;
    END;
END IF;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''WARNING: TEMP_DW_ASSET_ID Unassigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
Else
    BEGIN
    Msg := ''All records have been assigned a TEMP_DW_ASSET_ID'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IDENTIFY_RAW_ASSETS_TEST"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Identify distinct assets and assign temporary DW_ASSET_ID to RAW_HWAM or RAW_TENABLE_VUL'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_IDENTIFY_RAW_ASSETS_TEST'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
HWAM varchar := ''HWAM'';
IS_FROM_AWS_FEED BOOLEAN; -- 240917 CR-EBF
RECORD_COUNT NUMBER;
DATACATEGORY varchar;
PARENT_DATACATEGORY varchar;

BEGIN
--
-- 240917 CR-EBF added IS_FROM_AWS_FEED
--
select DATACATEGORY,PARENT_DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:PARENT_DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    --
    -- 240813 1957 CR-EBF
    -- 
    UPDATE CORE.RAW_HWAM upd
     set TEST_VARCHAR = ''DATACENTER_ID:'' || DATACENTER_ID || '';NORMALIZED_ASSET_ID_TATTOO:'' || NORMALIZED_ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR based on NORMALIZED_ASSET_ID_TATTOO='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- 240828 Remove IPV4,IPV6
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEST_VARCHAR =
    (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
    || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
    || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(A)='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
    
    BEGIN TRANSACTION;
    --
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEST_VARCHAR =
    (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
    || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
    || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
    || '';IPV4:'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV4,'',''),''''),''ITSNULL'')
    || '';IPV6:'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV6,'',''),''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(B)='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
   END;
Else
    BEGIN -- TENABLE
    If (:IS_FROM_AWS_FEED = 0) THEN
        BEGIN
        BEGIN TRANSACTION;
        --
        -- 240830 Remove IP
        -- 240823 Remove MACADDRESS,TENABLEUUID
        --
        UPDATE CORE.RAW_TENABLE_VUL upd
        set TEST_VARCHAR =
        (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
        || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
        || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
        || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
        || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
        || '';REPOSITORY_ID:'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
        )
        WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

        RECORD_COUNT := SQLROWCOUNT;

        IF (:RECORD_COUNT > 0) THEN
            BEGIN
            Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(A)='' || :RECORD_COUNT;
            CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
            END;
        End If;
        COMMIT;

        BEGIN TRANSACTION;
        --
        -- 240823 Remove MACADDRESS,TENABLEUUID
        --
        UPDATE CORE.RAW_TENABLE_VUL upd
        set TEST_VARCHAR =
        (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
        || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
        || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
        || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
        || '';IP:'' || coalesce(NULLIF(IP,''''),''ITSNULL'')
        || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
        || '';REPOSITORY_ID:'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
        )
        WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

        RECORD_COUNT := SQLROWCOUNT;

        IF (:RECORD_COUNT > 0) THEN
            BEGIN
            Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(B)='' || :RECORD_COUNT;
            CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
            END;
        End If;
        COMMIT;
        END;
    End If; -- IS_FROM_AWS_FEED
 
    BEGIN TRANSACTION;
    --
    -- 240917 CR-EBF enhance by testing for AWS
    -- 240813 1957 CR-EBF added code for DATACENTER_ID/NORMALIZED_ASSET_ID_TATTOO assignment
     -- 
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEST_VARCHAR = ''DATACENTER_ID:'' || DATACENTER_ID || '';NORMALIZED_ASSET_ID_TATTOO:'' || NORMALIZED_ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR based on NORMALIZED_ASSET_ID_TATTOO='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
    END; -- TENABLE
END IF;


------------------------------------------------------------------------
--
-- ASSIGN TEST_NUMBER BASED ON TEST_VARCHAR
--
------------------------------------------------------------------------

IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_HWAM upd
    set TEST_NUMBER = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEST_VARCHAR,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEST_VARCHAR
            FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEST_VARCHAR = seq.TEST_VARCHAR and upd.TEST_NUMBER IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
Else
    BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEST_NUMBER = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEST_VARCHAR,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEST_VARCHAR
            FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEST_VARCHAR = seq.TEST_VARCHAR and upd.TEST_NUMBER IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
END IF;

Msg := ''TEST_NUMBER assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL;
    END;
Else
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL;
    END;
END IF;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''WARNING: TEST_NUMBER Unassigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
Else
    BEGIN
    Msg := ''All records have been assigned a TEST_NUMBER'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IDENTIFY_RAW_ASSETS_TEST_V1"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Identify distinct assets and assign temporary DW_ASSET_ID to RAW_HWAM or RAW_TENABLE_VUL'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_IDENTIFY_RAW_ASSETS_TEST'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
HWAM varchar := ''HWAM'';
IS_FROM_AWS_FEED BOOLEAN; -- 240917 CR-EBF
RECORD_COUNT NUMBER;
DATACATEGORY varchar;
PARENT_DATACATEGORY varchar;

BEGIN
--
-- 240917 CR-EBF added IS_FROM_AWS_FEED
--
select DATACATEGORY,PARENT_DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:PARENT_DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    --
    -- 240813 1957 CR-EBF
    -- 
    UPDATE CORE.RAW_HWAM upd
     set TEST_VARCHAR = ''DATACENTER_ID:'' || DATACENTER_ID || '';NORMALIZED_ASSET_ID_TATTOO:'' || NORMALIZED_ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR based on NORMALIZED_ASSET_ID_TATTOO='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- 240828 Remove IPV4,IPV6
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEST_VARCHAR =
    (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
    || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
    || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(A)='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
    
    BEGIN TRANSACTION;
    --
    -- 240823 Remove MACADDRESS,MOTHERBOARD,TENANT_ID
    --
    UPDATE CORE.RAW_HWAM upd
    set TEST_VARCHAR =
    (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
    || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
    || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
    || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
    || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
    || '';IPV4:'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV4,'',''),''''),''ITSNULL'')
    || '';IPV6:'' || coalesce(NULLIF(ARRAY_TO_STRING(IPV6,'',''),''''),''ITSNULL'')
    )
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(B)='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
   END;
Else
    BEGIN -- TENABLE
    If (:IS_FROM_AWS_FEED = 0) THEN
        BEGIN
        BEGIN TRANSACTION;
        --
        -- 240830 Remove IP
        -- 240823 Remove MACADDRESS,TENABLEUUID
        --
        UPDATE CORE.RAW_TENABLE_VUL upd
        set TEST_VARCHAR =
        (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
        || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
        || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
        || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
        || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
        || '';REPOSITORY_ID:'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
        )
        WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

        RECORD_COUNT := SQLROWCOUNT;

        IF (:RECORD_COUNT > 0) THEN
            BEGIN
            Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(A)='' || :RECORD_COUNT;
            CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
            END;
        End If;
        COMMIT;

        BEGIN TRANSACTION;
        --
        -- 240823 Remove MACADDRESS,TENABLEUUID
        --
        UPDATE CORE.RAW_TENABLE_VUL upd
        set TEST_VARCHAR =
        (''DATACENTER_ID:'' || coalesce(NULLIF(DATACENTER_ID,''''),''ITSNULL'')
        || '';SYSTEM_ID:'' || coalesce(NULLIF(SYSTEM_ID,''''),''ITSNULL'') -- Not available when data first written to table so probably not needed
        || '';NORMALIZED_FQDN:'' || coalesce(NULLIF(NORMALIZED_FQDN,''''),''ITSNULL'')
        || '';NORMALIZED_HOSTNAME:'' || coalesce(NULLIF(ARRAY_TO_STRING(NORMALIZED_HOSTNAME,'',''),''''),''ITSNULL'')
        || '';IP:'' || coalesce(NULLIF(IP,''''),''ITSNULL'')
        || '';NORMALIZED_NETBIOSNAME:'' || coalesce(NULLIF(NORMALIZED_NETBIOSNAME,''''),''ITSNULL'')
        || '';REPOSITORY_ID:'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
        )
        WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NULL; -- 240813 1957 CR-EBF

        RECORD_COUNT := SQLROWCOUNT;

        IF (:RECORD_COUNT > 0) THEN
            BEGIN
            Msg := ''TEST_VARCHAR not based on NORMALIZED_ASSET_ID_TATTOO(B)='' || :RECORD_COUNT;
            CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
            END;
        End If;
        COMMIT;
        END;
    End If; -- IS_FROM_AWS_FEED
 
    BEGIN TRANSACTION;
    --
    -- 240917 CR-EBF enhance by testing for AWS
    -- 240813 1957 CR-EBF added code for DATACENTER_ID/NORMALIZED_ASSET_ID_TATTOO assignment
     -- 
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEST_VARCHAR = ''DATACENTER_ID:'' || DATACENTER_ID || '';NORMALIZED_ASSET_ID_TATTOO:'' || NORMALIZED_ASSET_ID_TATTOO
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL and NULLIF(DATACENTER_ID,'''') IS NOT NULL and NULLIF(NORMALIZED_ASSET_ID_TATTOO,'''') IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;

    IF (:RECORD_COUNT > 0) THEN
        BEGIN
        Msg := ''TEST_VARCHAR based on NORMALIZED_ASSET_ID_TATTOO='' || :RECORD_COUNT;
        CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
        END;
    End If;
    COMMIT;
    END; -- TENABLE
END IF;


------------------------------------------------------------------------
--
-- ASSIGN TEST_NUMBER BASED ON TEST_VARCHAR
--
------------------------------------------------------------------------

IF (:PARENT_DATACATEGORY = :HWAM) THEN
	BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_HWAM upd
    set TEST_NUMBER = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEST_VARCHAR,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEST_VARCHAR
            FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEST_VARCHAR = seq.TEST_VARCHAR and upd.TEST_NUMBER IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
Else
    BEGIN
    BEGIN TRANSACTION;
    UPDATE CORE.RAW_TENABLE_VUL upd
    set TEST_NUMBER = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEST_VARCHAR,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEST_VARCHAR
            FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEST_VARCHAR = seq.TEST_VARCHAR and upd.TEST_NUMBER IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
END IF;

Msg := ''TEST_NUMBER assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:PARENT_DATACATEGORY = :HWAM) THEN
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL;
    END;
Else
    BEGIN
    select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL;
    END;
END IF;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''WARNING: TEST_NUMBER Unassigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
Else
    BEGIN
    Msg := ''All records have been assigned a TEST_NUMBER'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IDENTIFY_RAW_ASSETS_TEST_V2"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Identify distinct assets and assign temporary DW_ASSET_ID to RAW_HWAM or RAW_TENABLE_VUL'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_IDENTIFY_RAW_ASSETS_TEST_V2'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
HWAM varchar := ''HWAM'';
IS_FROM_AWS_FEED BOOLEAN; -- 240917 CR-EBF
RECORD_COUNT NUMBER;
DATACATEGORY varchar;
PARENT_DATACATEGORY varchar;

BEGIN
--
-- 240917 CR-EBF added IS_FROM_AWS_FEED
--
select DATACATEGORY,PARENT_DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:PARENT_DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

IF (:DATACATEGORY NOT in (''CCIC VUL'',''CCIC VUL MITIGATED'')) THEN
    BEGIN
    Msg := ''Only testing CCIC VUL and CCIC VUL MITIGATED'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    return :Msg;
    END;
END IF;

BEGIN TRANSACTION;
UPDATE CORE.RAW_TENABLE_VUL
set TEST_VARCHAR = NULL
,TEST_NUMBER = NULL
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;
COMMIT;


UPDATE CORE.RAW_TENABLE_VUL
set TEST_VARCHAR =
        (''REPOSITORY_ID:'' || coalesce(NULLIF(REPOSITORY_ID,''''),''ITSNULL'')
        || '';REPOSITORY_DESCRIPTION:'' || coalesce(NULLIF(REPOSITORY_DESCRIPTION,''''),''ITSNULL'')
        || '';IP:'' || coalesce(NULLIF(IP,''''),''ITSNULL'')
        || '';DNSNAME:'' || coalesce(NULLIF(DNSNAME,''''),''ITSNULL'')
        )
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_VARCHAR IS NULL;
        

 ------------------------------------------------------------------------
--
-- ASSIGN TEST_NUMBER BASED ON TEST_VARCHAR
--
------------------------------------------------------------------------

BEGIN TRANSACTION;
UPDATE CORE.RAW_TENABLE_VUL upd
set TEST_NUMBER = seq.SEQ_TEMP_DW_ASSET_ID
    FROM (select d.TEST_VARCHAR,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
        FROM (select DISTINCT TEST_VARCHAR
            FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL) d) seq  
    WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEST_VARCHAR = seq.TEST_VARCHAR and upd.TEST_NUMBER IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''TEST_NUMBER assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and TEST_NUMBER IS NULL;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''WARNING: TEST_NUMBER Unassigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
Else
    BEGIN
    Msg := ''All records have been assigned a TEST_NUMBER'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_INITIATE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Initialize CRM database by generating a REPORT_ID (snapshot identifier) and pull fundamental data like CFACTS'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_INITIATE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_GENERATE_REPORT_ID();
REPORT_ID := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS); -- 240418 1326 CR873 New REPORT_ID is set IS_VIABLE = FALSE by default

CALL CORE.SP_CRM_PULL_CFACTS(:REPORT_ID);
CALL CORE.SP_CRM_UPDATE_PRIMARY_OP_LOC();
CALL CORE.SP_CRM_PULL_SYSTEMSAWSACCOUNTS();

If (hour(current_timestamp()) between 2 and 6) then -- 231108 WORKAROUND TO PREVENT PRE-MATURE DELETIONS OF ASSETS WHEN PROCESS IS RE-RUN IN THE SAME DAY
    BEGIN
    BEGIN TRANSACTION; -- 230703 PREV_LAST_CONFIRMED_TIME is used in SP_CRM_ASSETAGING

    UPDATE CORE.ASSET 
    set PREV_LAST_CONFIRMED_TIME = LAST_CONFIRMED_TIME
    ,PREV_SYSTEM_ID = SYSTEM_ID; -- 240926 CR-TBD Needed for diagnostics

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''ASSET.PREV_LAST_CONFIRMED_TIME set='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

    COMMIT;
    END;
Else
	BEGIN
	Msg := ''Outside normal run-time, ASSET.PREV_LAST_CONFIRMED_TIME not updated'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
	END;
END IF;


TRUNCATE TABLE CORE.TEMP_ASSETS_TO_DELETE; -- 240816
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''TRUNCATE TABLE CORE.TEMP_ASSETS_TO_DELETE'');

--
-- TEMP_HWAM is used by SP_CRM_LOAD_ASSET_V2 for asset matching
--
TRUNCATE TABLE CORE.TEMP_HWAM;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''TRUNCATE TABLE CORE.TEMP_HWAM'');

TRUNCATE TABLE CORE.TEMP_ASSET_METADATA; -- 240708 CR928
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''TRUNCATE TABLE CORE.TEMP_ASSET_METADATA''); -- 240708 CR928

TRUNCATE TABLE CORE.TEMP_ASSET_SOFTWARE; -- 240806
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''TRUNCATE TABLE CORE.TEMP_ASSET_SOFTWARE''); -- 240806

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IUSG_TENABLE_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS (IUSG) Tenable Vulnerability data, update/insert Master Device Record(MDR), update/insert Vulnerability Master'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_IUSG_TENABLE_VUL'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_PULL_IUSG_VUL();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''AWS VUL'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240727 CR928
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID); -- 250129 CR1077
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241025 CR1012
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928
CALL CORE.SP_CRM_LOAD_VULPLUGINS_MASTER(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LOAD_VULPLUGIN(:SNAPSHOT_ID); -- 230419 TEMPORARY UNTIL WE CAN DECOMMISSION CORE.VULPLUGIN

CALL CORE.SP_CRM_PULL_IUSG_VUL_MITIGATED();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''AWS VUL MITIGATED'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID); -- 240727 CR928
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID); -- 250129 CR1077
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241025 CR1012
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID); -- 240705 CR928
CALL CORE.SP_CRM_UPDATE_VULPLUGINS_MASTER(:SNAPSHOT_ID);

-- 241106 CR1023
CALL CORE.SP_CRM_PULL_MAG_VUL();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''MAG VUL'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID);
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS_TEST(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241023 CR1012 V3
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LOAD_VULPLUGINS_MASTER(:SNAPSHOT_ID);

-- 241106 CR1023
CALL CORE.SP_CRM_PULL_MAG_VUL_MITIGATED();
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(''MAG VUL MITIGATED'');
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS(:SNAPSHOT_ID);
CALL CORE.SP_CRM_IDENTIFY_RAW_ASSETS_TEST(:SNAPSHOT_ID);
CALL CORE.SP_CRM_LINK_METADATA_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL_V3(:SNAPSHOT_ID); -- 241023 CR1012 V3
CALL CORE.SP_CRM_LOAD_ASSET_V2(:SNAPSHOT_ID);
CALL CORE.SP_CRM_UPDATE_VULPLUGINS_MASTER(:SNAPSHOT_ID);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_KEV_CATALOG"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull KEV (BOD) catalog'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_KEV_CATALOG'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_PULL_KEV_CATALOG();
CALL CORE.SP_CRM_UPDATE_KEV_CATALOG(); -- Added 231103; Updates catalog with currenly available VULMASTER; It is run again after VULMASTER is updated; THIS MIGHT NOT BE NEEDED

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LINK_METADATA_V2"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Link metadata to each related vulnerability record within snapshot'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_LINK_METADATA_V2'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
PARENT_DATACATEGORY varchar;
DATACATEGORY varchar;
HWAM varchar := ''HWAM'';
VUL varchar := ''VUL'';
AWS_HWAM varchar := ''AWS HWAM'';
AWS_VUL varchar := ''AWS VUL'';
CCIC_VUL varchar := ''CCIC VUL'';
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED'';
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED'';
MAG_VUL varchar := ''MAG VUL''; -- 241021 CR1012
MAG_VUL_MITIGATED varchar := ''MAG VUL MITIGATED''; -- 241021 CR1012
FORESCOUT varchar := ''FORESCOUT'';
RECORD_COUNT number;
IS_VERBOSE_MODE boolean := 1;
STEP_MSG varchar;
METADATA_PREFIX varchar := ''Metadata msg:'';

BEGIN
/***********************************************************************************************************************************

NOTE: VW_HWAM_AWS_V2, VW_IUSG_CUMULATIVE_VULNS, VW_IUSG_MITIGATED_VULNS handles ASSET_ID_TATTOO,AWS_ACCOUNTID
NOTE: SP_CRM_PULL_FORESCOUT_V3 handles SYSTEM_ID,ASSET_ID_TATTOO,IS_FORESCOUT_MANAGED

CCIC (On-prem) Tenable Vulnerability data does not contain ASSET_ID_TATTOO or PRIMARY_FISMA_ID_TATTOO values.
In order to provide these two tag values there are two Plugin_IDs (i.e. Scripts) that read the tag data from the asset.
These plugin results are part of the vulnerability data stream but are not in-themseleves vulnerabilities.
The plugin results are stored in the Tenable field PLUGINTEXT and are parsed to obtain ASSET_ID_TATTOO and SYSTEM_ID,
Note: Plugins 1218405 and 1221295 were written in-house.

PluginID    PluginName                                                      Operating System
1218405     Check for Empty FISMA Tattoo files.                             Linux
1221295     Print out FISMA registry keys.                                  Windows
1032381     Check for Empty FISMA Tattoo files.	THIS PLUGIN APPEARS TO BE EXPERIMENTAL - DO NOT USE IT
90191       Amazon Web Services EC2 Instance Metadata Enumeration (Unix)	Unix
90427       Amazon Web Services EC2 Instance Metadata Enumeration (Windows)	Windows
99172       Microsoft Azure Instance Metadata Enumeration (Windows) -- 241021 Elliot suggested this as a possibility
99171       Microsoft Azure Instance Metadata Enumeration (Unix) -- 241021 Elliot suggested this as a possibility
19506       Nessus Scan Information	
20811       Microsoft Windows Installed Software Enumeration (credentialed check)

The purpose of this stored procedure is to enhance the actual vulnerability record with the tag values for proper identification
of the asset.

Although the plugins are supposed to return the ASSET_ID_TATTOO or PRIMARY_FISMA_ID_TATTOO values this is not always the case.
One factor for this failure is that a credentialed scan was not done.

TATTOO PLUGINS ALWAYS HAVE THE FOLLOWING (SOMETIMES MACADDRESS IS NULL)
DATACENTER_ID	DNSNAME	IP	MACADDRESS	NETBIOSNAME	TENABLEUUID

************************************************************************************************************************************/

select DATACATEGORY,PARENT_DATACATEGORY into :DATACATEGORY,:PARENT_DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--TRUNCATE TABLE TEMP_ASSET_METADATA;
--Msg := ''TRUNCATED TEMP_ASSET_METADATA'';
--If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;

BEGIN TRANSACTION;
--
-- Write distinct SNAPSHOT_ID/TEMP_DW_ASSET_ID to TEMP_ASSET_METADATA as an initialization step
--
IF (:PARENT_DATACATEGORY = :HWAM) THEN
    BEGIN
    INSERT INTO TEMP_ASSET_METADATA 
        (AWS_ACCOUNTID,DATACENTER_ID,DATA_ERROR_ARRAY,DATA_WARNING_ARRAY,IS_FORESCOUT_MANAGED,IS_TENABLE_CREDENTIALED_SCAN,SNAPSHOT_ID,SYSTEM_ID,TEMP_DW_ASSET_ID)
    SELECT DISTINCT NULL,DATACENTER_ID ,ARRAY_CONSTRUCT(),ARRAY_CONSTRUCT(),NULL,NULL,SNAPSHOT_ID,NULL,TEMP_DW_ASSET_ID -- 250129 CR1078
    FROM RAW_HWAM
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;
    END;
ELSE
    BEGIN
    INSERT INTO TEMP_ASSET_METADATA
        (AWS_ACCOUNTID,DATACENTER_ID,DATA_ERROR_ARRAY,DATA_WARNING_ARRAY,IS_FORESCOUT_MANAGED,IS_TENABLE_CREDENTIALED_SCAN,SNAPSHOT_ID,SYSTEM_ID,TEMP_DW_ASSET_ID)
    SELECT DISTINCT NULL,DATACENTER_ID ,ARRAY_CONSTRUCT(),ARRAY_CONSTRUCT(),NULL,NULL,SNAPSHOT_ID,NULL,TEMP_DW_ASSET_ID -- 250129 CR1078
    FROM RAW_TENABLE_VUL
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;
    END;
END IF;
COMMIT;

Msg := ''Finished initialize of TEMP_ASSET_METADATA'';
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;

IF (:PARENT_DATACATEGORY = :VUL) THEN
    BEGIN
    Msg := ''PARENT_DATACATEGORY='' || :PARENT_DATACATEGORY;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    --
    -- Capture Nessus Scan Information. Pertains to AWS and CCIC vulnerability data.
    --
    BEGIN TRANSACTION;
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_NESSUS_SCAN_INFO = met.PLUGINTEXT
    FROM (select DISTINCT TEMP_DW_ASSET_ID,PLUGINTEXT
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID IN (''19506'')) met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_NESSUS_SCAN_INFO'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    UPDATE TEMP_ASSET_METADATA
    set IS_TENABLE_CREDENTIALED_SCAN = CORE.FN_CRM_PARSE_TENABLE_CREDENTIALED_SCAN_V2(PLUGINTEXT_NESSUS_SCAN_INFO)
    ,NESSUS_VERSION = CORE.FN_CRM_PARSE_TENABLE_NESSUS_VERSION(PLUGINTEXT_NESSUS_SCAN_INFO)
    ,SCAN_START_DATE = REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(CORE.FN_CRM_PARSE_TENABLE_SCAN_START_DATE(PLUGINTEXT_NESSUS_SCAN_INFO)) 
    where SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_NESSUS_SCAN_INFO IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_NESSUS_SCAN_INFO parms('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Capture plugin: Amazon Web Services EC2 Instance Metadata Enumeration (Unix).
    -- Note: These EC2 plugins can be found in CCIC data. They are not needed for the AWS datastream since the up-stream views provide the
    -- necessary ASSET_ID_TATTOO, AWS_ACCOUNTID. However, we are capturing the pluginttext for possible research/diagnostics.
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_EC2_INSTANCE_LINUX = met.PLUGINTEXT
    FROM (select DISTINCT TEMP_DW_ASSET_ID,PLUGINTEXT
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''90191'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_LINUX'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Capture plugin: Amazon Web Services EC2 Instance Metadata Enumeration (Windows).
    -- Note: These EC2 plugins can be found in CCIC data. They are not needed for the AWS datastream since the up-stream views provide the
    -- necessary ASSET_ID_TATTOO, AWS_ACCOUNTID. However, we are capturing the pluginttext for possible research/diagnostics.
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_EC2_INSTANCE_WINDOWS = met.PLUGINTEXT
    FROM (select DISTINCT TEMP_DW_ASSET_ID,PLUGINTEXT
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''90427'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_WINDOWS'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION; -- 241021 CR1012
    --
    -- Capture plugin: AZURE Instance Metadata Enumeration (Unix).
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_AZURE_INSTANCE_LINUX = met.PLUGINTEXT
    FROM (select DISTINCT TEMP_DW_ASSET_ID,PLUGINTEXT
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''99171'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_AZURE_INSTANCE_LINUX'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION; -- 241021 CR1012
    --
    -- Capture plugin: AZURE Instance Metadata Enumeration (Windows).
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_AZURE_INSTANCE_WINDOWS = met.PLUGINTEXT
    FROM (select DISTINCT TEMP_DW_ASSET_ID,PLUGINTEXT
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''99172'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_AZURE_INSTANCE_WINDOWS'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;
    END;
END IF;

IF (:DATACATEGORY IN (:CCIC_VUL,:CCIC_VUL_MITIGATED)) THEN
    BEGIN 
    BEGIN TRANSACTION;
    --
    -- CCIC PLUGINTEXT terminates AWS ACCOUNTID with CHAR(32) (SPACE)
    -- AWS PLUGINTEXT terminates AWS ACCOUNTID with CHAR(10) (LINEFEED)
    -- 
    UPDATE TEMP_ASSET_METADATA
    set AWS_ACCOUNTID = CORE.FN_CRM_PARSE_TENABLE_AWS_ACCOUNTID(PLUGINTEXT_EC2_INSTANCE_LINUX)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_EC2_INSTANCE_LINUX IS NOT NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_LINUX.AWS_ACCOUNTID('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- CCIC PLUGINTEXT terminates AWS ACCOUNTID with CHAR(32) (SPACE)
    -- AWS PLUGINTEXT terminates AWS ACCOUNTID with CHAR(10) (LINEFEED)
    -- 
    UPDATE TEMP_ASSET_METADATA
    set AWS_ACCOUNTID = CORE.FN_CRM_PARSE_TENABLE_AWS_ACCOUNTID(PLUGINTEXT_EC2_INSTANCE_WINDOWS)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_EC2_INSTANCE_WINDOWS IS NOT NULL and AWS_ACCOUNTID IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_WINDOWS.AWS_ACCOUNTID('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Some on-prem assets do have an ASSET_ID_TATTOO so we dont want to overlay it if it already exists.
    -- When its null see if EC2 metadata can provide the ASSET_ID_TATTOO
    -- 
    UPDATE TEMP_ASSET_METADATA
    set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_TENABLE_AWS_INSTANCEID(PLUGINTEXT_EC2_INSTANCE_LINUX)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_EC2_INSTANCE_LINUX IS NOT NULL and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_LINUX.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Some on-prem assets do have an ASSET_ID_TATTOO so we dont want to overlay it if it already exists.
    -- When its null see if EC2 metadata can provide the ASSET_ID_TATTOO
    -- 
    UPDATE TEMP_ASSET_METADATA
    set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_TENABLE_AWS_INSTANCEID(PLUGINTEXT_EC2_INSTANCE_WINDOWS)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_EC2_INSTANCE_WINDOWS IS NOT NULL and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_EC2_INSTANCE_WINDOWS.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Capture plugin: Check for Empty FISMA Tattoo files. (Linux)
    -- We could have parsed the Asset_ID and Primary_FISMA_ID directly from the PLUGINTEXT
    -- but we are capturing the raw COMPLIANCE_ACTUAL_VALUE for possible research/diagnostics since things can
    -- change in the datacenter.
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_ONPREM_TAG_LINUX = NULLIF(met.COMPLIANCE_ACTUAL_VALUE,'''')
    FROM (select DISTINCT TEMP_DW_ASSET_ID
        ,CHARINDEX(''<cm:compliance-actual-value>The command returned :'',PLUGINTEXT,1) as StartActualValue 
        ,CHARINDEX(''</cm:compliance-actual-value>'',PLUGINTEXT,1) as EndActualValue 
        ,SUBSTRING(PLUGINTEXT,(StartActualValue + 50),(EndActualValue - StartActualValue - 50)) as COMPLIANCE_ACTUAL_VALUE
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''1218405'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_LINUX'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;

    --
    -- Capture plugin: Print out FISMA registry keys. (Windows)
    --
    UPDATE TEMP_ASSET_METADATA upd
    set PLUGINTEXT_ONPREM_TAG_WINDOWS = NULLIF(met.COMPLIANCE_ACTUAL_VALUE,'''')
    FROM (select DISTINCT TEMP_DW_ASSET_ID
        ,CHARINDEX(''<cm:compliance-actual-value>The command returned :'',PLUGINTEXT,1) as StartActualValue 
        ,CHARINDEX(''</cm:compliance-actual-value>'',PLUGINTEXT,1) as EndActualValue 
        ,SUBSTRING(PLUGINTEXT,(StartActualValue + 50),(EndActualValue - StartActualValue - 50)) as COMPLIANCE_ACTUAL_VALUE   
        from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''1221295'') met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_WINDOWS'';
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    --
    -- LINUX
    --
    -- 240923 CR987 add NULLIF
    BEGIN TRANSACTION;
    UPDATE TEMP_ASSET_METADATA upd
    set ASSET_ID_TATTOO = 
        NULLIF(split_part(substring(PLUGINTEXT_ONPREM_TAG_LINUX,((CHARINDEX(''/var/CMS/FISMA/Asset_ID/'',PLUGINTEXT_ONPREM_TAG_LINUX,1)) + 24),200),CHAR(10),1),'''')
      WHERE PLUGINTEXT_ONPREM_TAG_LINUX IS NOT NULL and CHARINDEX(''/var/CMS/FISMA/Asset_ID/'',PLUGINTEXT_ONPREM_TAG_LINUX,1) > 0 and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_LINUX.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;

    -- 240923 CR987 add NULLIF
    UPDATE TEMP_ASSET_METADATA upd
    set SYSTEM_ID = 
        NULLIF(split_part(substring(PLUGINTEXT_ONPREM_TAG_LINUX,((CHARINDEX(''/var/CMS/FISMA/Primary_FISMA_ID/'',PLUGINTEXT_ONPREM_TAG_LINUX,1)) + 32),100),CHAR(10),1),'''')
    WHERE PLUGINTEXT_ONPREM_TAG_LINUX IS NOT NULL and CHARINDEX(''/var/CMS/FISMA/Primary_FISMA_ID/'',PLUGINTEXT_ONPREM_TAG_LINUX,1) > 0 and SYSTEM_ID IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_LINUX.SYSTEM_ID('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    --
    -- WINDOWS
    -- 240923 CR987 add NULLIF
    BEGIN TRANSACTION;
    UPDATE TEMP_ASSET_METADATA upd
    set ASSET_ID_TATTOO = 
        NULLIF(split_part(substring(PLUGINTEXT_ONPREM_TAG_WINDOWS,(CHARINDEX(''The Asset_ID is '',PLUGINTEXT_ONPREM_TAG_WINDOWS,1) + 16),200),CHAR(10),1),'''')
    WHERE PLUGINTEXT_ONPREM_TAG_WINDOWS IS NOT NULL and CHARINDEX(''The Asset_ID is '',PLUGINTEXT_ONPREM_TAG_WINDOWS,1) > 0 and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_WINDOWS.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    -- 240923 CR987 add NULLIF
    UPDATE TEMP_ASSET_METADATA upd
    set SYSTEM_ID = 
        NULLIF(split_part(substring(PLUGINTEXT_ONPREM_TAG_WINDOWS,(CHARINDEX(''The Primary_FISMA_ID is '',PLUGINTEXT_ONPREM_TAG_WINDOWS,1) + 24),200),''<'',1),'''')
    WHERE PLUGINTEXT_ONPREM_TAG_WINDOWS IS NOT NULL and CHARINDEX(''The Primary_FISMA_ID is '',PLUGINTEXT_ONPREM_TAG_WINDOWS,1) > 0 and SYSTEM_ID IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_ONPREM_TAG_WINDOWS.SYSTEM_ID('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;
    END;
END IF;

IF (:DATACATEGORY IN (:MAG_VUL,:MAG_VUL_MITIGATED)) THEN -- 241021 CR1012
    BEGIN 
    BEGIN TRANSACTION;
    --
    -- AZURE - Linux
    -- 
    UPDATE TEMP_ASSET_METADATA
    set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_TENABLE_AZURE_INSTANCEID(PLUGINTEXT_AZURE_INSTANCE_LINUX)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_AZURE_INSTANCE_LINUX IS NOT NULL and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_AZURE_INSTANCE_LINUX.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;

    BEGIN TRANSACTION;
    --
    -- AZURE - Windows
    -- 
    UPDATE TEMP_ASSET_METADATA
    set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_TENABLE_AZURE_INSTANCEID(PLUGINTEXT_AZURE_INSTANCE_WINDOWS)
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGINTEXT_AZURE_INSTANCE_WINDOWS IS NOT NULL and ASSET_ID_TATTOO IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated TEMP_ASSET_METADATA.PLUGINTEXT_AZURE_INSTANCE_WINDOWS.ASSET_ID_TATTOO('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
    COMMIT;
    END;
END IF;

--
-- ACCOUNT_NUMBER can be found in some CCIC DATA, not just AWS
-- Some CAMP AWS Account IDs are linked to more that one system.
-- This needs to be addressed by CAMP and Datacenter.
-- As of 240714 these 4 account IDs are linked to more than on system: 087146460863,129336736835,333986012448,667687613718
-- We must have only one Primary FISMA ID so we use the rank function to obtain only one SYSTEM_ID per ACCOUNT_NUMBER
--
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_METADATA upd
set SYSTEM_ID = met.SYSTEM_ID
FROM TEMP_ASSET_METADATA t
JOIN (SELECT flw.ACCOUNT_NUMBER,flw.SYSTEM_ID
    FROM (select rank()over(partition by ACCOUNT_NUMBER order by SYSTEM_ID) TheRank,ACCOUNT_NUMBER,SYSTEM_ID
    from CORE.VW_AWS_CAMPDB_LOOKUP) flw where flw.TheRank = 1) met on met.ACCOUNT_NUMBER = t.AWS_ACCOUNTID   
WHERE upd.TEMP_DW_ASSET_ID = t.TEMP_DW_ASSET_ID and t.SYSTEM_ID IS NULL; 

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Updated TEMP_ASSET_METADATA.SYSTEM_ID (CAMP Lookup)('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
COMMIT;

--
-- 240924 There is potential to use the tags found in the Software plugin if the Tattoo plugins dont return the desired data
--
-- Plugin 20811 - Microsoft Windows Installed Software Enumeration (credentialed check)
--
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_METADATA upd
    set WINDOWS_INSTALLED_SOFTWARE_ASSET_ID = NULLIF(met.ASSET_ID,'''')
    FROM (select DISTINCT TEMP_DW_ASSET_ID
    ,TRIM(REPLACE(REVERSE(SPLIT_PART(REVERSE(REPLACE(REPLACE(SPLIT_PART(PLUGINTEXT,''[version Asset_ID]'',1),'':'','']''),CHR(10),'']'')),'']'',1)),CHR(10),'''')) as ASSET_ID
    from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''20811''
    and POSITION(''[version Asset_ID]'',PLUGINTEXT) > 0    ) met 
WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;
COMMIT;
--
-- 240924 CR-TBD
--
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_METADATA
set ASSET_ID_TATTOO = WINDOWS_INSTALLED_SOFTWARE_ASSET_ID
WHERE ASSET_ID_TATTOO IS NULL and WINDOWS_INSTALLED_SOFTWARE_ASSET_ID IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Updated ASSET_ID_TATTOO using WINDOWS_INSTALLED_SOFTWARE_ASSET_ID='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
COMMIT;
--
-- 240924 There is potential to use the tags found in the Software plugin if the Tattoo plugins dont return the desired data
--
-- Plugin 20811 - Microsoft Windows Installed Software Enumeration (credentialed check)
--
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_METADATA upd
    set WINDOWS_INSTALLED_SOFTWARE_FISMA_ID = NULLIF(met.FISMA_ID,'''')
    FROM (select DISTINCT TEMP_DW_ASSET_ID
    ,TRIM(REPLACE(REVERSE(SPLIT_PART(REVERSE(REPLACE(REPLACE(SPLIT_PART(PLUGINTEXT,''[version Primary_FISMA_ID]'',1),'':'','']''),CHR(10),'']'')),'']'',1)),CHR(10),'''')) as FISMA_ID
    from RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and PLUGIN_ID = ''20811''
    and POSITION(''[version Primary_FISMA_ID]'',PLUGINTEXT) > 0
    ) met 
WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;
COMMIT;
--
-- 240924 CR-TBD
--
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_METADATA
set SYSTEM_ID = WINDOWS_INSTALLED_SOFTWARE_FISMA_ID
WHERE SYSTEM_ID IS NULL and WINDOWS_INSTALLED_SOFTWARE_FISMA_ID IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Updated SYSTEM_ID using WINDOWS_INSTALLED_SOFTWARE_FISMA_ID='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if;
COMMIT;

----------------------------------------------------------------------------------------------------------
--
-- GENERATE ERRORS/WARNINGS
--
----------------------------------------------------------------------------------------------------------

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''DATACENTER_ID is Null'';
UPDATE TEMP_ASSET_METADATA
set DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,:STEP_MSG) 
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DATACENTER_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''DATACENTER_ID is Null('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''DATACENTER_ID is invalid'';
UPDATE TEMP_ASSET_METADATA upd
set DATA_ERROR_ARRAY = ARRAY_APPEND(upd.DATA_ERROR_ARRAY,:STEP_MSG) 
FROM TEMP_ASSET_METADATA t
LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = t.DATACENTER_ID
WHERE t.SNAPSHOT_ID = :P_SNAPSHOT_ID and t.DATACENTER_ID IS NOT NULL and s.SYSTEM_ID IS NULL and upd.TEMP_DW_ASSET_ID = t.TEMP_DW_ASSET_ID;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''DATACENTER_ID is invalid('' || :DATACATEGORY || '')='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

IF (:DATACATEGORY IN (:CCIC_VUL,:CCIC_VUL_MITIGATED)) THEN
    BEGIN 
    BEGIN TRANSACTION;
    STEP_MSG := METADATA_PREFIX || ''No metadata plugins available (1218405,1221295,90191,90427)'';
    UPDATE TEMP_ASSET_METADATA upd
    set DATA_WARNING_ARRAY = ARRAY_APPEND(upd.DATA_WARNING_ARRAY,:STEP_MSG) 
    FROM (select TEMP_DW_ASSET_ID
            from RAW_TENABLE_VUL
            where snapshot_id = :P_SNAPSHOT_ID
            and plugin_id in (''1218405'',''1221295'',''90191'',''90427'')
            group by TEMP_DW_ASSET_ID
            having count(1) = 0) met
    WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
    COMMIT;

    BEGIN TRANSACTION;
    STEP_MSG := METADATA_PREFIX || ''Plugin could not retrieve the Asset_ID tag'';
    UPDATE TEMP_ASSET_METADATA
    set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,:STEP_MSG) 
    WHERE ASSET_ID_TATTOO IS NULL
    and (PLUGINTEXT_EC2_INSTANCE_LINUX IS NOT NULL or PLUGINTEXT_EC2_INSTANCE_WINDOWS IS NOT NULL
        or PLUGINTEXT_ONPREM_TAG_LINUX IS NOT NULL or PLUGINTEXT_ONPREM_TAG_WINDOWS IS NOT NULL);

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
    COMMIT;

    BEGIN TRANSACTION;
    STEP_MSG := METADATA_PREFIX || ''Plugin could not retrieve the Primary_FISMA_ID tag'';
    UPDATE TEMP_ASSET_METADATA
    set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,:STEP_MSG) 
    WHERE SYSTEM_ID IS NULL
    and (PLUGINTEXT_EC2_INSTANCE_LINUX IS NOT NULL or PLUGINTEXT_EC2_INSTANCE_WINDOWS IS NOT NULL
        or PLUGINTEXT_ONPREM_TAG_LINUX IS NOT NULL or PLUGINTEXT_ONPREM_TAG_WINDOWS IS NOT NULL);

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
    COMMIT;
    END;
END IF;

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''AWS_ACCOUNTID is not in CAMP DB'';
UPDATE TEMP_ASSET_METADATA upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(upd.DATA_WARNING_ARRAY,:STEP_MSG) 
FROM (select t.TEMP_DW_ASSET_ID
        from TEMP_ASSET_METADATA t
        LEFT OUTER JOIN CORE.VW_AWS_CAMPDB_LOOKUP flw on flw.account_number = t.AWS_ACCOUNTID
        where t.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and t.AWS_ACCOUNTID IS NOT NULL and t.SYSTEM_ID IS NULL
        group by t.TEMP_DW_ASSET_ID) met
WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

-----------------------------------------------------------------------------------
--
-- Default SYSTEM_ID to DATACENTER_ID if SYSTEM_ID is not available
--
-----------------------------------------------------------------------------------
IF (:DATACATEGORY IN (:CCIC_VUL,:CCIC_VUL_MITIGATED,:FORESCOUT)) THEN
    BEGIN 
    BEGIN TRANSACTION;
    STEP_MSG := METADATA_PREFIX || ''SYSTEM_ID defaulted to DATACENTER_ID because no metadata plugins'';
    UPDATE TEMP_ASSET_METADATA
    set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,:STEP_MSG) 
    ,SYSTEM_ID = DATACENTER_ID
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and SYSTEM_ID IS NULL and DATACENTER_ID IS NOT NULL
    and PLUGINTEXT_EC2_INSTANCE_LINUX IS NULL and PLUGINTEXT_EC2_INSTANCE_WINDOWS IS NULL
    and PLUGINTEXT_ONPREM_TAG_LINUX IS NULL and PLUGINTEXT_ONPREM_TAG_WINDOWS IS NULL;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
    If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
    COMMIT;
    END;
END IF;
 
BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''SYSTEM_ID defaulted to DATACENTER_ID (Perhaps a network device)'';
UPDATE TEMP_ASSET_METADATA
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,:STEP_MSG) 
,SYSTEM_ID = DATACENTER_ID
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and SYSTEM_ID IS NULL and DATACENTER_ID IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''Tag contains deprecated Dependent_FISMA_ID'';
UPDATE TEMP_ASSET_METADATA
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,:STEP_MSG) 
WHERE SYSTEM_ID LIKE ''%The Dependent_FISMA_ID%'';

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''Removed Dependent_FISMA_ID from SYSTEM_ID'';
UPDATE TEMP_ASSET_METADATA tam
set SYSTEM_ID = split_part(tam.system_id,CHAR(10),1)
WHERE SYSTEM_ID LIKE ''%The Dependent_FISMA_ID%'';

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_METADATA.WARNING('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

BEGIN TRANSACTION;
STEP_MSG := METADATA_PREFIX || ''SYSTEM_ID is invalid'';
UPDATE TEMP_ASSET_METADATA upd
set DATA_ERROR_ARRAY = ARRAY_APPEND(upd.DATA_ERROR_ARRAY,:STEP_MSG) 
FROM (select t.TEMP_DW_ASSET_ID
        from TEMP_ASSET_METADATA t
        LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = t.SYSTEM_ID
        where t.SNAPSHOT_ID = :P_SNAPSHOT_ID and s.SYSTEM_ID IS NULL
        group by t.TEMP_DW_ASSET_ID) met
WHERE upd.TEMP_DW_ASSET_ID = met.TEMP_DW_ASSET_ID;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_METADATA.ERROR('' || :DATACATEGORY || '') '' || :STEP_MSG || ''='' || :RECORD_COUNT;
If (:IS_VERBOSE_MODE = 1) then CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); end if; 
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LOAD_ASSETINTERFACE"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Process TEMP_HWAM data into ASSETINTERFACE_* tables.TEMP_HWAM.DW_ASSET_ID must already be set'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_LOAD_ASSETINTERFACE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
DATACATEGORY varchar;
RECORD_COUNT NUMBER;

-- 230929 added: and r.DATECOMPLETED IS NULL

BEGIN
select DATACATEGORY into :DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;
--
-- 240610 CR903 Reworked SELECT to obtain unique TEMP_HWAM
--
MERGE INTO CORE.ASSETINTERFACE_FQDN as target
USING 
(SELECT a.DW_ASSET_ID
	,GET(th.FQDN,0)::varchar as FQDN -- 240610 CR903 single array value is ok
    ,th.NORMALIZED_FQDN 
    ,a.LAST_CONFIRMED_TIME
FROM (SELECT r.DW_ASSET_ID,r.NORMALIZED_FQDN,MAX(TEMP_HWAM_ID) as MAX_TEMP_HWAM_ID
    FROM CORE.TEMP_HWAM r
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(r.NORMALIZED_FQDN,'''') IS NOT NULL and r.DATECOMPLETED IS NULL
    GROUP BY r.DW_ASSET_ID,r.NORMALIZED_FQDN) m
    JOIN CORE.TEMP_HWAM th on th.TEMP_HWAM_ID = m.MAX_TEMP_HWAM_ID
    JOIN CORE.ASSET a on a.DW_ASSET_ID = th.DW_ASSET_ID
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.NORMALIZED_FQDN = target.NORMALIZED_FQDN) -- 240612 CR903

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,FQDN
    ,NORMALIZED_FQDN -- 240610 CR903
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.FQDN
    ,src.NORMALIZED_FQDN -- 240610 CR903
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_FQDN complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION;
-----------
--
-- 240611 CR903 Reworked SELECT to obtain unique TEMP_HWAM
--
MERGE INTO CORE.ASSETINTERFACE_HOSTNAME as target
USING 
(SELECT a.DW_ASSET_ID
	,coalesce(GET(th.HOSTNAME,0)::varchar,m.NORMALIZED_HOSTNAME) as HOSTNAME -- 240617 CR903 Use Normalized_Hostname if Hostame is null
    ,m.NORMALIZED_HOSTNAME 
    ,a.LAST_CONFIRMED_TIME
FROM (SELECT r.DW_ASSET_ID,GET(r.NORMALIZED_HOSTNAME,0) as NORMALIZED_HOSTNAME,MAX(TEMP_HWAM_ID) as MAX_TEMP_HWAM_ID
    FROM CORE.TEMP_HWAM r
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(GET(r.NORMALIZED_HOSTNAME,0),'''') IS NOT NULL and r.DATECOMPLETED IS NULL
    GROUP BY r.DW_ASSET_ID,GET(r.NORMALIZED_HOSTNAME,0)) m
    JOIN CORE.TEMP_HWAM th on th.TEMP_HWAM_ID = m.MAX_TEMP_HWAM_ID
    JOIN CORE.ASSET a on a.DW_ASSET_ID = th.DW_ASSET_ID
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.NORMALIZED_HOSTNAME = target.NORMALIZED_HOSTNAME)

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,HOSTNAME
    ,NORMALIZED_HOSTNAME
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.HOSTNAME
    ,src.NORMALIZED_HOSTNAME
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_HOSTNAME complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION;

MERGE INTO CORE.ASSETINTERFACE_IPV4 as target
USING (SELECT
	a.DW_ASSET_ID
	,f.value::string as IPV4 -- 230718
	,MAX(a.LAST_CONFIRMED_TIME) as LAST_CONFIRMED_TIME
FROM CORE.TEMP_HWAM r
JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID
JOIN TABLE(flatten(IPV4,outer=>true)) as f
WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(f.value,'''') IS NOT NULL and r.DATECOMPLETED IS NULL
GROUP BY a.DW_ASSET_ID, f.value::string -- 230718
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.IPV4 = target.IPV4)

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,IPV4
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.IPV4
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_IPV4 complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION;

MERGE INTO CORE.ASSETINTERFACE_IPV6 as target
USING (SELECT
	a.DW_ASSET_ID
	,f.value::string as IPV6 -- 230718
	,MAX(a.LAST_CONFIRMED_TIME) as LAST_CONFIRMED_TIME
FROM CORE.TEMP_HWAM r
JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID
JOIN TABLE(flatten(IPV6,outer=>true)) as f
WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(f.value,'''') IS NOT NULL and r.DATECOMPLETED IS NULL
GROUP BY a.DW_ASSET_ID, f.value::string -- 230718
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.IPV6 = target.IPV6)

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,IPV6
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.IPV6
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_IPV6 complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION; -- 230728

MERGE INTO CORE.ASSETINTERFACE_MACADDRESS as target
USING (SELECT
    a.DW_ASSET_ID
    ,f.value::string as MACADDRESS
    ,MAX(a.LAST_CONFIRMED_TIME) as LAST_CONFIRMED_TIME
FROM CORE.TEMP_HWAM r
JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID
JOIN TABLE(flatten(MACADDRESS,outer=>true)) as f
WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(f.value,'''') IS NOT NULL and r.DATECOMPLETED IS NULL
GROUP BY a.DW_ASSET_ID, f.value::string
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.MACADDRESS = target.MACADDRESS)

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,MACADDRESS
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.MACADDRESS
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_MACADDRESS complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

BEGIN TRANSACTION;
--
-- 240606 CR903 Reworked SELECT to obtain unique TEMP_HWAM
--
MERGE INTO CORE.ASSETINTERFACE_NETBIOSNAME as target
USING 
(SELECT a.DW_ASSET_ID
	,GET(th.NETBIOSNAME,0)::varchar as NETBIOSNAME -- 240606 CR903 single array value is ok
    ,th.NORMALIZED_NETBIOSNAME 
    ,a.LAST_CONFIRMED_TIME
FROM (SELECT r.DW_ASSET_ID,r.NORMALIZED_NETBIOSNAME,MAX(TEMP_HWAM_ID) as MAX_TEMP_HWAM_ID
    FROM CORE.TEMP_HWAM r
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(r.NORMALIZED_NETBIOSNAME,'''') IS NOT NULL and r.DATECOMPLETED IS NULL
    GROUP BY r.DW_ASSET_ID,r.NORMALIZED_NETBIOSNAME) m
    JOIN CORE.TEMP_HWAM th on th.TEMP_HWAM_ID = m.MAX_TEMP_HWAM_ID
    JOIN CORE.ASSET a on a.DW_ASSET_ID = th.DW_ASSET_ID
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.NORMALIZED_NETBIOSNAME = target.NORMALIZED_NETBIOSNAME)

WHEN MATCHED THEN UPDATE SET 
    target.LAST_CONFIRMED_TIME = src.LAST_CONFIRMED_TIME

WHEN NOT MATCHED THEN INSERT (
	DATACATEGORY
	,DATEUSEDBYMATCHING
	,DW_ASSET_ID
	,INSERT_DATE
	,NETBIOSNAME
    ,NORMALIZED_NETBIOSNAME -- 240606 CR903
	,LAST_CONFIRMED_TIME
)
VALUES (
	:DATACATEGORY -- DATACATEGORY
	,null -- DATEUSEDBYMATCHING
	,src.DW_ASSET_ID
	,CURRENT_TIMESTAMP() -- INSERT_DATE
	,src.NETBIOSNAME
    ,src.NORMALIZED_NETBIOSNAME -- 240606 CR903
	,src.LAST_CONFIRMED_TIME
);

-- 240710 CR928 Msg := ''Merge ASSETINTERFACE_NETBIOSNAME complete'';
-- 240710 CR928 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;


UPDATE TEMP_HWAM upd
set DATECOMPLETED = CURRENT_TIMESTAMP()
FROM CORE.TEMP_HWAM r
JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID
WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.TEMP_HWAM_ID = upd.TEMP_HWAM_ID;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LOAD_ASSET_V2"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Process RAW_HWAM or RAW_TENABLE_VUL data into ASSET tables'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_LOAD_ASSET_V2'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RowDispositionViable varchar := ''Viable'';
AWS_HWAM varchar := ''AWS HWAM'';
AWS_TENABLE varchar := ''AWS VUL'';
CCIC_TENABLE varchar := ''CCIC VUL'';
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED'';
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED'';
FORESCOUT_HWAM varchar := ''FORESCOUT''; -- Added 240329 CR860
CROWDSTRIKE varchar := ''CROWDSTRIKE''; -- Added 240822 CR958
AXONIUS varchar := ''AXONIUS''; -- Added 240917 CR981
MAG_VUL varchar := ''MAG VUL''; -- 241022 CR1012
MAG_VUL_MITIGATED varchar := ''MAG VUL MITIGATED''; -- 241022 CR1012
HWAM varchar := ''HWAM'';
VUL varchar := ''VUL'';
PARENT_DATACATEGORY varchar;
UnknownDeviceType varchar := ''Unknown'';
DATACATEGORY varchar;
RECORD_COUNT NUMBER;

BEGIN
select DATACATEGORY,PARENT_DATACATEGORY into :DATACATEGORY,:PARENT_DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- 241022 CR1012 add MAG_VUL,MAG_VUL_MITIGATED
-- 240917 CR981 add AXONIUS
-- 240822 CR958 add CROWDSTRIKE
IF (:DATACATEGORY NOT IN (:AWS_HWAM,:AWS_TENABLE,:AWS_VUL_MITIGATED,:CCIC_TENABLE,:CCIC_VUL_MITIGATED,
    :FORESCOUT_HWAM,:CROWDSTRIKE,:AXONIUS,:MAG_VUL,:MAG_VUL_MITIGATED)) THEN
	BEGIN
	Msg := ''Unknown DataCategory - check SNAPSHOT_ID'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

BEGIN TRANSACTION; -- 240611 CR903 add transaction
--
-- Write RAW_HWAM or RAW_TENABLE_VUL to common TEMP_HWAM for asset matching/asset creation/asset update
--
IF (upper(:PARENT_DATACATEGORY) = :HWAM) THEN
	BEGIN
    INSERT INTO TEMP_HWAM(
    ASSET_ID_TATTOO
    ,AWS_ACCOUNTID
    ,BIGFIX_ASSET_ID
    ,BIOS_GUID
    ,COMPUTER_TYPE
    ,DATACENTER_ID
    ,DEVICE_TYPE
    ,DEVICEMODEL
    ,ENVIRONMENT
    ,FQDN
    ,HOSTNAME
    ,INSTANCESTATUS
    ,IPV4
    ,IPV6
    ,IS_FORESCOUT_MANAGED
    ,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
    ,LAST_CONFIRMED_TIME
    ,MACADDRESS
    ,MOTHERBOARD
    ,NETBIOSNAME
    ,OS
    ,SNAPSHOT_ID
    ,SOURCE_TOOL
    ,SYSTEM_ID
    ,TEMP_DW_ASSET_ID
    ,TENANT_ID
	)
	SELECT
    ASSET_ID_TATTOO
    ,AWS_ACCOUNTID
    ,BIGFIX_ASSET_ID
    ,BIOS_GUID
    ,COMPUTER_TYPE
    ,DATACENTER_ID
    ,DEVICE_TYPE
    ,DEVICEMODEL
    ,ENVIRONMENT
    ,FQDN
    ,HOSTNAME
    ,INSTANCESTATUS
    ,IPV4
    ,IPV6
    ,COALESCE(NULLIF(IS_FS_MANAGED,''''),''0'')::BOOLEAN -- IS_FORESCOUT_MANAGED
    ,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
    ,LAST_CONFIRMED_TIME
    ,MACADDRESS
    ,MOTHERBOARD
    ,NETBIOSNAME
    ,OS
    ,SNAPSHOT_ID
    ,SOURCE_TOOL
    ,SYSTEM_ID
    ,TEMP_DW_ASSET_ID
    ,TENANT_ID
    FROM CORE.RAW_HWAM 
    WHERE RAW_HWAM_ID IN 
    (SELECT r2.RAW_HWAM_ID 
    --
    -- 240815 1449 CR-EBF Find TEMP_DW_ASSET_ID with most current (LAST_CONFIRMED_TIME) as expressed in RAW_HWAM_ID
    --
    FROM (select rank()over(partition by r1.TEMP_DW_ASSET_ID order by r1.LAST_CONFIRMED_TIME desc,r1.RAW_HWAM_ID desc) TheRank,r1.TEMP_DW_ASSET_ID,r1.LAST_CONFIRMED_TIME,r1.RAW_HWAM_ID
        FROM CORE.RAW_HWAM r1
        JOIN (select DISTINCT TEMP_DW_ASSET_ID FROM CORE.RAW_HWAM 
        WHERE snapshot_id = :P_SNAPSHOT_ID 
        -- 240826 CR-TBD and ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() 
            and array_size(DATA_ERROR_ARRAY) = 0 and TEMP_DW_ASSET_ID IS NOT NULL) d on d.TEMP_DW_ASSET_ID = r1.TEMP_DW_ASSET_ID
        WHERE r1.snapshot_id = :P_SNAPSHOT_ID 
        -- 240826 CR-TBD and r1.ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() 
        and array_size(r1.DATA_ERROR_ARRAY) = 0) r2 where r2.TheRank = 1);
	END;
ELSE
BEGIN
	INSERT INTO TEMP_HWAM(
    ASSET_ID_TATTOO
    ,AWS_ACCOUNTID
    ,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
    ,DATACENTER_ID
    ,FQDN
    ,HOSTNAME
    ,IPV4
    ,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
    ,IS_TENABLE_CREDENTIALED_SCAN
    ,LAST_CONFIRMED_TIME
    ,MACADDRESS
    ,NETBIOSNAME
    ,OS
    ,SNAPSHOT_ID
    ,SOURCE_TOOL
    ,SYSTEM_ID
    ,TEMP_DW_ASSET_ID
    ,TENABLEUUID
    ,TENANT_ID
	)
	SELECT
    ASSET_ID_TATTOO
    ,AWS_ACCOUNTID
    ,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
    ,DATACENTER_ID
    ,DNSNAME::array -- FQDN
    ,HOSTNAME::array -- HOSTNAME
    ,IPS::array -- IPV4
    ,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
    ,COALESCE(NULLIF(CREDENTIALED_SCAN,''''),''0'')::BOOLEAN -- IS_TENABLE_CREDENTIALED_SCAN
    ,LAST_SEEN -- LAST_CONFIRMED_TIME
    ,MACADDRESS::array -- MACADDRESS
    ,NETBIOSNAME::array -- NETBIOSNAME
    ,OPERATING_SYSTEM -- OS
    ,SNAPSHOT_ID
    ,SOURCE_TOOL
    ,SYSTEM_ID
    ,TEMP_DW_ASSET_ID
    ,TENABLEUUID
    ,TENANT_ID
    FROM CORE.RAW_TENABLE_VUL
    WHERE RAW_TENABLE_VUL_ID IN 
    (SELECT r2.RAW_TENABLE_VUL_ID 
    --
    -- 240815 1449 CR-EBF Find TEMP_DW_ASSET_ID with most current (LAST_SEEN) as expressed in RAW_TENABLE_VUL_ID
    --
    FROM (select rank()over(partition by r1.TEMP_DW_ASSET_ID order by r1.LAST_SEEN desc,r1.RAW_TENABLE_VUL_ID desc) TheRank,r1.TEMP_DW_ASSET_ID,r1.LAST_SEEN,r1.RAW_TENABLE_VUL_ID
        FROM CORE.RAW_TENABLE_VUL r1
        JOIN (select DISTINCT TEMP_DW_ASSET_ID FROM CORE.RAW_TENABLE_VUL 
        WHERE snapshot_id = :P_SNAPSHOT_ID 
        -- 240826 CR-TBD and ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() 
            and array_size(DATA_ERROR_ARRAY) = 0 and TEMP_DW_ASSET_ID IS NOT NULL) d on d.TEMP_DW_ASSET_ID = r1.TEMP_DW_ASSET_ID
        WHERE r1.snapshot_id = :P_SNAPSHOT_ID 
        -- 240826 CR-TBD and r1.ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() 
        and array_size(r1.DATA_ERROR_ARRAY) = 0) r2 where r2.TheRank = 1);
	END;
END IF;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TEMP_HWAM rows written='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
--
-- 240606 CR903
--
-- NORMALIZE certain fields to be used in asset matching.
-- ASSET_ID_TATTOO found differences in case depending on the sensor
-- FQDN is almost always a single value so an array is not needed. I found 5 cases over 90 days where there was more than one value but they were bogus
-- HOSTNAME needs to be an array. Had to flatten HOSTNAME in order to do split_part then re-create array.
-- NETBIOSNAME is almost always a single value so an array is not needed. I found 1 case over 90 days where there was more than one value but it was bogus
-- MACADDRESS needs to be an array
--
-- Also note: When testing this sql in a separate worksheet remove one of the back-slashes between the double-dollars
--
UPDATE TEMP_HWAM upd
set ASSET_ID_TATTOO = UPPER(th.ASSET_ID_TATTOO) -- 240622 CR903 Found upper/lower case values depending on sensor
,NORMALIZED_FQDN = UPPER(NULLIF(GET(th.FQDN,0)::varchar,''''))
,NORMALIZED_HOSTNAME = n.NORMALIZED_HOSTNAME -- 240611 CR903
,NORMALIZED_NETBIOSNAME = UPPER(coalesce(NULLIF(split_part(GET(th.NETBIOSNAME,0)::varchar,$$\\$$,2),''''),GET(th.NETBIOSNAME,0)::varchar)) -- Use double-dollars to avoid back-slash escape
,NORMALIZED_MACADDRESS = STRTOK_TO_ARRAY(UPPER(REPLACE(REPLACE(ARRAY_TO_STRING(th.MACADDRESS,''$''),'':'',''''),''-'','''')),''$'')
,MOTHERBOARD = UPPER(th.MOTHERBOARD) -- 240617
FROM (SELECT r.TEMP_HWAM_ID,ARRAY_AGG(NULLIF(REPLACE(UPPER(coalesce(split_part(f.value::string,''.'',1),split_part(GET(r.fqdn,0),''.'',1))),''*'',''''),'''')) as NORMALIZED_HOSTNAME
    FROM TEMP_HWAM r
    join table(flatten(HOSTNAME,outer=>true)) as f
    where r.SNAPSHOT_ID = :P_SNAPSHOT_ID
    GROUP BY r.TEMP_HWAM_ID) n
JOIN TEMP_HWAM th on th.TEMP_HWAM_ID = n.TEMP_HWAM_ID
WHERE upd.TEMP_HWAM_ID = th.TEMP_HWAM_ID;

COMMIT;

--
-- Attempt to match new rows against existing asset records
--
CALL CORE.SP_CRM_MATCH_EXISTING_ASSET_V3(:P_SNAPSHOT_ID); -- 240828 CR-TBD V3  240621 CR903
CALL CORE.SP_CRM_UPDATE_ASSET(:P_SNAPSHOT_ID); -- 240705 CR928 Renamed procedure
CALL CORE.SP_CRM_LOAD_ASSETINTERFACE(:P_SNAPSHOT_ID); -- Update the ASSETINTERFACE_* tables

--
-- Insert ASSET table based on Non-ASSET_ID_TATTOO rows
--
CALL CORE.SP_CRM_CREATE_ASSET_V1(:P_SNAPSHOT_ID); -- 240621 2109 CR903
CALL CORE.SP_CRM_LOAD_ASSETINTERFACE(:P_SNAPSHOT_ID); -- Update the ASSETINTERFACE_* tables

IF (:DATACATEGORY IN (:AWS_HWAM,:FORESCOUT_HWAM,:CROWDSTRIKE,:AXONIUS)) THEN -- 240917 CR981 add AXONIUS, 240822 CR958 add CROWDSTRIKE
	BEGIN
    --
    -- 240727 CR928
    -- At this time only HWAM datastreams provide DEVICETYPE.
    -- AWS is always: Server
    --
    BEGIN TRANSACTION;
    UPDATE ASSET upd
    set DEVICETYPE = t.DEVICE_TYPE
    FROM (SELECT dev.DW_ASSET_ID,dev.DEVICE_TYPE
        FROM (select rank()over(partition by DW_ASSET_ID order by DEVICE_TYPE) TheRank,DW_ASSET_ID,DEVICE_TYPE
        FROM CORE.TEMP_HWAM th
        JOIN CORE.DEVICETYPES dt on UPPER(dt.DEVICETYPE) = UPPER(th.DEVICE_TYPE)
        WHERE th.SNAPSHOT_ID = :P_SNAPSHOT_ID) dev where dev.TheRank = 1) t
    WHERE upd.DEVICETYPE = :UnknownDeviceType and upd.DW_ASSET_ID = t.DW_ASSET_ID;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''Updated ASSET.DEVICETYPE='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;   
	END;
END IF;


BEGIN TRANSACTION;

IF (upper(:PARENT_DATACATEGORY) = :VUL) THEN
	BEGIN
    --
    -- Set RAW_TENABLE_VUL.DW_ASSET_ID so SP_CRM_VULMASTER can link vulnerabilities to assets and for traceability
    --
    -- 240828 CR-TBD enhanced WHERE to improve performance
    --
    UPDATE RAW_TENABLE_VUL upd
    set DW_ASSET_ID = t.DW_ASSET_ID
    FROM RAW_TENABLE_VUL r
    JOIN TEMP_HWAM t on t.SNAPSHOT_ID = r.SNAPSHOT_ID and t.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID
    WHERE upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID
    and t.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and upd.TEMP_DW_ASSET_ID = t.TEMP_DW_ASSET_ID and t.DW_ASSET_ID IS NOT NULL and r.DW_ASSET_ID IS NULL;
    
 -- 240828 CR-TBD   WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID and t.DW_ASSET_ID IS NOT NULL and r.DW_ASSET_ID IS NULL;
   
    UPDATE ASSET upd
    set SOURCE_TOOL_VUL = :DATACATEGORY
    ,LASTMODIFIEDBY_TENABLE = CURRENT_TIMESTAMP()
    ,LASTSEEN_VUL = t.LAST_CONFIRMED_TIME
    FROM TEMP_HWAM t
    WHERE t.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.DW_ASSET_ID = t.DW_ASSET_ID;
    END;
ELSE
	BEGIN
    --
    -- Set RAW_HWAM.DW_ASSET_ID for traceability
    --
    -- 240828 CR-TBD enhanced WHERE to improve performance
    --
    UPDATE RAW_HWAM upd
    set DW_ASSET_ID = t.DW_ASSET_ID
    FROM RAW_HWAM r
    JOIN TEMP_HWAM t on t.SNAPSHOT_ID = r.SNAPSHOT_ID and t.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID
    WHERE upd.RAW_HWAM_ID = r.RAW_HWAM_ID
    and t.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and upd.TEMP_DW_ASSET_ID = t.TEMP_DW_ASSET_ID and t.DW_ASSET_ID IS NOT NULL and r.DW_ASSET_ID IS NULL;

 -- 240828 CR-TBD    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID and t.DW_ASSET_ID IS NOT NULL and r.DW_ASSET_ID IS NULL;

    IF (upper(:DATACATEGORY) = :AWS_HWAM) THEN
        BEGIN   
        UPDATE ASSET upd
        set SOURCE_TOOL_HWAM = :DATACATEGORY
        ,LASTMODIFIEDBY_AWS = CURRENT_TIMESTAMP()
        ,LASTSEEN_HWAM = t.LAST_CONFIRMED_TIME
        FROM TEMP_HWAM t
        WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.SNAPSHOT_ID = :P_SNAPSHOT_ID;
        END;
    ELSEIF (upper(:DATACATEGORY) = :FORESCOUT_HWAM) THEN -- Added 240329 CR860
        BEGIN 
        UPDATE ASSET upd
        set SOURCE_TOOL_HWAM = :DATACATEGORY
        ,LASTMODIFIEDBY_FORESCOUT = CURRENT_TIMESTAMP()
        ,LASTSEEN_HWAM = t.LAST_CONFIRMED_TIME
        FROM TEMP_HWAM t
        WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.SNAPSHOT_ID = :P_SNAPSHOT_ID;
        END;
    ELSEIF (upper(:DATACATEGORY) = :CROWDSTRIKE) THEN -- Added 240822 CR958
        BEGIN 
        UPDATE ASSET upd
        set SOURCE_TOOL_HWAM = :DATACATEGORY
        ,LASTMODIFIEDBY_CROWDSTRIKE = CURRENT_TIMESTAMP()
        ,LASTSEEN_HWAM = t.LAST_CONFIRMED_TIME
        FROM TEMP_HWAM t
        WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.SNAPSHOT_ID = :P_SNAPSHOT_ID;
        END; 
    ELSEIF (upper(:DATACATEGORY) = :AXONIUS) THEN -- Added 240822 CR958
        BEGIN 
        UPDATE ASSET upd
        set SOURCE_TOOL_HWAM = :DATACATEGORY
        ,LASTMODIFIEDBY_AXONIUS = CURRENT_TIMESTAMP()
        ,LASTSEEN_HWAM = t.LAST_CONFIRMED_TIME
        FROM TEMP_HWAM t
        WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.SNAPSHOT_ID = :P_SNAPSHOT_ID;
        END;
    ELSE
        BEGIN -- Unknown
        UPDATE ASSET upd
        set SOURCE_TOOL_HWAM = :DATACATEGORY
        ,LASTSEEN_HWAM = t.LAST_CONFIRMED_TIME
        FROM TEMP_HWAM t
        WHERE upd.DW_ASSET_ID = t.DW_ASSET_ID and t.SNAPSHOT_ID = :P_SNAPSHOT_ID;
        END;
    END IF;
    END;
END IF;

UPDATE CORE.SNAPSHOT_IDS
set UNASSIGNED_DW_ASSET_ID = (select count(1) from TEMP_HWAM WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and dw_asset_id IS NULL)
WHERE snapshot_id = :P_SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LOAD_VULCVE_MASTER"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Load VULPLUGINS_MASTER data into VULMASTER which contains distinct cves per asset'
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_LOAD_VULCVE_MASTER'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RowDispositionError varchar := ''Error''; 
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

------------------------
-- BEGINNING OF MERGE --
------------------------
MERGE INTO CORE.VULMASTER target USING
 (SELECT Maxplugin.CVE
,Maxplugin.Max_CVSSV2BASESCORE as CVSSV2BASESCORE
,Maxplugin.Max_CVSSV3BASESCORE as CVSSV3BASESCORE
,datediff(day,Maxplugin.Min_firstseen,Maxplugin.Max_lastfound) as DAYSSINCEDISCOVERY
,Maxplugin.dw_asset_id
,Maxplugin.Max_DW_PLUGIN_VUL_ID as DW_PLUGIN_VUL_ID
,case Maxplugin.Max_exploitavailable
    when 1 then ''Yes''
    Else ''No''
End as EXPLOITAVAILABLE
,Maxplugin.Min_firstseen as FIRSTSEEN
,case Maxplugin.Max_numeric_severity
    when 4 then ''Critical''
    when 3 then ''High''
    when 2 then ''Medium''
    when 1 then ''Low''
    Else ''Unknown''
End as FISMASEVERITY
,vulp.IS_FROM_AWS_FEED
,IFF(DATE_PART(YEAR, Maxplugin.Min_firstseen) < 2021, 1, 0) as IS_LEGACY
,Maxplugin.Max_lastfound as LASTFOUND
,case Maxplugin.Max_has_been_mitigated
    when 1 then ''reopened''
    Else ''open''
End as MITIGATIONSTATUS
,Maxplugin.Max_numeric_severity as NUMERIC_SEVERITY
,vulp.REPOSITORY_NAME
,vulp.REPOSITORY_ID -- 230720
from (select dw_asset_id,f.value::string as cve,min(firstseen) as Min_firstseen, Max(lastfound) as Max_lastfound,max(numeric_severity) as Max_numeric_severity
    ,max(IFF(upper(r.exploitavailable) = ''YES'',1,0)::number) as Max_exploitavailable
    ,max(r.has_been_mitigated::number) as Max_has_been_mitigated
    ,max(r.CVSSV2BASESCORE) as Max_CVSSV2BASESCORE
    ,max(r.CVSSV3BASESCORE) as Max_CVSSV3BASESCORE
    ,max(r.DW_PLUGIN_VUL_ID) as Max_DW_PLUGIN_VUL_ID
    
    FROM CORE.VULPLUGINS_MASTER r
    join table(flatten(cve,outer=>true)) as f
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID
    group by dw_asset_id,f.value::string) Maxplugin
    join CORE.VULPLUGINS_MASTER vulp on vulp.DW_PLUGIN_VUL_ID = Maxplugin.Max_DW_PLUGIN_VUL_ID
) src

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.CVE = target.CVE)

WHEN MATCHED THEN UPDATE SET 
-- Never change DW_ASSET_ID, CVE, FIRSTSEEN after initial row creation (Insert)
target.CVSSV2BASESCORE          = src.CVSSV2BASESCORE
,target.CVSSV3BASESCORE         = src.CVSSV3BASESCORE
,target.DATEDELETED             = null
,target.DATEMITIGATED           = null -- If it was once mitigated it is now open/reopened again so erase prior datemitigated
,target.DATEMODIFIED            = CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
,target.DATEREOPENED            = IFF(src.MITIGATIONSTATUS = ''reopened'', src.LASTFOUND, NULL)
,target.DAYSSINCEDISCOVERY      = src.DAYSSINCEDISCOVERY
,target.DELETIONREASON          = null
,target.DW_PLUGIN_VUL_ID_MODIFY = src.DW_PLUGIN_VUL_ID
,target.EXPLOITAVAILABLE        = src.EXPLOITAVAILABLE
,target.FISMASEVERITY           = src.FISMASEVERITY
,target.IS_LEGACY               = src.IS_LEGACY
,target.LASTFOUND               = src.LASTFOUND
,target.MITIGATIONSTATUS        = src.MITIGATIONSTATUS
,target.NUMERIC_SEVERITY        = src.NUMERIC_SEVERITY
,target.REPOSITORY_NAME         = src.REPOSITORY_NAME
,target.REPOSITORY_ID           = src.REPOSITORY_ID

WHEN NOT MATCHED THEN INSERT(
	 CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,DATEDELETED
	,DATEMITIGATED
	,DATEMODIFIED
	,DATEREOPENED
	,DAYSSINCEDISCOVERY
	,DELETIONREASON
	,DW_ASSET_ID
    ,DW_PLUGIN_VUL_ID_CREATE
    ,DW_PLUGIN_VUL_ID_MODIFY
	,EXPLOITAVAILABLE
	,FIRSTSEEN
	,FISMASEVERITY
	,INSERT_DATE
    ,IS_FROM_AWS_FEED
	,IS_LEGACY
    ,IS_PREV_DELETED
	,LASTFOUND
	,MITIGATIONSTATUS
	,NUMERIC_SEVERITY
	,ORIG_FISMASEVERITY
	,ORIG_MITIGATIONSTATUS
	,PREV_FISMASEVERITY
	,PREV_MITIGATIONSTATUS
    ,REPOSITORY_NAME
    ,REPOSITORY_ID
)
VALUES (
	 src.CVE
	,src.CVSSV2BASESCORE
	,src.CVSSV3BASESCORE
	,null -- DATEDELETED
	,null -- DATEMITIGATED
	,CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
	,IFF(src.MITIGATIONSTATUS = ''reopened'', src.LASTFOUND, NULL) -- DATEREOPENED
	,src.DAYSSINCEDISCOVERY
	,null -- DELETIONREASON
	,src.DW_ASSET_ID
    ,src.DW_PLUGIN_VUL_ID -- DW_PLUGIN_VUL_ID_CREATE
    ,src.DW_PLUGIN_VUL_ID -- DW_PLUGIN_VUL_ID_MODIFY
	,src.EXPLOITAVAILABLE
	,src.FIRSTSEEN
	,src.FISMASEVERITY
	,CURRENT_TIMESTAMP() -- INSERT_DATE
    ,src.IS_FROM_AWS_FEED
	,src.IS_LEGACY
    ,0 -- IS_PREV_DELETED
	,src.LASTFOUND
	,src.MITIGATIONSTATUS
	,src.NUMERIC_SEVERITY
	,src.FISMASEVERITY -- ORIG_FISMASEVERITY
	,src.MITIGATIONSTATUS -- ORIG_MITIGATIONSTATUS
	,src.FISMASEVERITY -- PREV_FISMASEVERITY
	,src.MITIGATIONSTATUS -- PREV_MITIGATIONSTATUS
    ,src.REPOSITORY_NAME
    ,src.REPOSITORY_ID
);

COMMIT;


BEGIN TRANSACTION;
--
-- Update LASTSEEN_VUL based on any vulnerability record received (including Informational) as long as record is not in error.
-- APPLICABILITYCODE does not need to equal ApplicabilityCode_Actionable
--
update CORE.ASSET upd
set LASTSEEN_VUL =  v.Max_LAST_SEEN
,DATEMODIFIED = CURRENT_TIMESTAMP()
FROM CORE.ASSET a
JOIN (select dw_asset_id,max(last_seen) as Max_LAST_SEEN
    from CORE.RAW_TENABLE_VUL where snapshot_id = :P_SNAPSHOT_ID and ROWDISPOSITION <> :RowDispositionError and DW_ASSET_ID IS NOT NULL and DW_ASSET_ID > 0
    group by dw_asset_id) v on v.dw_asset_id = a.dw_asset_id
where a.DW_ASSET_ID = upd.DW_ASSET_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LOAD_VULPLUGIN"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Load/Update VULPLUGIN table'
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_LOAD_VULPLUGIN'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
ApplicabilityCode_Actionable varchar := ''Actionable'';
DATACATEGORY VARCHAR;
RECORD_COUNT number;

BEGIN
select DATACATEGORY into :DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

Msg := ''WARNING: DECOMMISSION THIS SP ONCE VULPLUGIN TABLE HAS BEEN DECOMMISSION'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

BEGIN TRANSACTION;

MERGE INTO CORE.VULPLUGIN as target
USING (SELECT
DISTINCT -- 230821 0948
r.DESCRIPTION
,vm.DW_VUL_ID
,r.FAMILY_NAME
,vm.LASTFOUND
,r.PATCHPUB_DATE
,r.PLUGIN_ID
,r.PLUGIN_INFO
,r.PLUGIN_MOD_DATE
,r.PLUGIN_NAME
,r.PLUGIN_PUB_DATE
,r.SOLUTION
,r.SYNOPSIS
,r.VERSION
,r.VULN_PUB_DATE

from VW_VULMASTER vm
join RAW_TENABLE_VUL r on r.dw_asset_id = vm.dw_asset_id
join table(flatten(r.cve,outer=>true)) as f
where f.value::string is not null
and f.value::string = vm.CVE
and r.SNAPSHOT_ID = :P_SNAPSHOT_ID
and r.APPLICABILITYCODE = :ApplicabilityCode_Actionable

) as src 

ON (src.DW_VUL_ID = target.DW_VUL_ID and src.PLUGIN_ID = target.PLUGIN_ID)

WHEN MATCHED THEN UPDATE SET 
target.DESCRIPTION = src.DESCRIPTION
,target.FAMILY_NAME = src.FAMILY_NAME
,target.LASTFOUND = src.LASTFOUND
,target.PATCHPUB_DATE = src.PATCHPUB_DATE
,target.PLUGIN_INFO = src.PLUGIN_INFO
,target.PLUGIN_MOD_DATE = src.PLUGIN_MOD_DATE
,target.PLUGIN_NAME = src.PLUGIN_NAME
,target.PLUGIN_PUB_DATE = src.PLUGIN_PUB_DATE
,target.SOLUTION = src.SOLUTION
,target.SYNOPSIS = src.SYNOPSIS
,target.VERSION = src.VERSION
,target.VULN_PUB_DATE = src.VULN_PUB_DATE

WHEN NOT MATCHED THEN INSERT (
DESCRIPTION
,DW_VUL_ID
,FAMILY_NAME
,INSERT_DATE
,LASTFOUND
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,SOLUTION
,SYNOPSIS
,VERSION
,VULN_PUB_DATE
)
VALUES (
src.DESCRIPTION
,src.DW_VUL_ID
,src.FAMILY_NAME
,CURRENT_TIMESTAMP() -- INSERT_DATE
,src.LASTFOUND
,src.PATCHPUB_DATE
,src.PLUGIN_ID
,src.PLUGIN_INFO
,src.PLUGIN_MOD_DATE
,src.PLUGIN_NAME
,src.PLUGIN_PUB_DATE
,src.SOLUTION
,src.SYNOPSIS
,src.VERSION
,src.VULN_PUB_DATE
);

--Msg := ''Merge ASSETINTERFACE_FQDN complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LOAD_VULPLUGINS_MASTER"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Load/Update VULPLUGINS_MASTER table'
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_LOAD_VULPLUGINS_MASTER'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RowDispositionViable varchar := ''Viable''; -- 240121 added back
ApplicabilityCode_Actionable varchar := ''Actionable'';
ApplicabilityCode_Initial varchar := ''Initial''; -- 240121 added back
AWS_VulnerabilityDataStream varchar := ''AWS VUL'';
CCIC_VulnerabilityDataStream varchar := ''CCIC VUL'';
MAG_VulnerabilityDataStream varchar := ''MAG VUL''; -- 241023 CR1012
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;
RECORD_COUNT number;

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- 241023 CR1012 added MAG_VulnerabilityDataStream
IF (upper(:DATACATEGORY) NOT IN (:AWS_VulnerabilityDataStream,:CCIC_VulnerabilityDataStream,:MAG_VulnerabilityDataStream)) THEN
	BEGIN
	Msg := ''DataCategory not vaild in this stored procedure'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

BEGIN TRANSACTION; -- 240121 this transaction was on obsolete SP_CRM_LOAD_VULMASTER. Now adding it back in.

--
-- Determiine which rows are actionable. We want to yield one row for each DW_ASSET_ID/PLUGIN_ID
--
TRUNCATE TABLE TEMP_ACTIONABLE_VUL;

INSERT INTO CORE.TEMP_ACTIONABLE_VUL (DW_ASSET_ID,FIRST_SEEN,LAST_SEEN,PLUGIN_ID,RAW_TENABLE_VUL_ID)
with
actionable_cte as (
select DW_ASSET_ID,FIRST_SEEN,LAST_SEEN,PLUGIN_ID,RAW_TENABLE_VUL_ID
    FROM CORE.RAW_TENABLE_VUL 
    where SNAPSHOT_ID = :P_SNAPSHOT_ID
    and ROWDISPOSITION = :RowDispositionViable and APPLICABILITYCODE = :ApplicabilityCode_Initial and DW_ASSET_ID IS NOT NULL -- 240121 added DW_ASSET_ID
),
last_seen_cte as(
select dw_asset_id,PLUGIN_ID,last_seen,RAW_TENABLE_VUL_ID from (
    select distinct dw_asset_id,PLUGIN_ID,last_seen,RAW_TENABLE_VUL_ID,dense_rank() over (partition by dw_asset_id,PLUGIN_ID order by last_seen desc, RAW_TENABLE_VUL_ID desc) rank --
    from actionable_cte
    ) where rank=1
),
first_seen_cte as 
    (select a.dw_asset_id,a.plugin_id,min(a.first_seen) as Min_First_Seen
    FROM actionable_cte a
    join last_seen_cte ls on ls.dw_asset_id = a.dw_asset_id and ls.last_seen = a.last_seen
    group by a.dw_asset_id,a.plugin_id
)
select v.dw_asset_id, f.Min_First_Seen, v.last_seen,v.PLUGIN_ID ,v.RAW_TENABLE_VUL_ID
FROM actionable_cte v
join last_seen_cte l on l.RAW_TENABLE_VUL_ID = v.RAW_TENABLE_VUL_ID
join first_seen_cte f on f.dw_asset_id = v.dw_asset_id and f.plugin_id = v.plugin_id;

Msg := ''Populated TEMP_ACTIONABLE_VUL'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

--
-- 240121 probably dont need where clause but verify and remove at a later date
--
UPDATE CORE.RAW_TENABLE_VUL upd
set APPLICABILITYCODE = :ApplicabilityCode_Actionable
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.TEMP_ACTIONABLE_VUL t on t.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID -- 240121 exact record already known
where upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;
-- 240121 where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
-- 240121 and r.ROWDISPOSITION = :RowDispositionViable and r.APPLICABILITYCODE = :ApplicabilityCode_Initial;

Msg := ''Set RAW_TENABLE_VUL to Actionable'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;


BEGIN TRANSACTION;

MERGE INTO CORE.VULPLUGINS_MASTER as target
USING (SELECT
r.CREDENTIALED_SCAN
,r.CVE
,r.CVSSV2BASESCORE
,r.CVSSV3BASESCORE
,datediff(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.DESCRIPTION
,r.DW_ASSET_ID
,r.EXPLOIT_AVAILABLE as EXPLOITAVAILABLE
,r.FAMILY_ID
,r.FAMILY_NAME
,r.FAMILY_TYPE
,r.FIRST_SEEN as FIRSTSEEN
,r.FISMASEVERITY
,r.HAS_BEEN_MITIGATED
,r.LAST_SEEN as LASTFOUND
,r.MITIGATIONSTATUS
,r.NESSUS_VERSION
,r.NUMERIC_SEVERITY
,r.PATCHPUB_DATE
,r.PLUGIN_ID
,r.PLUGIN_INFO
,r.PLUGIN_MOD_DATE
,r.PLUGIN_NAME
,r.PLUGIN_PUB_DATE
,r.PORT
,r.REPOSITORY_ID
,r.REPOSITORY_NAME
,r.SCAN_POLICY_NAME
,r.SCAN_POLICY_UID
,r.SCAN_START_DATE
,r.SOLUTION
,r.SYNOPSIS
,r.TENABLEUUID
,r.VERSION
,r.VULN_PUB_DATE
from RAW_TENABLE_VUL r
JOIN TEMP_ACTIONABLE_VUL t on t.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID -- 240121 replace where clause since exact record already known
-- 240121 where r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.APPLICABILITYCODE = :ApplicabilityCode_Actionable and r.DW_ASSET_ID IS NOT NULL

) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.PLUGIN_ID = target.PLUGIN_ID)

WHEN MATCHED THEN UPDATE SET 
-- Never change DW_ASSET_ID or PLUGIN_ID
target.CREDENTIALED_SCAN = src.CREDENTIALED_SCAN
,target.CVE = src.CVE
,target.CVSSV2BASESCORE = src.CVSSV2BASESCORE
,target.CVSSV3BASESCORE = src.CVSSV3BASESCORE
,target.DATEDELETED = NULL
,target.DATEMITIGATED = NULL
,target.DATEMODIFIED = CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
,target.DATEREOPENED = CURRENT_TIMESTAMP()
,target.DAYSSINCEDISCOVERY = src.DAYSSINCEDISCOVERY
,target.DELETIONREASON = NULL
,target.DESCRIPTION = src.DESCRIPTION
--,target.DW_ASSET_ID
,target.EXPLOITAVAILABLE = src.EXPLOITAVAILABLE
,target.FAMILY_ID = src.FAMILY_ID
,target.FAMILY_NAME = src.FAMILY_NAME
,target.FAMILY_TYPE = src.FAMILY_TYPE
--,target.FIRSTSEEN
,target.FISMASEVERITY = src.FISMASEVERITY
,target.HAS_BEEN_MITIGATED = src.HAS_BEEN_MITIGATED
--,CURRENT_TIMESTAMP() -- INSERT_DATE
--,target.IS_FROM_AWS_FEED
,target.LASTFOUND = src.LASTFOUND
,target.MITIGATIONSTATUS = src.MITIGATIONSTATUS
,target.NESSUS_VERSION = src.NESSUS_VERSION
,target.NUMERIC_SEVERITY = src.NUMERIC_SEVERITY
,target.PATCHPUB_DATE = src.PATCHPUB_DATE
--,target.PLUGIN_ID
,target.PLUGIN_INFO = src.PLUGIN_INFO
,target.PLUGIN_MOD_DATE = src.PLUGIN_MOD_DATE
,target.PLUGIN_NAME = src.PLUGIN_NAME
,target.PLUGIN_PUB_DATE = src.PLUGIN_PUB_DATE
,target.PORT = src.PORT
,target.REPOSITORY_ID = src.REPOSITORY_ID
,target.REPOSITORY_NAME = src.REPOSITORY_NAME
,target.SCAN_POLICY_NAME = src.SCAN_POLICY_NAME
,target.SCAN_POLICY_UID = src.SCAN_POLICY_UID
,target.SCAN_START_DATE = src.SCAN_START_DATE
,target.SNAPSHOT_ID = :P_SNAPSHOT_ID
,target.SOLUTION = src.SOLUTION
,target.SYNOPSIS = src.SYNOPSIS
,target.TENABLEUUID = src.TENABLEUUID
,target.VERSION = src.VERSION
,target.VULN_PUB_DATE = src.VULN_PUB_DATE

WHEN NOT MATCHED THEN INSERT (
CREDENTIALED_SCAN
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,DATEDELETED
,DATEMITIGATED
,DATEMODIFIED
,DATEREOPENED
,DAYSSINCEDISCOVERY
,DELETIONREASON
,DESCRIPTION
,DW_ASSET_ID
,EXPLOITAVAILABLE
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRSTSEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,INSERT_DATE
,IS_FROM_AWS_FEED
,LASTFOUND
,MITIGATIONSTATUS
,NESSUS_VERSION
,NUMERIC_SEVERITY
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PORT
,REPOSITORY_ID
,REPOSITORY_NAME
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SNAPSHOT_ID
,SOLUTION
,SYNOPSIS
,TENABLEUUID
,VERSION
,VULN_PUB_DATE
)
VALUES (
src.CREDENTIALED_SCAN
,src.CVE
,src.CVSSV2BASESCORE
,src.CVSSV3BASESCORE
,NULL -- DATEDELETED
,NULL -- DATEMITIGATED
,CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
,NULL -- DATEREOPENED
,src.DAYSSINCEDISCOVERY -- DAYSSINCEDISCOVERY
,NULL -- DELETIONREASON
,src.DESCRIPTION
,src.DW_ASSET_ID
,src.EXPLOITAVAILABLE
,src.FAMILY_ID
,src.FAMILY_NAME
,src.FAMILY_TYPE
,src.FIRSTSEEN
,src.FISMASEVERITY
,src.HAS_BEEN_MITIGATED
,CURRENT_TIMESTAMP() -- INSERT_DATE
,:IS_FROM_AWS_FEED
,src.LASTFOUND
,src.MITIGATIONSTATUS
,src.NESSUS_VERSION
,src.NUMERIC_SEVERITY
,src.PATCHPUB_DATE
,src.PLUGIN_ID
,src.PLUGIN_INFO
,src.PLUGIN_MOD_DATE
,src.PLUGIN_NAME
,src.PLUGIN_PUB_DATE
,src.PORT
,src.REPOSITORY_ID
,src.REPOSITORY_NAME
,src.SCAN_POLICY_NAME
,src.SCAN_POLICY_UID
,src.SCAN_START_DATE
,:P_SNAPSHOT_ID
,src.SOLUTION
,src.SYNOPSIS
,src.TENABLEUUID
,src.VERSION
,src.VULN_PUB_DATE
);

Msg := ''Finished Merge'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

--
-- Now load the VULMASTER table which contains the CVEs related to each PluginID
-- E.g. PluginID can have one or more CVEs associated with it
--
CALL CORE.SP_CRM_LOAD_VULCVE_MASTER(:P_SNAPSHOT_ID);


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_MAINTENANCE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Perform maintenance steps on CYBER_RISK_MANAGEMENT database'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_MAINTENANCE'';
DataCategory varchar;
RECORD_COUNT number;
DaysToRetain_ALERTLOG number; -- 240114
DaysToRetain_MsgLog number;
DaysToRetain_RAW_HWAM number;
DaysToRetain_RAW_TENABLE_VUL number;
DaysToRetain_ASSETINTERFACE number;
DaysToRetain_BACKUP_Object number := 30;
OBJECTS_TO_DROP NUMBER;
OBJECTS_DROPPED NUMBER;
DROP_COMMAND VARCHAR;
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

DaysToRetain_ALERTLOG := (select PARMINT FROM CORE.Config where ParmName = ''DaysToRetain_ALERTLOG''); -- 240114
DaysToRetain_ASSETINTERFACE := (select PARMINT FROM CORE.Config where ParmName = ''DaysToRetain_ASSETINTERFACE''); -- 230922
DaysToRetain_MsgLog := (select PARMINT FROM CORE.Config where ParmName = ''DaysToRetain_MsgLog'');
DaysToRetain_RAW_HWAM := (select PARMINT FROM CORE.Config where ParmName = ''DaysToRetain_RAW_HWAM'');
DaysToRetain_RAW_TENABLE_VUL := (select PARMINT FROM CORE.Config where ParmName = ''DaysToRetain_RAW_TENABLE_VUL'');

IF (:DaysToRetain_ALERTLOG = 0 or :DaysToRetain_MsgLog = 0 or :DaysToRetain_RAW_HWAM = 0 or :DaysToRetain_RAW_TENABLE_VUL = 0 or :DaysToRetain_ASSETINTERFACE = 0) THEN
    Msg := ''WARNING: Config parameter not available'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    return Msg;
END IF;

BEGIN TRANSACTION; -- 240114
--
-- Age ALERTLOG
--
DELETE FROM CORE.ALERTLOG WHERE DATEDIFF(day,insert_date,current_date()) > :DaysToRetain_ALERTLOG;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ALERTLOG deleted (INSERT_DATE >'' || :DaysToRetain_ALERTLOG || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Age MSGLOG
--
DELETE FROM CORE.MSGLOG WHERE DATEDIFF(day,insert_date,current_date()) > :DaysToRetain_MsgLog;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''MSGLOG deleted (INSERT_DATE >'' || :DaysToRetain_MsgLog || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
-- 230918
-- Age RAW_HWAM
--
DELETE FROM CORE.RAW_HWAM WHERE DATEDIFF(day,insert_date,current_date()) > :DaysToRetain_RAW_HWAM;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''RAW_HWAM deleted (INSERT_DATE >'' || :DaysToRetain_RAW_HWAM || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
-- 230918
-- Age RAW_TENABLE_VUL
--
DELETE FROM CORE.RAW_TENABLE_VUL WHERE DATEDIFF(day,insert_date,current_date()) > :DaysToRetain_RAW_TENABLE_VUL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''RAW_TENABLE_VUL deleted (INSERT_DATE >'' || :DaysToRetain_RAW_TENABLE_VUL || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

-- 
-- 230922
-- Age ASSETINTERFACE tables
--
BEGIN TRANSACTION;
-- 230922
-- Age ASSETINTERFACE Tables
--
DELETE FROM ASSETINTERFACE_FQDN
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_FQDN ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_FQDN deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

DELETE FROM ASSETINTERFACE_HOSTNAME
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_HOSTNAME ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_HOSTNAME deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

DELETE FROM ASSETINTERFACE_IPV4
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_IPV4 ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_IPV4 deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

DELETE FROM ASSETINTERFACE_IPV6
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_IPV6 ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_IPV6 deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

DELETE FROM ASSETINTERFACE_MACADDRESS
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_MACADDRESS ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_MACADDRESS deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

DELETE FROM ASSETINTERFACE_NETBIOSNAME
WHERE ID IN (SELECT ai.ID 
    FROM CORE.ASSET a
    JOIN CORE.ASSETINTERFACE_NETBIOSNAME ai on ai.dw_asset_id = a.dw_asset_id
    where DATEDIFF(day, ai.LAST_CONFIRMED_TIME, a.LAST_CONFIRMED_TIME) > :DaysToRetain_ASSETINTERFACE);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ASSETINTERFACE_NETBIOSNAME deleted (LAST_CONFIRMED_TIME >'' || :DaysToRetain_ASSETINTERFACE || '')='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;


BEGIN TRANSACTION;
--
-- 240705 CR927
--
DELETE from VULMASTER 
where dw_asset_id in (SELECT distinct vm.DW_ASSET_ID FROM VULMASTER vm
    LEFT OUTER JOIN ASSET a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    where a.DW_ASSET_ID IS NULL);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER (with no associated Asset) deleted='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
--
-- 240705 CR927
--
DELETE from VULPLUGINS_MASTER 
where dw_asset_id in (SELECT distinct vm.DW_ASSET_ID FROM VULPLUGINS_MASTER vm
    LEFT OUTER JOIN ASSET a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    where a.DW_ASSET_ID IS NULL);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULPLUGINS_MASTER (with no associated Asset) deleted='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;


--
-- DROP BACKUP VIEWS
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.VIEWS 
    WHERE TABLE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and TABLE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object;

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN

    select TOP 1 ''DROP View '' || TABLE_SCHEMA || ''.'' || TABLE_NAME || '';'' into DROP_COMMAND
    from INFORMATION_SCHEMA.VIEWS 
    WHERE TABLE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and TABLE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object;

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;

--
-- DROP BACKUP PROCEDURES WITH ZERO ARGUMENTS
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.PROCEDURES 
    WHERE PROCEDURE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and PROCEDURE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE = ''()'';

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN

    select TOP 1 ''DROP Procedure '' || PROCEDURE_SCHEMA || ''.'' || PROCEDURE_NAME || ''();'' into DROP_COMMAND
    from INFORMATION_SCHEMA.PROCEDURES 
    WHERE PROCEDURE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and PROCEDURE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE = ''()'';

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;

--
-- DROP BACKUP PROCEDURES WITH ONE ARGUMENT
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.PROCEDURES 
    WHERE PROCEDURE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and PROCEDURE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 0;

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN
    select TOP 1 ''DROP Procedure '' || PROCEDURE_SCHEMA || ''.'' || PROCEDURE_NAME || ''('' || trim(split_part(ARGUMENT_SIGNATURE,'' '',2)) || '';'' into DROP_COMMAND
    from INFORMATION_SCHEMA.PROCEDURES 
    WHERE PROCEDURE_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and PROCEDURE_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 0;

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;

--
-- DROP BACKUP FUNCTIONS WITH ZERO ARGUMENTS
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE = ''()'';

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN

    select TOP 1 ''DROP Function '' || FUNCTION_SCHEMA || ''.'' || FUNCTION_NAME || ''();'' into DROP_COMMAND
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE = ''()'';

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;

--
-- DROP BACKUP FUNCTIONS WITH ONE ARGUMENT
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 0; 

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN
    select TOP 1 ''DROP Function '' || FUNCTION_SCHEMA || ''.'' || FUNCTION_NAME || ''('' || trim(split_part(ARGUMENT_SIGNATURE,'' '',2)) || '';'' into DROP_COMMAND
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 0;

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;

--
-- DROP BACKUP FUNCTIONS WITH TWO ARGUMENTS
--
select count(1) into OBJECTS_TO_DROP
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 1; 

OBJECTS_DROPPED := 0;

WHILE (:OBJECTS_DROPPED < :OBJECTS_TO_DROP) DO
	BEGIN
    select TOP 1 ''DROP Function '' || FUNCTION_SCHEMA || ''.'' || FUNCTION_NAME 
        || ''('' || replace((split_part(trim(split_part(ARGUMENT_SIGNATURE,'','',1)),'' '',2) 
        || '','' || split_part(trim(split_part(ARGUMENT_SIGNATURE,'','',2)),'' '',2)),'')'','''') || '')''  || '';'' into DROP_COMMAND
    from INFORMATION_SCHEMA.FUNCTIONS 
    WHERE FUNCTION_CATALOG = ''BUS_CYBER_RISK_MANAGEMENT'' and FUNCTION_SCHEMA = ''BACKUP'' and datediff(d,LAST_ALTERED::DATE,current_date()) > :DaysToRetain_BACKUP_Object
    and ARGUMENT_SIGNATURE <> ''()''
    and regexp_count(ARGUMENT_SIGNATURE, '','', 1) = 1;

    execute immediate DROP_COMMAND;

    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:DROP_COMMAND);

    OBJECTS_DROPPED := OBJECTS_DROPPED + 1;
    END;
	END WHILE;
    
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_MATCH_EXISTING_ASSET_V3"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Attempt to match TEMP_HWAM data against ASSET/ASSETINTERFACE tables'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_MATCH_EXISTING_ASSET_V3'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
DATACATEGORY varchar;
RECORD_COUNT NUMBER;
REMAINING_RECORDS_TO_MATCH NUMBER;
MATCHMETHOD varchar;
LOOP_COUNTER NUMBER;
IS_FROM_AWS_FEED boolean;
IS_SEARCH_SYSTEM_ID boolean;
LOOP_TEXT VARCHAR;
IS_ENABLE_STEP_MSG boolean := 1;
MAG_VUL varchar := ''MAG VUL''; -- 241025 CR1012
MAG_VUL_MITIGATED varchar := ''MAG VUL MITIGATED''; -- 241025 CR1012

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || :DATACATEGORY || '')''; -- This helps to clarify which datastream we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/********************
BEGIN TRANSACTION;
UPDATE TEMP_HWAM
set DW_ASSET_ID = NULL
,MATCHMETHOD = NULL
,DATEMODIFIED = NULL
,MATCHORDER = NULL
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;
COMMIT;

Msg := ''WARNING: Initialized TEMP_HWAM while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
************************************************/


select count(1) INTO :RECORD_COUNT FROM TEMP_HWAM WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;
Msg := ''TEMP_HWAM to match='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;


BEGIN TRANSACTION; -- 241025 CR1015
BEGIN
-- Renju found that the FISMA ID (SYSTEM_ID) for AdMed-GSS had both upper and lower case
-- values of the SYSTEM_ID when the SYSTEMS (master) table has it as lower case. 
-- Research shows upper case values being provided from FORESCOUT and Tenable and is mostly likely due
-- to an incorrect tag placed on the asset. SDW is using the upper function to validate SYSTEM_ID (which passes) but 
-- incorrectly writes the upshifted SYSTEM_ID to the ASSET table.
-- This correction should be made in the Prep or Metadata procedures but is being done here to expedite the correction, 
--
UPDATE TEMP_HWAM upd
set SYSTEM_ID = ns.SYSTEM_ID -- unaltered case
FROM TEMP_HWAM th
LEFT OUTER JOIN SYSTEMS s on s.SYSTEM_ID = th.SYSTEM_ID
JOIN SYSTEMS ns on upper(ns.SYSTEM_ID) = upper(th.SYSTEM_ID)
WHERE th.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.TEMP_HWAM_ID = th.TEMP_HWAM_ID and s.SYSTEM_ID IS NULL;
END;
COMMIT;



---------------------------------------------------------------------------------------------
--
-- LOOP TWO TIMES
--
-- 240828 We no longer distinguish between active/inactive assets. (Is_Applicable = 1/0)
--
-- 1) Search for existing assets where SYSTEM_ID matches
-- 2) Search for existing assets where SYSTEM_ID is ignored
--
---------------------------------------------------------------------------------------------


FOR LOOP_COUNTER IN 1 TO 2 DO

If (:LOOP_COUNTER = 1) THEN
    BEGIN
    IS_SEARCH_SYSTEM_ID := 1;
    LOOP_TEXT := ''SYSTEM_ID,'';
    END;
Else
    BEGIN
    IS_SEARCH_SYSTEM_ID := 0;
    LOOP_TEXT := ''(Ignore SYSTEM_ID)'';
    END;
End if;

If (:IS_FROM_AWS_FEED = 1 or (:DATACATEGORY in (:MAG_VUL,:MAG_VUL_MITIGATED))) THEN
    BEGIN
    BEGIN TRANSACTION;
    If (:IS_FROM_AWS_FEED = 1) THEN
        BEGIN
        MATCHMETHOD := ''(AWS)'' || ''DATACENTER_ID,ASSET_ID_TATTOO'';
        END;
    ELSEIF (:DATACATEGORY in (:MAG_VUL,:MAG_VUL_MITIGATED)) THEN
        BEGIN
        MATCHMETHOD := ''(MAG)'' || ''DATACENTER_ID,ASSET_ID_TATTOO'';
        END;
    End if;
 

    --
    -- DATACENTER_ID/ASSET_ID_TATTOO matching is a special (favorable) case especially in the AWS environment 
    -- where an InstanceID (ASSET_ID_TATTOO) is always available.
    --
    -- The Asset (MDR) table should only have one distinct row with DATACENTER_ID/ASSET_ID_TATTOO
    -- whether or not IS_APPLICABLE flag is true.
    --
    UPDATE TEMP_HWAM upd
    set DW_ASSET_ID = src.DW_ASSET_ID
    ,MATCHMETHOD = :MATCHMETHOD
    ,DATEMODIFIED = current_timestamp()
    ,MATCHORDER = (:LOOP_COUNTER * 100) + 5
    FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        JOIN ASSET a on a.DATACENTER_ID = th.DATACENTER_ID and a.ASSET_ID_TATTOO = th.ASSET_ID_TATTOO
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.ASSET_ID_TATTOO,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
    WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;
   

    Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
    If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

    --
    -- Exit loop. Any remaining TEMP_HWAM will be created as new assets at a later step
    --
    BREAK; -- Exit the loop.
    END;
END IF;

select COUNT(1) INTO :REMAINING_RECORDS_TO_MATCH FROM TEMP_HWAM WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_ASSET_ID IS NULL;
If (:REMAINING_RECORDS_TO_MATCH = 0) THEN
    BEGIN
    --
    -- All TEMP_HWAM rows have been assigned a DW_ASSET_ID
    --
    Msg := ''All TEMP_HWAM rows have been assigned a DW_ASSET_ID'';
    If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;
    BREAK; -- Exit the loop. No more matching needed. This will probably be rare.
    END;
END IF;

Msg := ''LOOP_COUNTER='' || :LOOP_COUNTER::varchar || '', LOOP_TEXT='' || :LOOP_TEXT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,FQDN,HOSTNAME,NETBIOSNAME,MOTHERBOARD,IPV4'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 20
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        join table(flatten(IPV4,outer=>true)) as fi4
        JOIN ASSETINTERFACE_FQDN fqdn on fqdn.NORMALIZED_FQDN = th.NORMALIZED_FQDN
        JOIN ASSET a on a.DW_ASSET_ID = fqdn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
            and a.MOTHERBOARD = th.MOTHERBOARD
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.DW_ASSET_ID = a.DW_ASSET_ID and hn.NORMALIZED_HOSTNAME = fh.value::string
        JOIN ASSETINTERFACE_NETBIOSNAME nbn on nbn.DW_ASSET_ID = a.DW_ASSET_ID and nbn.NORMALIZED_NETBIOSNAME = th.NORMALIZED_NETBIOSNAME
        JOIN ASSETINTERFACE_IPV4 ip4 on ip4.DW_ASSET_ID = a.DW_ASSET_ID and ip4.IPV4 = fi4.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_FQDN,'''') IS NOT NULL 
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NOT NULL
        and NULLIF(th.MOTHERBOARD,'''') IS NOT NULL
        and NULLIF(fi4.value::string,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,FQDN,HOSTNAME,NETBIOSNAME,IPV4'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 23
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        join table(flatten(IPV4,outer=>true)) as fi4
        JOIN ASSETINTERFACE_FQDN fqdn on fqdn.NORMALIZED_FQDN = th.NORMALIZED_FQDN
        JOIN ASSET a on a.DW_ASSET_ID = fqdn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.DW_ASSET_ID = a.DW_ASSET_ID and hn.NORMALIZED_HOSTNAME = fh.value::string
        JOIN ASSETINTERFACE_NETBIOSNAME nbn on nbn.DW_ASSET_ID = a.DW_ASSET_ID and nbn.NORMALIZED_NETBIOSNAME = th.NORMALIZED_NETBIOSNAME
        JOIN ASSETINTERFACE_IPV4 ip4 on ip4.DW_ASSET_ID = a.DW_ASSET_ID and ip4.IPV4 = fi4.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_FQDN,'''') IS NOT NULL 
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NOT NULL
        and NULLIF(fi4.value::string,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;


BEGIN TRANSACTION; -- 280828 CR-TBD New search
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,FQDN,HOSTNAME,NETBIOSNAME'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 24
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        JOIN ASSETINTERFACE_FQDN fqdn on fqdn.NORMALIZED_FQDN = th.NORMALIZED_FQDN
        JOIN ASSET a on a.DW_ASSET_ID = fqdn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.DW_ASSET_ID = a.DW_ASSET_ID and hn.NORMALIZED_HOSTNAME = fh.value::string
        JOIN ASSETINTERFACE_NETBIOSNAME nbn on nbn.DW_ASSET_ID = a.DW_ASSET_ID and nbn.NORMALIZED_NETBIOSNAME = th.NORMALIZED_NETBIOSNAME
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_FQDN,'''') IS NOT NULL 
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;


BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,FQDN,HOSTNAME,IPV4'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 30
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        join table(flatten(IPV4,outer=>true)) as fi4
        JOIN ASSETINTERFACE_FQDN fqdn on fqdn.NORMALIZED_FQDN = th.NORMALIZED_FQDN
        JOIN ASSET a on a.DW_ASSET_ID = fqdn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.DW_ASSET_ID = a.DW_ASSET_ID and hn.NORMALIZED_HOSTNAME = fh.value::string
        JOIN ASSETINTERFACE_IPV4 ip4 on ip4.DW_ASSET_ID = a.DW_ASSET_ID and ip4.IPV4 = fi4.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_FQDN,'''') IS NOT NULL 
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NULL
        and NULLIF(fi4.value::string,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;


BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,HOSTNAME,IPV4'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 40
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        join table(flatten(IPV4,outer=>true)) as fi4
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.NORMALIZED_HOSTNAME = fh.value::string
        JOIN ASSET a on a.DW_ASSET_ID = hn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_IPV4 ip4 on ip4.DW_ASSET_ID = a.DW_ASSET_ID and ip4.IPV4 = fi4.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(fi4.value::string,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,NETBIOSNAME,IPV4'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 50
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(IPV4,outer=>true)) as fi4
        JOIN ASSETINTERFACE_NETBIOSNAME nbn on nbn.NORMALIZED_NETBIOSNAME = th.NORMALIZED_NETBIOSNAME
        JOIN ASSET a on a.DW_ASSET_ID = nbn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_IPV4 ip4 on ip4.DW_ASSET_ID = a.DW_ASSET_ID and ip4.IPV4 = fi4.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NOT NULL
        and NULLIF(fi4.value::string,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

BEGIN TRANSACTION;
MATCHMETHOD := :LOOP_TEXT || ''DATACENTER_ID,FQDN,HOSTNAME'';

UPDATE TEMP_HWAM upd
set DW_ASSET_ID = src.DW_ASSET_ID
,MATCHMETHOD = :MATCHMETHOD
,DATEMODIFIED = current_timestamp()
,MATCHORDER = (:LOOP_COUNTER * 100) + 60
FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        join table(flatten(NORMALIZED_HOSTNAME,outer=>true)) as fh
        JOIN ASSETINTERFACE_FQDN fqdn on fqdn.NORMALIZED_FQDN = th.NORMALIZED_FQDN
        JOIN ASSET a on a.DW_ASSET_ID = fqdn.DW_ASSET_ID and a.DATACENTER_ID = th.DATACENTER_ID 
            and (:IS_SEARCH_SYSTEM_ID = 0 or (:IS_SEARCH_SYSTEM_ID = 1 and a.SYSTEM_ID = th.SYSTEM_ID))
        JOIN ASSETINTERFACE_HOSTNAME hn on hn.DW_ASSET_ID = a.DW_ASSET_ID and hn.NORMALIZED_HOSTNAME = fh.value::string
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.NORMALIZED_FQDN,'''') IS NOT NULL
        and NULLIF(fh.value::string,'''') IS NOT NULL
        and NULLIF(th.NORMALIZED_NETBIOSNAME,'''') IS NULL
        GROUP BY th.TEMP_HWAM_ID) src
WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
RECORD_COUNT := SQLROWCOUNT;
COMMIT;

Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;

END FOR OUTERLOOP; -- END OF LOOP


If (:IS_FROM_AWS_FEED = 0) THEN
    BEGIN
    BEGIN TRANSACTION;
    MATCHMETHOD := ''DATACENTER_ID,ASSET_ID_TATTOO'';
    --
    -- 240823 DATACENTER_ID/ASSET_ID_TATTOO matching is a special (favorable) case.
    -- The Asset (MDR) table should only have one distinct row with DATACENTER_ID/ASSET_ID_TATTOO
    -- whether or not IS_APPLICABLE flag is true
    --
    UPDATE TEMP_HWAM upd
    set DW_ASSET_ID = src.DW_ASSET_ID
    ,MATCHMETHOD = :MATCHMETHOD
    ,DATEMODIFIED = current_timestamp()
    ,MATCHORDER = 300 -- We are outside the loop
    FROM (select MIN(a.DW_ASSET_ID) as DW_ASSET_ID,th.TEMP_HWAM_ID
        FROM TEMP_HWAM th
        JOIN ASSET a on a.DATACENTER_ID = th.DATACENTER_ID and a.ASSET_ID_TATTOO = th.ASSET_ID_TATTOO
        WHERE th.DW_ASSET_ID IS NULL
        and th.SNAPSHOT_ID = :P_SNAPSHOT_ID
        and NULLIF(th.ASSET_ID_TATTOO,'''') IS NOT NULL
        GROUP BY th.TEMP_HWAM_ID) src
    WHERE upd.DW_ASSET_ID IS NULL and upd.TEMP_HWAM_ID = src.TEMP_HWAM_ID;
    RECORD_COUNT := SQLROWCOUNT;
    COMMIT;

    Msg := ''MATCHMETHOD:'' || :MATCHMETHOD || ''='' || :RECORD_COUNT;
    If (:IS_ENABLE_STEP_MSG = 1) THEN CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); End if;
    END;
END IF;

select count(1) into :RECORD_COUNT FROM TEMP_HWAM where SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_ASSET_ID IS NULL;
Msg := ''Unmatched records (To be created as new assets)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_NORMALIZE_ASSET_IDENTIFIERS"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Normalize asset identifiable columns in Raw data table. These are used in the asset matching process'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_NORMALIZE_ASSET_IDENTIFIERS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
PARENT_DATACATEGORY varchar;
DATACATEGORY varchar;
HWAM varchar := ''HWAM'';
VUL varchar := ''VUL'';
RECORD_COUNT number;

BEGIN
select DATACATEGORY,PARENT_DATACATEGORY into :DATACATEGORY,:PARENT_DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which snapshot we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;
--
-- 240606 CR903 first introduced normalization into SP_CRM_LOAD_ASSET_V2
--
-- NORMALIZE certain fields to be used in asset matching.
-- ASSET_ID_TATTOO found differences in case depending on the sensor
-- FQDN is almost always a single value so an array is not needed. I found 5 cases over 90 days where there was more than one value but they were bogus
-- HOSTNAME needs to be an array. Had to flatten HOSTNAME in order to do split_part then re-create array.
-- NETBIOSNAME is almost always a single value so an array is not needed. I found 1 case over 90 days where there was more than one value but it was bogus
-- MACADDRESS needs to be an array
--
-- Also note: When testing this sql in a separate worksheet remove one of the back-slashes between the double-dollars
--
IF (:PARENT_DATACATEGORY = :HWAM) THEN
    BEGIN
    UPDATE RAW_HWAM upd
    set NORMALIZED_ASSET_ID_TATTOO = UPPER(th.ASSET_ID_TATTOO)
    ,NORMALIZED_FQDN = UPPER(NULLIF(GET(th.FQDN,0)::varchar,''''))
    ,NORMALIZED_HOSTNAME = n.NORMALIZED_HOSTNAME
    ,NORMALIZED_NETBIOSNAME = UPPER(coalesce(NULLIF(split_part(GET(th.NETBIOSNAME,0)::varchar,$$\\$$,2),''''),GET(th.NETBIOSNAME,0)::varchar)) -- Use double-dollars to avoid back-slash escape
    ,NORMALIZED_MACADDRESS = STRTOK_TO_ARRAY(UPPER(REPLACE(REPLACE(ARRAY_TO_STRING(th.MACADDRESS,''$''),'':'',''''),''-'','''')),'','') 
    ,NORMALIZED_MOTHERBOARD = UPPER(th.MOTHERBOARD)
    FROM (SELECT r.RAW_HWAM_ID,ARRAY_AGG(NULLIF(REPLACE(UPPER(coalesce(split_part(f.value::string,''.'',1),split_part(GET(r.fqdn,0),''.'',1))),''*'',''''),'''')) as NORMALIZED_HOSTNAME
        FROM RAW_HWAM r
        join table(flatten(HOSTNAME,outer=>true)) as f
        where r.SNAPSHOT_ID = :P_SNAPSHOT_ID
        GROUP BY r.RAW_HWAM_ID) n
    JOIN RAW_HWAM th on th.RAW_HWAM_ID = n.RAW_HWAM_ID
    WHERE upd.RAW_HWAM_ID = th.RAW_HWAM_ID;
    END;
ELSE
    BEGIN
    UPDATE RAW_TENABLE_VUL upd
    set NORMALIZED_ASSET_ID_TATTOO = UPPER(th.ASSET_ID_TATTOO)
    ,NORMALIZED_FQDN = UPPER(th.DNSNAME)
    ,NORMALIZED_HOSTNAME = STRTOK_TO_ARRAY(UPPER(th.HOSTNAME),'','')
    ,NORMALIZED_NETBIOSNAME = UPPER(th.NETBIOSNAME)
    ,NORMALIZED_MACADDRESS = STRTOK_TO_ARRAY(UPPER(REPLACE(REPLACE(th.MACADDRESS,'':'',''''),''-'','''')),'','')
    ,NORMALIZED_MOTHERBOARD = NULL -- Motherboard is not in RAW_TENABLE_VUL
    FROM RAW_TENABLE_VUL th
    WHERE th.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.RAW_TENABLE_VUL_ID = th.RAW_TENABLE_VUL_ID;
    END;
END IF;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PREP_RAW_HWAM_V2"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Prep/Validate RAW_HWAM data'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PREP_RAW_HWAM_V2'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
False boolean := 0;
True boolean := 1;
AXONIUS varchar := ''AXONIUS'';
FORESCOUT varchar := ''FORESCOUT''; -- 241209 CR1048
RECORD_COUNT NUMBER;
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;
SNAPSHOT_ID NUMBER;
DATACATEGORY VARCHAR;

--
-- As of 9/22/2023 Axonius has the following adapters
-- 1.	active_directory_adapter
-- 2.	aws_adapter
-- 3.	bigfix_adapter
-- 4.	bigfix_inventory_adapter
-- 5.	counter_act_adapter
-- 6.	crowd_strike_adapter
-- 7.	epo_adapter
-- 8.	esx_adapter
-- 9.	mssql_adapter
-- 10.	sccm_adapter
-- 11.	splunk_adapter
-- 12.	tenable_security_center_adapter
--

BEGIN
SNAPSHOT_ID := :P_SNAPSHOT_ID;
select DATACATEGORY into :DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which HWAM we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--
-- 240730 CR942
-- Moved initialization of RAW_HWAM to respective PULL stored procedure so the fields are 
-- initialized upon write to RAW_HWAM
--

select count(1) into :TheRowCount FROM CORE.RAW_HWAM where SNAPSHOT_ID = :SNAPSHOT_ID and RowDisposition = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE();

IF (:TheRowCount = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

---------------------------------------------------------------------
--
-- DETERMINE/POPULATE: DATACENTER_ID, SYSTEM_ID, ASSET_ID_TATTOO
--
---------------------------------------------------------------------


-- Determine DATACENTER_ID
-- 230620 added NULLIF
-- 240726 CR928 UPDATE CORE.RAW_HWAM
-- 240726 CR928 set DATACENTER_ID = coalesce(NULLIF(AWS_DATACENTER_ID,''''),NULLIF(TENABLE_DATACENTER_ID,''''),NULLIF(BIGFIX_DATACENTER_ID,''''))
-- 240726 CR928 where SNAPSHOT_ID = :SNAPSHOT_ID and DATACENTER_ID IS NULL;

--
-- 240424 CR879 Integrate SecOps FISMA_UUID into SDW AWS HWAM datastream
--
UPDATE CORE.RAW_HWAM
set SYSTEM_ID = FISMA_UUID
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(FISMA_UUID,'''') IS NOT NULL and SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Assigned SYSTEM_ID using FISMA_UUID='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

-- Determine SYSTEM_ID
UPDATE CORE.RAW_HWAM
set SYSTEM_ID = coalesce(NULLIF(AWS_PRIMARY_FISMA_ID_TATTOO,''''),NULLIF(TENABLE_PRIMARY_FISMA_ID_TATTOO,''''),NULLIF(BIGFIX_PRIMARY_FISMA_ID_TATTOO,''''))
where SNAPSHOT_ID = :SNAPSHOT_ID and SYSTEM_ID IS NULL;

-- Assign SYSTEM_ID (if not already assigned) based on SYSTEM_ACRONYM (Should match official value found in SYSTEMS.ACRONYM)
UPDATE CORE.RAW_HWAM
set SYSTEM_ID = s.SYSTEM_ID
FROM CORE.RAW_HWAM r
JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
where r.RAW_HWAM_ID = CORE.RAW_HWAM.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ID IS NULL and r.SYSTEM_ACRONYM IS NOT NULL;

-- Assign SYSTEM_ID based on COMMONNAME (if SYSTEM_ID not already assigned)
-- THE COMMONNAME FIELD IS MANUALLY MAINTAINED AND IS NOT IN A SPECIFIC CFACTS FIELD.
-- WE WILL USE THIS TO IMPROVE SYSTEM REPORTING AND TO PROVIDE DATA QUALITY WARNINGS OF ITS USE UPSTREAM
UPDATE CORE.RAW_HWAM
set SYSTEM_ID = c.SYSTEM_ID
,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''Used COMMONNAME lookup to find SYSTEM_ACRONYM'')
FROM CORE.RAW_HWAM r
JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = CORE.RAW_HWAM.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ID IS NULL and r.SYSTEM_ACRONYM IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;

If (RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''Assigned SYSTEM_ID using COMMONNAME lookup='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

-- Determine ASSET_ID_TATTOO
UPDATE CORE.RAW_HWAM
set ASSET_ID_TATTOO = coalesce(AWS_INSTANCE_ID,BIGFIX_ASSET_ID_TATTOO,TENABLE_ASSET_ID_TATTOO)
where SNAPSHOT_ID = :SNAPSHOT_ID and ASSET_ID_TATTOO IS NULL;

---------------------------------------------------------------------
--
-- CLEAN: DATACENTER_ID, SYSTEM_ID, ASSET_ID_TATTOO
--
---------------------------------------------------------------------

-- Clean DATACENTER_ID
UPDATE CORE.RAW_HWAM h
set DATACENTER_ID = TRIM(REPLACE(REPLACE(REPLACE(DATACENTER_ID,''"'',''''),''['',''''),'']'',''''))
where SNAPSHOT_ID = :SNAPSHOT_ID
and DATACENTER_ID IS NOT NULL and (DATACENTER_ID LIKE ''%"%'' or DATACENTER_ID LIKE ''%[%'' or DATACENTER_ID LIKE ''%]%'');

-- Clean SYSTEM_ID
UPDATE CORE.RAW_HWAM h
set SYSTEM_ID = TRIM(REPLACE(REPLACE(REPLACE(SYSTEM_ID,''"'',''''),''['',''''),'']'',''''))
where SNAPSHOT_ID = :SNAPSHOT_ID
and SYSTEM_ID IS NOT NULL and (SYSTEM_ID LIKE ''%"%'' or SYSTEM_ID LIKE ''%[%'' or SYSTEM_ID LIKE ''%]%'');

-- Clean ASSET_ID_TATTOO
UPDATE CORE.RAW_HWAM h
set ASSET_ID_TATTOO = TRIM(REPLACE(REPLACE(REPLACE(ASSET_ID_TATTOO,''"'',''''),''['',''''),'']'',''''))
where SNAPSHOT_ID = :SNAPSHOT_ID
and ASSET_ID_TATTOO IS NOT NULL and (ASSET_ID_TATTOO LIKE ''%"%'' or ASSET_ID_TATTOO LIKE ''%[%'' or ASSET_ID_TATTOO LIKE ''%]%'');

  
---------------------------------------------------------------------
--
-- VALIDATE: DATACENTER_ID, SYSTEM_ID, ASSET_ID_TATTOO
--
---------------------------------------------------------------------

-- DATACENTER_ID invalid format or length
UPDATE CORE.RAW_HWAM h
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''DATACENTER_ID has invalid format or length'')
where SNAPSHOT_ID = :SNAPSHOT_ID and DATACENTER_ID IS NOT NULL and (DATACENTER_ID LIKE ''%,%'' or LEN(DATACENTER_ID) > 36);

--
-- When a duplicate datacenter/asset_id_tattoo is found then flag record as an error.
-- This case first discovered with AWS accounts 368332260651 and 568826666399 which pertain to system BatCave
--
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''Duplicate datacenter/asset_id_tattoo combination'')
FROM CORE.RAW_HWAM r
JOIN (select t.asset_id_tattoo -- 230706 added this layer
    FROM (select datacenter_id, asset_id_tattoo
        FROM CORE.RAW_HWAM
        where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(asset_id_tattoo,'''') IS NOT NULL -- 230706 added asset_id_tattoo check
        group by datacenter_id, asset_id_tattoo
        having count(1) > 1) t
    group by t.asset_id_tattoo
    having count(1) > 1) dup on dup.asset_id_tattoo = r.asset_id_tattoo
where r.RAW_HWAM_ID = CORE.RAW_HWAM.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID;

-- DATACENTER_ID is Null or Empty
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

-- DATACENTER_ID does not exist
UPDATE CORE.RAW_HWAM upd
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM CORE.RAW_HWAM r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;

--
-- 240917 CR981
-- When DATACENTER_ID is HIGLAS but DATACATEGORY is not AXONIUS then reject the data
--
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''HIGLAS HWAM only permitted via AXONIUS'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') = ''C9B9A131-F974-49BD-BBFF-1B0235747C0E'' and :DATACATEGORY <> :AXONIUS;

-- Validate SYSTEM_ACRONYM as an FYI. For the present time we also check to see if the acronym is a CommonName (not found in CFACTS)
UPDATE CORE.RAW_HWAM upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ACRONYM does not exist'')
FROM CORE.RAW_HWAM r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ACRONYM IS NOT NULL and (s.SYSTEM_ID IS NULL and c.SYSTEM_ID IS NULL);

-- Check to see if BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS contains different FISMA_IDs
-- Note: Only distinct values are in BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS at this point
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''BIGFIX_PRIMARY_FISMA_ID_TATTOO contains '' 
    || ARRAY_SIZE(BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS)::varchar || '' different values'')
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_SIZE(BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS) > 1;

-- Validate SYSTEM_ID
UPDATE CORE.RAW_HWAM upd
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''Invalid PRIMARY_FISMA_ID'')
FROM CORE.RAW_HWAM r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.system_id) = upper(r.SYSTEM_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ID IS NOT NULL and s.SYSTEM_ID IS NULL;


-- Validate DRaaS-CACHE. We expect all DRaaS assets to have the tenant tag format except for non-tattooable assets like network devices
-- 240912 CR978
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Invalid DRaaS-CACHE ASSET_ID_TAG'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and DATACENTER_ID = ''441a2d4fdbfbab00560cf9531f961911''
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(ASSET_ID_TAG) = 0;

-- 240912 CR978
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''DRaaS-CACHE ASSET_ID_TAG is empty'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and DATACENTER_ID = ''441a2d4fdbfbab00560cf9531f961911''
and ASSET_ID_TAG IS NULL;

-- 230728
--
-- Of the available (not null) DATACENTER_IDs are they all the same regardless of sensor.
-- 
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''DATACENTER_ID differs across sensors'')
where SNAPSHOT_ID = :SNAPSHOT_ID 
and ARRAY_SIZE(ARRAY_DISTINCT(ARRAY_COMPACT(ARRAY_CONSTRUCT(lower(NULLIF(AWS_DATACENTER_ID,'''')),lower(NULLIF(TENABLE_DATACENTER_ID,''''))
,lower(NULLIF(BIGFIX_DATACENTER_ID,'''')))))) > 1;

--
-- Of the available (not null) FISMA IDs are they all the same regardless of sensor.
-- Found cases where Forescout (derived FISMA ID) and Tenable (FISMA ID is tattooed on asset) have different FISMA IDs
-- 230620 1345 added NULLIF
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''FISMA_ID differs across sensors'')
where SNAPSHOT_ID = :SNAPSHOT_ID 
and ARRAY_SIZE(ARRAY_DISTINCT(ARRAY_COMPACT(ARRAY_CONSTRUCT(lower(NULLIF(AWS_PRIMARY_FISMA_ID_TATTOO,'''')),lower(NULLIF(TENABLE_PRIMARY_FISMA_ID_TATTOO,''''))
,lower(NULLIF(BIGFIX_PRIMARY_FISMA_ID_TATTOO,'''')))))) > 1;

UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Invalid ASSET_ID_TATTOO'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL -- 240917 CR-EBF added NULLIF
and CORE.FN_CRM_IS_VALID_ASSET_ID_TATTOO(ASSET_ID_TATTOO) = FALSE;

-- 230728
--
-- Of the available (not null) ASSET_ID_TATTOOs are they all the same regardless of sensor.
-- 
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''ASSET_ID_TATTOO differs across sensors'')
where SNAPSHOT_ID = :SNAPSHOT_ID 
and ARRAY_SIZE(ARRAY_DISTINCT(ARRAY_COMPACT(ARRAY_CONSTRUCT(lower(NULLIF(AWS_INSTANCE_ID,'''')),lower(NULLIF(TENABLE_ASSET_ID_TATTOO,''''))
,lower(NULLIF(BIGFIX_ASSET_ID_TATTOO,'''')))))) > 1;



If (:DATACATEGORY = :FORESCOUT) THEN -- 241209 CR1048
    BEGIN
    UPDATE CORE.RAW_HWAM
    set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
    ,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Forescout has Windows AND Linux asset ID populated'')
    where SNAPSHOT_ID = :SNAPSHOT_ID 
    and NULLIF(FS_ASSET_ID_TAG_WINDOWSINST,'''') IS NOT NULL and NULLIF(FS_LINUX_ASSET_ID,'''') IS NOT NULL;   
    END;
END IF;



-- 230731
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''No IP available'')
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_SIZE(IPV4) = 0 AND ARRAY_SIZE(IPV6) = 0;

-- 230927
UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''(ASSET_ID_TATTOO/FQDN/HOSTNAME/NETBIOSNAME) are null'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and ASSET_ID_TATTOO IS NULL and FQDN IS NULL and HOSTNAME IS NULL and NETBIOSNAME IS NULL;

-- 231214 The AWS ACCOUNTID should/must always be in the SEC_VW_FISMA_LOOKUPS
UPDATE CORE.RAW_HWAM upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''AWS ACCOUNTID is not in SEC_VW_FISMA_LOOKUPS'')
FROM CORE.RAW_HWAM r
left outer join CORE.VW_AWS_CAMPDB_LOOKUP ref on ref.ACCOUNT_NUMBER = r.AWS_ACCOUNTID -- 240710 CR928
-- 240710 CR928 left outer join REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS ref on ref.ACCOUNT_NUMBER = r.AWS_ACCOUNTID
WHERE r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.AWS_ACCOUNTID IS NOT NULL and ref.ACCOUNT_NUMBER IS NULL;

-- 240726 CR928 changed from warning to error
UPDATE CORE.RAW_HWAM upd
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''SEC_VW_FISMA_LOOKUPS contains invalid FISMA ID('' || coalesce(NULLIF(ref.SYSTEM_ID,''''),''NULL'') || '')'') -- 240710 CR928
FROM CORE.RAW_HWAM r
join CORE.VW_AWS_CAMPDB_LOOKUP ref on ref.ACCOUNT_NUMBER = r.AWS_ACCOUNTID -- 240710 CR928
left outer join CORE.SYSTEMS s on upper(s.SYSTEM_ID) = upper(ref.SYSTEM_ID) -- 240710 CR928
WHERE r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.AWS_ACCOUNTID IS NOT NULL and s.SYSTEM_ID IS NULL;

-- 240728 CR928
UPDATE CORE.RAW_HWAM upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''New DEVICETYPE found ('' || r.DEVICE_TYPE || '')'')
FROM CORE.RAW_HWAM r
left outer join CORE.DEVICETYPES dt on dt.DEVICETYPE = r.DEVICE_TYPE
WHERE r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DEVICE_TYPE,'''') IS NOT NULL and dt.DEVICETYPE IS NULL;

-- 230627
-- SYSTEM_ID could not be assigned using system ID related data contained within the RAW_HWAM record.
-- See if MDR(Asset) record already exists and use its SYSTEM_ID
UPDATE CORE.RAW_HWAM upd
set SYSTEM_ID = a.SYSTEM_ID
,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ID obtained from ASSET table based on ASSET_ID_TATTOO'')
FROM CORE.RAW_HWAM r
JOIN CORE.ASSET a on a.DATACENTER_ID = r.DATACENTER_ID and a.ASSET_ID_TATTOO = r.ASSET_ID_TATTOO
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''SYSTEM_ID from ASSET table used='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

--
-- When no SYSTEM_ID is available default it to the DATACENTER_ID
--
UPDATE CORE.RAW_HWAM upd
set SYSTEM_ID = r.DATACENTER_ID
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :True
,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ID defaulted to DATACENTER_ID'')
FROM CORE.RAW_HWAM r
JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = r.DATACENTER_ID
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''SYSTEM_ID defaulted to DATACENTER_ID='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

UPDATE CORE.RAW_HWAM
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''SYSTEM_ID could not be assigned'')
where SNAPSHOT_ID = :SNAPSHOT_ID and SYSTEM_ID IS NULL and ARRAY_SIZE(DATA_ERROR_ARRAY) = 0; -- 240727 CR928 added ARRAY_SIZE check

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''RESEARCH WHY SYSTEM_ID NOT ASSIGNED DESPITE NO ERRORS='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

-- TENABLE_ASSET_TAGS does not have (version Asset_ID)
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''TENABLE_ASSET_TAGS does not have (version Asset_ID)'')
where SNAPSHOT_ID = :SNAPSHOT_ID and TENABLE_ASSET_TAGS IS NOT NULL and TENABLE_ASSET_ID_TATTOO IS NULL;

-- TENABLE_ASSET_TAGS does not have (version Primary_FISMA_ID
UPDATE CORE.RAW_HWAM
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''TENABLE_ASSET_TAGS does not have (version Primary_FISMA_ID)'')
where SNAPSHOT_ID = :SNAPSHOT_ID and TENABLE_ASSET_TAGS IS NOT NULL and TENABLE_PRIMARY_FISMA_ID_TATTOO IS NULL;

--
-- UPDATE SNAPSHOT_IDS with Error and Warning counts
--
select SUM(ARRAY_SIZE(DATA_ERROR_ARRAY)),SUM(ARRAY_SIZE(DATA_WARNING_ARRAY)) into :ERROR_COUNT,:WARNING_COUNT FROM CORE.RAW_HWAM where SNAPSHOT_ID = :SNAPSHOT_ID;
select count(1) into :RECORDS_WITH_ERRORS FROM CORE.RAW_HWAM where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_SIZE(DATA_ERROR_ARRAY) > 0;
select count(1) into :RECORDS_WITH_WARNINGS FROM CORE.RAW_HWAM where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_SIZE(DATA_WARNING_ARRAY) > 0;

UPDATE SNAPSHOT_IDS
set ERROR_COUNT = :ERROR_COUNT
,RECORDS_WITH_ERRORS = :RECORDS_WITH_ERRORS
,RECORDS_WITH_WARNINGS = :RECORDS_WITH_WARNINGS
,WARNING_COUNT = :WARNING_COUNT
WHERE SNAPSHOT_ID = :SNAPSHOT_ID;


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PREP_RAW_TENABLE_VUL_V3"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Prep/Validate RAW_TENABLE_VUL data'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PREP_RAW_TENABLE_VUL_V3'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
AWS_VUL varchar := ''AWS VUL'';
CCIC_VUL varchar := ''CCIC VUL'';
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED''; -- 240118
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED''; -- 240118
MAG_VUL varchar := ''MAG VUL''; -- 241023 CR1012
MAG_VUL_MITIGATED varchar := ''MAG VUL MITIGATED''; -- 241023 CR1012
RECORD_COUNT NUMBER;
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--
-- 240710 CR928 
-- Moved initialization of RAW_TENABLE_VUL to respective PULL stored procedure so the fields are 
-- initialized upon write to RAW_TENABLE_VUL
--

select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and RowDisposition = CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE();

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

--
-- INSERT MOST CURRENT TENABLE REPOSITORY HISTORY
--
INSERT INTO CORE.TENABLE_REPOSITORYHIST (
	DATACENTER_ID,
	INSERT_DATE,
    IS_FROM_AWS_FEED,
	LAST_SEEN,
    RAW_TENABLE_VUL_COUNT,
    REPOSITORY_ID,
	REPOSITORY_NAME
)
select repo.DATACENTER_ID,repo.Max_INSERT_DATE,:IS_FROM_AWS_FEED,repo.Max_LAST_SEEN,repo.RAW_TENABLE_VUL_COUNT,repo.REPOSITORY_ID,repo.REPOSITORY_NAME
FROM (select 
    dc.SYSTEM_ID as DATACENTER_ID
    ,MAX(r.INSERT_DATE) as Max_INSERT_DATE
    ,MAX(r.LAST_SEEN) as Max_LAST_SEEN
    ,r.REPOSITORY_ID
    ,r.REPOSITORY_NAME
    ,count(1) RAW_TENABLE_VUL_COUNT
    from RAW_TENABLE_VUL r
    JOIN CORE.SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(r.DATACENTER_ID)
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.REPOSITORY_ID IS NOT NULL
    GROUP BY dc.SYSTEM_ID,r.REPOSITORY_ID,r.REPOSITORY_NAME) repo
LEFT OUTER JOIN CORE.TENABLE_REPOSITORYHIST t on t.DATACENTER_ID = repo.DATACENTER_ID and t.REPOSITORY_ID = repo.REPOSITORY_ID and t.INSERT_DATE = repo.Max_INSERT_DATE
WHERE t.TENABLE_REPOSITORYHIST_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''TENABLE_REPOSITORYHIST inserted='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

--
-- Derive FISMASEVERITY and NUMERIC_SEVERITY
--
-- 240911 CR976 Emergency Break Fix
-- Case statement was using NUMERIC_SEVERITY to set FISMASEVERITY which incorrectly used the pre-existing record value of zero
--
-- 240712 CR928 was multiple queries
--
-- 231012 move from CVSSV2 to CVSSV3; CVSS3 score ranges from https://nvd.nist.gov/vuln-metrics/cvss
-- Under CVSSV2 then ranges were as follows
--  Critical 10.0
--  High BETWEEN 7.0 AND 9.9
--  Medium	BETWEEN 4.0 AND 6.9
--  Low  BETWEEN 0.1 AND 3.9
--
UPDATE CORE.RAW_TENABLE_VUL
set NUMERIC_SEVERITY = IFF(CVSSV3BASESCORE >= 9.0,4,IFF(CVSSV3BASESCORE >= 7.0,3,IFF(CVSSV3BASESCORE >= 4.0,2,IFF(CVSSV3BASESCORE >= 0.1,1,0))))
,FISMASEVERITY = case IFF(CVSSV3BASESCORE >= 9.0,4,IFF(CVSSV3BASESCORE >= 7.0,3,IFF(CVSSV3BASESCORE >= 4.0,2,IFF(CVSSV3BASESCORE >= 0.1,1,0))))
    when 4 then ''Critical''
    when 3 then ''High''
    when 2 then ''Medium''
    when 1 then ''Low''
    when 0 then ''Info'' -- 240909
    Else ''Unknown''
End
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;


If (:DATACATEGORY IN (:CCIC_VUL,:CCIC_VUL_MITIGATED)) THEN
    BEGIN
    BEGIN TRANSACTION; 
    --
    -- 240727 CR928
    -- Assign metadata already determined by SP_CRM_LINK_METADATA_V2
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set DATACENTER_ID = met.DATACENTER_ID
    ,SYSTEM_ID = met.SYSTEM_ID
    ,ASSET_ID_TATTOO = met.ASSET_ID_TATTOO
    ,CREDENTIALED_SCAN = met.IS_TENABLE_CREDENTIALED_SCAN::number
    ,ASSET_ID_TAG = met.ASSET_ID_TATTOO
    ,FISMA_ID_TAG = met.SYSTEM_ID
-- 240729 TEMPOARARY DISABLE UNTIL RESOLVED    ,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,met.DATA_ERROR_ARRAY) -- Inherit metadata errors
-- 240729 TEMPOARARY DISABLE UNTIL RESOLVED    ,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,met.DATA_WARNING_ARRAY) -- Inherit metadata warnings
    FROM CORE.RAW_TENABLE_VUL r
    JOIN TEMP_ASSET_METADATA met on met.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;

    RECORD_COUNT := SQLROWCOUNT;

    Msg := ''CCIC metadata assigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    END;
End If;

BEGIN TRANSACTION; -- 240814 move this code to this point. (Was above TEMP_ASSET_METADATA)
--
-- 240410 CR 867 Implement DRaaS multi-tenant tag
--
UPDATE CORE.RAW_TENABLE_VUL upd
set ASSET_ID_TATTOO = p.ASSET_ID_TATTOO -- 240912 CR978
,DATACENTER_ID = p.DATACENTER_ID -- 240912 CR978
,TENANT_ID = p.TENANT_ID -- 240912 CR978
FROM CORE.RAW_TENABLE_VUL r
join table(CORE.FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG)) p -- 240912 CR978
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG) = 1 -- 240912 CR978
and r.ASSET_ID_TAG IS NOT NULL -- 240916 1459 CR978
and upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''Tenant tags assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


If (:DATACATEGORY IN (:AWS_VUL,:AWS_VUL_MITIGATED)) THEN
    BEGIN
    BEGIN TRANSACTION; 
    --
    -- 240727 CR928
    -- Assign CREDENTIALED_SCAN already determined by SP_CRM_LINK_METADATA_V2
    -- Since views already handle SYSTEM_ID and ASSET_ID_TATTOO, we are only interested in CREDENTIALED_SCAN
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set CREDENTIALED_SCAN = met.IS_TENABLE_CREDENTIALED_SCAN::number
-- 240729 TEMPOARARY DISABLE UNTIL RESOLVED    ,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,met.DATA_ERROR_ARRAY) -- Inherit metadata errors
-- 240729 TEMPOARARY DISABLE UNTIL RESOLVED    ,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,met.DATA_WARNING_ARRAY) -- Inherit metadata warnings
    FROM CORE.RAW_TENABLE_VUL r
    JOIN TEMP_ASSET_METADATA met on met.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;

    RECORD_COUNT := SQLROWCOUNT;

    Msg := ''AWS CREDENTIALED_SCAN assigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    END;
End If;

If (:DATACATEGORY IN (:MAG_VUL,:MAG_VUL_MITIGATED)) THEN -- 241023 CR1012
    BEGIN
    BEGIN TRANSACTION; 
    --
    -- Assign CREDENTIALED_SCAN already determined by SP_CRM_LINK_METADATA_V2
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set CREDENTIALED_SCAN = met.IS_TENABLE_CREDENTIALED_SCAN::number
    FROM CORE.RAW_TENABLE_VUL r
    JOIN TEMP_ASSET_METADATA met on met.TEMP_DW_ASSET_ID = r.TEMP_DW_ASSET_ID
    WHERE r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;

    RECORD_COUNT := SQLROWCOUNT;

    Msg := ''MAG CREDENTIALED_SCAN assigned='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    COMMIT;
    END;
End If;

--
-- This may overlay SYSTEM_ID set my metadata above
--
BEGIN TRANSACTION; -- 240419 CR 875
--
-- 240419 CR 875 Integrate new CCSQ lookup table for assigning FISMA ID based on Repository ID
--
UPDATE CORE.RAW_TENABLE_VUL upd
set SYSTEM_ID = s.SYSTEM_ID
FROM CORE.RAW_TENABLE_VUL r
-- 250110 JOIN REF_LOOKUPS.SHARED.SEC_MV_CCSQ_FISMA_LOOKUP lu on lu.REPOSITORY_ID = r.REPOSITORY_ID
-- 250113 corrected typo in view name
JOIN REF_LOOKUPS.SHARED.SEC_MV_CCSQ_TENABLE_REPOS_FISMA_LOOKUP lu on lu.REPOSITORY_ID = r.REPOSITORY_ID -- 250110 PE cloned/renamed view
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = lu.CFACTS_UID
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and upd.RAW_TENABLE_VUL_ID = r.RAW_TENABLE_VUL_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''CCSQ_FISMA_LOOKUP assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

-- Empty DATACENTER_ID; Null or Empty
UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''WARNING: Empty DATACENTER_ID='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

-- DATACENTER_ID does not exist
UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM CORE.RAW_TENABLE_VUL r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID
and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;


If (upper(:DATACATEGORY) IN (:AWS_VUL,:AWS_VUL_MITIGATED)) THEN -- 240727 CR928 This probably no longr needed
    BEGIN
    UPDATE CORE.RAW_TENABLE_VUL
    set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
    ,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Instance ID is null in AWS datastream'')
    where SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(AWS_INSTANCE_ID,'''') IS NULL;
    END;
End If;

-- Validate DRaaS-CACHE. We expect all DRaaS assets to have the tenant tag format except for non-tattooable assets like network devices
-- 240912 CR978
UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Invalid DRaaS-CACHE ASSET_ID_TAG'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and DATACENTER_ID = ''441a2d4fdbfbab00560cf9531f961911''
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(ASSET_ID_TAG) = 0;

-- 240912 CR978
UPDATE CORE.RAW_TENABLE_VUL
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''DRaaS-CACHE ASSET_ID_TAG is empty'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and DATACENTER_ID = ''441a2d4fdbfbab00560cf9531f961911''
and ASSET_ID_TAG IS NULL;

If (:DATACATEGORY IN (:MAG_VUL,:MAG_VUL_MITIGATED)) THEN -- 241023 CR1012
    BEGIN
    BEGIN TRANSACTION; 

    UPDATE CORE.RAW_TENABLE_VUL
    set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
    ,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''MAG ASSET_ID_TAG is empty'')
    where SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and ASSET_ID_TAG IS NULL;

    UPDATE CORE.RAW_TENABLE_VUL
    set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
    ,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''MAG FISMA_ID_TAG is empty'')
    where SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and FISMA_ID_TAG IS NULL;
    
    COMMIT;
    END;
End If;

UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Invalid ASSET_ID_TATTOO'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(ASSET_ID_TATTOO,'''') IS NOT NULL -- 240917 CR978 added NULLIF
and CORE.FN_CRM_IS_VALID_ASSET_ID_TATTOO(ASSET_ID_TATTOO) = FALSE;

-- Validate PRIMARY_FISMA_ID_TATTOO/PRIMARY_FISMA_ID_DERIVED
UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''Invalid PRIMARY_FISMA_ID'')
FROM CORE.RAW_TENABLE_VUL r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.system_id) = coalesce(upper(r.PRIMARY_FISMA_ID_TATTOO),upper(r.PRIMARY_FISMA_ID_DERIVED))
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and (r.PRIMARY_FISMA_ID_TATTOO IS NOT NULL OR r.PRIMARY_FISMA_ID_DERIVED IS NOT NULL) and s.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''WARNING: Validate PRIMARY_FISMA_ID='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

-- Assign SYSTEM_ID (if not already assigned) based on PRIMARY_FISMA_ID_TATTOO or PRIMARY_FISMA_ID_DERIVED
UPDATE CORE.RAW_TENABLE_VUL
set SYSTEM_ID = s.SYSTEM_ID
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.SYSTEMS s on upper(s.system_id) = coalesce(upper(r.PRIMARY_FISMA_ID_TATTOO),upper(r.PRIMARY_FISMA_ID_DERIVED))
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and (r.PRIMARY_FISMA_ID_TATTOO IS NOT NULL OR r.PRIMARY_FISMA_ID_DERIVED IS NOT NULL) and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''WARNING: Assign PRIMARY_FISMA_ID='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''No IP available'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and IP IS NULL;

UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''ASSET_ID_TATTOO,DNSNAME,HOSTNAME,NETBIOSNAME are null'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and ASSET_ID_TATTOO IS NULL and DNSNAME	IS NULL and HOSTNAME IS NULL and NETBIOSNAME IS NULL;

-- SYSTEM_ID could not be assigned using system ID related data contained within the RAW_HWAM record.
-- See if MDR(Asset) record already exists and use its SYSTEM_ID
UPDATE CORE.RAW_TENABLE_VUL upd
set SYSTEM_ID = a.SYSTEM_ID
,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ID obtained from ASSET table based on ASSET_ID_TATTOO'')
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.ASSET a on a.DATACENTER_ID = r.DATACENTER_ID and a.ASSET_ID_TATTOO = r.ASSET_ID_TATTOO
where r.RAW_TENABLE_VUL_ID = upd.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''SYSTEM_ID from ASSET table used='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''Invalid SYSTEM_ID'')
FROM CORE.RAW_TENABLE_VUL r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.system_id) = upper(r.SYSTEM_ID)
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and NULLIF(r.SYSTEM_ID,'''') IS NOT NULL and s.SYSTEM_ID IS NULL;

--
-- When no SYSTEM_ID is available default it to the DATACENTER_ID
--
UPDATE CORE.RAW_TENABLE_VUL upd
set SYSTEM_ID = r.DATACENTER_ID
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :True
,DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ID defaulted to DATACENTER_ID'')
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = r.DATACENTER_ID
where r.RAW_TENABLE_VUL_ID = upd.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''SYSTEM_ID defaulted to DATACENTER_ID='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

UPDATE CORE.RAW_TENABLE_VUL
set ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_ERROR()
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''SYSTEM_ID could not be assigned'')
FROM CORE.RAW_TENABLE_VUL r
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''RESEARCH WHY SYSTEM_ID NOT ASSIGNED='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

--
-- UPDATE SNAPSHOT_IDS with Error and Warning counts
--
select SUM(ARRAY_SIZE(DATA_ERROR_ARRAY)),SUM(ARRAY_SIZE(DATA_WARNING_ARRAY)) into :ERROR_COUNT,:WARNING_COUNT FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID;
select count(1) into :RECORDS_WITH_ERRORS FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and ARRAY_SIZE(DATA_ERROR_ARRAY) > 0;
select count(1) into :RECORDS_WITH_WARNINGS FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and ARRAY_SIZE(DATA_WARNING_ARRAY) > 0;

UPDATE SNAPSHOT_IDS
set ERROR_COUNT = :ERROR_COUNT
,RECORDS_WITH_ERRORS = :RECORDS_WITH_ERRORS
,RECORDS_WITH_WARNINGS = :RECORDS_WITH_WARNINGS
,WARNING_COUNT = :WARNING_COUNT
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;

--
-- The CCIC vulnerability data includes On-Prem vulnerabilities and AWS vulnerabilities.
-- When processing the CCIC vulnerability data exclude AWS vulnerability data because it
-- is processed in a separate vulnerability data-stream specific to AWS
--
If (upper(:DATACATEGORY) IN (:CCIC_VUL,:CCIC_VUL_MITIGATED)) THEN
    BEGIN
    --
    -- (AWS OC East) is the same thing as (AWS Vulnerabilities) except SecEng renames it to (AWS Vulnerabilities) within the CCIC security center server
    --
    UPDATE CORE.RAW_TENABLE_VUL upd
    set APPLICABILITYCODE = ''Excluding AWS VUL from CCIC VUL FEED''
    ,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
    FROM CORE.RAW_TENABLE_VUL r
    where r.RAW_TENABLE_VUL_ID = upd.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.REPOSITORY_ID = 14;
    END;
End if;

UPDATE CORE.RAW_TENABLE_VUL
set APPLICABILITYCODE = ''CVE is empty''
,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
FROM CORE.RAW_TENABLE_VUL r
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.APPLICABILITYCODE = CORE.FN_CRM_GET_INDICATOR_INITIAL() and ARRAY_SIZE(r.CVE) = 0;

UPDATE CORE.RAW_TENABLE_VUL
set APPLICABILITYCODE = ''SEVERITY_NAME is empty''
,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
FROM CORE.RAW_TENABLE_VUL r
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.APPLICABILITYCODE = CORE.FN_CRM_GET_INDICATOR_INITIAL() and (r.SEVERITY_NAME IS NULL or r.SEVERITY_NAME = '''');

UPDATE CORE.RAW_TENABLE_VUL
set APPLICABILITYCODE = ''SEVERITY_NAME is Info''
,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
FROM CORE.RAW_TENABLE_VUL r
where r.RAW_TENABLE_VUL_ID = CORE.RAW_TENABLE_VUL.RAW_TENABLE_VUL_ID 
and r.SNAPSHOT_ID = :P_SNAPSHOT_ID and r.APPLICABILITYCODE = CORE.FN_CRM_GET_INDICATOR_INITIAL() 
and (upper(r.FISMASEVERITY) = ''INFO''); -- 240911 CR976
-- 240911 CR976 and (upper(r.SEVERITY_NAME) = ''INFO'');

UPDATE CORE.RAW_TENABLE_VUL
set APPLICABILITYCODE = ''CVSS is zero''
,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
where SNAPSHOT_ID = :P_SNAPSHOT_ID and APPLICABILITYCODE = CORE.FN_CRM_GET_INDICATOR_INITIAL() and CVSSV3BASESCORE = 0;


--
-- 241023 CR1012
-- These plugins not used as of this date but marking them for visibility sake
--
-- 99172 Microsoft Azure Instance Metadata Enumeration (Windows)
-- 99171 Microsoft Azure Instance Metadata Enumeration (Unix)
--
UPDATE CORE.RAW_TENABLE_VUL
set APPLICABILITYCODE = ''Metadata''
,ROWDISPOSITION = CORE.FN_CRM_GET_ROWDISPOSITION_NOT_NEEDED()
where SNAPSHOT_ID = :P_SNAPSHOT_ID and APPLICABILITYCODE = CORE.FN_CRM_GET_INDICATOR_INITIAL() 
and PLUGIN_ID IN (''90191'',''90427'',''1221295'',''1218405'',''19506'',''99171'',''99172''); 

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_ALL_TEST"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull all data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_ALL_TEST'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE CORE.RAW_DATA;

CALL CORE.SP_CRM_PULL_AWS_HWAM_NEW(); -- LAST_CONFIRMED_TIME avail
select system$wait(60);
CALL CORE.SP_CRM_PULL_AXONIUS_NEW();
select system$wait(60);
CALL CORE.SP_CRM_PULL_CCIC_VUL_NEW(''CCIC VUL'');
select system$wait(60);
CALL CORE.SP_CRM_PULL_CCIC_VUL_NEW(''CCIC VUL MITIGATED'');
select system$wait(60);
CALL CORE.SP_CRM_PULL_CROWDSTRIKE_NEW();
select system$wait(60);
CALL CORE.SP_CRM_PULL_FORESCOUT_NEW();
select system$wait(60);
CALL CORE.SP_CRM_PULL_IUSG_VUL_NEW(''AWS VUL'');
select system$wait(60);
CALL CORE.SP_CRM_PULL_IUSG_VUL_NEW(''AWS VUL MITIGATED'');
select system$wait(60);
CALL CORE.SP_CRM_PULL_MAG_VUL_NEW(''MAG VUL'');
select system$wait(60);
CALL CORE.SP_CRM_PULL_MAG_VUL_NEW(''MAG VUL MITIGATED'');


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_AWS_HWAM_NEW"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS HWAM data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_AWS_HWAM_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AWS HWAM'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);
*/


SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;
  
insert into CORE.RAW_DATA (
ASSET_ID_TATTOO
,AWS_ACCOUNTID
,AWS_INSTANCE_ID
,COMPUTER_TYPE
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DATACENTER_ID
,DEVICETYPE
,ENVIRONMENT
,FQDN
,HOSTNAME
,INSERT_DATE
,INSTANCESTATUS
,IPV4
,IPV6
,LAST_SEEN
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_VERSION
,REPORTDATE
,ROWDISPOSITION
,SNAPSHOT_ID
,SOURCE_TOOL
,SYSTEM_ID
)
SELECT
src.ASSET_ID_TATTOO
,src.AWS_ACCOUNTID
,src.AWS_INSTANCE_ID
,src.COMPUTER_TYPE
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,src.DATACENTER_ID
,src.DEVICE_TYPE
,src.ENVIRONMENT
,STRTOK_TO_ARRAY(src.FQDN,'','') as FQDN
,src.HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,src.INSTANCESTATUS
,src.IPV4
,src.IPV6
,src.LAST_SEEN
,src.MACADDRESS
,src.MOTHERBOARD
,src.NETBIOSNAME
,src.OS
,src.OS_VERSION
,src.REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,:SNAPSHOT_ID as SNAPSHOT_ID
,src.SOURCE_TOOL
,src.SYSTEM_ID
FROM
(
SELECT 
h.INSTANCEID as ASSET_ID_TATTOO
,h.ACCOUNT_NUMBER as AWS_ACCOUNTID
,h.INSTANCEID as AWS_INSTANCE_ID
,h.COMPUTER_TYPE
,h.DATACENTER_ID
,h.DEVICE_TYPE
,h.ENVIRONMENT
,h.FQDN
,h.HOSTNAME
,h.INSTANCESTATUS
,h.IPV4
,h.IPV6
,h.LAST_CONFIRMED_TIME as LAST_SEEN
,h.MAC as MACADDRESS
,h.MOTHERBOARD_SN as MOTHERBOARD
,h.NETBIOS_HN as NETBIOSNAME
,h.OS
,h.OS_VERSION
,h.REPORT_TIME as REPORTDATE
,h.SOURCE_TOOL
,h.SYSTEM_ID
FROM CORE.VW_HWAM_AWS_V2 h
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = h.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = h.SYSTEM_ID
WHERE NULLIF(h.INSTANCEID,'''') IS NOT NULL

UNION ALL

SELECT 
h.INSTANCEID as ASSET_ID_TATTOO
,h.ACCOUNT_NUMBER as AWS_ACCOUNTID
,h.INSTANCEID as AWS_INSTANCE_ID
,h.COMPUTER_TYPE
,h.DATACENTER_ID::varchar as DATACENTER_ID -- 240725 CR928
,h.DEVICE_TYPE
,h.ENVIRONMENT
,h.FQDN
,STRTOK_TO_ARRAY(h.HOSTNAME,'','') as HOSTNAME
,h.INSTANCESTATUS
,h.IPV4
,h.IPV6
,h.REPORT_TIME::datetime as LAST_SEEN
,h.MAC as MACADDRESS
,NULL as MOTHERBOARD
,NULL as NETBIOSNAME
,h.OS
,h.OS_VERSION
,h.REPORT_TIME::datetime as REPORTDATE
,h.SOURCE_TOOL
,s.SYSTEM_ID
FROM APP_CDM.SHARED.SEC_VW_HWAM_CCSQ h
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = h.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = h.FISMA_ID
WHERE NULLIF(h.INSTANCEID,'''') IS NOT NULL
) src;

RECORD_COUNT := SQLROWCOUNT;

COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_AWS_HWAM_V2"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS HWAM data into RAW_HWAM table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_AWS_HWAM_V2'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AWS HWAM'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;
  
insert into CORE.RAW_HWAM (
ASSET_ID_TATTOO
,AWS_ACCOUNTID
,AWS_DATACENTER_ID
,AWS_PRIMARY_FISMA_ID_TATTOO
,AWS_INSTANCE_ID
,COMPUTER_TYPE
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DATACENTER_ID
,DEVICE_TYPE
,ENVIRONMENT
,FISMA_UUID
,FQDN
,HOSTNAME
,INSERT_DATE
,INSTANCESTATUS
,IPV4
,IPV6
,IS_FS_MANAGED
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,LAST_CONFIRMED_TIME
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_VERSION
,PRIMARY_FISMA_ID_DERIVED
,REPORTDATE
,ROWDISPOSITION
,SNAPSHOT_ID
,SOURCE_TOOL
,SYSTEM_ACRONYM
,SYSTEM_ID
)
--
-- USING SYSTEM_ID MULTIPLE TIMES NEEDS TO BE ELIMIMINATED
--
select
src.ASSET_ID_TATTOO
,src.AWS_ACCOUNTID
,src.AWS_DATACENTER_ID
,src.AWS_PRIMARY_FISMA_ID_TATTOO
,src.AWS_INSTANCE_ID
,src.COMPUTER_TYPE
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,src.DATACENTER_ID
,src.DEVICE_TYPE
,src.ENVIRONMENT
,src.FISMA_UUID
,STRTOK_TO_ARRAY(src.FQDN,'','') as FQDN
,src.HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,src.INSTANCESTATUS
,src.IPV4
,src.IPV6
,0 as IS_FS_MANAGED
,0 as IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC -- Initialize
,src.LAST_CONFIRMED_TIME
,src.MACADDRESS
,src.MOTHERBOARD
,src.NETBIOSNAME
,src.OS
,src.OS_VERSION
,src.PRIMARY_FISMA_ID_DERIVED
,src.REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,:SNAPSHOT_ID as SNAPSHOT_ID
,src.SOURCE_TOOL
,src.SYSTEM_ACRONYM
,src.SYSTEM_ID
FROM
(
SELECT 
h.INSTANCEID as ASSET_ID_TATTOO
,h.ACCOUNT_NUMBER as AWS_ACCOUNTID
,h.DATACENTER_ID as AWS_DATACENTER_ID -- 240725 CR928
,h.SYSTEM_ID as AWS_PRIMARY_FISMA_ID_TATTOO
,h.INSTANCEID as AWS_INSTANCE_ID
,h.COMPUTER_TYPE
,h.DATACENTER_ID -- 240725 CR928
,h.DEVICE_TYPE
,h.ENVIRONMENT
,h.FISMA_UUID
,h.FQDN
,h.HOSTNAME
,h.INSTANCESTATUS
,h.IPV4
,h.IPV6
,h.LAST_CONFIRMED_TIME
,h.MAC as MACADDRESS
,h.MOTHERBOARD_SN as MOTHERBOARD
,h.NETBIOS_HN as NETBIOSNAME
,h.OS
,h.OS_VERSION
,h.SYSTEM_ID as PRIMARY_FISMA_ID_DERIVED -- -- 240528 CR901 see AWS_PRIMARY_FISMA_ID_TATTOO above
,h.REPORT_TIME as REPORTDATE
,h.SOURCE_TOOL
,h.SYSTEM_ACRONYM
,h.SYSTEM_ID -- 240725 CR928
FROM CORE.VW_HWAM_AWS_V2 h -- 240725 CR928
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = h.DATACENTER_ID -- 240726 CR928
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = h.SYSTEM_ID -- 240726 CR928
WHERE NULLIF(h.INSTANCEID,'','') IS NOT NULL -- 240726 CR928

UNION ALL

SELECT 
h.INSTANCEID as ASSET_ID_TATTOO
,h.ACCOUNT_NUMBER as AWS_ACCOUNTID
,h.DATACENTER_ID as AWS_DATACENTER_ID
,h.FISMA_ID as AWS_PRIMARY_FISMA_ID_TATTOO
,h.INSTANCEID as AWS_INSTANCE_ID
,h.COMPUTER_TYPE
,h.DATACENTER_ID::varchar as DATACENTER_ID -- 240725 CR928
,h.DEVICE_TYPE
,h.ENVIRONMENT
,NULL as FISMA_UUID
,h.FQDN
,STRTOK_TO_ARRAY(h.HOSTNAME,'','') as HOSTNAME
,h.INSTANCESTATUS
,h.IPV4
,h.IPV6
,h.REPORT_TIME::datetime as LAST_CONFIRMED_TIME
,h.MAC as MACADDRESS
,NULL as MOTHERBOARD
,NULL as NETBIOSNAME
,h.OS
,h.OS_VERSION
,h.FISMA_ID as PRIMARY_FISMA_ID_DERIVED
,h.REPORT_TIME::datetime as REPORTDATE
,h.SOURCE_TOOL
,h.SYSTEM_ACRONYM
,h.FISMA_ID as SYSTEM_ID
FROM APP_CDM.SHARED.SEC_VW_HWAM_CCSQ h
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = h.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = h.FISMA_ID
WHERE NULLIF(h.INSTANCEID,'','') IS NOT NULL
) src;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_HWAM='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_CONFIRMED_TIME) FROM APP_CDM.SHARED.SEC_VW_HWAM_AWS);  -- RBAC 20230803/20230808
MAX_DATE := (select MAX(LAST_CONFIRMED_TIME) FROM APP_CDM.SHARED.SEC_VW_HWAM_AWS);  -- RBAC 20230803/20230808

If (:RECORD_COUNT > 0) THEN -- 240726 prefixed RECORD_COUNT with colon
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;
 
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_AXONIUS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AXONIUS data into CRM'
EXECUTE AS OWNER
AS '
--
-- CRM once ingested Axonius data encompassing multiple systems (prior to 240226) but this newest version is
-- specific to HIGALS data only
--
declare
Appl varchar := ''SP_CRM_PULL_AXONIUS'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AXONIUS'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

-- FOR TESTING PreviousPullDatetime := ''2024-07-30''::DATETIME;


Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_HWAM (
ASSET_ID_TAG
,ASSET_ID_TATTOO
,DATACENTER_ID
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DEVICE_TYPE
,FISMA_ID_TAG
,FQDN
,HOSTNAME
,INSERT_DATE
,IPV4
,IPV6
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,LAST_CONFIRMED_TIME
,MACADDRESS
,OS
,OS_VERSION
,REPORTDATE
,ROWDISPOSITION
,SYSTEM_ID
,SNAPSHOT_ID
,SOURCE_TOOL
)
SELECT
ax.AXON_ID as ASSET_ID_TAG
,ax.AXON_ID as ASSET_ID_TATTOO
,ax.DATACENTER_ID
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,ax.DEVICE_TYPE
,ax.FISMA_ID as FISMA_ID_TAG
,STRTOK_TO_ARRAY(ax.FQDN,'','') as FQDN
,STRTOK_TO_ARRAY(ax.HOST_NAME,'','') as HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,ax.IPV4
,ax.IPV6
,0 as IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,ax.LAST_CONFIRMED_TIME
,ax.MAC_ADDRESS as MACADDRESS
,ax.OS
,ax.OS_VERSION
,ax.REPORT_DATE as REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,ax.FISMA_ID as SYSTEM_ID
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
FROM APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS ax -- 241008 CR996 APP_HIGLAS DB RENAMED TO APP_AXONIUS
JOIN (select r1.DATACENTER_ID,r1.AXON_ID,r1.REPORT_DATE,r1.LAST_CONFIRMED_TIME
FROM (select rank()over(partition by DATACENTER_ID,AXON_ID order by REPORT_DATE desc, LAST_CONFIRMED_TIME desc) TheRank,DATACENTER_ID,AXON_ID, REPORT_DATE,LAST_CONFIRMED_TIME
    from APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS
    WHERE REPORT_DATE > :PreviousPullDatetime) r1 where r1.TheRank = 1) t on t.DATACENTER_ID = ax.DATACENTER_ID and t.AXON_ID = ax.AXON_ID and t.REPORT_DATE = ax.REPORT_DATE
    and t.LAST_CONFIRMED_TIME = ax.LAST_CONFIRMED_TIME
WHERE ax.REPORT_DATE > :PreviousPullDatetime;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
  
    UPDATE CORE.SNAPSHOT_IDS
    set RECORD_COUNT = 0
    where SNAPSHOT_ID = :SNAPSHOT_ID;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_HWAM='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

    MIN_DATE := (select MIN(REPORT_DATE) FROM APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS WHERE REPORT_DATE > :PreviousPullDatetime);
    MAX_DATE := (select MAX(REPORT_DATE) FROM APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS WHERE REPORT_DATE > :PreviousPullDatetime);

    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;

    UPDATE CORE.SNAPSHOT_IDS
    set MIN_DATE = :MIN_DATE
    ,MAX_DATE = :MAX_DATE
    ,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
    where SNAPSHOT_ID = :SNAPSHOT_ID;
    END;
END IF;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_AXONIUS_NEW"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AXONIUS data into CRM'
EXECUTE AS OWNER
AS '
--
-- CRM once ingested Axonius data encompassing multiple systems (prior to 240226) but this newest version is
-- specific to HIGALS data only
--
declare
Appl varchar := ''SP_CRM_PULL_AXONIUS_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AXONIUS'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_DATA (
ASSET_ID_TATTOO
,DATACENTER_ID
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DEVICETYPE
,FQDN
,HOSTNAME
,INSERT_DATE
,IPV4
,IPV6
,LAST_SEEN
,MACADDRESS
,OS
,OS_VERSION
,REPORTDATE
,ROWDISPOSITION
,SYSTEM_ID
,SNAPSHOT_ID
,SOURCE_TOOL
)
SELECT
ax.AXON_ID as ASSET_ID_TATTOO
,ax.DATACENTER_ID
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,ax.DEVICE_TYPE
,STRTOK_TO_ARRAY(ax.FQDN,'','') as FQDN
,STRTOK_TO_ARRAY(ax.HOST_NAME,'','') as HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,ax.IPV4
,ax.IPV6
,ax.LAST_CONFIRMED_TIME as LAST_SEEN
,ax.MAC_ADDRESS as MACADDRESS
,ax.OS
,ax.OS_VERSION
,ax.REPORT_DATE as REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,ax.FISMA_ID as SYSTEM_ID
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
FROM APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS ax -- 241008 CR996 APP_HIGLAS DB RENAMED TO APP_AXONIUS
JOIN (select r1.DATACENTER_ID,r1.AXON_ID,r1.REPORT_DATE,r1.LAST_CONFIRMED_TIME
FROM (select rank()over(partition by DATACENTER_ID,AXON_ID order by REPORT_DATE desc, LAST_CONFIRMED_TIME desc) TheRank,DATACENTER_ID,AXON_ID, REPORT_DATE,LAST_CONFIRMED_TIME
    from APP_AXONIUS.SHARED.SEC_VW_HWAM_HIGLAS
    WHERE REPORT_DATE > :PreviousPullDatetime) r1 where r1.TheRank = 1) t on t.DATACENTER_ID = ax.DATACENTER_ID and t.AXON_ID = ax.AXON_ID and t.REPORT_DATE = ax.REPORT_DATE
    and t.LAST_CONFIRMED_TIME = ax.LAST_CONFIRMED_TIME
WHERE ax.REPORT_DATE > :PreviousPullDatetime;

RECORD_COUNT := SQLROWCOUNT;

COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CCIC_VUL_MITIGATED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CCIC TENABLE MITIGATED data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_CCIC_VUL_MITIGATED'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''CCIC VUL MITIGATED'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE -- 240710 CR928
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AWS_ACCOUNTID
,AWS_INSTANCE_ID
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY -- 240710 CR928
,DATA_WARNING_ARRAY -- 240710 CR928
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG -- 240827 CR-TBD
,FISMA_ID_TAG -- 240827 CR-TBD
) 
SELECT
v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE -- 240710 CR928
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,null as AWS_ACCOUNTID
,NULL as AWS_INSTANCE_ID
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,v.BID
,v.CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,v.CPE
,v.CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,v.CVE -- 240108 was STRTOK_TO_ARRAY
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE -- 230419 Naseem found that BASESCORE matches legacy CVSSv2
,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240710 CR928
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240710 CR928
,v.REPOSITORY_DESCRIPTION as DATACENTER_ID
,v.DESCRIPTION
,NULLIF(v.DNSNAME,'''') as DNSNAME -- 240405 1939 added NULLIF
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN
,NULL as FISMASEVERITY
,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
,NULL as HOSTNAME -- 240405 1939 HOSTNAME is not part of view
,v.HOSTUNIQUENESS
,NULL as HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,v.IP
,v.IPS
,v.KEYDRIVERS
,v.LAST_SEEN
,NULLIF(v.MACADDRESS,'''') as MACADDRESS -- 240405 1939 added NULLIF
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS -- 240710 CR928
,NULLIF(v.NETBIOSNAME,'''') as NETBIOSNAME -- 240405 1939 added NULLIF
,0 as NUMERIC_SEVERITY -- 240710 CR928
,v.OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
,v.PLUGIN_ID
,v.PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,v.PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,v.PLUGINTEXT
,v.PORT
,NULL as PRIMARY_FISMA_ID_DERIVED
,v.PRIMARY_FISMA_ID as PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,NULL as RECASTRISKRULECOMMENT
,v.REPORTDATE -- 240108 is now TIMESTAMP_NTZ(9), was v.REPORTDATE::datetime
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240710 CR928
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,:SNAPSHOT_ID
,v.SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,v.TEMPORAL_SCORE
,v.UUID as TENABLEUUID
,v.UNIQUENESS
,v.VERSION
,v.VPR_SCORE
,v.VPRCONTEXT -- 240108 is now array, was v.VPRCONTEXT::varchar
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
,v.XREF
,v.ASSET_ID_TATTOO as ASSET_ID_TAG -- 240827 CR-TBD
,v.PRIMARY_FISMA_ID as FISMA_ID_TAG -- 240827 CR-TBD
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_MITIGATED_VULNS v
WHERE v.REPORTDATE > :PreviousPullDatetime;

COMMIT;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where Parmname = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CCIC_VUL_NEW"("P_DATACATEGORY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CCIC TENABLE data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_CCIC_VUL_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar;
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

/**********************************************************************************
SELECT DISTINCT IP
,ARRAY_TO_STRING(ARRAY_DISTINCT(STRTOK_TO_ARRAY(IPS,'','')),'','') as DISTINCT_IPS 
FROM RAW_TENABLE_VUL WHERE NULLIF(IP,'''') <> NULLIF(DISTINCT_IPS,'''')
ZERO ROWS SO IPS FIELD IS NOT NEEDED
**********************************************************************************/

BEGIN
Datacategory := :P_DATACATEGORY;

Appl := :Appl || ''('' || :Datacategory || '')'';
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:Datacategory NOT IN (''CCIC VUL'',''CCIC VUL MITIGATED'')) THEN
    BEGIN
    ExceptionMsg := ''Datacategory cannot be used in this SP'';
    raise CRM_logic_exception;
    END;
END IF;

IF (:Datacategory = ''CCIC VUL'') THEN
    BEGIN
    BEGIN TRANSACTION;
    
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	-- ,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE 
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,v.REPOSITORY_DESCRIPTION as DATACENTER_ID
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',v.CVSSV3BASESCORE) as NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
	,v.XREF
    --
    -- We do a UNION ALL on SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS and SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO
    -- because we need the metadata plugins
    --
    FROM (SELECT
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE 
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE 
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DESCRIPTION
	,DNSNAME
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,IP
	,IPS
	,KEYDRIVERS 
	,LAST_SEEN
	,MACADDRESS
	,NETBIOSNAME
	,OPERATING_SYSTEM
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
	,PRIMARY_FISMA_ID
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
--	,SCAN_POLICY_NAME
--	,SCAN_POLICY_UID
--	,SCAN_START_DATE
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SOLUTION
	,STIGSEVERITY
	,SYNOPSIS
	,TEMPORAL_SCORE
	,UNIQUENESS
	,UUID
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
	,XREF
    FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS
    WHERE REPORTDATE > :PreviousPullDatetime

    UNION ALL

    SELECT
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE 
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE 
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DESCRIPTION
	,DNSNAME
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,IP
	,IPS
	,KEYDRIVERS 
	,LAST_SEEN
	,MACADDRESS
	,NETBIOSNAME
	,OPERATING_SYSTEM
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
	,PRIMARY_FISMA_ID
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
--	,SCAN_POLICY_NAME
--	,SCAN_POLICY_UID
--	,SCAN_START_DATE
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SOLUTION
	,STIGSEVERITY
	,SYNOPSIS
	,TEMPORAL_SCORE
	,UNIQUENESS
	,UUID
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
	,XREF
    FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO
    WHERE REPORTDATE > :PreviousPullDatetime) v;

    RECORD_COUNT := SQLROWCOUNT;

    COMMIT;
    END;
ELSE -- CCIC VUL MITITGATED
    BEGIN
    BEGIN TRANSACTION;
    
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	-- ,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE 
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
--	,v.CREDENTIALED_SCAN
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,v.REPOSITORY_DESCRIPTION as DATACENTER_ID
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',v.CVSSV3BASESCORE) as NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
	,v.XREF
    FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_MITIGATED_VULNS v
    WHERE v.REPORTDATE > :PreviousPullDatetime;

    RECORD_COUNT := SQLROWCOUNT;
    
    COMMIT;
    END; 
END IF;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CCIC_VUL_V2"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CCIC TENABLE data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_CCIC_VUL_V2'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''CCIC VUL'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE -- 240710 CR928
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AWS_ACCOUNTID
,AWS_INSTANCE_ID
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY -- 240710 CR928
,DATA_WARNING_ARRAY -- 240710 CR928
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG -- 240827 CR-TBD
,FISMA_ID_TAG -- 240827 CR-TBD
) 
SELECT
v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE -- 240710 CR928
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,null as AWS_ACCOUNTID
,NULL as AWS_INSTANCE_ID
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,v.BID
,v.CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,v.CPE
,v.CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,v.CVE -- 240108 was STRTOK_TO_ARRAY
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE -- 230419 Naseem found that BASESCORE matches legacy CVSSv2
,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240710 CR928
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240710 CR928
,v.REPOSITORY_DESCRIPTION as DATACENTER_ID
,v.DESCRIPTION
,NULLIF(v.DNSNAME,'''') as DNSNAME -- 240405 1939 added NULLIF
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN
,NULL as FISMASEVERITY
,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
,NULL as HOSTNAME -- 240405 1939 HOSTNAME is not in view
,v.HOSTUNIQUENESS
,NULL as HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,v.IP
,v.IPS
,v.KEYDRIVERS
,v.LAST_SEEN
,NULLIF(v.MACADDRESS,'''') as MACADDRESS -- 240506 corrected spelling 240405 1939 added NULLIF
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS -- 240710 CR928
,NULLIF(v.NETBIOSNAME,'''') as NETBIOSNAME -- 240405 1939 added NULLIF
,0 as NUMERIC_SEVERITY -- 240710 CR928
,v.OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
,v.PLUGIN_ID
,v.PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,v.PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,v.PLUGINTEXT
,v.PORT
,NULL as PRIMARY_FISMA_ID_DERIVED
,v.PRIMARY_FISMA_ID as PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,NULL as RECASTRISKRULECOMMENT
,v.REPORTDATE -- 240108 is now TIMESTAMP_NTZ(9), was v.REPORTDATE::datetime
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240710 CR928
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,:SNAPSHOT_ID
,v.SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,v.TEMPORAL_SCORE
,v.UUID as TENABLEUUID
,v.UNIQUENESS
,v.VERSION
,v.VPR_SCORE
,v.VPRCONTEXT -- 240108 is now array, was v.VPRCONTEXT::varchar
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
,v.XREF
,v.ASSET_ID_TATTOO as ASSET_ID_TAG -- 240827 CR-TBD
,v.PRIMARY_FISMA_ID as FISMA_ID_TAG -- 240827 CR-TBD
--
-- We do a UNION ALL on SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS and SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO
-- because we need the metadata plugins
--
FROM (
SELECT
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,BASESCORE
,BID
,CHECKTYPE
,CPE
,CREDENTIALED_SCAN
,CVE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,HAS_BEEN_MITIGATED
,HOSTUNIQUENESS
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,NETBIOSNAME
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID
,PROTOCOL
,RECASTRISK
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SOLUTION
,STIGSEVERITY
,SYNOPSIS
,TEMPORAL_SCORE
,UUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_VULNS
WHERE REPORTDATE > :PreviousPullDatetime

UNION ALL

SELECT
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,BASESCORE
,BID
,CHECKTYPE
,CPE
,CREDENTIALED_SCAN
,CVE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,HAS_BEEN_MITIGATED
,HOSTUNIQUENESS
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,NETBIOSNAME
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID
,PROTOCOL
,RECASTRISK
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SOLUTION
,STIGSEVERITY
,SYNOPSIS
,TEMPORAL_SCORE
,UUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
FROM APP_TENABLE.SHARED.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO
WHERE REPORTDATE > :PreviousPullDatetime) v;

COMMIT;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CFACTS"("P_REPORT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CFACTS data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS 'declare
Appl varchar := ''SP_CRM_PULL_CFACTS'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean DEFAULT 0;
True boolean DEFAULT 1;
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

----------------------------------------------------------------------
--            CHECK TO SEE IF CFACTS DATA IS AVAILABLE AND CURRENT
----------------------------------------------------------------------

/****************************************************************************************************************************
THE BASELINE WAS ESTABLISHED 11/07/2024 WITH THE FOLLOWING:

CREATE TABLE EXPECTED_CFACTS_COLUMNS as
SELECT v.TABLE_CATALOG,v.TABLE_SCHEMA,v.TABLE_NAME,c.COLUMN_NAME,c.DATA_TYPE
FROM APP_CFACTS.INFORMATION_SCHEMA.VIEWS v
LEFT OUTER JOIN (select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,DATA_TYPE 
    from APP_CFACTS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = ''SHARED'' ) c on c.TABLE_CATALOG = v.TABLE_CATALOG 
    and c.TABLE_SCHEMA = v.TABLE_SCHEMA and c.TABLE_NAME = v.TABLE_NAME
WHERE v.TABLE_SCHEMA = ''SHARED'' and v.CREATED::date = current_date()
;

****************************************************************************************************************************/

--
-- 241105 CR1023
-- Ensure that all CFACTS data is available and current.
-- Check also helps to trap CFACTS field name changes or data type.
-- 241107 replaced LAST_ALTERED with CREATED
--
select count(1) INTO :RECORD_COUNT from CORE.EXPECTED_CFACTS_COLUMNS expected
LEFT OUTER JOIN (SELECT v.TABLE_CATALOG,v.TABLE_SCHEMA,v.TABLE_NAME,v.LAST_DDL,c.COLUMN_NAME,c.DATA_TYPE
    FROM APP_CFACTS.INFORMATION_SCHEMA.VIEWS v
    LEFT OUTER JOIN (select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,DATA_TYPE 
        from APP_CFACTS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = ''SHARED'' ) c on c.TABLE_CATALOG = v.TABLE_CATALOG 
        and c.TABLE_SCHEMA = v.TABLE_SCHEMA and c.TABLE_NAME = v.TABLE_NAME
     WHERE v.TABLE_SCHEMA = ''SHARED'' and v.CREATED::date = current_date()) cur on cur.TABLE_CATALOG = expected.TABLE_CATALOG 
        and cur.TABLE_SCHEMA = expected.TABLE_SCHEMA and cur.TABLE_NAME = expected.TABLE_NAME
        and cur.COLUMN_NAME = expected.COLUMN_NAME 
        and cur.DATA_TYPE = expected.DATA_TYPE
WHERE cur.COLUMN_NAME IS NULL;
   
IF (:RECORD_COUNT <> 0) THEN
    BEGIN
    --
    -- Send warning message to security-datalake-crm-sdw-alerts when not all CFACTS data is available
    --
    Msg := ''WARNING: APP_CFACTS.SHARED views are incomplete. '' || :RECORD_COUNT || '' columns are missing. SDW CFACTS data will remain unchanged.'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    
    select CORE.SF_SEND_SLACK_MESSAGE(:Msg);

    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
    END;
END IF;


----------------------------------------------------------------------
--            SYSTEMS
----------------------------------------------------------------------
BEGIN TRANSACTION;
MERGE INTO CORE.SYSTEMS t USING (
SELECT
	ACRONYM,
    ACTUAL_DECOMMISION_DATE, -- 231218
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE_NAME,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	INFORMATION_SYSTEM_TYPE,
	IS_MARKETPLACE,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
    LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE, -- 230428 
	LAST_ACT_SCA_FINAL_REPORT_DATE,
    LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,  -- 230428 
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
    OPERATED_BY, -- 250103 CR1059
	PACKAGE_TYPE,
    PIA_014,
	PIA_EXPIRATION_DATE,
	PRIMARY_ISSO,
	NULLIF(PRIMARY_OPERATING_LOCATION,'''') as PRIMARY_OPERATING_LOCATION,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
    CORE.FN_CRM_STRIPHTML(SYSTEM_DESCRIPTION) as SYSTEM_DESCRIPTION, -- 231012
	SYSTEM_ID,
	TLC_PHASE   
FROM CORE.VW_CFACTS_SYSTEMS    
)s ON (s.System_ID = t.System_ID)
WHEN MATCHED THEN UPDATE SET 
    t.ACRONYM = s.ACRONYM
    ,t.ACTUAL_DECOMMISION_DATE = s.ACTUAL_DECOMMISION_DATE -- 231218
	,t.ARCHER_TRACKING_ID = s.ARCHER_TRACKING_ID
    ,t.ATO_EXPIRATION_DATE = s.ATO_EXPIRATION_DATE
    ,t.ATO_REVIEW_DATE = s.ATO_REVIEW_DATE
	,t.AUTH_COMMENTS = s.AUTH_COMMENTS
	,t.AUTH_DECISION = s.AUTH_DECISION
    ,t.AUTHORIZATION_MEMO_SIGNED_DATE = s.AUTHORIZATION_MEMO_SIGNED_DATE
	,t.AUTHORIZATION_PACKAGE = s.AUTHORIZATION_PACKAGE_NAME
    ,t.BO_RECOMMENDATION_REVIEW_DATE = s.BO_RECOMMENDATION_REVIEW_DATE
    ,t.BO_REVIEW_DATE = s.BO_REVIEW_DATE
	,t.BUSINESS_OWNER = s.BUSINESS_OWNER
	,t.CIO = s.CIO
	,t.CISO = s.CISO
    ,t.CISO_REVIEW_DATE = s.CISO_REVIEW_DATE
	,t.CLOUD_SERVICE_PROVIDER = s.CLOUD_SERVICE_PROVIDER
    ,t.COMPONENT_ACRONYM = s.COMPONENT_ACRONYM
	,t.COMPONENT_DESCRIPTION = s.COMPONENT_DESCRIPTION
	,t.COMPONENT_NAME = s.COMPONENT_NAME
	,t.COMPONENT_RISK_REPORTS_OVERSIGHT = s.COMPONENT_RISK_REPORTS_OVERSIGHT
	,t.CONTINGENCYEXPIRATIONDATE = s.CONTINGENCYEXPIRATIONDATE
	,t.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID = s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,t.CP_TEST_DATE = s.CP_TEST_DATE
	,t.CP_TEST_RESULTS = s.CP_TEST_RESULTS
	,t.CRA = s.CRA
    ,t.CRA_REVIEW_DATE = s.CRA_REVIEW_DATE
	,t.CYBERVET = s.CYBERVET
	,t.DATE_AUTH_MEMO_EXPIRES = s.DATE_AUTH_MEMO_EXPIRES
	,t.DATE_AUTH_MEMO_SIGNED = s.DATE_AUTH_MEMO_SIGNED
	,t.DCISO = s.DCISO
    ,t.DIVISION_ACRONYM = s.DIVISION_ACRONYM
	,t.DIVISION_DESCRIPTION = s.DIVISION_DESCRIPTION
	,t.DIVISION_NAME = s.DIVISION_NAME
    ,t.DSPC_REVIEW_DATE = s.DSPC_REVIEW_DATE
    ,t.DSPPO_REVIEW_DATE = s.DSPPO_REVIEW_DATE
	,t.E_AUTH_EXP_DATE = s.E_AUTH_EXP_DATE
	,t.E_AUTH_LEVEL = s.E_AUTH_LEVEL
	,t.E_AUTH_RISK_ASSESSMENT_DATE = s.E_AUTH_RISK_ASSESSMENT_DATE
	,t.FINANCIAL_SYSTEM = s.FINANCIAL_SYSTEM
	,t.FIPS_199_AVAILABILITY_RATING = s.FIPS_199_AVAILABILITY_RATING
	,t.FIPS_199_CONFIDENTIALITY_RATING = s.FIPS_199_CONFIDENTIALITY_RATING
	,t.FIPS_199_INTEGRITY_RATING = s.FIPS_199_INTEGRITY_RATING
	,t.FIPS_199_OVERALL_IMPACT_RATING = s.FIPS_199_OVERALL_IMPACT_RATING
	,t.FIRST_PUBLISHED_DATE = s.FIRST_PUBLISHED_DATE
	,t.FISMA_SYSTEM = s.FISMA_SYSTEM
    ,t.GROUP_ACRONYM = s.GROUP_ACRONYM
	,t.GROUP_DESCRIPTION = s.GROUP_DESCRIPTION
	,t.GROUP_NAME = s.GROUP_NAME
	,t.HVA_SCORE = s.HVA_SCORE
	,t.HVASTATUS = s.HVASTATUS
	,t.INFORMATION_SYSTEM_TYPE = s.INFORMATION_SYSTEM_TYPE
	,t.IS_MARKETPLACE = s.IS_MARKETPLACE
	,t.ISRA_REVIEW_DATE = s.ISRA_REVIEW_DATE
	,t.ISRA_STATUS = s.ISRA_STATUS
	,t.ISSO = s.ISSO
	,t.ISSO_COUNT = s.ISSO_COUNT
    ,t.ISSO_REVIEW_DATE = s.ISSO_REVIEW_DATE
    ,t.ISSO_SUBMISSION_DATE = s.ISSO_SUBMISSION_DATE
	,t.ISSOCS = s.ISSOCS
	,t.LAST_ACT_DATE = s.LAST_ACT_DATE
    ,t.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE = s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,t.LAST_ACT_SCA_FINAL_REPORT_DATE = s.LAST_ACT_SCA_FINAL_REPORT_DATE
    ,t.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE = s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428    
	,t.LAST_PENTEST_DATE = s.LAST_PENTEST_DATE
	,t.MEF = s.MEF
	,t.MEF_CONTEXT = s.MEF_CONTEXT
	,t.NEXT_REQUIRED_CP_TEST_DATE = s.NEXT_REQUIRED_CP_TEST_DATE
	,t.OA_STATUS = s.OA_STATUS
    ,t.OPERATED_BY = s.OPERATED_BY -- 250103 CR1059
	,t.PACKAGE_TYPE = s.PACKAGE_TYPE
    ,t.PIA_014 = s.PIA_014 -- 230621
	,t.PIA_EXPIRATION_DATE = s.PIA_EXPIRATION_DATE
	,t.PRIMARY_ISSO = s.PRIMARY_ISSO
	,t.PRIMARY_OPERATING_LOCATION = s.PRIMARY_OPERATING_LOCATION
    ,t.REASON_FOR_ATO_REQUEST = s.REASON_FOR_ATO_REQUEST
	,t.SCA = s.SCA
	,t.SCA_DATE = s.SCA_DATE
	,t.SDM = s.SDM
    ,t.SOP_REVIEW_DATE = s.SOP_REVIEW_DATE
	,t.STE_DATE = s.STE_DATE
	,t.SYSTEM_DESCRIPTION = s.SYSTEM_DESCRIPTION
--	,t.SYSTEM_ID = s.SYSTEM_ID
	,t.TLC_PHASE = s.TLC_PHASE
WHEN NOT MATCHED THEN INSERT
    (ACRONYM
    ,ACTUAL_DECOMMISION_DATE -- 231218
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE
    ,ATO_REVIEW_DATE
	,AUTH_COMMENTS
	,AUTH_DECISION
    ,AUTHORIZATION_MEMO_SIGNED_DATE
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE
    ,BO_REVIEW_DATE
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE
    ,DSPPO_REVIEW_DATE
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,INSERT_DATE
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE
    ,ISSO_SUBMISSION_DATE
	,ISSOCS
	,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230621
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
    ,REASON_FOR_ATO_REQUEST
	,PRIMARY_OPERATING_LOCATION_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE
	,STE_DATE
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
)
VALUES (
    s.ACRONYM
    ,s.ACTUAL_DECOMMISION_DATE -- 231218
	,s.ARCHER_TRACKING_ID
    ,s.ATO_EXPIRATION_DATE
    ,s.ATO_REVIEW_DATE
	,s.AUTH_COMMENTS
	,s.AUTH_DECISION
    ,s.AUTHORIZATION_MEMO_SIGNED_DATE
	,s.AUTHORIZATION_PACKAGE_NAME
    ,s.BO_RECOMMENDATION_REVIEW_DATE
    ,s.BO_REVIEW_DATE
	,s.BUSINESS_OWNER
	,s.CIO
	,s.CISO
    ,s.CISO_REVIEW_DATE
	,s.CLOUD_SERVICE_PROVIDER
    ,s.COMPONENT_ACRONYM
	,s.COMPONENT_DESCRIPTION
	,s.COMPONENT_NAME
	,s.COMPONENT_RISK_REPORTS_OVERSIGHT
	,s.CONTINGENCYEXPIRATIONDATE
	,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,s.CP_TEST_DATE
	,s.CP_TEST_RESULTS
	,s.CRA
    ,s.CRA_REVIEW_DATE
	,s.CYBERVET
	,s.DATE_AUTH_MEMO_EXPIRES
	,s.DATE_AUTH_MEMO_SIGNED
    ,NULL -- DATEDELETED
    ,NULL -- DATEMODIFIED
	,s.DCISO
    ,s.DIVISION_ACRONYM
	,s.DIVISION_DESCRIPTION
	,s.DIVISION_NAME
    ,s.DSPC_REVIEW_DATE
    ,s.DSPPO_REVIEW_DATE
	,s.E_AUTH_EXP_DATE
	,s.E_AUTH_LEVEL
	,s.E_AUTH_RISK_ASSESSMENT_DATE
	,s.FINANCIAL_SYSTEM
	,s.FIPS_199_AVAILABILITY_RATING
	,s.FIPS_199_CONFIDENTIALITY_RATING
	,s.FIPS_199_INTEGRITY_RATING
	,s.FIPS_199_OVERALL_IMPACT_RATING
	,s.FIRST_PUBLISHED_DATE
	,s.FISMA_SYSTEM
    ,s.GROUP_ACRONYM
	,s.GROUP_DESCRIPTION
	,s.GROUP_NAME
	,s.HVA_SCORE
	,s.HVASTATUS
    ,NULL -- IN_CMS_CLOUD
	,s.INFORMATION_SYSTEM_TYPE
    ,CURRENT_TIMESTAMP()
    ,:false -- IS_DATACENTER
	,:false -- IS_EXCLUDEFROMREPORTING
	,:false -- IS_HIGHRISKSYSTEM
	,s.IS_MARKETPLACE
	,:false -- IS_OPERATIONALSYSTEM
	,:false -- IS_PHANTOMSYSTEM
	,:false -- IS_SECURITYHUB_ENABLED
	,s.ISRA_REVIEW_DATE
	,s.ISRA_STATUS
	,s.ISSO
	,s.ISSO_COUNT
    ,s.ISSO_REVIEW_DATE
    ,s.ISSO_SUBMISSION_DATE
	,s.ISSOCS
	,s.LAST_ACT_DATE
    ,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,s.LAST_ACT_SCA_FINAL_REPORT_DATE
    ,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428 
	,s.LAST_PENTEST_DATE
	,s.MEF
	,s.MEF_CONTEXT
    ,NULL -- MEFSTATUS
	,s.NEXT_REQUIRED_CP_TEST_DATE
	,s.OA_STATUS
    ,NULL -- OATO_CATEGORY
    ,s.OPERATED_BY -- 250103 CR1059
	,s.PACKAGE_TYPE
    ,s.PIA_014 -- 230621
	,s.PIA_EXPIRATION_DATE
    ,NULL -- PII_PHI
	,s.PRIMARY_ISSO
	,s.PRIMARY_OPERATING_LOCATION
    ,s.REASON_FOR_ATO_REQUEST
    ,NULL -- PRIMARY_OPERATING_LOCATION_ID
	,s.SCA
	,s.SCA_DATE
	,s.SDM
    ,s.SOP_REVIEW_DATE
	,s.STE_DATE
	,s.SYSTEM_DESCRIPTION
	,s.SYSTEM_ID
	,s.TLC_PHASE
    ,0 -- TOTALPOAMWITHAPPROVEDRBD
);

Msg := ''Merge SYSTEMS complete'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

select count(1) into :RECORD_COUNT FROM CORE.SYSTEMS GROUP BY SYSTEM_ID having count(1) > 1;
IF (coalesce(:RECORD_COUNT,0) > 1) THEN
	BEGIN
    -- THERE SHOULD NEVER BE TWO RECORDS WITH THE SAME SYSTEM_ID
    ExceptionMsg := ''DUPLICATE SYSTEM_ID IN SYSTEMS TABLE''; 
    raise CRM_logic_exception;
	END;
END IF;

--
-- Set IS_EXCLUDEFROMREPORTING Boolean to True as required.
-- CFACTS or Reporting teams (rarely) want to flag a CFACTS system to no
-- be included in FISMA Reporting. These are usually test records.
--
BEGIN TRANSACTION;
UPDATE CORE.SYSTEMS
set IS_EXCLUDEFROMREPORTING = 1
WHERE SYSTEM_ID IN
(
''11''
,''123456789101112131415''
,''N/A''
,''TBD''
);
COMMIT;

BEGIN TRANSACTION;
--
-- Initialize booleans that might change over time
--
UPDATE Systems
SET Is_OperationalSystem = :False
,Is_HighRiskSystem = :False;
       
-- Set Is_OperationalSystem to True to simplify reporting filters
--     
UPDATE Systems
SET Is_OperationalSystem = :True
where TLC_Phase = ''Operate''
and Package_Type = ''Information System''
and Information_System_Type IN 
(''Major Application''
,''General Support System''
,''Minor Application \\[Stand Alone\\]'' 
,''Minor Application \\[Child\\]'');
      
-- Set Is_HighRiskSystem to True to simply reporting filters
--
UPDATE Systems
SET Is_HighRiskSystem = :True
where Is_OperationalSystem = :True
and ((HVAStatus is not null and HVAStatus = ''Yes'') 
or (MEF_Context is not null and MEF_Context <> ''N/A'') 
or FIPS_199_Overall_Impact_Rating = ''High'');
  
-- Initialize fields that are re-evaluated each run
--
UPDATE Systems
SET In_CMS_Cloud = ''No''
,MEFStatus = NULL
,OATO_Category = 0
,PII_PHI = NULL
,TotalPOAMwithApprovedRBD = 0; 
   
UPDATE Systems
SET In_CMS_Cloud = ''Yes''
where Cloud_Service_Provider like ''%Amazon Web Services%''; 
            
UPDATE Systems
SET MEFStatus = ''Yes''
where MEF_Context IS NOT NULL 
and upper(MEF_Context) <> ''N/A''; -- 231013 added upper
      
UPDATE Systems upd -- Added upd 230531
SET PII_PHI = ''Yes''
FROM Systems s
JOIN (select distinct SYSTEM_ID
    FROM CORE.PII_SYSTEM_PII_TYPES st 
    WHERE UPPER(PII_Category) IN (''PII'',''PHI'')) p on p.SYSTEM_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID; -- Added where clause 230531
      
UPDATE Systems
SET OATO_Category = 3
WHERE (HVAStatus IS NOT NULL and HVAStatus = ''Yes'')
or (MEFStatus IS NOT NULL and MEFStatus = ''Yes'')
or (FIPS_199_Overall_Impact_Rating IS NOT NULL and FIPS_199_Overall_Impact_Rating = ''High'');

UPDATE Systems
SET OATO_Category = 2
WHERE OATO_Category = 0
and ((PII_PHI IS NOT NULL and PII_PHI = ''Yes'')
or (Financial_System IS NOT NULL and Financial_System = ''Yes'')
or (FIPS_199_Overall_Impact_Rating IS NOT NULL and FIPS_199_Overall_Impact_Rating = ''Moderate''));
      
-- As per Teresa, default to 1 to catch other possible issues
UPDATE Systems
SET OATO_Category = 1
WHERE OATO_Category = 0;
      
-- 210928 2153 TotalPOAMwithApprovedRBD used in CRMP metrics (V_CRMP_TotalNumberRiskAcceptance)
UPDATE Systems upd -- Added upd 230531
set TotalPOAMwithApprovedRBD = t.TotalPOAMwithApprovedRBD
FROM Systems s
JOIN (SELECT s.System_ID,count(1) as TotalPOAMwithApprovedRBD
    FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE a 
    INNER JOIN Systems s on s.SYSTEM_ID = a.IDUID
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs pa ON a.ContentId=pa.Authorization_Package_POAMs_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs p ON p.ContentId=pa.POAMs_Authorization_Package_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Risk_Acceptance_RBD_POAMs_x_Risk_Acceptance_RBD_POAMs pr ON p.ContentId=pr.POAMs_Risk_Acceptance_RBD_POAMs_ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_Risk_Acceptance_RBD r on pr.Risk_Acceptance_RBD_POAMs_ContentId=r.ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_Risk_Acceptance_RBD_Overall_Status rs ON rs.ParentContentId=r.ContentId
    INNER JOIN APP_CFACTS.SHARED.SEC_VW_enum_RBD_Overall_Status ers on rs.Value=ers.Id
    Where upper(ers.Value)=''APPROVED WITH SIGNATURE'' -- 231017 add upper; Also CFACTS changed on or about 7/28/23. value used to be plural (Approved with Signatures)
    group by s.System_ID) t on t.System_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID; -- Added where clause 230531

--
-- SYSTEM_COMMONNAME is a supplemental table that provides the Common Name used to reference a system.
-- This value is not contained in CFACTS as an official value. It is simply used in everyday language for convenience. 
-- When a new system is added then the CommonName is the same as the official Acronym until such time as a manual
-- change is made within this table
--
INSERT into CORE.SYSTEM_COMMONNAME (COMMONNAME,SYSTEM_ID)
SELECT s.ACRONYM, s.SYSTEM_ID
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
where c.SYSTEM_ID IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''SYSTEMS table updated'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

-- 230607
-- SecurityHub data is provided manually and so the SYSTEM_SECURITYHUB_ENABLED table is a simple list
-- of systems that have SecurityHub enabled
--
UPDATE Systems upd
SET IS_SECURITYHUB_ENABLED = 1
FROM Systems s
JOIN CORE.SYSTEM_SECURITYHUB_ENABLED sh on sh.SYSTEM_ID = s.System_ID
WHERE upd.SYSTEM_ID = s.SYSTEM_ID;
COMMIT;


-- 250219 CR1079 
UPDATE SYSTEMS S
SET IS_OA_READY = CASE 
    WHEN CV.LASTSEEN_VUL IS NOT NULL 
        AND CV.HARDWARE_HOST_STATUS = ''Fully HWAM AWS Hosted'' 
        AND CV.AWS_SECHUB_ENABLED = ''Y''
    THEN TRUE
    ELSE FALSE
END
FROM BUS_CYBER_RISK_MANAGEMENT.CORE.SEC_VW_CDM_VISIBILITY_APP_CFACTS CV
WHERE S.SYSTEM_ID = CV.SYSTEM_ID
;


Msg := ''SYSTEMS update complete'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------------------------------------------------
--            ALLOCATEDCONTROL
----------------------------------------------------------------------
TRUNCATE TABLE CORE.ALLOCATEDCONTROL;

BEGIN TRANSACTION;
INSERT INTO CORE.ALLOCATEDCONTROL
	(ALLOCATION_STATUS
	,CONTROL_ELEMENT
	,CONTROL_ELEMENT_NUMBER
	,CONTROL_FAMILY
	,CONTROL_NAME
	,CONTROL_NUMBER
	,CONTROL_NUMBER_COMBO
	,CONTROL_SET_VERSION_NUMBER
	,HYBRID_CONTROL
	,INHERITABLE_BY_OTHER_SYSTEMS
	,LAST_ACT_DATE
	,LAST_ASSESSMENT_DATE
	,LAST_PENTEST_DATE
	,LAST_SCA_DATE
	,OVERALL_CONTROL_STATUS
	,PRIVATE_IMP_UPDATED_DATE
    ,PRIVATE_IMPLEMENTATION_DETAILS -- 230622
    ,REPORT_ID
	,RESPONSIBILITY
	,SHARED_IMP_UPDATED_DATE
	,SIGNIFICANT_CONTROL_CHANGE
	,SIGNIFICANT_CONTROL_CHANGE_DETAILS
	,SYSTEM_ID
	,TRACKING_ID
)
SELECT
	ALLOCATION_STATUS
	,CONTROL_ELEMENT
	,CONTROL_ELEMENT_NUMBER
	,CONTROL_FAMILY
	,CONTROL_NAME
	,CONTROL_NUMBER
	,CONTROL_NUMBER_COMBO
	,CONTROL_SET_VERSION_NUMBER
	,HYBRID_CONTROL
	,INHERITABLE_BY_OTHER_SYSTEMS
	,LAST_ACT_DATE
	,LAST_ASSESSMENT_DATE
	,LAST_PENTEST_DATE
	,LAST_SCA_DATE
	,OVERALL_CONTROL_STATUS
	,PRIVATE_IMP_UPDATED_DATE
    ,PRIVATE_IMPLEMENTATION_DETAILS -- 230622
    ,:P_Report_ID as REPORT_ID
	,RESPONSIBILITY
	,SHARED_IMP_UPDATED_DATE
	,SIGNIFICANT_CONTROL_CHANGE
	,SIGNIFICANT_CONTROL_CHANGE_DETAILS
	,SYSTEM_ID
	,TRACKING_ID
FROM CORE.VW_CFACTS_ALLOCATEDCONTROL
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            CAATHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.CAATHIST
	(ACT_CAAT_FILEPROCESSEDDATE
	,ASSESSMENT_AUDIT_COMPANY
	,CAAT_ID
	,DATE_IDENTIFIED
	,FINDING_DESCRIPTION
	,FINDING_ID
	,FINDING_TITLE
	,RELATED_POAMS
    ,REPORT_ID
	,SOURCE_AUDIT_TYPE
	,SYSTEM_ID
	,TEST_METHOD
	,TEST_OBJECTIVE
	,TEST_RESULT
	,WEAKNESS_DESCRIPTION
)
SELECT
	ACT_CAAT_FILEPROCESSEDDATE
	,ASSESSMENTAUDIT_COMPANY
	,CAAT_ID
	,DATE_IDENTIFIED
	,FINDING_DESCRIPTION
	,FINDING_ID
	,FINDING_TITLE
	,RELATED_POAMS
    ,:P_Report_ID as REPORT_ID
	,SOURCE_AUDIT_TYPE_2
	,SYSTEM_ID
	,TEST_METHOD
	,TEST_OBJECTIVE
	,TEST_RESULT
	,WEAKNESS_DESCRIPTION
FROM CORE.VW_CFACTS_CAAT
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            CEDE_MVP_POAMS_CONTROLS
-- Added 230621
----------------------------------------------------------------------
TRUNCATE TABLE CORE.CEDE_MVP_POAMS_CONTROLS;

BEGIN TRANSACTION;
INSERT INTO CORE.CEDE_MVP_POAMS_CONTROLS (
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	POAM_ID,
	REPORT_ID,
    SYSTEM_ID,
	WEAKNESS_RISK_LEVEL
)
SELECT 
Alloc.Control_Number --as Allocated Control
,eOverallStatus.Value --as Overall Status 
,p.POAM_ID
,:P_Report_ID
,s.SYSTEM_ID
,eRiskLevel.Value --as Weakness Risk Level
FROM APP_CFACTS.SHARED.SEC_VW_POAMs p
INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs pa ON p.ContentId = pa.POAMs_Authorization_Package_ContentId
INNER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package a ON a.ContentId=pa.Authorization_Package_POAMs_ContentId
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.IDUID
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status pOverallStatus on pOverallStatus.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Status_9 eOverallStatus on eOverallStatus.Id = pOverallStatus.Value
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1 pRiskLevel on pRiskLevel.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1 eRiskLevel on eRiskLevel.ID = pRiskLevel.Value
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_POAM_x_POAMs_Allocated_Control pAlloc on pAlloc.POAMs_Allocated_Control_ContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards Alloc on Alloc.ContentId = pAlloc.Allocated_Controls_POAM_ContentId;
COMMIT;

----------------------------------------------------------------------
--            MILESTONEHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.MILESTONEHIST
	(ACTUAL_COMPLETION_DATE
	,CHANGES_TO_MILESTONE
	,ESTIMATED_COMPLETION_DATE
	,LAST_UPDATED
	,MILESTONE_DESCRIPTION
	,MILESTONE_ID
	,MILESTONE_NAME
	,MILESTONE_STATUS
	,POAM_ID
    ,REPORT_ID
	,SCHEDULED_COMPLETION_DATE
	,SYSTEM_ID
)
SELECT
	ACTUAL_COMP_DATE
	,CHANGES2MS
	,EST_COMP_DATE
	,LAST_UPDATED
	,MS_DESC
	,MS_ID
	,MS_NAME
	,MS_STATUS
	,POAM_ID
    ,:P_Report_ID as REPORT_ID
	,SCHED_COMP_DATE
	,SYSTEM_ID
FROM CORE.VW_CFACTS_MILESTONE
WHERE SYSTEM_ID IS NOT NULL;
COMMIT;

----------------------------------------------------------------------
--            PIAHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.PIAHIST
	(DUE_DATE
    ,FINAL_APPROVER
    ,FINAL_APPROVER_DATE
    ,FINAL_APPROVER_STATUS
    ,HHS_PIA_REVIEW_DATE
    ,HHS_PIA_STATUS
    ,OVERALL_STATUS
    ,PIA_TRACKING_ID
    ,REPORT_ID
    ,REVIEW_DATE
    ,REVIEW_STATUS
    ,REVIEWER
    ,SUBMISSION_DATE
    ,SUBMISSION_STATUS
    ,SUBMITTER
    ,SYSTEM_ID
)
SELECT
    DUE_DATE
    ,FINAL_APPROVER
    ,FINAL_APPROVER_DATE
    ,FINAL_APPROVER_STATUS
    ,HHS_PIA_REVIEW_DATE
    ,HHS_PIA_STATUS
    ,OVERALL_STATUS
    ,PIA_TRACKING_ID
    ,:P_Report_ID as REPORT_ID
    ,REVIEW_DATE
    ,REVIEW_STATUS
    ,REVIEWER
    ,SUBMISSION_DATE
    ,SUBMISSION_STATUS
    ,SUBMITTER
    ,SYSTEM_ID
FROM CORE.VW_CFACTS_PIA
where SYSTEM_ID IS NOT NULL; -- 230317 added in SDL environment
COMMIT;

----------------------------------------------------------------------
--           POAMHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;
INSERT INTO CORE.POAMHIST
	(ACTUAL_COMPLETION_DATE,
	ACTUAL_LABOR_COST,
	CAAT,
	CAAT_ID,
    CVE,
	DAYS_OPEN,
	ESTIMATED_COMPLETION_DATE,
	FUNDING_SOURCE,
	LABOR_ESTIMATE,
	OVERALL_STATUS,
	POAM_CLOSED_DATE,
	POAM_ID,
	POAM_OWNER,
	POAM_REVIEWER,
    REPORT_ID,
	REVIEW_COMMENTS,
	REVIEW_DATE,
	REVIEW_STATUS,
	SCHEDULED_COMPLETION_DATE,
	SUBMISSION_STATUS,
	SYSTEM_ID,
	TARGET,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_ID,
	WEAKNESS_POC,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY
)
SELECT
	ACTUAL_COMPLETION_DATE
	,ACTUAL_LABOR_COST
	,CAAT
	,CAAT_ID   
    ,IFF(FINDING_ID LIKE ''KEV%'',REPLACE(FINDING_ID,''KEV'',''CVE''),IFF(FINDING_ID LIKE ''CVE%'',FINDING_ID,NULL)) as CVE --231019 CR#775
	,DAYS_OPEN
	,ESTIMATED_COMPLETION_DATE
	,FUNDING_SOURCE
	,LABOR_ESTIMATE
	,OVERALL_STATUS
	,POAM_CLOSED_DATE
	,POAM_ID
	,POAM_OWNER
	,POAM_REVIEWER
	,:P_Report_ID as REPORT_ID
	,REVIEW_COMMENTS
	,REVIEW_DATE
	,REVIEW_STATUS
	,SCHEDULED_COMPLETION_DATE
	,SUBMISSION_STATUS
	,SYSTEM_ID
	,TARGET
	,WEAKNESS_CREATION_DATE
	,WEAKNESS_ID
	,WEAKNESS_POC
	,WEAKNESS_RISK_LEVEL
	,WEAKNESS_SEVERITY
FROM CORE.VW_CFACTS_POAM
WHERE SYSTEM_ID IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Inserted into POAMHIST='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

----------------------------------------------------------------------
--           SYSTEMSHIST
----------------------------------------------------------------------
BEGIN TRANSACTION;

INSERT INTO CORE.SYSTEMSHIST
    (ACRONYM
    ,ACTUAL_DECOMMISION_DATE --240904 CR965
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE --240904 CR965
    ,ATO_REVIEW_DATE --240904 CR965
	,AUTH_COMMENTS
	,AUTH_DECISION
    ,AUTHORIZATION_MEMO_SIGNED_DATE --240904 CR965
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE --240904 CR965
    ,BO_REVIEW_DATE --240904 CR965
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE --240904 CR965
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE --240904 CR965
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
    ,DIRECTOR_COMMENT --240904 CR965
    ,DIRECTOR_COMMENT2 --240904 CR965
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE --240904 CR965
    ,DSPPO_REVIEW_DATE --240904 CR965
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,IS_CCSQ --240904 CR965
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE --240904 CR965
    ,ISSO_SUBMISSION_DATE --240904 CR965
	,ISSOCS
    ,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230623
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
	,PRIMARY_OPERATING_LOCATION_ID
    ,REASON_FOR_ATO_REQUEST --240904 CR965
	,REPORT_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE --240904 CR965
	,STE_DATE
    ,SYSTEM_CREATION_DATE --240904 CR965
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
)
SELECT
ACRONYM
    ,ACTUAL_DECOMMISION_DATE --240904 CR965
	,ARCHER_TRACKING_ID
    ,ATO_EXPIRATION_DATE --240904 CR965
    ,ATO_REVIEW_DATE --240904 CR965
	,AUTH_COMMENTS
	,AUTH_DECISION
	,AUTHORIZATION_MEMO_SIGNED_DATE --240904 CR965
	,AUTHORIZATION_PACKAGE
    ,BO_RECOMMENDATION_REVIEW_DATE --240904 CR965
    ,BO_REVIEW_DATE --240904 CR965
	,BUSINESS_OWNER
	,CIO
	,CISO
    ,CISO_REVIEW_DATE --240904 CR965
	,CLOUD_SERVICE_PROVIDER
	,COMPONENT_ACRONYM
	,COMPONENT_DESCRIPTION
	,COMPONENT_NAME
	,COMPONENT_RISK_REPORTS_OVERSIGHT
	,CONTINGENCYEXPIRATIONDATE
	,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
	,CP_TEST_DATE
	,CP_TEST_RESULTS
	,CRA
    ,CRA_REVIEW_DATE --240904 CR965
	,CYBERVET
	,DATE_AUTH_MEMO_EXPIRES
	,DATE_AUTH_MEMO_SIGNED
	,DATEDELETED
	,DATEMODIFIED
	,DCISO
    ,DIRECTOR_COMMENT --240904 CR965
    ,DIRECTOR_COMMENT2 --240904 CR965
	,DIVISION_ACRONYM
	,DIVISION_DESCRIPTION
	,DIVISION_NAME
    ,DSPC_REVIEW_DATE --240904 CR965
    ,DSPPO_REVIEW_DATE --240904 CR965
	,E_AUTH_EXP_DATE
	,E_AUTH_LEVEL
	,E_AUTH_RISK_ASSESSMENT_DATE
	,FINANCIAL_SYSTEM
	,FIPS_199_AVAILABILITY_RATING
	,FIPS_199_CONFIDENTIALITY_RATING
	,FIPS_199_INTEGRITY_RATING
	,FIPS_199_OVERALL_IMPACT_RATING
	,FIRST_PUBLISHED_DATE
	,FISMA_SYSTEM
	,GROUP_ACRONYM
	,GROUP_DESCRIPTION
	,GROUP_NAME
	,HVA_SCORE
	,HVASTATUS
	,IN_CMS_CLOUD
	,INFORMATION_SYSTEM_TYPE
    ,IS_CCSQ --240904 CR965
	,IS_DATACENTER
	,IS_EXCLUDEFROMREPORTING
	,IS_HIGHRISKSYSTEM
	,IS_MARKETPLACE
	,IS_OPERATIONALSYSTEM
	,IS_PHANTOMSYSTEM
	,IS_SECURITYHUB_ENABLED
	,ISRA_REVIEW_DATE
	,ISRA_STATUS
	,ISSO
	,ISSO_COUNT
    ,ISSO_REVIEW_DATE --240904 CR965
    ,ISSO_SUBMISSION_DATE --240904 CR965
	,ISSOCS
    ,LAST_ACT_DATE
    ,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428 
	,LAST_ACT_SCA_FINAL_REPORT_DATE
    ,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE  -- 230428
	,LAST_PENTEST_DATE
	,MEF
	,MEF_CONTEXT
	,MEFSTATUS
	,NEXT_REQUIRED_CP_TEST_DATE
	,OA_STATUS
	,OATO_CATEGORY
    ,OPERATED_BY -- 250103 CR1059
	,PACKAGE_TYPE
    ,PIA_014 -- 230623
	,PIA_EXPIRATION_DATE
	,PII_PHI
	,PRIMARY_ISSO
	,PRIMARY_OPERATING_LOCATION
	,PRIMARY_OPERATING_LOCATION_ID
    ,REASON_FOR_ATO_REQUEST --240904 CR965
	,:P_Report_ID as REPORT_ID
	,SCA
	,SCA_DATE
	,SDM
    ,SOP_REVIEW_DATE --240904 CR965
	,STE_DATE
    ,INSERT_DATE AS SYSTEM_CREATION_DATE --240904 CR965
	,SYSTEM_DESCRIPTION
	,SYSTEM_ID
	,TLC_PHASE
	,TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Inserted into SYSTEMSHIST='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;


----------------------------------------------------------------------
--            CFACTS_USERMAPPING
----------------------------------------------------------------------
TRUNCATE TABLE CORE.CFACTS_USERMAPPING;

BEGIN TRANSACTION;
INSERT INTO CORE.CFACTS_USERMAPPING
	(ACRONYM
	,ROLE
	,SYSTEM_ID
	,USER_ID
)
SELECT
    ACRONYM
	,ROLE
	,SYSTEM_ID
	,USER_ID
FROM CORE.VW_CFACTS_USERMAPPING;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CROWDSTRIKE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CROWDSTRIKE data into CRM'
EXECUTE AS OWNER
AS '
--
-- 240820 as of creation of this SP, found that all Crowdstrike data had ASSET_ID_TATTOO populated.
-- Population examined was from 8/2/24 thru 8/20/24.
--
declare
Appl varchar := ''SP_CRM_PULL_CROWDSTRIKE'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''CROWDSTRIKE'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);
--
-- 240821 CR958; creation of this stored procedure
--

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_HWAM (
ASSET_ID_TAG
,ASSET_ID_TATTOO
,DATACENTER_ID
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DEVICE_TYPE
,FISMA_ID_TAG
,FQDN
,HOSTNAME
,INSERT_DATE
,IPV4
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,MACADDRESS
,OS
,OS_BUILD_NUMBER
,LAST_CONFIRMED_TIME
,REPORTDATE
,ROWDISPOSITION
,SYSTEM_ID
,SNAPSHOT_ID
,SOURCE_TOOL
)
SELECT
cs.ASSET_ID as ASSET_ID_TAG
,cs.ASSET_ID as ASSET_ID_TATTOO
,cs.DATA_CENTER as DATACENTER_ID
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,cs.TYPE as DEVICE_TYPE
--,FILENAME
,cs.FISMA_TAG as FISMA_ID_TAG
,STRTOK_TO_ARRAY(cs.FQDN,'','') as FQDN
,STRTOK_TO_ARRAY(cs.HOSTNAME,'','') as HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,cs.IP_ADDRESSES as IPV4
,0 as IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,cs.MAC_ADDRESSES as MACADDRESS
,cs.OS
,cs.OS_BUILD_NUMBER
-- ,SNOWPIPE_LOAD_TS
-- ,TAG always empty. Purpose unknown
,cs.TIMESTAMP as LAST_CONFIRMED_TIME
,cs.S3_FILE_TS as REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,cs.FISMA_TAG as SYSTEM_ID
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
FROM APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE cs
JOIN (select r1.DATA_CENTER,r1.ASSET_ID,r1.TIMESTAMP
FROM (select rank()over(partition by DATA_CENTER,ASSET_ID order by TIMESTAMP desc) TheRank,DATA_CENTER,ASSET_ID,TIMESTAMP
    from APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE
    WHERE S3_FILE_TS > :PreviousPullDatetime) r1 where r1.TheRank = 1) t on t.DATA_CENTER = cs.DATA_CENTER and t.ASSET_ID = cs.ASSET_ID and t.TIMESTAMP = cs.TIMESTAMP
WHERE cs.S3_FILE_TS > :PreviousPullDatetime
;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
    ROLLBACK;
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_HWAM='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE WHERE S3_FILE_TS > :PreviousPullDatetime);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE WHERE S3_FILE_TS > :PreviousPullDatetime);

If (:RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
-- 
-- 240820 found Tenant ID to contain lowercase character therefore must use upper function to parse
--
UPDATE CORE.RAW_HWAM upd
set ASSET_ID_TATTOO = p.ASSET_ID_TATTOO -- 240827 CR-TBD
,DATACENTER_ID = p.DATACENTER_ID -- 240827 CR-TBD
,TENANT_ID = p.TENANT_ID -- 240827 CR-TBD
FROM CORE.RAW_HWAM r
join table(CORE.FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG)) p -- 240827 CR-TBD
where r.SNAPSHOT_ID = :SNAPSHOT_ID 
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG) = 1 -- 240827 CR-TBD
and r.ASSET_ID_TAG IS NOT NULL -- 240916 1459 CR-EBF
and upd.RAW_HWAM_ID = r.RAW_HWAM_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''Tenant tags assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_CROWDSTRIKE_NEW"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CROWDSTRIKE data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 240820 as of creation of this SP, found that all Crowdstrike data had ASSET_ID_TATTOO populated.
-- Population examined was from 8/2/24 thru 8/20/24.
--
declare
Appl varchar := ''SP_CRM_PULL_CROWDSTRIKE_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''CROWDSTRIKE'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);
--
-- 240821 CR958; creation of this stored procedure
--

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);
*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_DATA (
ASSET_ID_TAG
,ASSET_ID_TATTOO
,DATACENTER_ID
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DEVICETYPE
,FISMA_ID_TAG
,FQDN
,HOSTNAME
,INSERT_DATE
,IPV4
,IS_SYSTEM_ID_DEFAULTED_TO_DC
,MACADDRESS
,OS
,OS_BUILD_NUMBER
,LAST_SEEN
,REPORTDATE
,ROWDISPOSITION
,SYSTEM_ID
,SNAPSHOT_ID
,SOURCE_TOOL
)
SELECT
cs.ASSET_ID as ASSET_ID_TAG
,cs.ASSET_ID as ASSET_ID_TATTOO
,cs.DATA_CENTER as DATACENTER_ID
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,cs.TYPE as DEVICE_TYPE
--,FILENAME
,cs.FISMA_TAG as FISMA_ID_TAG
,STRTOK_TO_ARRAY(cs.FQDN,'','') as FQDN
,STRTOK_TO_ARRAY(cs.HOSTNAME,'','') as HOSTNAME
,CURRENT_TIMESTAMP() as INSERT_DATE
,cs.IP_ADDRESSES as IPV4
,0 as IS_SYSTEM_ID_DEFAULTED_TO_DC
,cs.MAC_ADDRESSES as MACADDRESS
,cs.OS
,cs.OS_BUILD_NUMBER
-- ,SNOWPIPE_LOAD_TS
-- ,TAG always empty. Purpose unknown
,cs.TIMESTAMP as LAST_SEEN
,cs.S3_FILE_TS as REPORTDATE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,cs.FISMA_TAG as SYSTEM_ID
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
FROM APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE cs
JOIN (select r1.DATA_CENTER,r1.ASSET_ID,r1.TIMESTAMP
FROM (select rank()over(partition by DATA_CENTER,ASSET_ID order by TIMESTAMP desc) TheRank,DATA_CENTER,ASSET_ID,TIMESTAMP
    from APP_CROWDSTRIKE.SHARED.SEC_VW_CROWDSTRIKE
    WHERE S3_FILE_TS > :PreviousPullDatetime) r1 where r1.TheRank = 1) t on t.DATA_CENTER = cs.DATA_CENTER and t.ASSET_ID = cs.ASSET_ID and t.TIMESTAMP = cs.TIMESTAMP
WHERE cs.S3_FILE_TS > :PreviousPullDatetime
;

RECORD_COUNT := SQLROWCOUNT;

COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;



BEGIN TRANSACTION;
-- 
-- 240820 found Tenant ID to contain lowercase character therefore must use upper function to parse
--
UPDATE CORE.RAW_DATA upd
set ASSET_ID_TATTOO = p.ASSET_ID_TATTOO -- 240827 CR-TBD
,DATACENTER_ID = p.DATACENTER_ID -- 240827 CR-TBD
,TENANT_ID = p.TENANT_ID -- 240827 CR-TBD
FROM CORE.RAW_DATA r
join table(CORE.FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG)) p -- 240827 CR-TBD
where r.SNAPSHOT_ID = :SNAPSHOT_ID 
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG) = 1 -- 240827 CR-TBD
and r.ASSET_ID_TAG IS NOT NULL -- 240916 1459 CR-EBF
and upd.RAW_ID = r.RAW_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''Tenant tags assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_NEW"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into RAW_DATA table and prep Forescout specific data'
EXECUTE AS OWNER
AS '
--
-- 240705 CR926 Dedupe Forescout HWAM - This is what facilitated creation of SP_CRM_PULL_FORESCOUT_V2
--
-- 240326 Elliot
-- "Anything with VA in the name is discovered via HPS inspection or nmap interrogation. HWI is usually any discovered fields based on manufacturer, 
-- but I may need to look at that in more detail for a better answer."
--
--
declare
Appl varchar := ''SP_CRM_PULL_FORESCOUT_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);
*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;



Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_DATA (
DATACENTER_ID
,FS_FISMA_ID_TAG_WINDOWSINST
,FS_LINUX_FISMA_ID
,FS_FISMA_ID_TAG_GROUPS
,FISMA_ID_TAG -- 240808 CR950
,SYSTEM_ID
,FS_ASSET_ID_TAG_WINDOWSINST
,FS_LINUX_ASSET_ID
,ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TATTOO
,DATA_ERROR_ARRAY -- 240730 CR942
,DATA_WARNING_ARRAY -- 240730 CR942
,DEVICETYPE
,FQDN
,FS_APPLIANCE_IP
,FS_HWI_MOTHERBOARD
,FS_HWI_PROCESSOR
,FS_LINUX_HOSTNAME
,FS_LINUX_OPERATING_SYSTEM
,FS_LINUX_RUNNING_PROCESSES
,FS_NETBIOS_DOMAIN
,FS_VA_OS
,FS_VA_OS_CPE
,FS_WINDOWS_APPLICATIONS_INSTALLED
,INSERT_DATE
,IPV4
,IPV6
,IS_FS_MANAGED -- 240708
,IS_SYSTEM_ID_DEFAULTED_TO_DC
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_CPE
,ROWDISPOSITION -- 240730 CR942
,SNAPSHOT_ID
,SOURCE_TOOL
,FS_SENDER_INFO_DATE
,LAST_SEEN
,REPORTDATE
)
SELECT 
CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(GROUPS) as DATACENTER_ID
,CORE.FN_CRM_PARSE_FORESCOUT_FISMA_ID_V2(WINDOWS_APPLICATIONS_INSTALLED) as FS_FISMA_ID_TAG_WINDOWSINST
,TRIM(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(split_part(LINUX_FISMA_ID,''/var/CMS/FISMA/Primary_FISMA_ID/'',2))) as FS_LINUX_FISMA_ID -- 240705 CR926 fixed to prevent $ in result
,CORE.FN_CRM_PARSE_FORESCOUT_FISMA_ID(GROUPS) as FS_FISMA_ID_TAG_GROUPS
-- 
-- 250107 Elliot indicated GROUPS should continue to be used since sometimes it contains the FISMA ID
-- specifically mapped to the Appliance that the data comes from
--
,coalesce(FS_FISMA_ID_TAG_WINDOWSINST,FS_LINUX_FISMA_ID,FS_FISMA_ID_TAG_GROUPS) as FISMA_ID_TAG -- 240808 CR950
,FISMA_ID_TAG as SYSTEM_ID -- 240808 CR950
,CORE.FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2(WINDOWS_APPLICATIONS_INSTALLED) as FS_ASSET_ID_TAG_WINDOWSINST
,TRIM(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(split_part(LINUX_ASSET_ID,''/var/CMS/FISMA/Asset_ID/'',2))) as FS_LINUX_ASSET_ID -- 240705 CR926 fixed to prevent $ in result
,coalesce(FS_ASSET_ID_TAG_WINDOWSINST,FS_LINUX_ASSET_ID) as ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TAG as ASSET_ID_TATTOO
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240730 CR942
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240730 CR942
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(ASSET_FUNCTION) as DEVICE_TYPE
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(DNS_NAME),'','') as FQDN
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(APPLIANCE_IP) as FS_APPLIANCE_IP
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_MOTHERBOARD) as FS_HWI_MOTHERBOARD
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_PROCESSOR) as FS_HWI_PROCESSOR
-- LABEL_LIST is not reliable at this time
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_HOSTNAME) as FS_LINUX_HOSTNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_OPERATING_SYSTEM) as FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES as FS_LINUX_RUNNING_PROCESSES
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_DOMAIN) as FS_NETBIOS_DOMAIN
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS) as FS_VA_OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS_CPE) as FS_VA_OS_CPE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(WINDOWS_APPLICATIONS_INSTALLED) as FS_WINDOWS_APPLICATIONS_INSTALLED
,CURRENT_TIMESTAMP() as INSERT_DATE
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV4),'','') as IPV4
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV6),'','') as IPV6
,case coalesce((CHARINDEX(''Managed NIX Devices'',GROUPS,1) > 0 or CHARINDEX(''Managed Windows'',GROUPS,1) > 0),0) -- 240708 as per Elliot Levy
        when 0 then ''0''
        Else ''1''
End as IS_FS_MANAGED
,0 as IS_SYSTEM_ID_DEFAULTED_TO_DC -- 240730 CR942
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MAC_ADDRESS),'','') as MACADDRESS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MOTHERBOARD_SN) as MOTHERBOARD
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_HOSTNAME),'','') as NETBIOSNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OPERATING_SYSTEM) as OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OS_CPE) as OS_CPE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240730 CR942
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
,MAX(date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END || ''-'' || substring(SENDER_INFO,5,11) )::datetime as FS_SENDER_INFO_DATE
,FS_SENDER_INFO_DATE as LAST_SEEN
,MIN(S3_FILE_TS) as REPORTDATE -- $$$ WHY THE NEED FOR MIN
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousPullDatetime
group by
DATACENTER_ID
,FS_FISMA_ID_TAG_WINDOWSINST
,FS_LINUX_FISMA_ID
,FS_FISMA_ID_TAG_GROUPS
,FISMA_ID_TAG -- 240808 CR950
,SYSTEM_ID
,FS_ASSET_ID_TAG_WINDOWSINST
,FS_LINUX_ASSET_ID
,ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TATTOO
,DATA_ERROR_ARRAY -- 240730 CR942
,DATA_WARNING_ARRAY -- 240730 CR942
,DEVICE_TYPE
,FQDN
,FS_APPLIANCE_IP
,FS_HWI_MOTHERBOARD
,FS_HWI_PROCESSOR
,FS_LINUX_HOSTNAME
,FS_LINUX_OPERATING_SYSTEM
,FS_LINUX_RUNNING_PROCESSES
,FS_NETBIOS_DOMAIN
,FS_VA_OS
,FS_VA_OS_CPE
,ROWDISPOSITION -- 240730 CR942
,FS_WINDOWS_APPLICATIONS_INSTALLED
,IPV4
,IPV6
,IS_FS_MANAGED -- 240708
,IS_SYSTEM_ID_DEFAULTED_TO_DC -- 240730 CR942
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_CPE
;

RECORD_COUNT := SQLROWCOUNT;

COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

-------------------------------------------------------------------------------
--
-- PREP THE DATA
--
-------------------------------------------------------------------------------

BEGIN TRANSACTION;
--
-- 240410 CR 867 Implement DRaaS multi-tenant tag
--
UPDATE CORE.RAW_DATA upd
set ASSET_ID_TATTOO = p.ASSET_ID_TATTOO -- 240827 CR-TBD
,DATACENTER_ID = p.DATACENTER_ID -- 240827 CR-TBD
,TENANT_ID = p.TENANT_ID -- 240827 CR-TBD
FROM CORE.RAW_DATA r
join table(CORE.FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG)) p -- 240827 CR-TBD
where r.SNAPSHOT_ID = :SNAPSHOT_ID 
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG) = 1 -- 240827 CR-TBD
and r.ASSET_ID_TAG IS NOT NULL -- 240916 1459 CR-EBF
and upd.RAW_ID = r.RAW_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''Tenant tags assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
-- Clean FS_LINUX_HOSTNAME
UPDATE CORE.RAW_DATA
set FS_LINUX_HOSTNAME = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and ((upper(FS_LINUX_HOSTNAME) LIKE ''%LAST LOGIN:%'') or upper(FS_LINUX_HOSTNAME) LIKE ''%TOO MANY LOGINS%''
    or upper(FS_LINUX_HOSTNAME) LIKE ''%CONNECTION RESET BY%'');
COMMIT;

BEGIN TRANSACTION;
-- Set HOSTNAME to FS_LINUX_HOSTNAME when HOSTNAME is null
UPDATE CORE.RAW_DATA
set HOSTNAME = STRTOK_TO_ARRAY(FS_LINUX_HOSTNAME)
where SNAPSHOT_ID = :SNAPSHOT_ID and HOSTNAME IS NULL and FS_LINUX_HOSTNAME IS NOT NULL;
COMMIT;

BEGIN TRANSACTION;
-- Extract FS_HWI_MOTHERBOARD
-- Remove leading/trailing forward-slash and period
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_DATA
set FS_HWI_MOTHERBOARD = TRIM(SUBSTRING(FS_HWI_MOTHERBOARD,(POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) + 15),(POSITION(''SKU:'',FS_HWI_MOTHERBOARD,1) - POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) - 16 )),''/.'')
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) > 0;
COMMIT;
BEGIN TRANSACTION;
-- Clean FS_HWI_MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_DATA
set FS_HWI_MOTHERBOARD = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (upper(FS_HWI_MOTHERBOARD) LIKE ''%ERROR%'' or upper(FS_HWI_MOTHERBOARD) LIKE ''%NOT RECOGNIZED%''    
    or FS_HWI_MOTHERBOARD IN (''No Instance(s) Available.'',''Type2 - Board Serial Number'',''None''));
COMMIT;
BEGIN TRANSACTION;
-- Extract MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_DATA
set MOTHERBOARD = TRIM(SUBSTRING(MOTHERBOARD,(POSITION(''SerialNumber='',MOTHERBOARD,1) + 13),(POSITION(''Version='',MOTHERBOARD,1) - POSITION(''SerialNumber='',MOTHERBOARD,1) - 14 )),''/.'')
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''SerialNumber='',MOTHERBOARD,1) > 0;
COMMIT;
BEGIN TRANSACTION;
-- Clean MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_DATA
set MOTHERBOARD = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (upper(MOTHERBOARD) LIKE ''%ERROR%'' or upper(MOTHERBOARD) LIKE ''%NOT RECOGNIZED%''    
    or MOTHERBOARD IN (''No Instance(s) Available.'',''Type2 - Board Serial Number'',''None''));
COMMIT;
BEGIN TRANSACTION;
-- Set MOTHERBOARD to FS_HWI_MOTHERBOARD when MOTHERBOARD is null
UPDATE CORE.RAW_DATA
set MOTHERBOARD = FS_HWI_MOTHERBOARD
where SNAPSHOT_ID = :SNAPSHOT_ID and MOTHERBOARD IS NULL and FS_HWI_MOTHERBOARD IS NOT NULL;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.RAW_DATA
set OS = coalesce(OS,FS_VA_OS,FS_LINUX_OPERATING_SYSTEM)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.RAW_DATA
set OS_CPE = coalesce(OS_CPE,FS_VA_OS_CPE)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_V3"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT and prep Forescout specific data'
EXECUTE AS OWNER
AS '
--
-- 240705 CR926 Dedupe Forescout HWAM - This is what facilitated creation of SP_CRM_PULL_FORESCOUT_V2
--
-- 240326 Elliot
-- "Anything with VA in the name is discovered via HPS inspection or nmap interrogation. HWI is usually any discovered fields based on manufacturer, 
-- but I may need to look at that in more detail for a better answer."
--
--
declare
Appl varchar := ''SP_CRM_PULL_FORESCOUT_V3'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousPullDatetime TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_HWAM (
DATACENTER_ID
,FS_FISMA_ID_TAG_WINDOWSINST
,FS_LINUX_FISMA_ID
,FS_FISMA_ID_TAG_GROUPS
,FISMA_ID_TAG -- 240808 CR950
,SYSTEM_ID
,FS_ASSET_ID_TAG_WINDOWSINST
,FS_LINUX_ASSET_ID
,ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TATTOO
,DATA_ERROR_ARRAY -- 240730 CR942
,DATA_WARNING_ARRAY -- 240730 CR942
,DEVICE_TYPE
,FQDN
,FS_APPLIANCE_IP
,FS_HWI_MOTHERBOARD
,FS_HWI_PROCESSOR
,FS_LINUX_HOSTNAME
,FS_LINUX_OPERATING_SYSTEM
,FS_LINUX_RUNNING_PROCESSES
,FS_NETBIOS_DOMAIN
,FS_VA_OS
,FS_VA_OS_CPE
,FS_WINDOWS_APPLICATIONS_INSTALLED
,INSERT_DATE
,IPV4
,IPV6
,IS_FS_MANAGED -- 240708
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC -- 240730 CR942
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_CPE
,ROWDISPOSITION -- 240730 CR942
,SNAPSHOT_ID
,SOURCE_TOOL
,FS_SENDER_INFO_DATE
,LAST_CONFIRMED_TIME
,REPORTDATE
)
SELECT 
CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(GROUPS) as DATACENTER_ID
,CORE.FN_CRM_PARSE_FORESCOUT_FISMA_ID_V2(WINDOWS_APPLICATIONS_INSTALLED) as FS_FISMA_ID_TAG_WINDOWSINST
,TRIM(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(split_part(LINUX_FISMA_ID,''/var/CMS/FISMA/Primary_FISMA_ID/'',2))) as FS_LINUX_FISMA_ID -- 240705 CR926 fixed to prevent $ in result
,CORE.FN_CRM_PARSE_FORESCOUT_FISMA_ID(GROUPS) as FS_FISMA_ID_TAG_GROUPS
,coalesce(FS_FISMA_ID_TAG_WINDOWSINST,FS_LINUX_FISMA_ID,FS_FISMA_ID_TAG_GROUPS) as FISMA_ID_TAG -- 240808 CR950
,FISMA_ID_TAG as SYSTEM_ID -- 240808 CR950
,CORE.FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2(WINDOWS_APPLICATIONS_INSTALLED) as FS_ASSET_ID_TAG_WINDOWSINST
,TRIM(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(split_part(LINUX_ASSET_ID,''/var/CMS/FISMA/Asset_ID/'',2))) as FS_LINUX_ASSET_ID -- 240705 CR926 fixed to prevent $ in result
,coalesce(FS_ASSET_ID_TAG_WINDOWSINST,FS_LINUX_ASSET_ID) as ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TAG as ASSET_ID_TATTOO
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240730 CR942
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240730 CR942
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(ASSET_FUNCTION) as DEVICE_TYPE
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(DNS_NAME),'','') as FQDN
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(APPLIANCE_IP) as FS_APPLIANCE_IP
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_MOTHERBOARD) as FS_HWI_MOTHERBOARD
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_PROCESSOR) as FS_HWI_PROCESSOR
-- LABEL_LIST is not reliable at this time
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_HOSTNAME) as FS_LINUX_HOSTNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_OPERATING_SYSTEM) as FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES as FS_LINUX_RUNNING_PROCESSES
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_DOMAIN) as FS_NETBIOS_DOMAIN
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS) as FS_VA_OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS_CPE) as FS_VA_OS_CPE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(WINDOWS_APPLICATIONS_INSTALLED) as FS_WINDOWS_APPLICATIONS_INSTALLED
,CURRENT_TIMESTAMP() as INSERT_DATE
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV4),'','') as IPV4
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV6),'','') as IPV6
,case coalesce((CHARINDEX(''Managed NIX Devices'',GROUPS,1) > 0 or CHARINDEX(''Managed Windows'',GROUPS,1) > 0),0) -- 240708 as per Elliot Levy
        when 0 then ''0''
        Else ''1''
End as IS_FS_MANAGED
,0 as IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC -- 240730 CR942
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MAC_ADDRESS),'','') as MACADDRESS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MOTHERBOARD_SN) as MOTHERBOARD
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_HOSTNAME),'','') as NETBIOSNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OPERATING_SYSTEM) as OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OS_CPE) as OS_CPE
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240730 CR942
,:SNAPSHOT_ID as SNAPSHOT_ID
,:Datacategory as SOURCE_TOOL
,MAX(date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END || ''-'' || substring(SENDER_INFO,5,11) )::datetime as FS_SENDER_INFO_DATE
,FS_SENDER_INFO_DATE as LAST_CONFIRMED_TIME
,MIN(S3_FILE_TS) as REPORTDATE
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousPullDatetime
group by
DATACENTER_ID
,FS_FISMA_ID_TAG_WINDOWSINST
,FS_LINUX_FISMA_ID
,FS_FISMA_ID_TAG_GROUPS
,FISMA_ID_TAG -- 240808 CR950
,SYSTEM_ID
,FS_ASSET_ID_TAG_WINDOWSINST
,FS_LINUX_ASSET_ID
,ASSET_ID_TAG -- 240808 CR950
,ASSET_ID_TATTOO
,DATA_ERROR_ARRAY -- 240730 CR942
,DATA_WARNING_ARRAY -- 240730 CR942
,DEVICE_TYPE
,FQDN
,FS_APPLIANCE_IP
,FS_HWI_MOTHERBOARD
,FS_HWI_PROCESSOR
,FS_LINUX_HOSTNAME
,FS_LINUX_OPERATING_SYSTEM
,FS_LINUX_RUNNING_PROCESSES
,FS_NETBIOS_DOMAIN
,FS_VA_OS
,FS_VA_OS_CPE
,ROWDISPOSITION -- 240730 CR942
,FS_WINDOWS_APPLICATIONS_INSTALLED
,IPV4
,IPV6
,IS_FS_MANAGED -- 240708
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC -- 240730 CR942
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_CPE
;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_HWAM='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousPullDatetime);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousPullDatetime);

If (:RECORD_COUNT > 0) THEN -- 240726 prefixed RECORD_COUNT with colon
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

-- CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Finished Pull'');

/********************************* 240827 CR-TBD let prep phase validate the SYSTEM_ID
BEGIN TRANSACTION;
-- Clean SYSTEM_ID
UPDATE CORE.RAW_HWAM
set SYSTEM_ID = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and ((upper(SYSTEM_ID) LIKE ''%NO SUCH FILE OR DIRECTORY%'') 
    or upper(SYSTEM_ID) LIKE ''%PERMISSION DENIED%'')
    or SYSTEM_ID = ''/var/CMS/FISMA/Primary_FISMA_ID'';

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Cleaned SYSTEM_ID='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*******************************************************************/

/********************************* 240827 CR-TBD let prep phase validate the ASSET_ID_TATTOO
BEGIN TRANSACTION;
-- Clean ASSET_ID_TATTOO
UPDATE CORE.RAW_HWAM
set ASSET_ID_TATTOO = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and ((upper(ASSET_ID_TATTOO) LIKE ''%NO SUCH FILE OR DIRECTORY%'') or upper(ASSET_ID_TATTOO) LIKE ''%PERMISSION DENIED%''
    or upper(ASSET_ID_TATTOO) LIKE ''%OPERATION NOT PERMITTED%'' or upper(ASSET_ID_TATTOO) LIKE ''%NOT FOUND%''
    or ASSET_ID_TATTOO = ''/var/CMS/FISMA/Asset_ID'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Cleaned ASSET_ID_TATTOO='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*******************************************************************/


BEGIN TRANSACTION;
--
-- 240410 CR 867 Implement DRaaS multi-tenant tag
--
UPDATE CORE.RAW_HWAM upd
set ASSET_ID_TATTOO = p.ASSET_ID_TATTOO -- 240827 CR-TBD
,DATACENTER_ID = p.DATACENTER_ID -- 240827 CR-TBD
,TENANT_ID = p.TENANT_ID -- 240827 CR-TBD
FROM CORE.RAW_HWAM r
join table(CORE.FN_CRM_PARSE_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG)) p -- 240827 CR-TBD
where r.SNAPSHOT_ID = :SNAPSHOT_ID 
and CORE.FN_CRM_IS_VALID_DRAAS_ASSET_ID_TATTOO(r.ASSET_ID_TAG) = 1 -- 240827 CR-TBD
and r.ASSET_ID_TAG IS NOT NULL -- 240916 1459 CR-EBF
and upd.RAW_HWAM_ID = r.RAW_HWAM_ID;

RECORD_COUNT := SQLROWCOUNT;

Msg := ''Tenant tags assigned='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
-- Clean FS_LINUX_HOSTNAME
UPDATE CORE.RAW_HWAM
set FS_LINUX_HOSTNAME = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and ((upper(FS_LINUX_HOSTNAME) LIKE ''%LAST LOGIN:%'') or upper(FS_LINUX_HOSTNAME) LIKE ''%TOO MANY LOGINS%''
    or upper(FS_LINUX_HOSTNAME) LIKE ''%CONNECTION RESET BY%'');
COMMIT;

BEGIN TRANSACTION;
-- Set HOSTNAME to FS_LINUX_HOSTNAME when HOSTNAME is null
UPDATE CORE.RAW_HWAM
set HOSTNAME = STRTOK_TO_ARRAY(FS_LINUX_HOSTNAME)
where SNAPSHOT_ID = :SNAPSHOT_ID and HOSTNAME IS NULL and FS_LINUX_HOSTNAME IS NOT NULL;
COMMIT;

BEGIN TRANSACTION;
-- Extract FS_HWI_MOTHERBOARD
-- Remove leading/trailing forward-slash and period
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_HWAM
set FS_HWI_MOTHERBOARD = TRIM(SUBSTRING(FS_HWI_MOTHERBOARD,(POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) + 15),(POSITION(''SKU:'',FS_HWI_MOTHERBOARD,1) - POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) - 16 )),''/.'')
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''Serial Number: '',FS_HWI_MOTHERBOARD,1) > 0;
COMMIT;
BEGIN TRANSACTION;
-- Clean FS_HWI_MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_HWAM
set FS_HWI_MOTHERBOARD = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (upper(FS_HWI_MOTHERBOARD) LIKE ''%ERROR%'' or upper(FS_HWI_MOTHERBOARD) LIKE ''%NOT RECOGNIZED%''    
    or FS_HWI_MOTHERBOARD IN (''No Instance(s) Available.'',''Type2 - Board Serial Number'',''None''));
COMMIT;
BEGIN TRANSACTION;
-- Extract MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_HWAM
set MOTHERBOARD = TRIM(SUBSTRING(MOTHERBOARD,(POSITION(''SerialNumber='',MOTHERBOARD,1) + 13),(POSITION(''Version='',MOTHERBOARD,1) - POSITION(''SerialNumber='',MOTHERBOARD,1) - 14 )),''/.'')
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''SerialNumber='',MOTHERBOARD,1) > 0;
COMMIT;
BEGIN TRANSACTION;
-- Clean MOTHERBOARD
-- Raw value contains several fields that we may want to use in the future
UPDATE CORE.RAW_HWAM
set MOTHERBOARD = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (upper(MOTHERBOARD) LIKE ''%ERROR%'' or upper(MOTHERBOARD) LIKE ''%NOT RECOGNIZED%''    
    or MOTHERBOARD IN (''No Instance(s) Available.'',''Type2 - Board Serial Number'',''None''));
COMMIT;
BEGIN TRANSACTION;
-- Set MOTHERBOARD to FS_HWI_MOTHERBOARD when MOTHERBOARD is null
UPDATE CORE.RAW_HWAM
set MOTHERBOARD = FS_HWI_MOTHERBOARD
where SNAPSHOT_ID = :SNAPSHOT_ID and MOTHERBOARD IS NULL and FS_HWI_MOTHERBOARD IS NOT NULL;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.RAW_HWAM
set OS = coalesce(OS,FS_VA_OS,FS_LINUX_OPERATING_SYSTEM)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.RAW_HWAM
set OS_CPE = coalesce(OS_CPE,FS_VA_OS_CPE)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_IUSG_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS (IUSG) TENABLE data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_IUSG_VUL'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AWS VUL''; -- 240115
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE -- 240710 CR928
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AWS_ACCOUNTID
,AWS_INSTANCE_ID
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY -- 240710 CR928
,DATA_WARNING_ARRAY -- 240710 CR928
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,SYSTEM_ID -- 240724 CR940
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG -- 240827 CR-TBD
,FISMA_ID_TAG -- 240827 CR-TBD
) 
SELECT
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE -- 240710 CR928
,instanceid as ASSET_ID_TATTOO -- 240528 CR901
,ASSETEXPOSURESCORE
,accountid as AWS_ACCOUNTID
,instanceid as AWS_INSTANCE_ID
,coalesce(NULLIF(BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,BID
,CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,CPE
,NULL as CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,CVE
,coalesce(NULLIF(BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
,coalesce(NULLIF(CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240710 CR928
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240710 CR928
,coalesce(DATACENTER_ID,''InstanceID not in SEC_VW_HWAM_AWS'') as DATACENTER_ID -- 240724 CR940
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,NULL as FISMASEVERITY
,coalesce(NULLIF(HAS_BEEN_MITIGATED,''''),''0'')::NUMBER as HAS_BEEN_MITIGATED
,NULL as HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS -- 240710 CR928
,NETBIOSNAME
,0 as NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PATCHPUB_DATE) as PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,NULL as PRIMARY_FISMA_ID -- 240528 CR901
,NULL as PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,S3_FILE_CREATE as REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240710 CR928
,NULL as SCAN_POLICY_NAME
,NULL as SCAN_POLICY_UID
,NULL as SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,:SNAPSHOT_ID
,SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,STIGSEVERITY
,SYNOPSIS
,coalesce(SYSTEM_ID,''Not in FISMA_LOOKUP'') as THE_SYSTEM_ID -- 240724 CR940
,TEMPORAL_SCORE
,UUID as TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,STRTOK_TO_ARRAY(VPRCONTEXT,'','') as VPRCONTEXT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(VULN_PUB_DATE) as VULN_PUB_DATE
,XREF
,instanceid as ASSET_ID_TAG -- 240827 CR-TBD
,THE_SYSTEM_ID as FISMA_ID_TAG -- 240827 CR-TBD
FROM CORE.VW_IUSG_CUMULATIVE_VULNS -- 240724 CR940
WHERE S3_FILE_CREATE > :PreviousPullDatetime;

COMMIT;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_IUSG_VUL_MITIGATED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull AWS (IUSG) TENABLE MITIGATED data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_IUSG_VUL_MITIGATED'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''AWS VUL MITIGATED'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;
insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE -- 240710 CR928
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AWS_ACCOUNTID
,AWS_INSTANCE_ID
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY -- 240710 CR928
,DATA_WARNING_ARRAY -- 240710 CR928
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,SYSTEM_ID -- 240724 CR940
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG -- 240827 CR-TBD
,FISMA_ID_TAG -- 240827 CR-TBD
)
SELECT
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE -- 240710 CR928
,INSTANCEID as ASSET_ID_TATTOO -- 240528 CR901
,ASSETEXPOSURESCORE
,ACCOUNTID as AWS_ACCOUNTID -- 240528 CR901
,INSTANCEID as AWS_INSTANCE_ID -- 240528 CR901
,coalesce(NULLIF(BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,BID
,CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,CPE
,NULL as CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,CVE
,coalesce(NULLIF(BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
,coalesce(NULLIF(CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY -- 240710 CR928
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY -- 240710 CR928
,coalesce(DATACENTER_ID,''InstanceID not in SEC_VW_HWAM_AWS'') as DATACENTER_ID -- 240724 CR940
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,NULL as FISMASEVERITY
,coalesce(NULLIF(HAS_BEEN_MITIGATED,''''),''0'')::NUMBER as HAS_BEEN_MITIGATED
,NULL as HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS -- 240710 CR928
,NETBIOSNAME
,0 as NUMERIC_SEVERITY -- 240710 CR928
,OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PATCHPUB_DATE) as PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,NULL as PRIMARY_FISMA_ID -- 240528 CR901
,NULL as PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,S3_FILE_CREATE as REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION -- 240710 CR928
,NULL as SCAN_POLICY_NAME
,NULL as SCAN_POLICY_UID
,NULL as SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,:SNAPSHOT_ID
,SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,STIGSEVERITY
,SYNOPSIS
,coalesce(SYSTEM_ID,''Not in FISMA_LOOKUP'') as THE_SYSTEM_ID -- 240724 CR940
,TEMPORAL_SCORE
,UUID as TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,STRTOK_TO_ARRAY(VPRCONTEXT,'','') as VPRCONTEXT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(VULN_PUB_DATE) as VULN_PUB_DATE
,XREF
,INSTANCEID as ASSET_ID_TAG -- 240827 CR-TBD
,THE_SYSTEM_ID as FISMA_ID_TAG -- 240827 CR-TBD
FROM CORE.VW_IUSG_MITIGATED_VULNS
WHERE S3_FILE_CREATE > :PreviousPullDatetime;

COMMIT;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_IUSG_VUL_NEW"("P_DATACATEGORY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull IUSG (AWS) TENABLE data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_IUSG_VUL_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar;
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

/**********************************************************************************
SELECT DISTINCT IP
,ARRAY_TO_STRING(ARRAY_DISTINCT(STRTOK_TO_ARRAY(IPS,'','')),'','') as DISTINCT_IPS 
FROM RAW_TENABLE_VUL WHERE NULLIF(IP,'''') <> NULLIF(DISTINCT_IPS,'''')
ZERO ROWS SO IPS FIELD IS NOT NEEDED
**********************************************************************************/

BEGIN
Datacategory := :P_DATACATEGORY;

Appl := :Appl || ''('' || :Datacategory || '')'';
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);
*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:Datacategory NOT IN (''AWS VUL'',''AWS VUL MITIGATED'')) THEN
    BEGIN
    ExceptionMsg := ''Datacategory cannot be used in this SP'';
    raise CRM_logic_exception;
    END;
END IF;

IF (:Datacategory = ''AWS VUL'') THEN
    BEGIN
    BEGIN TRANSACTION;
    
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
    ,AWS_ACCOUNTID -- IUSG
    ,AWS_INSTANCE_ID -- IUSG
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE 
    ,v.AWS_ACCOUNTID -- IUSG
    ,v.AWS_INSTANCE_ID -- IUSG
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
--	,v.CREDENTIALED_SCAN
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,v.DATACENTER_ID -- IUSG differs from CCIC
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',v.CVSSV3BASESCORE) as NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
--	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
    ,v.SYSTEM_ID -- IUSG
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
    ,v.VULNUNIQUENESS -- IUSG
    ,v.VULNUUID -- IUSG
	,v.XREF
    FROM (SELECT
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
    ,instanceid as ASSET_ID_TATTOO -- IUSG
	,ASSETEXPOSURESCORE
    ,accountid as AWS_ACCOUNTID -- IUSG
    ,instanceid as AWS_INSTANCE_ID -- IUSG
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
    ,coalesce(DATACENTER_ID,''InstanceID not in SEC_VW_HWAM_AWS'') as DATACENTER_ID -- IUSG differs from CCIC
	,DESCRIPTION
	,DNSNAME
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,IP
	,IPS
	,KEYDRIVERS 
	,LAST_SEEN
	,MACADDRESS
	,NETBIOSNAME
	,OPERATING_SYSTEM
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,S3_FILE_CREATE as REPORTDATE -- IUSG differs from CCIC
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
--	,SCAN_POLICY_NAME
--	,SCAN_POLICY_UID
--	,SCAN_START_DATE
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SOLUTION
	,STIGSEVERITY
	,SYNOPSIS
    ,coalesce(SYSTEM_ID,''Not in FISMA_LOOKUP'') as SYSTEM_ID -- IUSG
	,TEMPORAL_SCORE
	,UNIQUENESS
	,UUID
	,VERSION
	,VPR_SCORE
    ,STRTOK_TO_ARRAY(VPRCONTEXT,'','') as VPRCONTEXT -- IUSG differs from CCIC
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
    FROM CORE.VW_IUSG_CUMULATIVE_VULNS
    WHERE S3_FILE_CREATE > :PreviousPullDatetime ) v;

    RECORD_COUNT := SQLROWCOUNT;

    COMMIT;
    END;
ELSE -- AWS VUL MITITGATED
    BEGIN
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
    ,AWS_ACCOUNTID -- IUSG
    ,AWS_INSTANCE_ID -- IUSG
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE 
    ,v.AWS_ACCOUNTID -- IUSG
    ,v.AWS_INSTANCE_ID -- IUSG
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
--	,v.CREDENTIALED_SCAN
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,v.DATACENTER_ID -- IUSG differs from CCIC
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',v.CVSSV3BASESCORE) as NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
--	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
    ,v.SYSTEM_ID -- IUSG
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
    ,v.VULNUNIQUENESS -- IUSG
    ,v.VULNUUID -- IUSG
	,v.XREF
    FROM (SELECT
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
    ,instanceid as ASSET_ID_TATTOO -- IUSG
	,ASSETEXPOSURESCORE
    ,accountid as AWS_ACCOUNTID -- IUSG
    ,instanceid as AWS_INSTANCE_ID -- IUSG
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
    ,coalesce(DATACENTER_ID,''InstanceID not in SEC_VW_HWAM_AWS'') as DATACENTER_ID -- IUSG differs from CCIC
	,DESCRIPTION
	,DNSNAME
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,IP
	,IPS
	,KEYDRIVERS 
	,LAST_SEEN
	,MACADDRESS
	,NETBIOSNAME
	,OPERATING_SYSTEM
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,S3_FILE_CREATE as REPORTDATE -- IUSG differs from CCIC
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
--	,SCAN_POLICY_NAME
--	,SCAN_POLICY_UID
--	,SCAN_START_DATE
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SOLUTION
	,STIGSEVERITY
	,SYNOPSIS
    ,coalesce(SYSTEM_ID,''Not in FISMA_LOOKUP'') as SYSTEM_ID -- IUSG
	,TEMPORAL_SCORE
	,UNIQUENESS
	,UUID
	,VERSION
	,VPR_SCORE
    ,STRTOK_TO_ARRAY(VPRCONTEXT,'','') as VPRCONTEXT -- IUSG differs from CCIC
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
    FROM CORE.VW_IUSG_MITIGATED_VULNS
    WHERE S3_FILE_CREATE > :PreviousPullDatetime ) v;

    RECORD_COUNT := SQLROWCOUNT;

    COMMIT;
    END; 
END IF;


IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_KEV_CATALOG"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull CISA Known Exploited Vulnerabilities(KEV) data into BUS_CYBER_RISK_MANAGEMENT. https://www.cisa.gov/known-exploited-vulnerabilities-catalog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PULL_KEV_CATALOG'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

select count(1) into :TheRowCount FROM REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV; -- 230801 was in BOD_KEV_CATALOG schema  -- 230811 added SEC_

IF (TheRowCount = 0) THEN
	BEGIN
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''WARNING: REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV is empty'');   -- 230811 added SEC_
    END;
ELSE
    BEGIN
    BEGIN TRANSACTION;
    
    MERGE INTO CORE.KEV_CATALOG t USING (
    SELECT
        kevdetail.DUEDATE as BODDUEDATE
	    ,kevdetail.CVEID as CVE
        ,kevdetail.DATEADDED as DATEADDEDTOCATALOG
	    ,kevdetail.PRODUCT
        ,kevdetail.REQUIREDACTION
        ,kevdetail.SHORTDESCRIPTION
        ,kevdetail.VENDORPROJECT
        ,kevdetail.VULNERABILITYNAME
    FROM REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV kevdetail
    --
    -- 240919 1059 CR982
    -- It is expected that the NIST NVD (nvd.nist.gov) contains distinct CVEs but on 9/19/24, CVE-2019-1069 was found to be duplicated.
    -- This caused a failure in this stored procedure. We will now use the record with the greatest DUEDATE. 
    --
    JOIN (SELECT r2.CVEID,r2.DUEDATE
        FROM (select rank()over(partition by r1.CVEID order by r1.DUEDATE desc) TheRank,r1.CVEID,r1.DUEDATE
            FROM REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV r1
            JOIN (select DISTINCT CVEID FROM REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV) d on d.CVEID = r1.CVEID) r2
            where r2.TheRank = 1) UniqueKev on UniqueKev.CVEID = kevdetail.CVEID and UniqueKev.DUEDATE = kevdetail.DUEDATE
    )s ON (s.CVE = t.CVE)
    WHEN MATCHED THEN UPDATE SET 
        t.BODDUEDATE = s.BODDUEDATE
        ,t.DATEADDEDTOCATALOG = s.DATEADDEDTOCATALOG
        ,t.DATEMODIFIED = CURRENT_TIMESTAMP()
        ,t.PRODUCT = s.PRODUCT
        ,t.REQUIREDACTION = s.REQUIREDACTION
        ,t.SHORTDESCRIPTION = s.SHORTDESCRIPTION
        ,t.VENDORPROJECT = s.VENDORPROJECT
        ,t.VULNERABILITYNAME = s.VULNERABILITYNAME
    WHEN NOT MATCHED THEN INSERT
        (BODDUEDATE
        ,CVE
        ,DATEADDEDTOCATALOG
        ,INSERT_DATE
        ,IS_DELETED
        ,NOTES
        ,ORIG_DUEDATE
        ,PRODUCT
        ,REQUIREDACTION
        ,SHORTDESCRIPTION
        ,VENDORPROJECT
        ,VULNERABILITYNAME
    )
    VALUES (s.BODDUEDATE
        ,s.CVE
        ,s.DATEADDEDTOCATALOG
        ,CURRENT_TIMESTAMP() -- INSERT_DATE
        ,0 -- IS_DELETED
        ,null -- NOTES
        ,s.BODDUEDATE -- ORIG_DUEDATE
        ,s.PRODUCT
        ,s.REQUIREDACTION
        ,s.SHORTDESCRIPTION
        ,s.VENDORPROJECT
        ,s.VULNERABILITYNAME
    );

   -- 230922 Msg := ''Merge KEV_CATALOG complete'';
   -- 230922 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

    COMMIT;

    BEGIN TRANSACTION;
    --
    -- Logically delete the KEV if no longer in new catalog
    -- We keep the deleted KEV for use in vulnerability history
    --
    UPDATE CORE.KEV_CATALOG upd
    set IS_DELETED = 1
    ,DATEDELETED = CURRENT_TIMESTAMP()
    from CORE.KEV_CATALOG oldkev
    left outer join REF_LOOKUPS.SHARED.SEC_MV_BOD_KEV newkev on newkev.cveid = oldkev.CVE -- 230801 was in BOD_KEV_CATALOG schema  -- 230811 added SEC_
    WHERE upd.ID = oldkev.ID and newkev.cveid IS NULL and oldkev.IS_DELETED = 0;

    COMMIT;
    
    /* 231103 
    BEGIN TRANSACTION;

    UPDATE CORE.KEV_CATALOG upd
    set exploitAvailable = r.exploitAvailable
    ,FISMAseverity = r.FISMAseverity
    ,LASTFOUND = r.lastfound
    FROM CORE.KEV_CATALOG kev
    JOIN (select m.cve,t.exploitAvailable,t.FISMAseverity,T.lastfound
	    FROM (SELECT CVE,MAX(lastfound) as MaxLastFound
		    FROM CORE.VW_VULMASTER
		    where IS_KEV = 1 and MitigationStatus <> ''fixed''
		    GROUP by CVE) m
	    JOIN (SELECT distinct CVE,lastfound,exploitAvailable,FISMAseverity
		    FROM CORE.VW_VULMASTER
		    where IS_KEV = 1 and MitigationStatus <> ''fixed'') t on t.CVE = m.CVE and t.lastfound = m.MaxLastFound) r on r.CVE = kev.CVE
    where kev.ID = upd.ID;

    COMMIT;
    */

    
	END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_MAG_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull MAG TENABLE data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_MAG_VUL'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''MAG VUL'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,SYSTEM_ID
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG
,FISMA_ID_TAG
) 
SELECT
v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,v.SUBSCRIPTION_ID as AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,v.BID
,v.CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,v.CPE
,v.CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,v.CVE
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE -- 230419 Naseem found that BASESCORE matches legacy CVSSv2
,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,coalesce(v.REPOSITORY_DESCRIPTION,''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE'') as DATACENTER_ID -- SEC_VW_FISMA_LOOKUPS_MAG should have DATACENTER_ID but is NULL
,v.DESCRIPTION
,NULLIF(v.DNSNAME,'''') as DNSNAME
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN
,CORE.FN_CRM_CHARACTER_SEVERITY(v.FN_NUMERIC_SEVERITY) as FISMASEVERITY -- 241106 CR-TBD
,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
,NULL as HOSTNAME
,v.HOSTUNIQUENESS
,NULL as HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,v.IP
,v.IPS
,v.KEYDRIVERS
,v.LAST_SEEN
,NULLIF(v.MACADDRESS,'''') as MACADDRESS
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS
,NULLIF(v.NETBIOSNAME,'''') as NETBIOSNAME
,v.FN_NUMERIC_SEVERITY as NUMERIC_SEVERITY -- 241106 CR-TBD
,v.OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
,v.PLUGIN_ID
,v.PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,v.PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,v.PLUGINTEXT
,v.PORT
,NULL as PRIMARY_FISMA_ID_DERIVED
,NULL as PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,NULL as RECASTRISKRULECOMMENT
,v.REPORTDATE
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,:SNAPSHOT_ID
,v.SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,v.SYSTEM_ID
,v.TEMPORAL_SCORE
,v.UUID as TENABLEUUID
,v.UNIQUENESS
,v.VERSION
,v.VPR_SCORE
,STRTOK_TO_ARRAY(v.VPRCONTEXT,'','') as VPRCONTEXT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
,v.XREF
,v.ASSET_ID_TATTOO as ASSET_ID_TAG
,v.SYSTEM_ID as FISMA_ID_TAG
FROM (
SELECT
mag.ACCEPT_RISK_RULE_COMMENT
,mag.ACCEPTRISK
,mag.ACRSCORE
,mag.NAME as ASSET_ID_TATTOO -- 241022 discussion with Greg Beck indicates this should be reliable as a distinct value
,mag.ASSETEXPOSURESCORE
,mag.BASESCORE
,mag.BID
,mag.CHECKTYPE
,mag.CPE
,NULL as CREDENTIALED_SCAN
,mag.CVE
,mag.CVSSV3BASESCORE
,mag.CVSSV3TEMPORALSCORE
,mag.CVSSV3VECTOR
,mag.CVSSVECTOR
,mag.DESCRIPTION
,mag.DNSNAME
,mag.EXPLOIT_AVAILABLE
,mag.EXPLOITEASE
,mag.EXPLOITFRAMEWORKS
,mag.FAMILY_ID
,mag.FAMILY_NAME
,mag.FAMILY_TYPE
,mag.FIRST_SEEN
,mag.HAS_BEEN_MITIGATED
,mag.HOSTUNIQUENESS
,mag.IP
,mag.IPS
,mag.KEYDRIVERS
,mag.LAST_SEEN
,mag.MACADDRESS
,mag.NETBIOSNAME
,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',mag.CVSSV3BASESCORE) as FN_NUMERIC_SEVERITY -- 241106 CR-TBD
,mag.OPERATING_SYSTEM
,mag.PATCHPUB_DATE
,mag.PLUGIN_ID
,mag.PLUGIN_INFO
,mag.PLUGIN_MOD_DATE
,mag.PLUGIN_NAME
,mag.PLUGIN_PUB_DATE
,mag.PLUGINTEXT
,mag.PORT
,NULL as PRIMARY_FISMA_ID
,mag.PROTOCOL
,mag.RECASTRISK
,mag.S3_FILE_CREATE as REPORTDATE
,mag.REPOSITORY_DATAFORMAT
,NULLIF(mag.REPOSITORY_DESCRIPTION,'''') as REPOSITORY_DESCRIPTION
,mag.REPOSITORY_ID
,mag.REPOSITORY_NAME
,mag.RISKFACTOR
,NULL as SCAN_POLICY_NAME
,NULL as SCAN_POLICY_UID
,NULL as SCAN_START_DATE
,mag.SEEALSO
,mag.SEVERITY_DESCRIPTION
,mag.SEVERITY_ID
,mag.SEVERITY_NAME
,mag.SOLUTION
,mag.STIGSEVERITY
,mag.SYNOPSIS
,coalesce(NULLIF(lu.FISMA,''''),''SUBSCRIPTION_ID is not in SEC_VW_FISMA_LOOKUPS_MAG'') as SYSTEM_ID
,mag.SUBSCRIPTION_ID -- 241125 CR1038
,mag.TEMPORAL_SCORE
,mag.UUID
,mag.UNIQUENESS
,mag.VERSION
,mag.VPR_SCORE
,mag.VPRCONTEXT
,mag.VULN_PUB_DATE
,mag.XREF
--
-- OTHER MAG COLUMNS NOT USED AT THIS TIME
--
-- DNS_SERVERS -- SPARSE
-- FILENAME -- NOT NEEDED BUT CONSIDER ADDING TO NEW (SINGLE) RAW_DATA TABLE
-- INSTANCEID -- ALWAYS EMPTY
-- IP_CONFIGURATIONS -- EXPLORE -- HAS FQDN WHICH HAS NOT BEEN OTHERWISE PARSED
-- MACADDRESS -- MAC_ADDRESS appears to be of more value. This is sparse and does not always match MAC_ADDRESS
-- MAG_INSTANCE_IP_ADDRESS -- MIGHT BE IMPORTANT
-- NAME -- COMPARE TO SUBSCRIPTION_ID; APPEARS TO BE HOSTNAME
-- NETWORK_INTERFACE_ID -- EXPLORE
-- split_part(NETWORK_INTERFACE_ID,''/'',3) as NETWORK_INTERFACE_ID_SUBSCRIPTION_ID 
-- split_part(NETWORK_INTERFACE_ID,''/'',5)
-- split_part(NETWORK_INTERFACE_ID,''/'',9)
-- NETWORK_PRIMARY - TRUE/FALSE/NULL
-- RAW_VULNS -- DONT NEED RAW DATA
-- SF_FILE_LOAD -- NOT NEEDED
-- TYPE -- Always: Microsoft.Network/networkInterfaces
-- VIRTUAL_MACHINE_ID -- Not always populated
-- VULNUNIQUENESS -- NOT NEEDED
-- VULNUUID -- ALWAYS EMPTY
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS mag
--
-- Need to use upper function because of case issues in Tenable data
--
LEFT OUTER JOIN REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS_MAG lu on upper(lu.account_number) = upper(mag.SUBSCRIPTION_ID)
WHERE mag.S3_FILE_CREATE > :PreviousPullDatetime
and 
(
FN_NUMERIC_SEVERITY > 0 -- 241105 CR1024 filter-out Informational records
or mag.PLUGIN_ID = ''19506'' -- 240128 CR1076 reinstate plugin which was excluded under CR1024
)
) v;

RECORD_COUNT := SQLROWCOUNT;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.SNAPSHOT_IDS
set RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;
    
Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;
update CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_MAG_VUL_MITIGATED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull MAG TENABLE data into BUS_CYBER_RISK_MANAGEMENT RAW_TENABLE_VUL table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_MAG_VUL_MITIGATED'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar := ''MAG VUL MITIGATED'';
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);

Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into CORE.RAW_TENABLE_VUL(
ACCEPT_RISK_RULE_COMMENT
,ACCEPTRISK
,ACRSCORE
,APPLICABILITYCODE
,ASSET_ID_TATTOO
,ASSETEXPOSURESCORE
,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,BASESCORE
,BID
,CHECKTYPE
,COMPLIANCE_ACTUAL_VALUE
,COMPLIANCE_CHECK_NAME
,COMPLIANCE_ERROR
,COMPLIANCE_RESULT
,CPE
,CREDENTIALED_SCAN
,CUSTOM_SEVERITY
,CVE
,CVSSV2BASESCORE
,CVSSV3BASESCORE
,CVSSV3TEMPORALSCORE
,CVSSV3VECTOR
,CVSSVECTOR
,DATA_ERROR_ARRAY
,DATA_WARNING_ARRAY
,DATACENTER_ID
,DESCRIPTION
,DNSNAME
,EXPLOIT_AVAILABLE
,EXPLOITEASE
,EXPLOITFRAMEWORKS
,FAMILY_ID
,FAMILY_NAME
,FAMILY_TYPE
,FIRST_SEEN
,FISMASEVERITY
,HAS_BEEN_MITIGATED
,HOSTNAME
,HOSTUNIQUENESS
,HOSTUUID
,INSERT_DATE
,IP
,IPS
,KEYDRIVERS
,LAST_SEEN
,MACADDRESS
,MITIGATIONSTATUS
,NETBIOSNAME
,NUMERIC_SEVERITY
,OPERATING_SYSTEM
,PATCHPUB_DATE
,PLUGIN_ID
,PLUGIN_INFO
,PLUGIN_MOD_DATE
,PLUGIN_NAME
,PLUGIN_PUB_DATE
,PLUGINTEXT
,PORT
,PRIMARY_FISMA_ID_DERIVED
,PRIMARY_FISMA_ID_TATTOO
,PROTOCOL
,RECASTRISK
,RECASTRISKRULECOMMENT
,REPORTDATE
,REPOSITORY_DATAFORMAT
,REPOSITORY_DESCRIPTION
,REPOSITORY_ID
,REPOSITORY_NAME
,RISKFACTOR
,ROWDISPOSITION
,SCAN_POLICY_NAME
,SCAN_POLICY_UID
,SCAN_START_DATE
,SEEALSO
,SEVERITY_DESCRIPTION
,SEVERITY_ID
,SEVERITY_NAME
,SNAPSHOT_ID
,SOLUTION
,SOURCE_TOOL
,STATE
,STIGSEVERITY
,SYNOPSIS
,SYSTEM_ID
,TEMPORAL_SCORE
,TENABLEUUID
,UNIQUENESS
,VERSION
,VPR_SCORE
,VPRCONTEXT
,VULN_PUB_DATE
,XREF
,ASSET_ID_TAG
,FISMA_ID_TAG
) 
SELECT
v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,v.SUBSCRIPTION_ID as AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
,v.BID
,v.CHECKTYPE
,NULL as COMPLIANCE_ACTUAL_VALUE
,NULL as COMPLIANCE_CHECK_NAME
,NULL as COMPLIANCE_ERROR
,NULL as COMPLIANCE_RESULT
,v.CPE
,v.CREDENTIALED_SCAN
,NULL as CUSTOM_SEVERITY
,v.CVE
,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE -- 230419 Naseem found that BASESCORE matches legacy CVSSv2
,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
,coalesce(v.REPOSITORY_DESCRIPTION,''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE'') as DATACENTER_ID -- SEC_VW_FISMA_LOOKUPS_MAG should have DATACENTER_ID but is NULL
,v.DESCRIPTION
,NULLIF(v.DNSNAME,'''') as DNSNAME
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN
,CORE.FN_CRM_CHARACTER_SEVERITY(v.FN_NUMERIC_SEVERITY) as FISMASEVERITY -- 241106 CR-TBD
,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
,NULL as HOSTNAME
,v.HOSTUNIQUENESS
,NULL as HOSTUUID
,CURRENT_TIMESTAMP() as INSERT_DATE
,v.IP
,v.IPS
,v.KEYDRIVERS
,v.LAST_SEEN
,NULLIF(v.MACADDRESS,'''') as MACADDRESS
,case HAS_BEEN_MITIGATED
    when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
    Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
End as MITIGATIONSTATUS
,NULLIF(v.NETBIOSNAME,'''') as NETBIOSNAME
,v.FN_NUMERIC_SEVERITY as NUMERIC_SEVERITY -- 241106 CR-TBD
,v.OPERATING_SYSTEM
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
,v.PLUGIN_ID
,v.PLUGIN_INFO
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
,v.PLUGIN_NAME
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
,v.PLUGINTEXT
,v.PORT
,NULL as PRIMARY_FISMA_ID_DERIVED
,NULL as PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,NULL as RECASTRISKRULECOMMENT
,v.REPORTDATE
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,:SNAPSHOT_ID
,v.SOLUTION
,''Tenable'' as SOURCE_TOOL
,NULL as STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,v.SYSTEM_ID
,v.TEMPORAL_SCORE
,v.UUID as TENABLEUUID
,v.UNIQUENESS
,v.VERSION
,v.VPR_SCORE
,STRTOK_TO_ARRAY(v.VPRCONTEXT,'','') as VPRCONTEXT
,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
,v.XREF
,v.ASSET_ID_TATTOO as ASSET_ID_TAG
,v.SYSTEM_ID as FISMA_ID_TAG
FROM (
SELECT
mag.ACCEPT_RISK_RULE_COMMENT
,mag.ACCEPTRISK
,mag.ACRSCORE
,mag.NAME as ASSET_ID_TATTOO -- 241022 discussion with Greg Beck indicates this should be reliable as a distinct value
,mag.ASSETEXPOSURESCORE
,mag.BASESCORE
,mag.BID
,mag.CHECKTYPE
,mag.CPE
,NULL as CREDENTIALED_SCAN
,mag.CVE
,mag.CVSSV3BASESCORE
,mag.CVSSV3TEMPORALSCORE
,mag.CVSSV3VECTOR
,mag.CVSSVECTOR
,mag.DESCRIPTION
,mag.DNSNAME
,mag.EXPLOIT_AVAILABLE
,mag.EXPLOITEASE
,mag.EXPLOITFRAMEWORKS
,mag.FAMILY_ID
,mag.FAMILY_NAME
,mag.FAMILY_TYPE
,mag.FIRST_SEEN
,mag.HAS_BEEN_MITIGATED
,mag.HOSTUNIQUENESS
,mag.IP
,mag.IPS
,mag.KEYDRIVERS
,mag.LAST_SEEN
,mag.MACADDRESS
,mag.NETBIOSNAME
,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',mag.CVSSV3BASESCORE) as FN_NUMERIC_SEVERITY -- 241106 CR-TBD
,mag.OPERATING_SYSTEM
,mag.PATCHPUB_DATE
,mag.PLUGIN_ID
,mag.PLUGIN_INFO
,mag.PLUGIN_MOD_DATE
,mag.PLUGIN_NAME
,mag.PLUGIN_PUB_DATE
,mag.PLUGINTEXT
,mag.PORT
,NULL as PRIMARY_FISMA_ID
,mag.PROTOCOL
,mag.RECASTRISK
,mag.S3_FILE_CREATE as REPORTDATE
,mag.REPOSITORY_DATAFORMAT
,NULLIF(mag.REPOSITORY_DESCRIPTION,'''') as REPOSITORY_DESCRIPTION
,mag.REPOSITORY_ID
,mag.REPOSITORY_NAME
,mag.RISKFACTOR
,NULL as SCAN_POLICY_NAME
,NULL as SCAN_POLICY_UID
,NULL as SCAN_START_DATE
,mag.SEEALSO
,mag.SEVERITY_DESCRIPTION
,mag.SEVERITY_ID
,mag.SEVERITY_NAME
,mag.SOLUTION
,mag.STIGSEVERITY
,mag.SYNOPSIS
,coalesce(NULLIF(lu.FISMA,''''),''SUBSCRIPTION_ID is not in SEC_VW_FISMA_LOOKUPS_MAG'') as SYSTEM_ID
,mag.SUBSCRIPTION_ID -- 241125 CR1038
,mag.TEMPORAL_SCORE
,mag.UUID
,mag.UNIQUENESS
,mag.VERSION
,mag.VPR_SCORE
,mag.VPRCONTEXT
,mag.VULN_PUB_DATE
,mag.XREF
--
-- OTHER MAG COLUMNS NOT USED AT THIS TIME
--
-- DNS_SERVERS -- SPARSE
-- FILENAME -- NOT NEEDED BUT CONSIDER ADDING TO NEW (SINGLE) RAW_DATA TABLE
-- INSTANCEID -- ALWAYS EMPTY
-- IP_CONFIGURATIONS -- EXPLORE
-- MACADDRESS -- MAC_ADDRESS appears to be of more value. This is sparse and does not always match MAC_ADDRESS
-- MAG_INSTANCE_IP_ADDRESS -- MIGHT BE IMPORTANT
-- NAME -- COMPARE TO SUBSCRIPTION_ID; APPEARS TO BE HOSTNAME
-- NETWORK_INTERFACE_ID -- EXPLORE
-- split_part(NETWORK_INTERFACE_ID,''/'',3) as NETWORK_INTERFACE_ID_SUBSCRIPTION_ID 
-- split_part(NETWORK_INTERFACE_ID,''/'',5)
-- split_part(NETWORK_INTERFACE_ID,''/'',9)
-- NETWORK_PRIMARY - TRUE/FALSE/NULL
-- RAW_VULNS -- DONT NEED RAW DATA
-- SF_FILE_LOAD -- NOT NEEDED
-- TYPE -- Always: Microsoft.Network/networkInterfaces
-- VIRTUAL_MACHINE_ID -- Not always populated
-- VULNUNIQUENESS -- NOT NEEDED
-- VULNUUID -- ALWAYS EMPTY
FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_MITIGATED_VULNS mag
--
-- Need to use upper function because of case issues in Tenable data
--
LEFT OUTER JOIN REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS_MAG lu on upper(lu.account_number) = upper(mag.SUBSCRIPTION_ID)
WHERE mag.S3_FILE_CREATE > :PreviousPullDatetime
and FN_NUMERIC_SEVERITY > 0 -- 241105 CR1024 filter-out Informational records
) v;

RECORD_COUNT := SQLROWCOUNT;
COMMIT;

BEGIN TRANSACTION;
UPDATE CORE.SNAPSHOT_IDS
set RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no VUL data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;
    
Msg := :Datacategory || '' inserted into RAW_TENABLE_VUL='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

MIN_DATE := (select MIN(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(REPORTDATE) FROM CORE.RAW_TENABLE_VUL WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;
update CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_MAG_VUL_NEW"("P_DATACATEGORY" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull MAG TENABLE data into RAW_DATA table'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SP_CRM_PULL_MAG_VUL_NEW'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
Datacategory varchar;
PreviousPullDatetime TIMESTAMP_LTZ(9);
SNAPSHOT_ID number;
RECORD_COUNT number;
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

/**********************************************************************************
SELECT DISTINCT IP
,ARRAY_TO_STRING(ARRAY_DISTINCT(STRTOK_TO_ARRAY(IPS,'','')),'','') as DISTINCT_IPS 
FROM RAW_TENABLE_VUL WHERE NULLIF(IP,'''') <> NULLIF(DISTINCT_IPS,'''')
ZERO ROWS SO IPS FIELD IS NOT NEEDED
**********************************************************************************/

BEGIN
Datacategory := :P_DATACATEGORY;

Appl := :Appl || ''('' || :Datacategory || '')'';
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/*
CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:Datacategory);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:Datacategory);

PreviousPullDatetime := (select PARMDATE FROM CORE.CONFIG where PARMNAME = :Datacategory);
*/

SNAPSHOT_ID := (day(current_date()) || hour(current_timestamp()) || minute(current_timestamp()))::number;
Msg := ''Test SNAPSHOT_ID='' || :SNAPSHOT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

PreviousPullDatetime := ((current_date() - 1)::date || '' 00:01'')::timestamp;


Msg := ''Previous pull of '' || :Datacategory || ''='' || :PreviousPullDatetime;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

IF (:Datacategory NOT IN (''MAG VUL'',''MAG VUL MITIGATED'')) THEN
    BEGIN
    ExceptionMsg := ''Datacategory cannot be used in this SP'';
    raise CRM_logic_exception;
    END;
END IF;

IF (:Datacategory = ''MAG VUL'') THEN
    BEGIN
    BEGIN TRANSACTION;
    
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
    ,AZURE_SUBSCRIPTION_ID
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE
    ,v.SUBSCRIPTION_ID as AZURE_SUBSCRIPTION_ID
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
--	,v.CREDENTIALED_SCAN
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,coalesce(v.REPOSITORY_DESCRIPTION,''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE'') as DATACENTER_ID -- SEC_VW_FISMA_LOOKUPS_MAG should have DATACENTER_ID but is NULL
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,v.FN_NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(v.FN_NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
--	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
    ,v.SYSTEM_ID -- IUSG
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
    ,v.VULNUNIQUENESS -- IUSG
    ,v.VULNUUID -- IUSG
	,v.XREF
    FROM (SELECT
    mag.ACCEPT_RISK_RULE_COMMENT
	,mag.ACCEPTRISK
	,mag.ACRSCORE
    ,mag.name as ASSET_ID_TATTOO -- 241022 discussion with Greg Beck indicates this should be reliable as a distinct value
   	,mag.ASSETEXPOSURESCORE
	,mag.BASESCORE
	,mag.BID
	,mag.CHECKTYPE
	,mag.CPE
--	,mag.CREDENTIALED_SCAN
	,mag.CVE
	,mag.CVSSV3BASESCORE
	,mag.CVSSV3TEMPORALSCORE
	,mag.CVSSV3VECTOR
	,mag.CVSSVECTOR
    ,mag.DESCRIPTION
	,mag.DNSNAME
	,mag.EXPLOIT_AVAILABLE
	,mag.EXPLOITEASE
	,mag.EXPLOITFRAMEWORKS
	,mag.FAMILY_ID
	,mag.FAMILY_NAME
	,mag.FAMILY_TYPE
	,mag.FIRST_SEEN
	,mag.HAS_BEEN_MITIGATED
	,mag.HOSTUNIQUENESS
	,mag.HOSTUUID
	,mag.IP
	,mag.IPS
	,mag.KEYDRIVERS 
	,mag.LAST_SEEN
	,mag.MACADDRESS
	,mag.NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',mag.CVSSV3BASESCORE) as FN_NUMERIC_SEVERITY
	,mag.OPERATING_SYSTEM
	,mag.PATCHPUB_DATE
	,mag.PLUGIN_ID
	,mag.PLUGIN_INFO
	,mag.PLUGIN_MOD_DATE
	,mag.PLUGIN_NAME
	,mag.PLUGIN_PUB_DATE
	,mag.PLUGINTEXT
	,mag.PORT
--	,mag.PRIMARY_FISMA_ID
	,mag.PROTOCOL
	,mag.RECASTRISK
	,mag.RECASTRISKRULECOMMENT
	,mag.S3_FILE_CREATE as REPORTDATE -- IUSG differs from CCIC
	,mag.REPOSITORY_DATAFORMAT
	,mag.REPOSITORY_DESCRIPTION
	,mag.REPOSITORY_ID
	,mag.REPOSITORY_NAME
	,mag.RISKFACTOR
--	,mag.SCAN_POLICY_NAME
--	,mag.SCAN_POLICY_UID
--	,mag.SCAN_START_DATE
	,mag.SEEALSO
	,mag.SEVERITY_DESCRIPTION
	,mag.SEVERITY_ID
	,mag.SEVERITY_NAME
	,mag.SOLUTION
	,mag.STIGSEVERITY
	,mag.SYNOPSIS
    ,coalesce(NULLIF(lu.FISMA,''''),''SUBSCRIPTION_ID is not in SEC_VW_FISMA_LOOKUPS_MAG'') as SYSTEM_ID
    ,mag.SUBSCRIPTION_ID
   	,mag.TEMPORAL_SCORE
	,mag.UNIQUENESS
	,mag.UUID
	,mag.VERSION
	,mag.VPR_SCORE
    ,STRTOK_TO_ARRAY(mag.VPRCONTEXT,'','') as VPRCONTEXT -- IUSG differs from CCIC
	,mag.VULN_PUB_DATE
    ,mag.VULNUNIQUENESS -- IUSG
    ,mag.VULNUUID -- IUSG
	,mag.XREF
    --
    -- OTHER MAG COLUMNS NOT USED AT THIS TIME
    --
    -- DNS_SERVERS -- SPARSE
    -- FILENAME -- NOT NEEDED BUT CONSIDER ADDING TO NEW (SINGLE) RAW_DATA TABLE
    -- INSTANCEID -- ALWAYS EMPTY
    -- IP_CONFIGURATIONS -- EXPLORE -- HAS FQDN WHICH HAS NOT BEEN OTHERWISE PARSED
    -- MACADDRESS -- MAC_ADDRESS appears to be of more value. This is sparse and does not always match MAC_ADDRESS
    -- MAG_INSTANCE_IP_ADDRESS -- MIGHT BE IMPORTANT
    -- NAME -- COMPARE TO SUBSCRIPTION_ID; APPEARS TO BE HOSTNAME
    -- NETWORK_INTERFACE_ID -- EXPLORE
    -- split_part(NETWORK_INTERFACE_ID,''/'',3) as NETWORK_INTERFACE_ID_SUBSCRIPTION_ID 
    -- split_part(NETWORK_INTERFACE_ID,''/'',5)
    -- split_part(NETWORK_INTERFACE_ID,''/'',9)
    -- NETWORK_PRIMARY - TRUE/FALSE/NULL
    -- RAW_VULNS -- DONT NEED RAW DATA
    -- SF_FILE_LOAD -- NOT NEEDED
    -- TYPE -- Always: Microsoft.Network/networkInterfaces
    -- VIRTUAL_MACHINE_ID -- Not always populated
    -- VULNUNIQUENESS -- NOT NEEDED
    -- VULNUUID -- ALWAYS EMPTY
    FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_CUMULATIVE_VULNS mag
    --
    -- Need to use upper function because of case issues in Tenable data
    --
    LEFT OUTER JOIN REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS_MAG lu on upper(lu.account_number) = upper(mag.SUBSCRIPTION_ID)
    WHERE mag.S3_FILE_CREATE > :PreviousPullDatetime
    and (
    FN_NUMERIC_SEVERITY > 0 -- 241105 CR1024 filter-out Informational records
    or mag.PLUGIN_ID = ''19506'' -- 240128 CR1076 reinstate plugin which was excluded under CR1024
    )  
    ) v;

    RECORD_COUNT := SQLROWCOUNT;

    COMMIT;
    END;
ELSE -- MAG VUL MITITGATED
    BEGIN
    BEGIN TRANSACTION;
    
    INSERT INTO CORE.RAW_DATA(
    ACCEPT_RISK_RULE_COMMENT
	,ACCEPTRISK
	,ACRSCORE
	,APPLICABILITYCODE
	,ASSET_ID_TATTOO
	,ASSETEXPOSURESCORE
    ,AZURE_SUBSCRIPTION_ID
	,BASESCORE
	,BID
	,CHECKTYPE
	,CPE
--	,CREDENTIALED_SCAN
	,CVE
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
	,CVSSV3TEMPORALSCORE
	,CVSSV3VECTOR
	,CVSSVECTOR
	,DATA_ERROR_ARRAY
	,DATA_WARNING_ARRAY
	,DATACENTER_ID
	,DESCRIPTION
	,EXPLOIT_AVAILABLE
	,EXPLOITEASE
	,EXPLOITFRAMEWORKS
	,FAMILY_ID
	,FAMILY_NAME
	,FAMILY_TYPE
	,FIRST_SEEN
	,FQDN
	,HAS_BEEN_MITIGATED
	,HOSTUNIQUENESS
	,HOSTUUID
	,INSERT_DATE
	,IP
	,KEYDRIVERS
	,LAST_SEEN
	,MACADDRESS
	,MITIGATIONSTATUS
	,NETBIOSNAME
	,NUMERIC_SEVERITY
    ,FISMASEVERITY -- Placed here for convenience
	,OS
	,PATCHPUB_DATE
	,PLUGIN_ID
	,PLUGIN_INFO
	,PLUGIN_MOD_DATE
	,PLUGIN_NAME
	,PLUGIN_PUB_DATE
	,PLUGINTEXT
	,PORT
--	,PRIMARY_FISMA_ID_DERIVED
	,PROTOCOL
	,RECASTRISK
	,RECASTRISKRULECOMMENT
	,REPORTDATE
	,REPOSITORY_DATAFORMAT
	,REPOSITORY_DESCRIPTION
	,REPOSITORY_ID
	,REPOSITORY_NAME
	,RISKFACTOR
	,ROWDISPOSITION
	,SEEALSO
	,SEVERITY_DESCRIPTION
	,SEVERITY_ID
	,SEVERITY_NAME
	,SNAPSHOT_ID
	,SOLUTION
	,SOURCE_TOOL
	,STIGSEVERITY
	,SYNOPSIS
	,SYSTEM_ID
	,TEMPORAL_SCORE
	,TENABLEUUID
	,UNIQUENESS
	,VERSION
	,VPR_SCORE
	,VPRCONTEXT
	,VULN_PUB_DATE
    ,VULNUNIQUENESS -- IUSG
    ,VULNUUID -- IUSG
	,XREF
) 
    SELECT
    v.ACCEPT_RISK_RULE_COMMENT
	,v.ACCEPTRISK
	,v.ACRSCORE
    ,CORE.FN_CRM_GET_INDICATOR_INITIAL() as APPLICABILITYCODE
	,v.ASSET_ID_TATTOO
	,v.ASSETEXPOSURESCORE
    ,v.SUBSCRIPTION_ID as AZURE_SUBSCRIPTION_ID
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as BASESCORE
	,v.BID
	,v.CHECKTYPE
	,v.CPE
--	,v.CREDENTIALED_SCAN
	,v.CVE
    ,coalesce(NULLIF(v.BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV2BASESCORE
    ,coalesce(NULLIF(v.CVSSV3BASESCORE,''''),''0'')::NUMBER(38,1) as CVSSV3BASESCORE
	,v.CVSSV3TEMPORALSCORE
	,v.CVSSV3VECTOR
	,v.CVSSVECTOR
    ,ARRAY_CONSTRUCT() as DATA_ERROR_ARRAY
    ,ARRAY_CONSTRUCT() as DATA_WARNING_ARRAY
    ,coalesce(v.REPOSITORY_DESCRIPTION,''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE'') as DATACENTER_ID -- SEC_VW_FISMA_LOOKUPS_MAG should have DATACENTER_ID but is NULL
	,v.DESCRIPTION
	,v.EXPLOIT_AVAILABLE
	,v.EXPLOITEASE
	,v.EXPLOITFRAMEWORKS
	,v.FAMILY_ID
	,v.FAMILY_NAME
	,v.FAMILY_TYPE
	,v.FIRST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.DNSNAME,''''),'','') as FQDN
    ,v.HAS_BEEN_MITIGATED::boolean as HAS_BEEN_MITIGATED
	,v.HOSTUNIQUENESS
	,v.HOSTUUID
    ,CURRENT_TIMESTAMP() as INSERT_DATE
	,v.IP
	-- ,v.IPS
	,v.KEYDRIVERS 
	,v.LAST_SEEN
    ,STRTOK_TO_ARRAY(NULLIF(v.MACADDRESS,''''),'','') as MACADDRESS
    ,case HAS_BEEN_MITIGATED
        when 1 then CORE.FN_CRM_GET_MITIGATIONSTATUS_REOPENED()
        Else CORE.FN_CRM_GET_MITIGATIONSTATUS_OPEN()
    End as MITIGATIONSTATUS
    ,STRTOK_TO_ARRAY(NULLIF(v.NETBIOSNAME,''''),'','') as NETBIOSNAME
    ,v.FN_NUMERIC_SEVERITY
    ,CORE.FN_CRM_CHARACTER_SEVERITY(v.FN_NUMERIC_SEVERITY) as FISMASEVERITY -- Placed here for convenience
	,v.OPERATING_SYSTEM
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PATCHPUB_DATE) as PATCHPUB_DATE
	,v.PLUGIN_ID
	,v.PLUGIN_INFO
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_MOD_DATE) as PLUGIN_MOD_DATE
	,v.PLUGIN_NAME
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.PLUGIN_PUB_DATE) as PLUGIN_PUB_DATE
	,v.PLUGINTEXT
	,v.PORT
--	,v.PRIMARY_FISMA_ID
	,v.PROTOCOL
	,v.RECASTRISK
	,v.RECASTRISKRULECOMMENT
	,v.REPORTDATE
	,v.REPOSITORY_DATAFORMAT
	,v.REPOSITORY_DESCRIPTION
	,v.REPOSITORY_ID
	,v.REPOSITORY_NAME
	,v.RISKFACTOR
    ,CORE.FN_CRM_GET_ROWDISPOSITION_VIABLE() as ROWDISPOSITION
	-- ,v.SCAN_POLICY_NAME
	-- ,v.SCAN_POLICY_UID
    -- ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.SCAN_START_DATE) as SCAN_START_DATE
	,v.SEEALSO
	,v.SEVERITY_DESCRIPTION
	,v.SEVERITY_ID
	,v.SEVERITY_NAME
    ,:SNAPSHOT_ID
	,v.SOLUTION
    ,''Tenable'' as SOURCE_TOOL
	,v.STIGSEVERITY
	,v.SYNOPSIS
    ,v.SYSTEM_ID -- IUSG
	,v.TEMPORAL_SCORE
    ,v.UUID as TENABLEUUID
	,v.UNIQUENESS
    ,v.VERSION
	,v.VPR_SCORE
	,v.VPRCONTEXT
    ,REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(v.VULN_PUB_DATE) as VULN_PUB_DATE
    ,v.VULNUNIQUENESS -- IUSG
    ,v.VULNUUID -- IUSG
	,v.XREF
    FROM (SELECT
    mag.ACCEPT_RISK_RULE_COMMENT
	,mag.ACCEPTRISK
	,mag.ACRSCORE
    ,mag.name as ASSET_ID_TATTOO -- 241022 discussion with Greg Beck indicates this should be reliable as a distinct value
   	,mag.ASSETEXPOSURESCORE
	,mag.BASESCORE
	,mag.BID
	,mag.CHECKTYPE
	,mag.CPE
--	,mag.CREDENTIALED_SCAN
	,mag.CVE
	,mag.CVSSV3BASESCORE
	,mag.CVSSV3TEMPORALSCORE
	,mag.CVSSV3VECTOR
	,mag.CVSSVECTOR
    ,mag.DESCRIPTION
	,mag.DNSNAME
	,mag.EXPLOIT_AVAILABLE
	,mag.EXPLOITEASE
	,mag.EXPLOITFRAMEWORKS
	,mag.FAMILY_ID
	,mag.FAMILY_NAME
	,mag.FAMILY_TYPE
	,mag.FIRST_SEEN
	,mag.HAS_BEEN_MITIGATED
	,mag.HOSTUNIQUENESS
	,mag.HOSTUUID
	,mag.IP
	,mag.IPS
	,mag.KEYDRIVERS 
	,mag.LAST_SEEN
	,mag.MACADDRESS
	,mag.NETBIOSNAME
    ,CORE.FN_CRM_NUMERIC_SEVERITY(''3.0'',mag.CVSSV3BASESCORE) as FN_NUMERIC_SEVERITY
	,mag.OPERATING_SYSTEM
	,mag.PATCHPUB_DATE
	,mag.PLUGIN_ID
	,mag.PLUGIN_INFO
	,mag.PLUGIN_MOD_DATE
	,mag.PLUGIN_NAME
	,mag.PLUGIN_PUB_DATE
	,mag.PLUGINTEXT
	,mag.PORT
--	,mag.PRIMARY_FISMA_ID
	,mag.PROTOCOL
	,mag.RECASTRISK
	,mag.RECASTRISKRULECOMMENT
	,mag.S3_FILE_CREATE as REPORTDATE -- IUSG differs from CCIC
	,mag.REPOSITORY_DATAFORMAT
	,mag.REPOSITORY_DESCRIPTION
	,mag.REPOSITORY_ID
	,mag.REPOSITORY_NAME
	,mag.RISKFACTOR
--	,mag.SCAN_POLICY_NAME
--	,mag.SCAN_POLICY_UID
--	,mag.SCAN_START_DATE
	,mag.SEEALSO
	,mag.SEVERITY_DESCRIPTION
	,mag.SEVERITY_ID
	,mag.SEVERITY_NAME
	,mag.SOLUTION
	,mag.STIGSEVERITY
	,mag.SYNOPSIS
    ,coalesce(NULLIF(lu.FISMA,''''),''SUBSCRIPTION_ID is not in SEC_VW_FISMA_LOOKUPS_MAG'') as SYSTEM_ID
    ,mag.SUBSCRIPTION_ID
   	,mag.TEMPORAL_SCORE
	,mag.UNIQUENESS
	,mag.UUID
	,mag.VERSION
	,mag.VPR_SCORE
    ,STRTOK_TO_ARRAY(mag.VPRCONTEXT,'','') as VPRCONTEXT -- IUSG differs from CCIC
	,mag.VULN_PUB_DATE
    ,mag.VULNUNIQUENESS -- IUSG
    ,mag.VULNUUID -- IUSG
	,mag.XREF
    --
    -- OTHER MAG COLUMNS NOT USED AT THIS TIME
    --
    -- DNS_SERVERS -- SPARSE
    -- FILENAME -- NOT NEEDED BUT CONSIDER ADDING TO NEW (SINGLE) RAW_DATA TABLE
    -- INSTANCEID -- ALWAYS EMPTY
    -- IP_CONFIGURATIONS -- EXPLORE -- HAS FQDN WHICH HAS NOT BEEN OTHERWISE PARSED
    -- MACADDRESS -- MAC_ADDRESS appears to be of more value. This is sparse and does not always match MAC_ADDRESS
    -- MAG_INSTANCE_IP_ADDRESS -- MIGHT BE IMPORTANT
    -- NAME -- COMPARE TO SUBSCRIPTION_ID; APPEARS TO BE HOSTNAME
    -- NETWORK_INTERFACE_ID -- EXPLORE
    -- split_part(NETWORK_INTERFACE_ID,''/'',3) as NETWORK_INTERFACE_ID_SUBSCRIPTION_ID 
    -- split_part(NETWORK_INTERFACE_ID,''/'',5)
    -- split_part(NETWORK_INTERFACE_ID,''/'',9)
    -- NETWORK_PRIMARY - TRUE/FALSE/NULL
    -- RAW_VULNS -- DONT NEED RAW DATA
    -- SF_FILE_LOAD -- NOT NEEDED
    -- TYPE -- Always: Microsoft.Network/networkInterfaces
    -- VIRTUAL_MACHINE_ID -- Not always populated
    -- VULNUNIQUENESS -- NOT NEEDED
    -- VULNUUID -- ALWAYS EMPTY
    FROM APP_TENABLE.SHARED.SEC_VW_IUSG_MAG_MITIGATED_VULNS mag
    --
    -- Need to use upper function because of case issues in Tenable data
    --
    LEFT OUTER JOIN REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS_MAG lu on upper(lu.account_number) = upper(mag.SUBSCRIPTION_ID)
    WHERE mag.S3_FILE_CREATE > :PreviousPullDatetime
    and FN_NUMERIC_SEVERITY > 0 -- 241105 CR1024 filter-out Informational records
    ) v;

    RECORD_COUNT := SQLROWCOUNT;

    COMMIT;
    END; 
END IF;


IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
ELSE
    BEGIN
    Msg := :Datacategory || '' inserted into RAW_DATA='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;

MIN_DATE := (select MIN(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);
MAX_DATE := (select MAX(LAST_SEEN) FROM CORE.RAW_DATA WHERE SNAPSHOT_ID = :SNAPSHOT_ID);

BEGIN TRANSACTION;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
 where SNAPSHOT_ID = :SNAPSHOT_ID;

/***************** COMMENT WHILE TESTING
UPDATE CORE.CONFIG
set PARMDATE = :MAX_DATE
where PARMNAME = :Datacategory and :MAX_DATE IS NOT NULL;
***************************************************************/
Msg := ''WARNING: Update of CORE.CONFIG disabled while testing'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_SYSTEMSAWSACCOUNTS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull list of AWS account IDs associated with the FISMA ID'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PULL_SYSTEMSAWSACCOUNTS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

select count(1) into :TheRowCount FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS;
-- 230801 select count(1) into :TheRowCount FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS; -- 230811 RBAC for DBLOOKUPS

IF (TheRowCount = 0) THEN
	BEGIN
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''WARNING: REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS is empty'');
    END;
ELSE
    BEGIN
    BEGIN TRANSACTION;

    TRUNCATE TABLE CORE.SYSTEMSAWSACCOUNTS;
    
    Insert into CORE.SYSTEMSAWSACCOUNTS (AWS_ACCOUNTID,	INSERT_DATE, SYSTEM_ID)
    select ACCOUNT_NUMBER,CURRENT_TIMESTAMP(),FISMA 
    from REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS WHERE FISMA IS NOT NULL and ACCOUNT_NUMBER IS NOT NULL; --230801 as per Naseem
    -- 230801 from REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS WHERE FISMA IS NOT NULL and ACCOUNT_NUMBER IS NOT NULL;
    
    COMMIT;
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_TENABLE_SOFTWARE_TOMTEST"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Stored procedure used to populate CORE.ASSET_SOFTWARE table'
EXECUTE AS OWNER
AS 'DECLARE
Appl varchar := ''SP_CRM_PULL_TENABLE_SOFTWARE_TOMTEST'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;
SOURCETOOL varchar := ''Tenable'';
PLUGIN_20811_COUNT NUMBER := 0;
PLUGIN_22869_COUNT NUMBER := 0;
PLUGIN_45590_COUNT NUMBER := 0;

-- Plugin 22869	Software Enumeration (SSH)
-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)
-- Plugin 45590 Common Platform Enumeration (CPE)

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


IF (:DATACATEGORY = ''AWS VUL'') THEN
	BEGIN
	Msg := ''WARNING: Temporary disable AWS VUL'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;


/*****************************************************************************************************
BEGIN TRANSACTION;
INSERT INTO CORE.TEMP_ASSET_SOFTWARE
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
SELECT t.DW_ASSET_ID,t.PLUGIN_ID
,coalesce(NULLIF(split_part(t.RAW_SOFTWARE,''      '',2),''''),''NO INSTALLATION DATE'') as RAW_DATEINSTALLED
,t.RAW_SOFTWARE
,NULL as THEVERSION -- RAW_VERSION
,split_part(THEVERSION,''.'',1) as THEMAJOR
,split_part(split_part(THEVERSION,''.'',2),''.'',1) as THEMINOR
,TRIM(split_part(t.RAW_SOFTWARE,''      '',1)) as THESOFTWARENAME
,:SOURCETOOL as SOURCE_TOOL
,REPLACE(THEVERSION,''NO VERSION'','''') as VERSION
,:P_SNAPSHOT_ID
FROM (
select r.dw_asset_id,r.PLUGIN_ID
,(position(('': '' || CHR(10) || CHR(10)),r.PLUGINTEXT) + 4) as STARTOFSOFTLIST
,(position(''</plugin_output>'',r.PLUGINTEXT)) as ENDOFSOFTLIST
,STRTOK_TO_ARRAY(SUBSTRING(r.PLUGINTEXT,STARTOFSOFTLIST,(ENDOFSOFTLIST - STARTOFSOFTLIST - 4)),CHR(10)) as SOFTARRAY
,TRIM(f.value::string) as RAW_SOFTWARE
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = r.DW_ASSET_ID -- We only want active assets
join table(flatten(SOFTARRAY,outer=>true)) as f
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and r.DW_ASSET_ID IS NOT NULL 
and r.PLUGIN_ID = ''22869'' -- Software Enumeration (SSH)
and NULLIF(TRIM(RAW_SOFTWARE),'''') IS NOT NULL -- Must be non-null
and RAW_SOFTWARE NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Asset_ID%'' -- Exclude asset tags
--  NOT SURE and raw_software NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
) t
;

PLUGIN_22869_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 22869) Written='' || :PLUGIN_22869_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*****************************************************************************************************/


--BEGIN TRANSACTION;
INSERT INTO CORE.TEMP_ASSET_SOFTWARE_TOMTEST
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
SELECT t.DW_ASSET_ID,t.PLUGIN_ID
,coalesce(NULLIF(split_part(split_part(t.RAW_SOFTWARE,''[installed on '',2),'']'',1),''''),''NO INSTALLATION DATE'') as RAW_DATEINSTALLED
,t.RAW_SOFTWARE
,coalesce(NULLIF(split_part(split_part(t.RAW_SOFTWARE,''[version '',2),'']'',1),''''),''NO VERSION'') as THEVERSION -- RAW_VERSION
,split_part(THEVERSION,''.'',1) as THEMAJOR
,split_part(split_part(THEVERSION,''.'',2),''.'',1) as THEMINOR
,TRIM(split_part(RAW_SOFTWARE,''[version '',1)) as THESOFTWARENAME
,:SOURCETOOL as SOURCE_TOOL
,REPLACE(THEVERSION,''NO VERSION'','''') as VERSION
,:P_SNAPSHOT_ID
FROM (
select r.dw_asset_id,r.PLUGIN_ID
,(position(('':'' || CHR(10)),r.PLUGINTEXT) + 4) as STARTOFSOFTLIST
,(position(''</plugin_output>'',r.PLUGINTEXT)) as ENDOFSOFTLIST
,STRTOK_TO_ARRAY(SUBSTRING(r.PLUGINTEXT,STARTOFSOFTLIST,(ENDOFSOFTLIST - STARTOFSOFTLIST - 4)),CHR(10)) as SOFTARRAY
,TRIM(f.value::string) as RAW_SOFTWARE
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = r.DW_ASSET_ID -- We only want active assets
join table(flatten(SOFTARRAY,outer=>true)) as f
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and r.DW_ASSET_ID IS NOT NULL 
and r.PLUGIN_ID = ''20811'' -- Microsoft Windows Installed Software Enumeration (credentialed check)
and NULLIF(TRIM(RAW_SOFTWARE),'''') IS NOT NULL -- Must be non-null
and RAW_SOFTWARE NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Asset_ID%'' -- Exclude asset tags
and raw_software NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
) t
;

PLUGIN_20811_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 20811) Written='' || :PLUGIN_20811_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;


--BEGIN TRANSACTION;
INSERT INTO CORE.TEMP_ASSET_SOFTWARE_TOMTEST
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
VENDOR,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
WITH CPE_LIST AS (
    SELECT
        RTV.DW_ASSET_ID
        ,RTV.PLUGIN_ID
        ,RTV.SNAPSHOT_ID
        ,SPLIT(RTV.PLUGINTEXT, CHAR(10)) AS CPE_ARRAY
    FROM 
    CORE.RAW_TENABLE_VUL RTV
    JOIN CORE.VW_ASSETS A ON A.DW_ASSET_ID = RTV.DW_ASSET_ID
    WHERE RTV.PLUGIN_ID = ''45590'' AND RTV.SNAPSHOT_ID = :P_SNAPSHOT_ID
    ),
    EXPLODED AS (
    SELECT 
         C.DW_ASSET_ID
        ,PLUGIN_ID
        ,TRIM(T.value) AS CPE_STRING
        ,SPLIT(CPE_STRING,'':'') AS CPE_ARRAY
        ,SNAPSHOT_ID
    FROM CPE_LIST C,
    LATERAL FLATTEN(INPUT => C.CPE_ARRAY) t
),
FINAL_SPLIT AS (
SELECT 
     EXPLODED.*
    ,REGEXP_SUBSTR(cpe_array[4],''\\\\b\\\\d+(\\\\.\\\\d+)*\\\\b[\\\\sA-Za-z]?'') as RAW_VERSION
    ,split(RAW_VERSION,''.'') AS VERSION_ARRAY
FROM EXPLODED
)
SELECT
    DW_ASSET_ID,
    PLUGIN_ID,
    ''NO INSTALLATION DATE'' AS RAW_DATEINSTALLED,
    CPE_STRING AS RAW_SOFTWARE,
    RAW_VERSION,
    VERSION_ARRAY[0]::string as MAJOR,
    VERSION_ARRAY[1]::string as MINOR,
    CPE_ARRAY[3]::string as SOFTWARE,
    CPE_ARRAY[2]::string as VENDOR,
    :SOURCETOOL AS SOURCE_TOOL,
    RAW_VERSION AS VERSION,
    SNAPSHOT_ID
FROM FINAL_SPLIT
WHERE LEFT(CPE_STRING, 5) = ''cpe:/''
QUALIFY ROW_NUMBER() OVER (PARTITION BY DW_ASSET_ID, SOFTWARE, VERSION ORDER BY DW_ASSET_ID DESC) = 1;


PLUGIN_45590_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 45590) Written='' || :PLUGIN_45590_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;


--------------------------------------------------------------------------
--
-- TEST TO SEE IF THERE IS ANYTHING TO PROCESS, IF NOT, EXIT
--
--------------------------------------------------------------------------

IF ((PLUGIN_20811_COUNT + PLUGIN_22869_COUNT + PLUGIN_45590_COUNT) = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no SWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

--------------------------------------------------------------------------
--
-- CHECK FOR VARIOUS DATEINSTALLED FORMATS AND NORMALIZE
--
--------------------------------------------------------------------------

--BEGIN TRANSACTION;
-- 
-- 9/9/99
-- 9/9/9999
-- 9/99/99
-- 9/99/9999
-- 99.99.9999
-- 99/9/99
-- 99/9/9999
-- 99/99/99
-- 99/99/9999
-- 9999/99/
-- 9999/99/99
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = REPLACE(REPLACE(REGEXP_SUBSTR(RAW_DATEINSTALLED,''[0-9]{1,4}[(/|\\-|.)][0-9]{1,2}[(/|\\-|.)][0-9]{1,4}''),''/'',''-''),''.'',''-'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,4}[(/|\\-|.)][0-9]{1,2}[(/|\\-|.)][0-9]{1,4}.*'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(wide net)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- Thu Apr 26 11:20:02 EDT 2018
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,25,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,9,2) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][0-9]{2}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(TZ-1))='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
-- Format found in Plugin 22869
-- Fri 01 Apr 2022 01:55:38 PM CDT
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,12,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,8,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,5,2) || '' '' || substring(RAW_DATEINSTALLED,17,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][A-Za-z]{2}[ ][A-Za-z]{3}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(TZ-2))='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- Tue Feb 28 12:29:52 2023
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,21,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,9,2) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][0-9]{2}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(1)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Sun Jun  2 08:09:28 2024
-- 1234567890123456789012345
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,21,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,10,1)) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][ ][0-9]{1}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(2))='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;


--BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Sun 02 Jun 2024 03:02:53 AM
-- Mon 08 Feb 2016 12:13:52 PM
-- 1234567890123456789012345
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,12,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,8,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,5,2)) || '' '' || substring(RAW_DATEINSTALLED,17,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ](AM|PM)'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(AMPM))='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Thu Sep 13 12:15:09
-- Sun Jun  2 00:35:19
-- 1234567890123456789012345
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = ''2000-'' -- DEFAULT YEAR TO 2000
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,9,2)) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ]([0-9]{2}|[ ][0-9]{1})[ ][0-9]{2}:[0-9]{2}:[0-9]{2}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(NoYear))='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- 2012/11/
-- Add 1st day of month
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = REPLACE(REGEXP_SUBSTR(RAW_DATEINSTALLED,''[0-9]{4}/[0-9]{2}/'') || ''01'',''/'',''-'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{4}/[0-9]{2}/'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999/99/)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

/*
BEGIN TRANSACTION;
UPDATE TEMP_ASSET_SOFTWARE
set RAW_DATEINSTALLED = ''LEFTOVER:'' || NULLIF(TRIM(REPLACE(RAW_DATEINSTALLED,'']'','''')),'''')
where RAW_SOFTWARE like ''%[installed on%''
and RAW_DATEINSTALLED IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Windows InstalledDate leftovers='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*/


--
-- CLEAN AND NORMALIZE RAW_DATEINSTALLED FOR CONVERTION TO TIMESTAMP_LTZ
--

--BEGIN TRANSACTION;
--
-- 99-99-9999 to 9999-99-99
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = right(RAW_DATEINSTALLED,4) || ''-'' || substring(RAW_DATEINSTALLED,1,LEN(RAW_DATEINSTALLED) - 5)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,2}[-][0-9]{1,2}[-][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Reverse year='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--BEGIN TRANSACTION;
--
-- 99-99-20 to 2020-99-99
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set RAW_DATEINSTALLED = ''2020-'' || substring(RAW_DATEINSTALLED,1,LEN(RAW_DATEINSTALLED) - 3)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,2}[-][0-9]{1,2}[-]20'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Year(20)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

select count(1) INTO :RECORD_COUNT FROM TEMP_ASSET_SOFTWARE WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(RAW_DATEINSTALLED,'''') IS NULL;
Msg := ''Windows InstalledDate TOBE RESOLVED='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);


--BEGIN TRANSACTION;
--
-- Convert RAW_DATEINSTALLED to actual datetime column DATEINSTALLED
--
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST
set DATEINSTALLED = RAW_DATEINSTALLED::datetime
where SNAPSHOT_ID = :P_SNAPSHOT_ID and TRY_TO_DATE(SUBSTRING(RAW_DATEINSTALLED,1,10),''YYYY-MM-DD'') IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ActualDatetime='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;


/************************************
BEGIN TRANSACTION;
--
-- Confirmed future dates found in data
-- 2040/12/19
--
UPDATE TEMP_ASSET_SOFTWARE
set RAW_DATEINSTALLED = NULL
where RAW_DATEINSTALLED IS NOT NULL
and (RAW_DATEINSTALLED = '''' -- Empty string
or RAW_DATEINSTALLED::DATE > CURRENT_DATE());

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Future dateinstalled set to null='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
************************************/


--BEGIN TRANSACTION;
UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set VENDOR = ''Citrix''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%CITRIX%'';

UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set VENDOR = ''Cisco''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%CISCO%'';

UPDATE TEMP_ASSET_SOFTWARE_TOMTEST 
set VENDOR = ''Microsoft''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%MICROSOFT%'';

Msg := ''Vendor has been set'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;

--------------------------------------------------------------------------
--
-- INSERT/UPDATE CORE.ASSET_SOFTWARE USING CORE.TEMP_ASSET_SOFTWARE
--
--------------------------------------------------------------------------

--BEGIN TRANSACTION;
MERGE INTO CORE.ASSET_SOFTWARE_TOMTEST as target
USING 
(SELECT 
    MAX(S.DATEINSTALLED) as DATEINSTALLED,
    S.DW_ASSET_ID,
    S.MAJOR,
    S.MINOR,
    S.SOFTWARENAME,
    S.SOURCE_TOOL,
    ''TBD'' as SWAM_CATEGORY,
    ''TBD'' as SWAM_SUBCATEGORY,
    S.VENDOR,
    S.VERSION,
    S.PLUGIN_ID AS SOURCETOOL_ENHANCEMENT,
    CASE WHEN SM.SOFTWARE_ID IS NOT NULL AND SM.SOFTWARE_ID > 0 THEN 
        SM.SOFTWARE_ID 
    ELSE 
        -1 
    END AS SOFTWARE_NAME_ID
    FROM CORE.TEMP_ASSET_SOFTWARE_TOMTEST S
    LEFT JOIN SANDBOX.SOFTWARE_NAME_MASTER SM ON SANDBOX.GET_SOFTWARE_KEY(S.SOFTWARENAME) = SM.SOFTWARE_KEY
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID
    GROUP BY DW_ASSET_ID,MAJOR,MINOR,SOFTWARENAME,SOURCE_TOOL,SWAM_CATEGORY,SWAM_SUBCATEGORY,VENDOR,VERSION, SOURCETOOL_ENHANCEMENT, SM.SOFTWARE_ID
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.SOFTWARENAME = target.SOFTWARENAME and src.VERSION = target.VERSION)

WHEN MATCHED THEN UPDATE SET 
    target.LASTSEEN = CURRENT_TIMESTAMP(),
    target.SOURCETOOL_ENHANCEMENT = src.SOURCETOOL_ENHANCEMENT,
    target.SOFTWARE_NAME_ID = src.SOFTWARE_NAME_ID

WHEN NOT MATCHED THEN INSERT (
    DATEINSTALLED
    ,DW_ASSET_ID
    ,FIRSTSEEN
    ,INSERT_DATE
    ,LASTSEEN
    ,MAJOR
    ,MINOR
    ,SOFTWARENAME
    ,SOURCE_TOOL
    ,SWAM_CATEGORY
    ,SWAM_SUBCATEGORY
    ,VENDOR
    ,VERSION
    ,SOURCETOOL_ENHANCEMENT
    ,SOFTWARE_NAME_ID
)
VALUES (
    src.DATEINSTALLED
    ,src.DW_ASSET_ID
    ,CURRENT_TIMESTAMP() -- FIRSTSEEN
    ,CURRENT_TIMESTAMP() -- INSERT_DATE
    ,CURRENT_TIMESTAMP() -- LASTSEEN
    ,src.MAJOR
    ,src.MINOR
    ,src.SOFTWARENAME
    ,src.SOURCE_TOOL
    ,src.SWAM_CATEGORY
    ,src.SWAM_SUBCATEGORY
    ,src.VENDOR
    ,src.VERSION
    ,src.SOURCETOOL_ENHANCEMENT
    ,src.SOFTWARE_NAME_ID
);

Msg := ''CORE.ASSET_SOFTWARE updated'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
--COMMIT;


--BEGIN TRANSACTION;
--
-- Update ASSET LASTSEEN_SWAM and SOURCE_TOOL_SWAM
--
UPDATE ASSET_TOMTEST upd
set LASTSEEN_SWAM = sft.LASTSEEN
,SOURCE_TOOL_SWAM = :SOURCETOOL
FROM ASSET_TOMTEST a
JOIN (select DW_ASSET_ID,MAX(LASTSEEN) as LASTSEEN
    from ASSET_SOFTWARE_TOMTEST group by DW_ASSET_ID) sft on sft.DW_ASSET_ID = a.DW_ASSET_ID
WHERE upd.DW_ASSET_ID = a.DW_ASSET_ID;
--COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_TENABLE_SOFTWARE_V2"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Stored procedure used to populate CORE.ASSET_SOFTWARE table'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PULL_TENABLE_SOFTWARE_V2'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;
SOURCETOOL varchar := ''Tenable'';
PLUGIN_20811_COUNT NUMBER := 0;
PLUGIN_22869_COUNT NUMBER := 0;
PLUGIN_45590_COUNT NUMBER := 0;

--
-- CONCEPT: Extract (DW_ASSET_ID, PLUGIN_ID, RAW_PRODUCT, SOURCE_TOOL, SNAPSHOT_ID) regardless of PLUGIN_ID.
--          Then obtain PRODUCT_NAME, DATE_INSTALLED, VERSION from RAW_PRODUCT. 
-- It is preferable to write directly to the ASSET_SOFTWARE table but there are more plugins that need to be included
-- and many unknowns about the parsing and cleaning of the data. Therefore, we will continue to write to the
--
--
-- Plugin 22869	Software Enumeration (SSH)
-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)
-- Plugin 45590 Common Platform Enumeration (CPE)

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--TRUNCATE CORE.TEMP_ASSET_SOFTWARE;


--
-- Plugin 20811
--
-- General Format of plugin
--      <plugin_output> (All plugins start with this)
--      Preamble ("The following software are installed on the remote host :"), Ths is the same for AWS and CCIC
--      List of software (See notes about deliminator below)
--      Installed updates title ("The following updates are installed :"))
--      List of installed updates (See notes about deliminator below)
--      </plugin_output> (All plugins end with this)
--
-- Actual Finding in one plugintext (The 2nd set of software and updates are identical)
--      <plugin_output>
--      The following software are installed on the remote host :
--      List of software...
--      The following updates are installed :
--      List of updates...
--      The following software are installed on the remote host :
--      List of software...
--      The following updates are installed :
--      List of updates...
--      </plugin_output>
--
-- 1) For CCIC VUL each software is delineated with a Line-Feed character chr(10)
-- 2) For AWS VUL each software is NOT delineated with a Line-Feed character chr(10)
-- 3) For CCIC AND AWS a right-bracket chr(93) can be used to delineate the software IF the
--      version/install date format is replaced. 
--      e.g [version 12.16.2020.01]  [installed on 2024/04/29]; The "] [" is replaced with 2 back-to-back characters that are
--      highly unlikely to occur naturally in the data (see VERSION_DELIMINATOR)
-- 4) Install date is not always present
-- 5) At this time we do not want the list of updates
-- 6) Sometimes the software version does not have the version tag leaving us to determine the version as part of parsing
--

IF (:DATACATEGORY = ''CCIC VUL'') THEN
    BEGIN
    BEGIN TRANSACTION;
    INSERT INTO CORE.TEMP_ASSET_SOFTWARE
    (
    DW_ASSET_ID,
    PLUGIN_ID,
    RAW_PRODUCT,
    SOURCE_TOOL,
    SNAPSHOT_ID
    )
    SELECT t.DW_ASSET_ID,t.PLUGIN_ID,t.RAW_PRODUCT,:SOURCETOOL as SOURCE_TOOL,:P_SNAPSHOT_ID
    FROM (
    select r.dw_asset_id,r.PLUGIN_ID
    ,split_part(plugintext,''The following software are installed on the remote host :'',2) as PREAMBLE_REMOVED
    ,split_part(PREAMBLE_REMOVED,''The following updates are installed'',1) as UPDATES_REMOVED
    ,split_part(UPDATES_REMOVED,''</plugin_output>'',1) as USABLE_PLUGINTEXT
    ,ARRAY_DISTINCT(STRTOK_TO_ARRAY(USABLE_PLUGINTEXT,CHR(10))) as SOFTARRAY
    ,NULLIF(TRIM(REPLACE(f.value::string,CHR(10),'''')),'''') as RAW_PRODUCT
    FROM CORE.RAW_TENABLE_VUL r
    JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID and a.IS_APPLICABLE = 1 -- We only want active assets
    join table(flatten(SOFTARRAY,outer=>true)) as f
    where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and r.DW_ASSET_ID IS NOT NULL 
    and r.PLUGIN_ID = ''20811'' -- Microsoft Windows Installed Software Enumeration (credentialed check)
    and NULLIF(TRIM(RAW_PRODUCT),'''') IS NOT NULL -- Must be non-null
    and RAW_PRODUCT NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT like ''%version Asset_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
    and NOT REGEXP_LIKE(RAW_PRODUCT,''[{][A-Za-z0-9]{8}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{12}[{] .*'') -- {F38DB479-C9A3-412F-83C8-09DFF5BBC210}
    ) t
    WHERE NULLIF(t.RAW_PRODUCT,'''') IS NOT NULL;

    PLUGIN_20811_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
ELSE -- AWS VUL/AWS VUL MITIGATED/MAG VUL/MAG VUL MITIGATED
    BEGIN
    BEGIN TRANSACTION;
    INSERT INTO CORE.TEMP_ASSET_SOFTWARE
    (
    DW_ASSET_ID,
    PLUGIN_ID,
    RAW_PRODUCT,
    SOURCE_TOOL,
    SNAPSHOT_ID
    )
    SELECT t.DW_ASSET_ID,t.PLUGIN_ID,t.RAW_PRODUCT,:SOURCETOOL as SOURCE_TOOL,:P_SNAPSHOT_ID
    FROM (
    select r.dw_asset_id,r.PLUGIN_ID
    ,split_part(plugintext,''The following software are installed on the remote host :'',2) as PREAMBLE_REMOVED
    ,split_part(PREAMBLE_REMOVED,''The following updates are installed'',1) as UPDATES_REMOVED
    ,split_part(UPDATES_REMOVED,''</plugin_output>'',1) as USABLE_PLUGINTEXT
    ,REPLACE(USABLE_PLUGINTEXT,'']  [installed on'',(CHR(9) || ''installed on'')) as READY_FOR_ARRAY
    ,ARRAY_DISTINCT(STRTOK_TO_ARRAY(READY_FOR_ARRAY,'']'')) as SOFTARRAY
    ,NULLIF(TRIM(f.value::string),'''') as RAW_PRODUCT
    FROM CORE.RAW_TENABLE_VUL r
    JOIN CORE.ASSET a on a.DW_ASSET_ID = r.DW_ASSET_ID and a.IS_APPLICABLE = 1 -- We only want active assets
    join table(flatten(SOFTARRAY,outer=>true)) as f
    where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
    and r.DW_ASSET_ID IS NOT NULL 
    and r.PLUGIN_ID = ''20811'' -- Microsoft Windows Installed Software Enumeration (credentialed check)
    and NULLIF(TRIM(RAW_PRODUCT),'''') IS NOT NULL -- Must be non-null
    and RAW_PRODUCT NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT like ''%version Asset_ID%'' -- Exclude asset tags
    and RAW_PRODUCT NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
    and NOT REGEXP_LIKE(RAW_PRODUCT,''[{][A-Za-z0-9]{8}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{4}-[A-Za-z0-9]{12}[{] .*'') -- {F38DB479-C9A3-412F-83C8-09DFF5BBC210}
    ) t
    ;

    PLUGIN_20811_COUNT := SQLROWCOUNT;
    COMMIT;
    END;
END IF;

If (PLUGIN_20811_COUNT > 0) THEN
    BEGIN
    Msg := ''TEMP_ASSET_SOFTWARE(pluginid 20811) Written='' || :PLUGIN_20811_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
END IF;



--
-- Remove Line-Feed from PRODUCT_NAME
-- Dont change RAW_DATEINSTALLED below. This will help diagnose future unexpected date formats.
-- 250102 added NULLIF
--
UPDATE CORE.TEMP_ASSET_SOFTWARE
set PRODUCT_NAME = trim(REPLACE(SPLIT_PART(RAW_PRODUCT,''['',1),CHR(10),''''))
,RAW_DATEINSTALLED = NULLIF(trim(REPLACE(SPLIT_PART(RAW_PRODUCT,''installed on '',2),'']'','''')),'''')
,RAW_VERSION = nullif(trim(replace(split_part(split_part(split_part(RAW_PRODUCT,''[version'',2),'']'',1),''installed on'',1)
,'']'','''')),'''')
,DATA_WARNING_ARRAY = ARRAY_CONSTRUCT()
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;

----------------------------------------------------------------------------------
--
-- Resolve version that does not fit standard format e.g. [version
--
----------------------------------------------------------------------------------

--
-- 01/01/2013 11.0.6.6840
--
UPDATE CORE.TEMP_ASSET_SOFTWARE
set RAW_VERSION = nullif(split_part(RAW_VERSION,'' '',2),'''')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_VERSION,''[0-9]{1,2}/[0-9]{1,2}/[0-9]{4} .*'');

--
-- 250115 resolve version that does not fit standard format e.g. [version
-- Remove version from PRODUCT_NAME
--
UPDATE TEMP_ASSET_SOFTWARE
set PRODUCT_NAME = TRIM(SUBSTRING(PRODUCT_NAME,1,position('' version '',lower(PRODUCT_NAME))))
,RAW_VERSION = NULLIF(TRIM(SUBSTRING(PRODUCT_NAME,(position('' version '',lower(PRODUCT_NAME)) + 9))),'''')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and (nullif(RAW_VERSION,'''') is null and lower(PRODUCT_NAME) like ''% version %'');

--
-- FOR NOW, MAKE VERSION = RAW_VERSION
-- THERE ARE OTHER VERSION FORMATS THAT WILL ALSO NEED TO BE PARSED
--
UPDATE CORE.TEMP_ASSET_SOFTWARE
set VERSION = NULLIF(RAW_VERSION,'''')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(RAW_VERSION,'''') IS NOT NULL;

--------------------------------------------------------------------------
--
-- DETERMINE IF SOFTWARE ALREADY EXISTS
--
--------------------------------------------------------------------------

UPDATE CORE.TEMP_ASSET_SOFTWARE upd
set DW_SWAM_ID = soft.DW_SWAM_ID
FROM CORE.TEMP_ASSET_SOFTWARE newsoft
JOIN CORE.ASSET_SOFTWARE soft on soft.DW_ASSET_ID = newsoft.DW_ASSET_ID and soft.SOFTWARENAME = newsoft.PRODUCT_NAME and soft.VERSION = newsoft.VERSION
WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID and upd.DW_ASSET_ID = newsoft.DW_ASSET_ID 
and newsoft.PRODUCT_NAME IS NOT NULL and newsoft.VERSION IS NOT NULL
and upd.PRODUCT_NAME = newsoft.PRODUCT_NAME and upd.VERSION = newsoft.VERSION;

--------------------------------------------------------------------------
--
-- CONVERT VARIOUS DATEINSTALLED FORMATS
-- NO NEED TO CONVERT DATEINSTALLED IF SOFTWARE ALREADY EXISTS
--
--------------------------------------------------------------------------

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''MM/DD/YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''MM/DD/YYYY'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''MM-DD-YY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''MM-DD-YY'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''YYYY/MM/DD'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''YYYY/MM/DD'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DD.MM.YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DD.MM.YYYY'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''MMMM DD, YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''MMMM DD, YYYY'') is not null;

--
-- DO WE ALSO NEED: MM DD YY, HH12:MI AM
--

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''MM/DD/YY, HH12:MI PM'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''MM/DD/YY, HH12:MI PM'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS YYYY'') is not null;

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS CST YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS CST YYYY'') is not null; -- Cant find symbol for TimeZone

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS CDT YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS CDT YYYY'') is not null; -- Cant find symbol for TimeZone

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS EST YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS EST YYYY'') is not null; -- Cant find symbol for TimeZone

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS EDT YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS EDT YYYY'') is not null; -- Cant find symbol for TimeZone

UPDATE TEMP_ASSET_SOFTWARE
set DATEINSTALLED = TO_DATE(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS PDT YYYY'')
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and RAW_DATEINSTALLED IS NOT NULL and DATEINSTALLED IS NULL
and try_to_date(RAW_DATEINSTALLED,''DY MMMM DD HH24:MI:SS PDT YYYY'') is not null; -- Cant find symbol for TimeZone




---------------------------------------------------------------------------------------------------
-- Check for remaining issues
-- a) RAW_PRODUCT has (installed on) keyword but date was not parsed into raw_dateinstalled
-- b) raw_dateinstalled was populated but could not be converted to date
---------------------------------------------------------------------------------------------------

UPDATE TEMP_ASSET_SOFTWARE
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''RAW_DATEINSTALLED not converted'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and DATEINSTALLED IS NULL 
and (nullif(raw_dateinstalled,'''') is not null or lower(RAW_PRODUCT) like ''%installed on%'');

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''RAW_DATEINSTALLED not converted='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

UPDATE TEMP_ASSET_SOFTWARE
set DATA_WARNING_ARRAY = ARRAY_APPEND(DATA_WARNING_ARRAY,''RAW_VERSION not converted='')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_SWAM_ID IS NULL and VERSION IS NULL 
and (nullif(RAW_VERSION,'''') is not null or lower(RAW_PRODUCT) like ''% version%'');

RECORD_COUNT := SQLROWCOUNT;

If (:RECORD_COUNT > 0) THEN
    BEGIN
    Msg := ''RAW_VERSION not converted='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);   
    END;
END IF;

Msg := ''Setting Vendor'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;
UPDATE TEMP_ASSET_SOFTWARE 
set VENDOR = ''Citrix''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(PRODUCT_NAME) LIKE ''%CITRIX%'';

UPDATE TEMP_ASSET_SOFTWARE 
set VENDOR = ''Cisco''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(PRODUCT_NAME) LIKE ''%CISCO%'';

UPDATE TEMP_ASSET_SOFTWARE 
set VENDOR = ''Microsoft''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(PRODUCT_NAME) LIKE ''%MICROSOFT%'';

Msg := ''Vendor has been set'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

--------------------------------------------------------------------------
--
-- INSERT/UPDATE CORE.ASSET_SOFTWARE USING CORE.TEMP_ASSET_SOFTWARE
--
--------------------------------------------------------------------------
BEGIN TRANSACTION;
MERGE INTO CORE.ASSET_SOFTWARE as target
USING 
(SELECT MAX(DATEINSTALLED) as DATEINSTALLED,DW_ASSET_ID,PRODUCT_NAME,SOURCE_TOOL,VENDOR,VERSION
    FROM CORE.TEMP_ASSET_SOFTWARE
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID
    GROUP BY DW_ASSET_ID,PRODUCT_NAME,SOURCE_TOOL,VENDOR,VERSION
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.PRODUCT_NAME = target.SOFTWARENAME and src.VERSION = target.VERSION)

WHEN MATCHED THEN UPDATE SET 
    target.LASTSEEN = CURRENT_TIMESTAMP()

WHEN NOT MATCHED THEN INSERT (
    DATEINSTALLED
    ,DW_ASSET_ID
    ,FIRSTSEEN
    ,INSERT_DATE
    ,LASTSEEN
    ,MAJOR
    ,MINOR
    ,SOFTWARENAME -- TOBE RENAMED TO PRODUCT_NAME
    ,SOURCE_TOOL
    ,SWAM_CATEGORY
    ,SWAM_SUBCATEGORY
    ,VENDOR
    ,VERSION
)
VALUES (
    src.DATEINSTALLED
    ,src.DW_ASSET_ID
    ,CURRENT_TIMESTAMP() -- FIRSTSEEN
    ,CURRENT_TIMESTAMP() -- INSERT_DATE
    ,CURRENT_TIMESTAMP() -- LASTSEEN
    ,split_part(src.VERSION,''.'',1) -- MAJOR
    ,split_part(split_part(src.VERSION,''.'',2),''.'',1) -- MINOR
    ,src.PRODUCT_NAME
    ,src.SOURCE_TOOL
    ,''TBD'' -- SWAM_CATEGORY
    ,''TBD'' -- SWAM_SUBCATEGORY
    ,src.VENDOR
    ,src.VERSION
);

Msg := ''CORE.ASSET_SOFTWARE updated'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


BEGIN TRANSACTION;
--
-- Update ASSET LASTSEEN_SWAM and SOURCE_TOOL_SWAM
--
UPDATE CORE.ASSET upd
set LASTSEEN_SWAM = sft.LASTSEEN
,SOURCE_TOOL_SWAM = :SOURCETOOL
FROM CORE.ASSET a
JOIN (select DW_ASSET_ID,MAX(LASTSEEN) as LASTSEEN
    from CORE.ASSET_SOFTWARE group by DW_ASSET_ID) sft on sft.DW_ASSET_ID = a.DW_ASSET_ID
WHERE upd.DW_ASSET_ID = a.DW_ASSET_ID;
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_START_PROCEDURE"("P_APPL" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write Start of Application message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_START_PROCEDURE'';
ExceptionMsg varchar := ''Default'';
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

BEGIN TRANSACTION;
insert into CORE.MSGLOG (APPL,MSG) VALUES(:P_APPL,''Starting Application'');
COMMIT;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TRAL_EVALUATION"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Evaluate systems to determine if OA metrics passed such that a TRigger Accountability Log (TRAL) can be generated.'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_TRAL_EVALUATION'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TodaysDate date := CURRENT_DATE();
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- TEMPORARY -  Need to ensure same System/Metric is unique  (Only one dateIdentified)
--TRUNCATE TABLE CORE.TRAL_Log;

/*
Trigger Description 	RL1	RL2	RL3
Failed to complete Pen Test within the specified frequency.	N/A	2	2
Failed to complete ACT within the specified frequency.	1	2	3
System exceeded specified threshold for Vuln Risk Tolerance. 	2	2	2
System exceeded the specified threshold for Resiliency Score. 	2	2	3
System exceeded threshold for Asset Risk Tolerance. 	1	1	2
			
Low Severity: 	1		
Moderate Severity:	2		
High Severity:	3		

ID	MetricName
1	Last Pen Test
2	Last ACT
3	Vuln Risk Tolerance
4	Resiliency Score
5	Asset Risk Tolerance
*/

-- Create new TRAL_Log if SystemID/MetricID does not already exist
INSERT INTO CORE.TRAL_Log
           (dateIdentified
           ,SYSTEM_ID 
           ,TRAL_METRIC_ID 
		   ,InitialScore
           ,INSERT_DATE)
select 
:TodaysDate
,s.SYSTEM_ID
,TM.TRAL_METRIC_ID
,DATEDIFF(d,s.Last_Pentest_Date,CURRENT_DATE()) 
,:TodaysDate
FROM CORE.Systems s
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
where s.Is_PhantomSystem = 0 
and tm.MetricName = ''Last Pen Test''
and (s.Last_Pentest_Date IS NULL or DATEDIFF(d,s.Last_Pentest_Date,CURRENT_DATE()) > trsl.Threshold) 
and l.ID IS NULL;

--Msg := ''Last Pen Test INSERT complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

-- INTENT OF THIS CODE IS TO CREATE A NEW (dateIdentified) if a prior issue had been mitigated
--or (s.Last_Pentest_Date IS NOT NULL and l.dateMitigated IS NOT NULL and s.Last_Pentest_Date > l.dateMitigated)

-- Create new TRAL_Log if SystemID/MetricID does not already exist
INSERT INTO CORE.TRAL_Log
           (dateIdentified
           ,SYSTEM_ID 
           ,TRAL_METRIC_ID 
		   ,InitialScore
           ,INSERT_DATE)
select 
:TodaysDate
,s.SYSTEM_ID
,TM.TRAL_METRIC_ID
,DATEDIFF(d,s.Last_ACT_Date,CURRENT_DATE()) 
,:TodaysDate
FROM CORE.Systems s
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
where s.Is_PhantomSystem = 0 
and tm.MetricName = ''Last ACT''
and (s.Last_ACT_Date IS NULL or DATEDIFF(d,s.Last_ACT_Date,CURRENT_DATE()) > trsl.Threshold)
and l.ID IS NULL;

--Msg := ''Last ACT INSERT complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

-- Create new TRAL_Log if SystemID/MetricID does not already exist
INSERT INTO CORE.TRAL_Log
           (dateIdentified
           ,SYSTEM_ID 
           ,TRAL_METRIC_ID 
		   ,InitialScore
           ,INSERT_DATE)
select 
:TodaysDate
,s.SYSTEM_ID
,TM.TRAL_METRIC_ID
,ss.VulnRiskTolerance
,:TodaysDate
FROM CORE.Systems s
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
	and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
where s.Is_PhantomSystem = 0 
and tm.MetricName = ''Vuln Risk Tolerance''
and ss.VulnRiskTolerance > trsl.Threshold
and l.ID IS NULL;

--Msg := ''Vuln Risk Tolerance INSERT complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

-- Create new TRAL_Log if SystemID/MetricID does not already exist
INSERT INTO CORE.TRAL_Log
           (dateIdentified
           ,SYSTEM_ID 
           ,TRAL_METRIC_ID 
		   ,InitialScore
           ,INSERT_DATE)
select 
:TodaysDate
,s.SYSTEM_ID
,TM.TRAL_METRIC_ID
,ss.ResiliencyScore 
,:TodaysDate
FROM CORE.Systems s
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
	and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
where s.Is_PhantomSystem = 0 
and tm.MetricName = ''Resiliency Score''
and ss.ResiliencyScore > trsl.Threshold
and l.ID IS NULL;

--Msg := ''Resiliency Score INSERT complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

-- Create new TRAL_Log if SystemID/MetricID does not already exist
INSERT INTO CORE.TRAL_Log
           (dateIdentified
           ,SYSTEM_ID 
           ,TRAL_METRIC_ID 
		   ,InitialScore
           ,INSERT_DATE)
select 
:TodaysDate
,s.SYSTEM_ID
,TM.TRAL_METRIC_ID
,ABS(ss.AssetRiskTolerance)
,:TodaysDate
FROM CORE.Systems s
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
	and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
where s.Is_PhantomSystem = 0 
and tm.MetricName = ''Asset Risk Tolerance''
and ABS(ss.AssetRiskTolerance) > trsl.Threshold
and l.ID IS NULL;

--Msg := ''Asset Risk Tolerance INSERT complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

--
-- Check for mitigation
--
UPDATE CORE.TRAL_LOG upd -- 240509 CR893 EBF
set dateMitigated = CURRENT_DATE()
,SubsequentScore = t.subsequentScore
,DATEMODIFIED = CURRENT_TIMESTAMP() -- 240509 CR893 EBF
FROM CORE.TRAL_Log tl
JOIN (select s.SYSTEM_ID,TM.TRAL_METRIC_ID,DATEDIFF(d,coalesce(s.Last_Pentest_Date,CAST(''01/01/1900'' as datetime)),CURRENT_DATE()) as subsequentScore
	FROM CORE.Systems s
	JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
	JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
	JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
	JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
	where s.Is_PhantomSystem = 0 
	and tm.MetricName = ''Last Pen Test''
	and (l.dateMitigated IS NULL or (s.Last_Pentest_Date IS NOT NULL and s.Last_Pentest_Date > l.dateMitigated))
	and DATEDIFF(d,coalesce(s.Last_Pentest_Date,CAST(''01/01/1900'' as datetime)),CURRENT_DATE()) <= trsl.Threshold
	) t on t.SYSTEM_ID = tL.SYSTEM_ID and t.TRAL_METRIC_ID = TL.TRAL_METRIC_ID
where upd.SYSTEM_ID = tL.SYSTEM_ID and upd.TRAL_METRIC_ID = TL.TRAL_METRIC_ID; -- 240509 CR893 EBF

--Msg := ''Last Pen Test UPDATE complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

UPDATE CORE.TRAL_LOG upd -- 240509 CR893 EBF
set dateMitigated = CURRENT_DATE()
,SubsequentScore = t.subsequentScore
,DATEMODIFIED = CURRENT_TIMESTAMP() -- 240509 CR893 EBF
FROM CORE.TRAL_Log tl
JOIN (select s.SYSTEM_ID,TM.TRAL_METRIC_ID,DATEDIFF(d,coalesce(s.Last_ACT_Date,CAST(''01/01/1900'' as datetime)),CURRENT_DATE()) as subsequentScore
	FROM CORE.Systems s
	JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
	JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
	JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
	JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
	where s.Is_PhantomSystem = 0 
	and tm.MetricName = ''Last ACT''
	and (l.dateMitigated IS NULL or (s.Last_ACT_Date IS NOT NULL and s.Last_ACT_Date > l.dateMitigated))
	and DATEDIFF(d,coalesce(s.Last_ACT_Date,CAST(''01/01/1900'' as datetime)),CURRENT_DATE()) <= trsl.Threshold
	) t on t.SYSTEM_ID = tL.SYSTEM_ID and t.TRAL_METRIC_ID = TL.TRAL_METRIC_ID
where upd.SYSTEM_ID = tL.SYSTEM_ID and upd.TRAL_METRIC_ID = TL.TRAL_METRIC_ID; -- 240509 CR893 EBF

--Msg := ''Last ACT UPDATE complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

UPDATE CORE.TRAL_LOG upd -- 240509 CR893 EBF
set dateMitigated = CURRENT_DATE()
,SubsequentScore = t.subsequentScore
,DATEMODIFIED = CURRENT_TIMESTAMP() -- 240509 CR893 EBF
FROM CORE.TRAL_Log tl
JOIN (select s.SYSTEM_ID,TM.TRAL_METRIC_ID,ss.VulnRiskTolerance as subsequentScore
	FROM CORE.Systems s
	JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
	JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
	JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
	JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
		and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
	LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
	where s.Is_PhantomSystem = 0 
	and tm.MetricName = ''Vuln Risk Tolerance''
	and l.dateMitigated IS NULL
	and ss.VulnRiskTolerance <= trsl.Threshold
	) t on t.SYSTEM_ID = tL.SYSTEM_ID and t.TRAL_METRIC_ID = TL.TRAL_METRIC_ID
where upd.SYSTEM_ID = tL.SYSTEM_ID and upd.TRAL_METRIC_ID = TL.TRAL_METRIC_ID; -- 240509 CR893 EBF

--Msg := ''Vuln Risk Tolerance UPDATE complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

UPDATE CORE.TRAL_LOG upd -- 240509 CR893 EBF
set dateMitigated = CURRENT_DATE()
,SubsequentScore = t.subsequentScore
,DATEMODIFIED = CURRENT_TIMESTAMP() -- 240509 CR893 EBF
FROM CORE.TRAL_Log tl
JOIN (select s.SYSTEM_ID,TM.TRAL_METRIC_ID,ss.ResiliencyScore as subsequentScore
	FROM CORE.Systems s
	JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
	JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
	JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
	JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
		and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
	LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
	where s.Is_PhantomSystem = 0 
	and tm.MetricName = ''Resiliency Score''
	and l.dateMitigated IS NULL
	and ss.ResiliencyScore <= trsl.Threshold
	) t on t.SYSTEM_ID = tL.SYSTEM_ID and t.TRAL_METRIC_ID = TL.TRAL_METRIC_ID
where upd.SYSTEM_ID = tL.SYSTEM_ID and upd.TRAL_METRIC_ID = TL.TRAL_METRIC_ID; -- 240509 CR893 EBF

--Msg := ''Resiliency Score UPDATE complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

UPDATE CORE.TRAL_LOG upd -- 240509 CR893 EBF
set dateMitigated = CURRENT_DATE()
,SubsequentScore = t.subsequentScore
,DATEMODIFIED = CURRENT_TIMESTAMP() -- 240509 CR893 EBF
FROM CORE.TRAL_Log tl
JOIN (select s.SYSTEM_ID,TM.TRAL_METRIC_ID,ABS(ss.AssetRiskTolerance) as subsequentScore
	FROM CORE.Systems s
	JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
	JOIN CORE.TRAL_RiskSeverityLevel trsl on TRSL.SYSTEMRISKCATEGORY_ID = src.SYSTEMRISKCATEGORY_ID
	JOIN CORE.TRAL_Metric tm on TM.TRAL_METRIC_ID = TRSL.TRAL_METRIC_ID
	JOIN CORE.SystemSummary ss on SS.SYSTEM_ID  = s.SYSTEM_ID
		and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary)
	LEFT OUTER JOIN CORE.TRAL_Log l on L.SYSTEM_ID = s.SYSTEM_ID and L.TRAL_METRIC_ID = TM.TRAL_METRIC_ID
	where s.Is_PhantomSystem = 0 
	and tm.MetricName = ''Asset Risk Tolerance''
	and l.dateMitigated IS NULL
	and ABS(ss.AssetRiskTolerance) <= trsl.Threshold
	) t on t.SYSTEM_ID = tL.SYSTEM_ID and t.TRAL_METRIC_ID = TL.TRAL_METRIC_ID
where upd.SYSTEM_ID = tL.SYSTEM_ID and upd.TRAL_METRIC_ID = TL.TRAL_METRIC_ID; -- 240509 CR893 EBF

--Msg := ''Asset Risk Tolerance UPDATE complete'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl, :Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_ASSET"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Update ASSET table using TEMP_HWAM data'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_UPDATE_ASSET'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED''; -- 241104 CR1021
DATACATEGORY varchar;
RECORD_COUNT NUMBER;

BEGIN
select DATACATEGORY into :DATACATEGORY FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

UPDATE ASSET upd
set
ASSET_ID_TATTOO = coalesce(upd.ASSET_ID_TATTOO,src.ASSET_ID_TATTOO) -- Use src value only if existing (upd) value is null
,AWS_ACCOUNTID = coalesce(src.AWS_ACCOUNTID,upd.AWS_ACCOUNTID) -- Retain value if source is null
,AWS_INSTANCESTATUS = coalesce(src.INSTANCESTATUS,upd.AWS_INSTANCESTATUS) -- Retain value if source is null
,AZURE_SUBSCRIPTION_ID = coalesce(src.AZURE_SUBSCRIPTION_ID,upd.AZURE_SUBSCRIPTION_ID) -- 241125 CR1038 -- Retain value if source is null
,COMPUTER_TYPE = coalesce(src.COMPUTER_TYPE,upd.COMPUTER_TYPE) -- Retain value if source is null
,DATEDELETED = NULL -- Asset might have been inactive (aka logically deleted)
,DELETIONREASON = NULL -- Asset might have been inactive (aka logically deleted)
,DEVICEMODEL = coalesce(src.DEVICEMODEL,upd.DEVICEMODEL) -- 230927 Retain value if source is null
,DEVICETYPE = coalesce(src.DEVICE_TYPE,upd.DEVICETYPE) -- Retain value if source is null
,ENVIRONMENT = coalesce(src.ENVIRONMENT,upd.ENVIRONMENT) -- Retain value if source is null
,IS_APPLICABLE = TRUE -- If asset was inactive (aka logically deleted) then reactivate it since we have new data
,IS_FORESCOUT_MANAGED = coalesce(src.IS_FORESCOUT_MANAGED,upd.IS_FORESCOUT_MANAGED) -- 240705 CR931
,IS_TENABLE_CREDENTIALED_SCAN = coalesce(src.IS_TENABLE_CREDENTIALED_SCAN,upd.IS_TENABLE_CREDENTIALED_SCAN) -- 240705 CR931
,LAST_CONFIRMED_TIME = GREATEST(src.LAST_CONFIRMED_TIME,upd.LAST_CONFIRMED_TIME) 
,LASTASSETUPDATE = CURRENT_TIMESTAMP()
,MODIFIEDBY_SNAPSHOT_ID = src.SNAPSHOT_ID
,MODIFIEDBY_TEMP_DW_ASSET_ID = src.TEMP_DW_ASSET_ID -- 240705 CR928
,MOTHERBOARD = coalesce(src.MOTHERBOARD,upd.MOTHERBOARD) -- Retain value if source is null
,OS = coalesce(src.OS,upd.OS) -- Retain value if source is null
,OS_BUILD_NUMBER = coalesce(src.OS_BUILD_NUMBER,upd.OS_BUILD_NUMBER) -- 240821 CR958; and Retain value if source is null
,SOURCE_TOOL_LASTSEEN = src.SOURCE_TOOL
--
-- 241104 CR1021 CCIC VUL MITIGATED does not contain metadata tags and so SYSTEM_ID defaults to DATACENTER_ID and should not
-- 240926 Tested is_freeze_system_id to determine if SYSTEM_ID could be changed. This was a special (one-time) case to facilitate DRaaS re-tagging efforts
--        Prior to 240926 SYSTEM_ID was readily changed by any sensor data
-- 
,SYSTEM_ID = case :DATACATEGORY
    when :CCIC_VUL_MITIGATED then upd.SYSTEM_ID -- Retain SYSTEM_ID (DONT ALLOW IT TO BE CHANGED)
    Else src.SYSTEM_ID -- Its ok to change the system that the asset belongs to
    end
,TENABLEUUID = coalesce(src.TENABLEUUID,upd.TENABLEUUID) -- Retain value if source is null
,TENANT_ID = coalesce(upd.TENANT_ID,src.TENANT_ID) -- 240705 CR928 Use src value only if existing (upd) value is null, 240424 CR880 
from -- 240830 1724 CR-TBD reworked finding unique TEMP_HWAM record that represents the distinct DW_ASSET_ID
(SELECT r2.TEMP_HWAM_ID
    FROM (select rank()over(partition by r1.DW_ASSET_ID order by r1.LAST_CONFIRMED_TIME desc,r1.TEMP_HWAM_ID desc) TheRank,r1.TEMP_HWAM_ID
        FROM CORE.TEMP_HWAM r1
        JOIN (select DW_ASSET_ID
        FROM CORE.TEMP_HWAM WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and DW_ASSET_ID IS NOT NULL
        GROUP BY DW_ASSET_ID) d on d.DW_ASSET_ID = r1.DW_ASSET_ID) r2 where r2.TheRank = 1) thi
JOIN CORE.TEMP_HWAM src on src.TEMP_HWAM_ID = thi.TEMP_HWAM_ID -- Single record representing the asset to be updated
where src.SNAPSHOT_ID = :P_SNAPSHOT_ID and src.DW_ASSET_ID IS NOT NULL and upd.DW_ASSET_ID = src.DW_ASSET_ID;

-- 240726 CR928
RECORD_COUNT := SQLROWCOUNT;
Msg := ''Updated ASSET='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;


BEGIN TRANSACTION; -- 241114 CR-EBF for diagnostics
INSERT INTO BUS_CYBER_RISK_MANAGEMENT.CORE.ASSET_SNAPSHOT_LOG (
ASSET_DATECREATED
,ASSET_ID_TATTOO
,AWS_ACCOUNTID
,AWS_INSTANCESTATUS
,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,AXONIUS_INTERNAL_AXONIUS_ID
,BIGFIX_ASSET_ID
,BIOS_GUID
,CLOUD_ID
,COMPUTER_TYPE
,CREATEDBY_RAW_ID
,CREATEDBY_SNAPSHOT_ID
,CREATEDBY_TEMP_DW_ASSET_ID
,DATACENTER_ID
,DATEDELETED
,DATEMODIFIED
,DELETIONREASON
,DEVICEMODEL
,DEVICETYPE
,DW_ASSET_ID
,ENVIRONMENT
,INSERT_DATE
,IS_APPLICABLE
,IS_FORESCOUT_MANAGED
,IS_FREEZE_SYSTEM_ID
,IS_FROM_AWS_FEED
,IS_PRIMARY_FISMA_ID_DERIVED
,IS_SCANNABLE
,IS_TATTOOABLE
,IS_TENABLE_CREDENTIALED_SCAN
,LAST_CONFIRMED_TIME
,LASTASSETUPDATE
,LASTMODIFIEDBY_AWS
,LASTMODIFIEDBY_AXONIUS
,LASTMODIFIEDBY_BIGFIX
,LASTMODIFIEDBY_CROWDSTRIKE
,LASTMODIFIEDBY_FORESCOUT
,LASTMODIFIEDBY_TENABLE
,LASTSEEN_CSM
,LASTSEEN_HWAM
,LASTSEEN_SWAM
,LASTSEEN_VUL
,MODIFIEDBY_RAW_ID
,MODIFIEDBY_SNAPSHOT_ID
,MODIFIEDBY_TEMP_DW_ASSET_ID
,MOTHERBOARD
,OS
,OS_BUILD_NUMBER
,OS_CPE
,OS_VERSION
,PREV_DATEDELETED
,PREV_LAST_CONFIRMED_TIME
,PREV_SYSTEM_ID
,SNAPSHOT_ID
,SOURCE_TOOL_CREATE
,SOURCE_TOOL_CSM
,SOURCE_TOOL_HWAM
,SOURCE_TOOL_LASTSEEN
,SOURCE_TOOL_SWAM
,SOURCE_TOOL_VUL
,SYSTEM_ID
,TENABLEUUID
,TENANT_ID
,VULNRISKTOLERANCE
)
select 
a.INSERT_DATE as ASSET_DATECREATED
,a.ASSET_ID_TATTOO
,a.AWS_ACCOUNTID
,a.AWS_INSTANCESTATUS
,a.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,a.AXONIUS_INTERNAL_AXONIUS_ID
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID
,a.COMPUTER_TYPE
,a.CREATEDBY_RAW_ID
,a.CREATEDBY_SNAPSHOT_ID
,a.CREATEDBY_TEMP_DW_ASSET_ID
,a.DATACENTER_ID
,a.DATEDELETED
,a.DATEMODIFIED
,a.DELETIONREASON
,a.DEVICEMODEL
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,CURRENT_TIMESTAMP() as INSERT_DATE
,a.IS_APPLICABLE
,a.IS_FORESCOUT_MANAGED
,a.IS_FREEZE_SYSTEM_ID
,a.IS_FROM_AWS_FEED
,a.IS_PRIMARY_FISMA_ID_DERIVED
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTMODIFIEDBY_AWS
,a.LASTMODIFIEDBY_AXONIUS
,a.LASTMODIFIEDBY_BIGFIX
,a.LASTMODIFIEDBY_CROWDSTRIKE
,a.LASTMODIFIEDBY_FORESCOUT
,a.LASTMODIFIEDBY_TENABLE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,a.MODIFIEDBY_RAW_ID
,a.MODIFIEDBY_SNAPSHOT_ID
,a.MODIFIEDBY_TEMP_DW_ASSET_ID
,a.MOTHERBOARD
,a.OS
,a.OS_BUILD_NUMBER
,a.OS_CPE
,a.OS_VERSION
,a.PREV_DATEDELETED
,a.PREV_LAST_CONFIRMED_TIME
,a.PREV_SYSTEM_ID
,:P_SNAPSHOT_ID
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,a.SYSTEM_ID
,a.TENABLEUUID
,a.TENANT_ID
,a.VULNRISKTOLERANCE
FROM ASSET a
JOIN TEMP_HWAM th on th.dw_asset_id = a.dw_asset_id and th.TEMP_DW_ASSET_ID = a.MODIFIEDBY_TEMP_DW_ASSET_ID and a.MODIFIEDBY_SNAPSHOT_ID = :P_SNAPSHOT_ID; -- 241120

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Insert ASSET_SNAPSHOT_LOG='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_KEV_CATALOG"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Update KEV_CATALOG with exploitAvailable and FISMAseverity based on actual open vulnerabilities'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_UPDATE_KEV_CATALOG'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

UPDATE CORE.KEV_CATALOG upd
set exploitAvailable = r.exploitAvailable
,FISMAseverity = r.FISMAseverity
,LASTFOUND = r.lastfound
FROM CORE.KEV_CATALOG kev
JOIN (select m.cve,t.exploitAvailable,t.FISMAseverity,T.lastfound
	FROM (SELECT CVE,MAX(lastfound) as MaxLastFound
		FROM CORE.VW_VULMASTER
		where IS_KEV = 1 and MitigationStatus <> ''fixed''
		GROUP by CVE) m
	JOIN (SELECT distinct CVE,lastfound,exploitAvailable,FISMAseverity
		FROM CORE.VW_VULMASTER
		where IS_KEV = 1 and MitigationStatus <> ''fixed'') t on t.CVE = m.CVE and t.lastfound = m.MaxLastFound) r on r.CVE = kev.CVE
where kev.ID = upd.ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_PRIMARY_OP_LOC"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Assign PRIMARY_OPERATING_LOCATION_ID based on first value in PRIMARY_OPERATING_LOCATION'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_UPDATE_PRIMARY_OP_LOC'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
DefaultID varchar := CORE.FN_CRM_GETUID_DEFAULT();

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

-- Set PRIMARY_OPERATING_LOCATION_ID to NULL
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = :DefaultID; -- 231012

COMMIT;

BEGIN TRANSACTION;

-- Set PRIMARY_OPERATING_LOCATION_ID to a phantom ID that indicates the primary operating location has not been assigned
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = CORE.FN_CRM_GETUID_UNASSIGNED_OPLOC() -- 231012 was hard coded
WHERE NULLIF(PRIMARY_OPERATING_LOCATION,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;

-- Search Authorization_Package 1st
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEMS dc on upper(dc.Authorization_Package) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Search Acronym 2nd
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEMS dc on upper(dc.ACRONYM) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Search CommonName 3rd
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEM_COMMONNAME dc on upper(dc.COMMONNAME) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Special; Does not match Autorization Package or Acronym
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = 
CASE upper(split_part(PRIMARY_OPERATING_LOCATION,'','',1))
when ''AMAZON WEB SERVICES'' then ''56FFF52E-175B-4E48-9B38-669C8BC74899'' -- 241024 CR1014
when ''AMAZON WEB SERVICES GOVCLOUD'' then ''5d8a99a8db672340f99cfd721f96190d'' -- 241024 CR1014
when ''AUTONOMIC RESOURCES CLOUD PLATFORM'' then ''B8A904E8-E126-4589-A15D-783E9F65DEE1''
when ''C2C SOLUTIONS INC.'' then ''CD15B586-0B74-4625-94EE-A74A9D0DB12E''
when ''CAHABA'' then ''32B6522E-709A-4550-A475-1476B70BC7B5''
when ''CDS DATA CENTER'' then ''04EAE4CC-6ED2-4E2F-A551-5E23B9D24340''
when ''CGI FEDERAL DATA CENTER'' then ''EDD72375-1795-4395-8B02-DB15F7EC85A0''
when ''CONNOLLY'' then ''DB8E60FE-21FA-4FFC-A3AC-02295B324D63''
when ''GDIT-NEW YORK-MSPSC'' then ''FC7C833D-C6B7-4523-8850-4A0E9958FD0D''
when ''GHI'' then ''F168F3C3-3888-4151-A044-91A16F9B12C5''
when ''HEALTH INTEGRITY'' then ''CB216460-BAEA-4BE5-916B-9B442F66D30A''
when ''IT-CNP'' then ''B4D19F4D-5C47-4E66-89C2-A1EC58027083''
when ''LEWIN GROUP DATA CENTER'' then ''79749F8A-59C7-4AE6-92A4-2F36C3382F05''
when ''MARICOM/CSC'' then ''4AB3EEB6-F7B9-4C03-8600-A937CC139264''
when ''MAXIMUS SUPPORT CENTER'' then ''8EEE4AE4-2D3E-4F74-BB83-ECF3D5D0A748''
when ''MERIDIAN KNOWLEDGE SOLUTIONS'' then ''A48BD76B-ECE3-453E-9BFA-17BB3E7B996F''
when ''MICROSOFT AZURE GOVERNMENT'' then ''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE''
when ''NATIONAL HERITAGE'' then ''42112E95-FDF1-4262-86F5-13F67165A436''
when ''NDCHEALTH DATA CENTER'' then ''55D4EC76-4917-45EA-A7CF-1DEC4EF11500''
when ''PERFORMANT FINANCIAL CORP'' then ''00A23131-F7D5-4CB0-BBA9-95D571B742CB''
when ''PERSPECTA ENTERPRISE SOLUTIONS TULSA'' then ''8EEED60A-080A-42D3-89C3-C17E2B5261B0''
when ''SALESFORCE.COM'' then ''3F9B8D09-DFEA-4C26-BB1D-81616E6B6159''
when ''SAN DIEGO SUPERCOMPUTER'' then ''933B3E39-BC98-4D67-90F2-20F7FF9C9EB8''
when ''VENTECH-ASHBURN'' then ''DB0B74DC-610A-4D35-B645-B16059B5D64A''
when ''VERIZON-CULPEPPER'' then ''3FE7D025-6CEF-48F7-B141-FB3255532A7E''
when ''VIAWEST DATA CENTER'' then ''56B016BE-FD56-48AD-89A1-2755E0C875BA''
when ''XOC DATA CENTER'' then ''2DD3E858-9229-4358-879C-ED41CB52E3BE''
-- with no Else it yields NULL
END
WHERE PRIMARY_OPERATING_LOCATION_ID = :DefaultID;

COMMIT;

BEGIN TRANSACTION;

-- Use default as safety net
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = :DefaultID
WHERE PRIMARY_OPERATING_LOCATION_ID is NULL;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_REPORT_IDS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Update the REPORT_IDS table with enterprise level daily counts. e.g. Systems,Assets,Vulnerabilities'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_UPDATE_REPORT_IDS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
CURRENT_REPORT_ID NUMBER := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS);
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- 231228 added to help shed light on asset count changes from day to day
select count(1) into :RECORD_COUNT FROM CORE.ASSET;
Msg :=  ''Unfiltered count of Assets='' || cast(RECORD_COUNT as varchar);
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 


UPDATE CORE.REPORT_IDS -- 231120
SET ASSETS = (select count(1) from CORE.VW_ASSETS)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240103
SET ASSETS_AWS = (select count(1) from CORE.VW_ASSETS where DATACENTER_ID = ''56FFF52E-175B-4E48-9B38-669C8BC74899'') -- 241011 EBF; Acronym was renamed in CFACTS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240103
SET ASSETS_AWS_GOVCLOUD = (select count(1) from CORE.VW_ASSETS where DATACENTER_ID = ''5d8a99a8db672340f99cfd721f96190d'') -- 241011 EBF; Acronym was renamed in CFACTS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231207
SET ASSETS_CREATED_TODAY = (select count(1) from CORE.ASSET WHERE INSERT_DATE::DATE = CURRENT_DATE()) -- 231228 Use ASSET table not VW_ASSETS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231207
SET ASSETS_DELETED_TODAY = (select count(1) from CORE.ASSET WHERE DATEDELETED::DATE = CURRENT_DATE()) -- Use ASSET table not VW_ASSETS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

select count(1) into :RECORD_COUNT
   FROM (select datacenter_id,asset_id_tattoo 
    from asset where asset_id_tattoo is not null
    group by datacenter_id,asset_id_tattoo having count(1) > 1);

UPDATE CORE.REPORT_IDS 
SET DUPLICATE_DATACENTER_TATTOO_PAIR = :RECORD_COUNT
WHERE REPORT_ID = :CURRENT_REPORT_ID;

select count(1) into :RECORD_COUNT from CORE.TEMP_HWAM where DW_ASSET_ID IS NULL;

UPDATE CORE.REPORT_IDS 
SET TEMP_HWAM_UNASSIGNED_DW_ASSET_ID = :RECORD_COUNT
WHERE REPORT_ID = :CURRENT_REPORT_ID;

select count(1) into :RECORD_COUNT FROM CORE.ASSET where Is_Applicable=1 and DEVICETYPE=''Unknown'' ;

UPDATE CORE.REPORT_IDS 
SET ASSETS_UNKNOWN_DEVICETYPE = :RECORD_COUNT
WHERE REPORT_ID = :CURRENT_REPORT_ID;

select count(1) into :RECORD_COUNT 
FROM CORE.ASSET a 
-- 241213 join DEVICETYPES dt on dt.devicetype = a.devicetype
where a.IS_APPLICABLE = 1 
and a.IS_ENDPOINT = 1 -- 241213
-- 241213 and UPPER(dt.DEVICEROLE) = ''ENDPOINT'' 
and a.LASTSEEN_VUL IS NULL;

UPDATE CORE.REPORT_IDS 
SET ASSETS_NEVER_SCANNED = :RECORD_COUNT
WHERE REPORT_ID = :CURRENT_REPORT_ID;

select count(1) into :RECORD_COUNT 
FROM CORE.ASSET a 
-- 241213 join DEVICETYPES dt on dt.devicetype = a.devicetype
where a.IS_APPLICABLE = 1 
and a.IS_ENDPOINT = 1 -- 241213
-- 241213 and UPPER(dt.DEVICEROLE) = ''ENDPOINT'' 
and a.LASTSEEN_VUL IS NOT NULL and DATEDIFF(day, a.LASTSEEN_VUL, CURRENT_DATE()) > 3;

UPDATE CORE.REPORT_IDS 
SET ASSETS_NOT_SCANNED_LAST3DAYS = :RECORD_COUNT
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_CREATED_TODAY = (select count(1) from CORE.VULPLUGINS_MASTER WHERE INSERT_DATE::DATE = CURRENT_DATE())
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_DELETED_TODAY = (select count(1) from CORE.VULPLUGINS_MASTER WHERE DATEDELETED::DATE = CURRENT_DATE())
WHERE REPORT_ID = :CURRENT_REPORT_ID;

-- Vulnerabilities indirectly considered because Asset record was deleted
UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_INACTIVE_ASSET_TODAY = (select count(1) 
    from CORE.ASSET a
    join CORE.VULPLUGINS_MASTER vm on vm.dw_asset_id = a.dw_asset_id
    where a.datedeleted::date = current_date() and a.is_applicable = 0 and vm.deletionreason IS NULL)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_FIXED_TODAY = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and DATEMITIGATED::DATE = CURRENT_DATE())
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_OPEN = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_REOPENED = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_CRITICAL = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''CRITICAL'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_HIGH = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''HIGH'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_LOW = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''LOW'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240118
SET PLUGINS_MEDIUM = (select count(1) from CORE.VULPLUGINS_MASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''MEDIUM'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET SYSTEMS_DEVELOP = (select count(1) from CORE.VW_SYSTEMS WHERE UPPER(TLC_PHASE) = ''DEVELOP'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET SYSTEMS_INITIATE  = (select count(1) from CORE.VW_SYSTEMS WHERE UPPER(TLC_PHASE) = ''INITIATE'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET SYSTEMS_OPERATE = (select count(1) from CORE.VW_SYSTEMS WHERE UPPER(TLC_PHASE) = ''OPERATE'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET SYSTEMS_RETIRE = (select count(1) from CORE.VW_SYSTEMS WHERE UPPER(TLC_PHASE) = ''RETIRE'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240103
SET VUL_AWS = (select count(1) 
    from CORE.VW_ASSETS a
    join CORE.VW_VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
    where UPPER(vm.MITIGATIONSTATUS) <> ''FIXED'' and a.DATACENTER_ID = ''56FFF52E-175B-4E48-9B38-669C8BC74899'') -- 241011 EBF; Acronym was renamed in CFACTS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 240103
SET VUL_GOVCLOUD = (select count(1) 
    from CORE.VW_ASSETS a
    join CORE.VW_VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
    where UPPER(vm.MITIGATIONSTATUS) <> ''FIXED'' and a.DATACENTER_ID = ''5d8a99a8db672340f99cfd721f96190d'') -- 241011 EBF; Acronym was renamed in CFACTS
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_FIXED_TODAY = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and DATEMITIGATED::DATE = CURRENT_DATE())
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_OPEN = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_REOPENED = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_CRITICAL = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''CRITICAL'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_HIGH = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''HIGH'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_LOW = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''LOW'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231120
SET VUL_MEDIUM = (select count(1) from CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) IN (''OPEN'',''REOPENED'') AND UPPER(FISMASEVERITY) = ''MEDIUM'')
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 231129; Dont use view. It doesnt have DATEDELETED.
SET VUL_DELETED_TODAY = (select count(1) from CORE.VULMASTER WHERE DATEDELETED::DATE = CURRENT_DATE())
WHERE REPORT_ID = :CURRENT_REPORT_ID;

-- Vulnerabilities indirectly considered because Asset record was deleted
UPDATE CORE.REPORT_IDS -- 231129; Dont use view.
SET VUL_INACTIVE_ASSET_TODAY = (select count(1) 
    from CORE.ASSET a
    join CORE.VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
    where a.datedeleted::date = current_date() and a.is_applicable = 0 and vm.deletionreason IS NULL)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 241011
SET ASSETS_SCANNABLE = (select count(1) from CORE.VW_ASSETS where IS_SCANNABLE = 1)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 241011
SET ASSETS_TENABLE_CREDENTIALED_SCAN = (select count(1) from CORE.VW_ASSETS where IS_TENABLE_CREDENTIALED_SCAN = 1)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 241011
SET ASSETS_FORESCOUT_MANAGED  = (select count(1) from CORE.VW_ASSETS where IS_FORESCOUT_MANAGED = 1)
WHERE REPORT_ID = :CURRENT_REPORT_ID;

UPDATE CORE.REPORT_IDS -- 241213
SET ENDPOINTS  = (select count(1) from VW_ASSETS where is_applicable = 1 and is_endpoint = 1)
WHERE REPORT_ID = :CURRENT_REPORT_ID;


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_VULCVE_MASTER"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Update VULMASTER with a) fixed/open/reopened mitigation status, b) plugin deleted reason '
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_UPDATE_VULCVE_MASTER'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
No_Plugins_Msg varchar := ''No plugins'';
DaysUntilVulConsideredDeleted number;
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

UPDATE CORE.VULMASTER upd
set DELETED_PLUGIN_COUNT = coalesce(t.PLUGIN_COUNT,0)
,MAX_PLUGIN_DATEMODIFIED = t.MAX_DATEMODIFIED
FROM CORE.VULMASTER vm
LEFT OUTER JOIN (SELECT vp.DW_ASSET_ID,f.value::string as CVE,MAX(DATEMODIFIED) as MAX_DATEMODIFIED,COUNT(vp.PLUGIN_ID) as PLUGIN_COUNT 
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f
    WHERE vp.DELETIONREASON IS NOT NULL
    GROUP BY vp.DW_ASSET_ID,f.value::string) t on t.DW_ASSET_ID = vm.DW_ASSET_ID and t.CVE = vm.CVE
WHERE upd.DW_VUL_ID = vm.DW_VUL_ID; -- 240120 and t.MAX_DATEMODIFIED >= upd.DATEMODIFIED;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Set VULMASTER.DELETED_PLUGIN_COUNT='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;

UPDATE CORE.VULMASTER upd
set FIXED_PLUGIN_COUNT = coalesce(t.PLUGIN_COUNT,0)
,MAX_PLUGIN_DATEMODIFIED = t.MAX_DATEMODIFIED
FROM CORE.VULMASTER vm
LEFT OUTER JOIN (SELECT vp.DW_ASSET_ID,f.value::string as CVE,MAX(DATEMODIFIED) as MAX_DATEMODIFIED,COUNT(vp.PLUGIN_ID) as PLUGIN_COUNT 
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f
    WHERE vp.MITIGATIONSTATUS IS NOT NULL and UPPER(vp.MITIGATIONSTATUS) = ''FIXED'' and vp.DELETIONREASON IS NULL
    GROUP BY vp.DW_ASSET_ID,f.value::string) t on t.DW_ASSET_ID = vm.DW_ASSET_ID and t.CVE = vm.CVE
WHERE upd.DW_VUL_ID = vm.DW_VUL_ID; -- 240120 and t.MAX_DATEMODIFIED >= upd.DATEMODIFIED;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Set VULMASTER.FIXED_PLUGIN_COUNT='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;

UPDATE CORE.VULMASTER upd
set OPEN_PLUGIN_COUNT = coalesce(t.PLUGIN_COUNT,0)
,MAX_PLUGIN_DATEMODIFIED = t.MAX_DATEMODIFIED
FROM CORE.VULMASTER vm
LEFT OUTER JOIN (SELECT vp.DW_ASSET_ID,f.value::string as CVE,MAX(DATEMODIFIED) as MAX_DATEMODIFIED,COUNT(vp.PLUGIN_ID) as PLUGIN_COUNT 
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f
    WHERE (vp.MITIGATIONSTATUS IS NULL or UPPER(vp.MITIGATIONSTATUS) NOT IN (''FIXED'',''REOPENED'')) -- 240419 CR 874 added REOPENED
        and vp.DELETIONREASON IS NULL
    GROUP BY vp.DW_ASSET_ID,f.value::string) t on t.DW_ASSET_ID = vm.DW_ASSET_ID and t.CVE = vm.CVE
WHERE upd.DW_VUL_ID = vm.DW_VUL_ID; -- 240120 and t.MAX_DATEMODIFIED >= upd.DATEMODIFIED;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Set VULMASTER.OPEN_PLUGIN_COUNT='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION; -- 240419 CR 874

UPDATE CORE.VULMASTER upd
set REOPENED_PLUGIN_COUNT = coalesce(t.PLUGIN_COUNT,0)
,MAX_PLUGIN_DATEMODIFIED = t.MAX_DATEMODIFIED
FROM CORE.VULMASTER vm
LEFT OUTER JOIN (SELECT vp.DW_ASSET_ID,f.value::string as CVE,MAX(DATEMODIFIED) as MAX_DATEMODIFIED,COUNT(vp.PLUGIN_ID) as PLUGIN_COUNT 
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f
    WHERE vp.MITIGATIONSTATUS IS NOT NULL and UPPER(vp.MITIGATIONSTATUS) = ''REOPENED'' and vp.DELETIONREASON IS NULL
    GROUP BY vp.DW_ASSET_ID,f.value::string) t on t.DW_ASSET_ID = vm.DW_ASSET_ID and t.CVE = vm.CVE
WHERE upd.DW_VUL_ID = vm.DW_VUL_ID;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Set VULMASTER.REOPENED_PLUGIN_COUNT='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;

UPDATE CORE.VULMASTER upd
set TOTAL_PLUGIN_COUNT = coalesce(t.PLUGIN_COUNT,0)
,MAX_PLUGIN_DATEMODIFIED = t.MAX_DATEMODIFIED
FROM CORE.VULMASTER vm
LEFT OUTER JOIN (SELECT vp.DW_ASSET_ID,f.value::string as CVE,MAX(DATEMODIFIED) as MAX_DATEMODIFIED,COUNT(vp.PLUGIN_ID) as PLUGIN_COUNT 
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f
    GROUP BY vp.DW_ASSET_ID,f.value::string) t on t.DW_ASSET_ID = vm.DW_ASSET_ID and t.CVE = vm.CVE
WHERE upd.DW_VUL_ID = vm.DW_VUL_ID; -- 240120 and t.MAX_DATEMODIFIED >= upd.DATEMODIFIED;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Set VULMASTER.TOTAL_PLUGIN_COUNT='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

--
--
-- Based on plugin counts obtained above, determine the individual CVE mitigation status
--
--

BEGIN TRANSACTION;
--
-- Old VULMASTER record before VULPLUGINS_MASTER was created therefore no related plugins
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = :No_Plugins_Msg || '', already fixed''
WHERE TOTAL_PLUGIN_COUNT = 0 and MITIGATIONSTATUS = ''fixed'';

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as No Plugins/Already fixed='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
--
-- Old VULMASTER record before VULPLUGINS_MASTER was created therefore no related plugins
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = :No_Plugins_Msg || '', already deleted''
WHERE TOTAL_PLUGIN_COUNT = 0 and DELETIONREASON IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as No Plugins/Already deleted='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION; -- 240120
--
-- Logically delete vulnerabilities that have not been marked as fixed in (DaysUntilVulConsideredDeleted) days
--
DaysUntilVulConsideredDeleted := (select PARMINT FROM CORE.CONFIG where PARMNAME = ''DaysUntilVulConsideredDeleted'');

If (DaysUntilVulConsideredDeleted IS NULL) THEN
	BEGIN
	Msg := ''WARNING: Config parameter (DaysUntilVulConsideredDeleted) not available'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
	END;
Else
    BEGIN
    --
    -- Age vulnerabilities that are not already fixed
    -- This is only for old VULMASTER records that have no associated VULPLUGINS_MASTER record (TOTAL_PLUGIN_COUNT = 0)
    --
    UPDATE CORE.VULMASTER
    set dateDeleted = CURRENT_TIMESTAMP()
    ,DeletionReason = ''No plugins and more than '' || :DaysUntilVulConsideredDeleted::varchar || '' days since lastFound''
    ,IS_PREV_DELETED = TRUE
    ,DATEMODIFIED = CURRENT_TIMESTAMP()
    WHERE TOTAL_PLUGIN_COUNT = 0 and DeletionReason IS NULL and MitigationStatus <> ''fixed''
    and DATEDIFF(d,lastfound,CURRENT_TIMESTAMP()) > :DaysUntilVulConsideredDeleted;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''VULMASTER(No plugins) records logically deleted(>'' || :DaysUntilVulConsideredDeleted::varchar || '' days)='' || RECORD_COUNT::varchar;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

COMMIT;

BEGIN TRANSACTION;
--
-- Old VULMASTER record before VULPLUGINS_MASTER was created therefore no related plugins
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = :No_Plugins_Msg || '', '' || coalesce(NULLIF(MITIGATIONSTATUS,''''),''Unknown'')
WHERE TOTAL_PLUGIN_COUNT = 0 and (EXTENDED_MITIGATIONSTATUS IS NULL or substring(EXTENDED_MITIGATIONSTATUS,1,10) <> :No_Plugins_Msg);

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as No Plugins/Various='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
--
-- Pure mitigation
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = ''fixed''
,DATEMITIGATED = CURRENT_TIMESTAMP()
,DATEMODIFIED = CURRENT_TIMESTAMP()
,DELETIONREASON = NULL
,MITIGATIONSTATUS = ''fixed''
WHERE TOTAL_PLUGIN_COUNT > 0 and OPEN_PLUGIN_COUNT = 0 and REOPENED_PLUGIN_COUNT = 0 -- 240419 CR 874 added REOPENED
    and DELETED_PLUGIN_COUNT = 0 and FIXED_PLUGIN_COUNT = TOTAL_PLUGIN_COUNT and MITIGATIONSTATUS <> ''fixed''; -- 240120

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as fixed(pure)='' || :RECORD_COUNT; -- 240419 CR 874
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION; -- 240122
--
-- Mitigated (fixed) but split between fixed and deleted
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = ''fixed but split, '' || DELETED_PLUGIN_COUNT || '' deleted and '' || FIXED_PLUGIN_COUNT || '' fixed''
,DATEMITIGATED = CURRENT_TIMESTAMP()
,DATEMODIFIED = CURRENT_TIMESTAMP()
,DELETIONREASON = NULL
,MITIGATIONSTATUS = ''fixed''
WHERE TOTAL_PLUGIN_COUNT > 0 and OPEN_PLUGIN_COUNT = 0 and REOPENED_PLUGIN_COUNT = 0 -- 240419 CR 874 added REOPENED
    and FIXED_PLUGIN_COUNT > 0 and (DELETED_PLUGIN_COUNT + FIXED_PLUGIN_COUNT) = TOTAL_PLUGIN_COUNT and MITIGATIONSTATUS <> ''fixed'';

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as fixed(split)='' || :RECORD_COUNT; -- 240419 CR 874
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;
--
-- All plugins deleted
--
UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = ''All related plugins deleted''
,DATEDELETED = CURRENT_TIMESTAMP()
,DATEMODIFIED = CURRENT_TIMESTAMP()
,DELETIONREASON = ''All related plugins deleted''
WHERE TOTAL_PLUGIN_COUNT > 0 and OPEN_PLUGIN_COUNT = 0 and REOPENED_PLUGIN_COUNT = 0 -- 240419 CR 874 added REOPENED
    and FIXED_PLUGIN_COUNT = 0 and DELETED_PLUGIN_COUNT = TOTAL_PLUGIN_COUNT; -- and DELETIONREASON IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as deleted='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION;

UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = ''Partially mitigated, '' || OPEN_PLUGIN_COUNT || '' open plugins out of '' || TOTAL_PLUGIN_COUNT
,DATEMITIGATED = NULL
,DATEMODIFIED = CURRENT_TIMESTAMP()
,DELETIONREASON = NULL
,MITIGATIONSTATUS = ''open''
WHERE TOTAL_PLUGIN_COUNT > 0 and OPEN_PLUGIN_COUNT > 0 and REOPENED_PLUGIN_COUNT = 0; -- 240419 CR 874 added REOPENED

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as partially mitigated(open)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

BEGIN TRANSACTION; -- 240419 CR 874 added REOPENED

UPDATE CORE.VULMASTER
set EXTENDED_MITIGATIONSTATUS = ''Partially mitigated, '' || REOPENED_PLUGIN_COUNT || '' reopened plugins, ''
    || OPEN_PLUGIN_COUNT || '' open plugins out of '' || TOTAL_PLUGIN_COUNT
,DATEMITIGATED = NULL
,DATEMODIFIED = CURRENT_TIMESTAMP()
,DELETIONREASON = NULL
,MITIGATIONSTATUS = ''reopened''
WHERE TOTAL_PLUGIN_COUNT > 0 and REOPENED_PLUGIN_COUNT > 0; -- It doesnt matter if OPEN_PLUGIN_COUNT is zero

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULMASTER records just marked as partially mitigated(reopened)='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_VULPLUGINS_MASTER"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Update VULPLUGINS_MASTER with a) fixed mitigation staus, delete rows not scanned by cutoff (days), delete rows where asset has been deleted'
EXECUTE AS OWNER
AS '
declare
Appl varchar := ''SP_CRM_UPDATE_VULPLUGINS_MASTER'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED'';
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED'';
MAG_VUL_MITIGATED varchar := ''MAG VUL MITIGATED''; -- 241023 CR1012
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;
RECORD_COUNT number;
DaysUntilVulConsideredDeleted number;

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- 241023 CR1012 added MAG_VUL_MITIGATED
IF (upper(:DATACATEGORY) NOT IN (:AWS_VUL_MITIGATED,:CCIC_VUL_MITIGATED,:MAG_VUL_MITIGATED)) THEN
	BEGIN
	Msg := ''DataCategory not vaild in this stored procedure'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

BEGIN TRANSACTION;
--
-- Logically delete vulnerabilities that have not been marked as fixed in (DaysUntilVulConsideredDeleted) days
--
DaysUntilVulConsideredDeleted := (select PARMINT FROM CORE.CONFIG where PARMNAME = ''DaysUntilVulConsideredDeleted'');

If (DaysUntilVulConsideredDeleted IS NULL) THEN
	BEGIN
	Msg := ''WARNING: Config parameter (DaysUntilVulConsideredDeleted) not available'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
	END;
Else
    BEGIN
    --
    -- Age vulnerabilities that are not already fixed
    --
    UPDATE CORE.VULPLUGINS_MASTER
    set dateDeleted = CURRENT_TIMESTAMP()
    ,DeletionReason = ''More than '' || :DaysUntilVulConsideredDeleted::varchar || '' days since lastFound''
    ,IS_PREV_DELETED = TRUE
    ,DATEMODIFIED = CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
    WHERE DeletionReason IS NULL and MitigationStatus <> ''fixed''
    and DATEDIFF(d,lastfound,CURRENT_TIMESTAMP()) > :DaysUntilVulConsideredDeleted;

    RECORD_COUNT := SQLROWCOUNT;
    Msg := ''VULPLUGINS_MASTER records logically deleted(>'' || :DaysUntilVulConsideredDeleted::varchar || '' days)='' || RECORD_COUNT::varchar;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    END;
End if;

COMMIT;


BEGIN TRANSACTION;

UPDATE CORE.VULPLUGINS_MASTER upd
set MITIGATIONSTATUS = ''fixed''
,DATEMITIGATED = CURRENT_TIMESTAMP()
,DATEMODIFIED = CURRENT_TIMESTAMP() -- DATEMODIFIED. Setting this is critical to SP_CRM_UPDATE_VULCVE_MASTER
FROM CORE.VULPLUGINS_MASTER vp
JOIN (select dw_asset_id,plugin_id,max(last_seen) as MAX_LASTSEEN
    FROM CORE.RAW_TENABLE_VUL
    WHERE snapshot_id = :P_SNAPSHOT_ID
    and severity_id > 0 -- Do not use Informational records (severity_id = 0)
    group by dw_asset_id,plugin_id) mit on mit.dw_asset_id = vp.dw_asset_id and mit.plugin_id = vp.plugin_id
WHERE upd.DW_PLUGIN_VUL_ID = vp.DW_PLUGIN_VUL_ID and mit.MAX_LASTSEEN >= vp.LASTFOUND
and coalesce(vp.MITIGATIONSTATUS,''itsnull'') <> ''fixed'' -- Dont mark as fixed if already fixed
and vp.DELETIONREASON IS NULL; -- Dont mark as fixed if already deleted

RECORD_COUNT := SQLROWCOUNT;
Msg := ''VULPLUGINS_MASTER records just marked as fixed='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_ASSETHIST"("P_REPORT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write active ASSET rows to ASSETHIST.'
EXECUTE AS OWNER
AS '

DECLARE 
Appl varchar := ''SP_CRM_WRITE_ASSETHIST'';
Msg varchar;
RowCount number;
ExceptionMsg varchar := ''Default'';
StartOfProgram timestamp := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number := 0;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

INSERT INTO CORE.ASSETHIST
(ASSET_DATECREATED -- 240624 CR913
,ASSET_ID_TATTOO
,AWS_ACCOUNTID -- 240624 CR913
,AWS_INSTANCESTATUS -- 230525
,AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,BIGFIX_ASSET_ID
,BIOS_GUID
,CLOUD_ID -- 230711
,COMPUTER_TYPE
,DATACENTER_ID
,DATEMODIFIED
,DEVICEMODEL -- 230703
,DEVICETYPE
,DW_ASSET_ID
,ENVIRONMENT
,IS_ENDPOINT -- 241212 CR1052
,IS_FORESCOUT_MANAGED -- 241007 CR984
,IS_FREEZE_SYSTEM_ID -- 241007 CR984
,IS_FROM_AWS_FEED -- 241007 CR984
,IS_PRIMARY_FISMA_ID_DERIVED -- 241007 CR984
,IS_SCANNABLE -- 231221
,IS_TATTOOABLE
,IS_TENABLE_CREDENTIALED_SCAN -- 241007 CR984
,LAST_CONFIRMED_TIME
,LASTASSETUPDATE
,LASTMODIFIEDBY_AWS -- 241007 CR984
,LASTMODIFIEDBY_AXONIUS -- 241007 CR984
,LASTMODIFIEDBY_BIGFIX -- 241007 CR984
,LASTMODIFIEDBY_CROWDSTRIKE -- 241007 CR984
,LASTMODIFIEDBY_FORESCOUT -- 241007 CR984
,LASTMODIFIEDBY_TENABLE -- 241007 CR984
,LASTSEEN_CSM
,LASTSEEN_HWAM
,LASTSEEN_SWAM
,LASTSEEN_VUL
,MOTHERBOARD
,OS
,OS_BUILD_NUMBER -- 241007 CR984
,OS_CPE
,OS_VERSION
,PREV_DATEDELETED -- 241007 CR984
,PREV_LAST_CONFIRMED_TIME -- 241007 CR984
,PREV_SYSTEM_ID -- 241007 CR984
,REPORT_ID
,SOURCE_TOOL_CREATE
,SOURCE_TOOL_CSM
,SOURCE_TOOL_HWAM
,SOURCE_TOOL_LASTSEEN
,SOURCE_TOOL_SWAM
,SOURCE_TOOL_VUL
,SYSTEM_ID
,TENABLEUUID
,TENANT_ID -- 240624 CR913
,VULNRISKTOLERANCE
)
SELECT 
a.INSERT_DATE as ASSET_DATECREATED -- 240624 CR913
,a.ASSET_ID_TATTOO
,a.AWS_ACCOUNTID -- 240624 CR913
,a.AWS_INSTANCESTATUS -- 230525
,a.AZURE_SUBSCRIPTION_ID -- 241125 CR1038
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID -- 230711
,a.COMPUTER_TYPE
,a.DATACENTER_ID
,a.DATEMODIFIED
,a.DEVICEMODEL -- 230703
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,a.IS_ENDPOINT -- 241212 CR1052
,a.IS_FORESCOUT_MANAGED -- 241007 CR984
,a.IS_FREEZE_SYSTEM_ID -- 241007 CR984
,a.IS_FROM_AWS_FEED -- 241007 CR984
,a.IS_PRIMARY_FISMA_ID_DERIVED -- 241007 CR984
,a.IS_SCANNABLE -- 231221
,a.IS_TATTOOABLE
,a.IS_TENABLE_CREDENTIALED_SCAN -- 241007 CR984
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTMODIFIEDBY_AWS -- 241007 CR984
,a.LASTMODIFIEDBY_AXONIUS -- 241007 CR984
,a.LASTMODIFIEDBY_BIGFIX -- 241007 CR984
,a.LASTMODIFIEDBY_CROWDSTRIKE -- 241007 CR984
,a.LASTMODIFIEDBY_FORESCOUT -- 241007 CR984
,a.LASTMODIFIEDBY_TENABLE -- 241007 CR984
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,a.MOTHERBOARD
,a.OS
,a.OS_BUILD_NUMBER -- 241007 CR984
,a.OS_CPE
,a.OS_VERSION
,a.PREV_DATEDELETED -- 241007 CR984
,a.PREV_LAST_CONFIRMED_TIME -- 241007 CR984
,a.PREV_SYSTEM_ID -- 241007 CR984
,:P_REPORT_ID
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,a.SYSTEM_ID
,a.TENABLEUUID
,a.TENANT_ID -- 240624 CR913
,a.VULNRISKTOLERANCE
FROM CORE.ASSET a
Where a.Is_Applicable = 1;

COMMIT;


BEGIN TRANSACTION;

INSERT INTO CORE.ASSETINTERFACECOALESCEDHIST
	(DW_ASSET_ID,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	REPORT_ID)
SELECT
	a.DW_ASSET_ID
	,aic.FQDN
	,aic.HOSTNAME
	,aic.IPV4
	,aic.IPV6
	,aic.MACADDRESS
	,aic.NETBIOSNAME
	,:P_REPORT_ID
FROM CORE.Asset a
join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID
Where a.Is_Applicable = 1;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
    
    END;
    
    ';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_ASSETINTERFACECOALESCED"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Coalesece AssetInterface records into single records per asset'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_WRITE_ASSETINTERFACECOALESCED'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE CORE.AssetInterfaceCoalesced;

INSERT INTO CORE.AssetInterfaceCoalesced
           (DW_ASSET_ID
           ,FQDN
           ,HOSTNAME
           ,NETBIOSNAME
           ,IPv4
           ,IPv6
           ,MACADDRESS,
		   INSERT_DATE)
SELECT A1.DW_ASSET_ID
      ,F.FQDN
      ,H.HOSTNAME
      ,N.NETBIOSNAME
      ,I4.IPV4
      ,I6.IPV6
      ,M.MACADDRESS
      ,CURRENT_TIMESTAMP() -- INSERT_DATE
FROM CORE.ASSET A1 
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT FQDN, '', '') WITHIN GROUP (ORDER BY FQDN DESC) as FQDN FROM CORE.ASSETINTERFACE_FQDN GROUP BY DW_ASSET_ID) F ON F.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT HOSTNAME, '', '') WITHIN GROUP (ORDER BY HOSTNAME DESC) as HOSTNAME FROM CORE.ASSETINTERFACE_HOSTNAME GROUP BY DW_ASSET_ID) H ON H.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT NETBIOSNAME, '', '') WITHIN GROUP (ORDER BY NETBIOSNAME DESC) as NETBIOSNAME FROM CORE.ASSETINTERFACE_NETBIOSNAME GROUP BY DW_ASSET_ID) N ON N.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT IPV4, '', '') WITHIN GROUP (ORDER BY IPV4 DESC) as IPV4 FROM CORE.ASSETINTERFACE_IPV4 GROUP BY DW_ASSET_ID) I4 ON I4.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT IPV6, '', '') WITHIN GROUP (ORDER BY IPV6 DESC) as IPV6 FROM CORE.ASSETINTERFACE_IPV6 GROUP BY DW_ASSET_ID) I6 ON I6.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN (select DW_ASSET_ID, listagg(DISTINCT MACADDRESS, '', '') WITHIN GROUP (ORDER BY MACADDRESS DESC) as MACADDRESS FROM CORE.ASSETINTERFACE_MACADDRESS GROUP BY DW_ASSET_ID) M ON M.DW_ASSET_ID = A1.DW_ASSET_ID
WHERE A1.IS_APPLICABLE = 1
;

/**************************
THIS CODE WORKED PRIOR TO 7/7/23. IT USED TO RUN IN ABOUT 1 MINUTE. AS OF 7/7/23 IT RUNS FOR MORE THAN 18 MINUTES BEFORE IT NEEDS TO BE CANCELED
Bill Lennon noted that on July 5th 6th - Snowflake released GROUP BY: New ALL Keyword
The GROUP BY clause now supports the ALL keyword, which specifies that all expressions in the SELECT list that do not use aggregate functions should be used for grouping.

IT IS UNKNOWN IF THIS RELEASE CAUSED THE CODE TO STOP FUNCTIONING. 

SELECT A1.DW_ASSET_ID
      ,listagg(DISTINCT F.fqdn, '', '')        WITHIN GROUP (ORDER BY F.fqdn DESC) as FQDN
      ,listagg(DISTINCT H.hostname, '', '')    WITHIN GROUP (ORDER BY H.hostname DESC) as HOSTNAME
      ,listagg(DISTINCT N.netbiosname, '', '') WITHIN GROUP (ORDER BY N.netbiosname DESC) as NETBIOSNAME
      ,listagg(DISTINCT I4.ipv4, '', '')       WITHIN GROUP (ORDER BY I4.ipv4 DESC) AS IPV4
      ,listagg(DISTINCT I6.ipv6, '', '')       WITHIN GROUP (ORDER BY I6.ipv6 DESC) AS IPV6
      ,listagg(DISTINCT M.MACADDRESS, '', '')  WITHIN GROUP (ORDER BY M.MACADDRESS DESC) AS MACADDRESS
      ,CURRENT_TIMESTAMP() -- INSERT_DATE
FROM CORE.ASSET A1 
LEFT OUTER JOIN CORE.ASSETINTERFACE_FQDN F        ON F.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN CORE.ASSETINTERFACE_HOSTNAME H    ON H.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN CORE.ASSETINTERFACE_NETBIOSNAME N ON N.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN CORE.ASSETINTERFACE_IPV4 I4       ON I4.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN CORE.ASSETINTERFACE_IPV6 I6       ON I6.DW_ASSET_ID = A1.DW_ASSET_ID
LEFT OUTER JOIN CORE.ASSETINTERFACE_MACADDRESS M  ON M.DW_ASSET_ID = A1.DW_ASSET_ID
WHERE A1.IS_APPLICABLE = 1
GROUP BY A1.DW_ASSET_ID
;
********************/

-- 230918 RECORD_COUNT := SQLROWCOUNT;
-- 230918 Msg := ''AssetInterfaceCoalesced rows written='' || cast(RECORD_COUNT as varchar);
-- 230918 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_MSGLOG"("P_APPL" VARCHAR(16777216), "P_MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_WRITE_MSGLOG'';
ExceptionMsg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

BEGIN TRANSACTION;
insert into CORE.MSGLOG (APPL,MSG) VALUES(:P_APPL,:P_MSG);
COMMIT;

--
-- 241030
-- There should never be a null msg so if one is found something is fundamentally wrong.
--
If (NULLIF(:P_MSG,'''') IS NULL) THEN
    BEGIN
    ExceptionMsg := ''ERROR: FOUND NULL MSG''; 
    raise CRM_logic_exception;
    END;
END IF;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_REPORTINGTABLES"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Populate a temp tables to improve performance for Tableau pull'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_WRITE_REPORTINGTABLES'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE CORE.Temp_Single_AssetInterface;

INSERT INTO CORE.Temp_Single_AssetInterface
           (DW_ASSET_ID
           ,fqdn
           ,hostname
           ,ipv4
           ,ipv6
           ,MACADDRESS
           ,netbiosname)
select 
a.DW_ASSET_ID
,iFqdn.fqdn
,iHostname.hostname
,iIpv4.ipv4
,iIpv6.ipv6
,iMac.MACADDRESS
,iNetbiosname.netbiosname
FROM Asset a
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_FQDN  
		WHERE fqdn IS NOT NULL group by DW_ASSET_ID) iMaxFqdn on iMaxFqdn.DW_ASSET_ID = a.DW_ASSET_ID
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_HOSTNAME  
		WHERE hostname IS NOT NULL group by DW_ASSET_ID) iMaxHostname on iMaxHostname.DW_ASSET_ID = a.DW_ASSET_ID
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_IPV4  
		WHERE ipv4 IS NOT NULL group by DW_ASSET_ID) iMaxIpv4 on iMaxIpv4.DW_ASSET_ID = a.DW_ASSET_ID
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_IPV6  
		WHERE ipv6 IS NOT NULL group by DW_ASSET_ID) iMaxIpv6 on iMaxIpv6.DW_ASSET_ID = a.DW_ASSET_ID
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_MACADDRESS  
		WHERE MACADDRESS IS NOT NULL group by DW_ASSET_ID) iMaxMac on iMaxMac.DW_ASSET_ID = a.DW_ASSET_ID
left join (select DW_ASSET_ID, Max(ID) AssetInterfaceID FROM CORE.ASSETINTERFACE_NETBIOSNAME  
		WHERE netbiosname IS NOT NULL group by DW_ASSET_ID) iMaxNetbiosname on iMaxNetbiosname.DW_ASSET_ID = a.DW_ASSET_ID

left join (select ID AssetInterfaceID, fqdn FROM CORE.ASSETINTERFACE_FQDN ) iFqdn on iFqdn.AssetInterfaceID = iMaxFqdn.AssetInterfaceID
left join (select ID AssetInterfaceID, hostname FROM CORE.ASSETINTERFACE_HOSTNAME ) iHostname on iHostname.AssetInterfaceID = iMaxHostname.AssetInterfaceID
left join (select ID AssetInterfaceID, ipv4 FROM CORE.ASSETINTERFACE_IPV4 ) iIpv4 on iIpv4.AssetInterfaceID = iMaxIpv4.AssetInterfaceID
left join (select ID AssetInterfaceID, ipv6 FROM CORE.ASSETINTERFACE_IPV6 ) iIpv6 on iIpv6.AssetInterfaceID = iMaxIpv6.AssetInterfaceID
left join (select ID AssetInterfaceID, MACADDRESS FROM CORE.ASSETINTERFACE_MACADDRESS ) iMac on iMac.AssetInterfaceID = iMaxMac.AssetInterfaceID
left join (select ID AssetInterfaceID, netbiosname FROM CORE.ASSETINTERFACE_NETBIOSNAME ) iNetbiosname on iNetbiosname.AssetInterfaceID = iMaxNetbiosname.AssetInterfaceID

WHERE a.Is_Applicable = 1;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Temp_Single_AssetInterface rows written='' || RECORD_COUNT::varchar;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

TRUNCATE TABLE rpt.AssetDetail;

INSERT INTO rpt.AssetDetail
           (filter
           ,SYSTEM_ID
           ,DATACENTER_ID
           ,ID
           ,DW_VUL_ID
           ,cve
           ,daysSinceDiscovery
           ,exploitavailable
           ,firstseen
           ,fismaseverity
           ,lastfound
           ,mitigationstatus
           ,Snapshot_ID
           ,BODDueDate
           ,dateCreated
           ,datemitigated
           ,DeletionReason
           ,Acronym
           ,Acr_Alias
           ,Component_Acronym
           ,is_bod
           ,rankk
           ,refresh_date
           ,solution
           ,familyname
           ,HVAStatus
           ,MEFStatus
           ,Is_MarketPlace
           ,signature
           ,pluginid
           ,data_center_name
           ,DW_ASSET_ID
           ,computer_type
           ,os
           ,bios_guid
           ,source_tool
           ,environment
           ,asset_id_tattoo
           ,os_version
           ,TenableUUID
           ,DeviceType
           ,fqdn
           ,hostname
           ,ipv4
           ,ipv6
           ,MAC -- MACADDRESS
           ,netbiosname
           ,VulnRiskTolerance
           ,cvss2basescore
           ,OATO_Category
           ,Sensor_firstseen
           ,Sensor_lastfound
           ,cvss3basescore
           --,dw_asset_id
           --,datacenter_id_derived
           ,AWS_accountIds
           ,TLC_Phase
           ,CLOUD_ACCOUNT_ID -- 241125 CR1038
           )
select 1 as filter
,a.SYSTEM_ID,a.DATACENTER_ID,vm.DW_VUL_ID as ID,vm.DW_VUL_ID
,vm.cve,vm.daysSinceDiscovery,vm.exploitavailable,vm.firstseen,vm.fismaseverity
,vm.lastfound,vm.mitigationstatus
,1 as Snapshot_ID
,vm.BODDueDate
,vm.INSERT_DATE -- dateCreated
,vm.datemitigated
,null as DeletionReason
,s.Acronym
,substring(s.Acronym, 1, 1) || ''***'' as Acr_Alias
,s.COMPONENT_ACRONYM
,vm.IS_KEV as is_bod
,1 as rankk
,CURRENT_TIMESTAMP() as refresh_date
,p.solution
,p.FAMILY_NAME as familyname
,s.HVAStatus
,s.MEFStatus
,s.Is_MarketPlace
,p.synopsis as signature
,p.PLUGIN_ID
,a.DATACENTER_ACRONYM as data_center_name
,vm.DW_ASSET_ID,a.computer_type,a.os,a.bios_guid,a.SOURCE_TOOL_CREATE -- source_tool
,a.environment,a.asset_id_tattoo,a.os_version,a.TenableUUID,a.DeviceType
,aic.fqdn 
,aic.hostname 
,aic.ipv4 
,aic.ipv6 
,aic.MACADDRESS 
,aic.netbiosname 
,a.VulnRiskTolerance
,vm.CVSSV2BASESCORE
,s.OATO_Category
,vm.firstseen as Sensor_firstseen -- a separate field called Sensor_firstseen no longer exists. It was only a diagnostic field in legacy
,vm.lastfound as Sensor_lastfound -- a separate field called Sensor_lastfound no longer exists. It was only a diagnostic field in legacy
,vm.CVSSV3BASESCORE
--,a.dw_asset_id 
--,a.DATACENTER_ID as DATACENTER_ID_DERIVED -- dc.CFACTS_UID as datacenter_id_derived
,s.AWS_ACCOUNTIDS as AWS_accountId
,s.TLC_Phase
,a.CLOUD_ACCOUNT_ID -- 241125 CR1038
from CORE.VW_Assets a  
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.VW_VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VULPLUGIN group by DW_VUL_ID) plugs on plugs.DW_VUL_ID = vm.dw_vul_id
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
left outer join CORE.Temp_Single_AssetInterface aic on aic.DW_ASSET_ID = a.dw_asset_id;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''rpt.AssetDetail rows written='' || RECORD_COUNT::varchar;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

TRUNCATE TABLE RPT.Temp_Vuln_FV_Rolling60Days;

INSERT INTO RPT.Temp_Vuln_FV_Rolling60Days
select * FROM CORE.VW_VULN_ROLLING60DAYS;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''rpt.Temp_Vuln_FV_Rolling60Days rows written='' || RECORD_COUNT::varchar;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

TRUNCATE TABLE RPT.Temp_Vuln_Trending;

INSERT INTO RPT.Temp_Vuln_Trending
select * FROM CORE.VW_VULN_DASHBOARD_TRENDING;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''rpt.Temp_Vuln_Trending rows written='' || RECORD_COUNT::varchar;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_SUMMARY_TABLES"("P_REPORT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write summarized Datacenter and System data'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_WRITE_SUMMARY_TABLES'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
RECORD_COUNT number;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-- UPDATE SYSTEMSUMMARY
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------

--
-- Write all systems to SYSTEMSUMMARY table.
-- This will ultimately show that nothing was reported for a given system
-- and reporting of assets that are retired, etc.
--
INSERT INTO CORE.SYSTEMSUMMARY
    (ASSETRISKTOLERANCE
	,ASSETS
	,HWAMRAWAWS
	,HWAMRAWBIGFIX
	,HWAMRAWFORESCOUT
	,KEV_FIXED_MONTHTODATE
	,KEV_FIXED_TODAY
	,KEV_OPEN
	,KEV_REOPENED
	,PREVASSETS
	,REPORT_ID
	,RESIDUALRISK
	,RESILIENCYSCORE
	,SYSTEM_ID
	,VUL_CRITICAL_FIXED_TODAY -- 231222
	,VUL_CRITICAL_OPEN -- 231222
	,VUL_CRITICAL_REOPENED -- 231222
	,VUL_DELETED_TODAY -- 231222
	,VUL_HIGH_FIXED_TODAY -- 231222
	,VUL_HIGH_OPEN -- 231222
	,VUL_HIGH_REOPENED -- 231222
	,VUL_INACTIVE_ASSET_TODAY -- 231222
	,VUL_LOW_FIXED_TODAY -- 231222
	,VUL_LOW_OPEN -- 231222
	,VUL_LOW_REOPENED -- 231222
	,VUL_MEDIUM_FIXED_TODAY -- 231222
	,VUL_MEDIUM_OPEN -- 231222
	,VUL_MEDIUM_REOPENED -- 231222;
	,VULCRITICAL
	,VULCRITICAL_GT15_LTE60DAYS
	,VULCRITICAL_GT30_LTE60DAYS
	,VULCRITICAL_GT60DAYS
	,VULCRITICAL_GTE15DAYS
	,VULCRITICAL_LTE15DAYS
	,VULCRITICAL_LTE30DAYS
	,VULCRITICALREMEDIATED
	,VULDELETED
	,VULHIGH
	,VULHIGH_GT30_LTE60DAYS
	,VULHIGH_GT60DAYS
	,VULHIGH_LTE30DAYS
	,VULHIGHREMEDIATED
	,VULLOW
	,VULMEDIUM
	,VULNRISKTOLERANCE
	,VULRAW
	,VULRAW_CRITICAL
	,VULRAW_HIGH
	,VULRAW_LOW
	,VULRAW_MEDIUM
	,VULUNIQUECRITICAL_GT15_LTE60DAYS
	,VULUNIQUECRITICAL_GT30_LTE60DAYS
	,VULUNIQUECRITICAL_GT60DAYS
	,VULUNIQUECRITICAL_GTE15DAYS
	,VULUNIQUEHIGH_GT30_LTE60DAYS
	,VULUNIQUEHIGH_GT60DAYS
	,VULUNIQUELOW
	,VULUNIQUEMEDIUM
)
select 
   NULL as ASSETRISKTOLERANCE -- Deliberately set to NULL so when PrevAssets = 0 we dont get divide by zero (below)
	,0 as ASSETS
	,0 as HWAMRAWAWS
	,0 as HWAMRAWBIGFIX
	,0 as HWAMRAWFORESCOUT
	,0 as KEV_FIXED_MONTHTODATE
	,0 as KEV_FIXED_TODAY
	,0 as KEV_OPEN
	,0 as KEV_REOPENED
	,0 as PREVASSETS
    ,:P_Report_ID
	,0 as RESIDUALRISK
	,0 as RESILIENCYSCORE
    ,SYSTEM_ID
	,0 as VUL_CRITICAL_FIXED_TODAY -- 231222
	,0 as VUL_CRITICAL_OPEN -- 231222
	,0 as VUL_CRITICAL_REOPENED -- 231222
	,0 as VUL_DELETED_TODAY -- 231222
	,0 as VUL_HIGH_FIXED_TODAY -- 231222
	,0 as VUL_HIGH_OPEN -- 231222
	,0 as VUL_HIGH_REOPENED -- 231222
	,0 as VUL_INACTIVE_ASSET_TODAY -- 231222
	,0 as VUL_LOW_FIXED_TODAY -- 231222
	,0 as VUL_LOW_OPEN -- 231222
	,0 as VUL_LOW_REOPENED -- 231222
	,0 as VUL_MEDIUM_FIXED_TODAY -- 231222
	,0 as VUL_MEDIUM_OPEN -- 231222
	,0 as VUL_MEDIUM_REOPENED -- 231222;
	,0 as VULCRITICAL
	,0 as VULCRITICAL_GT15_LTE60DAYS
	,0 as VULCRITICAL_GT30_LTE60DAYS
	,0 as VULCRITICAL_GT60DAYS
	,0 as VULCRITICAL_GTE15DAYS
	,0 as VULCRITICAL_LTE15DAYS
	,0 as VULCRITICAL_LTE30DAYS
	,0 as VULCRITICALREMEDIATED
	,0 as VULDELETED
	,0 as VULHIGH
	,0 as VULHIGH_GT30_LTE60DAYS
	,0 as VULHIGH_GT60DAYS
	,0 as VULHIGH_LTE30DAYS
	,0 as VULHIGHREMEDIATED
	,0 as VULLOW
	,0 as VULMEDIUM
	,0 as VULNRISKTOLERANCE
	,0 as VULRAW
	,0 as VULRAW_CRITICAL
	,0 as VULRAW_HIGH
	,0 as VULRAW_LOW
	,0 as VULRAW_MEDIUM
	,0 as VULUNIQUECRITICAL_GT15_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT30_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT60DAYS
	,0 as VULUNIQUECRITICAL_GTE15DAYS
	,0 as VULUNIQUEHIGH_GT30_LTE60DAYS
	,0 as VULUNIQUEHIGH_GT60DAYS
	,0 as VULUNIQUELOW
	,0 as VULUNIQUEMEDIUM
FROM CORE.VW_SYSTEMS;

-- 230918 RECORD_COUNT := SQLROWCOUNT;
-- 230918 Msg :=  ''SYSTEMSUMMARY created='' || cast(RECORD_COUNT as varchar);
-- 230918 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

--
-- Updates to SYSTEMSUMMARY below will only be for valid systems
--

UPDATE CORE.SYSTEMSUMMARY ss
set Assets = t.Total
FROM (select SYSTEM_ID,COUNT(1) Total 
    FROM CORE.VW_ASSETS
    GROUP BY SYSTEM_ID) t 
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulDeleted = t.Total
FROM (SELECT a.SYSTEM_ID,count(1) Total
    FROM CORE.VULMASTER vm
    JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    WHERE vm.DELETIONREASON IS NULL and vm.datedeleted::date = CURRENT_DATE
    GROUP BY a.SYSTEM_ID) t 
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;


DROP TABLE IF EXISTS TEMP_SYSTEM_VUL_TOTALS;

CREATE TEMPORARY TABLE TEMP_SYSTEM_VUL_TOTALS (CVE VARCHAR, DaysSinceDiscovery NUMBER, FISMASEVERITY VARCHAR , MITIGATIONSTATUS VARCHAR, SYSTEM_ID VARCHAR);

--
-- Only vulnerabilities that are:
-- a) Not logically deleted 
-- b) Assets related to vulnerability are active (not logically deleted)
-- c) Vulnerbility is not fixed (open/reopen)
--
INSERT INTO TEMP_SYSTEM_VUL_TOTALS (CVE, DaysSinceDiscovery, FISMASEVERITY, MITIGATIONSTATUS, SYSTEM_ID)
select CVE, DaysSinceDiscovery, FISMASeverity, MitigationStatus,SYSTEM_ID
	FROM CORE.VW_VULMASTER WHERE MitigationStatus <> ''fixed'';

----------------------------
-- Critical Vulnerabilities
----------------------------

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical_lte15days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 15 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueCritical_gt15_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical_gt15_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical_lte30days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 30 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueCritical_gt30_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical_gt30_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueCritical_gt60days = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulCritical_gt60days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished SYSTEMSUMMARY(Critical)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- High Vulnerabilities
----------------------------

UPDATE CORE.SYSTEMSUMMARY ss
set VulHigh = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulHigh_lte30days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery <= 30 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueHigh_gt30_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulHigh_gt30_lte60days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueHigh_gt60days = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulHigh_gt60days = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished SYSTEMSUMMARY(High)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Medium Vulnerabilities
----------------------------

UPDATE CORE.SYSTEMSUMMARY ss
set VulMedium = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueMedium = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished SYSTEMSUMMARY(Medium)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Low Vulnerabilities
----------------------------

UPDATE CORE.SYSTEMSUMMARY ss
set VulLow = t.Total
FROM (select SYSTEM_ID,count(1) Total FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VulUniqueLow = t.Total
FROM (select SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,SYSTEM_ID FROM TEMP_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY CVE,SYSTEM_ID)
	GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished SYSTEMSUMMARY(Low)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

UPDATE CORE.SYSTEMSUMMARY ss
set PrevAssets = t.PrevAssets
FROM (select SYSTEM_ID,ASSETS as PrevAssets
    FROM (SELECT MAX(REPORT_ID) as MAX_REPORT_ID FROM CORE.REPORT_IDS where Is_endOfMonth=1) r
    JOIN CORE.SYSTEMSUMMARY s on s.REPORT_ID = r.MAX_REPORT_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY
set AssetRiskTolerance = cast(((PrevAssets - Assets)*100.00/PrevAssets) as decimal(15,2))
WHERE REPORT_ID = :P_Report_ID and PrevAssets > 0; -- Result is AssetRiskTolerance is NULL by default

UPDATE CORE.SYSTEMSUMMARY
set AssetRiskTolerance = 0
WHERE REPORT_ID = :P_Report_ID AND AssetRiskTolerance is null;

UPDATE CORE.SYSTEMSUMMARY ss
set ResidualRisk = s.TotalPOAMwithApprovedRBD
FROM CORE.Systems s
WHERE s.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set ResiliencyScore = t.Total
FROM (SELECT p.SYSTEM_ID
	,SUM(WEAKNESS_RISK_LEVEL_WEIGHT) Total
	FROM CORE.VW_POAMHIST p 
	WHERE p.Overall_Status in (''Delayed'', ''Ongoing'', ''Draft'')
	and p.REPORT_ID = :P_Report_ID
	GROUP BY p.SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set SUM_ASSET_VULNRISKTOLERANCE = t.SUM_ASSET_VULNRISKTOLERANCE
,VULNRISKTOLERANCE = t.SUM_ASSET_VULNRISKTOLERANCE -- VULNRISKTOLERANCE is further calculated if SCANNABLEASSETS > 0
,SCANNABLEASSETS = t.SCANNABLEASSETS
FROM (SELECT SYSTEM_ID,SUM(VULNRISKTOLERANCE) as SUM_ASSET_VULNRISKTOLERANCE, count(1) SCANNABLEASSETS
    FROM CORE.VW_ASSETS
    WHERE Is_Scannable=1 
    group by SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VULNRISKTOLERANCE = ss.SUM_ASSET_VULNRISKTOLERANCE / ss.SCANNABLEASSETS
WHERE ss.REPORT_ID = :P_Report_ID and ss.SCANNABLEASSETS > 0;


--
-- KEV Totals
--

DROP TABLE IF EXISTS TEMP_KEV_TOTALS;

CREATE TEMPORARY TABLE TEMP_KEV_TOTALS (SYSTEM_ID VARCHAR, MITIGATIONSTATUS VARCHAR, TOTAL NUMBER);

INSERT INTO TEMP_KEV_TOTALS (SYSTEM_ID, MITIGATIONSTATUS, TOTAL)
SELECT vm.SYSTEM_ID,vm.MITIGATIONSTATUS,count(1) TOTAL
FROM (select SYSTEM_ID,CVE,MITIGATIONSTATUS
    FROM CORE.VW_VULMASTER
    where ((MitigationStatus=''fixed'' and cast(datemitigated as date) = cast((SELECT max(REPORT_DATE) from CORE.REPORT_IDS) as date))
    or MitigationStatus=''open'' or MitigationStatus=''reopened'')) vm 
JOIN CORE.KEV_CATALOG bodcat on bodcat.CVE = vm.cve
group by vm.SYSTEM_ID,vm.MITIGATIONSTATUS;

UPDATE CORE.SYSTEMSUMMARY ss
set KEV_Open = t.Total
from TEMP_KEV_TOTALS t
where t.SYSTEM_ID = ss.SYSTEM_ID and t.MitigationStatus=''open'' and ss.REPORT_ID= :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set KEV_Reopened = t.Total
from TEMP_KEV_TOTALS t
where t.SYSTEM_ID = ss.SYSTEM_ID and t.MitigationStatus=''reopened'' and ss.REPORT_ID= :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set KEV_Fixed_Today = t.Total
from TEMP_KEV_TOTALS t
where t.SYSTEM_ID = ss.SYSTEM_ID and t.MitigationStatus=''fixed'' and ss.REPORT_ID= :P_Report_ID;


DROP table TEMP_KEV_TOTALS;


UPDATE CORE.SYSTEMSUMMARY ss
set KEV_Fixed_MonthToDate = t.Total
from (select vm.SYSTEM_ID,count(1) Total
    FROM CORE.VW_VULMASTER vm
    JOIN CORE.KEV_CATALOG bodcat on bodcat.CVE = vm.cve
    WHERE vm.MitigationStatus=''fixed''
    and cast(datemitigated as date) between cast((select MAX(REPORT_DATE) from REPORT_IDS WHERE Is_EndOfMonth = 1) as date) and cast((select MAX(REPORT_DATE) from CORE.REPORT_IDS) as date)
    group by vm.SYSTEM_ID) t
where t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID= :P_Report_ID;


UPDATE CORE.SYSTEMSUMMARY ss
set VUL_CRITICAL_FIXED_TODAY = t.Total -- 231222 
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and UPPER(FISMASEVERITY) = ''CRITICAL'' and DATEMITIGATED::DATE = CURRENT_DATE() GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_CRITICAL_OPEN = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'' AND UPPER(FISMASEVERITY) = ''CRITICAL'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_CRITICAL_REOPENED = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'' AND UPPER(FISMASEVERITY) = ''CRITICAL'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_HIGH_FIXED_TODAY = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and UPPER(FISMASEVERITY) = ''HIGH'' and DATEMITIGATED::DATE = CURRENT_DATE() GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_HIGH_OPEN = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'' AND UPPER(FISMASEVERITY) = ''HIGH'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_HIGH_REOPENED = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'' AND UPPER(FISMASEVERITY) = ''HIGH'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_MEDIUM_FIXED_TODAY = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and UPPER(FISMASEVERITY) = ''MEDIUM'' and DATEMITIGATED::DATE = CURRENT_DATE() GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_MEDIUM_OPEN = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'' AND UPPER(FISMASEVERITY) = ''MEDIUM'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_MEDIUM_REOPENED = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'' AND UPPER(FISMASEVERITY) = ''MEDIUM'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_LOW_FIXED_TODAY = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''FIXED'' and UPPER(FISMASEVERITY) = ''LOW'' and DATEMITIGATED::DATE = CURRENT_DATE() GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_LOW_OPEN = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''OPEN'' AND UPPER(FISMASEVERITY) = ''LOW'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_LOW_REOPENED = t.Total -- 231222
FROM (select SYSTEM_ID,count(1) Total FROM CORE.VW_VULMASTER WHERE UPPER(MITIGATIONSTATUS) = ''REOPENED'' AND UPPER(FISMASEVERITY) = ''LOW'' GROUP BY SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

-- UPDATE CORE.SYSTEMSUMMARY ss
-- set VUL_DELETED_TODAY = t.Total -- 231222
-- FROM (select SYSTEM_ID,count(1) Total FROM CORE.VULMASTER WHERE DATEDELETED::DATE = CURRENT_DATE() GROUP BY SYSTEM_ID) t
-- WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

-- UPDATE CORE.SYSTEMSUMMARY ss
-- SET VUL_INACTIVE_ASSET_TODAY = t.Total -- 231222
-- from (select vm.SYSTEM_ID,count(1) Total
--     from CORE.ASSET a
--     join CORE.VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
--     where a.datedeleted::date = current_date() and a.is_applicable = 0 and vm.deletionreason IS NULL   
--     group by vm.SYSTEM_ID) t
-- where t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID= :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
set VUL_DELETED_TODAY = t.Total -- 231225
FROM (select a.SYSTEM_ID,count(1) Total
    from CORE.ASSET a
    join CORE.VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
    where vm.DATEDELETED::DATE = CURRENT_DATE()   
    group by a.SYSTEM_ID) t
WHERE t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.SYSTEMSUMMARY ss
SET VUL_INACTIVE_ASSET_TODAY = t.Total -- 231225
from (select a.SYSTEM_ID,count(1) Total
    from CORE.ASSET a
    join CORE.VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
    where a.datedeleted::date = current_date() and a.is_applicable = 0 and vm.deletionreason IS NULL   
    group by a.SYSTEM_ID) t
where t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID= :P_Report_ID;
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-- UPDATE DATACENTERSUMMARY
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------

--
-- Write all systems to DATACENTERSUMMARY table.
-- Although not all Systems records represent datacenters, the data submitted
-- might incorrectly put a System CFACTS_UUID in the datacenter_ID field.
-- We still want to report these assets that are mistakenly assigned.
--
INSERT INTO CORE.DATACENTERSUMMARY
    (ASSETS
	,DATACENTER_ID
	,HWAMRAWAWS
	,HWAMRAWBIGFIX
	,HWAMRAWFORESCOUT
	,OPERATIONALSYSTEMS
	,REPORT_ID
	,SYSTEMS
	,VULCRITICAL
	,VULCRITICAL_GT15_LTE60DAYS
	,VULCRITICAL_GT30_LTE60DAYS
	,VULCRITICAL_GT60DAYS
	,VULCRITICAL_GTE15DAYS
	,VULCRITICAL_LTE15DAYS
	,VULCRITICAL_LTE30DAYS
	,VULDELETED
	,VULHIGH
	,VULHIGH_GT30_LTE60DAYS
	,VULHIGH_GT60DAYS
	,VULHIGH_LTE30DAYS
	,VULLOW
	,VULMEDIUM
	,VULRAW
	,VULRAW_CRITICAL
	,VULRAW_HIGH
	,VULRAW_LOW
	,VULRAW_MEDIUM
	,VULUNIQUECRITICAL_GT15_LTE60DAYS
	,VULUNIQUECRITICAL_GT30_LTE60DAYS
	,VULUNIQUECRITICAL_GT60DAYS
	,VULUNIQUECRITICAL_GTE15DAYS
	,VULUNIQUEHIGH_GT30_LTE60DAYS
	,VULUNIQUEHIGH_GT60DAYS
	,VULUNIQUELOW
	,VULUNIQUEMEDIUM
)
SELECT
    0 as ASSETS
	,SYSTEM_ID as DATACENTER_ID
	,0 as HWAMRAWAWS
	,0 as HWAMRAWBIGFIX
	,0 as HWAMRAWFORESCOUT
	,0 as OPERATIONALSYSTEMS
	,:P_Report_ID
	,0 as SYSTEMS
	,0 as VULCRITICAL
	,0 as VULCRITICAL_GT15_LTE60DAYS
	,0 as VULCRITICAL_GT30_LTE60DAYS
	,0 as VULCRITICAL_GT60DAYS
	,0 as VULCRITICAL_GTE15DAYS
	,0 as VULCRITICAL_LTE15DAYS
	,0 as VULCRITICAL_LTE30DAYS
	,0 as VULDELETED
	,0 as VULHIGH
	,0 as VULHIGH_GT30_LTE60DAYS
	,0 as VULHIGH_GT60DAYS
	,0 as VULHIGH_LTE30DAYS
	,0 as VULLOW
	,0 as VULMEDIUM
	,0 as VULRAW
	,0 as VULRAW_CRITICAL
	,0 as VULRAW_HIGH
	,0 as VULRAW_LOW
	,0 as VULRAW_MEDIUM
	,0 as VULUNIQUECRITICAL_GT15_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT30_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT60DAYS
	,0 as VULUNIQUECRITICAL_GTE15DAYS
	,0 as VULUNIQUEHIGH_GT30_LTE60DAYS
	,0 as VULUNIQUEHIGH_GT60DAYS
	,0 as VULUNIQUELOW
	,0 as VULUNIQUEMEDIUM
FROM CORE.VW_SYSTEMS;

-- 230918 RECORD_COUNT := SQLROWCOUNT;
-- 230918 Msg :=  ''DATACENTERSUMMARY created='' || cast(RECORD_COUNT as varchar);
-- 230918 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 


UPDATE CORE.DATACENTERSUMMARY ss
set Assets = t.Total
FROM (select DATACENTER_ID,COUNT(1) Total 
    FROM CORE.VW_ASSETS
    GROUP BY DATACENTER_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set Systems = t.Total
FROM (select DATACENTER_ID,COUNT(1) Total 
    FROM (SELECT DISTINCT DATACENTER_ID, SYSTEM_ID FROM CORE.VW_ASSETS)    
    GROUP BY DATACENTER_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set OperationalSystems = t.Total
FROM (select DATACENTER_ID,COUNT(1) Total 
    FROM (SELECT DISTINCT a.DATACENTER_ID, a.SYSTEM_ID 
        FROM CORE.VW_ASSETS a
        JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID and s.TLC_Phase = ''Operate''
    )  
    GROUP BY DATACENTER_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulDeleted = t.Total
FROM (SELECT a.DATACENTER_ID,count(1) Total
    FROM CORE.VULMASTER vm
    JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    WHERE vm.DELETIONREASON IS NULL and vm.datedeleted::date = CURRENT_DATE
    GROUP BY a.DATACENTER_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

    
DROP TABLE IF EXISTS TEMP_DATACENTER_VUL_TOTALS;

CREATE TEMPORARY TABLE TEMP_DATACENTER_VUL_TOTALS (CVE VARCHAR, DaysSinceDiscovery NUMBER, FISMASEVERITY VARCHAR , MITIGATIONSTATUS VARCHAR, DATACENTER_ID VARCHAR);

--
-- Only vulnerabilities that are:
-- a) Not logically deleted 
-- b) Assets related to vulnerability are active (not logically deleted)
-- c) Vulnerbility is not fixed (open/reopen)
--
INSERT INTO TEMP_DATACENTER_VUL_TOTALS (CVE, DaysSinceDiscovery, FISMASEVERITY, MITIGATIONSTATUS, DATACENTER_ID)
select CVE, DaysSinceDiscovery, FISMASeverity, MitigationStatus, DATACENTER_ID -- 230608 1427 was SYSTEM_ID
	FROM CORE.VW_VULMASTER WHERE MitigationStatus <> ''fixed'';


----------------------------
-- Critical Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical_lte15days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 15 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueCritical_gt15_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical_gt15_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical_lte30days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 30 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueCritical_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueCritical_gt60days = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulCritical_gt60days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSUMMARY(Critical)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- High Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSUMMARY ss
set VulHigh = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulHigh_lte30days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery <= 30 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueHigh_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulHigh_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueHigh_gt60days = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulHigh_gt60days = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSUMMARY(High)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Medium Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSUMMARY ss
set VulMedium = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueMedium = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSUMMARY(Medium)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Low Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSUMMARY ss
set VulLow = t.Total
FROM (select DATACENTER_ID,count(1) Total FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSUMMARY ss
set VulUniqueLow = t.Total
FROM (select DATACENTER_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID FROM TEMP_DATACENTER_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY CVE,DATACENTER_ID)
	GROUP BY DATACENTER_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSUMMARY(Low)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 


-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-- UPDATE DATACENTERSYSTEMSUMMARY (Systems split between >1 datacenter)
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------------------

-- Insert DATACENTERSYSTEMSUMMARY based on HWAM found
INSERT INTO CORE.DATACENTERSYSTEMSUMMARY
    (ASSETS
	,DATACENTER_ID
	,HWAMRAWAWS
	,HWAMRAWBIGFIX
	,HWAMRAWFORESCOUT
	,REPORT_ID
	,SYSTEM_ID
	,VULCRITICAL
	,VULCRITICAL_GT15_LTE60DAYS
	,VULCRITICAL_GT30_LTE60DAYS
	,VULCRITICAL_GT60DAYS
	,VULCRITICAL_GTE15DAYS
	,VULCRITICAL_LTE15DAYS
	,VULCRITICAL_LTE30DAYS
	,VULDELETED
	,VULHIGH
	,VULHIGH_GT30_LTE60DAYS
	,VULHIGH_GT60DAYS
	,VULHIGH_LTE30DAYS
	,VULLOW
	,VULMEDIUM
	,VULRAW
	,VULRAW_CRITICAL
	,VULRAW_HIGH
	,VULRAW_LOW
	,VULRAW_MEDIUM
	,VULUNIQUECRITICAL_GT15_LTE60DAYS
	,VULUNIQUECRITICAL_GT30_LTE60DAYS
	,VULUNIQUECRITICAL_GT60DAYS
	,VULUNIQUECRITICAL_GTE15DAYS
	,VULUNIQUEHIGH_GT30_LTE60DAYS
	,VULUNIQUEHIGH_GT60DAYS
	,VULUNIQUELOW
	,VULUNIQUEMEDIUM
)
SELECT 
    0 as ASSETS
	,t.DATACENTER_ID
	,0 as HWAMRAWAWS
	,0 as HWAMRAWBIGFIX
	,0 as HWAMRAWFORESCOUT
	,:P_Report_ID
	,t.SYSTEM_ID
	,0 as VULCRITICAL
	,0 as VULCRITICAL_GT15_LTE60DAYS
	,0 as VULCRITICAL_GT30_LTE60DAYS
	,0 as VULCRITICAL_GT60DAYS
	,0 as VULCRITICAL_GTE15DAYS
	,0 as VULCRITICAL_LTE15DAYS
	,0 as VULCRITICAL_LTE30DAYS
	,0 as VULDELETED
	,0 as VULHIGH
	,0 as VULHIGH_GT30_LTE60DAYS
	,0 as VULHIGH_GT60DAYS
	,0 as VULHIGH_LTE30DAYS
	,0 as VULLOW
	,0 as VULMEDIUM
	,0 as VULRAW
	,0 as VULRAW_CRITICAL
	,0 as VULRAW_HIGH
	,0 as VULRAW_LOW
	,0 as VULRAW_MEDIUM
	,0 as VULUNIQUECRITICAL_GT15_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT30_LTE60DAYS
	,0 as VULUNIQUECRITICAL_GT60DAYS
	,0 as VULUNIQUECRITICAL_GTE15DAYS
	,0 as VULUNIQUEHIGH_GT30_LTE60DAYS
	,0 as VULUNIQUEHIGH_GT60DAYS
	,0 as VULUNIQUELOW
	,0 as VULUNIQUEMEDIUM
FROM (select a.DATACENTER_ID,a.SYSTEM_ID
	FROM CORE.VW_ASSETS a
	JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
	GROUP BY a.DATACENTER_ID, a.SYSTEM_ID) t;

-- 230918 RECORD_COUNT := SQLROWCOUNT;
-- 230918 Msg :=  ''DATACENTERSYSTEMSUMMARY created='' || cast(RECORD_COUNT as varchar);
-- 230918 CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set Assets = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,COUNT(1) Total 
    FROM CORE.VW_ASSETS
    GROUP BY DATACENTER_ID,SYSTEM_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulDeleted = t.Total
FROM (SELECT a.DATACENTER_ID,a.SYSTEM_ID,count(1) Total
    FROM CORE.VULMASTER vm
    JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    WHERE vm.DELETIONREASON IS NULL and vm.datedeleted::date = CURRENT_DATE
    GROUP BY a.DATACENTER_ID,a.SYSTEM_ID) t 
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

    
DROP TABLE IF EXISTS TEMP_DATACENTER_SYSTEM_VUL_TOTALS;

CREATE TEMPORARY TABLE TEMP_DATACENTER_SYSTEM_VUL_TOTALS (CVE VARCHAR, DATACENTER_ID VARCHAR, DaysSinceDiscovery NUMBER, FISMASEVERITY VARCHAR , MITIGATIONSTATUS VARCHAR, SYSTEM_ID VARCHAR);

--
-- Only vulnerabilities that are:
-- a) Not logically deleted 
-- b) Assets related to vulnerability are active (not logically deleted)
-- c) Vulnerbility is not fixed (open/reopen)
--
INSERT INTO TEMP_DATACENTER_SYSTEM_VUL_TOTALS (CVE, DATACENTER_ID, DaysSinceDiscovery, FISMASEVERITY, MITIGATIONSTATUS, SYSTEM_ID)
select CVE, DATACENTER_ID, DaysSinceDiscovery, FISMASeverity, MitigationStatus,SYSTEM_ID
	FROM CORE.VW_VULMASTER WHERE MitigationStatus <> ''fixed'';



----------------------------
-- Critical Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical_lte15days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 15 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueCritical_gt15_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical_gt15_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 15 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical_lte30days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery <= 30 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueCritical_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueCritical_gt60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulCritical_gt60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Critical'' and DaysSinceDiscovery > 60 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSYSTEMSUMMARY(Critical)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- High Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulHigh = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulHigh_lte30days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery <= 30 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueHigh_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulHigh_gt30_lte60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 30 and DaysSinceDiscovery <= 60 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueHigh_gt60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulHigh_gt60days = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''High'' and DaysSinceDiscovery > 60 GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSYSTEMSUMMARY(High)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Medium Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulMedium = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueMedium = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Medium'' GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSYSTEMSUMMARY(Medium)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

----------------------------
-- Low Vulnerabilities
----------------------------

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulLow = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

UPDATE CORE.DATACENTERSYSTEMSUMMARY ss
set VulUniqueLow = t.Total
FROM (select DATACENTER_ID,SYSTEM_ID,count(1) Total 
    FROM (SELECT CVE,DATACENTER_ID,SYSTEM_ID FROM TEMP_DATACENTER_SYSTEM_VUL_TOTALS WHERE FISMAseverity = ''Low'' GROUP BY CVE,DATACENTER_ID,SYSTEM_ID)
	GROUP BY DATACENTER_ID,SYSTEM_ID) t
WHERE t.DATACENTER_ID = ss.DATACENTER_ID and t.SYSTEM_ID = ss.SYSTEM_ID and ss.REPORT_ID = :P_Report_ID;

--Msg :=  ''Finished DATACENTERSYSTEMSUMMARY(Low)'';
--CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_WRITE_VULHIST"("P_REPORT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write VULMASTER records to VULHIST. Asset and vul must be active.'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_WRITE_VULHIST'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
RECORD_COUNT number := 0;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

----------------------------------------------------------------------
--            VULHIST
----------------------------------------------------------------------

BEGIN TRANSACTION;

INSERT INTO CORE.VULHIST
    (CVE -- 240625 CR916
	,CVSSV2BASESCORE
	,CVSSV3BASESCORE
    ,DATEMITIGATED -- 240625 CR916
    ,DW_ASSET_ID -- 240625 CR916
	,DW_VUL_ID
	,EXPLOITAVAILABLE
    ,EXTENDED_MITIGATIONSTATUS -- 240625 CR916
    ,FIRSTSEEN -- 240625 CR916
    ,IS_LEGACY -- 240625 CR916
	,FISMASEVERITY
	,LASTFOUND
	,MITIGATIONSTATUS
    ,NUMERIC_SEVERITY -- 240625 CR916
    ,REPOSITORY_ID -- 240625 CR916
    ,VUL_DATECREATED -- 240625 CR916
	,REPORT_ID
	)
select 
vm.CVE -- 240625 CR916
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,vm.DATEMITIGATED -- 240625 CR916
,vm.DW_ASSET_ID -- 240625 CR916
,vm.DW_VUL_ID
,vm.exploitAvailable
,vm.EXTENDED_MITIGATIONSTATUS -- 240625 CR916
,vm.FIRSTSEEN -- 240625 CR916
,vm.IS_LEGACY -- 240625 CR916
,vm.FISMAseverity
,vm.lastfound
,vm.MitigationStatus
,vm.NUMERIC_SEVERITY -- 240625 CR916
,vm.REPOSITORY_ID -- 240625 CR916
,vm.INSERT_DATE as VUL_DATECREATED -- 240625 CR916
,:P_REPORT_ID
FROM CORE.VW_VULMASTER vm
WHERE (vm.datemitigated IS NULL or datediff(day,vm.datemitigated,current_date()) <= 365) -- 231018 1656 when mitigated for more than a year dont write to history
;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_THROW_ERROR"("MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION)
SECRETS = ('crm_sdw_url'=SLACK_CRM_SDW_WEBHOOK_URL)
EXECUTE AS CALLER
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import date

def main(session, msg): 
    # Retrieve the Webhook URL from the SECRET object
    webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    
    slack_data = {
     "text": f"Snowflake alert: {msg}"
    }

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"
';
CREATE OR REPLACE PROCEDURE "SP_THROW_ERROR"("MSG" VARCHAR(16777216), "ENV" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION)
SECRETS = ('dev_url'=SLACK_DEV_WEBHOOK_URL,'perf_url'=SLACK_PERF_WEBHOOK_URL,'prod_url'=SLACK_PROD_WEBHOOK_URL,'crm_sdw_url'=SLACK_CRM_SDW_WEBHOOK_URL,'gov_url'=SLACK_GOV_WEBHOOK_URL)
EXECUTE AS CALLER
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import date

def main(session, msg, env): 
    # Retrieve the Webhook URL from the SECRET object
    if env == ''PROD'':
        webhook_url = _snowflake.get_generic_secret_string(''prod_url'')
    elif env == ''PERF'':
        webhook_url = _snowflake.get_generic_secret_string(''perf_url'')
    elif env == ''GOV'':
        webhook_url = _snowflake.get_generic_secret_string(''gov_url'')
    elif env == ''CRM_SDW'':
        webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    else:
        webhook_url = _snowflake.get_generic_secret_string(''dev_url'')
    
    slack_data = {
     "text": f"Snowflake says: {msg}"
    }

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"
';
CREATE OR REPLACE PROCEDURE "SP_UPDATE_HWAM_MONTHLY_DATA"()
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
COMMENT='Save IUSG-AWS HWAM data of last day of every month from APP_CDM'
EXECUTE AS OWNER
AS '
    var Sql_insert = `Insert into CORE.OATO_HWAM_MONTHLY_DATA
                      select  INSTANCEID,
                              INSTANCESTATUS,
                              ACCOUNT_NUMBER,
                              PRIMARY_FISMA_ID_DERIVED,
                              DATACENTER_ID_DERIVED,
                              SYSTEM_ACRONYM,
                              LAST_CONFIRMED_TIME,
                              current_date() 
                      from APP_CDM.SHARED.SEC_VW_HWAM_AWS;  -- 231031 rename of DB (was CDM) RBAC 20230809 change to SHARED
                      `;
      
    snowflake.execute (
            {sqlText: Sql_insert}
            );
    return ''OATO_HWAM_MONTHLY_DATA updated successful'';
   ';
CREATE OR REPLACE PROCEDURE "SP_UPDATE_PRIMARY_OP_LOC2"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Insert new Primary_Operating_Location(s) into PrimaryOpLoc table'
EXECUTE AS OWNER
AS '
BEGIN
LET DefaultID := CORE.FN_CRM_GETUID_DEFAULT();
return DefaultID;
END
';
create or replace task TSK_CRM_AWS_HWAM
	warehouse=CYBER_RISK_MANAGEMENT_03_WH
	schedule='using cron 15 4 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull AWS HWAM and process into CRM database'
	as CALL CORE.SP_CRM_AWS_HWAM();
create or replace task TSK_CRM_AXONIUS
	warehouse=CYBER_RISK_MANAGEMENT_09_WH
	schedule='using cron 30 11 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull AXONIUS (HIGLAS) and process into CRM database'
	as CALL CORE.SP_CRM_AXONIUS();
create or replace task TSK_CRM_CCIC_TENABLE_VUL
	warehouse=CYBER_RISK_MANAGEMENT_05_WH
	schedule='using cron 15 5 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull CCIC_TENABLE_VUL and process into CRM database'
	as CALL CORE.SP_CRM_CCIC_TENABLE_VUL();
create or replace task TSK_CRM_CONCLUDE
	warehouse=CYBER_RISK_MANAGEMENT_07_WH
	schedule='using cron 20 6 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Complete remaining stored procedures to make CRM data ready for reporting'
	as CALL CORE.SP_CRM_CONCLUDE();
create or replace task TSK_CRM_CROWDSTRIKE
	warehouse=CYBER_RISK_MANAGEMENT_08_WH
	schedule='using cron 30 2 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull CROWDSTRIKE and process into CRM database'
	as CALL CORE.SP_CRM_CROWDSTRIKE();
create or replace task TSK_CRM_FORESCOUT_HWAM
	warehouse=CYBER_RISK_MANAGEMENT_04_WH
	schedule='using cron 15 4 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull FORESCOUT HWAM and process into CRM database'
	as CALL CORE.SP_CRM_FORESCOUT_HWAM();
create or replace task TSK_CRM_INITIATE
	warehouse=CYBER_RISK_MANAGEMENT_01_WH
	schedule='using cron 15 2 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Initialize CRM database by generating a REPORT_ID (snapshot identifier) and pull fundamental data like CFACTS'
	as CALL CORE.SP_CRM_INITIATE();
create or replace task TSK_CRM_IUSG_TENABLE_VUL
	warehouse=CYBER_RISK_MANAGEMENT_06_WH
	schedule='using cron 45 5 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull IUSG TENABLE VUL and process into CRM database'
	as CALL CORE.SP_CRM_IUSG_TENABLE_VUL();
create or replace task TSK_CRM_KEV_CATALOG
	warehouse=CYBER_RISK_MANAGEMENT_02_WH
	schedule='using cron 15 3 * * * America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Pull KEV (BOD) CATALOG and process into CRM database'
	as CALL CORE.SP_CRM_KEV_CATALOG();
create or replace task TSK_CRM_MAINTENANCE
	warehouse=CYBER_RISK_MANAGEMENT_12_WH
	schedule='using cron 30 23 * * 6 America/New_York'
	STATEMENT_TIMEOUT_IN_SECONDS=3600
	COMMENT='Perform routine maintenance and cleanup of the CRM database'
	as CALL CORE.SP_CRM_MAINTENANCE();
create or replace task TSK_UPDATE_HWAM_MONTHLY_DATA
	schedule='using cron 0 4 L * * America/New_York'
	as call CORE.SP_UPDATE_HWAM_MONTHLY_DATA();
create or replace schema DBA COMMENT='Schema for database utilities and health checks. All objects subject to change as needed. DO NOT EMBED THESE OBJECTS IN OTHER VIEWS.';

create or replace TABLE LEGACYOBJECTS (
	OBJECTTYPE VARCHAR(16777216),
	SCHEMA_NAME VARCHAR(16777216),
	OBJECTNAME VARCHAR(16777216),
	CREATE_DATE VARCHAR(16777216),
	MODIFY_DATE VARCHAR(16777216),
	ROWCOUNT VARCHAR(16777216),
	MIGRATIONSTATUS VARCHAR(16777216),
	REPLACEDWITHSDLOBJECT VARCHAR(16777216)
);
create or replace TABLE SYSPRI (
	ACRONYM VARCHAR(16777216),
	COLORCODE VARCHAR(16777216),
	LEGENDVALUE VARCHAR(16777216),
	PRIORITY NUMBER(38,0),
	STATUS VARCHAR(16777216),
	LEGENDCOMMENT VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TERESA_WORKSHEET VARCHAR(16777216),
	TERESA_COMMENT1 VARCHAR(16777216)
);
create or replace TABLE SYSTEM_COMMENTS (
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TERESA_WORKSHEET_240212 VARCHAR(16777216),
	TERESA_COMMENT_240212 VARCHAR(16777216),
	ELLIOT_COMMENT_240212 VARCHAR(16777216),
	COLORCODE VARCHAR(16777216),
	LEGENDVALUE VARCHAR(16777216),
	PRIORITY NUMBER(38,0),
	STATUS VARCHAR(16777216),
	LEGENDCOMMENT VARCHAR(16777216),
	TERESA_WORKSHEET_240426 VARCHAR(16777216),
	TERESA_COMMENT_240426 VARCHAR(16777216)
);
create or replace TABLE SYSTEM_COMMONNAME (
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	COMMONNAME VARCHAR(16777216)
);
create or replace view VW_ALERTLOG(
	ID,
	APPL,
	ERRTYPE,
	INSERT_DATE,
	SQLERRM,
	SQLCODE,
	SQLSTATE,
	CUSTOM_ERRMSG
) COMMENT='Visibility of fatal process errors (Historical)\t'
 as
SELECT ID,APPL,ERRTYPE,INSERT_DATE,SQLERRM,SQLCODE,SQLSTATE,CUSTOM_ERRMSG
 FROM CORE.ALERTLOG ORDER BY ID DESC;
create or replace view VW_ASSETINTERFACE_SUMMARY(
	INTERFACEFIELD,
	MIN_LAST_CONFIRMED_TIME,
	MAX_LAST_CONFIRMED_TIME,
	TOTAL
) COMMENT='Diagnostic View to summarize the contents of all ASSETINTERFACE_XXX tables\t'
 as
select 'FQDN' As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_FQDN	Union all
select 'HOSTNAME'As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_HOSTNAME	Union all
select 'IPV4'As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_IPV4	Union all
select 'IPV6'As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_IPV6	Union all
select 'MACADDRESS'As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_MACADDRESS	Union all
select 'NETBIOSNAME'As InterfaceField,min(LAST_CONFIRMED_TIME) as Min_LAST_CONFIRMED_TIME, max(LAST_CONFIRMED_TIME) as Max_LAST_CONFIRMED_TIME, count(1) as Total FROM CORE.ASSETINTERFACE_NETBIOSNAME	 
;
create or replace view VW_CHECK_CAMP(
	DATE,
	DATA_CENTER,
	DATA_CENTER_CHECK,
	DATACENTER_ACRONYM,
	FISMA,
	FISMA_CHECK,
	SYSTEM_ACRONYM,
	SYSTEM_ACRONYM_CHECK,
	ACCOUNT_NUMBER,
	CFACTS_PRIMARY_OPERATING_LOCATION,
	DERIVED_PRIMARY_OPERATING_LOCATION_ACRONYM,
	DC_POL_CHECK
) COMMENT='Check CAMP (SEC_VW_FISMA_LOOKUPS) for valid data\t'
 as
SELECT ref.DATE,ref.DATA_CENTER
,case coalesce(dc.system_id,'ITSNULL')
    when 'ITSNULL' then 'DATA_CENTER is not valid'
    else 'DATA_CENTER Valid'
end as DATA_CENTER_CHECK
,dc.acronym as DATACENTER_ACRONYM
,ref.FISMA
,case coalesce(s.system_id,'ITSNULL')
    when 'ITSNULL' then 'FISMA is not valid'
    else 'FISMA Valid'
end as FISMA_CHECK
,ref.SYSTEM_ACRONYM
,case coalesce(acro.system_id,'ITSNULL')
    when 'ITSNULL' then 'SYSTEM_ACRONYM is not valid'
    else 'SYSTEM_ACRONYM Valid'
end as SYSTEM_ACRONYM_CHECK
,ref.ACCOUNT_NUMBER
,s.PRIMARY_OPERATING_LOCATION as CFACTS_PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as DERIVED_PRIMARY_OPERATING_LOCATION_ACRONYM
,case
    when dc.system_id = s.primary_operating_location_id then 'DATA_CENTER and PRIMARY_OPERATING_LOCATION match'
    else 'DATA_CENTER and PRIMARY_OPERATING_LOCATION do not match'
end as DC_POL_CHECK
FROM REF_LOOKUPS.SHARED.SEC_VW_FISMA_LOOKUPS ref
left outer join core.systems dc on upper(dc.system_id) = upper(ref.DATA_CENTER)
left outer join core.systems s on upper(s.system_id) = upper(ref.fisma)
left outer join core.systems acro on upper(acro.acronym) = upper(ref.system_acronym)
left outer join core.systems pol on upper(pol.system_id) = upper(s.primary_operating_location_id) 
--left outer join core.systems dcpol on upper(dcpol.system_id) = upper(s.primary_operating_location_id)
;
create or replace view VW_CHECK_CREDENTIALED_SCAN(
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	LASTSEEN_VUL,
	IS_TENABLE_CREDENTIALED_SCAN,
	PRESENCE_OF_PLUGIN,
	IS_WORD_CREDENTIALED_PRESENT_IN_PLUGINTEXT,
	RAW_CREDENTIALED_CHECK_VALUE,
	RAW_CREDENTIALED_SCAN_VALUE,
	OS,
	PLUGINTEXT
) COMMENT='Check integrity of Asset.is_tenable_credentialed_scan'
 as
select a.dw_asset_id,a.DATACENTER_ACRONYM,a.SYSTEM_ACRONYM,a.lastseen_vul::date as LASTSEEN_VUL
,a.is_tenable_credentialed_scan
,case coalesce(plug.dw_asset_id,0)
    when 0 THEN 'Plugin19506Notfound'
    else 'See_Raw_Credentialed_Scan_Value'
end as Presence_of_plugin
,plug.IS_WORD_CREDENTIALED_PRESENT_IN_PLUGINTEXT
,plug.Raw_Credentialed_Check_Value
,plug.Raw_Credentialed_Scan_Value
,a.os,plug.plugintext
FROM CORE.VW_ASSETS a
LEFT OUTER JOIN (select r.dw_asset_id,snap.snapshot_date::date as snapshot_date,r.ip
,CASE position('CREDENTIAL',upper(r.plugintext)) 
    when 0 then 'No'
    Else 'Yes'
END IS_WORD_CREDENTIALED_PRESENT_IN_PLUGINTEXT
,position('Credentialed checks',r.plugintext) as Startof_Credentialed_Check
,split_part(split_part(substring(r.plugintext,Startof_Credentialed_Check,50),char(10),1),':',2) as Raw_Credentialed_Check_Value
,position('Credentialed_Scan',r.plugintext) as Startof_Credentialed_Scan
,REPLACE(split_part(split_part(substring(r.plugintext,Startof_Credentialed_Scan,50),char(10),1),':',2),'LastAuthenticatedResults','') as Raw_Credentialed_Scan_Value
--,Raw_Credentialed_Scan_Value::boolean as Raw_IS_Credentialed_Scan
,r.plugintext
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
where r.plugin_id = '19506' and snap.snapshot_date::date >= (current_date() - 15)::date ) plug on plug.dw_asset_id = a.dw_asset_id and plug.snapshot_date = a.lastseen_vul::date
;
create or replace view VW_CHECK_VULPLUGINS_MASTER(
	DATACATEGORY,
	DW_ASSET_ID,
	PLUGIN_ID,
	VPM_CVE,
	VPM_LASTFOUND,
	VPM_DELETIONREASON,
	VPM_MITITGATIONSTATUS,
	VM_MITITGATIONSTATUS,
	TOTAL_PLUGIN_COUNT,
	OPEN_PLUGIN_COUNT,
	DELETED_PLUGIN_COUNT,
	FIXED_PLUGIN_COUNT,
	DELETIONREASON,
	EXTENDED_MITIGATIONSTATUS,
	PRIORTOCHANGE_MITITGATIONSTATUS
) COMMENT='Check VULPLUGINS_MASTER\t'
 as
SELECT DISTINCT raw.datacategory,vpm.dw_asset_id,vpm.plugin_id,vpm.VPM_CVE,vpm.LASTFOUND as VPM_LASTFOUND,vpm.deletionreason as VPM_DELETIONREASON,vpm.mitigationstatus as VPM_MITITGATIONSTATUS,vm.mitigationstatus as VM_MITITGATIONSTATUS
,vm.total_plugin_count,vm.open_plugin_count,vm.deleted_plugin_count,vm.fixed_plugin_count,vm.deletionreason,vm.extended_mitigationstatus,b.mitigationstatus as PriorToChange_MITITGATIONSTATUS
from (SELECT f.value::string as VPM_CVE,vp.* exclude CVE
    FROM CORE.VULPLUGINS_MASTER vp
    join table(flatten(cve,outer=>true)) as f) vpm --on vpm.DW_ASSET_ID = vm.DW_ASSET_ID and t.VP_CVE = vm.CVE

left outer join (SELECT snap.datacategory,r.dw_asset_id,f.value::string as RAW_CVE,r.plugin_id
    FROM CORE.RAW_TENABLE_VUL r
    join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
    join table(flatten(cve,outer=>true)) as f
    where upper(snap.datacategory) like '%MIT%') raw on raw.DW_ASSET_ID = vpm.DW_ASSET_ID and raw.RAW_CVE = vpm.VPM_CVE and raw.plugin_id = vpm.plugin_id

left outer join CORE.VULMASTER vm on vm.dw_asset_id = vpm.DW_ASSET_ID and vm.cve = vpm.VPM_CVE

left outer join SANDBOX.BACKUP_VULMASTER_240119_2342 b on b.dw_asset_id = vpm.DW_ASSET_ID and b.cve = vpm.VPM_CVE
;
create or replace view VW_DUPLICATE_ASSETS(
	QUERY_USED,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_FORESCOUT_MANAGED,
	IS_FROM_AWS_FEED,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_BUILD_NUMBER,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	VULNRISKTOLERANCE
) COMMENT='Diagnostic View to report duplicate assets'
 as

 SELECT 'DATACENTER_ID/ASSET_ID_TATTOO' as QUERY_USED,* FROM CORE.VW_ASSETS WHERE DW_ASSET_ID IN (SELECT DISTINCT r2.DW_ASSET_ID
    FROM (select rank()over(partition by r1.DATACENTER_ID,r1.ASSET_ID_TATTOO order by r1.insert_date asc) TheRank,r1.DW_ASSET_ID,r1.INSERT_DATE
        FROM CORE.ASSET r1
        JOIN (select DATACENTER_ID,ASSET_ID_TATTOO 
        FROM CORE.ASSET WHERE ASSET_ID_TATTOO is not null
        GROUP BY DATACENTER_ID,ASSET_ID_TATTOO
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.ASSET_ID_TATTOO = r1.ASSET_ID_TATTOO) r2)

UNION ALL

SELECT 'DATACENTER_ID/NORMALIZED_FQDN' as QUERY_USED,* FROM CORE.VW_ASSETS WHERE DW_ASSET_ID IN (SELECT DISTINCT r2.DW_ASSET_ID
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_FQDN order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID,r1.ASSET_ID_TATTOO
        FROM CORE.ASSET r1
        JOIN CORE.ASSETINTERFACE_FQDN f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_FQDN 
            FROM CORE.ASSET a
            JOIN CORE.ASSETINTERFACE_FQDN f0 on f0.dw_asset_id = a.dw_asset_id
        WHERE a.DATACENTER_ID NOT IN ('56FFF52E-175B-4E48-9B38-669C8BC74899','5d8a99a8db672340f99cfd721f96190d','DB0B74DC-610A-4D35-B645-B16059B5D64A')
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_FQDN
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_FQDN = f1.NORMALIZED_FQDN) r2)

UNION ALL

SELECT 'DATACENTER_ID/NORMALIZED_HOSTNAME' as QUERY_USED,* FROM CORE.VW_ASSETS WHERE DW_ASSET_ID IN (SELECT DISTINCT r2.DW_ASSET_ID
    FROM (select rank()over(partition by r1.DATACENTER_ID,f1.NORMALIZED_HOSTNAME order by r1.LAST_CONFIRMED_TIME desc, r1.DW_ASSET_ID desc) TheRank,r1.DW_ASSET_ID,r1.ASSET_ID_TATTOO
        FROM CORE.ASSET r1
        JOIN CORE.ASSETINTERFACE_HOSTNAME f1 on f1.dw_asset_id = r1.dw_asset_id
        JOIN (select a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME 
            FROM CORE.ASSET a
            JOIN CORE.ASSETINTERFACE_HOSTNAME f0 on f0.dw_asset_id = a.dw_asset_id
            where a.DATACENTER_ID NOT IN ('56FFF52E-175B-4E48-9B38-669C8BC74899','5d8a99a8db672340f99cfd721f96190d','DB0B74DC-610A-4D35-B645-B16059B5D64A')
        GROUP BY a.DATACENTER_ID,f0.NORMALIZED_HOSTNAME
        HAVING count(1) > 1) d on d.DATACENTER_ID = r1.DATACENTER_ID and d.NORMALIZED_HOSTNAME = f1.NORMALIZED_HOSTNAME) r2)
;
create or replace view VW_ENDPOINTS_REPORTING_SWAM(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	TOTAL_WINDOWS_ENDPOINTS,
	TOTAL_WINDOWS_ENDPOINTS_WITH_SWAM,
	ASSETS_NOT_REPORTING_SWAM,
	TOTAL_ENDPOINTS_CREDENTIALED
) COMMENT='Visibility of Endpoints Reporting SWAM\t'
 as
with
WindowsEndpoints as (select dw_asset_id from core.vw_assets where upper(os) like '%WINDOWS%' and is_endpoint = 1)
,AssetSwam as (select distinct wep.dw_asset_id
    from WindowsEndpoints wep
    join core.ASSET_SOFTWARE soft on soft.dw_asset_id = wep.dw_asset_id
)
,DCSYS as (select a.datacenter_acronym,a.system_acronym,count(1) TOTAL_WINDOWS_ENDPOINTS
    from WindowsEndpoints wep
    join core.vw_assets a on a.dw_asset_id = wep.dw_asset_id
    group by a.datacenter_acronym,a.system_acronym
)
,DCSYS_ASSETS_WT_SWAM as (select a.datacenter_acronym,a.system_acronym,count(1) TOTAL_WINDOWS_ENDPOINTS_WITH_SWAM
    from AssetSwam aswam
    join core.vw_assets a on a.dw_asset_id = aswam.dw_asset_id
    group by a.datacenter_acronym,a.system_acronym    
)
,DCSYS_ASSETS_CREDENTIALED as (select a.datacenter_acronym,a.system_acronym,count(1) TOTAL_ENDPOINTS_CREDENTIALED
    from WindowsEndpoints wep
    join core.vw_assets a on a.dw_asset_id = wep.dw_asset_id
    where a.IS_TENABLE_CREDENTIALED_SCAN = 1
    group by a.datacenter_acronym,a.system_acronym
)
select ds.DATACENTER_ACRONYM,ds.SYSTEM_ACRONYM,ds.TOTAL_WINDOWS_ENDPOINTS,coalesce(dcswam.TOTAL_WINDOWS_ENDPOINTS_WITH_SWAM,0) as TOTAL_WINDOWS_ENDPOINTS_WITH_SWAM
,(ds.TOTAL_WINDOWS_ENDPOINTS - coalesce(dcswam.TOTAL_WINDOWS_ENDPOINTS_WITH_SWAM,0)) as ASSETS_NOT_REPORTING_SWAM
,coalesce(cred.TOTAL_ENDPOINTS_CREDENTIALED,0) as TOTAL_ENDPOINTS_CREDENTIALED
FROM DCSYS ds
LEFT OUTER JOIN DCSYS_ASSETS_CREDENTIALED cred on cred.datacenter_acronym = ds.datacenter_acronym and cred.system_acronym = ds.system_acronym
LEFT OUTER JOIN DCSYS_ASSETS_WT_SWAM dcswam on dcswam.datacenter_acronym = ds.datacenter_acronym and dcswam.system_acronym = ds.system_acronym
order by ds.datacenter_acronym,ds.system_acronym;
create or replace view VW_ENTERPRISE_SCANS(
	REPORT_ID,
	REPORT_DATE,
	YYMM,
	TOTAL_ASSETS,
	SCANABLE_ASSETS,
	ASSETS_SCANNED_TODAY,
	ASSETS_SCANNED_WITNIN_3_DAYS,
	ASSETS_SCANNED
) COMMENT='Reports enterprise scans totals\t'
 as
select t.REPORT_ID,t.REPORT_DATE,t.YYMM
    ,coalesce(a.TOTAL_ASSETS,0) as TOTAL_ASSETS
    ,coalesce(scanable.SCANABLE_ASSETS,0) as SCANABLE_ASSETS
    ,coalesce(scantoday.ASSETS_SCANNED_TODAY,0) as ASSETS_SCANNED_TODAY
    ,coalesce(scanwithin3.ASSETS_SCANNED_WITNIN_3_DAYS,0) as ASSETS_SCANNED_WITNIN_3_DAYS
    ,coalesce(scan.ASSETS_SCANNED,0) as ASSETS_SCANNED
FROM (SELECT r1.REPORT_ID,r1.REPORT_DATE,to_char(r1.REPORT_DATE,'YYMM') as YYMM
        FROM (select rank()over(partition by REPORT_ID order by REPORT_DATE::date) TheRank,REPORT_ID,REPORT_DATE::date as REPORT_DATE
            FROM CORE.REPORT_IDS where is_viable = 1 and REPORT_DATE::date >= '2024-02-01'::date) r1 where r1.TheRank = 1) t

left outer join (select  r.REPORT_ID,count(1) as TOTAL_ASSETS
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date) a on a.REPORT_ID = t.REPORT_ID

left outer join (select  r.REPORT_ID,count(1) as SCANABLE_ASSETS
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    WHERE ah.is_scannable = 1
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date) scanable on scanable.REPORT_ID = t.REPORT_ID
    
left outer join (select r.REPORT_ID,count(1) as ASSETS_SCANNED_TODAY
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL and ah.LASTSEEN_VUL::date = r.REPORT_DATE::date
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date) scantoday on scantoday.REPORT_ID = a.REPORT_ID

left outer join (select r.REPORT_ID,count(1) as ASSETS_SCANNED
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date) scan on scan.REPORT_ID = a.REPORT_ID

left outer join (select r.REPORT_ID,count(1) as ASSETS_SCANNED_WITNIN_3_DAYS
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL and DATEDIFF(day, ah.LASTSEEN_VUL, r.REPORT_DATE) <= 3
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date) scanwithin3 on scanwithin3.REPORT_ID = a.REPORT_ID
    
;
create or replace view VW_LIST_CFACTS_ENUM_VALUES(
	THETABLE,
	ID,
	VALUE
) COMMENT='Get list of APP_CFACTS SEC_VW_ENUM values. List of views generated with VW_LIST_CFACTS_ENUM_VIEWS\t'
 as
SELECT 'SEC_VW_ENUM_ALLOCATED__HYBRID_YES' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATED__HYBRID_YES UNION ALL
SELECT 'SEC_VW_ENUM_ALLOCATION_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ALLOCATION_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_ASSESSMENT_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ASSESSMENT_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_AUTHENTICATION_REQUIRED' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_AUTHENTICATION_REQUIRED UNION ALL
SELECT 'SEC_VW_ENUM_AUTHORIZATION_DECISION' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_AUTHORIZATION_DECISION UNION ALL
SELECT 'SEC_VW_ENUM_BACKGROUND_INVESTIGATION' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_BACKGROUND_INVESTIGATION UNION ALL
SELECT 'SEC_VW_ENUM_CLOUD_SERVICE_PROVIDER_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_CLOUD_SERVICE_PROVIDER_1 UNION ALL
SELECT 'SEC_VW_ENUM_CONTINGENCY_PLAN_TEST_RESULTS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_CONTINGENCY_PLAN_TEST_RESULTS UNION ALL
SELECT 'SEC_VW_ENUM_CONTROL_FAMILY' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_CONTROL_FAMILY UNION ALL
SELECT 'SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU UNION ALL
SELECT 'SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU_1 UNION ALL
SELECT 'SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU_2' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_COPY_OF_SINGLESIGNON_SSO_OU_2 UNION ALL
SELECT 'SEC_VW_ENUM_DOES_THE_SYSTEM_SUPPORT_THE_ACTIVITIES_O' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_DOES_THE_SYSTEM_SUPPORT_THE_ACTIVITIES_O UNION ALL
SELECT 'SEC_VW_ENUM_EAUTHENTICATION_LEVEL' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_EAUTHENTICATION_LEVEL UNION ALL
SELECT 'SEC_VW_ENUM_ENTRY_POINT_USED' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ENTRY_POINT_USED UNION ALL
SELECT 'SEC_VW_ENUM_ENTRY_POINT_USED_NOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ENTRY_POINT_USED_NOU UNION ALL
SELECT 'SEC_VW_ENUM_ENTRY_POINT_USED_PNOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ENTRY_POINT_USED_PNOU UNION ALL
SELECT 'SEC_VW_ENUM_ENTRY_POINT_USED_POU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ENTRY_POINT_USED_POU UNION ALL
SELECT 'SEC_VW_ENUM_ENTRY_POINT_USERD_PNOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ENTRY_POINT_USERD_PNOU UNION ALL
SELECT 'SEC_VW_ENUM_FINAL_APPROVER_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_FINAL_APPROVER_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_FINANCIAL_SYSTEM' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_FINANCIAL_SYSTEM UNION ALL
SELECT 'SEC_VW_ENUM_FISMA_REPORTABLE' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_FISMA_REPORTABLE UNION ALL
SELECT 'SEC_VW_ENUM_FUNDING_SOURCE' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_FUNDING_SOURCE UNION ALL
SELECT 'SEC_VW_ENUM_GVL_YESNO' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_GVL_YESNO UNION ALL
SELECT 'SEC_VW_ENUM_GVL_YES__NO__DEFAULT_NO' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_GVL_YES__NO__DEFAULT_NO UNION ALL
SELECT 'SEC_VW_ENUM_HELPER_PIA014' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_HELPER_PIA014 UNION ALL
SELECT 'SEC_VW_ENUM_HSDW_' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_HSDW_ UNION ALL
SELECT 'SEC_VW_ENUM_INFORMATION_SYSTEM_TYPE' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_INFORMATION_SYSTEM_TYPE UNION ALL
SELECT 'SEC_VW_ENUM_INHERITABLE2' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_INHERITABLE2 UNION ALL
SELECT 'SEC_VW_ENUM_ISRA_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_ISRA_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_IS_THE_PII_THAT_THE_SYSTEM_COLLECTS_MAIN' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_IS_THE_PII_THAT_THE_SYSTEM_COLLECTS_MAIN UNION ALL
SELECT 'SEC_VW_ENUM_IS_THE_SYSTEM_PUBLIC_AKA_INTERNET_FACING' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_IS_THE_SYSTEM_PUBLIC_AKA_INTERNET_FACING UNION ALL
SELECT 'SEC_VW_ENUM_IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_IS_THIS_HVA_NECESSARY_TO_PERFORM_MEF UNION ALL
SELECT 'SEC_VW_ENUM_IS_THIS_SYSTEM_ACCESSED_BY_NONORGANIZATI' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_IS_THIS_SYSTEM_ACCESSED_BY_NONORGANIZATI UNION ALL
SELECT 'SEC_VW_ENUM_MARKETPLACE_SYSTEMS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_MARKETPLACE_SYSTEMS UNION ALL
SELECT 'SEC_VW_ENUM_MFA_INHERITED_OU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_MFA_INHERITED_OU UNION ALL
SELECT 'SEC_VW_ENUM_MILESTONE_STATUS_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_MILESTONE_STATUS_1 UNION ALL
SELECT 'SEC_VW_ENUM_MISSION_ESSENTIAL_FUNCTIONS_' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_MISSION_ESSENTIAL_FUNCTIONS_ UNION ALL
SELECT 'SEC_VW_ENUM_MULTIFACTOR_AUTHENTICATION_OPTIONS_ENABL' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_MULTIFACTOR_AUTHENTICATION_OPTIONS_ENABL UNION ALL
SELECT 'SEC_VW_ENUM_NONORGANIZATIONAL_MULTIFACTOR_AUTHENTICA' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_NONORGANIZATIONAL_MULTIFACTOR_AUTHENTICA UNION ALL
SELECT 'SEC_VW_ENUM_OA_ENTRANCE_CRITERIA_MET' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OA_ENTRANCE_CRITERIA_MET UNION ALL
SELECT 'SEC_VW_ENUM_OA_READY' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OA_READY UNION ALL
SELECT 'SEC_VW_ENUM_OA_READY_WITH_HOSTING' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OA_READY_WITH_HOSTING UNION ALL
SELECT 'SEC_VW_ENUM_OA_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OA_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_OA_STATUS2' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OA_STATUS2 UNION ALL
SELECT 'SEC_VW_ENUM_OPERATED_BY' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OPERATED_BY UNION ALL
SELECT 'SEC_VW_ENUM_OPERATING_LOCATION' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OPERATING_LOCATION UNION ALL
SELECT 'SEC_VW_ENUM_OVERALL_CONTROL_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OVERALL_CONTROL_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_OVERALL_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_OVERALL_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_PACKAGE_TYPE' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_PACKAGE_TYPE UNION ALL
SELECT 'SEC_VW_ENUM_PRIVILEGED_MULTIFACTOR_AUTHENTICATION_OP' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_PRIVILEGED_MULTIFACTOR_AUTHENTICATION_OP UNION ALL
SELECT 'SEC_VW_ENUM_PRIVILEGED_NONORGANIZATIONAL_MULTIFACTOR' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_PRIVILEGED_NONORGANIZATIONAL_MULTIFACTOR UNION ALL
SELECT 'SEC_VW_ENUM_RBD_OVERALL_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_RBD_OVERALL_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_REASON_FOR_ATO_REQUEST' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_REASON_FOR_ATO_REQUEST UNION ALL
SELECT 'SEC_VW_ENUM_REVIEW_STATUS_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_REVIEW_STATUS_1 UNION ALL
SELECT 'SEC_VW_ENUM_RISK_LEVEL_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_RISK_LEVEL_1 UNION ALL
SELECT 'SEC_VW_ENUM_RISK_REVIEW_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_RISK_REVIEW_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_RISK_SUBMISSION_STATUS' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_RISK_SUBMISSION_STATUS UNION ALL
SELECT 'SEC_VW_ENUM_SECURITY_CATEGORY' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_SECURITY_CATEGORY UNION ALL
SELECT 'SEC_VW_ENUM_SINGLESIGNON_SSO' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_SINGLESIGNON_SSO UNION ALL
SELECT 'SEC_VW_ENUM_STATUS_9' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_STATUS_9 UNION ALL
SELECT 'SEC_VW_ENUM_TYPE_OF_MULTIFACTOR_AUTHENTICATION_1' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_TYPE_OF_MULTIFACTOR_AUTHENTICATION_1 UNION ALL
SELECT 'SEC_VW_ENUM_TYPE_OF_MULTIFACTOR_AUTHENTICATION_IN_US' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_TYPE_OF_MULTIFACTOR_AUTHENTICATION_IN_US UNION ALL
SELECT 'SEC_VW_ENUM_USER_INTERFACES' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_USER_INTERFACES UNION ALL
SELECT 'SEC_VW_ENUM_USER_INTERFACESS_NOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_USER_INTERFACESS_NOU UNION ALL
SELECT 'SEC_VW_ENUM_USER_INTERFACES_PNOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_USER_INTERFACES_PNOU UNION ALL
SELECT 'SEC_VW_ENUM_USER_INTERFACES_POU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_USER_INTERFACES_POU UNION ALL
SELECT 'SEC_VW_ENUM_WEAKNESS_SEVERITY' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_WEAKNESS_SEVERITY UNION ALL
SELECT 'SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION UNION ALL
SELECT 'SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION_NOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION_NOU UNION ALL
SELECT 'SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION_PNOU' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_WHAT_STAGE_OF_IMPLEMENTATION_PNOU UNION ALL
SELECT 'SEC_VW_ENUM_XLC_PHASE' as TheTable, ID, VALUE FROM APP_CFACTS.SHARED.SEC_VW_ENUM_XLC_PHASE
;
create or replace view VW_LIST_CFACTS_ENUM_VIEWS(
	THECOMMAND
) COMMENT='Get list of APP_CFACTS SEC_VW_ENUM views for obtaining Values\t'
 as
SELECT 'SELECT ' || char(39) || TABLE_NAME || char(39) || ' as TheTable, ID, VALUE FROM ' 
|| TABLE_CATALOG || '.' || TABLE_SCHEMA || '.' || TABLE_NAME || ' UNION ALL' as TheCommand
FROM APP_CFACTS.INFORMATION_SCHEMA.VIEWS v
WHERE v.TABLE_SCHEMA IN ('SHARED') and UPPER(TABLE_NAME) LIKE '%ENUM%'
order by TABLE_NAME
;
create or replace view VW_LIST_CRM_COLUMNS(
	DATABASENAME,
	DBSCHEMA,
	OBJECTNAME,
	OBJECTTYPE,
	OBJECT_LAST_ALTERED,
	OBJECT_COMMENT,
	COLUMN_NAME,
	COLUMN_DEFAULT,
	IS_NULLABLE,
	DATA_TYPE,
	IS_IDENTITY,
	COLUMN_COMMENT
) COMMENT='View to list all column names of objects available to CRM\t'
 as
SELECT tbl.DATABASENAME,tbl.DBSCHEMA,tbl.OBJECTNAME,tbl.OBJECTTYPE,tbl.LAST_ALTERED as OBJECT_LAST_ALTERED,tbl.COMMENT as OBJECT_COMMENT,crm.COLUMN_NAME, crm.COLUMN_DEFAULT, crm.IS_NULLABLE, crm.DATA_TYPE, crm.IS_IDENTITY,crm.COMMENT as COLUMN_COMMENT
FROM DBA.VW_LIST_CRM_TABLES_AND_VIEWS tbl
LEFT OUTER JOIN (
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL 

select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_ARCHER.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_AXONIUS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_CDM.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_CFACTS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- 250218 select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_SIGNAL.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from APP_TENABLE.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,TABLE_NAME,COLUMN_NAME,COLUMN_DEFAULT,IS_NULLABLE,DATA_TYPE,IS_IDENTITY,COMMENT from REF_LOOKUPS.INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA'


) crm on crm.TABLE_CATALOG = tbl.DATABASENAME and crm.TABLE_SCHEMA = tbl.DBSCHEMA and crm.TABLE_NAME = tbl.OBJECTNAME
;
create or replace view VW_LIST_CRM_OBJECTS(
	DATABASENAME,
	DBSCHEMA,
	OBJECTTYPE,
	OBJECTNAME,
	CREATED,
	LAST_ALTERED,
	LAST_DDL,
	LAST_DDL_BY,
	OWNER,
	COMMENT
) COMMENT='View to list all objects available to CRM\t'
 as
select
	v.DATABASENAME,
	v.DBSCHEMA,
	v.OBJECTTYPE,
	v.OBJECTNAME,
    substring(v.CREATED::string,1,16) as CREATED,
    substring(v.LAST_ALTERED::string,1,16) as LAST_ALTERED,
    substring(v.LAST_DDL::string,1,16) as LAST_DDL,
    v.LAST_DDL_BY,
    v.OWNER,
	v.COMMENT
FROM
(select DATABASE_NAME as DatabaseName, 'N/A' as DBSchema, 'Database' as ObjectType, DATABASE_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,DATABASE_OWNER as OWNER,COMMENT 
 from INFORMATION_SCHEMA.DATABASES UNION ALL
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,PROCEDURE_OWNER as OWNER,COMMENT 
 from INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,FUNCTION_OWNER as OWNER,COMMENT
 from INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,LAST_DDL,LAST_DDL_BY,TABLE_OWNER as OWNER,COMMENT
 from INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,LAST_DDL,LAST_DDL_BY,TABLE_OWNER as OWNER,COMMENT
 from INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Pipe' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,PIPE_OWNER as OWNER,COMMENT 
 from INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,SCHEMA_OWNER as OWNER,COMMENT 
 from INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,NULL as LAST_DDL,NULL as LAST_DDL_BY,STAGE_OWNER as OWNER,COMMENT 
 from INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA'
) v
--WHERE v.DATABASENAME = 'BUS_CYBER_RISK_MANAGEMENT';
;
create or replace view VW_LIST_CRM_TABLES_AND_VIEWS(
	DATABASENAME,
	DBSCHEMA,
	OBJECTTYPE,
	OBJECTNAME,
	CREATED,
	LAST_ALTERED,
	COMMENT
) COMMENT='View to list all Tables and Views available to CRM\t'
 as
select
	crm.TABLE_CATALOG as DATABASENAME
	,crm.TABLE_SCHEMA as DBSCHEMA
	,crm.OBJECTTYPE
	,crm.TABLE_NAME
    ,substring(crm.CREATED::varchar,1,16) as CREATED
    ,substring(crm.LAST_ALTERED::varchar,1,16) as LAST_ALTERED
	,crm.COMMENT
FROM
(select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_SCHEMA IN ('DBA','CEDE','CORE','RPT') UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' and TABLE_SCHEMA IN ('DBA','CEDE','CORE','RPT') UNION ALL

select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_CDM.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_CDM.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL

select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_CFACTS.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_CFACTS.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL

select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_TENABLE.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_TENABLE.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL

select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from REF_LOOKUPS.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from REF_LOOKUPS.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL

select TABLE_CATALOG,TABLE_SCHEMA,'View' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_ARCHER.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG,TABLE_SCHEMA,'Table' as OBJECTTYPE,TABLE_NAME,CREATED,LAST_ALTERED,COMMENT
    from APP_ARCHER.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW'
 
) crm
--WHERE v.DATABASENAME = 'BUS_CYBER_RISK_MANAGEMENT';
;
create or replace view VW_LIST_CRM_VIEWS(
	THEOBJECT
) COMMENT='View can be used to list production views for testing their functionality\t'
 as
--
-- SELECT 'SELECT TOP 1 ' || char(39) || DBSCHEMA || char(46)  || OBJECTNAME || char(39) || ' FROM ' || DBSCHEMA || '.' || char(34) || OBJECTNAME || char(34) || ' UNION ALL' as TheObject
-- FROM DBA.VW_LIST_CRM_OBJECTS WHERE OBJECTTYPE = 'View' AND DBSCHEMA IN ('CEDE','CORE','DBA','RPT')
--
SELECT 'SELECT * FROM ' || DBSCHEMA || '.' || char(34) || OBJECTNAME || char(34) || ' limit 2;' as TheObject
FROM DBA.VW_LIST_CRM_OBJECTS WHERE OBJECTTYPE = 'View' AND DBSCHEMA IN ('CEDE','CORE','DBA','RPT')
ORDER BY DBSCHEMA, OBJECTNAME;
create or replace view VW_LIST_EXTERNAL_OBJECTS(
	DATABASENAME,
	DBSCHEMA,
	OBJECTTYPE,
	OBJECTNAME,
	CREATED,
	LAST_ALTERED,
	COMMENT
) COMMENT='View to list all objects available to CRM\t'
 as
select
	v.DATABASENAME,
	v.DBSCHEMA,
	v.OBJECTTYPE,
	v.OBJECTNAME,
    TO_CHAR(v.CREATED,'MM/DD/YYYY HH24:MI') as CREATED,
    TO_CHAR(v.LAST_ALTERED,'MM/DD/YYYY HH24:MI') as LAST_ALTERED,
	v.COMMENT
FROM
(
-- APP_CDM
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CDM.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CDM.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CDM.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CDM.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CDM.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CDM.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CDM.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- APP_CFACTS
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CFACTS.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CFACTS.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_CFACTS.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CFACTS.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CFACTS.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CFACTS.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_CFACTS.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- APP_FORESCOUT
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_FORESCOUT.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_FORESCOUT.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_FORESCOUT.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_FORESCOUT.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_FORESCOUT.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_FORESCOUT.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_FORESCOUT.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- APP_SIGNAL
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SIGNAL.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SIGNAL.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SIGNAL.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SIGNAL.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SIGNAL.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SIGNAL.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SIGNAL.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
 -- APP_SNYK
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SNYK.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SNYK.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_SNYK.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SNYK.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SNYK.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SNYK.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_SNYK.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- APP_TENABLE
select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_TENABLE.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_TENABLE.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from APP_TENABLE.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_TENABLE.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_TENABLE.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_TENABLE.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from APP_TENABLE.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
-- REF_LOOKUP
 select PROCEDURE_CATALOG as DatabaseName, PROCEDURE_SCHEMA as DBSchema, 'Procedure' as ObjectType, PROCEDURE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from REF_LOOKUPS.INFORMATION_SCHEMA.PROCEDURES WHERE PROCEDURE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select FUNCTION_CATALOG as DatabaseName, FUNCTION_SCHEMA as DBSchema, 'Function' as ObjectType, FUNCTION_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from REF_LOOKUPS.INFORMATION_SCHEMA.FUNCTIONS WHERE FUNCTION_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'View' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT 
 from REF_LOOKUPS.INFORMATION_SCHEMA.VIEWS WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select TABLE_CATALOG as DatabaseName, TABLE_SCHEMA as DBSchema, 'Table' as ObjectType, TABLE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from REF_LOOKUPS.INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA <> 'INFORMATION_SCHEMA' and TABLE_TYPE <> 'VIEW' UNION ALL
select PIPE_CATALOG as DatabaseName, PIPE_SCHEMA as DBSchema, 'Table' as ObjectType, PIPE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from REF_LOOKUPS.INFORMATION_SCHEMA.PIPES WHERE PIPE_SCHEMA <> 'INFORMATION_SCHEMA' UNION ALL
select CATALOG_NAME as DatabaseName, SCHEMA_NAME as DBSchema, 'Schema' as ObjectType, SCHEMA_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from REF_LOOKUPS.INFORMATION_SCHEMA.SCHEMATA WHERE SCHEMA_NAME <> 'INFORMATION_SCHEMA' UNION ALL
select STAGE_CATALOG as DatabaseName, STAGE_SCHEMA as DBSchema, 'Stage' as ObjectType, STAGE_NAME as ObjectName,CREATED,LAST_ALTERED,COMMENT
 from REF_LOOKUPS.INFORMATION_SCHEMA.STAGES WHERE STAGE_SCHEMA <> 'INFORMATION_SCHEMA'
 
) v
WHERE v.DATABASENAME <> 'BUS_CYBER_RISK_MANAGEMENT';
;
create or replace view VW_MFA_TEST(
	IDUID,
	PARENTCONTENTID,
	VALUE
) as
select DISTINCT ap.IDUID
--,x.*
,iou.*
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap
--JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_MFA_AUTHORIZATION_PACKAGE_X_MFA_AUTHORIZATION_PACKAGE x on x.Authorization_Package_MFA_Authorization_Package_ContentId = ap.contentid

LEFT OUTER JOIN (select distinct x.Authorization_Package_MFA_Authorization_Package_ContentId as ParentContentId,e.Value
    FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_MFA_AUTHORIZATION_PACKAGE_X_MFA_AUTHORIZATION_PACKAGE x
    JOIN APP_CFACTS.SHARED.SEC_VW_MFA_MFA_Inherited_OU p on p.parentcontentid = x.MFA_Authorization_Package_ContentId
    JOIN APP_CFACTS.SHARED.SEC_VW_enum_MFA_Inherited_OU e on e.ID = p.value) iou on iou.ParentContentId = ap.contentid

/***************** OF INTEREST
select ap.IDUID,x.MFA_Authorization_Package_ContentId
,MFA.* 
FROM APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE ap
JOIN APP_CFACTS.SHARED.SEC_VW_AUTHORIZATION_PACKAGE_MFA_AUTHORIZATION_PACKAGE_X_MFA_AUTHORIZATION_PACKAGE x on x.Authorization_Package_MFA_Authorization_Package_ContentId = ap.contentid
JOIN APP_CFACTS.SHARED.SEC_VW_MFA mfa on mfa.contentid = x.MFA_Authorization_Package_ContentId
where 
ap.iduid = '0074BAC6-7C64-452F-9991-BF844D99196C' 
and mfa.authentication_datafeed_id is not null
order by ap.IDUID,x.MFA_Authorization_Package_ContentId
****************************************************************/


/*
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Multifactor_Authentication_Options_Enabl ON  APP_CFACTS.SHARED.SEC_VW_MFA_Multifactor_Authentication_Options_Enabl.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Multifactor_Authentication_Options_Enabl on APP_CFACTS.SHARED.SEC_VW_enum_Multifactor_Authentication_Options_Enabl.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Multifactor_Authentication_Options_Enabl.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_NonOrganizational_Multifactor_Authentica ON  APP_CFACTS.SHARED.SEC_VW_MFA_NonOrganizational_Multifactor_Authentica.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_NonOrganizational_Multifactor_Authentica on APP_CFACTS.SHARED.SEC_VW_enum_NonOrganizational_Multifactor_Authentica.ID = APP_CFACTS.SHARED.SEC_VW_MFA_NonOrganizational_Multifactor_Authentica.Value	

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_Multifactor_Authentication_Op ON  APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_Multifactor_Authentication_Op.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Privileged_Multifactor_Authentication_Op on APP_CFACTS.SHARED.SEC_VW_enum_Privileged_Multifactor_Authentication_Op.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_Multifactor_Authentication_Op.Value	

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_NonOrganizational_Multifactor ON  APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_NonOrganizational_Multifactor.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Privileged_NonOrganizational_Multifactor on APP_CFACTS.SHARED.SEC_VW_enum_Privileged_NonOrganizational_Multifactor.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Privileged_NonOrganizational_Multifactor.Value	

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Type_of_MultiFactor_Authentication_in_Us ON  APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Type_of_MultiFactor_Authentication_in_Us.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_in_Us on APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_in_Us.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Type_of_MultiFactor_Authentication_in_Us.Value
*/


/*
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_Authorization_Package__122_MultiFactor_Authentication ON  APP_CFACTS.SHARED.SEC_VW_Authorization_Package__122_MultiFactor_Authentication.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum__122_MultiFactor_Authentication on APP_CFACTS.SHARED.SEC_VW_enum__122_MultiFactor_Authentication.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package__122_MultiFactor_Authentication.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_multifactor_Required ON  APP_CFACTS.SHARED.SEC_VW_Authorization_Package_multifactor_Required.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_multifactor_Required on APP_CFACTS.SHARED.SEC_VW_enum_multifactor_Required.ID = APP_CFACTS.SHARED.SEC_VW_Authorization_Package_multifactor_Required.Value	

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Authentication_Type_Name ON  APP_CFACTS.SHARED.SEC_VW_MFA_Authentication_Type_Name.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_1 on APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_1.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Authentication_Type_Name.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Background_Investigation ON  APP_CFACTS.SHARED.SEC_VW_MFA_Background_Investigation.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Background_Investigation on APP_CFACTS.SHARED.SEC_VW_enum_Background_Investigation.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Background_Investigation.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU ON  APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU on APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_1 ON  APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_1.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU_1 on APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU_1.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_1.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_2 ON  APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_2.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU_2 on APP_CFACTS.SHARED.SEC_VW_enum_Copy_of_SingleSignOn_SSO_OU_2.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Copy_of_SingleSignOn_SSO_OU_2.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used ON  APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used on APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_NOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_NOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_NOU on APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_NOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_NOU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_PNOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_PNOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_PNOU on APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_PNOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_PNOU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_POU ON  APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_POU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_POU on APP_CFACTS.SHARED.SEC_VW_enum_Entry_Point_Used_POU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Entry_Point_Used_POU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_SingleSignOn_SSO ON  APP_CFACTS.SHARED.SEC_VW_MFA_SingleSignOn_SSO.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_SingleSignOn_SSO on APP_CFACTS.SHARED.SEC_VW_enum_SingleSignOn_SSO.ID = APP_CFACTS.SHARED.SEC_VW_MFA_SingleSignOn_SSO.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_Type_of_MultiFactor_Authentication_in_Us ON  APP_CFACTS.SHARED.SEC_VW_MFA_Type_of_MultiFactor_Authentication_in_Us.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_1 on APP_CFACTS.SHARED.SEC_VW_enum_Type_of_MultiFactor_Authentication_1.ID = APP_CFACTS.SHARED.SEC_VW_MFA_Type_of_MultiFactor_Authentication_in_Us.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_user_Interfaces ON  APP_CFACTS.SHARED.SEC_VW_MFA_user_Interfaces.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_user_Interfaces on APP_CFACTS.SHARED.SEC_VW_enum_user_Interfaces.ID = APP_CFACTS.SHARED.SEC_VW_MFA_user_Interfaces.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_PNOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_PNOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_User_Interfaces_PNOU on APP_CFACTS.SHARED.SEC_VW_enum_User_Interfaces_PNOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_PNOU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_POU ON  APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_POU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_User_Interfaces_POU on APP_CFACTS.SHARED.SEC_VW_enum_User_Interfaces_POU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfaces_POU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfacess_NOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfacess_NOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_User_Interfacess_NOU on APP_CFACTS.SHARED.SEC_VW_enum_User_Interfacess_NOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_User_Interfacess_NOU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation ON  APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation on APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation.ID = APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_NOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_NOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation_NOU on APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation_NOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_NOU.Value	
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_PNOU ON  APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_PNOU.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation_PNOU on APP_CFACTS.SHARED.SEC_VW_enum_What_stage_of_Implementation_PNOU.ID = APP_CFACTS.SHARED.SEC_VW_MFA_What_stage_of_Implementation_PNOU.Value	
*/
WHERE ap.IDUID IS NOT NULL
--and ap.IDUID = '9009F83A-D7B8-4C11-A48A-6A7AA284F727'
ORDER BY ap.IDUID
;
create or replace view VW_MSGLOG(
	ID,
	INSERT_DATE,
	APPL,
	MSG
) COMMENT='Visibility of process steps and warnings (Historical)\t'
 as
SELECT ID
,substring(INSERT_DATE::varchar,1,16) as INSERT_DATE
,APPL,MSG
FROM CORE.MSGLOG ORDER BY ID DESC;
create or replace view VW_OBJECT_COMMENTS(
	DBSCHEMA,
	OBJECTTYPE,
	OBJECTNAME,
	ALTERSTRING,
	COMMENT
) COMMENT='List of database objects with comments\t'
 as
SELECT DBSCHEMA,OBJECTTYPE,OBJECTNAME
,'Alter ' || OBJECTTYPE || ' ' || DBSCHEMA || '.' || OBJECTNAME || ' SET COMMENT=' as AlterString
,COMMENT
FROM DBA.VW_LIST_CRM_OBJECTS 
WHERE DATABASENAME = 'BUS_CYBER_RISK_MANAGEMENT' 
and UPPER(OBJECTTYPE) <> 'SCHEMA'
--and COMMENT IS NULL
and UPPER(OBJECTTYPE) IN ('FUNCTION','PROCEDURE','TABLE','VIEW')
and DBSCHEMA in ('DBA','CEDE','CORE','RPT')
ORDER BY DBSCHEMA,OBJECTTYPE,OBJECTNAME;
create or replace view VW_QUERY_HISTORY(
	QUERY_TYPE,
	ERROR_MESSAGE,
	QUERY_TEXT,
	USER_NAME,
	START_TIME,
	END_TIME,
	TOTAL_ELAPSED_TIME,
	COMPILATION_TIME,
	EXECUTION_TIME,
	ROWS_PRODUCED,
	DATABASE_NAME,
	SCHEMA_NAME,
	SESSION_ID,
	ROLE_NAME,
	WAREHOUSE_NAME,
	WAREHOUSE_SIZE,
	WAREHOUSE_TYPE,
	CLUSTER_NUMBER,
	QUERY_TAG,
	EXECUTION_STATUS,
	ERROR_CODE,
	BYTES_SCANNED,
	QUERY_ID,
	QUEUED_PROVISIONING_TIME,
	QUEUED_REPAIR_TIME,
	QUEUED_OVERLOAD_TIME,
	TRANSACTION_BLOCKED_TIME,
	OUTBOUND_DATA_TRANSFER_CLOUD,
	OUTBOUND_DATA_TRANSFER_REGION,
	OUTBOUND_DATA_TRANSFER_BYTES,
	INBOUND_DATA_TRANSFER_CLOUD,
	INBOUND_DATA_TRANSFER_REGION,
	INBOUND_DATA_TRANSFER_BYTES,
	CREDITS_USED_CLOUD_SERVICES,
	LIST_EXTERNAL_FILE_TIME,
	RELEASE_VERSION,
	EXTERNAL_FUNCTION_TOTAL_INVOCATIONS,
	EXTERNAL_FUNCTION_TOTAL_SENT_ROWS,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS,
	EXTERNAL_FUNCTION_TOTAL_SENT_BYTES,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES,
	IS_CLIENT_GENERATED_STATEMENT
) COMMENT='Diagnostic View to list queries executed against the CORE schema\t'
 as
select 
   QUERY_TYPE,
    ERROR_MESSAGE,
	QUERY_TEXT,
	USER_NAME,
    START_TIME,
	END_TIME,
	TOTAL_ELAPSED_TIME,
	COMPILATION_TIME,
	EXECUTION_TIME,
    ROWS_PRODUCED,
	DATABASE_NAME,
	SCHEMA_NAME,
	SESSION_ID,
	ROLE_NAME,
	WAREHOUSE_NAME,
	WAREHOUSE_SIZE,
	WAREHOUSE_TYPE,
	CLUSTER_NUMBER,
	QUERY_TAG,
	EXECUTION_STATUS,
	ERROR_CODE,
	BYTES_SCANNED,
    QUERY_ID,
	QUEUED_PROVISIONING_TIME,
	QUEUED_REPAIR_TIME,
	QUEUED_OVERLOAD_TIME,
	TRANSACTION_BLOCKED_TIME,
	OUTBOUND_DATA_TRANSFER_CLOUD,
	OUTBOUND_DATA_TRANSFER_REGION,
	OUTBOUND_DATA_TRANSFER_BYTES,
	INBOUND_DATA_TRANSFER_CLOUD,
	INBOUND_DATA_TRANSFER_REGION,
	INBOUND_DATA_TRANSFER_BYTES,
	CREDITS_USED_CLOUD_SERVICES,
	LIST_EXTERNAL_FILE_TIME,
	RELEASE_VERSION,
	EXTERNAL_FUNCTION_TOTAL_INVOCATIONS,
	EXTERNAL_FUNCTION_TOTAL_SENT_ROWS,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_ROWS,
	EXTERNAL_FUNCTION_TOTAL_SENT_BYTES,
	EXTERNAL_FUNCTION_TOTAL_RECEIVED_BYTES,
	IS_CLIENT_GENERATED_STATEMENT
from table(information_schema.query_history())
WHERE DATABASE_NAME='BUS_CYBER_RISK_MANAGEMENT' AND SCHEMA_NAME='CORE'
;
create or replace view VW_RAW_EXCEPTION_SUMMARY(
	SNAPSHOT_ID,
	SNAPSHOT_DATE,
	DATACATEGORY,
	MSGTYPE,
	MSG,
	TOTAL
) COMMENT='View to report data errors/warnings in RAW_HWAM and RAW_TENABLE_VUL tables in summary form (Historical)\t'
 as
select snap.snapshot_id,snap.snapshot_date::date as snapshot_date,snap.datacategory,t.MsgType,t.Msg,t.Total
FROM CORE.SNAPSHOT_IDS snap
JOIN
(
select r.snapshot_id,'Error' as MsgType,f.value::string MSG,count(1) Total 
FROM CORE.RAW_HWAM r
JOIN table(flatten(r.data_error_array,outer=>true)) as f
group by r.snapshot_id,f.value::string 
UNION ALL
select r.snapshot_id,'Warn' as MsgType,f.value::string MSG,count(1) Total 
FROM CORE.RAW_HWAM r
JOIN table(flatten(r.data_warning_array,outer=>true)) as f
group by r.snapshot_id,f.value::string 
UNION ALL
select r.snapshot_id,'Error' as MsgType,f.value::string MSG,count(1) Total 
FROM CORE.RAW_TENABLE_VUL r
JOIN table(flatten(r.data_error_array,outer=>true)) as f
group by r.snapshot_id,f.value::string 
UNION ALL
select r.snapshot_id,'Warn' as MsgType,f.value::string MSG,count(1) Total 
FROM CORE.RAW_TENABLE_VUL r
JOIN table(flatten(r.data_warning_array,outer=>true)) as f
group by r.snapshot_id,f.value::string 
) t on t.snapshot_id = snap.snapshot_id
WHERE snap.snapshot_date >= current_date()
order by snap.snapshot_id,snap.snapshot_date::date,snap.datacategory,t.MsgType,t.MSG;
create or replace view VW_RAW_HWAM_ASSET_IDENTIFYING_FIELDS(
	ASSET_ID_TATTOO,
	BIOS_GUID,
	DATACENTER_ID,
	DW_ASSET_ID,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	SYSTEM_ID,
	TENANT_ID,
	TEST_DW_ASSET_ID
) as
SELECT DISTINCT
ASSET_ID_TATTOO
,BIOS_GUID
,DATACENTER_ID
,DW_ASSET_ID
,ARRAY_TO_STRING(FQDN,',') as FQDN
,ARRAY_TO_STRING(HOSTNAME,',') as HOSTNAME
,ARRAY_TO_STRING(IPV4,',') as IPV4
,ARRAY_TO_STRING(IPV6,',') as IPV6
,ARRAY_TO_STRING(MACADDRESS,',') as MACADDRESS
,MOTHERBOARD
,ARRAY_TO_STRING(NETBIOSNAME,',') as NETBIOSNAME
--,RAW_HWAM_ID
,SYSTEM_ID
,TENANT_ID
,TEST_DW_ASSET_ID
,FROM CORE.RAW_HWAM
WHERE SNAPSHOT_ID = 2271
--and TEST_DW_ASSET_ID = 0
;
create or replace view VW_RAW_HWAM_EXCEPTIONS(
	RAW_HWAM_ID,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_DATACENTER_ID,
	AWS_PRIMARY_FISMA_ID_TATTOO,
	AWS_INSTANCE_ID,
	AXONIUS_ADAPTER_LIST_LENGTH,
	AXONIUS_ADAPTERS,
	AXONIUS_ADAPTERS_UUID,
	AXONIUS_INTERNAL_AXONIUS_ID,
	BIGFIX_ASSET_ID,
	BIGFIX_ASSET_ID_TATTOO,
	BIGFIX_DATACENTER_ID,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO,
	BIOS_GUID,
	CLOUD_ID,
	CLOUD_PROVIDER,
	COMPUTER_TYPE,
	CONNECTION_LABEL,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DEVICE_MANUFACTURER,
	DEVICE_TYPE,
	DOMAIN_PREFERRED,
	ENVIRONMENT,
	EVENTTIME,
	FIRST_FETCH_TIME,
	FORESCOUT_ASSET_ID_TATTOO,
	FORESCOUT_ASSIGNED_LABELS,
	FORESCOUT_DATACENTER_ID,
	FORESCOUT_PRIMARY_FISMA_ID,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	INSTANCESTATUS,
	IPV4,
	IPV6,
	IS_FS_MANAGED,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	IS_WINDOWS_SERVER_PREFERRED,
	LABELS,
	LAST_CONFIRMED_TIME,
	LAST_USED_USERS_COMPANY_ASSOCIATION,
	LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_BUILD_PREFERRED,
	OS_CPE,
	OS_DOTTED,
	OS_MAJOR,
	OS_MINOR,
	OS_TYPE_DISTRIBUTION_PREFERRED,
	OS_TYPE_PREFERRED,
	OS_VERSION,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	REPORTDATE,
	ROWDISPOSITION,
	SITECODE_PREFERRED,
	SNAPSHOT_ID,
	SOURCE_TOOL,
	SUBNETS_PREFERRED,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TENABLE_ASSET_ID_TATTOO,
	TENABLE_ASSET_TAGS,
	TENABLE_DATACENTER_ID,
	TENABLE_PRIMARY_FISMA_ID_TATTOO,
	TIME_ZONE,
	VIRTUAL_HOST,
	WINDOWS_PATCH_VERSION,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
	DEVICEMODEL,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	DATACATEGORY,
	SNAPSHOT_DATE
) COMMENT='View to report RAW_HWAM records that have DATA_ERROR_ARRAY or DATA_WARNING_ARRAY populated (Historical)\t'
 as
SELECT 
 h.RAW_HWAM_ID 
,h.ASSET_ID_TATTOO 
,h.AWS_ACCOUNTID 
,h.AWS_DATACENTER_ID 
,h.AWS_PRIMARY_FISMA_ID_TATTOO 
,h.AWS_INSTANCE_ID 
,h.AXONIUS_ADAPTER_LIST_LENGTH 
,array_to_string(h.AXONIUS_ADAPTERS,',') as AXONIUS_ADAPTERS 
,array_to_string(h.AXONIUS_ADAPTERS_UUID,',') as AXONIUS_ADAPTERS_UUID
,h.AXONIUS_INTERNAL_AXONIUS_ID 
,h.BIGFIX_ASSET_ID 
,h.BIGFIX_ASSET_ID_TATTOO 
,h.BIGFIX_DATACENTER_ID 
,h.BIGFIX_PRIMARY_FISMA_ID_TATTOO   
,array_to_string(h.BIOS_GUID,',')  as BIOS_GUID 
,array_to_string(h.CLOUD_ID,',')  as CLOUD_ID 
,array_to_string(h.CLOUD_PROVIDER,',')  as CLOUD_PROVIDER 
,h.COMPUTER_TYPE 
,array_to_string(h.CONNECTION_LABEL,',')  as CONNECTION_LABEL 
,array_to_string(h.DATA_ERROR_ARRAY,',')  as DATA_ERROR_ARRAY 
,array_to_string(h.DATA_WARNING_ARRAY,',')  as DATA_WARNING_ARRAY 
,h.DATACENTER_ID 
,h.DATECOMPLETED 
,array_to_string(h.DEVICE_MANUFACTURER,',')  as DEVICE_MANUFACTURER 
,h.DEVICE_TYPE 
,h.DOMAIN_PREFERRED 
,h.ENVIRONMENT 
,h.EVENTTIME 
,h.FIRST_FETCH_TIME 
,h.FORESCOUT_ASSET_ID_TATTOO 
,h.FORESCOUT_ASSIGNED_LABELS 
,h.FORESCOUT_DATACENTER_ID 
,h.FORESCOUT_PRIMARY_FISMA_ID 
,array_to_string(h.FQDN,',') as  FQDN
,array_to_string(h.HOSTNAME,',') as  HOSTNAME
,h.INSERT_DATE 
,h.INSTANCESTATUS 
,array_to_string(h.IPV4,',') as IPV4 
,array_to_string(h.IPV6,',') as IPV6 
,h.IS_FS_MANAGED 
,h.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,h.IS_WINDOWS_SERVER_PREFERRED 
,array_to_string(h.LABELS,',') as  LABELS
,h.LAST_CONFIRMED_TIME 
,array_to_string(h.LAST_USED_USERS_COMPANY_ASSOCIATION,',') as LAST_USED_USERS_COMPANY_ASSOCIATION 
,array_to_string(h.LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,',') as  LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,array_to_string(h.MACADDRESS,',') as MACADDRESS 
,h.MOTHERBOARD 
,array_to_string(h.NETBIOSNAME,',') as NETBIOSNAME
,h.OS 
,h.OS_BUILD_PREFERRED 
,h.OS_CPE 
,h.OS_DOTTED 
,h.OS_MAJOR 
,h.OS_MINOR 
,h.OS_TYPE_DISTRIBUTION_PREFERRED 
,h.OS_TYPE_PREFERRED 
,h.OS_VERSION 
,h.PRIMARY_FISMA_ID_DERIVED 
,h.PRIMARY_FISMA_ID_TATTOO 
,h.REPORTDATE 
,h.ROWDISPOSITION 
,h.SITECODE_PREFERRED 
,h.SNAPSHOT_ID 
,h.SOURCE_TOOL
,array_to_string(h.SUBNETS_PREFERRED,',') as  SUBNETS_PREFERRED
,h.SYSTEM_ACRONYM 
,h.SYSTEM_ID 
,h.TENABLE_ASSET_ID_TATTOO 
,h.TENABLE_ASSET_TAGS 
,h.TENABLE_DATACENTER_ID 
,h.TENABLE_PRIMARY_FISMA_ID_TATTOO 
,array_to_string(h.TIME_ZONE,',') as  TIME_ZONE
,array_to_string(h.VIRTUAL_HOST,',') as VIRTUAL_HOST
,array_to_string(h.WINDOWS_PATCH_VERSION,',') as WINDOWS_PATCH_VERSION 
,array_to_string(h.BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,',')  as BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS 
,h.DEVICEMODEL 
,h.DW_ASSET_ID 
,s.ACRONYM DATACENTER_ACRONYM
,snap.datacategory
,snap.snapshot_date
FROM CORE.RAW_HWAM h
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id=h.snapshot_id
LEFT JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID=h.DATACENTER_ID
where (array_size(h.DATA_ERROR_ARRAY) !=0 or array_size(h.DATA_WARNING_ARRAY) !=0);
create or replace view VW_RAW_HWAM_EXCEPTIONS_240125(
	RAW_HWAM_ID,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_DATACENTER_ID,
	AWS_PRIMARY_FISMA_ID_TATTOO,
	AWS_INSTANCE_ID,
	AXONIUS_ADAPTER_LIST_LENGTH,
	AXONIUS_ADAPTERS,
	AXONIUS_ADAPTERS_UUID,
	AXONIUS_INTERNAL_AXONIUS_ID,
	BIGFIX_ASSET_ID,
	BIGFIX_ASSET_ID_TATTOO,
	BIGFIX_DATACENTER_ID,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO,
	BIOS_GUID,
	CLOUD_ID,
	CLOUD_PROVIDER,
	COMPUTER_TYPE,
	CONNECTION_LABEL,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DEVICE_MANUFACTURER,
	DEVICE_TYPE,
	DOMAIN_PREFERRED,
	ENVIRONMENT,
	EVENTTIME,
	FIRST_FETCH_TIME,
	FORESCOUT_ASSET_ID_TATTOO,
	FORESCOUT_ASSIGNED_LABELS,
	FORESCOUT_DATACENTER_ID,
	FORESCOUT_PRIMARY_FISMA_ID,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	INSTANCESTATUS,
	IPV4,
	IPV6,
	IS_FS_MANAGED,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	IS_WINDOWS_SERVER_PREFERRED,
	LABELS,
	LAST_CONFIRMED_TIME,
	LAST_USED_USERS_COMPANY_ASSOCIATION,
	LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_BUILD_PREFERRED,
	OS_CPE,
	OS_DOTTED,
	OS_MAJOR,
	OS_MINOR,
	OS_TYPE_DISTRIBUTION_PREFERRED,
	OS_TYPE_PREFERRED,
	OS_VERSION,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	REPORTDATE,
	ROWDISPOSITION,
	SITECODE_PREFERRED,
	SNAPSHOT_ID,
	SOURCE_TOOL,
	SUBNETS_PREFERRED,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TENABLE_ASSET_ID_TATTOO,
	TENABLE_ASSET_TAGS,
	TENABLE_DATACENTER_ID,
	TENABLE_PRIMARY_FISMA_ID_TATTOO,
	TIME_ZONE,
	VIRTUAL_HOST,
	WINDOWS_PATCH_VERSION,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
	DEVICEMODEL,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	DATACATEGORY,
	SNAPSHOT_DATE
) COMMENT='View to report RAW_HWAM records that have DATA_ERROR_ARRAY or DATA_WARNING_ARRAY populated (Historical)\t'
 as
SELECT 
 h.RAW_HWAM_ID 
,h.ASSET_ID_TATTOO 
,h.AWS_ACCOUNTID 
,h.AWS_DATACENTER_ID 
,h.AWS_PRIMARY_FISMA_ID_TATTOO 
,h.AWS_INSTANCE_ID 
,h.AXONIUS_ADAPTER_LIST_LENGTH 
,h.AXONIUS_ADAPTERS 
,h.AXONIUS_ADAPTERS_UUID 
,h.AXONIUS_INTERNAL_AXONIUS_ID 
,h.BIGFIX_ASSET_ID 
,h.BIGFIX_ASSET_ID_TATTOO 
,h.BIGFIX_DATACENTER_ID 
,h.BIGFIX_PRIMARY_FISMA_ID_TATTOO 
,h.BIOS_GUID 
,h.CLOUD_ID 
,h.CLOUD_PROVIDER 
,h.COMPUTER_TYPE 
,h.CONNECTION_LABEL 
,h.DATA_ERROR_ARRAY 
,h.DATA_WARNING_ARRAY 
,h.DATACENTER_ID 
,h.DATECOMPLETED 
,h.DEVICE_MANUFACTURER 
,h.DEVICE_TYPE 
,h.DOMAIN_PREFERRED 
,h.ENVIRONMENT 
,h.EVENTTIME 
,h.FIRST_FETCH_TIME 
,h.FORESCOUT_ASSET_ID_TATTOO 
,h.FORESCOUT_ASSIGNED_LABELS 
,h.FORESCOUT_DATACENTER_ID 
,h.FORESCOUT_PRIMARY_FISMA_ID 
,h.FQDN 
,h.HOSTNAME 
,h.INSERT_DATE 
,h.INSTANCESTATUS 
,h.IPV4 
,h.IPV6 
,h.IS_FS_MANAGED 
,h.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,h.IS_WINDOWS_SERVER_PREFERRED 
,h.LABELS 
,h.LAST_CONFIRMED_TIME 
,h.LAST_USED_USERS_COMPANY_ASSOCIATION 
,h.LAST_USED_USERS_DEPARTMENTS_ASSOCIATION 
,h.MACADDRESS 
,h.MOTHERBOARD 
,h.NETBIOSNAME 
,h.OS 
,h.OS_BUILD_PREFERRED 
,h.OS_CPE 
,h.OS_DOTTED 
,h.OS_MAJOR 
,h.OS_MINOR 
,h.OS_TYPE_DISTRIBUTION_PREFERRED 
,h.OS_TYPE_PREFERRED 
,h.OS_VERSION 
,h.PRIMARY_FISMA_ID_DERIVED 
,h.PRIMARY_FISMA_ID_TATTOO 
,h.REPORTDATE 
,h.ROWDISPOSITION 
,h.SITECODE_PREFERRED 
,h.SNAPSHOT_ID 
,h.SOURCE_TOOL
,h.SUBNETS_PREFERRED 
,h.SYSTEM_ACRONYM 
,h.SYSTEM_ID 
,h.TENABLE_ASSET_ID_TATTOO 
,h.TENABLE_ASSET_TAGS 
,h.TENABLE_DATACENTER_ID 
,h.TENABLE_PRIMARY_FISMA_ID_TATTOO 
,h.TIME_ZONE 
,h.VIRTUAL_HOST 
,h.WINDOWS_PATCH_VERSION 
,h.BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS 
,h.DEVICEMODEL 
,h.DW_ASSET_ID 
,s.ACRONYM DATACENTER_ACRONYM
,snap.datacategory
,snap.snapshot_date
FROM CORE.RAW_HWAM h
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id=h.snapshot_id
LEFT JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID=h.DATACENTER_ID
where (array_size(h.DATA_ERROR_ARRAY) !=0 or array_size(h.DATA_WARNING_ARRAY) !=0);
create or replace view VW_RAW_HWAM_POPULATED_FIELDS(
	ASSET_ID_TATTOO,
	BIOS_GUID,
	DATACENTER_ID,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	SYSTEM_ID,
	TOTAL
) as
SELECT DISTINCT
case coalesce(NULLIF(ASSET_ID_TATTOO,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as ASSET_ID_TATTOO
,case coalesce(NULLIF(ARRAY_TO_STRING(BIOS_GUID,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as BIOS_GUID
,case coalesce(NULLIF(DATACENTER_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as DATACENTER_ID
--,case coalesce(NULLIF(DW_ASSET_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as DW_ASSET_ID

,case coalesce(NULLIF(ARRAY_TO_STRING(FQDN,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as FQDN
,case coalesce(NULLIF(ARRAY_TO_STRING(HOSTNAME,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as HOSTNAME
,case coalesce(NULLIF(ARRAY_TO_STRING(IPV4,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as IPV4
,case coalesce(NULLIF(ARRAY_TO_STRING(IPV6,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as IPV6
,case coalesce(NULLIF(ARRAY_TO_STRING(MACADDRESS,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as MACADDRESS

,case coalesce(NULLIF(MOTHERBOARD,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as MOTHERBOARD
,case coalesce(NULLIF(ARRAY_TO_STRING(NETBIOSNAME,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as NETBIOSNAME
,case coalesce(NULLIF(SYSTEM_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as SYSTEM_ID
--,case coalesce(NULLIF(TENANT_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as TENANT_ID
,COUNT(1) Total
FROM CORE.RAW_HWAM
WHERE SNAPSHOT_ID = 2260
--2260
--and TEST_DW_ASSET_ID = 0
GROUP BY 
case coalesce(NULLIF(ASSET_ID_TATTOO,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(BIOS_GUID,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(DATACENTER_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
--,case coalesce(NULLIF(DW_ASSET_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End

,case coalesce(NULLIF(ARRAY_TO_STRING(FQDN,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(HOSTNAME,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(IPV4,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(IPV6,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(MACADDRESS,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End

,case coalesce(NULLIF(MOTHERBOARD,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(ARRAY_TO_STRING(NETBIOSNAME,','),''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(SYSTEM_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
;
create or replace view VW_RAW_TENABLE_VUL_ASSET_ATTRIBUTES(
	RAW_TENABLE_VUL_ID,
	TEMP_DW_ASSET_ID,
	DW_ASSET_ID,
	DW_VUL_ID,
	APPLICABILITYCODE,
	ROWDISPOSITION,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_INSTANCE_ID,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DNSNAME,
	HOSTNAME,
	HOSTUNIQUENESS,
	INSERT_DATE,
	IP,
	MACADDRESS,
	NETBIOSNAME,
	PLUGIN_ID,
	PLUGIN_NAME,
	PLUGIN_TAGS,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	REPOSITORY_ID,
	SNAPSHOT_ID,
	SNAPSHOT_DATE,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TATTOO_PLUGIN_ASSET_ID,
	TATTOO_PLUGIN_PRIMARY_FISMA_ID,
	TENABLEUUID
) COMMENT='Diagnostic View to report RAW_TENABLE_VUL but only fields that represent asset attributes (e.g. FQDN)'
 as
SELECT
r.RAW_TENABLE_VUL_ID
,r.TEMP_DW_ASSET_ID
,r.DW_ASSET_ID
,r.DW_VUL_ID
,r.APPLICABILITYCODE
,r.ROWDISPOSITION
,r.ASSET_ID_TATTOO
,r.AWS_ACCOUNTID
,r.AWS_INSTANCE_ID
,dc.acronym as DATACENTER_ACRONYM
,r.DATACENTER_ID
,r.DATA_ERROR_ARRAY
,r.DATA_WARNING_ARRAY
,r.DNSNAME
,r.HOSTNAME
,r.HOSTUNIQUENESS
,r.INSERT_DATE
,r.IP
,r.MACADDRESS
,r.NETBIOSNAME
,r.PLUGIN_ID
,r.PLUGIN_NAME
,r.PLUGIN_TAGS
--,r.PLUGINTEXT
,r.PRIMARY_FISMA_ID_DERIVED
,r.PRIMARY_FISMA_ID_TATTOO
,r.REPOSITORY_ID
,r.SNAPSHOT_ID
,snap.snapshot_date
,s.acronym as SYSTEM_ACRONYM
,r.SYSTEM_ID
,r.TATTOO_PLUGIN_ASSET_ID
,r.TATTOO_PLUGIN_PRIMARY_FISMA_ID
,r.TENABLEUUID
--,r.UNIQUENESS
FROM BUS_CYBER_RISK_MANAGEMENT.CORE.RAW_TENABLE_VUL r
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
LEFT JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = r.DATACENTER_ID
LEFT JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = r.SYSTEM_ID
--WHERE r.INSERT_DATE::date = current_date();
;
create or replace view VW_RAW_TENABLE_VUL_ASSET_IDENTIFYING_FIELDS(
	ASSET_ID_TATTOO,
	DATACENTER_ID,
	DNSNAME,
	HOSTNAME,
	IP,
	MACADDRESS,
	NETBIOSNAME,
	REPOSITORY_ID,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	TEMP_DW_ASSET_ID,
	TEMP_ASSET_KEY,
	TEST_NUMBER,
	TEST_VARCHAR
) as
SELECT DISTINCT
ASSET_ID_TATTOO
,DATACENTER_ID
,DNSNAME
,HOSTNAME
,IP
,MACADDRESS
,NETBIOSNAME
,REPOSITORY_ID
,SYSTEM_ID
,TENABLEUUID
,TENANT_ID
,TEMP_DW_ASSET_ID
,TEMP_ASSET_KEY
,TEST_NUMBER
,TEST_VARCHAR
FROM CORE.RAW_TENABLE_VUL
where SNAPSHOT_ID IN (2822,2821)
;
create or replace view VW_RAW_TENABLE_VUL_ASSET_IDENTIFYING_FIELDS_CMR(
	ASSET_ID_TATTOO,
	DATACENTER_ID,
	DNSNAME,
	HOSTNAME,
	IP,
	MACADDRESS,
	NETBIOSNAME,
	REPOSITORY_ID,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	TEMP_DW_ASSET_ID,
	PLUGIN_ID,
	UNIQUENESS
) as
SELECT DISTINCT
ASSET_ID_TATTOO
,DATACENTER_ID
,DNSNAME
,HOSTNAME
,IP
,MACADDRESS
,NETBIOSNAME
,REPOSITORY_ID
,SYSTEM_ID
,TENABLEUUID
,TENANT_ID
,TEMP_DW_ASSET_ID
,PLUGIN_ID
,UNIQUENESS
--,TEMP_ASSET_KEY
FROM CORE.RAW_TENABLE_VUL
WHERE SNAPSHOT_ID = 2325
;
create or replace view VW_RAW_TENABLE_VUL_EXCEPTIONS(
	RAW_TENABLE_VUL_ID,
	ACCEPT_RISK_RULE_COMMENT,
	ACCEPTRISK,
	ACRSCORE,
	APPLICABILITYCODE,
	ASSET_ID_TATTOO,
	ASSETEXPOSURESCORE,
	AWS_ACCOUNTID,
	AWS_INSTANCE_ID,
	BASESCORE,
	BID,
	CHECKTYPE,
	COMPLIANCE_ACTUAL_VALUE,
	COMPLIANCE_CHECK_NAME,
	COMPLIANCE_ERROR,
	COMPLIANCE_RESULT,
	CPE,
	CREDENTIALED_SCAN,
	CUSTOM_SEVERITY,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	CVSSV3TEMPORALSCORE,
	CVSSV3VECTOR,
	CVSSVECTOR,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_DUP_NUMBER,
	DW_VUL_ID,
	EXPLOIT_AVAILABLE,
	EXPLOITEASE,
	EXPLOITFRAMEWORKS,
	FAMILY_ID,
	FAMILY_NAME,
	FAMILY_TYPE,
	FIRST_SEEN,
	FISMASEVERITY,
	HAS_BEEN_MITIGATED,
	HOSTNAME,
	HOSTUNIQUENESS,
	HOSTUUID,
	INSERT_DATE,
	IP,
	IPS,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	KEYDRIVERS,
	LAST_SEEN,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	NUMERIC_SEVERITY,
	OPERATING_SYSTEM,
	PATCHPUB_DATE,
	PLUGIN_ID,
	PLUGIN_INFO,
	PLUGIN_MOD_DATE,
	PLUGIN_NAME,
	PLUGIN_PUB_DATE,
	PLUGIN_TAGS,
	PLUGINTEXT,
	PORT,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	PROTOCOL,
	RECASTRISK,
	RECASTRISKRULECOMMENT,
	REPORTDATE,
	REPOSITORY_DATAFORMAT,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RISKFACTOR,
	ROWDISPOSITION,
	SCAN_POLICY_NAME,
	SCAN_POLICY_UID,
	SCAN_START_DATE,
	SEEALSO,
	SEVERITY_DESCRIPTION,
	SEVERITY_ID,
	SEVERITY_NAME,
	SNAPSHOT_ID,
	SOLUTION,
	SOURCE_TOOL,
	STATE,
	STIGSEVERITY,
	SYNOPSIS,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TEMP_DW_ASSET_ID,
	TEMPORAL_SCORE,
	TENABLEUUID,
	UNIQUENESS,
	VERSION,
	VPR_SCORE,
	VPRCONTEXT,
	VULN_PUB_DATE,
	XREF,
	DATACENTER_ACRONYM,
	DATACATEGORY,
	SNAPSHOT_DATE
) COMMENT='View to report RAW_TENABLE_VUL records that have DATA_ERROR_ARRAY or DATA_WARNING_ARRAY populated (Historical)\t'
 as
SELECT 
 v.RAW_TENABLE_VUL_ID 
,v.ACCEPT_RISK_RULE_COMMENT
,v.ACCEPTRISK
,v.ACRSCORE
,v.APPLICABILITYCODE
,v.ASSET_ID_TATTOO
,v.ASSETEXPOSURESCORE
,v.AWS_ACCOUNTID
,v.AWS_INSTANCE_ID
,v.BASESCORE 
,v.BID
,v.CHECKTYPE
,v.COMPLIANCE_ACTUAL_VALUE
,v.COMPLIANCE_CHECK_NAME
,v.COMPLIANCE_ERROR
,v.COMPLIANCE_RESULT
,v.CPE
,v.CREDENTIALED_SCAN
,v.CUSTOM_SEVERITY
,v.CVE 
,v.CVSSV2BASESCORE 
,v.CVSSV3BASESCORE 
,v.CVSSV3TEMPORALSCORE
,v.CVSSV3VECTOR
,v.CVSSVECTOR
,v.DATA_ERROR_ARRAY 
,v.DATA_WARNING_ARRAY 
,v.DATACENTER_ID
,v.DATECOMPLETED 
,v.DESCRIPTION
,v.DNSNAME
,v.DW_ASSET_ID 
,v.DW_DUP_NUMBER 
,v.DW_VUL_ID 
,v.EXPLOIT_AVAILABLE
,v.EXPLOITEASE
,v.EXPLOITFRAMEWORKS
,v.FAMILY_ID
,v.FAMILY_NAME
,v.FAMILY_TYPE
,v.FIRST_SEEN 
,v.FISMASEVERITY
,v.HAS_BEEN_MITIGATED 
,v.HOSTNAME
,v.HOSTUNIQUENESS
,v.HOSTUUID
,v.INSERT_DATE 
,v.IP
,v.IPS
,v.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC 
,v.KEYDRIVERS
,v.LAST_SEEN 
,v.MACADDRESS
,v.MITIGATIONSTATUS
,v.NETBIOSNAME
,v.NUMERIC_SEVERITY 
,v.OPERATING_SYSTEM
,v.PATCHPUB_DATE 
,v.PLUGIN_ID
,v.PLUGIN_INFO
,v.PLUGIN_MOD_DATE 
,v.PLUGIN_NAME
,v.PLUGIN_PUB_DATE 
,v.PLUGIN_TAGS
,v.PLUGINTEXT
,v.PORT
,v.PRIMARY_FISMA_ID_DERIVED
,v.PRIMARY_FISMA_ID_TATTOO
,v.PROTOCOL
,v.RECASTRISK
,v.RECASTRISKRULECOMMENT
,v.REPORTDATE 
,v.REPOSITORY_DATAFORMAT
,v.REPOSITORY_DESCRIPTION
,v.REPOSITORY_ID
,v.REPOSITORY_NAME
,v.RISKFACTOR
,v.ROWDISPOSITION
,v.SCAN_POLICY_NAME
,v.SCAN_POLICY_UID
,v.SCAN_START_DATE 
,v.SEEALSO
,v.SEVERITY_DESCRIPTION
,v.SEVERITY_ID
,v.SEVERITY_NAME
,v.SNAPSHOT_ID 
,v.SOLUTION
,v.SOURCE_TOOL
,v.STATE
,v.STIGSEVERITY
,v.SYNOPSIS
,s.ACRONYM SYSTEM_ACRONYM -- 231023
,v.SYSTEM_ID
,v.TEMP_DW_ASSET_ID 
,v.TEMPORAL_SCORE
,v.TENABLEUUID
,v.UNIQUENESS
,v.VERSION
,v.VPR_SCORE
,v.VPRCONTEXT
,v.VULN_PUB_DATE 
,v.XREF
,dc.ACRONYM DATACENTER_ACRONYM
,snap.datacategory
,snap.snapshot_date
FROM CORE.RAW_TENABLE_VUL v
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id=v.snapshot_id
LEFT JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID=v.DATACENTER_ID
LEFT JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID=v.SYSTEM_ID -- 231023
where (array_size(v.DATA_ERROR_ARRAY) !=0 or array_size(v.DATA_WARNING_ARRAY) !=0);
create or replace view VW_RAW_TENABLE_VUL_LIMITED(
	RAW_TENABLE_VUL_ID,
	DATACATEGORY,
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ACCEPT_RISK_RULE_COMMENT,
	ACCEPTRISK,
	ACRSCORE,
	APPLICABILITYCODE,
	ASSET_ID_TATTOO,
	ASSETEXPOSURESCORE,
	AWS_ACCOUNTID,
	AWS_INSTANCE_ID,
	BASESCORE,
	BID,
	CHECKTYPE,
	COMPLIANCE_ACTUAL_VALUE,
	COMPLIANCE_CHECK_NAME,
	COMPLIANCE_ERROR,
	COMPLIANCE_RESULT,
	CPE,
	CREDENTIALED_SCAN,
	CUSTOM_SEVERITY,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	CVSSV3TEMPORALSCORE,
	CVSSV3VECTOR,
	CVSSVECTOR,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	DATACENTER_ID,
	DATECOMPLETED,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_DUP_NUMBER,
	DW_VUL_ID,
	EXPLOIT_AVAILABLE,
	EXPLOITEASE,
	EXPLOITFRAMEWORKS,
	FAMILY_ID,
	FAMILY_NAME,
	FAMILY_TYPE,
	FIRST_SEEN,
	FISMASEVERITY,
	HAS_BEEN_MITIGATED,
	HOSTNAME,
	HOSTUNIQUENESS,
	HOSTUUID,
	INSERT_DATE,
	IP,
	IPS,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
	KEYDRIVERS,
	LAST_SEEN,
	MACADDRESS,
	MITIGATIONSTATUS,
	NESSUS_VERSION,
	NETBIOSNAME,
	NUMERIC_SEVERITY,
	OPERATING_SYSTEM,
	PATCHPUB_DATE,
	PLUGIN_ID,
	PLUGIN_INFO,
	PLUGIN_MOD_DATE,
	PLUGIN_NAME,
	PLUGIN_PUB_DATE,
	PLUGIN_TAGS,
	PORT,
	PRIMARY_FISMA_ID_DERIVED,
	PRIMARY_FISMA_ID_TATTOO,
	PROTOCOL,
	RECASTRISK,
	RECASTRISKRULECOMMENT,
	REPORTDATE,
	REPOSITORY_DATAFORMAT,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RISKFACTOR,
	ROWDISPOSITION,
	SCAN_POLICY_NAME,
	SCAN_POLICY_UID,
	SCAN_START_DATE,
	SEEALSO,
	SEVERITY_DESCRIPTION,
	SEVERITY_ID,
	SEVERITY_NAME,
	SOLUTION,
	SOURCE_TOOL,
	STATE,
	STIGSEVERITY,
	SYNOPSIS,
	SYSTEM_ID,
	TATTOO_PLUGIN_ASSET_ID,
	TATTOO_PLUGIN_PRIMARY_FISMA_ID,
	TEMP_DW_ASSET_ID,
	TEMPORAL_SCORE,
	TENABLEUUID,
	UNIQUENESS,
	VERSION,
	VPR_SCORE,
	VPRCONTEXT,
	VULN_PUB_DATE,
	XREF
) COMMENT='Diagnostic View to report RAW_TENABLE_VUL but with limited columns. Exlcude cols that cause wrap-around in Excel'
 as
SELECT
r.RAW_TENABLE_VUL_ID
,snap.DATACATEGORY
,snap.SNAPSHOT_DATE::date as SNAPSHOT_DATE
,r.SNAPSHOT_ID
,dc.ACRONYM DATACENTER_ACRONYM
,s.ACRONYM SYSTEM_ACRONYM
,r.ACCEPT_RISK_RULE_COMMENT
,r.ACCEPTRISK
,r.ACRSCORE
,r.APPLICABILITYCODE
,r.ASSET_ID_TATTOO
,r.ASSETEXPOSURESCORE
,r.AWS_ACCOUNTID
,r.AWS_INSTANCE_ID
,r.BASESCORE
,r.BID
,r.CHECKTYPE
,r.COMPLIANCE_ACTUAL_VALUE
,r.COMPLIANCE_CHECK_NAME
,r.COMPLIANCE_ERROR
,r.COMPLIANCE_RESULT
,r.CPE
,r.CREDENTIALED_SCAN
,r.CUSTOM_SEVERITY
,r.CVE
,r.CVSSV2BASESCORE
,r.CVSSV3BASESCORE
,r.CVSSV3TEMPORALSCORE
,r.CVSSV3VECTOR
,r.CVSSVECTOR
,r.DATA_ERROR_ARRAY
,r.DATA_WARNING_ARRAY
,r.DATACENTER_ID
,r.DATECOMPLETED
,r.DESCRIPTION
,r.DNSNAME
,r.DW_ASSET_ID
,r.DW_DUP_NUMBER
,r.DW_VUL_ID
,r.EXPLOIT_AVAILABLE
,r.EXPLOITEASE
,r.EXPLOITFRAMEWORKS
,r.FAMILY_ID
,r.FAMILY_NAME
,r.FAMILY_TYPE
,r.FIRST_SEEN
,r.FISMASEVERITY
,r.HAS_BEEN_MITIGATED
,r.HOSTNAME
,r.HOSTUNIQUENESS
,r.HOSTUUID
,r.INSERT_DATE::date as INSERT_DATE
,r.IP
,r.IPS
,r.IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,r.KEYDRIVERS
,r.LAST_SEEN
,r.MACADDRESS
,r.MITIGATIONSTATUS
,r.NESSUS_VERSION
,r.NETBIOSNAME
,r.NUMERIC_SEVERITY
,r.OPERATING_SYSTEM
,r.PATCHPUB_DATE
,r.PLUGIN_ID
,r.PLUGIN_INFO
,r.PLUGIN_MOD_DATE
,r.PLUGIN_NAME
,r.PLUGIN_PUB_DATE
,r.PLUGIN_TAGS
--,r.PLUGINTEXT -- causes wrap-around in excel
,r.PORT
,r.PRIMARY_FISMA_ID_DERIVED
,r.PRIMARY_FISMA_ID_TATTOO
,r.PROTOCOL
,r.RECASTRISK
,r.RECASTRISKRULECOMMENT
,r.REPORTDATE
,r.REPOSITORY_DATAFORMAT
,r.REPOSITORY_DESCRIPTION
,r.REPOSITORY_ID
,r.REPOSITORY_NAME
,r.RISKFACTOR
,r.ROWDISPOSITION
,r.SCAN_POLICY_NAME
,r.SCAN_POLICY_UID
,r.SCAN_START_DATE
,r.SEEALSO
,r.SEVERITY_DESCRIPTION
,r.SEVERITY_ID
,r.SEVERITY_NAME
,r.SOLUTION
,r.SOURCE_TOOL
,r.STATE
,r.STIGSEVERITY
,r.SYNOPSIS
,r.SYSTEM_ID
,r.TATTOO_PLUGIN_ASSET_ID
,r.TATTOO_PLUGIN_PRIMARY_FISMA_ID
,r.TEMP_DW_ASSET_ID
,r.TEMPORAL_SCORE
,r.TENABLEUUID
,r.UNIQUENESS
,r.VERSION
,r.VPR_SCORE
,r.VPRCONTEXT
,r.VULN_PUB_DATE
,r.XREF
FROM BUS_CYBER_RISK_MANAGEMENT.CORE.RAW_TENABLE_VUL r
JOIN CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
LEFT JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = r.DATACENTER_ID
LEFT JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = r.SYSTEM_ID;
create or replace view VW_RAW_TENABLE_VUL_POPULATED_FIELDS(
	ASSET_ID_TATTOO,
	DATACENTER_ID,
	DNSNAME,
	HOSTNAME,
	IP,
	MACADDRESS,
	NETBIOSNAME,
	REPOSITORY_ID,
	SYSTEM_ID,
	TENABLEUUID,
	TOTAL
) as
SELECT DISTINCT
case coalesce(NULLIF(ASSET_ID_TATTOO,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as ASSET_ID_TATTOO
,case coalesce(NULLIF(DATACENTER_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as DATACENTER_ID
--,case coalesce(NULLIF(DW_ASSET_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as DW_ASSET_ID

,case coalesce(NULLIF(DNSNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as DNSNAME
,case coalesce(NULLIF(HOSTNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as HOSTNAME
,case coalesce(NULLIF(IP,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as IP
,case coalesce(NULLIF(MACADDRESS,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as MACADDRESS

,case coalesce(NULLIF(NETBIOSNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as NETBIOSNAME
,case coalesce(NULLIF(REPOSITORY_ID::varchar,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as REPOSITORY_ID
,case coalesce(NULLIF(SYSTEM_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as SYSTEM_ID
,case coalesce(NULLIF(TENABLEUUID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as TENABLEUUID
--,case coalesce(NULLIF(TENANT_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End as TENANT_ID
,COUNT(1) Total
FROM CORE.RAW_TENABLE_VUL
WHERE SNAPSHOT_ID = 2263
--2264	AWS VUL MITIGATED
--2263

GROUP BY 
case coalesce(NULLIF(ASSET_ID_TATTOO,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(DATACENTER_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(DNSNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(HOSTNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(IP,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(MACADDRESS,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(NETBIOSNAME,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(REPOSITORY_ID::varchar,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(SYSTEM_ID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
,case coalesce(NULLIF(TENABLEUUID,''),'ITSNULL') when 'ITSNULL' then 'ITSNULL' Else 'Populated' End
;
create or replace view VW_REPORT_IDS(
	REPORT_ID,
	IS_VIABLE,
	IS_ENDOFMONTH,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	ASSETS_AWS_GOVCLOUD,
	ASSETS_PCT_AWS,
	ASSETS_CREATED_TODAY,
	ASSETS_DELETED_TODAY,
	ASSETS_FORESCOUT_MANAGED,
	ASSETS_NEVER_SCANNED,
	ASSETS_NOT_SCANNED_LAST3DAYS,
	ASSETS_SCANNABLE,
	ASSETS_TENABLE_CREDENTIALED_SCAN,
	ASSETS_UNKNOWN_DEVICETYPE,
	DUPLICATE_DATACENTER_TATTOO_PAIR,
	ENDPOINTS,
	PCT_TENABLE_CREDENTIALED_SCAN,
	PLUGINS_CREATED_TODAY,
	PLUGINS_CRITICAL,
	PLUGINS_DELETED_TODAY,
	PLUGINS_FIXED_TODAY,
	PLUGINS_HIGH,
	PLUGINS_INACTIVE_ASSET_TODAY,
	PLUGINS_LOW,
	PLUGINS_MEDIUM,
	PLUGINS_OPEN,
	PLUGINS_REOPENED,
	SYSTEMS_DEVELOP,
	SYSTEMS_INITIATE,
	SYSTEMS_OPERATE,
	SYSTEMS_RETIRE,
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID,
	VUL_AWS,
	VUL_PCT_AWS,
	VUL_CRITICAL,
	VUL_DELETED_TODAY,
	VUL_FIXED_TODAY,
	VUL_GOVCLOUD,
	VUL_HIGH,
	VUL_INACTIVE_ASSET_TODAY,
	VUL_LOW,
	VUL_MEDIUM,
	VUL_OPEN,
	VUL_REOPENED,
	COMMENTS
) COMMENT='Enterprise level view of basic daily totals (Systems,Assets,Vulnerbilities, etc.)\t'
 as
select
REPORT_ID
,IS_VIABLE -- 240416 CR873
,IS_ENDOFMONTH
,substring(REPORT_DATE::varchar,1,10) as REPORT_DATE
,ASSETS
,ASSETS_AWS -- 240103
,ASSETS_AWS_GOVCLOUD -- 240103
,((ASSETS_AWS + ASSETS_AWS_GOVCLOUD) / ASSETS) * 100.0 as ASSETS_PCT_AWS -- 240103
,ASSETS_CREATED_TODAY -- 231207
,ASSETS_DELETED_TODAY -- 231207
,ASSETS_FORESCOUT_MANAGED -- 241011
,ASSETS_NEVER_SCANNED
,ASSETS_NOT_SCANNED_LAST3DAYS
,ASSETS_SCANNABLE -- 241011
,ASSETS_TENABLE_CREDENTIALED_SCAN -- 241011
,ASSETS_UNKNOWN_DEVICETYPE
,DUPLICATE_DATACENTER_TATTOO_PAIR
,ENDPOINTS -- 241216
,DIV0(ASSETS_TENABLE_CREDENTIALED_SCAN,ASSETS_SCANNABLE) * 100.0 as PCT_TENABLE_CREDENTIALED_SCAN -- 241011
,PLUGINS_CREATED_TODAY -- 240118
,PLUGINS_CRITICAL -- 240118
,PLUGINS_DELETED_TODAY -- 240118
,PLUGINS_FIXED_TODAY -- 240118
,PLUGINS_HIGH -- 240118
,PLUGINS_INACTIVE_ASSET_TODAY -- 240118
,PLUGINS_LOW -- 240118
,PLUGINS_MEDIUM -- 240118
,PLUGINS_OPEN -- 240118
,PLUGINS_REOPENED -- 240118
,SYSTEMS_DEVELOP
,SYSTEMS_INITIATE
,SYSTEMS_OPERATE
,SYSTEMS_RETIRE
,TEMP_HWAM_UNASSIGNED_DW_ASSET_ID
,VUL_AWS -- 240103
,(VUL_AWS + VUL_GOVCLOUD) / (VUL_CRITICAL + VUL_HIGH + VUL_MEDIUM + VUL_LOW) * 100.0 as VUL_PCT_AWS -- 240103
,VUL_CRITICAL
,VUL_DELETED_TODAY
,VUL_FIXED_TODAY
,VUL_GOVCLOUD -- 240103
,VUL_HIGH
,VUL_INACTIVE_ASSET_TODAY
,VUL_LOW
,VUL_MEDIUM
,VUL_OPEN
,VUL_REOPENED
,COMMENTS
FROM CORE.REPORT_IDS
order by REPORT_ID DESC;
create or replace view VW_ROWCOUNT_FOR_VIEWS(
	THECOMMAND
) COMMENT='View is used to obtain row counts for all the views found in the production schemas\t'
 as
SELECT 
'SELECT ' || char(39) || OBJECTNAME || char(39) || ' as ObjectName, count(1) as TotalRows'  || ' FROM ' || DBSCHEMA || '.' || char(34) || OBJECTNAME || char(34) || ' UNION ALL' as TheCommand
FROM DBA.VW_LIST_CRM_OBJECTS WHERE OBJECTTYPE = 'View' AND DBSCHEMA IN ('CEDE','CORE','DBA','RPT')
ORDER BY DBSCHEMA, OBJECTNAME;
create or replace view VW_SNAPSHOT_IDS(
	SNAPSHOT_ID,
	REPORT_ID,
	SNAPSHOT_DATE,
	PARENT_DATACATEGORY,
	DATACATEGORY,
	IS_FROM_AWS_FEED,
	RECORD_COUNT,
	RECORDS_WITH_ERRORS,
	RECORDS_WITH_WARNINGS,
	ERROR_COUNT,
	WARNING_COUNT,
	UNASSIGNED_DW_ASSET_ID,
	MAX_DATE,
	MIN_DATE,
	COMMENTS
) COMMENT='Visibility of ingested record counts, errors, warnings for each data category [AWS HWAM/AWS VUL/AXONIUS/CCIC VUL] (Historical)\t'
 as
SELECT 
SNAPSHOT_ID
,REPORT_ID
,SNAPSHOT_DATE::date as SNAPSHOT_DATE
,PARENT_DATACATEGORY
,DATACATEGORY
,IS_FROM_AWS_FEED
,RECORD_COUNT
,RECORDS_WITH_ERRORS
,RECORDS_WITH_WARNINGS
,ERROR_COUNT
,WARNING_COUNT
,UNASSIGNED_DW_ASSET_ID
,substring(MAX_DATE::varchar,1,16) as MAX_DATE
,substring(MIN_DATE::varchar,1,16) as MIN_DATE
,COMMENTS
FROM CORE.SNAPSHOT_IDS ORDER BY SNAPSHOT_ID DESC;
create or replace view VW_SYSTEMSHIST(
	ACRONYM,
	ACTUAL_DECOMMISION_DATE,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIRECTOR_COMMENT,
	DIRECTOR_COMMENT2,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	IS_CCSQ,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	OPERATED_BY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	REPORT_DATE,
	REPORT_ID,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_CREATION_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='Return all systems for all report_id to show history of system changes if any.'
 as
SELECT 
--
-- 250103 CR1060 Re-baseline view with SYSTEMSHIST table
-- Also note, prior to 250103 this was only reporting the current date and not history
--
sh.ACRONYM
,sh.ACTUAL_DECOMMISION_DATE
,sh.ARCHER_TRACKING_ID
,sh.ATO_EXPIRATION_DATE
,sh.ATO_REVIEW_DATE
,sh.AUTH_COMMENTS
,sh.AUTH_DECISION
,sh.AUTHORIZATION_MEMO_SIGNED_DATE
,sh.AUTHORIZATION_PACKAGE
,sh.BO_RECOMMENDATION_REVIEW_DATE
,sh.BO_REVIEW_DATE
,sh.BUSINESS_OWNER
,sh.CIO
,sh.CISO
,sh.CISO_REVIEW_DATE
,sh.CLOUD_SERVICE_PROVIDER
,sh.COMPONENT_ACRONYM
,sh.COMPONENT_DESCRIPTION
,sh.COMPONENT_NAME
,sh.COMPONENT_RISK_REPORTS_OVERSIGHT
,sh.CONTINGENCYEXPIRATIONDATE
,sh.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,sh.CP_TEST_DATE
,sh.CP_TEST_RESULTS
,sh.CRA
,sh.CRA_REVIEW_DATE
,sh.CYBERVET
,sh.DATE_AUTH_MEMO_EXPIRES
,sh.DATE_AUTH_MEMO_SIGNED
,sh.DATEDELETED
,sh.DATEMODIFIED
,sh.DCISO
,sh.DIRECTOR_COMMENT
,sh.DIRECTOR_COMMENT2
,sh.DIVISION_ACRONYM
,sh.DIVISION_DESCRIPTION
,sh.DIVISION_NAME
,sh.DSPC_REVIEW_DATE
,sh.DSPPO_REVIEW_DATE
,sh.E_AUTH_EXP_DATE
,sh.E_AUTH_LEVEL
,sh.E_AUTH_RISK_ASSESSMENT_DATE
,sh.FINANCIAL_SYSTEM
,sh.FIPS_199_AVAILABILITY_RATING
,sh.FIPS_199_CONFIDENTIALITY_RATING
,sh.FIPS_199_INTEGRITY_RATING
,sh.FIPS_199_OVERALL_IMPACT_RATING
,sh.FIRST_PUBLISHED_DATE
,sh.FISMA_SYSTEM
,sh.GROUP_ACRONYM
,sh.GROUP_DESCRIPTION
,sh.GROUP_NAME
,sh.HVA_SCORE
,sh.HVASTATUS
,sh.IN_CMS_CLOUD
,sh.INFORMATION_SYSTEM_TYPE
,sh.IS_CCSQ
,sh.IS_DATACENTER
,sh.IS_EXCLUDEFROMREPORTING
,sh.IS_HIGHRISKSYSTEM
,sh.IS_MARKETPLACE
,sh.IS_OA_READY
,sh.IS_OPERATIONALSYSTEM
,sh.IS_PHANTOMSYSTEM
,sh.IS_SECURITYHUB_ENABLED
,sh.ISRA_REVIEW_DATE
,sh.ISRA_STATUS
,sh.ISSO
,sh.ISSO_COUNT
,sh.ISSO_REVIEW_DATE
,sh.ISSO_SUBMISSION_DATE
,sh.ISSOCS
,sh.LAST_ACT_DATE
,sh.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,sh.LAST_ACT_SCA_FINAL_REPORT_DATE
,sh.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,sh.LAST_PENTEST_DATE
,sh.MEF
,sh.MEF_CONTEXT
,sh.MEFSTATUS
,sh.NEXT_REQUIRED_CP_TEST_DATE
,sh.OA_STATUS
,sh.OATO_CATEGORY
,sh.OPERATED_BY
,sh.PACKAGE_TYPE
,sh.PIA_014
,sh.PIA_EXPIRATION_DATE
,sh.PII_PHI
,sh.PRIMARY_ISSO
,sh.PRIMARY_OPERATING_LOCATION
,sh.PRIMARY_OPERATING_LOCATION_ID
,sh.REASON_FOR_ATO_REQUEST
,r.REPORT_DATE
,sh.REPORT_ID
,sh.SCA
,sh.SCA_DATE
,sh.SDM
,sh.SOP_REVIEW_DATE
,sh.STE_DATE
,sh.SYSTEM_CREATION_DATE
,sh.SYSTEM_DESCRIPTION
,sh.SYSTEM_ID
,sh.TLC_PHASE
,sh.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.REPORT_IDS r
JOIN CORE.SYSTEMSHIST sh on sh.REPORT_ID = r.REPORT_ID
WHERE r.IS_VIABLE = 1
;
create or replace view VW_SYSTEMS_REPORTED(
	ACRONYM,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COLORCODE,
	LEGENDVALUE,
	PRIORITY,
	STATUS,
	LEGENDCOMMENT,
	IS_IN_REF_LOOKUPS_CAMP,
	LASTSEEN_HWAM,
	LASTSEEN_VUL,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	SYSTEM_ID,
	TLC_PHASE,
	ASSETS,
	SCANNABLEASSETS,
	ASSETSSCANNED,
	SCANNABLE_BUT_NOT_SCANNED,
	ASSETS_NEVER_SCANNED,
	IS_DRAAS_SYSTEM,
	IS_SECOPS_TAGGED,
	CCSQ_REPOSITORY_ID_ARRAY,
	VULMASTER_REPOSITORY_ID_ARRAY,
	TERESA_WORKSHEET,
	TERESA_COMMENT,
	ELLIOT_COMMENT
) COMMENT='Diagnostic; View reports FISMA systems reporting or not reporting HWAM/VUL\t'
 as
SELECT
s.ACRONYM
,c.COMMONNAME
,s.COMPONENT_ACRONYM
,sc.colorcode
,sc.legendvalue
,sc.priority
,sc.status
,sc.legendcomment
,case coalesce(ref.VERIFIED_FISMA,'ITSNULL')
    when 'ITSNULL' then 'No'
    Else 'Yes'
end as IS_IN_REF_LOOKUPS_CAMP

,recent.LASTSEEN_HWAM
,recent.LASTSEEN_VUL

,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID

,s.SYSTEM_ID
,s.TLC_PHASE

,coalesce(a.ASSETS,0) as ASSETS

,coalesce(sa.ScannableAssets,0) as ScannableAssets -- 240426
,coalesce(va.AssetsScanned,0) as AssetsScanned -- 240426
,(coalesce(sa.ScannableAssets,0) - coalesce(va.AssetsScanned,0)) as Scannable_but_not_Scanned -- 240426

,coalesce(neverScanned.Assets_Never_Scanned,0) Assets_Never_Scanned
--240426
,case coalesce(draas.system_id,'ITSNULL')
    when 'ITSNULL' then 'No'
    Else 'Yes'
end as IS_DRAAS_SYSTEM

--240430
,case coalesce(secops.fisma_uuid,'ITSNULL')
    when 'ITSNULL' then 'No'
    Else 'Yes'
end as IS_SECOPS_TAGGED

,ccsq_repos.REPOSITORY_ID_ARRAY as CCSQ_REPOSITORY_ID_ARRAY -- 240426
,vul_repos.REPOSITORY_ID_ARRAY as VULMASTER_REPOSITORY_ID_ARRAY -- 240426
,coalesce(sc.teresa_worksheet_240426,sc.teresa_worksheet_240212) as TERESA_WORKSHEET
,coalesce(sc.teresa_comment_240426,sc.teresa_comment_240212) as TERESA_COMMENT
,sc.ELLIOT_COMMENT_240212 as ELLIOT_COMMENT
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN DBA.SYSTEM_COMMENTS sc on sc.SYSTEM_ID = s.SYSTEM_ID

LEFT OUTER JOIN (SELECT DISTINCT VERIFIED_FISMA FROM CORE.VW_AWS_CAMPDB_LOOKUP) ref on ref.VERIFIED_FISMA = s.SYSTEM_ID -- 240603

LEFT OUTER JOIN (select SYSTEM_ID,count(1) Assets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID

LEFT OUTER JOIN (select SYSTEM_ID,count(1) Assets_Never_Scanned FROM CORE.ASSET where Is_Applicable = 1 and LASTSEEN_VUL IS NULL group by SYSTEM_ID) neverScanned on neverScanned.SYSTEM_ID = s.SYSTEM_ID

LEFT OUTER JOIN (select SYSTEM_ID,MAX(LASTSEEN_HWAM)::date as LASTSEEN_HWAM, MAX(LASTSEEN_VUL)::date as LASTSEEN_VUL FROM CORE.ASSET group by SYSTEM_ID) recent on recent.SYSTEM_ID = s.SYSTEM_ID

-- 240426
left outer join (select system_id,count(1) ScannableAssets from core.vw_assets where is_scannable = 1 group by system_id) sa on sa.system_id = s.system_id
-- 240426
left outer join (select a.system_id,count(1) AssetsScanned
    from core.vw_assets a
    join (select distinct dw_asset_id from core.vw_vulmaster) vm on vm.dw_asset_id = a.dw_asset_id group by a.system_id) va on va.system_id = s.system_id

-- 240426
left outer join (select CFACTS_UID, listagg(DISTINCT REPOSITORY_ID, ', ') WITHIN GROUP (ORDER BY REPOSITORY_ID ASC) as REPOSITORY_ID_ARRAY FROM REF_LOOKUPS.SHARED.SEC_MV_CCSQ_FISMA_LOOKUP GROUP BY CFACTS_UID) ccsq_repos on ccsq_repos.CFACTS_UID = s.system_id
-- 240426
LEFT OUTER JOIN (select distinct system_id from core.vw_assets where datacenter_id = '441a2d4fdbfbab00560cf9531f961911') as draas on draas.system_id = s.system_id -- DRaaS-CACHE
-- 240426
left outer join (select SYSTEM_ID, listagg(DISTINCT REPOSITORY_ID, ', ') WITHIN GROUP (ORDER BY REPOSITORY_ID::number ASC) as REPOSITORY_ID_ARRAY 
    FROM core.VW_VULMASTER GROUP BY SYSTEM_ID) vul_Repos on vul_Repos.system_id = s.system_id

-- 240430
LEFT OUTER JOIN (select distinct fisma_uuid from core.raw_hwam where fisma_uuid is not null) secops on secops.fisma_uuid = s.system_id
    
WHERE s.IS_PHANTOMSYSTEM = 0 and (upper(s.TLC_PHASE) <> 'RETIRE' or coalesce(a.ASSETS,0) > 0)
ORDER BY s.ACRONYM;
create or replace view VW_TABLE_DDL(
	STMT
) COMMENT='View generates list of GET_DDL statements for each CORE table. Subsequent select statements must be executed\t'
 as
SELECT 'SELECT GET_DDL(''TABLE'',''' || table_schema || '.' || table_name || ''') as STMT UNION ALL' AS stmt
FROM INFORMATION_SCHEMA.TABLES WHERE table_schema = 'CORE' AND TABLE_TYPE = 'BASE TABLE' order by table_name;
create or replace view VW_TASK_HISTORY(
	NAME,
	DATABASE_NAME,
	SCHEMA_NAME,
	QUERY_TEXT,
	STATE,
	QUERY_START_TIME,
	COMPLETED_TIME,
	ELAPSED_MILLISECONDS,
	NEXT_SCHEDULED_TIME,
	ERROR_CODE,
	ERROR_MESSAGE,
	CONDITION_TEXT,
	SCHEDULED_TIME,
	QUERY_ID,
	ROOT_TASK_ID,
	GRAPH_VERSION,
	RUN_ID,
	RETURN_VALUE,
	SCHEDULED_FROM
) COMMENT='Diagnostic View to list execution of background/scheduled tasks (7 days only)\t'
 as
select 
	NAME,
	DATABASE_NAME,
	SCHEMA_NAME,
	QUERY_TEXT,
	STATE,
    QUERY_START_TIME,
    COMPLETED_TIME,
    datediff(millisecond,QUERY_START_TIME,COMPLETED_TIME),
    NEXT_SCHEDULED_TIME,
	ERROR_CODE,
	ERROR_MESSAGE,
    CONDITION_TEXT,
	SCHEDULED_TIME,
	QUERY_ID,
	ROOT_TASK_ID,
	GRAPH_VERSION,
	RUN_ID,
	RETURN_VALUE,
	SCHEDULED_FROM
from table(information_schema.task_history());
create or replace view VW_TEMP_ASSET_METADATA(
	DATACATEGORY,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	DATA_ERROR_ARRAY,
	DATA_WARNING_ARRAY,
	PLUGINTEXT_EC2_INSTANCE_LINUX,
	PLUGINTEXT_EC2_INSTANCE_WINDOWS,
	PLUGINTEXT_ONPREM_TAG_LINUX,
	PLUGINTEXT_ONPREM_TAG_WINDOWS,
	SYSTEM_ID,
	ACRONYM,
	TEMP_DW_ASSET_ID
) COMMENT='Diagnostic View that shows all fields in TEMP_ASSET_METADATA table\t'
 as
select distinct
snap.datacategory
,tam.ASSET_ID_TATTOO
,tam.AWS_ACCOUNTID
,tam.DATA_ERROR_ARRAY
,tam.DATA_WARNING_ARRAY
--,tam.IS_FORESCOUT_MANAGED
--,tam.IS_TENABLE_CREDENTIALED_SCAN
--,tam.NESSUS_VERSION
,tam.PLUGINTEXT_EC2_INSTANCE_LINUX
,tam.PLUGINTEXT_EC2_INSTANCE_WINDOWS
,tam.PLUGINTEXT_ONPREM_TAG_LINUX
,tam.PLUGINTEXT_ONPREM_TAG_WINDOWS
--,tam.PLUGINTEXT_NESSUS_SCAN_INFO
--,tam.SCAN_POLICY_NAME
--,tam.SCAN_POLICY_UID
--,tam.SCAN_START_DATE
--,tam.SNAPSHOT_ID
,tam.SYSTEM_ID
,s.ACRONYM
,tam.TEMP_DW_ASSET_ID
from CORE.TEMP_ASSET_METADATA tam
left outer join CORE.SYSTEMS s on s.system_id = tam.system_id
join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = tam.snapshot_id
--WHERE snap.DATACATEGORY = 'CCIC VUL' and tam.SYSTEM_ID IS NULL
;
create or replace view VW_TEMP_HWAM_ASSET_IDENTIFYING_FIELDS(
	TEMP_HWAM_ID,
	DATACATEGORY,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	TEMP_DW_ASSET_ID,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	NORMALIZED_FQDN,
	NORMALIZED_HOSTNAME,
	NORMALIZED_NETBIOSNAME,
	MOTHERBOARD,
	IPV4,
	NORMALIZED_MACADDRESS,
	MATCHMETHOD,
	LAST_CONFIRMED_TIME,
	SNAPSHOT_ID,
	SOURCE_TOOL,
	TENABLEUUID,
	TENANT_ID,
	DATACENTER_ID,
	SYSTEM_ID
) COMMENT='Diagnostic View that shows all fields in TEMP_HWAM table that could potentially identify an asset/device (Current day only)\t'
 as
SELECT
th.TEMP_HWAM_ID
,snap.DATACATEGORY
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,th.TEMP_DW_ASSET_ID
,th.DW_ASSET_ID
,th.ASSET_ID_TATTOO
,th.NORMALIZED_FQDN
,ARRAY_TO_STRING(th.NORMALIZED_HOSTNAME,',') as NORMALIZED_HOSTNAME
,th.NORMALIZED_NETBIOSNAME
,th.MOTHERBOARD
,ARRAY_TO_STRING(th.IPV4,',') as IPV4
,ARRAY_TO_STRING(th.NORMALIZED_MACADDRESS,',') as NORMALIZED_MACADDRESS
,th.MATCHMETHOD
,th.LAST_CONFIRMED_TIME
,th.SNAPSHOT_ID
,th.SOURCE_TOOL
,th.TENABLEUUID
,th.TENANT_ID
,th.DATACENTER_ID
,th.SYSTEM_ID
FROM CORE.TEMP_HWAM th
join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = th.snapshot_id
LEFT OUTER JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = th.datacenter_id
LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = th.SYSTEM_ID
order by th.TEMP_HWAM_ID
;
create or replace view VW_TEMP_HWAM_MATCHING_RESULTS(
	DATACATEGORY,
	MATCHMETHOD,
	MATCHORDER,
	TOTAL
) as
select snap.datacategory,MATCHMETHOD,MATCHORDER,count(1) Total
from CORE.TEMP_HWAM th
join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = th.snapshot_id
group by snap.datacategory,MATCHMETHOD,MATCHORDER
order by snap.datacategory,MATCHORDER;
;
create or replace view VW_TEMP_HWAM_POPULATED_FIELDS(
	DATACATEGORY,
	CMR_DW_ASSET_ID,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	NORMALIZED_FQDN,
	NORMALIZED_HOSTNAME,
	IPV4,
	NORMALIZED_MACADDRESS,
	MOTHERBOARD,
	NORMALIZED_NETBIOSNAME,
	SYSTEM_ACRONYM
) COMMENT='Diagnostic View that shows all fields in TEMP_HWAM table that are populated\t'
 as
SELECT
snap.datacategory
,case coalesce(cmr_dw_asset_id::varchar,'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as CMR_DW_ASSET_ID,
case coalesce(dw_asset_id::varchar,'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as DW_ASSET_ID
,case coalesce(NULLIF(th.ASSET_ID_TATTOO,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as ASSET_ID_TATTOO
--,case coalesce(NULLIF(dc.ACRONYM,''),'ITSNULL')
--    when 'ITSNULL' then 'ITSNULL'
--    Else 'Populated'
--End as DATACENTER_ACRONYM
,case coalesce(NULLIF(th.NORMALIZED_FQDN,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as NORMALIZED_FQDN
,case array_size(th.NORMALIZED_HOSTNAME) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End as NORMALIZED_HOSTNAME
,case array_size(th.IPV4) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End as IPV4
,case array_size(th.NORMALIZED_MACADDRESS) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End as NORMALIZED_MACADDRESS
,case coalesce(NULLIF(th.MOTHERBOARD,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as MOTHERBOARD
,case coalesce(NULLIF(th.NORMALIZED_NETBIOSNAME,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as NORMALIZED_NETBIOSNAME
,case coalesce(NULLIF(s.ACRONYM,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End as SYSTEM_ACRONYM
FROM CORE.TEMP_HWAM th
join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = th.snapshot_id
LEFT OUTER JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = th.datacenter_id
LEFT OUTER JOIN CORE.SYSTEMS s on s.SYSTEM_ID = th.SYSTEM_ID
/*
group by 
--snap.datacategory
case coalesce(NULLIF(th.ASSET_ID_TATTOO,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End
--,case coalesce(NULLIF(dc.ACRONYM,''),'ITSNULL')
--    when 'ITSNULL' then 'ITSNULL'
--    Else 'Populated'
--End
,case coalesce(NULLIF(th.NORMALIZED_FQDN,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End
,case array_size(th.NORMALIZED_HOSTNAME) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End
,case array_size(th.IPV4) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End
,case array_size(th.NORMALIZED_MACADDRESS) 
    when 0 then 'ITSNULL'
    Else 'Populated'
End
,case coalesce(NULLIF(th.MOTHERBOARD,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End
,case coalesce(NULLIF(th.NORMALIZED_NETBIOSNAME,''),'ITSNULL')
    when 'ITSNULL' then 'ITSNULL'
    Else 'Populated'
End
--,case coalesce(NULLIF(s.ACRONYM,''),'ITSNULL')
--    when 'ITSNULL' then 'ITSNULL'
--    Else 'Populated'
--End
*/
;
create or replace view VW_TEMP_HWAM_UNASSIGNED_DW_ASSET_ID(
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	DATACATEGORY,
	TOTAL,
	TOTALUNASSIGNED
) COMMENT='Diagnostic View to report count of TEMP_HWAM records that do not have DW_ASSET_ID assigned\t'
 as
SELECT
t.snapshot_date,t.snapshot_id,t.datacategory,t.Total,IFNULL(u.TotalUnassigned,0) as TotalUnassigned
FROM (select snap.snapshot_date,snap.snapshot_id,snap.datacategory,count(1) as Total
FROM CORE.TEMP_HWAM th
join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = th.snapshot_id
group by snap.snapshot_date,snap.snapshot_id,snap.datacategory order by snap.snapshot_id) t
LEFT OUTER JOIN (select snapshot_id,count(1) TotalUnassigned
    from CORE.TEMP_HWAM WHERE dw_asset_id IS NULL
    group by snapshot_id) u on u.snapshot_id = t.snapshot_id
order by t.snapshot_id;
create or replace view VW_TENABLE_REPOSITORYHIST(
	INSERT_DATE,
	ACRONYM,
	DATACENTER_ID,
	LAST_SEEN,
	RAW_TENABLE_VUL_COUNT,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	IS_FROM_AWS_FEED,
	IS_MOST_RECENT_DATE
) COMMENT='View to list all Tenable Repository history. e.g. Each time repo is seen\t'
 as
SELECT 
rh.INSERT_DATE::date as INSERT_DATE
,dc.ACRONYM
,rh.DATACENTER_ID
--,dc.IS_MARKETPLACE
,substring(rh.LAST_SEEN::varchar,1,16) as LAST_SEEN 
,rh.RAW_TENABLE_VUL_COUNT
,rh.REPOSITORY_ID
,rh.REPOSITORY_NAME
,rh.IS_FROM_AWS_FEED
,case coalesce(m.REPOSITORY_ID::varchar,'ItNull')
    when 'ItNull' then 'No'
    Else 'Yes'
End as IS_MOST_RECENT_DATE
FROM CORE.TENABLE_REPOSITORYHIST rh
left outer join CORE.SYSTEMS dc on dc.SYSTEM_ID = rh.DATACENTER_ID

left outer join (select REPOSITORY_ID,DATACENTER_ID,max(INSERT_DATE) as MAX_INSERT_DATE
from CORE.TENABLE_REPOSITORYHIST GROUP BY REPOSITORY_ID,DATACENTER_ID) m on m.REPOSITORY_ID = rh.REPOSITORY_ID and m.DATACENTER_ID = rh.DATACENTER_ID and m.MAX_INSERT_DATE = rh.INSERT_DATE

where rh.REPOSITORY_ID IS NOT NULL
ORDER BY rh.TENABLE_REPOSITORYHIST_ID DESC
;
create or replace view VW_TENABLE_REPOSITORY_LAST_SEEN(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	MIN_INSERT_DATE,
	MAX_INSERT_DATE,
	MAX_LAST_SEEN
) COMMENT='View to list all Tenable Repositories and the date last seen\t'
 as
--
-- 231124
-- LSDR Vulnerabilities (TERATDV) (Lastseen 7/9/23) and Performant Vulnerability Database (Lastseend 6/24/23)
--
SELECT 
dc.ACRONYM as DATACENTER_ACRONYM
,rh.DATACENTER_ID
,rh.REPOSITORY_ID
,rh.REPOSITORY_NAME
,MIN(rh.INSERT_DATE)::date as Min_INSERT_DATE
,MAX(rh.INSERT_DATE)::date as Max_INSERT_DATE
,substring(MAX(rh.LAST_SEEN)::varchar,1,16) as Max_LAST_SEEN 
FROM CORE.TENABLE_REPOSITORYHIST rh
left outer join CORE.SYSTEMS dc on dc.SYSTEM_ID = rh.DATACENTER_ID
where rh.repository_id IS NOT NULL -- 231124
GROUP BY dc.ACRONYM,rh.DATACENTER_ID,rh.REPOSITORY_ID,rh.REPOSITORY_NAME
ORDER BY dc.ACRONYM,rh.REPOSITORY_NAME;
create or replace view VW_TENABLE_REPOSITORY_SCHED(
	DATECOLUMNNAME,
	ACRONYM,
	RAW_TENABLE_VUL_COUNT,
	REPOSITORY_ID,
	REPOSITORY_NAME
) COMMENT='UNDER DEVELOPMENT; View to list all Tenable Repositories and the dates see in pivot table format\t'
 as
SELECT 
--substring(rh.INSERT_DATE::varchar,1,16) as INSERT_DATE
--rh.INSERT_DATE::date || ' ' || upper(dayname(rh.INSERT_DATE::date)) as DATECOLUMNNAME
rh.LAST_SEEN::date || ' ' || upper(dayname(rh.LAST_SEEN::date)) as DATECOLUMNNAME
,dc.ACRONYM
--,rh.INSERT_DATE::date as INSERT_DATE
,rh.RAW_TENABLE_VUL_COUNT
,rh.REPOSITORY_ID
,rh.REPOSITORY_NAME
FROM CORE.TENABLE_REPOSITORYHIST rh
left outer join CORE.SYSTEMS dc on dc.SYSTEM_ID = rh.DATACENTER_ID

where rh.REPOSITORY_ID IS NOT NULL and DATEDIFF(day,rh.insert_date,current_date()) <= 90
--ORDER BY rh.TENABLE_REPOSITORYHIST_ID DESC
;
create or replace view VW_TOP_10_CVE(
	FISMASEVERITY,
	CVE,
	TOTALASSETS
) COMMENT='Top 10 CVEs for Critical, High, Medium\t'
 as
SELECT t.*
FROM (
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'Critical' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'High' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'Medium' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
) t
order by t.FISMASEVERITY, t.TOTALASSETS DESC
;
create or replace view VW_TOP_10_PLUGIN(
	FISMASEVERITY,
	PLUGIN_ID,
	TOTALASSETS
) COMMENT='Top 10 PLUGIN_IDs for Critical, High, Medium\t'
 as
SELECT t.*
FROM (
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'Critical' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'High' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'Medium' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
) t
order by t.FISMASEVERITY, t.TOTALASSETS DESC
;
create or replace view VW_TRAL_LOG_DIAGNOSTIC(
	DATE_IDENTIFIED,
	ACRONYM,
	SYSTEM_ID,
	FISMA_SYSTEM,
	TLC_PHASE,
	SYSTEM_RISK_LEVEL,
	DESCRIPTION,
	OA_READY,
	OA_STATUS,
	SEVERITY,
	IMPACTED_CONTROLS,
	RISK_RESPONSE,
	THRESHOLDDISPLAY,
	INITIALSCORE,
	DATEMITIGATED,
	SUBSEQUENTSCORE,
	METRICNAME,
	THRESHOLD,
	LAST_PENTEST_DATE,
	DAYS_SINCE_LAST_PENTEST,
	LAST_ACT_DATE,
	DAYS_SINCE_LAST_ACT,
	VULNRISKTOLERANCE,
	RESILIENCYSCORE,
	ABS_ASSETRISKTOLERANCE,
	DATEMODIFIED,
	REPORT_ID,
	REPORT_DATE
) COMMENT='Diagnostic: Returns the log for the TRAL metrics with initial and subsequent score  '
 as
--
-- Author: Chris Rollman, IronVine
-- Date created: 4/5/22
SELECT 
tl.dateIdentified::date as Date_Identified
,s.Acronym
,s.system_id
,s.Authorization_Package as FISMA_System
,s.TLC_Phase 
,src.Description || '(' || cast(src.SYSTEMRISKCATEGORY_ID as varchar) || ')' as System_Risk_Level
,tm.TriggerDescription as Description
,coalesce(s.Is_OA_Ready=1,'Yes','No') OA_Ready
,s.OA_Status
,case tsl.RiskSeverityLevel
	when 'High' then tsl.RiskSeverityLevel || '(3)'
	when 'Moderate' then tsl.RiskSeverityLevel || '(2)'
	when 'Low' then tsl.RiskSeverityLevel || '(1)'
	Else tsl.RiskSeverityLevel
End as Severity
,tsl.ImpactedControls as Impacted_Controls
,tsl.RiskResponse as Risk_Response
,tsl.ThresholdDisplay as ThresholdDisplay
,tl.InitialScore
,tl.dateMitigated
,tl.SubsequentScore
,tm.metricname
,tsl.Threshold
,TO_CHAR(sh.last_pentest_date,'mm/dd/yyyy') as LAST_PENTEST_DATE
,DATEDIFF(d,s.Last_Pentest_Date,r.report_date) DAYS_SINCE_LAST_PENTEST
,TO_CHAR(sh.last_act_date,'mm/dd/yyyy') as LAST_ACT_DATE
,DATEDIFF(d,s.LAST_ACT_DATE,r.report_date) DAYS_SINCE_LAST_ACT
,ss.VulnRiskTolerance
,ss.ResiliencyScore
,ABS(ss.AssetRiskTolerance) as ABS_AssetRiskTolerance
,TO_CHAR(tl.DATEMODIFIED,'mm/dd/yy hh:mm') as DATEMODIFIED
,r.report_id
,TO_CHAR(r.report_date,'mm/dd/yyyy') as REPORT_DATE
FROM CORE.VW_SYSTEMS s 
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_Log tl on tl.System_ID = s.System_ID
JOIN CORE.TRAL_Metric tm on tm.TRAL_Metric_ID = tl.TRAL_Metric_ID
JOIN CORE.TRAL_RiskSeverityLevel tsl  on tsl.SystemRiskCategory_ID = src.SYSTEMRISKCATEGORY_ID and tsl.TRAL_Metric_ID = tl.TRAL_Metric_ID
LEFT OUTER JOIN CORE.SystemSummary ss on SS.SYSTEM_ID = s.SYSTEM_ID and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.SystemSummary) --ss.REPORT_ID = 497
LEFT OUTER JOIN CORE.REPORT_IDS r on r.report_id = ss.report_id
LEFT OUTER JOIN CORE.SYSTEMSHIST sh on sh.report_id = ss.report_id and sh.system_id = s.system_id
where s.TLC_Phase <> 'Retire'
--and tl.dateIdentified::date <= r.report_date::date
ORDER BY s.Acronym, tl.dateIdentified;
create or replace view VW_VULPLUGINS_MASTER_FLATTENED(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DW_ASSET_ID,
	DW_PLUGIN_VUL_ID,
	DW_VUL_ID,
	PLUGIN_ID,
	PLUGIN_NAME,
	CVE,
	PLUGIN_MITIGATIONSTATUS,
	PLUGIN_DATEMITIGATED,
	PLUGIN_DELETIONREASON,
	PLUGIN_DATEDELETED,
	CVE_MITIGATIONSTATUS,
	CVE_DATEMITIGATED,
	EXTENDED_MITIGATIONSTATUS,
	CVE_DELETIONREASON,
	CVE_DATEDELETED,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FAMILY_NAME,
	FIRSTSEEN,
	LASTFOUND,
	PLUGIN_FISMASEVERITY,
	CVE_FISMASEVERITY,
	PLUGIN_INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	NETBIOSNAME,
	MACADDRESS,
	IPV4,
	PORT,
	IS_KEV,
	KEV_DUEDATE,
	KEV_SHORTDESCRIPTION,
	KEV_VENDORPROJECT,
	KEV_VULNERABILITYNAME,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	PATCHPUB_DATE,
	VULN_PUB_DATE,
	VERSION
) as
SELECT
a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,vpm.DW_ASSET_ID
,vpm.DW_PLUGIN_VUL_ID
,vm.DW_VUL_ID
,vpm.PLUGIN_ID
,vpm.PLUGIN_NAME
,f.value::string as CVE
,vpm.MITIGATIONSTATUS as PLUGIN_MITIGATIONSTATUS
,vpm.datemitigated as PLUGIN_DATEMITIGATED
,vpm.deletionreason as PLUGIN_DELETIONREASON
,vpm.datedeleted as PLUGIN_DATEDELETED
,vm.MITIGATIONSTATUS as CVE_MITIGATIONSTATUS
,vm.datemitigated as CVE_DATEMITIGATED
,vm.EXTENDED_MITIGATIONSTATUS
,vm.deletionreason as CVE_DELETIONREASON
,vm.datedeleted as CVE_DATEDELETED
,vpm.CVSSV2BASESCORE
,vpm.CVSSV3BASESCORE
,vpm.DAYSSINCEDISCOVERY
,vpm.EXPLOITAVAILABLE
,vpm.FAMILY_NAME
,vpm.FIRSTSEEN::date as FIRSTSEEN
,vpm.LASTFOUND::date as LASTFOUND
,vpm.FISMASEVERITY as PLUGIN_FISMASEVERITY
,vm.FISMASEVERITY as CVE_FISMASEVERITY
,vpm.INSERT_DATE::date as PLUGIN_INSERT_DATE
,vpm.IS_FROM_AWS_FEED
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.last_confirmed_time
,a.asset_id_tattoo
,a.fqdn
,a.hostname
,a.netbiosname
,a.macaddress
,a.ipv4
,vpm.PORT
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,kev.BODDUEDATE::date as KEV_DUEDATE
,kev.SHORTDESCRIPTION as KEV_SHORTDESCRIPTION
,kev.VENDORPROJECT as KEV_VENDORPROJECT
,kev.VULNERABILITYNAME as KEV_VULNERABILITYNAME
,vpm.REPOSITORY_ID
,trh.REPOSITORY_LASTSEEN::date as REPOSITORY_LASTSEEN
,vpm.REPOSITORY_NAME
,vpm.PATCHPUB_DATE::date as PATCHPUB_DATE
,vpm.VULN_PUB_DATE::date as VULN_PUB_DATE
--,vpm.DESCRIPTION
--,vpm.SOLUTION
--,vpm.SYNOPSIS
,vpm.VERSION
FROM CORE.VULPLUGINS_MASTER vpm
join table(flatten(cve,outer=>true)) as f
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = f.value::string and kev.IS_DELETED = 0
JOIN CORE.VULMASTER vm on vm.dw_asset_id = vpm.dw_asset_id and vm.CVE = f.value::string
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vpm.DW_ASSET_ID
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vpm.REPOSITORY_ID
WHERE vpm.repository_id in (94,95,96,97) 

/*
WHERE (a.system_id = '95392439db248410296cfd0e0f961941' -- HRES
    or
    a.datacenter_id = '95392439db248410296cfd0e0f961941') -- HRES
and f.value::string = 'CVE-2024-37891'
*/
order by a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,a.dw_asset_id
,f.value::string
,vpm.plugin_id
;
create or replace view VW_VULPLUGINS_MASTER_HIGLAS(
	DW_PLUGIN_VUL_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	NETBIOSNAME,
	IPV4,
	IPV6,
	DEVICETYPE,
	OS,
	DW_ASSET_ID,
	PLUGIN_ID,
	FISMASEVERITY_V3,
	FISMASEVERITY_V2,
	CVE,
	PLUGIN_MITIGATIONSTATUS,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	INSERT_DATE,
	FIRSTSEEN,
	LASTFOUND,
	DATEMITIGATED,
	DATEMODIFIED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	DATACENTER_ID,
	SYSTEM_ID,
	IS_FROM_AWS_FEED,
	TOTAL_PLUGIN_COUNT,
	FIXED_PLUGIN_COUNT,
	OPEN_PLUGIN_COUNT,
	DELETED_PLUGIN_COUNT,
	MITIGATIONSTATUS,
	EXTENDED_MITIGATIONSTATUS,
	FISMASEVERITY
) COMMENT='Temporary View reports Tenable vulnerabilities from VULPLUGINS_MASTER for HIGLAS.\t'
 as
SELECT
vpm.DW_PLUGIN_VUL_ID
,a.datacenter_acronym
,a.system_acronym
,a.asset_id_tattoo
,a.fqdn
,a.hostname
,a.netbiosname
,a.ipv4
,a.ipv6
,a.devicetype
,a.os
,vpm.DW_ASSET_ID
,vpm.PLUGIN_ID 
,vpm.FISMASEVERITY as FISMASEVERITY_V3
,(select CORE.FN_CRM_FISMASEVERITY('2.0',vpm.CVSSV2BASESCORE)) as FISMASEVERITY_V2
,f.value::string CVE
--,ARRAY_TO_STRING(vpm.CVE,',') as CVE
,vpm.mitigationstatus as Plugin_MitigationStatus
,vpm.CVSSV2BASESCORE
,vpm.CVSSV3BASESCORE
,substring(vpm.INSERT_DATE::varchar,1,16) as INSERT_DATE
,substring(vpm.FIRSTSEEN::varchar,1,16) as FIRSTSEEN
,substring(vpm.LASTFOUND::varchar,1,16) as LASTFOUND
,substring(vpm.DATEMITIGATED::varchar,1,16) as DATEMITIGATED
,substring(vpm.DATEMODIFIED::varchar,1,16) as DATEMODIFIED
,substring(vpm.DATEREOPENED::varchar,1,16) as DATEREOPENED
,vpm.DAYSSINCEDISCOVERY
,vpm.EXPLOITAVAILABLE
,vpm.REPOSITORY_ID
,vpm.REPOSITORY_NAME
,a.DATACENTER_ID
,a.SYSTEM_ID
,vpm.IS_FROM_AWS_FEED
,vm.total_plugin_count
,vm.fixed_plugin_count
,vm.open_plugin_count
,vm.deleted_plugin_count
,vm.mitigationstatus
,vm.extended_mitigationstatus
,vm.fismaseverity
FROM CORE.VULPLUGINS_MASTER vpm
join table(flatten(cve,outer=>true)) as f
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vpm.DW_ASSET_ID
left OUTER JOIN CORE.VULMASTER vm on vm.dw_asset_id = vpm.dw_asset_id and vm.CVE = f.value::string
WHERE vpm.DELETIONREASON IS NULL and a.system_acronym = 'HIGLAS';
create or replace schema DEV_CEDE COMMENT='For developing new views for Tableau';

create or replace view VW_CEDE_AUTHORIZATION_PACKAGES(
	ACRONYM,
	BUSINESS_OWNER,
	COMPONENT_ACRONYM,
	CURRENTYEARHVASCORE,
	FIPS_199_OVERALL_IMPACT_RATING,
	FISMA_SYSTEM,
	AUTHORIZATION_PACKAGE,
	ISCURRENTYEARHVALIST,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEFSTATUS,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	REPORTDATE,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	TLC_PHASE
) COMMENT='Contains system information'
 as
SELECT 
s.Acronym 
,s.Business_Owner 
,s.Component_Acronym 
,s.HVA_SCORE as CurrentYearHVAScore
,s.FIPS_199_Overall_Impact_Rating 
,s.FISMA_System 
,s.Authorization_Package 
,s.HVASTATUS as IscurrentyearHVAlist
,s.MEF as MissionEssentialFunctions_MEFs
,s.mefstatus
,s.PRIMARY_ISSO 
,s.Primary_Operating_Location 
,(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,s.SYSTEM_DESCRIPTION 
,s.SDM as SystemDeveloperMaintainer_SDM
,s.TLC_Phase 
FROM CORE.VW_Systems s 
;
create or replace view VW_CEDE_CFACTS_USER_PERSMISSIONS(
	REPORTDATE,
	ACRONYM,
	AUTHORIZATION_PACKAGE,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	CFACTS_UID,
	USERNAME,
	ROLE
) COMMENT='Security view for user permission to CEDE dashboards'
 as
SELECT distinct
(select Report_Date from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as ReportDate
,s.ACRONYM as Acronym
,s.AUTHORIZATION_PACKAGE as Authorization_Package
,s.COMPONENT_ACRONYM as Component_Acronym
,s.GROUP_ACRONYM as Group_Acronym
,s.TLC_PHASE as TLC_Phase
,case SUBSTRING(s.SYSTEM_ID,1,4)
	when '0000' then NULL
	Else s.SYSTEM_ID
End as CFACTS_UID
,um.USER_ID as UserName
,um.ROLE as Role
FROM CORE.VW_SYSTEMS s
JOIN BUS_CYBER_RISK_MANAGEMENT.DEV_RPT.V_SEC_USERSYSMAPPING_ALL uma on uma.acronym = s.acronym
JOIN CORE.CFACTS_USERMAPPING um on um.USER_ID = uma.username and um.role = uma.role
--WHERE um.USER_ID = 'S1T6' -- Julianne
;
create or replace view VW_CEDE_CONTROL_DETAIL_WITH_POAM(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	PRIMARY_OPERATING_LOCATION,
	CURRENT_HVA_SYS,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEF_COUNT,
	BUSINESS_OWNER,
	FIPS_199_OVERALL_IMPACT_RATING,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	CONTROL_NUMBER,
	TIER,
	CONTROL_NAME,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_ELEMENT,
	POAM_ID,
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL,
	SYS_PII_LEVEL
) COMMENT='Contains system details, controls and POAM details'
 as
SELECT e.REPORTDATE
      ,d.AUTHORIZATION_PACKAGE
      ,e.ACRONYM
      ,e.FISMA_SYSTEM
      ,e.TLC_PHASE 
      ,e.COMPONENT_ACRONYM
	  ,k.PRIMARY_OPERATING_LOCATION     
      ,CASE when e.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end as CURRENT_HVA_SYS
      ,e.MISSIONESSENTIALFUNCTIONS_MEFS
	  ,CASE when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 365 then 2 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end AS MEF_COUNT
      ,e.BUSINESS_OWNER
      ,e.FIPS_199_OVERALL_IMPACT_RATING
      ,e.PRIMARY_ISSO
      ,e.SYSTEM_DESCRIPTION
      ,e.SYSTEMDEVELOPERMAINTAINER_SDM
      ,d.CONTROL_NUMBER
      ,CASE when d.CONTROL_NUMBER IN ('SC-08','SC-28') then 'Encryption' 
	        when d.CONTROL_NUMBER IN ('SC-12','SC-13','SC-17') then 'Encryption Support' 
	        when d.CONTROL_NUMBER IN ('AC-03','AC-06','AC-17','AU-06','IA-02','MP-02','SI-04') then 'Tier 1' 
	        when d.CONTROL_NUMBER IN ('AC-04','AC-20','AU-12','IA-05(02)','SC-07','SC-CMS-01') then 'Tier 2' 
	        when d.CONTROL_NUMBER IN ('AC-06(01)','AC-18','CA-07','CM-03','IA-02(12)','PM-12') then 'Tier 3' 
	  end AS Tier
      ,d.CONTROL_NAME
      ,j.OVERALL_CONTROL_STATUS
      ,j.PRIVATE_IMP_UPDATED_DATE
      ,j.PRIVATE_IMPLEMENTATION_DETAILS
      ,d.control_element_number
      ,d.control_element
      ,h.POAM_ID
      ,h.ALLOCATED_CONTROL
      ,h.OVERALL_STATUS
      ,h.WEAKNESS_RISK_LEVEL
	  ,Coalesce(l.SYS_PII_LEVEL,'Undetermined') as SYS_PII_LEVEL
  FROM (SELECT 
	c.CONTROL_NUMBER,
	c.CONTROL_NAME,
	b.AUTHORIZATION_PACKAGE,
    c.control_element_number
    ,c.control_element
	  FROM (SELECT CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element, authorization_package FROM CEDE.VW_CEDE_ALLOCATED_CONTROLS GROUP BY CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element, authorization_package) c 
	join  (SELECT AUTHORIZATION_PACKAGE FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes' GROUP BY AUTHORIZATION_PACKAGE) b on c.authorization_package = b.AUTHORIZATION_PACKAGE) d
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES e ON e.AUTHORIZATION_PACKAGE = d.AUTHORIZATION_PACKAGE
  LEFT JOIN (SELECT f.AUTHORIZATION_PACKAGE
      ,f.POAM_ID
      ,g.ALLOCATED_CONTROL
      ,f.OVERALL_STATUS
      ,f.WEAKNESS_RISK_LEVEL
	  FROM CEDE.VW_CEDE_POAM f 
	  LEFT JOIN CEDE.VW_CEDE_POAMS_CONTROLS g ON f.POAM_ID=g.POAM_ID
	  WHERE f.OVERALL_STATUS !='Completed' and f.OVERALL_STATUS !='Closed For System Disposition') h ON (d.AUTHORIZATION_PACKAGE = h.AUTHORIZATION_PACKAGE and h.ALLOCATED_CONTROL=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_ALLOCATED_CONTROLS j ON (j.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE and j.CONTROL_NUMBER=d.CONTROL_NUMBER and j.control_element_number = d.control_element_number)
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL k ON k.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL l ON d.AUTHORIZATION_PACKAGE=l.AUTHORIZATION_PACKAGE
  ;
create or replace view VW_CEDE_CONTROL_DETAIL_WITH_POAM_TEST(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	PRIMARY_OPERATING_LOCATION,
	CURRENT_HVA_SYS,
	MISSIONESSENTIALFUNCTIONS_MEFS,
	MEF_COUNT,
	BUSINESS_OWNER,
	FIPS_199_OVERALL_IMPACT_RATING,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	CONTROL_NUMBER,
	TIER,
	CONTROL_NAME,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_ELEMENT,
	OVERALL_CONTROL_STATUS,
	PRIVATE_IMP_UPDATED_DATE,
	PRIVATE_IMPLEMENTATION_DETAILS,
	POAM_ID,
	ALLOCATED_CONTROL,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL,
	SYS_PII_LEVEL
) COMMENT='Contains system details, controls and POAM details'
 as
SELECT e.REPORTDATE
      ,d.AUTHORIZATION_PACKAGE
      ,e.ACRONYM
      ,e.FISMA_SYSTEM
      ,e.TLC_PHASE 
      ,e.COMPONENT_ACRONYM
	  ,k.PRIMARY_OPERATING_LOCATION     
      ,CASE when e.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end as CURRENT_HVA_SYS
      ,e.MISSIONESSENTIALFUNCTIONS_MEFS
	  ,CASE when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 365 then 2 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(e.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end AS MEF_COUNT
      ,e.BUSINESS_OWNER
      ,e.FIPS_199_OVERALL_IMPACT_RATING
      ,e.PRIMARY_ISSO
      ,e.SYSTEM_DESCRIPTION
      ,e.SYSTEMDEVELOPERMAINTAINER_SDM
      ,d.CONTROL_NUMBER
      ,CASE when d.CONTROL_NUMBER IN ('SC-08','SC-28') then 'Encryption' 
	        when d.CONTROL_NUMBER IN ('SC-12','SC-13','SC-17') then 'Encryption Support' 
	        when d.CONTROL_NUMBER IN ('AC-03','AC-06','AC-17','AU-06','IA-02','MP-02','SI-04') then 'Tier 1' 
	        when d.CONTROL_NUMBER IN ('AC-04','AC-20','AU-12','IA-05(02)','SC-07','SC-CMS-01') then 'Tier 2' 
	        when d.CONTROL_NUMBER IN ('AC-06(01)','AC-18','CA-07','CM-03','IA-02(12)','PM-12') then 'Tier 3' 
	  end AS Tier
      ,d.CONTROL_NAME
      ,d.control_element_number
      ,d.control_element
      ,j.OVERALL_CONTROL_STATUS
      ,j.PRIVATE_IMP_UPDATED_DATE
      ,j.PRIVATE_IMPLEMENTATION_DETAILS
      ,h.POAM_ID
      ,h.ALLOCATED_CONTROL
      ,h.OVERALL_STATUS
      ,h.WEAKNESS_RISK_LEVEL
	  ,Coalesce(l.SYS_PII_LEVEL,'Undetermined') as SYS_PII_LEVEL
  FROM (SELECT 
	c.CONTROL_NUMBER,
	c.CONTROL_NAME,
    c.control_element_number,
    c.control_element,
	b.AUTHORIZATION_PACKAGE
	  FROM (SELECT CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element FROM CEDE.VW_CEDE_ALLOCATED_CONTROLS GROUP BY CONTROL_NUMBER, CONTROL_NAME, control_element_number, control_element) c, 
	  (SELECT AUTHORIZATION_PACKAGE FROM CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes' GROUP BY AUTHORIZATION_PACKAGE) b) d
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES e ON e.AUTHORIZATION_PACKAGE = d.AUTHORIZATION_PACKAGE
  LEFT JOIN (SELECT f.AUTHORIZATION_PACKAGE
      ,f.POAM_ID
      ,g.ALLOCATED_CONTROL
      ,f.OVERALL_STATUS
      ,f.WEAKNESS_RISK_LEVEL
	  FROM CEDE.VW_CEDE_POAM f 
	  LEFT JOIN CEDE.VW_CEDE_POAMS_CONTROLS g ON f.POAM_ID=g.POAM_ID
	  WHERE f.OVERALL_STATUS !='Completed' and f.OVERALL_STATUS !='Closed For System Disposition') h ON (d.AUTHORIZATION_PACKAGE = h.AUTHORIZATION_PACKAGE and h.ALLOCATED_CONTROL=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_ALLOCATED_CONTROLS j ON (j.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE and j.CONTROL_NUMBER=d.CONTROL_NUMBER)
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL k ON k.AUTHORIZATION_PACKAGE=d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL l ON d.AUTHORIZATION_PACKAGE=l.AUTHORIZATION_PACKAGE
  ;
create or replace view VW_CEDE_POAMS_CONTROLS(
	ALLOCATED_CONTROL,
	CONTROL_ELEMENT_NUMBER,
	AUTHORIZATION_PACKAGE,
	POAM_ID,
	REPORT_DATE
) COMMENT='Contains POAM related allocated controls'
 as
SELECT c.ALLOCATED_CONTROL 
    ,Alloc.control_element_number
	,s.AUTHORIZATION_PACKAGE 
	,c.POAM_ID 
    ,r.REPORT_DATE 
FROM CORE.CEDE_MVP_POAMS_Controls c
join CORE.ALLOCATEDCONTROL Alloc on Alloc.control_number = c.allocated_control
JOIN CORE.REPORT_IDS r on r.REPORT_ID = c.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = c.SYSTEM_ID
;
create or replace view VW_CEDE_SYSTEM_DETAIL_WITH_PRIORITIZATION(
	REPORTDATE,
	AUTHORIZATION_PACKAGE,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	COMPONENT_ACRONYM,
	CURRENT_HVA_SYS,
	MEF_COUNT,
	MEFSTATUS,
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	SYSTEM_DESCRIPTION,
	SYSTEMDEVELOPERMAINTAINER_SDM,
	PRIMARY_OPERATING_LOCATION,
	SYSTEM_PII_LEVEL,
	NORM_DATA_SENSITIVITY,
	NORM_SECUIRTY_POSTURE2,
	NORM_SYSTEM_CRITICALITY,
	OVERALL_PRIORITIZATION
) COMMENT='Contains System information, PII level and aver all prioritization level'
 as
SELECT a.REPORTDATE
      ,a.AUTHORIZATION_PACKAGE
      ,a.ACRONYM
      ,a.FISMA_SYSTEM
      ,a.TLC_PHASE
      ,a.COMPONENT_ACRONYM
      ,CASE when a.ISCURRENTYEARHVALIST = 'Yes' then 1
	      else 0 end AS current_hva_sys
	  ,CASE when len(a.MISSIONESSENTIALFUNCTIONS_MEFS)  = 365 then 2 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 174 then 1 
	      when len(a.MISSIONESSENTIALFUNCTIONS_MEFS) = 190 then 1 
	      else 0 end as mef_count
      ,a.MEFSTATUS    
      ,a.BUSINESS_OWNER
      ,a.PRIMARY_ISSO
      ,a.SYSTEM_DESCRIPTION
      ,a.SYSTEMDEVELOPERMAINTAINER_SDM
      ,b.PRIMARY_OPERATING_LOCATION
	  ,coalesce(f.SYS_PII_LEVEL,'Undetermined') as system_pii_level
	  ,c.NORM_DATA_SENSITIVITY
	  ,coalesce(d.NORM_SECURITY_POSTURE,0) as norm_secuirty_posture2
	  ,e.NORM_SYSTEM_CRITICALITY
	  ,CASE WHEN c.NORM_DATA_SENSITIVITY>=0 and e.NORM_SYSTEM_CRITICALITY>=0 then 
	  ROUND((c.NORM_DATA_SENSITIVITY*.15) + ((1-coalesce(d.NORM_SECURITY_POSTURE,0)) *.7) + (e.NORM_SYSTEM_CRITICALITY *.15),3) END AS overall_prioritization
  FROM DEV_CEDE.VW_CEDE_AUTHORIZATION_PACKAGES a
  LEFT JOIN CEDE.VW_CEDE_AUTHORIZATION_PACKAGES_POL b on b.AUTHORIZATION_PACKAGE =a.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_DATA_SENSITIVITY c ON a.AUTHORIZATION_PACKAGE =c.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SECURITY_POSTURE d ON a.AUTHORIZATION_PACKAGE =d.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_PRIORITIZATION_SYSTEM_CRITICALITY e ON a.AUTHORIZATION_PACKAGE =e.AUTHORIZATION_PACKAGE
  LEFT JOIN CEDE.VW_CEDE_SYSTEM_PII_LEVEL f ON a.AUTHORIZATION_PACKAGE =f.AUTHORIZATION_PACKAGE
  WHERE a.TLC_PHASE = 'Operate' and a.FISMA_SYSTEM = 'Yes'
  ;
create or replace schema DEV_ISPG COMMENT='ISPG Sandbox';

create or replace TABLE SAMPLE_TABLE (
	SAMPLE_TABLE_COL1 VARCHAR(100),
	SAMPLE_TABLE_COL2 NUMBER(38,0)
)COMMENT='sample table for DEV_ISPG'
;
create or replace view SAMPLE_VIEW(
	SAMPLE_VIEW_COL1,
	SAMPLE_VIEW_COL2
) as
   select sample_table_col1, sample_table_col2 from BUS_CYBER_RISK_MANAGEMENT.DEV_ISPG.SAMPLE_TABLE ;
create or replace schema DEV_RPT COMMENT='For developing new views for Tableau';

create or replace TABLE CFACTS_EXCLUSIVECLUB (
	USERNAME VARCHAR(16777216),
	MEMBER BOOLEAN
)COMMENT='List of CRM user IDs'
;
create or replace TABLE CFACTS_EXCLUSIVECLUB1 (
	USERNAME VARCHAR(16777216),
	MEMBER BOOLEAN
)COMMENT='List of CRM user IDs'
;
create or replace TABLE CRR_COMPONENT_PARAMS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	COMPONENT VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	GROUPS VARCHAR(16777216),
	REPORTNAME VARCHAR(16777216),
	SYSTEMS VARCHAR(16777216),
	primary key (ID)
)COMMENT='Look up table to get report name based on acronym and component acronym for MCRR report'
;
create or replace TABLE DATACENTER_USERS (
	CFACTS_UID VARCHAR(16777216),
	USERID VARCHAR(16777216)
);
create or replace TABLE LEGACY_SYSTEMS (
	SYSTEM_ID VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE TEMP_DAILYDATACHECK (
	REFRESH_DATE TIMESTAMP_LTZ(9),
	REPORT_ID NUMBER(38,0),
	TABLENAME VARCHAR(16777216)
);
create or replace TABLE TEMP_TRENDING (
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	"CVE Count" NUMBER(18,0),
	"Unique CVE Count" NUMBER(18,0),
	CURRENTMTDSTART DATE,
	DATA_CENTER_NAME VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(21,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	IS_MARKETPLACE BOOLEAN,
	MEFSTATUS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	PREVEOMSTART DATE,
	RANKK NUMBER(38,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	REPORT_DATE DATE,
	REPORT_ID NUMBER(38,0),
	TLC_PHASE VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2)
);
create or replace TABLE TEMP_VULN_FV_ROLLING60DAYS (
	V_ACR VARCHAR(16777216),
	V_COMP_ACR VARCHAR(16777216),
	V_TLC_PHASE VARCHAR(16777216),
	V_HVA_STAT VARCHAR(16777216),
	V_IS_MRKT_PLC BOOLEAN,
	V_MEF_STATUS VARCHAR(16777216),
	V_ACR_DISPLAY VARCHAR(16777216),
	FILTER VARCHAR(1),
	FK_PRIMARY_FISMA_ID VARCHAR(16777216),
	FK_DATACENTER_ID VARCHAR(16777216),
	ID NUMBER(38,0),
	FK_DW_VUL_NUMBER NUMBER(38,0),
	CVE VARCHAR(16777216),
	DAYSSINCEDISCOVERY NUMBER(9,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	FK_SNAPSHOTID NUMBER(38,0),
	ACRONYM VARCHAR(16777216),
	ACR_ALIAS VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	IS_DATACENTER BOOLEAN,
	IS_MARKETPLACE BOOLEAN,
	TLC_PHASE VARCHAR(16777216),
	IS_SCANNABLE BOOLEAN,
	BODDUEDATE TIMESTAMP_TZ(9),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	HVASTATUS VARCHAR(16777216),
	MEFSTATUS VARCHAR(16777216),
	DATA_CENTER_NAME VARCHAR(16777216),
	DELETIONREASON VARCHAR(16777216),
	FK_PLUGINID VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	FAMILYNAME VARCHAR(16777216),
	SIGNATURE VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	RANKK NUMBER(18,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	CURRENTMTDSTART DATE,
	PREVEOMSTART DATE,
	FK_ASSETID NUMBER(38,0),
	COMPUTER_TYPE VARCHAR(16777216),
	OS VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	CVSS2BASESCORE NUMBER(38,1),
	CVSS3BASESCORE NUMBER(38,1),
	VRT NUMBER(10,2),
	"POA&M ID" VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216)
)COMMENT='Contains all the Vulnerabilities data for last 60 days'
;
create or replace view VW_ASSETDETAIL_ROLLING60DAYS(
	ACR,
	COM_ACR,
	ACR_ALIAS,
	ACRONYM,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTIDS,
	BIOS_GUID,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	COMPUTER_TYPE,
	CVE,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	DATA_CENTER_NAME,
	DATACENTER_ID,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	OVERDUE_FILTER,
	DELETIONREASON,
	DEVICETYPE,
	DW_ASSET_ID,
	DW_VUL_ID,
	ENVIRONMENT,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FILTER,
	FIRSTSEEN,
	FISMASEVERITY,
	FQDN,
	HOSTNAME,
	HVASTATUS,
	ID,
	IPV4,
	IPV6,
	IS_BOD,
	IS_MARKETPLACE,
	LASTFOUND,
	MAC,
	MEFSTATUS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OATO_CATEGORY,
	OS,
	OS_VERSION,
	PLUGINID,
	RANKK,
	REFRESH_DATE,
	SENSOR_FIRSTSEEN,
	SENSOR_LASTFOUND,
	SIGNATURE,
	SNAPSHOT_ID,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	FISMA_ID,
	TENABLEUUID,
	TLC_PHASE,
	VULNRISKTOLERANCE,
	EPSS,
	EPSS_FILTER,
	PERCENTILE
) COMMENT='Contains all the Vulnerabilities and asset for latest snapshots with granular CVE IDs/Asset ID/Plug in ID/IPV4/EPSS etc for each system/data Center/component (Fixed Vulns population imited to rolling 60 days)'
 as
select 
    s.Acronym as ACR,
    s.Component_Acronym as COM_ACR,
	substring(s.Acronym,1,1) || '***' as ACR_ALIAS,
	s.ACRONYM,
	Asst.ASSET_ID_TATTOO,
	s.AWS_ACCOUNTIDS,
	Asst.BIOS_GUID,
	Asst.BODDUEDATE,
	Asst.COMPONENT_ACRONYM,
	Asst.COMPUTER_TYPE,
	Asst.CVE,
	Asst.CVSS2BASESCORE,
	Asst.CVSS3BASESCORE,
    IFNULL(Asst.DATA_CENTER_NAME,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name, --Datacenter from assets or primary oploc CR #850.
    IFNULL(Asst.DATACENTER_ID,s.primary_operating_location_id) as DATACENTER_ID, --Datacenter id from assets or primary oploc CR #850.
	Asst.DATECREATED,
	Asst.DATEMITIGATED,
	Asst.DAYSSINCEDISCOVERY,
    case 
    when Asst.DAYSSINCEDISCOVERY <= 15 then '<= 15 days'
    when Asst.DAYSSINCEDISCOVERY > 15 and Asst.DAYSSINCEDISCOVERY <= 30 then '> 15 and <= 30 days'
    when Asst.DAYSSINCEDISCOVERY > 30 and Asst.DAYSSINCEDISCOVERY <= 45 then '> 30 and <= 45 days'
    when Asst.DAYSSINCEDISCOVERY > 45 and Asst.DAYSSINCEDISCOVERY <= 60 then '> 45 and <= 60 days'
    when Asst.DAYSSINCEDISCOVERY > 60 and Asst.DAYSSINCEDISCOVERY <= 90 then '> 60 and <= 90 days'
    when Asst.DAYSSINCEDISCOVERY > 90 then '> 90 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER,
    case 
    when Asst.FISMASEVERITY = 'Critical' and Asst.DAYSSINCEDISCOVERY > 15 then 'OVERDUE CRITICAL'
    when Asst.FISMASEVERITY = 'High' and Asst.DAYSSINCEDISCOVERY > 30 then 'OVERDUE HIGH'
    when Asst.FISMASEVERITY = 'Medium' and Asst.DAYSSINCEDISCOVERY > 90 then 'OVERDUE MODERATE'
    when Asst.FISMASEVERITY = 'Low' and Asst.DAYSSINCEDISCOVERY > 365 then 'OVERDUE LOW'
    ELSE 'NOT OVERDUE'
    end as OVERDUE_FILTER, 
	Asst.DELETIONREASON,
	Asst.DEVICETYPE,
	Asst.DW_ASSET_ID,
	Asst.DW_VUL_ID,
    --Asst.DW_ASSET_ID as "FK_AssetID",
    --Asst.DW_VUL_ID as "FK_dw_vul_number",
	Asst.ENVIRONMENT,
	Asst.EXPLOITAVAILABLE,
	Asst.FAMILYNAME,
	Asst.FILTER,
	Asst.FIRSTSEEN,
	Asst.FISMASEVERITY,
	Asst.FQDN,
	Asst.HOSTNAME,
	s.HVASTATUS,
	Asst.ID,
	Asst.IPV4,
	Asst.IPV6,
	Asst.IS_BOD,
	s.IS_MARKETPLACE,
	Asst.LASTFOUND,
	Asst.MAC,
	s.MEFSTATUS,
	Asst.MITIGATIONSTATUS,
	Asst.NETBIOSNAME,
	Asst.OATO_CATEGORY,
	Asst.OS,
	Asst.OS_VERSION,
	Asst.PLUGINID,
	Asst.RANKK,
	Asst.REFRESH_DATE,
	Asst.SENSOR_FIRSTSEEN,
	Asst.SENSOR_LASTFOUND,
	Asst.SIGNATURE,
	Asst.SNAPSHOT_ID,
	Asst.SOLUTION,
	Asst.SOURCE_TOOL,
	Asst.SYSTEM_ID,
    Asst.SYSTEM_ID FISMA_ID,
	Asst.TENABLEUUID,
	s.TLC_PHASE,
	Asst.VULNRISKTOLERANCE
    ,epss.epss
    ,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    end as epss_FILTER
    ,epss.percentile
 from (select * from RPT.AssetDetail where lower(MitigationStatus) in ('open', 'reopened') or (lower(MitigationStatus) = 'fixed' and datemitigated > (current_date() - 60)))asst
 right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_MarketPlace,HVAStatus,MEFStatus,TLC_Phase,aws_accountids, PRIMARY_OPERATING_LOCATION_ACRONYM, primary_operating_location_id from CORE.vw_Systems) s ON s.SYSTEM_ID = asst.SYSTEM_ID 
 LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = Asst.cve
;
create or replace view VW_ASSET_SOFTWARE_DB(
	ASSET_ID_TATTOO,
	ASSETSOFTWARE_ID,
	COMPONENT_ACRONYM,
	DATACENTER_ID,
	DATEINSTALLED,
	DEVICETYPE,
	DW_ASSET_ID,
	FIRSTSEEN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	ACRONYM,
	GROUP_ACRONYM,
	MEFSTATUS,
	TLC_PHASE,
	IS_MARKETPLACE,
	HVASTATUS,
	OATO_CATEGORY,
	SYSTEM_ID,
	VENDOR,
	VERSION,
	DATACENTER_ACRONYM
) COMMENT='View reports software related to assets \t'
 as
SELECT 
sw.ASSET_ID_TATTOO
,sw.ASSETSOFTWARE_ID
,dlookup.COMPONENT_ACRONYM
,sw.DATACENTER_ID
,sw.DATEINSTALLED
,sw.DEVICETYPE
,sw.DW_ASSET_ID
,sw.FIRSTSEEN
,sw.LASTSEEN
,sw.MAJOR
,sw.MINOR
,sw.SOFTWARENAME
,sw.SOURCE_TOOL
,sw.SWAM_CATEGORY
,dlookup.ACRONYM
,dlookup.GROUP_ACRONYM
,dlookup.mefstatus
,dlookup.tlc_phase
,dlookup.is_marketplace
,dlookup.hvastatus
,dlookup.oato_category
,dlookup.ID SYSTEM_ID
,sw.VENDOR
,sw.VERSION
,dlookup.datacenter_acronym
from BUS_CYBER_RISK_MANAGEMENT.DEV_RPT.V_DIMENSIONAL_LOOKUP1 dlookup
left outer join CORE.VW_ASSET_SOFTWARE_TEST sw on dlookup.id = sw.system_id and dlookup.component_acronym = sw.component_acronym
;
create or replace view VW_ASSET_SOFTWARE_DETAILS(
	ACRONYM,
	DATACENTERACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	TLC_PHASE,
	SOURCE_TOOL_LASTSEEN,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	INSERT_DATE,
	LASTSEEN_HWAM,
	IS_APPLICABLE,
	DEVICEROLE,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	AWS_INSTANCESTATUS,
	IS_TENABLE_CREDENTIALED_SCAN,
	FIRSTSEEN,
	DATEINSTALLED,
	DW_SWAM_ID,
	SOFTWARENAME
) COMMENT='This view contains Master Device records data along with Sofware name for SWAM details'
 as
select
sys.Acronym
,dc.Acronym as DatacenterAcronym
,substring(sys.Acronym,1,1) || '***' as Acr_Alias
,sys.Component_Acronym
,sys.Group_Acronym
,sys.Is_DataCenter
,sys.Is_MarketPlace
,sys.HVAStatus
,sys.MEFStatus
,sys.TLC_Phase
,a.SOURCE_TOOL_LASTSEEN
,upper(a.environment) as environment
,a.asset_id_tattoo
,a.os_version
,a.TenableUUID
,a.DeviceType
,a.INSERT_DATE
,a.LastSeen_HWAM
,a.IS_APPLICABLE
,a.DeviceRole
,a.fqdn
,a.hostname
,a.IPv4
,a.IPv6
,a.Macaddress
,a.netbiosname 
,a.AWS_INSTANCESTATUS
,asw.is_tenable_credentialed_scan
,asw.FIRSTSEEN
,ASW.DATEINSTALLED
,asw.DW_SWAM_ID
,asw.SOFTWARENAME
from CORE.VW_ASSETS a
JOIN CORE.VW_ASSET_SOFTWARE asw on a.dw_asset_id = asw.dw_asset_id
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,Group_Acronym,TLC_Phase,aws_accountids,IS_EXCLUDEFROMREPORTING from CORE.vw_Systems) sys ON sys.SYSTEM_ID = a.SYSTEM_ID 
left join (select SYSTEM_ID,acronym from CORE.vw_Systems) dc ON dc.SYSTEM_ID = a.DATACENTER_ID
;
create or replace view VW_ASSET_SOFTWARE_TEST(
	ASSET_ID_TATTOO,
	ASSETSOFTWARE_ID,
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DATEINSTALLED,
	DEVICETYPE,
	DW_ASSET_ID,
	FIRSTSEEN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	VENDOR,
	VERSION
) COMMENT='View reports software related to assets \t'
 as
SELECT 
ASSET_ID_TATTOO
,ASSETSOFTWARE_ID
,COMPONENT_ACRONYM
,DATACENTER_ACRONYM
,DATACENTER_ID
,DATEINSTALLED
,DEVICETYPE
,DW_ASSET_ID
,FIRSTSEEN
,LASTSEEN
,MAJOR
,MINOR
,SOFTWARENAME
,SOURCE_TOOL
,SWAM_CATEGORY
,SYSTEM_ACRONYM
,SYSTEM_ID
,VENDOR
,VERSION
FROM CORE.VW_ASSET_SOFTWARE_TEST;
create or replace view VW_CDM_DASHBOARD(
	SYSTEM_ID,
	DATACENTER_ID,
	ASSETHIST_ID,
	DW_ASSET_ID,
	REPORT_ID,
	IS_SCANNABLE,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	TLC_PHASE,
	IS_EXCLUDEFROMREPORTING,
	RANKK,
	REFRESH_DATE,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL_LASTSEEN,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	INSERT_DATE,
	DATEDELETED,
	IS_APPLICABLE,
	DEVICEROLE,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	AWS_INSTANCESTATUS,
	NETBIOS_HN,
	DATACENTER,
	VRT,
	SNAPSHOTS,
	ENDOFMONTH,
	REPORT_DATE,
	STARTOFMONTH,
	LASTSEEN_HWAM,
	AWS_ACCOUNTIDS,
	REFRESHDATE,
	TENANT_ID,
	IS_TENABLE_CREDENTIALED_SCAN,
	IS_FORESCOUT_MANAGED,
	CLOUD_ACCOUNT_ID,
	IS_ENDPOINT
) COMMENT='This view contains Master Device records data along with Vuln risk tolerance calculated at each asset level'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union --CR#822 changed Union All to Union to avoid duplicate records on monthend snapshot date
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=3)),
    
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) = 1 then 'Current' when dense_rank()over(order by Report_ID desc) ='2' then 'LastMonth' when  dense_rank()over(order by Report_ID desc) ='3' then 'PrevMonth' when  dense_rank()over(order by Report_ID desc) ='4' then  'PrevPrevMonth' end as SnapshotsRank,
	case when dense_rank()over(order by Report_ID desc) =1 then LAST_DAY(current_date()) else LAST_DAY(ADD_MONTHS(Report_Date,-1)) end as EndofMonth,
	r.Report_Date,
	case when dense_rank()over(order by Report_ID desc) =1 then DATE_TRUNC('MONTH',current_date()) else (DATE_TRUNC('MONTH',ADD_MONTHS(Report_Date,-1))) End as StartOfMonth
	from ReportIDs r)
    
select
ah.SYSTEM_ID 
,ah.DATACENTER_ID 
,ah.ASSETHIST_ID 
,ah.dw_Asset_ID 
,ah.Report_ID
,a.Is_Scannable 
,sys.Acronym 
,substring(sys.Acronym,1,1) || '***' as Acr_Alias
,sys.Component_Acronym 
,sys.Group_Acronym 
,sys.Is_DataCenter 
,sys.Is_MarketPlace 
,sys.HVAStatus 
,sys.MEFStatus 
,sys.TLC_Phase 
,sys.IS_EXCLUDEFROMREPORTING 
,dense_rank()over(order by ah.REPORT_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,a.computer_type 
,a.os 
,a.bios_guid 
,a.SOURCE_TOOL_LASTSEEN 
,upper(a.environment) as environment
,a.asset_id_tattoo 
,a.os_version 
,a.TenableUUID 
,a.DeviceType 
,a.INSERT_DATE 
,NULL as dateDeleted
,a.IS_APPLICABLE 
,a.DeviceRole 
,a.fqdn 
,a.hostname 
,a.IPv4
,a.IPv6 
,a.Macaddress 
,a.netbiosname 
,upper(ah.AWS_INSTANCESTATUS) AWS_INSTANCESTATUS 
,ah.BIOS_GUID as netbios_hn
,dc.Acronym as Datacenter
,ah.VulnRiskTolerance as VRT
,snap.SnapshotsRank as Snapshots
,snap.EndofMonth 
,snap.Report_Date 
,snap.StartOfMonth 
,a.LastSeen_HWAM 
,sys.aws_accountids 
,current_date() as RefreshDate
,a.tenant_id 
,ah.is_tenable_credentialed_scan --cr#968
,ah.is_forescout_managed --cr#968
,a.CLOUD_ACCOUNT_ID -- 241125 CR1038
,ah.IS_ENDPOINT --241219 CR968
from CORE.VW_Assets a
RIGHT JOIN CORE.VW_ASSETHIST ah on ah.DW_ASSET_ID = a.DW_ASSET_ID 
--join CORE.reportsnapshots RC on ah.report_id = RC.REPORT_ID
JOIN Snapshots snap on snap.REPORT_ID = ah.REPORT_ID
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,Group_Acronym,TLC_Phase,aws_accountids,IS_EXCLUDEFROMREPORTING from CORE.vw_Systems) sys ON sys.SYSTEM_ID = ah.SYSTEM_ID 
left join (select SYSTEM_ID,acronym from CORE.vw_Systems) dc ON dc.SYSTEM_ID = ah.DATACENTER_ID
--left join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID;
;
create or replace view VW_CONFIGURATION_COMPLIANCE_BETA_V2(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	DAYSSINCEDISCOVERY,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FIRST_SEEN,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SEVERITY_NAME,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.COMPONENT_ACRONYM
,a.DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.DAYSSINCEDISCOVERY
,comp.Finding_Description
,comp.Finding_ID
,comp.FIRST_SEEN
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.IS_TENABLE_CREDENTIALED_SCAN
,comp.LAST_SEEN as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity

,case coalesce(upper(comp.Severity),'ITSNULL')
    when 'I' then 'High'
    when 'II' then 'Medium'
    when 'III' then 'Low'
    Else 'Unknown'
End as Severity_Name

,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,DATEDIFF(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.FIRST_SEEN
,r.LAST_SEEN

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
left outer join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CONFIGURATION_COMPLIANCE_BETA_V3(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	DAYSSINCEDISCOVERY,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FIRST_SEEN,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SEVERITY_NAME,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.COMPONENT_ACRONYM
,a.DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.DAYSSINCEDISCOVERY
,comp.Finding_Description
,comp.Finding_ID
,comp.FIRST_SEEN
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.IS_TENABLE_CREDENTIALED_SCAN
,comp.LAST_SEEN as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity

,case coalesce(upper(comp.Severity),'ITSNULL')
    when 'I' then 'High'
    when 'II' then 'Medium'
    when 'III' then 'Low'
    Else 'Unknown'
End as Severity_Name

,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 20),(CompInfoEnd - CompInfoStart - 20)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,DATEDIFF(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.FIRST_SEEN
,r.LAST_SEEN

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
left outer join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CRITICALVULN_HOSTCOUNT(
	REPORT_ID,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	IS_BOD,
	CVE,
	CVSSV3BASESCORE,
	EPSS,
	TOTALVULCOUNT,
	VUL_FIXED_TODAY,
	ASSETS_SCANNED
) as
SELECT t.REPORT_ID
    ,t.REPORT_DATE
    ,RI.ASSETS
    ,RI.ASSETS_AWS
    ,t.FISMASEVERITY
    ,t.MITIGATIONSTATUS
    ,t.IS_BOD
    ,t.CVE
    ,t.CVSSV3BASESCORE
    ,epss.EPSS
    ,t.TOTALVULCOUNT
    ,VUL_FIXED_TODAY
    ,ASSETS_SCANNED
FROM (
(select REPORT_ID, REPORT_DATE, FISMASEVERITY, MITIGATIONSTATUS, IS_BOD, CVSSV3BASESCORE, cve,count(1) TOTALVULCOUNT 
from CORE.VW_VULHIST group by REPORT_ID, REPORT_DATE,FISMASEVERITY,MITIGATIONSTATUS,IS_BOD,cvssv3basescore,cve order by count(1) DESC)
) t
Join (select top 31 REPORT_ID, ASSETS, ASSETS_AWS + ASSETS_AWS_GOVCLOUD as ASSETS_AWS, VUL_FIXED_TODAY, ASSETS ASSETS_SCANNED from CORE.REPORT_IDS order by REPORT_ID desc) RI on RI.REPORT_ID = t.REPORT_ID 
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = t.cve
order by t.REPORT_ID DESC
;
create or replace view VW_CRITICALVULN_HOSTCOUNT_SYSTEMS(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	SYSTEM_ACRONYM,
	ASSETS,
	ASSETS_SCANNED
) as
SELECT t.REPORT_ID
    ,t.REPORT_DATE
    ,t.SYSTEM_ID
    ,t.SYSTEM_ACRONYM
    ,t.ASSETS
    ,t.ASSETS ASSETS_SCANNED
FROM (
(select REPORT_ID, REPORT_DATE, SYSTEM_ID, SYSTEM_ACRONYM, count(1) ASSETS 
from CORE.VW_ASSETHIST group by REPORT_ID, SYSTEM_ACRONYM, REPORT_DATE, SYSTEM_ID order by count(1) DESC)
) t
Join (select top 31 REPORT_ID, REPORT_DATE from CORE.REPORT_IDS order by REPORT_ID desc) RI on RI.REPORT_ID = t.REPORT_ID 
order by t.REPORT_ID DESC
;
create or replace view VW_CRM_PORTAL(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	ACRONYM,
	NEXT_REQUIRED_CP_TEST_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	TLC_PHASE,
	ASSETS,
	VUL_OPEN,
	VUL_REOPENED,
	RESILIENCYSCORE,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_MONTHTODATE,
	VULNRISKTOLERANCE,
	POAM_COUNT,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TOTAL_ASSET,
	TIMELINESS_PCT,
	COUNT_SOFTWAREINSTALLED,
	VULN_OVERDUE,
	COUNT_FINDINGS,
	COUNT_PHISHING_RES_LOGIN,
	COUNT_TOTALLOGIN
) as
select 
    rids.report_id,
    rids.report_date,
    sys.system_id,
    sys.acronym,
    sys.next_required_cp_test_date,
    sys.DATE_AUTH_MEMO_EXPIRES,
    sys.is_oa_ready,
    sys.oa_status,
    Sys.tlc_phase,
    ss.assets, 
    vulopen.vul_open, 
    vulopen.vul_reopened,
    ss.resiliencyscore,
    ss.KEV_OPEN,
    ss.KEV_REOPENED,
    ss.KEV_FIXED_MONTHTODATE,
    ss.vulnrisktolerance,
    p.POAM_COUNT,
    Count_less72Hrs,
    Count_greater72Hrs,
    total_asset,
    case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
    end as Timeliness_PCT,
    Count_SoftwareInstalled,
    CRITICALGT15+HIGHGT30+MODERATEGT90+LOWGT365 as VULN_OVERDUE,
    COUNT_FINDINGS,
    (select sum(piv+fido2+zscaler) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS where date(authndate) >= DATE_TRUNC(month, CURRENT_DATE())) as COUNT_PHISHING_RES_LOGIN,
    (select sum(EMAIL+FIDO2+OKTAOTP+OKTAPUSH+OTP+PHONE+PIV+SMS+ZSCALER) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS where date(authndate) >= DATE_TRUNC(month, CURRENT_DATE())) as COUNT_TOTALLOGIN
from (select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 0 UNION select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 1) rids
JOIN (select report_id, system_id, sum(vul_high_open +vul_critical_open+vul_medium_open+vul_low_open) vul_open, sum(vul_high_reopened + vul_critical_reopened + vul_medium_reopened + vul_low_reopened) vul_reopened from core.vw_systemsummary group by all) vulopen on vulopen.report_id = rids.report_id
left outer join (select report_id, system_id, acronym, assets, resiliencyscore, kev_open KEV_OPEN, kev_reopened kev_reopened, kev_fixed_monthtodate kev_fixed_monthtodate, vulnrisktolerance vulnrisktolerance from core.vw_systemsummary where assets <> 0) ss on vulopen.system_id = ss.system_id and ss.report_id = rids.report_id
left outer join (select report_id, system_id, count(poam_id) POAM_COUNT from core.vw_poamhist where overall_status not in ('Completed', 'Pending Verification') 
group by all) p on vulopen.system_id = p.system_id and p.report_id = rids.report_id
left outer JOIN (select distinct
report_id, system_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah 
group by all) tl on vulopen.system_id = tl.system_id and tl.report_id = rids.report_id
join core.vw_systems sys on sys.system_id = vulopen.system_id
left outer join (SELECT system_id, count(distinct sw.DW_ASSET_ID) Count_SoftwareInstalled from CORE.VW_ASSET_SOFTWARE sw where date(sw.dateinstalled) >= (select max(date(report_date)) from core.report_ids where is_endofmonth = 1) and date(sw.dateinstalled) <= current_date group by all) sw on sw.system_id = sys.system_id
left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by ALL)vulDays on ss.system_id = vulDays.system_id
 left join (select system_acronym, count(ID) COUNT_FINDINGS from APP_AWS_SECURITY_HUB.PUBLIC.SEC_VW_AWS_SECURITYHUB_ALL where PRODUCTNAME in ('config','Security Hub') and WORKFLOW_STATUS = 'NEW' group by all) sh on sh.system_acronym = ss.ACRONYM 
;
create or replace view VW_DAILYDATACHECK(
	TABLENAME,
	REPORT_ID,
	REFRESH_DATE
) as
select 'RPT.ASSETDETAIL' as TableName, max(r.report_id) report_id, max(refresh_date) as Refresh_date from RPT.ASSETDETAIL ad
join core.report_ids r on date(r.report_date) = date(ad.refresh_date)
UNION
select 'RPT.TEMP_VULN_TRENDING' as TableName, max(report_id) report_id, max(refresh_date) as Refresh_date from rpt.TEMP_VULN_TRENDING
UNION
select 'RPT.TEMP_VULN_FV_ROLLING60DAYS' as TableName, max(r.report_id) report_id, max(refresh_date) as Refresh_date from rpt.TEMP_VULN_FV_ROLLING60DAYS vr
join core.report_ids r on date(r.report_date) = date(vr.refresh_date)
UNION
select 'CORE.SYSTEMSUMMARY' as TableName, max(ss.report_id) report_id, max(report_date) as Refresh_date from core.systemsummary ss
join core.report_ids r on r.report_id = ss.report_id
UNION
select 'CORE.VULHIST' as TableName, max(vh.report_id) report_id, max(report_date) as Refresh_date from core.vulhist vh
join core.report_ids r on r.report_id = vh.report_id
UNION
select 'CORE.ASSETHIST' as TableName, max(ah.report_id) report_id, max(report_date) as Refresh_date from core.assethist ah
join core.report_ids r on r.report_id = ah.report_id
UNION
select 'CORE.POAMHIST' as TableName, max(ph.report_id) report_id, max(report_date) as Refresh_date from core.poamhist ph
join core.report_ids r on r.report_id = ph.report_id
UNION
select 'CORE.ALLOCATEDCONTROL' as TableName, max(AC.report_id) report_id, max(report_date) as Refresh_date from core.allocatedcontrol AC
join core.report_ids r on r.report_id = AC.report_id
;
create or replace view VW_DATAQUALITY_6M(
	DATACENTER_ID,
	SYSTEM_ID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ACRONYM,
	ACR_ALIAS,
	DATACENTER,
	DCACR_ALIAS,
	TATOO_COUNT,
	TOTAL_ASSET,
	ASSET_ID_TATTOO_PCT,
	DC_ID_DERIVED_COUNT,
	DATACENTER_ID_DERIVED_PCT,
	P_FISMA_ID_TATTOO_COUNT,
	PRIMARY_FISMA_ID_TATTOO_PCT,
	P_FISMA_ID_DERIVED_COUNT,
	PRIMARY_FISMA_ID_DERIVED_PCT,
	FQDN_COUNT,
	FQDN_PCT,
	HOSTNAME_COUNT,
	HOSTNAME_PCT,
	MAC_COUNT,
	MAC_PCT,
	MOTHERBOARD_SN_COUNT,
	MOTHERBOARD_SN_PCT,
	NETBIOS_HN_COUNT,
	NETBIOS_HN_PCT,
	OS_COUNT,
	TOTAL_OS,
	OS_PCT,
	TLC_PHASE,
	IS_MARKETPLACE,
	MEFSTATUS,
	HVASTATUS,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TIMELINESS_PCT,
	BIGFIX_ASSET_ID_COUNT,
	BIGFIX_ASSET_ID_PCT,
	OS_CPE_COUNT,
	OS_CPE_PCT,
	BIOS_GUID_COUNT,
	BIOS_GUID_PCT,
	INSTANCESTATUS_COUNT,
	INSTANCESTATUS_PCT,
	IPV4_COUNT,
	IPV4_PCT,
	IPV6_COUNT,
	IPV6_PCT,
	REPORT_ID,
	REPORT_DATE
) COMMENT='Used for Tableau in Data Quality Dashboard:  Showing HWAM data based on completeness and Timeliness'
 as
with
ReportIDs as ((select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union
	select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=6)),
    
Snapshots as (select Report_ID,
	r.Report_Date
	from ReportIDs r) 
 --  select * from  Snapshots
    
select distinct
ah.datacenter_id,
ah.System_Id,
S.Component_Acronym as Component_Acronym
,S.Group_Acronym as Group_Acronym
,S.Acronym as Acronym
,CONCAT(SUBSTR(S.Acronym, 1, 1), '***') as Acr_Alias
,data_center.Acronym DataCenter
,CONCAT(SUBSTR(data_center.Acronym, 1, 1), '***') as DCAcr_Alias
--,dense_rank()over(order by report_id desc) as rankk,
,tatoo.tatoo_count
,tl.total_asset total_asset
,asset_id_tattoo_PCT
,dc_id_derived_count
,datacenter_id_derived_PCT
,p_fisma_id_tattoo_count
,primary_fisma_id_tattoo_PCT
,p_fisma_id_derived_count
,primary_fisma_id_derived_PCT
,fqdn_count
,fqdn_PCT
,hostname_count
,hostname_PCT
,Mac_count
,Mac_PCT
,motherboard_sn_count
,motherboard_sn_PCT
,netbios_hn_count
,netbios_hn_PCT
,os.os_count
,os.total_os
,os.os_PCT
--,s.AWS_accountIds CR #1044 241209
,s.TLC_Phase
,s.Is_MarketPlace
,s.MEFStatus
,s.HVAStatus
,tl.Count_less72Hrs
,tl.Count_greater72Hrs
,case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
end as Timeliness_PCT
,bigfix_asset_id_count
,bigfix_asset_id_PCT
,os_cpe_count
,os_cpe_PCT
,bios_guid_count
,bios_guid_PCT
,InstanceStatus_count
,InstanceStatus_PCT
,ipv4_count
,ipv4_PCT
,ipv6_count
,ipv6_PCT
,snap.report_id
,snap.report_date
--,coalesce(ah.AWS_ACCOUNTID,ah.AZURE_SUBSCRIPTION_ID) as CLOUD_ACCOUNT_ID -- 241125 CR1038 CR#1044 241209
--,getdate() as RefreshDate
from core.Asset a
JOIN core.ASSETHIST ah on ah.dw_asset_id = a.dw_asset_id --and a.Is_Applicable = 1 and ah.Is_Applicable = 1
join Snapshots snap on snap.report_id = ah.report_id
left join (select System_Id, datacenter_id, report_id, sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id) total_asset, count(asset_id_tattoo) tatoo_count 
,case when count(a.dw_asset_id) != 0 then
ROUND(count(asset_id_tattoo)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as asset_id_tattoo_PCT
,count(datacenter_id) dc_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(datacenter_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  datacenter_id_derived_PCT
,count(system_id) p_fisma_id_tattoo_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  primary_fisma_id_tattoo_PCT
,count(system_id) p_fisma_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  primary_fisma_id_derived_PCT
,count(motherboard) motherboard_sn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(motherboard)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  motherboard_sn_PCT
,count(bigfix_asset_id) bigfix_asset_id_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bigfix_asset_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  bigfix_asset_id_PCT
,count(bios_guid) bios_guid_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bios_guid)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  bios_guid_PCT
,count(os_cpe) os_cpe_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(os_cpe)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  os_cpe_PCT
from core.VW_ASSETHIST a
where a.devicetype in (select devicetype from core.DEVICETYPES dv where dv.devicetype in ('Server', 'Workstation', 'Computer','Laptop'))
Group by System_Id, datacenter_id, a.report_id) tatoo on tatoo.System_Id = ah.System_Id
and tatoo.datacenter_id = ah.datacenter_id and tatoo.report_id = snap.report_id
left join (select a.System_Id, a.datacenter_id, ac.report_id
,count(fqdn) fqdn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(fqdn)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  fqdn_PCT
,count(hostname) hostname_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(hostname)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  hostname_PCT
,count(MACADDRESS) Mac_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(MACADDRESS)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  Mac_PCT
,count(ipv4) ipv4_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv4)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  ipv4_PCT
,count(ipv6) ipv6_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv6)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  ipv6_PCT
from core.AssetInterfaceCoalescedHist ac
join core.Asset a on a.dw_asset_id = ac.dw_asset_id group by a.System_Id, datacenter_id, ac.report_id
) aic on aic.System_Id = ah.System_Id and aic.datacenter_id = ah.datacenter_id
and aic.report_id = snap.report_id

--added to limit the count to Windows OS 1/13/2024
left join (select aah.System_Id, aah.datacenter_id, aah.report_id,count(NETBIOSNAME) netbios_hn_count
,case when count(aah.dw_asset_id) != 0 then
ROUND(count(NETBIOSNAME)*100.0/sum(count(aah.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  netbios_hn_PCT
from core.VW_ASSETHIST aah
where aah.os is not null and aah.os like '%Windows%'
group by System_Id, datacenter_id, aah.report_id
) netbios on netbios.System_Id = ah.System_Id
and netbios.datacenter_id  = ah.datacenter_id and netbios.report_id = snap.report_id
/***********************/

left join (select aah.System_Id, aah.datacenter_id, aah.report_id, count(os) os_count, sum(count(os)) over(PARTITION BY aah.datacenter_id,aah.System_Id, aah.report_id) total_os
,ROUND(count(os)*100.0/sum(count(dw_asset_id)) over(PARTITION BY aah.datacenter_id,aah.System_Id, aah.report_id),1) as  os_PCT
from core.VW_ASSETHIST aah
where aah.os is not null
group by System_Id, datacenter_id, aah.report_id
) os on os.System_Id = ah.System_Id
and os.datacenter_id  = ah.datacenter_id and os.report_id = snap.report_id
left join (select ah.System_Id, report_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah
group by System_Id, ah.report_id
) tl on tl.System_Id = ah.System_Id and tl.report_id = snap.report_id
left join (
select 
System_Id, datacenter_id, ah.report_id, count(aws_instancestatus) InstanceStatus_count 
,case when count(aws_instancestatus) != 0 then
ROUND(count(aws_instancestatus)*100.0/sum(count(aws_instancestatus)) over(PARTITION BY datacenter_id, System_Id, ah.report_id),1) 
else null end as InstanceStatus_PCT
from core.VW_ASSETHIST ah
--join Snapshots snap on snap.report_id = ah.report_id
where source_tool_hwam = 'AWS HWAM'
group by System_Id, datacenter_id, ah.report_id
)IStat on IStat.System_Id = ah.System_Id and IStat.datacenter_id  = ah.datacenter_id and IStat.report_id = snap.report_id
right outer join (select System_Id, Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,
	Group_Acronym,TLC_Phase, Is_ExcludeFromReporting,
	--cast(substring(AWS_accountIds,1,2000) as varchar(2000)) as AWS_accountIds CR #1044
    from CORE.VW_SYSTEMS 
	where Is_PhantomSystem=0 and Is_ExcludeFromReporting =0) S ON S.System_Id = ah.System_Id --and Is_ExcludeFromReporting = 0
left join (select System_Id, Acronym, AWS_accountIds from CORE.VW_SYSTEMS) data_center ON data_center.System_Id = ah.datacenter_id
where ah.System_Id is not null;
create or replace view VW_HOSTCOUNT_EPSS(
	CVE,
	KEV,
	"CVSS Score",
	"EPSS SCORE (%)",
	"TOTAL ASSETS"
) as
SELECT CVE
    ,is_bod KEV
    ,cvss3basescore "CVSS Score"
	,epss.epss "EPSS SCORE (%)"
    ,count(FK_ASSETID) "TOTAL ASSETS"
    FROM RPT.TEMP_VULN_FV_ROLLING60DAYS vuln
    LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vuln.cve
    where rankk = 1 and epss is not null and mitigationstatus <> 'fixed' and cvss3basescore >=5
    group by CVE,is_bod, cvss3basescore, epss.epss
    order by epss desc limit 12
    ;
create or replace view VW_HRS_COMPLIANCE(
	ACRONYM,
	COMPONENT_ACRONYM,
	FIPS_199_OVERALL_IMPACT_RATING,
	AUTH_DECISION,
	HVASTATUS,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	OA_STATUS,
	OATO_CATEGORY,
	OATO_CATEGORY_DESC,
	TLC_PHASE,
	TOTALASSETS,
	REPORT_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	RANKK
) COMMENT='Used for Tableau in High Risk Summary Report: System and OA details'
 as
SELECT 
s.Acronym
,s.COMPONENT_ACRONYM
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.AUTH_DECISION
,s.HVASTATUS
,IFF(s.IS_OA_READY=1,'Yes','No') Is_OA_Ready
,s.IS_OPERATIONALSYSTEM
,s.OA_STATUS
,s.OATO_CATEGORY
,src.DESCRIPTION OATO_Category_desc
,s.TLC_PHASE
,ss.Assets as TotalAssets
,vsnap.Report_Date Report_Date
,s.DATE_AUTH_MEMO_EXPIRES
,dense_rank()over(order by ss.report_id desc) as rankk
FROM CORE.VW_SYSTEMS s
JOIN (select report_id, system_id, assets  from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join (select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap on vsnap.Report_ID = ss.report_id
JOIN CORE.SystemRiskCategory src on s.oato_category = src.systemriskcategory_id;
create or replace view VW_HRS_HWAMCOUNT(
	COMPONENTACRONYM,
	HWAM_PCT
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Asset details'
 as
select ComponentAcronym,
cast ( Y / (Y + N ) as DECIMAL(18, 4))*100   hwam_pct
from
(
select "Component_Acronym" ComponentAcronym, cast(sum(case when (HWAM_CNT)<>0 then 1 else 0 end)as DECIMAL(18, 4)) as Y,
cast(sum(case when (HWAM_CNT)=0 then 1 else 0 end)as DECIMAL(18, 4))  as N
 from(
select  "Component_Acronym","System", sum("Total Assets") HWAM_CNT
from  rpt.V_CyberRisk_System_Summary
group by "Component_Acronym","System" ) A
group by "Component_Acronym"
)B;
create or replace view VW_HRS_POAM(
	COMPONENT_ACRONYM,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_DECISION,
	AVG_DAYS_OPEN,
	WEAKNESS_RISK_LEVEL
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Poam data'
 as
SELECT  Component_Acronym ,Acronym,syst.Archer_Tracking_ID,Auth_Decision,(cast(days_open as numeric)) as avg_days_open,weakness_risk_level
FROM	CORE.VW_SYSTEMS syst
		left outer join CORE.VW_POAMS poam 
		on (syst.Archer_Tracking_ID =poam.archer_tracking_id 
		and Poam.overall_status in ('Delayed','Ongoing','Draft')
		and  weakness_risk_level in ('Critical','High','Low','Moderate'))
where	Component_Acronym IS NOT NULL
		and syst.TLC_Phase = 'Operate';
create or replace view VW_HRS_VULNDATA(
	SYSTEM_ID,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_PACKAGE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	COUNT,
	ISSO,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SCA,
	SCA_DATE,
	SDM,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD,
	NEXT_REQUIRED_CP_TEST_DATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	AWS_ACCOUNTIDS,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	CISO_REVIEW_DATE,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	CRA_REVIEW_DATE,
	DIVISION_DESCRIPTION,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	FIRST_PUBLISHED_DATE,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	PIA_014,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SOP_REVIEW_DATE,
	REMEDIATED_VULN,
	DELAYED_VUL,
	FISMASEVERITY,
	CNT
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Vulnerability data'
 as
select 
	main.SYSTEM_ID,
	main.Acronym,
	main.Archer_Tracking_ID,
	main.Auth_Comments,
	main.Auth_Decision,
	main.Authorization_Package,
	main.Business_Owner,
	main.CIO,
	main.CISO,
	main.Cloud_Service_Provider,
	main.CommonName,
	main.Component_Acronym,
	main.Component_Risk_Reports_Oversight,
	main.ContingencyExpirationDate,
	main.CP_Test_Date,
	main.CP_Test_Results,
	main.CRA,
	main.CyberVet,
	main.Date_Auth_Memo_Expires,
	main.Date_Auth_Memo_Signed,
	main.dateDeleted,
	main.dateModified,
	main.DCISO,
	main.Division_Acronym,
	--main.DivisionName,
	main.E_AUTH_EXP_DATE,
	main.E_AUTH_LEVEL,
	main.E_AUTH_RISK_ASSESSMENT_DATE,
	main.Financial_System,
	main.FIPS_199_Availability_Rating,
	main.FIPS_199_Confidentiality_Rating,
	main.FIPS_199_Integrity_Rating,
	main.FIPS_199_Overall_Impact_Rating,
	main.FISMA_System,
	main.Group_Acronym,
	main.HVA_Score,
	main.HVAStatus,
	main.In_CMS_Cloud,
	main.Information_System_Type,
	main.Is_DataCenter,
	main.Is_ExcludeFromReporting,
	main.Is_HighRiskSystem,
	main.Is_MarketPlace,
	main.Is_OA_Ready,
	main.Is_OperationalSystem,
	main.Is_PhantomSystem,
	main.Is_SecurityHub_Enabled,
	main.ISRA_REVIEW_DATE,
	main.ISRA_Status,
	main.ISSO Count,
	main.ISSO,
	main.ISSOCS,
	main.Last_ACT_Date,
	main.Last_Pentest_Date,
	main.MEF,
	main.MEF_Context,
	main.MEFStatus,
	main.OA_Status,
	main.OATO_Category,
	main.Package_Type,
	main.PIA_Expiration_Date,
	main.PII_PHI,
	main.Primary_ISSO,
	main.Primary_Operating_Location,
	main.SCA,
	main.SCA_Date,
	main.SDM,
	main.STE_DATE,
	main.System_Description,
	main.TLC_Phase,
	main.TotalAssets,
	main.TotalPOAMwithApprovedRBD,
	main.Next_Required_CP_Test_Date,
	main.Control_Set_Version_Number_System_Provid,
	main.AWS_accountIds,
	main.ATO_EXPIRATION_DATE,
	main.ATO_REVIEW_DATE,
	main.AUTHORIZATION_MEMO_SIGNED_DATE,
	main.BO_RECOMMENDATION_REVIEW_DATE,
	main.BO_REVIEW_DATE,
	main.CISO_REVIEW_DATE,
	main.COMPONENT_DESCRIPTION,
	main.COMPONENT_NAME,
	main.CRA_REVIEW_DATE,
	main.DIVISION_DESCRIPTION,
	main.DSPC_REVIEW_DATE,
	main.DSPPO_REVIEW_DATE,
	main.FIRST_PUBLISHED_DATE,
	main.GROUP_DESCRIPTION,
	main.GROUP_NAME,
	main.ISSO_REVIEW_DATE,
	main.ISSO_SUBMISSION_DATE,
	main.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	main.LAST_ACT_SCA_FINAL_REPORT_DATE,
	main.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	main.PIA_014,
	main.PRIMARY_OPERATING_LOCATION_ACRONYM,
	main.PRIMARY_OPERATING_LOCATION_ID,
	main.REASON_FOR_ATO_REQUEST,
	main.SOP_REVIEW_DATE

,a.REMEDIATED_VULN
,a.DELAYED_VUL
,a.FISMAseverity
,cnt  from CORE.VW_SYSTEMS main

left outer join (select
s.Component_Acronym,
s.Acronym,
v.FISMAseverity,
vm.datemitigated,
SUM(case when v.MitigationStatus = 'Fixed' and vm.datemitigated between DATEADD(day, -(day(CURRENT_DATE()-2)), dateadd(month, -1, CURRENT_DATE()-1)) and 
DATEADD(day, -(day(CURRENT_DATE())), CURRENT_DATE())   then 1 else 0 end) as Remediated_Vuln,
SUM(case when v.MitigationStatus <> 'Fixed' and  v.DaysSinceDiscovery > 90 then 1 else 0 end) as Delayed_Vul,
count(*) as cnt
-- Delayed should be based on this DaysSinceDiscovery
FROM CORE.VW_VULHIST v 
join (select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap
on v.report_id = vsnap.Report_ID
JOIN (select dw_vul_id, datemitigated from CORE.VW_VULMASTER) vm on vm.dw_vul_id = v.dw_vul_id
JOIN (select system_id, component_acronym, acronym from CORE.VW_SYSTEMS) s on s.system_id = v.system_id
where v.FISMAseverity in ('Critical','High') 
GROUP BY s.Component_Acronym
,v.FISMAseverity,Acronym,vm.datemitigated)a

on (a.Component_Acronym = main.Component_Acronym and a.Acronym=main.Acronym)
where TLC_Phase = 'Operate';
create or replace view VW_LANDINGPAGE(
	REPORT_ID,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	ASSETS_AWS_GOVCLOUD,
	VUL_OPEN,
	VUL_REOPENED,
	RESILIENCYSCORE,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_MONTHTODATE,
	VULNRISKTOLERANCE,
	POAM_COUNT,
	COUNT_TRADITIONAL,
	COUNT_NONTRADITIONAL,
	COUNT_OAREADY,
	COUNT_OANOTREADY,
	COUNT_EXPIRING_CPT,
	COUNT_EXPIRED_CPT,
	COUNT_EXPIRING_ATO,
	COUNT_EXPIRED_ATO,
	COUNT_SOFTWAREINSTALLED,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TIMELINESS_PCT
) as
select 
    rids.report_id, 
    rids.report_date, 
    rids.assets, 
    rids.assets_aws, 
    rids.assets_aws_govcloud,
    vulopen.vul_open, 
    vulopen.vul_reopened,
    vulopen.resiliencyscore,
    ss.KEV_OPEN,
    ss.KEV_REOPENED,
    ss.KEV_FIXED_MONTHTODATE,
    ss.vulnrisktolerance,
    p.POAM_COUNT,
    count_Traditional,
    count_NonTraditional,
    count_OAReady,
    count_OANotReady,
    (select count(distinct system_id) from core.vw_systems where next_required_cp_test_date >= current_date and next_required_cp_test_date <= (current_date + 90) and tlc_phase <> 'Retire') count_expiring_CPT,
    (select count(distinct system_id) from core.vw_systems where next_required_cp_test_date < current_date and tlc_phase <> 'Retire') count_expired_CPT,
    (select count(distinct system_id) from core.vw_systems where DATE_AUTH_MEMO_EXPIRES >= current_date and DATE_AUTH_MEMO_EXPIRES <= (current_date + 90) and tlc_phase <> 'Retire') count_expiring_ATO,
    (select count(distinct system_id) from core.vw_systems where DATE_AUTH_MEMO_EXPIRES < current_date and tlc_phase <> 'Retire') count_expired_ATO,
    (SELECT count(sw.DW_ASSET_ID) from CORE.VW_ASSET_SOFTWARE sw where sw.dateinstalled >= (select max(report_date) from core.report_ids where is_endofmonth = 1)) Count_SoftwareInstalled,
    Count_less72Hrs,
    Count_greater72Hrs,
    ROUND(Count_less72Hrs*100.0/tl.total_asset,1) Timeliness_PCT
from core.report_ids rids
join (select report_id, count(poam_id) POAM_COUNT from core.vw_poamhist where report_id in 
(select max(report_id) from core.report_ids where is_endofmonth = 0 UNION select max(report_id) from core.report_ids where is_endofmonth = 1) 
and overall_status not in ('Completed', 'Pending Verification')
group by all) p on p.report_id = rids.report_id
Join (select report_id, sum(vul_high_open +vul_critical_open+vul_medium_open+vul_low_open) vul_open, sum(vul_high_reopened + vul_critical_reopened + vul_medium_reopened + vul_low_reopened) vul_reopened, avg(resiliencyscore) resiliencyscore
from core.vw_systemsummary 
group by all) vulopen on vulopen.report_id = p.report_id
join (select report_id, sum(kev_open) KEV_OPEN, sum(kev_reopened) kev_reopened, sum(kev_fixed_monthtodate) kev_fixed_monthtodate, avg(vulnrisktolerance) vulnrisktolerance from core.vw_systemsummary where assets <> 0
group by all) ss on ss.report_id = p.report_id
JOIN (select report_id, count(1) count_Traditional from core.systemshist where OA_STATUS = 'Traditional' and tlc_phase = 'Operate' group by report_id) OASTAT on OASTAT.report_id = p.report_id
JOIN (select report_id, count(1) count_NonTraditional from core.systemshist where OA_STATUS != 'Traditional' and tlc_phase = 'Operate' group by report_id) OANSTAT on OANSTAT.report_id = p.report_id
JOIN (select report_id, count(1) count_OAReady from core.systemshist where IS_OA_READY = 1 and tlc_phase = 'Operate' group by report_id) OAREADY on OAREADY.report_id = p.report_id
JOIN (select report_id, count(1) count_OANotReady from core.systemshist where IS_OA_READY = 0 and tlc_phase = 'Operate' group by report_id) OANREADY on OANREADY.report_id = p.report_id
JOIN (select distinct
report_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY report_id) total_asset
from core.VW_ASSETHIST ah
group by ah.report_id) tl on tl.report_id = p.report_id
;
create or replace view VW_MARKETPLACE_OVERDUE_VRAD(
	COMPONENT_ACRONYM,
	SYSTEM_ID,
	FISMA_ID,
	ACRONYM,
	TLC_PHASE,
	OATO_CATEGORY,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DATACENTER_ID,
	AWS_ACCOUNTIDS,
	CVE,
	DW_VUL_ID,
	TENABLEUUID,
	PLUGINID,
	FAMILYNAME,
	SIGNATURE,
	SOLUTION,
	FISMASEVERITY,
	CVSS3BASESCORE,
	EPSS,
	EPSS_FILTER,
	EPSS_PERCENTILE,
	MITIGATIONSTATUS,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	OVERDUE_FILTER,
	IS_BOD,
	BODDUEDATE,
	SENSOR_FIRSTSEEN,
	SENSOR_LASTFOUND,
	EXPLOITAVAILABLE,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	ENVIRONMENT,
	COMPUTER_TYPE,
	DEVICETYPE,
	IPV4,
	IPV6,
	HOSTNAME,
	FQDN,
	OS,
	OS_VERSION,
	MAC,
	NETBIOSNAME,
	BIOS_GUID,
	SOURCE_TOOL,
	VULNRISKTOLERANCE,
	REFRESH_DATE,
	SNAPSHOT_ID
) COMMENT='provides overdue vulns and related asset details for Marketplace Systems only'
 as
select 
	COMPONENT_ACRONYM,
    SYSTEM_ID,
    FISMA_ID,
    ACRONYM,
    TLC_PHASE,
    OATO_CATEGORY,
    IS_MARKETPLACE,
    HVASTATUS,
    MEFSTATUS,
    DATA_CENTER_NAME,
    DATACENTER_ID,
    AWS_ACCOUNTIDS,
    CVE,
    DW_VUL_ID,
    TENABLEUUID,
    PLUGINID,
    FAMILYNAME,
    SIGNATURE,
    SOLUTION,
    FISMASEVERITY,
    CVSS3BASESCORE,
    EPSS,
    EPSS_FILTER,
    PERCENTILE EPSS_PERCENTILE,
    MITIGATIONSTATUS,
    DATEMITIGATED,
    DAYSSINCEDISCOVERY,
    DAYSSINCEDISCOVERY_FILTER,
    OVERDUE_FILTER,
    IS_BOD,
    BODDUEDATE,
    SENSOR_FIRSTSEEN,
    SENSOR_LASTFOUND,
    EXPLOITAVAILABLE,
    DW_ASSET_ID,
    ASSET_ID_TATTOO,
    ENVIRONMENT,
    COMPUTER_TYPE,
    DEVICETYPE,
    IPV4,
    IPV6,
    HOSTNAME,
    FQDN,
    OS,
    OS_VERSION,
    MAC,
    NETBIOSNAME,
    BIOS_GUID,
    SOURCE_TOOL,
    VULNRISKTOLERANCE,
    REFRESH_DATE,
    SNAPSHOT_ID
 from RPT.VW_ASSETDETAIL_ROLLING60DAYS asst
where is_marketplace = 1 and lower(MitigationStatus) in ('open', 'reopened')
and ((Asst.FISMASEVERITY = 'Critical' and Asst.DAYSSINCEDISCOVERY > 15) OR
    (Asst.FISMASEVERITY = 'High' and Asst.DAYSSINCEDISCOVERY > 30) OR
    (Asst.FISMASEVERITY = 'Medium' and Asst.DAYSSINCEDISCOVERY > 90) OR
    (Asst.FISMASEVERITY = 'Low' and Asst.DAYSSINCEDISCOVERY > 365))
;
create or replace view VW_SEC_LANDINGPAGE(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	ACRONYM,
	NEXT_REQUIRED_CP_TEST_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	TLC_PHASE,
	ASSETS,
	VUL_OPEN,
	VUL_REOPENED,
	RESILIENCYSCORE,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_MONTHTODATE,
	VULNRISKTOLERANCE,
	POAM_COUNT,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TOTAL_ASSET,
	TIMELINESS_PCT,
	COUNT_SOFTWAREINSTALLED,
	VULN_OVERDUE,
	COUNT_FINDINGS,
	COUNT_PHISHING_RES_LOGIN,
	COUNT_TOTALLOGIN
) as
select 
    rids.report_id,
    rids.report_date,
    sys.system_id,
    sys.acronym,
    sys.next_required_cp_test_date,
    sys.DATE_AUTH_MEMO_EXPIRES,
    sys.is_oa_ready,
    sys.oa_status,
    Sys.tlc_phase,
    ss.assets, 
    vulopen.vul_open, 
    vulopen.vul_reopened,
    ss.resiliencyscore,
    ss.KEV_OPEN,
    ss.KEV_REOPENED,
    ss.KEV_FIXED_MONTHTODATE,
    ss.vulnrisktolerance,
    p.POAM_COUNT,
    Count_less72Hrs,
    Count_greater72Hrs,
    total_asset,
    case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
    end as Timeliness_PCT,
    Count_SoftwareInstalled,
    CRITICALGT15+HIGHGT30+MODERATEGT90+LOWGT365 as VULN_OVERDUE,
    COUNT_FINDINGS,
    (select sum(piv+fido2+zscaler) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS where date(authndate) >= DATE_TRUNC(month, CURRENT_DATE())) as COUNT_PHISHING_RES_LOGIN,
    (select sum(EMAIL+FIDO2+OKTAOTP+OKTAPUSH+OTP+PHONE+PIV+SMS+ZSCALER) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS where date(authndate) >= DATE_TRUNC(month, CURRENT_DATE())) as COUNT_TOTALLOGIN
from (select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 0 UNION select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 1) rids
JOIN (select report_id, system_id, sum(vul_high_open +vul_critical_open+vul_medium_open+vul_low_open) vul_open, sum(vul_high_reopened + vul_critical_reopened + vul_medium_reopened + vul_low_reopened) vul_reopened from core.vw_systemsummary group by all) vulopen on vulopen.report_id = rids.report_id
left outer join (select report_id, system_id, acronym, assets, resiliencyscore, kev_open KEV_OPEN, kev_reopened kev_reopened, kev_fixed_monthtodate kev_fixed_monthtodate, vulnrisktolerance vulnrisktolerance from core.vw_systemsummary where assets <> 0) ss on vulopen.system_id = ss.system_id and ss.report_id = rids.report_id
left outer join (select report_id, system_id, count(poam_id) POAM_COUNT from core.vw_poamhist where overall_status not in ('Completed', 'Pending Verification') 
group by all) p on vulopen.system_id = p.system_id and p.report_id = rids.report_id
left outer JOIN (select distinct
report_id, system_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah 
group by all) tl on vulopen.system_id = tl.system_id and tl.report_id = rids.report_id
join core.vw_systems sys on sys.system_id = vulopen.system_id
left outer join (SELECT system_id, count(distinct sw.DW_ASSET_ID) Count_SoftwareInstalled from CORE.VW_ASSET_SOFTWARE sw where date(sw.dateinstalled) >= (select max(date(report_date)) from core.report_ids where is_endofmonth = 1) and date(sw.dateinstalled) <= current_date group by all) sw on sw.system_id = sys.system_id
left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by ALL)vulDays on ss.system_id = vulDays.system_id
 left join (select system_acronym, count(ID) COUNT_FINDINGS from APP_AWS_SECURITY_HUB.PUBLIC.SEC_VW_AWS_SECURITYHUB_ALL where PRODUCTNAME in ('config','Security Hub') and WORKFLOW_STATUS = 'NEW' group by all) sh on sh.system_acronym = ss.ACRONYM 
;
create or replace view VW_SEC_LANDINGPAGE2(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	ACRONYM,
	NEXT_REQUIRED_CP_TEST_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	TLC_PHASE,
	ASSETS,
	VUL_OPEN,
	VUL_REOPENED,
	RESILIENCYSCORE,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_MONTHTODATE,
	VULNRISKTOLERANCE,
	POAM_COUNT,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TOTAL_ASSET,
	TIMELINESS_PCT,
	COUNT_SOFTWAREINSTALLED,
	VULN_OVERDUE,
	COUNT_FINDINGS
) as
select 
    rids.report_id,
    rids.report_date,
    sys.system_id,
    sys.acronym,
    sys.next_required_cp_test_date,
    sys.DATE_AUTH_MEMO_EXPIRES,
    sys.is_oa_ready,
    sys.oa_status,
    Sys.tlc_phase,
    ss.assets, 
    vulopen.vul_open, 
    vulopen.vul_reopened,
    ss.resiliencyscore,
    ss.KEV_OPEN,
    ss.KEV_REOPENED,
    ss.KEV_FIXED_MONTHTODATE,
    ss.vulnrisktolerance,
    p.POAM_COUNT,
    Count_less72Hrs,
    Count_greater72Hrs,
    total_asset,
    case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
    end as Timeliness_PCT,
    Count_SoftwareInstalled,
    CRITICALGT15+HIGHGT30+MODERATEGT90+LOWGT365 as VULN_OVERDUE,
    COUNT_FINDINGS
from (select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 0 UNION select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 1) rids
JOIN (select report_id, system_id, sum(vul_high_open +vul_critical_open+vul_medium_open+vul_low_open) vul_open, sum(vul_high_reopened + vul_critical_reopened + vul_medium_reopened + vul_low_reopened) vul_reopened from core.vw_systemsummary group by all) vulopen on vulopen.report_id = rids.report_id
left outer join (select report_id, system_id, acronym, assets, resiliencyscore, kev_open KEV_OPEN, kev_reopened kev_reopened, kev_fixed_monthtodate kev_fixed_monthtodate, vulnrisktolerance vulnrisktolerance from core.vw_systemsummary where assets <> 0) ss on vulopen.system_id = ss.system_id and ss.report_id = rids.report_id
left outer join (select report_id, system_id, count(poam_id) POAM_COUNT from core.vw_poamhist where overall_status not in ('Completed', 'Pending Verification') 
group by all) p on vulopen.system_id = p.system_id and p.report_id = rids.report_id
left outer JOIN (select distinct
report_id, system_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah 
group by all) tl on vulopen.system_id = tl.system_id and tl.report_id = rids.report_id
join core.vw_systems sys on sys.system_id = vulopen.system_id
left outer join (SELECT system_id, count(distinct sw.DW_ASSET_ID) Count_SoftwareInstalled from CORE.VW_ASSET_SOFTWARE sw where date(sw.dateinstalled) >= (select max(date(report_date)) from core.report_ids where is_endofmonth = 1) and date(sw.dateinstalled) <= current_date group by all) sw on sw.system_id = sys.system_id
left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by ALL)vulDays on ss.system_id = vulDays.system_id
 left join (select system_acronym, count(ID) COUNT_FINDINGS from APP_AWS_SECURITY_HUB.PUBLIC.SEC_VW_AWS_SECURITYHUB_ALL where PRODUCTNAME in ('config','Security Hub') and WORKFLOW_STATUS = 'NEW' group by all) sh on sh.system_acronym = ss.ACRONYM 
;
create or replace view VW_SEC_USERSYSMAPPING_VATDC(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ACRONYM,
	SYSTEM_ID,
	USERID
) COMMENT='Security view for specifically crated for Data center users (Details provided by VAT team)'
 as
select distinct
 A.DATACENTER_ACRONYM --as "DataCenter Acronym"
,A.DATACENTER_ID --as "DataCenterUID"
,S.Acronym --as "System Acronym"
,S.SYSTEM_ID --as "SystemUID"
,SU.UserId --as "UserName"
from CORE.VW_SYSTEMS S
join CORE.VW_ASSETS A on A.system_id = S.system_id
join rpt.VAT_SYSTEMUSERS SU on S.SYSTEM_ID = SU.SYSTEM_ID
where S.Is_ExcludeFromReporting = 0 and S.Is_PhantomSystem=0 and SU.UserId is not null
;
create or replace view VW_VATOPS_WKLY_STATUS(
	REPORT_ID,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	IS_BOD,
	CVE,
	CVSSV3BASESCORE,
	EPSS,
	TOTALVULCOUNT,
	VUL_FIXED_TODAY,
	ASSETS_SCANNED
) as
SELECT t.REPORT_ID
    ,t.REPORT_DATE
    ,RI.ASSETS
    ,RI.ASSETS_AWS
    ,t.FISMASEVERITY
    ,t.MITIGATIONSTATUS
    ,t.IS_BOD
    ,t.CVE
    ,t.CVSSV3BASESCORE
    ,epss.EPSS
    ,t.TOTALVULCOUNT
    ,VUL_FIXED_TODAY
    ,ASSETS_SCANNED
FROM (
(select REPORT_ID, REPORT_DATE, FISMASEVERITY, MITIGATIONSTATUS, IS_BOD, CVSSV3BASESCORE, cve,count(1) TOTALVULCOUNT 
from CORE.VW_VULHIST group by REPORT_ID, REPORT_DATE,FISMASEVERITY,MITIGATIONSTATUS,IS_BOD,cvssv3basescore,cve order by count(1) DESC)
) t
Join (select top 31 REPORT_ID, ASSETS, ASSETS_AWS + ASSETS_AWS_GOVCLOUD as ASSETS_AWS, VUL_FIXED_TODAY, ASSETS ASSETS_SCANNED from CORE.REPORT_IDS order by REPORT_ID desc) RI on RI.REPORT_ID = t.REPORT_ID 
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = t.cve
order by t.REPORT_ID DESC
;
create or replace view VW_VATOPS_WKLY_SYSTEMS_STATUS(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	SYSTEM_ACRONYM,
	ASSETS,
	ASSETS_SCANNED
) as
SELECT t.REPORT_ID
    ,t.REPORT_DATE
    ,t.SYSTEM_ID
    ,t.SYSTEM_ACRONYM
    ,t.ASSETS
    ,t.ASSETS ASSETS_SCANNED
FROM (
(select REPORT_ID, REPORT_DATE, SYSTEM_ID, SYSTEM_ACRONYM, count(1) ASSETS 
from CORE.VW_ASSETHIST group by REPORT_ID, SYSTEM_ACRONYM, REPORT_DATE, SYSTEM_ID order by count(1) DESC)
) t
Join (select top 31 REPORT_ID, REPORT_DATE from CORE.REPORT_IDS order by REPORT_ID desc) RI on RI.REPORT_ID = t.REPORT_ID 
order by t.REPORT_ID DESC
;
create or replace view VW_VULCURR_DETAIL(
	SYSTEM_ID,
	SYSTEMACRONYM,
	CVE,
	DAYSSINCEDISCOVERY,
	FISMASEVERITY,
	DAYSSINCEDISCOVERY_FILTER,
	EPSS,
	EPSS_FILTER,
	PERCENTILE
) COMMENT='current statistics over all vulns including EPSS metrics for CR#959'
 as
SELECT 
s.SYSTEM_ID
,s.Acronym as SystemAcronym
,v.cve
,v.DaysSinceDiscovery
,v.FISMASEVERITY
,case 
    when v.FISMAseverity = 'Critical' and v.DAYSSINCEDISCOVERY > 15 then 'Critical >15 days'
    when v.FISMAseverity = 'High' and v.DAYSSINCEDISCOVERY > 30 then 'high >30 days'
    when v.FISMAseverity = 'Medium' and v.DAYSSINCEDISCOVERY > 90 then 'moderate > 90 days'
    when v.FISMAseverity = 'Low' and v.DAYSSINCEDISCOVERY > 365 then 'low > 365 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER 
,epss.epss 
,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    End as EPSS_FILTER 
,epss.percentile 
FROM core.vw_vulmaster v--rpt.assetdetail v
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = v.SYSTEM_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = v.cve
where v.MitigationStatus IN ('open','reopened');
create or replace view VW_VULCURR_DETAIL_MCRR(
	REPORT_ID,
	SYSTEM_ID,
	SYSTEMACRONYM,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	EPSS,
	EPSS_FILTER,
	PERCENTILE
) COMMENT='current statistics over all vulns including EPSS and FISMAseverity metrics for CR#959'
 as
SELECT 
r.REPORT_ID
,s.SYSTEM_ID
,s.Acronym as SystemAcronym
,s.GROUP_ACRONYM
,s.GROUP_NAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.cve
,v.CVSSV2BASESCORE as CVSSV2BASE 
,v.CVSSV3BASESCORE as CVSSV3Base
,v.DaysSinceDiscovery
,case 
    when v.FISMAseverity = 'Critical' and v.DAYSSINCEDISCOVERY > 15 then 'Critical >15 days'
    when v.FISMAseverity = 'High' and v.DAYSSINCEDISCOVERY > 30 then 'high >30 days'
    when v.FISMAseverity = 'Medium' and v.DAYSSINCEDISCOVERY > 90 then 'moderate > 90 days'
    when v.FISMAseverity = 'Low' and v.DAYSSINCEDISCOVERY > 365 then 'low > 365 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER 
,v.exploitAvailable
,vm.firstSeen
,v.FISMAseverity
,v.lastFound
,v.MitigationStatus
,vm.IS_KEV as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated 
,epss.epss 
,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    End as EPSS_FILTER 
,epss.percentile 
FROM (Select max(REPORT_ID) REPORT_ID from core.report_ids where is_endofmonth = 1) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_VUL_ID = v.dw_vul_id
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = v.SYSTEM_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = v.cve
where v.MitigationStatus IN ('open','reopened');
create or replace view VW_VULHIST_TEST(
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	GROUP_NAME,
	ID,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGIN_ID,
	REPORT_DATE,
	REPORT_ID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='Return open/reopened historical vulnerability for all report_id.'
 as
SELECT 
ah.ASSET_ID_TATTOO
,kev.BODDUEDATE
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
,dc.Acronym as DATACENTERACRONYM
,vm.DATEMITIGATED
,DATEDIFF(day,vm.firstseen,v.lastFound) as DAYSSINCEDISCOVERY
,NULL as DESCRIPTION
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,vm.DW_VUL_ID
,v.EXPLOITAVAILABLE
,NULL as FAMILYNAME
,vm.FIRSTSEEN
,v.FISMASEVERITY
,s.GROUP_ACRONYM -- 230623
,s.GROUP_NAME
,v.ID
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,v.LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,plugs.PLUGIN_ID
,r.REPORT_DATE
,r.REPORT_ID
,NULL as SIGNATURE
,NULL as SOLUTION
,'Tenable' as SOURCE_TOOL -- 230623
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM CORE.REPORT_IDS r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
--where v.MitigationStatus IN ('open','reopened');
;
create or replace view VW_VULN_DASHBOARD_TRENDING(
	ACRONYM,
	COMPONENT_ACRONYM,
	CVE_COUNT,
	UNIQUE_CVE_COUNT,
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE,
	IS_CURRENT
) COMMENT='Contains all the summarized Vulnerabilities for latest 12 month end and current day snapshots at Org Hierarchy level'
 as
SELECT 
ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count" CVE_Count,
    "Unique CVE Count" Unique_CVE_Count,
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE,
    case 
    when RANKK = 1 and CVE_Count > 0 then 1
    ELSE 0
    end as IS_CURRENT,
    FROM RPT.TEMP_VULN_TRENDING;
create or replace view VW_VULN_ROLLING60DAYS(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) COMMENT='Used to populate RPT.Temp_Vuln_FV_Rolling60Days from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
--
-- V5 replace Snapshots CTE and POAMHIST REPORT_ID (using FN_CRM_GET_REPORT_ID(0)) and mitigation filter at bottom not at join
--
--
-- The only difference between rpt.v_systems and core.rpt.wv_systems is alias names
--
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from core.report_ids where report_id = (select max(report_id) from core.report_ids)
    UNION ALL
    select 2 as RANKK, REPORT_ID, 'EOM' as MTDVSEOM from core.report_ids where report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1)
)
select sys.ACRONYM as v_acr,sys.COMPONENT_ACRONYM as v_comp_acr ,sys.TLC_Phase v_tlc_phase,sys.HVAStatus as v_hva_stat,sys.IS_MARKETPLACE as v_is_mrkt_plc,sys.MEFSTATUS as v_mef_status,
case when vuln.ACRONYM is null then concat(sys.ACRONYM,'*') else sys.ACRONYM end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS sys

left outer join
(
select
'1' as filter
,vh.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,vh.DATACENTER_ID as FK_DATACENTER_ID
,vh.id
,vh.DW_VUL_ID as FK_dw_vul_number
,vh.cve
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.firstseen
,vh.fismaseverity
,vh.lastfound
,vh.mitigationstatus
,vh.REPORT_ID as fk_snapshotid
,s.ACRONYM
,substring(s.ACRONYM, 1, 1) || '***' as Acr_Alias -- 231103 changed from + to ||
,s.COMPONENT_ACRONYM
,s.IS_DATACENTER
,s.IS_MARKETPLACE
,s.TLC_PHASE
,A.Is_Scannable
--,vh.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,s.HVASTATUS
,s.MEFSTATUS
,data_center.ACRONYM as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
--,dense_rank()over(order by vh.REPORT_ID desc) as rankk -- 231201
,snap.RANKK as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,vh.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,s.OATO_CATEGORY
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED vh on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN SnapShots snap on vh.REPORT_ID = snap.REPORT_ID
--and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON vh.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join CORE.VW_SYSTEMS data_center ON data_center.SYSTEM_ID = vh.datacenter_id
left outer JOIN CORE.VW_SYSTEMS s ON s.SYSTEM_ID = vh.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat on bodcat.CVE = vh.cve

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT p.SYSTEM_ID,p.POAM_ID,CVE,p.Overall_Status
    FROM (select * from core.report_ids where report_id = (select max(report_id) from core.report_ids)) r
    JOIN CORE.POAMHist p on p.REPORT_ID = r.REPORT_ID
    where p.CVE IS NOT NULL) pom on pom.CVE=vh.CVE and pom.SYSTEM_ID=vh.SYSTEM_ID    
where (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
) vuln on vuln.FK_PRIMARY_FISMA_ID = sys.SYSTEM_ID   -- 231103 (vuln."Acronym" = vh."Acronym" and vuln."Component_Acronym" = vh."Component_Acronym" )

where sys.COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO') -- 231103 and "Is_ExcludeFromReporting" = 0
;
create or replace view V_CDM_DASHBOARD(
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	"id",
	"FK_AssetID",
	"FK_ReportID",
	"Is_Scannable",
	"Acronym",
	"Acr_Alias",
	"Component_Acronym",
	"Group_Acronym",
	"Is_DataCenter",
	"Is_MarketPlace",
	"HVAStatus",
	"MEFStatus",
	"TLC_Phase",
	"Is_ExcludeFromReporting",
	"rankk",
	"refresh_date",
	"computer_type",
	"os",
	"bios_guid",
	"source_tool",
	"environment",
	"asset_id_tattoo",
	"os_version",
	"TenableUUID",
	"DeviceType",
	"datecreated",
	"dateDeleted",
	"Is_Applicable",
	"DeviceRole",
	"fqdn",
	"hostname",
	"IPv4",
	"IPv6",
	"Mac",
	"netbiosname",
	"InstanceStatus",
	"netbios_hn",
	DATACENTER,
	VRT,
	SNAPSHOTS,
	"EndofMonth",
	"ReportDate",
	"StartOfMonth",
	"LastSeen_HWAM",
	"AWS_accountIds",
	"RefreshDate"
) COMMENT='This view contains Master Device records data along with Vuln risk tolerance calculated at each asset level'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=3)),
    
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) = 1 then 'Current' when dense_rank()over(order by Report_ID desc) ='2' then 'LastMonth' when  dense_rank()over(order by Report_ID desc) ='3' then 'PrevMonth' when  dense_rank()over(order by Report_ID desc) ='4' then  'PrevPrevMonth' end as SnapshotsRank,
	case when dense_rank()over(order by Report_ID desc) =1 then LAST_DAY(current_date()) else LAST_DAY(ADD_MONTHS(Report_Date,-1)) end as EndofMonth,
	r.Report_Date,
	case when dense_rank()over(order by Report_ID desc) =1 then DATE_TRUNC('MONTH',current_date()) else (DATE_TRUNC('MONTH',ADD_MONTHS(Report_Date,-1))) End as StartOfMonth
	from ReportIDs r)
    
select
ah.SYSTEM_ID as "FK_PRIMARY_FISMA_ID"
,ah.DATACENTER_ID as "FK_DATACENTER_ID"
,ah.ASSETHIST_ID as "id"
,ah.dw_Asset_ID as "FK_AssetID"
,ah.Report_ID as "FK_ReportID"
,a.Is_Scannable as "Is_Scannable"
,sys.Acronym as "Acronym"
,substring(sys.Acronym,1,1) || '***' as "Acr_Alias"
,sys.Component_Acronym as "Component_Acronym"
,sys.Group_Acronym as "Group_Acronym"
,sys.Is_DataCenter as "Is_DataCenter"
,sys.Is_MarketPlace as "Is_MarketPlace"
,sys.HVAStatus as "HVAStatus"
,sys.MEFStatus as "MEFStatus"
,sys.TLC_Phase as "TLC_Phase"
,sys.IS_EXCLUDEFROMREPORTING as "Is_ExcludeFromReporting"
,dense_rank()over(order by ah.REPORT_ID desc) as "rankk"
,CURRENT_TIMESTAMP() as "refresh_date"
,a.computer_type as "computer_type"
,a.os as "os"
,a.bios_guid as "bios_guid"
,a.SOURCE_TOOL_LASTSEEN as "source_tool"
,a.environment as "environment"
,a.asset_id_tattoo as "asset_id_tattoo"
,a.os_version as "os_version"
,a.TenableUUID as "TenableUUID"
,a.DeviceType as "DeviceType"
,a.INSERT_DATE as "datecreated"
,NULL as "dateDeleted"
,a.IS_APPLICABLE as "Is_Applicable"
,a.DeviceRole as "DeviceRole"
,a.fqdn as "fqdn"
,a.hostname as "hostname"
,a.IPv4 as "IPv4"
,a.IPv6 as "IPv6"
,a.Macaddress as "Mac"
,a.netbiosname as "netbiosname"
,ah.AWS_INSTANCESTATUS as "InstanceStatus"
,ah.BIOS_GUID as "netbios_hn"
,dc.Acronym as "Datacenter"
,ah.VulnRiskTolerance as "VRT"
,snap.SnapshotsRank as "Snapshots"
,snap.EndofMonth as "EndofMonth"
,snap.Report_Date as "ReportDate"
,snap.StartOfMonth as "StartOfMonth"
,a.LastSeen_HWAM as "LastSeen_HWAM"
,sys.aws_accountids as "AWS_accountIds"
,current_date() as "RefreshDate"
from CORE.VW_Assets a
JOIN CORE.VW_ASSETHIST ah on ah.DW_ASSET_ID = a.DW_ASSET_ID 
--join CORE.reportsnapshots RC on ah.report_id = RC.REPORT_ID
JOIN Snapshots snap on snap.REPORT_ID = ah.REPORT_ID
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,Group_Acronym,TLC_Phase,aws_accountids,IS_EXCLUDEFROMREPORTING from CORE.vw_Systems) sys ON sys.SYSTEM_ID = ah.SYSTEM_ID 
left join (select SYSTEM_ID,acronym from CORE.vw_Systems) dc ON dc.SYSTEM_ID = ah.DATACENTER_ID
--left join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID;
;
create or replace view V_DATAQUALITY_6M_SOURCETOOL(
	DATACENTER_ID,
	SYSTEM_ID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ACRONYM,
	ACR_ALIAS,
	"Data Center",
	DCACR_ALIAS,
	AWS_ACCOUNTIDS,
	"TLC_Phase",
	"Is_MarketPlace",
	"MEFStatus",
	"HVAStatus",
	AXONIUS,
	FORESCOUT,
	BIGFIX,
	AWS,
	TENABLE,
	"Other_%",
	SOURCE_TOOL_COUNT,
	TOTAL_SOURCE_COUNT,
	"source_tool_%",
	SOURCE_TOOL_HWAM,
	REPORT_ID,
	REPORT_DATE
) COMMENT='Used for Tableau in Data Quality Dashboard:  Showing HWAM data based on completeness and Timeliness'
 as
with
ReportIDs as (SELECT REPORT_ID,Report_Date, Is_endOfMonth FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))
	union all
	select top 6 Report_ID,Report_Date, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM' ),
    
Snapshots as (select Report_ID,
	r.Report_Date
	from ReportIDs r) 
 --  select * from  Snapshots
    
select distinct
ah.datacenter_id,
ah.System_Id,
S."Component_Acronym" as Component_Acronym
,S."Group_Acronym" as Group_Acronym
,S."Acronym" as Acronym
,CONCAT(SUBSTR(S."Acronym", 1, 1), '***') as Acr_Alias
,data_center."Acronym" "Data Center"
,CONCAT(SUBSTR(data_center."Acronym", 1, 1), '***') as DCAcr_Alias
,s.AWS_accountIds
,s."TLC_Phase"
,s."Is_MarketPlace"
,s."MEFStatus"
,s."HVAStatus"
--,dense_rank()over(order by report_id desc) as rankk,
,st."'AXONIUS'" "AXONIUS"
,st."'FORESCOUT'" "FORESCOUT"
,st."'BIGFIX'" "BIGFIX"
,st."'AWS'" "AWS"
,st."'TENABLE'" "TENABLE"
,st."'UNKNOWN'" "Other_%"
,st1.source_tool_count
,st1.Total_source_Count
,st1."source_tool_%"
,st1.source_tool_hwam
,snap.report_id
,snap.report_date

--,getdate() as RefreshDate
from core.Asset a
JOIN core.ASSETHIST ah on ah.dw_asset_id = a.dw_asset_id --and a.Is_Applicable = 1 and ah.Is_Applicable = 1
join Snapshots snap on snap.report_id = ah.report_id
left join (select system_id, datacenter_id, source_tool_hwam, count(source_tool_hwam) source_tool_count, ah1.report_id, sum(count(source_tool_hwam)) over(PARTITION BY system_id) as Total_source_Count 
,case when sum(count(source_tool_hwam))  OVER(PARTITION BY system_id) != 0 then
ROUND(count(source_tool_hwam)*100.0/sum(count(source_tool_hwam))  OVER(PARTITION BY system_id),1)
else null end  as "source_tool_%"
from core.VW_AssetHist ah1
join (SELECT REPORT_ID,Report_Date FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) snap on snap.Report_ID = ah1.Report_ID
where source_tool_hwam is not null
group by system_id, datacenter_id, source_tool_hwam, ah1.report_id
) st1 on st1.system_id = ah.system_id and st1.datacenter_id = ah.datacenter_id
and st1.source_tool_hwam = ah.source_tool_hwam and st1.report_id = snap.report_id
left join (
select 
System_Id, datacenter_id, "'AXONIUS'","'FORESCOUT'", "'BIGFIX'", "'AWS'", "'TENABLE'", "'UNKNOWN'"
,piv.report_id
from
(
select System_Id, datacenter_id, upper(source_tool_hwam) SourceTool, report_id
,case when sum(count(source_tool_hwam))  OVER(PARTITION BY System_Id, report_id) != 0 then
ROUND(count(source_tool_hwam)*100.0/sum(count(source_tool_hwam))  OVER(PARTITION BY System_Id, report_id),1)
else null end  as "source_tool_%"
from core.VW_ASSETHIST ah1
where source_tool_hwam is not null
group by System_Id, datacenter_id, source_tool_hwam,report_id) d
pivot
(
  MAX("source_tool_%")
  for SourceTool in ('AXONIUS', 'FORESCOUT', 'BIGFIX', 'AWS', 'TENABLE', 'UNKNOWN')
) piv
) st on st.System_Id = ah.System_Id and st.datacenter_id = ah.datacenter_id
and st.report_id = snap.report_id
right outer join (select ID,"Acronym","Component_Acronym","Is_DataCenter","Is_MarketPlace","HVAStatus","MEFStatus",
	"Group_Acronym","TLC_Phase", "Is_ExcludeFromReporting",
	cast(substring("AWS_accountIds",1,2000) as varchar(2000)) as AWS_accountIds from rpt.v_Systems 
	where "Is_PhantomSystem"=0 and "Is_ExcludeFromReporting" =0) S ON S.ID = ah.System_Id --and Is_ExcludeFromReporting = 0
left join (select id,"Acronym", "AWS_accountIds" from rpt.v_Systems) data_center ON data_center.ID = ah.datacenter_id
where ah.System_Id is not null;
create or replace view V_DATAQUALITY_PIV_6M(
	DATACENTER_ID,
	SYSTEM_ID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ACRONYM,
	ACR_ALIAS,
	"Data Center",
	DCACR_ALIAS,
	AXONIUS,
	FORESCOUT,
	BIGFIX,
	AWS,
	TENABLE,
	"Other_%",
	TATOO_COUNT,
	TOTAL_ASSET,
	"asset_id_tattoo_%",
	DC_ID_DERIVED_COUNT,
	"datacenter_id_derived_%",
	P_FISMA_ID_TATTOO_COUNT,
	"primary_fisma_id_tattoo_%",
	P_FISMA_ID_DERIVED_COUNT,
	"primary_fisma_id_derived_%",
	COMPUTER_TYPE,
	C_TYPE_COUNT,
	TOTAL_COMPUTER_TYPE,
	"computer_type_%",
	DEVICETYPE,
	DEVICETYPE_COUNT,
	TOTAL_DEVICETYPE,
	"device_type_%",
	FQDN_COUNT,
	"fqdn_%",
	HOSTNAME_COUNT,
	"hostname_%",
	MAC_COUNT,
	"Mac_%",
	MOTHERBOARD_SN_COUNT,
	"motherboard_sn_%",
	NETBIOS_HN_COUNT,
	"netbios_hn_%",
	OS,
	OS_COUNT,
	TOTAL_OS,
	"os_%",
	AWS_ACCOUNTIDS,
	"TLC_Phase",
	"Is_MarketPlace",
	"MEFStatus",
	"HVAStatus",
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	"Timeliness_%",
	BIGFIX_ASSET_ID_COUNT,
	"bigfix_asset_id_%",
	OS_CPE_COUNT,
	"os_cpe_%",
	BIOS_GUID_COUNT,
	"bios_guid_%",
	INSTANCESTATUS_COUNT,
	"InstanceStatus_%",
	IPV4_COUNT,
	"ipv4_%",
	IPV6_COUNT,
	"ipv6_%",
	REPORT_ID,
	REPORT_DATE,
	SOURCE_TOOL_COUNT,
	TOTAL_SOURCE_COUNT,
	"source_tool_%",
	SOURCE_TOOL_HWAM
) COMMENT='Used for Tableau in Data Quality Dashboard:  Showing HWAM data based on completeness and Timeliness'
 as
with
ReportIDs as (SELECT REPORT_ID,Report_Date, Is_endOfMonth FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))
	union all
	select top 6 Report_ID,Report_Date, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM' ),
    
Snapshots as (select Report_ID,
	r.Report_Date
	from ReportIDs r) 
 --  select * from  Snapshots
    
select distinct
ah.datacenter_id,
ah.System_Id,
S."Component_Acronym" as Component_Acronym
,S."Group_Acronym" as Group_Acronym
,S."Acronym" as Acronym
,CONCAT(SUBSTR(S."Acronym", 1, 1), '***') as Acr_Alias
,data_center."Acronym" "Data Center"
,CONCAT(SUBSTR(data_center."Acronym", 1, 1), '***') as DCAcr_Alias
--,dense_rank()over(order by report_id desc) as rankk,
,st."'AXONIUS'" "AXONIUS"
,st."'FORESCOUT'" "FORESCOUT"
,st."'BIGFIX'" "BIGFIX"
,st."'AWS'" "AWS"
,st."'TENABLE'" "TENABLE"
,st."'UNKNOWN'" "Other_%"
,tatoo.tatoo_count
,tl.total_asset total_asset
,"asset_id_tattoo_%"
,dc_id_derived_count
,"datacenter_id_derived_%"
,p_fisma_id_tattoo_count
,"primary_fisma_id_tattoo_%"
,p_fisma_id_derived_count
,"primary_fisma_id_derived_%"
,ctype.computer_type
,ctype.c_type_count
,ctype.total total_computer_type
,ctype."computer_type_%"
,d.DeviceType
,d.DeviceType_count
,d.total_DeviceType
,d."device_type_%"
,fqdn_count
,"fqdn_%"
,hostname_count
,"hostname_%"
,Mac_count
,"Mac_%"
,motherboard_sn_count
,"motherboard_sn_%"
,netbios_hn_count
,"netbios_hn_%"
,os.os
,os.os_count
,os.total_os
,os."os_%"
,s.AWS_accountIds
,s."TLC_Phase"
,s."Is_MarketPlace"
,s."MEFStatus"
,s."HVAStatus"
,tl.Count_less72Hrs
,tl.Count_greater72Hrs
,case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
end as "Timeliness_%"
,bigfix_asset_id_count
,"bigfix_asset_id_%"
,os_cpe_count
,"os_cpe_%"
,bios_guid_count
,"bios_guid_%"
,InstanceStatus_count
,"InstanceStatus_%"
,ipv4_count
,"ipv4_%"
,ipv6_count
,"ipv6_%"
,snap.report_id
,snap.report_date
,st1.source_tool_count
,st1.Total_source_Count
,st1."source_tool_%"
,st1.source_tool_hwam
--,getdate() as RefreshDate
from core.Asset a
JOIN core.ASSETHIST ah on ah.dw_asset_id = a.dw_asset_id --and a.Is_Applicable = 1 and ah.Is_Applicable = 1
join Snapshots snap on snap.report_id = ah.report_id
left join (select system_id, datacenter_id, source_tool_hwam, count(source_tool_hwam) source_tool_count, sum(count(source_tool_hwam)) over(PARTITION BY system_id) as Total_source_Count 
,case when sum(count(source_tool_hwam))  OVER(PARTITION BY system_id) != 0 then
ROUND(count(source_tool_hwam)*100.0/sum(count(source_tool_hwam))  OVER(PARTITION BY system_id),1)
else null end  as "source_tool_%"
from core.VW_AssetHist ah1
join (SELECT REPORT_ID,Report_Date FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) snap on snap.Report_ID = ah1.Report_ID
where source_tool_hwam is not null
group by system_id, datacenter_id, source_tool_hwam 
) st1 on st1.system_id = ah.system_id and st1.datacenter_id = ah.datacenter_id
and st1.source_tool_hwam = ah.source_tool_hwam
left join (
select 
System_Id, datacenter_id, "'AXONIUS'","'FORESCOUT'", "'BIGFIX'", "'AWS'", "'TENABLE'", "'UNKNOWN'"
,piv.report_id
from
(
select System_Id, datacenter_id, upper(source_tool_hwam) SourceTool, report_id
,case when sum(count(source_tool_hwam))  OVER(PARTITION BY System_Id, report_id) != 0 then
ROUND(count(source_tool_hwam)*100.0/sum(count(source_tool_hwam))  OVER(PARTITION BY System_Id, report_id),1)
else null end  as "source_tool_%"
from core.VW_ASSETHIST ah1
where source_tool_hwam is not null
group by System_Id, datacenter_id, source_tool_hwam,report_id) d
pivot
(
  MAX("source_tool_%")
  for SourceTool in ('AXONIUS', 'FORESCOUT', 'BIGFIX', 'AWS', 'TENABLE', 'UNKNOWN')
) piv
) st on st.System_Id = ah.System_Id and st.datacenter_id = ah.datacenter_id
and st.report_id = snap.report_id
left join (select System_Id, datacenter_id, report_id, sum(count(a.dw_asset_id)) OVER(PARTITION BY System_Id, report_id) total_asset, count(asset_id_tattoo) tatoo_count 
,case when count(a.dw_asset_id) != 0 then
ROUND(count(asset_id_tattoo)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY System_Id, report_id),1) 
else null end as "asset_id_tattoo_%"
,count(datacenter_id) dc_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(datacenter_id)*100.0/count(a.dw_asset_id),1) 
else null end as  "datacenter_id_derived_%"
,count(system_id) p_fisma_id_tattoo_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/count(a.dw_asset_id),1) 
else null end as  "primary_fisma_id_tattoo_%"
,count(system_id) p_fisma_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/count(a.dw_asset_id),1) 
else null end as  "primary_fisma_id_derived_%"
,count(motherboard) motherboard_sn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(motherboard)*100.0/count(a.dw_asset_id),1) 
else null end as  "motherboard_sn_%"
,count(NETBIOSNAME) netbios_hn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(NETBIOSNAME)*100.0/count(a.dw_asset_id),1) 
else null end as  "netbios_hn_%"
,count(bigfix_asset_id) bigfix_asset_id_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bigfix_asset_id)*100.0/count(a.dw_asset_id),1) 
else null end as  "bigfix_asset_id_%"
,count(bios_guid) bios_guid_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bios_guid)*100.0/count(a.dw_asset_id),1) 
else null end as  "bios_guid_%"
,count(os_cpe) os_cpe_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(os_cpe)*100.0/count(a.dw_asset_id),1) 
else null end as  "os_cpe_%"
from core.VW_ASSETHIST a
where a.devicetype in (select devicetype from core.DEVICETYPES dv where dv.devicetype in ('Server', 'Workstation', 'Computer','Laptop'))
Group by System_Id, datacenter_id, a.report_id) tatoo on tatoo.System_Id = ah.System_Id
and tatoo.datacenter_id = ah.datacenter_id and tatoo.report_id = snap.report_id
left join (select System_Id, datacenter_id, aah.report_id, computer_type, count(computer_type) c_type_count, sum(count(computer_type))  OVER(PARTITION BY System_Id, aah.report_id) as total 
,ROUND(count(computer_type)*100.0/sum(count(computer_type))  OVER(PARTITION BY System_Id, aah.report_id),1) as  "computer_type_%"
from core.VW_ASSETHIST aah
where computer_type is not null 
group by System_Id, datacenter_id, aah.report_id, computer_type) ctype on ctype.System_Id = ah.System_Id
and ctype.datacenter_id = ah.datacenter_id and ctype.report_id = snap.report_id and ctype.computer_type = ah.computer_type
left JOIN (select a.System_Id, datacenter_id, a.report_id, a.DEVICETYPE, count(di.DeviceType) DeviceType_count,
sum(count(di.DeviceType)) over(PARTITION BY a.System_Id, a.report_id) total_DeviceType
,ROUND(count(di.DeviceType)*100.0/sum(count(di.DeviceType)) over(PARTITION BY a.System_Id, a.report_id),1) as  "device_type_%"
from  core.DEVICETYPES di
join core.VW_ASSETHIST a on a.DeviceType = di.devicetype 
where a.DEVICETYPE is not null group by System_Id, datacenter_id, a.report_id, a.DEVICETYPE, di.DeviceType
) D  ON ah.System_Id=D.System_Id and ah.datacenter_id = d.datacenter_id 
and d.report_id = snap.report_id and ah.DeviceType = d.DeviceType
left join (select a.System_Id, a.datacenter_id, ac.report_id
,count(fqdn) fqdn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(fqdn)*100.0/count(a.dw_asset_id),1) 
else null end as  "fqdn_%"
,count(hostname) hostname_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(hostname)*100.0/count(a.dw_asset_id),1) 
else null end as  "hostname_%"
,count(MACADDRESS) Mac_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(MACADDRESS)*100.0/count(a.dw_asset_id),1) 
else null end as  "Mac_%"
,count(ipv4) ipv4_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv4)*100.0/count(a.dw_asset_id),1) 
else null end as  "ipv4_%"
,count(ipv6) ipv6_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv6)*100.0/count(a.dw_asset_id),1) 
else null end as  "ipv6_%"
from core.AssetInterfaceCoalescedHist ac
join core.Asset a on a.dw_asset_id = ac.dw_asset_id group by a.System_Id, datacenter_id, ac.report_id
) aic on aic.System_Id = ah.System_Id and aic.datacenter_id = ah.datacenter_id
and aic.report_id = snap.report_id
left join (select aah.System_Id, aah.datacenter_id, aah.report_id, os, count(os) os_count, sum(count(os)) over(PARTITION BY aah.System_Id, aah.report_id) total_os
,ROUND(count(os)*100.0/sum(count(os)) over(PARTITION BY aah.System_Id, aah.report_id),1) as  "os_%"
from core.VW_ASSETHIST aah
where aah.os is not null
group by System_Id, datacenter_id, aah.report_id, os
) os on os.System_Id = ah.System_Id
and os.datacenter_id  = ah.datacenter_id and os.report_id = snap.report_id and os.os = ah.os
left join (select ah.System_Id, ah.datacenter_id, report_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah
group by System_Id, datacenter_id, ah.report_id
) tl on tl.System_Id = ah.System_Id
and tl.datacenter_id  = ah.datacenter_id and tl.report_id = snap.report_id
left join (
select 
System_Id, ah.report_id, count(aws_instancestatus) InstanceStatus_count 
,case when count(aws_instancestatus) != 0 then
ROUND(count(aws_instancestatus)*100.0/sum(count(aws_instancestatus)) over(PARTITION BY System_Id, ah.report_id),1) 
else null end as "InstanceStatus_%"
from core.VW_ASSETHIST ah
--join Snapshots snap on snap.report_id = ah.report_id
where source_tool_hwam = 'AWS'
group by System_Id, ah.report_id
)IStat on IStat.System_Id = ah.System_Id and IStat.report_id = snap.report_id
right outer join (select ID,"Acronym","Component_Acronym","Is_DataCenter","Is_MarketPlace","HVAStatus","MEFStatus",
	"Group_Acronym","TLC_Phase", "Is_ExcludeFromReporting",
	cast(substring("AWS_accountIds",1,2000) as varchar(2000)) as AWS_accountIds from rpt.v_Systems 
	where "Is_PhantomSystem"=0 and "Is_ExcludeFromReporting" =0) S ON S.ID = ah.System_Id --and Is_ExcludeFromReporting = 0
left join (select id,"Acronym", "AWS_accountIds" from rpt.v_Systems) data_center ON data_center.ID = ah.datacenter_id
where ah.System_Id is not null;
create or replace view V_DIMENSIONAL_LOOKUP1(
	ID,
	DCID,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	DATACENTER_ACRONYM
) COMMENT='FISMA System related hierarchy look up details'
 as
SELECT distinct 
s.SYSTEM_ID as ID, 
dc.SYSTEM_ID as DCID, 
s.acronym, 
s.Component_Acronym, 
s.Group_Acronym, 
s.TLC_Phase, 
s.HVAStatus, 
s.Is_MarketPlace, 
s.MEFStatus,
s.OATO_Category,
IFNULL(dc.Acronym, s.primary_operating_location_acronym) as datacenter_acronym
FROM CORE.VW_Systems s  
left outer JOIN CORE.VW_assets a on a.SYSTEM_ID = s.SYSTEM_ID 
left outer JOIN CORE.VW_Systems DC on DC.SYSTEM_ID = a.datacenter_id
Where s.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
create or replace view V_HRS_COMPLIANCE(
	ACRONYM,
	COMPONENT_ACRONYM,
	FIPS_199_OVERALL_IMPACT_RATING,
	AUTH_DECISION,
	HVASTATUS,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	OA_STATUS,
	OATO_CATEGORY,
	OATO_CATEGORY_DESC,
	TLC_PHASE,
	TOTALASSETS,
	REPORT_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	RANKK
) COMMENT='Used for Tableau in High Risk Summary Report: System and OA details'
 as
SELECT 
s.Acronym
,s.COMPONENT_ACRONYM
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.AUTH_DECISION
,s.HVASTATUS
,IFF(s.IS_OA_READY=1,'Yes','No') Is_OA_Ready
,s.IS_OPERATIONALSYSTEM
,s.OA_STATUS
,s.OATO_CATEGORY
,src.DESCRIPTION OATO_Category_desc
,s.TLC_PHASE
,ss.Assets as TotalAssets
,vsnap.Report_Date Report_Date
,s.DATE_AUTH_MEMO_EXPIRES
,dense_rank()over(order by ss.report_id desc) as rankk
FROM CORE.VW_SYSTEMS s
JOIN (select report_id, system_id, assets  from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join (select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap on vsnap.Report_ID = ss.report_id
JOIN CORE.SystemRiskCategory src on s.oato_category = src.systemriskcategory_id;
create or replace view V_HRS_HWAMCOUNT(
	COMPONENTACRONYM,
	"hwam_pct"
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Asset details'
 as
select ComponentAcronym,
cast ( Y / (Y + N ) as DECIMAL(18, 4))*100   "hwam_pct" 
from
(
select "Component_Acronym" ComponentAcronym, cast(sum(case when (HWAM_CNT)<>0 then 1 else 0 end)as DECIMAL(18, 4)) as Y,
cast(sum(case when (HWAM_CNT)=0 then 1 else 0 end)as DECIMAL(18, 4))  as N
 from(
select  "Component_Acronym","System", sum("Total Assets") HWAM_CNT
from  rpt.V_CyberRisk_System_Summary
group by "Component_Acronym","System" ) A
group by "Component_Acronym"
)B;
create or replace view V_HRS_POAM(
	"Component_Acronym",
	"Acronym",
	"Archer_Tracking_ID",
	"Auth_Decision",
	AVG_DAYS_OPEN,
	WEAKNESS_RISK_LEVEL
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Poam data'
 as
SELECT  "Component_Acronym" ,"Acronym",syst."Archer_Tracking_ID","Auth_Decision",(cast(days_open as numeric)) as avg_days_open,weakness_risk_level
FROM	rpt.V_Systems syst
		left outer join RPT.V_POAMS poam 
		on (syst."Archer_Tracking_ID" =poam.archer_tracking_id 
		and Poam.overall_status in ('Delayed','Ongoing','Draft')
		and  weakness_risk_level in ('Critical','High','Low','Moderate'))
where	"Component_Acronym" IS NOT NULL
		and syst."TLC_Phase" = 'Operate';
create or replace view V_HRS_VULNDATA(
	ID,
	"dateCreated",
	"FK_SnapshotID",
	"Acronym",
	"Archer_Tracking_ID",
	"Auth_Comments",
	"Auth_Decision",
	"Authorization_Package",
	"Business_Owner",
	CFACTS_UID,
	CIO,
	CISO,
	"Cloud_Service_Provider",
	"CommonName",
	"Component_Acronym",
	"Component_Risk_Reports_Oversight",
	"ContingencyExpirationDate",
	"CP_Test_Date",
	"CP_Test_Results",
	CRA,
	"CyberVet",
	"Date_Auth_Memo_Expires",
	"Date_Auth_Memo_Signed",
	"dateDeleted",
	"dateModified",
	DCISO,
	"Division_Acronym",
	"DivisionName",
	"E-Auth_Exp_Date",
	"E-Auth_Level",
	"E-Auth_Risk_Assessment_Date",
	"Financial_System",
	"FIPS_199_Availability_Rating",
	"FIPS_199_Confidentiality_Rating",
	"FIPS_199_Integrity_Rating",
	"FIPS_199_Overall_Impact_Rating",
	"FISMA_System",
	"Group_Acronym",
	"HVA_Score",
	"HVAStatus",
	"In_CMS_Cloud",
	"Information_System_Type",
	"Is_DataCenter",
	"Is_ExcludeFromReporting",
	"Is_HighRiskSystem",
	"Is_MarketPlace",
	"Is_OA_Ready",
	"Is_OperationalSystem",
	"Is_PhantomSystem",
	"Is_SecurityHub_Enabled",
	"ISRA_Review_Date",
	"ISRA_Status",
	"ISSO Count",
	ISSO,
	ISSOCS,
	"Last_ACT_Date",
	"Last_Pentest_Date",
	MEF,
	"MEF_Context",
	"MEFStatus",
	"OA_Status",
	"OATO_Category",
	"Package_Type",
	"PIA_Expiration_Date",
	PII_PHI,
	"Primary_ISSO",
	"Primary_Operating_Location",
	SCA,
	"SCA_Date",
	SDM,
	"ST&E_Date",
	"System_Description",
	"TLC_Phase",
	"TotalAssets",
	"TotalPOAMwithApprovedRBD",
	"VATName",
	"Next_Required_CP_Test_Date",
	"Control_Set_Version_Number_System_Provid",
	"AWS_accountIds",
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	CISO_REVIEW_DATE,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	CRA_REVIEW_DATE,
	DIVISION_DESCRIPTION,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	FIRST_PUBLISHED_DATE,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	PIA_014,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SOP_REVIEW_DATE,
	REMEDIATED_VULN,
	DELAYED_VUL,
	"FISMAseverity",
	CNT
) COMMENT='Used for Tableau in High Risk Summary Report: Contains Vulnerability data'
 as
select main.*,
a.Remediated_Vuln,
a.Delayed_Vul,
a."FISMAseverity",cnt  from rpt.V_Systems main

left outer join (select
s."Component_Acronym" ,
s."Acronym",
v."FISMAseverity",
vm.datemitigated,
SUM(case when v."MitigationStatus" = 'Fixed' and vm.datemitigated between DATEADD(day, -(day(CURRENT_DATE()-2)), dateadd(month, -1, CURRENT_DATE()-1)) and 
DATEADD(day, -(day(CURRENT_DATE())), CURRENT_DATE())   then 1 else 0 end) as Remediated_Vuln,
SUm(case when v."MitigationStatus" <> 'Fixed' and  v."DaysSinceDiscovery" > 90 then 1 else 0 end) as Delayed_Vul,
count(*) as cnt
-- Delayed should be based on this DaysSinceDiscovery
FROM rpt.V_VULHIST v 
join (select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap
on v.report_id = vsnap.Report_ID
JOIN CORE.VulMaster vm on vm.dw_vul_id = v.dw_vul_id
JOIN rpt.V_Systems s on s.ID = v."FISMA_id"
where v."FISMAseverity" in ('Critical','High') 
GROUP BY s."Component_Acronym"
,v."FISMAseverity","Acronym",vm.datemitigated)a

on (a."Component_Acronym" = main."Component_Acronym" and a."Acronym"=main."Acronym")
where "TLC_Phase" = 'Operate';
create or replace view V_SEC_USERSYSMAPPING_ALL(
	ACRONYM,
	USERNAME,
	MEMBER,
	ROLE
) COMMENT='Used for security in tableau: Security view for giving role based access to the users'
 as
SELECT distinct
um.ACRONYM
,um.USER_ID as USERNAME
,FALSE as MEMBER
,um.ROLE
FROM CORE.CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID
where um.role not in ( 'ISPG Fed Staff', 'ISPG Contractor Staff', 'CMS Read Only')
--and TLC_Phase <> 'Retire'
Union All
select distinct
syst.ACRONYM
,EC.USERNAME
,EC.MEMBER
,um.role as ROLE
from RPT.CFACTS_EXCLUSIVECLUB EC 
LEFT JOIN CORE.VW_SYSTEMS syst on 1=1
join CORE.CFACTS_USERMAPPING um on um.user_id = ec.username 
where Member = 1;
create or replace view V_SEC_USERSYSMAPPING_VATDC(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ACRONYM,
	SYSTEM_ID,
	USERID
) COMMENT='Security view for specifically crated for Data center users (Details provided by VAT team)'
 as
select distinct
 A.DATACENTER_ACRONYM --as "DataCenter Acronym"
,A.DATACENTER_ID --as "DataCenterUID"
,S.Acronym --as "System Acronym"
,S.SYSTEM_ID --as "SystemUID"
,SU.UserId --as "UserName"
from CORE.VW_SYSTEMS S
join CORE.VW_ASSETS A on A.system_id = S.system_id
join rpt.VAT_SYSTEMUSERS SU on S.SYSTEM_ID = SU.SYSTEM_ID
where S.Is_ExcludeFromReporting = 0 and S.Is_PhantomSystem=0 and SU.UserId is not null
;
create or replace view V_SYSTEMS(
	ID,
	FISMA_ID,
	"dateCreated",
	"FK_SnapshotID",
	"Acronym",
	"Archer_Tracking_ID",
	"Auth_Comments",
	"Auth_Decision",
	"Authorization_Package",
	"Business_Owner",
	CFACTS_UID,
	CIO,
	CISO,
	"Cloud_Service_Provider",
	"CommonName",
	"Component_Acronym",
	"Component_Risk_Reports_Oversight",
	"ContingencyExpirationDate",
	"CP_Test_Date",
	"CP_Test_Results",
	CRA,
	"CyberVet",
	"Date_Auth_Memo_Expires",
	"Date_Auth_Memo_Signed",
	"dateDeleted",
	"dateModified",
	DCISO,
	"Division_Acronym",
	"DivisionName",
	"E-Auth_Exp_Date",
	"E-Auth_Level",
	"E-Auth_Risk_Assessment_Date",
	"Financial_System",
	"FIPS_199_Availability_Rating",
	"FIPS_199_Confidentiality_Rating",
	"FIPS_199_Integrity_Rating",
	"FIPS_199_Overall_Impact_Rating",
	"FISMA_System",
	"Group_Acronym",
	"HVA_Score",
	"HVAStatus",
	"In_CMS_Cloud",
	"Information_System_Type",
	"Is_DataCenter",
	"Is_ExcludeFromReporting",
	"Is_HighRiskSystem",
	"Is_MarketPlace",
	"Is_OA_Ready",
	"Is_OperationalSystem",
	"Is_PhantomSystem",
	"Is_SecurityHub_Enabled",
	"ISRA_Review_Date",
	"ISRA_Status",
	"ISSO Count",
	ISSO,
	ISSOCS,
	"Last_ACT_Date",
	"Last_Pentest_Date",
	MEF,
	"MEF_Context",
	"MEFStatus",
	"OA_Status",
	"OATO_Category",
	"Package_Type",
	"PIA_Expiration_Date",
	PII_PHI,
	"Primary_ISSO",
	"Primary_Operating_Location",
	SCA,
	"SCA_Date",
	SDM,
	"ST&E_Date",
	"System_Description",
	"TLC_Phase",
	"TotalAssets",
	"TotalPOAMwithApprovedRBD",
	"VATName",
	"Next_Required_CP_Test_Date",
	"Control_Set_Version_Number_System_Provid",
	"AWS_accountIds",
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	CISO_REVIEW_DATE,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	CRA_REVIEW_DATE,
	DIVISION_DESCRIPTION,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	FIRST_PUBLISHED_DATE,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	PIA_014,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SOP_REVIEW_DATE
) COMMENT='Dimensional view for referencing the Org hierarchy data (similar to CORE.VW_SYSTEMS)'
 as
SELECT
SYSTEM_ID as "ID"
,SYSTEM_ID as FISMA_ID
,INSERT_DATE as "dateCreated"
,(SELECT TOP 1 REPORT_ID FROM CORE.REPORT_IDS order by REPORT_ID desc) as "FK_SnapshotID"
,ACRONYM as "Acronym"
,ARCHER_TRACKING_ID as "Archer_Tracking_ID"
,AUTH_COMMENTS as "Auth_Comments"
,AUTH_DECISION as "Auth_Decision"
,AUTHORIZATION_PACKAGE as "Authorization_Package"
,BUSINESS_OWNER as "Business_Owner"
,SYSTEM_ID as "CFACTS_UID"
,CIO as "CIO"
,CISO as "CISO"
,CLOUD_SERVICE_PROVIDER as "Cloud_Service_Provider"
,COMMONNAME as "CommonName"
,COMPONENT_ACRONYM as "Component_Acronym"
,COMPONENT_RISK_REPORTS_OVERSIGHT as "Component_Risk_Reports_Oversight"
,CONTINGENCYEXPIRATIONDATE as "ContingencyExpirationDate"
,CP_TEST_DATE as "CP_Test_Date"
,CP_TEST_RESULTS as "CP_Test_Results"
,CRA as "CRA"
,CYBERVET as "CyberVet"
,DATE_AUTH_MEMO_EXPIRES as "Date_Auth_Memo_Expires"
,DATE_AUTH_MEMO_SIGNED as "Date_Auth_Memo_Signed"
,DATEDELETED as "dateDeleted"
,DATEMODIFIED as "dateModified"
,DCISO as "DCISO"
,DIVISION_ACRONYM as "Division_Acronym"
,DIVISION_NAME as "DivisionName"
,E_AUTH_EXP_DATE as "E-Auth_Exp_Date"
,E_AUTH_LEVEL as "E-Auth_Level"
,E_AUTH_RISK_ASSESSMENT_DATE as "E-Auth_Risk_Assessment_Date"
,FINANCIAL_SYSTEM as "Financial_System"
,FIPS_199_AVAILABILITY_RATING as "FIPS_199_Availability_Rating"
,FIPS_199_CONFIDENTIALITY_RATING as "FIPS_199_Confidentiality_Rating"
,FIPS_199_INTEGRITY_RATING as "FIPS_199_Integrity_Rating"
,FIPS_199_OVERALL_IMPACT_RATING as "FIPS_199_Overall_Impact_Rating"
,FISMA_SYSTEM as "FISMA_System"
,GROUP_ACRONYM as "Group_Acronym"
,HVA_SCORE as "HVA_Score"
,HVASTATUS as "HVAStatus"
,IN_CMS_CLOUD as "In_CMS_Cloud"
,INFORMATION_SYSTEM_TYPE as "Information_System_Type"
,IS_DATACENTER as "Is_DataCenter"
,IS_EXCLUDEFROMREPORTING as "Is_ExcludeFromReporting"
,IS_HIGHRISKSYSTEM as "Is_HighRiskSystem"
,IS_MARKETPLACE as "Is_MarketPlace"
,IS_OA_READY as "Is_OA_Ready"
,IS_OPERATIONALSYSTEM as "Is_OperationalSystem"
,IS_PHANTOMSYSTEM as "Is_PhantomSystem"
,IS_SECURITYHUB_ENABLED as "Is_SecurityHub_Enabled"
,ISRA_REVIEW_DATE as "ISRA_Review_Date"
,ISRA_STATUS as "ISRA_Status"
,ISSO_COUNT as "ISSO Count"
,ISSO as "ISSO"
,ISSOCS as "ISSOCS"
,LAST_ACT_DATE as "Last_ACT_Date"
,LAST_PENTEST_DATE as "Last_Pentest_Date"
,MEF as "MEF"
,MEF_CONTEXT as "MEF_Context"
,MEFSTATUS as "MEFStatus"
,OA_STATUS as "OA_Status"
,OATO_CATEGORY as "OATO_Category"
,PACKAGE_TYPE as "Package_Type"
,PIA_EXPIRATION_DATE as "PIA_Expiration_Date"
,PII_PHI as "PII_PHI"
,PRIMARY_ISSO as "Primary_ISSO"
,PRIMARY_OPERATING_LOCATION as "Primary_Operating_Location"
,SCA as "SCA"
,SCA_DATE as "SCA_Date"
,SDM as "SDM"
,STE_DATE as "ST&E_Date"
,SYSTEM_DESCRIPTION as "System_Description"
,TLC_PHASE as "TLC_Phase"
,TOTALASSETS as "TotalAssets"
,TOTALPOAMWITHAPPROVEDRBD as "TotalPOAMwithApprovedRBD"
,null as "VATName"
,NEXT_REQUIRED_CP_TEST_DATE as "Next_Required_CP_Test_Date"
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as "Control_Set_Version_Number_System_Provid"
,AWS_ACCOUNTIDS as "AWS_accountIds"
,ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE as ATO_REVIEW_DATE
,AUTHORIZATION_MEMO_SIGNED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE
,BO_RECOMMENDATION_REVIEW_DATE as BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE as BO_REVIEW_DATE
,CISO_REVIEW_DATE as CISO_REVIEW_DATE
,COMPONENT_DESCRIPTION as COMPONENT_DESCRIPTION
,COMPONENT_NAME as COMPONENT_NAME
,CRA_REVIEW_DATE as CRA_REVIEW_DATE
,DIVISION_DESCRIPTION as DIVISION_DESCRIPTION
,DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE as DSPPO_REVIEW_DATE
,FIRST_PUBLISHED_DATE as FIRST_PUBLISHED_DATE
,GROUP_DESCRIPTION as GROUP_DESCRIPTION
,GROUP_NAME as GROUP_NAME
,ISSO_REVIEW_DATE as ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE as ISSO_SUBMISSION_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,PIA_014 as PIA_014
,PRIMARY_OPERATING_LOCATION_ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID as PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST as REASON_FOR_ATO_REQUEST
,SOP_REVIEW_DATE as SOP_REVIEW_DATE
FROM CORE.VW_SYSTEMS;
create or replace view V_SYSTEMSUMMARY(
	"ReportDate",
	"Is_endOfMonth",
	"ComponentAcronym",
	"DivisionAcronym",
	"GroupAcronym",
	"PrimaryOperatingLocation",
	"SystemAcronym",
	"SystemCommonName",
	CFACTS_UID,
	"Assets",
	"VulCritical",
	"VulCritical_gt30_lte60days",
	"VulCritical_gt60days",
	"VulCritical_gte15days",
	"VulCritical_lte15days",
	"VulCritical_lte30days",
	"VulHigh",
	"VulHigh_gt30_lte60days",
	"VulHigh_gt60days",
	"VulHigh_lte30days",
	"VulRaw",
	"VulRaw_Critical",
	"VulRaw_High",
	"VulRaw_Low",
	"VulRaw_Medium",
	"VulUniqueCritical_gt15_lte60days",
	"VulUniqueCritical_gt30_lte60days",
	"VulUniqueCritical_gt60days",
	"VulUniqueCritical_gte15days",
	"VulUniqueHigh_gt30_lte60days",
	"VulUniqueHigh_gt60days",
	"HWAMRawAWS",
	"HWAMRawBigFix",
	"HWAMRawForeScout",
	"VulDeleted",
	"VulMedium",
	"VulLow",
	"VulUniqueMedium",
	"VulUniqueLow",
	"AssetRiskTolerance",
	"ResidualRisk",
	"ResiliencyScore",
	"PrevAssets",
	"VulnRiskTolerance",
	"FK_ReportID",
	"FK_SystemID",
	FISMA_ID,
	"SystemSummaryPrimaryKey",
	"Control_Set_Version_Number_System_Provid",
	"KEV_Open",
	"KEV_Reopened",
	"KEV_Fixed_MonthToDate",
	AUTHORIZATION_PACKAGE,
	KEV_FIXED_TODAY,
	SCANNABLEASSETS,
	VULCRITICALREMEDIATED,
	VULHIGHREMEDIATED,
	VULUNIQUECRITICAL_GT15_LTE60DAYS
) COMMENT='System level summary data for all report_id to show history of system changes.'
 as
select ss.REPORT_DATE as "ReportDate"
,ss.IS_ENDOFMONTH as "Is_endOfMonth"
,s.COMPONENT_ACRONYM as "ComponentAcronym"
,s.DIVISION_ACRONYM as "DivisionAcronym"
,s.GROUP_ACRONYM as "GroupAcronym"
,s.PRIMARY_OPERATING_LOCATION_ACRONYM as "PrimaryOperatingLocation"
,s.ACRONYM as "SystemAcronym"
,s.COMMONNAME as "SystemCommonName"
,ss.SYSTEM_ID as "CFACTS_UID"
,ss.ASSETS as "Assets"
,ss.VULCRITICAL as "VulCritical"
,ss.VULUNIQUECRITICAL_GT30_LTE60DAYS as "VulCritical_gt30_lte60days"
,ss.VULCRITICAL_GT60DAYS as "VulCritical_gt60days"
,ss.VULCRITICAL_GTE15DAYS as "VulCritical_gte15days"
,ss.VULCRITICAL_LTE15DAYS as "VulCritical_lte15days"
,ss.VULCRITICAL_LTE30DAYS as "VulCritical_lte30days"
,ss.VULHIGH as "VulHigh"
,ss.VULHIGH_GT30_LTE60DAYS as "VulHigh_gt30_lte60days"
,ss.VULHIGH_GT60DAYS as "VulHigh_gt60days"
,ss.VULHIGH_LTE30DAYS as "VulHigh_lte30days"
,ss.VULRAW as "VulRaw"
,ss.VULRAW_CRITICAL as "VulRaw_Critical"
,ss.VULRAW_HIGH as "VulRaw_High"
,ss.VULRAW_LOW as "VulRaw_Low"
,ss.VULRAW_MEDIUM as "VulRaw_Medium"
,ss.VULCRITICAL_GT15_LTE60DAYS as "VulUniqueCritical_gt15_lte60days"
,ss.VULCRITICAL_GT30_LTE60DAYS as "VulUniqueCritical_gt30_lte60days"
,ss.VULUNIQUECRITICAL_GT60DAYS as "VulUniqueCritical_gt60days"
,ss.VULUNIQUECRITICAL_GTE15DAYS as "VulUniqueCritical_gte15days"
,ss.VULUNIQUEHIGH_GT30_LTE60DAYS as "VulUniqueHigh_gt30_lte60days"
,ss.VULUNIQUEHIGH_GT60DAYS as "VulUniqueHigh_gt60days"
,ss.HWAMRAWAWS as "HWAMRawAWS"
,ss.HWAMRAWBIGFIX as "HWAMRawBigFix"
,ss.HWAMRAWFORESCOUT as "HWAMRawForeScout"
,ss.VULDELETED as "VulDeleted"
,ss.VULMEDIUM as "VulMedium"
,ss.VULLOW as "VulLow"
,ss.VULUNIQUEMEDIUM as "VulUniqueMedium"
,ss.VULUNIQUELOW as "VulUniqueLow"
,ss.ASSETRISKTOLERANCE as "AssetRiskTolerance"
,ss.RESIDUALRISK as "ResidualRisk"
,ss.RESILIENCYSCORE as "ResiliencyScore"
,ss.PREVASSETS as "PrevAssets"
,ss.VULNRISKTOLERANCE as "VulnRiskTolerance"
,ss.REPORT_ID as "FK_ReportID"
,ss.SYSTEM_ID as "FK_SystemID"
,ss.SYSTEM_ID as FISMA_ID
,ss.ID as "SystemSummaryPrimaryKey"
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as "Control_Set_Version_Number_System_Provid"
,ss.KEV_OPEN as "KEV_Open"
,ss.KEV_REOPENED as "KEV_Reopened"
,ss.KEV_FIXED_MONTHTODATE as "KEV_Fixed_MonthToDate"
,s.AUTHORIZATION_PACKAGE as AUTHORIZATION_PACKAGE
,ss.KEV_FIXED_TODAY as KEV_FIXED_TODAY
,ss.SCANNABLEASSETS as SCANNABLEASSETS
,0 as VULCRITICALREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this field. It was never populated.
,0 as VULHIGHREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this 
,ss.VULUNIQUECRITICAL_GT15_LTE60DAYS as VULUNIQUECRITICAL_GT15_LTE60DAYS
FROM CORE.VW_SYSTEMSUMMARY ss
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ss.SYSTEM_ID
;
create or replace view V_SYSTEMSUMMARY_DCRR_POAM(
	ACRONYM,
	CFACTS_UID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	TLC_PHASE,
	WEAKNESS_RISK_LEVEL,
	REPORTDATE,
	WEAKNESS_WEIGHT,
	POAM_CNT
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains POAM related information(POAM count, Weakness Risk Level)'
 as
select distinct
Acronym, 
p.system_id CFACTS_UID,
s.Component_Acronym
,s.Group_Acronym
,s.HVAStatus
,s.Is_MarketPlace
,s.MEFStatus
,s.TLC_Phase
,WEAKNESS_RISK_LEVEL as Weakness_Risk_Level
,reportdate as reportdate
,case when WEAKNESS_RISK_LEVEL= 'Low' then 10
when (WEAKNESS_RISK_LEVEL)= 'Moderate' then 15
when (WEAKNESS_RISK_LEVEL)= 'High' then 30
when (WEAKNESS_RISK_LEVEL)= 'Critical' then 45 else 0 end weakness_weight,
count(distinct POAM_ID) as POAM_CNT
from CORE.VW_POAMS_OPEN p --CR#1074
join CORE.VW_SYSTEMS s on p.system_id = s.system_id 
group by ALL;
create or replace view V_SYSTEMSUMMARY_DCRR_SYSTEMS(
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CFACTS_UID,
	COMPONENT_ACRONYM,
	ACRONYM,
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SDM,
	TLC_PHASE,
	ISSO,
	CRA,
	GROUP_NAME,
	DIVISION_NAME,
	GROUP_ACRONYM,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	AUTHORIZATION_PACKAGE,
	CONTINGENCYEXPIRATIONDATE,
	NEXT_REQUIRED_CP_TEST_DATE,
	CP_TEST_DATE,
	AUTH_DECISION,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	REM_CNT,
	KEV_OPEN,
	KEV_REOPENED,
	UNIQ_CRIT_15_60,
	UNIQ_CRIT_60,
	TOT_CRIT_60,
	UNIQ_IGH_15_60,
	TOT_HIGH_15_60,
	UNIQ_HIGH_60,
	TOT_HIGH_60,
	HWAM_COUNT,
	ASSETRISKTOLERANCE,
	RESIDUALRISK,
	VULNRISKTOLERANCE,
	RESILIENCYSCORE,
	TOT_CRIT_VULNS,
	TOT_HIGH_VULNS,
	DATACENTER_ACRONYM,
	REPORT_ID,
	REPORT_DATE,
	RANKK
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains System related information.'
 as
select
systems.Control_Set_Version_Number_System_Provid
,systems.system_id cfacts_uid
,systems.COMPONENT_ACRONYM
,systems.acronym
,systems.BUSINESS_OWNER
,systems.primary_isso
,systems.primary_operating_location
,systems.sdm
,systems.tlc_phase
,systems.isso
,systems.cra
,systems.GROUP_NAME
,systems.DIVISION_NAME
,systems.Group_Acronym
,systems.Is_MarketPlace
,systems.HVAStatus
,systems.MEFStatus
,systems.Authorization_Package
,systems.ContingencyExpirationDate
,systems.Next_Required_CP_Test_Date
,systems.cp_test_date
,systems.Auth_Decision
,systems.Date_Auth_Memo_Expires
,systems.Is_OA_Ready
,systems.OA_Status
,summary.KEV_Fixed_MonthToDate rem_cnt
,summary.KEV_Open
,summary.KEV_Reopened 
,summary.VulUniqueCritical_gt15_lte60days as uniq_crit_15_60
,summary.VulUniqueCritical_gt60days as uniq_crit_60
,summary.VulCritical_gt60days  as tot_crit_60
,summary.VulUniqueHigh_gt30_lte60days  as uniq_igh_15_60
,summary.VulHigh_gt30_lte60days as tot_high_15_60
,summary.VulUniqueHigh_gt60days as uniq_high_60
,summary.VulHigh_gt60days as tot_high_60
,summary.Assets HWAM_COUNT
,summary.AssetRiskTolerance
,summary.ResidualRisk
,summary.VulnRiskTolerance
,summary.resiliencyscore
,summary.VulCritical as tot_crit_vulns
,summary.VulHigh as tot_high_vulns
,dLookup.DATACENTER_ACRONYM
,snap.REPORT_ID
,snap.Report_Date
,dense_rank()over(order by snap.REPORT_ID desc) as rankk
 from CORE.VW_SYSTEMSUMMARY summary
join (select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap = 1) snap on snap.REPORT_ID=summary.REPORT_ID
    right outer join CORE.VW_SYSTEMS systems on (summary.system_id = systems.system_id) 
 inner join BUS_CYBER_RISK_MANAGEMENT.RPT.V_DIMENSIONAL_LOOKUP1 dLookup on (systems.system_id = dLookup.id) 
where systems.IS_PHANTOMSYSTEM = 0 and systems.IS_EXCLUDEFROMREPORTING = 0;
create or replace view V_SYSTEMSUMMARY_DCRR_VULN(
	JOIN_ID,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_DECISION,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IN_CMS_CLOUD,
	ISSO_COUNT,
	OA_STATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	TLC_PHASE,
	UNIQ_CVE_COUNT,
	CVE_COUNT,
	FISMASEVERITY,
	LESSTHAN25,
	LESSTHAN50,
	GREATERTHAN50,
	GREATERTHAN75,
	CRITICALGT15,
	HIGHGT30,
	MODERATEGT90,
	LOWGT365,
	REPORTDATE
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains vuln related information(CVE count, Fisma Severity)'
 as
 with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union --CR#822 changed Union All to Union to avoid duplicate records on monthend snapshot date
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap = 1)),  
Snapshots as (select Report_ID,Report_Date, snapshot_ID,Is_endOfMonth from ReportIDs r)
select s.system_id as join_ID
,acronym
,Archer_Tracking_ID
,auth_decision
,Component_Acronym
,Group_Acronym
,HVAStatus
,In_CMS_Cloud
,isso_count
,OA_Status
,MEFStatus
,Is_MarketPlace
,tlc_phase
,Uniq_cve_count
,cve_count
,FISMAseverity
,LessThan25
,LessThan50
,GreaterThan50
,GreaterThan75
,CriticalGT15
,HighGT30
,ModerateGT90
,LowGT365
,Report_Date ReportDate
from CORE.VW_SYSTEMS s
right outer JOIN (select system_id, Report_ID from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join Snapshots snap on snap.Report_ID = ss.Report_ID
left outer join (select system_id,count(distinct cve) Uniq_cve_count, count(cve) cve_count, FISMAseverity, Report_ID from CORE.VW_VULHIST where MitigationStatus in ('open', 'reopened')
group by system_id, FISMAseverity, Report_ID) vul on vul.system_id = ss.system_id and 
vul.Report_ID = snap.Report_ID
--Below lines are added for CR #959
left join (select system_id, sum(Q2) + sum(Q3) as LessThan25,sum(Q4) as LessThan50, sum(Q5) as GreaterThan50, sum(Q6) as GreaterThan75 from (SELECT system_id, 
       "'NULL'" AS Q1,
      "'<=0%'" AS Q2,
       "'> 0% and <= 25%'" AS Q3, 
       "'> 25% and <= 50%'" AS Q4, 
       "'> 50% and <= 75%'" AS Q5,
       "'> 75% and <= 100%'" AS Q6
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS
    PIVOT(count(CVE) FOR EPSS_FILTER IN (
      'NULL',
      '<=0%',
      '> 0% and <= 25%', 
      '> 25% and <= 50%', 
      '> 50% and <= 75%', 
      '> 75% and <= 100%')
    ) where lower(MitigationStatus) in ('open', 'reopened')) group by system_id)vulcur on ss.system_id = vulcur.system_id  
 left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by system_id)vulDays on ss.system_id = vulDays.system_id
  ;
create or replace view V_SYSTEMSUMMARY_DCRR_VULN_TEST1(
	JOIN_ID,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_DECISION,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IN_CMS_CLOUD,
	ISSO_COUNT,
	OA_STATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	TLC_PHASE,
	UNIQ_CVE_COUNT,
	CVE_COUNT,
	FISMASEVERITY,
	LESSTHAN25,
	LESSTHAN50,
	GREATERTHAN50,
	GREATERTHAN75,
	DAYSSINCEDISCOVERY,
	REPORTDATE
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains vuln related information(CVE count, Fisma Severity)'
 as
 with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union --CR#822 changed Union All to Union to avoid duplicate records on monthend snapshot date
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=2)),  
Snapshots as (select Report_ID,Report_Date, snapshot_ID,Is_endOfMonth from ReportIDs r)
select s.system_id as join_ID
,acronym
,Archer_Tracking_ID
,auth_decision
,Component_Acronym
,Group_Acronym
,HVAStatus
,In_CMS_Cloud
,isso_count
,OA_Status
,MEFStatus
,Is_MarketPlace
,tlc_phase
,Uniq_cve_count
,cve_count
,FISMAseverity
,LessThan25
,LessThan50
,GreaterThan50
,GreaterThan75
,DAYSSINCEDISCOVERY
,Report_Date ReportDate
from CORE.VW_SYSTEMS s
right outer JOIN (select system_id, Report_ID from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join Snapshots snap on snap.Report_ID = ss.Report_ID
left outer join (select system_id,count(distinct cve) Uniq_cve_count, count(cve) cve_count, FISMAseverity, avg(DAYSSINCEDISCOVERY) DAYSSINCEDISCOVERY, Report_ID from CORE.VW_VULHIST where MitigationStatus in ('open', 'reopened') and report_id = 616
group by system_id, FISMAseverity, Report_ID) vul on vul.system_id = ss.system_id and 
vul.Report_ID = snap.Report_ID
left join (select system_id, sum(Q1)+ sum(Q2) + sum(Q3) as LessThan25,sum(Q4) as LessThan50, sum(Q5) as GreaterThan50, sum(Q6) as GreaterThan75 from (SELECT system_id, 
       "'NULL'" AS Q1,
      "'<=0%'" AS Q2,
       "'> 0% and <= 25%'" AS Q3, 
       "'> 25% and <= 50%'" AS Q4, 
       "'> 50% and <= 75%'" AS Q5,
       "'> 75% and <= 100%'" AS Q6
  FROM DEV_RPT.VW_VULCURR_DETAIL
    PIVOT(count(CVE) FOR EPSS_FILTER IN (
      'NULL',
      '<=0%',
      '> 0% and <= 25%', 
      '> 25% and <= 50%', 
      '> 50% and <= 75%', 
      '> 75% and <= 100%')
    ))group by system_id)vulcur on ss.system_id = vulcur.system_id  
   
  ;
create or replace view V_SYSTEMSUMMARY_MCRR_MILESTONE(
	POAM_ID,
	LATESTMILESTONEUPDATEDATE,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	WEAKNESS_RISK_LEVEL,
	OVERALL_STATUS,
	REPORTNAME
) COMMENT='Used for Tableau in Monthly Cyber Risk Report dashboard: View for monthly Cyber Risk Reporting with Milestone related to System information (Poam Risk Level/Milestone last updated)'
 as
SELECT  distinct m.POAM_ID
,cast(m.LAST_UPDATED as datetime) as LatestMilestoneUpdateDate
,S.Acronym
,s.Component_Acronym
,s.Group_Acronym
,p."Weakness_Risk_Level" Weakness_Risk_Level
,p."Overall_Status" Overall_Status
,reportName
FROM rpt.V_MILESTONE_MONTHENDSNAPSHOT m
INNER JOIN
(SELECT POAM_ID, MAX(cast (LAST_UPDATED as datetime)) AS LatestdateTime
FROM rpt.V_MILESTONE_MONTHENDSNAPSHOT
GROUP BY POAM_ID) drv_m
ON (m.POAM_ID = drv_m.POAM_ID
AND cast(m.LAST_UPDATED as datetime) = drv_m.LatestdateTime)
INNER JOIN (select "Weakness_Risk_Level", "Overall_Status", "POA&M ID", "Archer_Tracking_ID" from
rpt.V_POAMS_MONTHENDSNAPSHOT) P on (m.POAM_ID=P."POA&M ID")
INNER JOIN (select Archer_Tracking_ID, Acronym,Component_Acronym,Group_Acronym from CORE.VW_SYSTEMS) S
on S.Archer_Tracking_ID = P."Archer_Tracking_ID"
 LEFT JOIN rpt.CRR_Component_Params reportName ON ((Acronym = reportName.systems) AND (Component_Acronym = reportName.component) AND (Group_Acronym = reportName.groups))
where datediff(day,(select max(report_date) from core.VW_REPORTSNAPSHOTS where DataCategory = 'CFACTS' and Is_endOfMonth =1),cast(LAST_UPDATED as  datetime)) <-24
and P."Overall_Status" not in ('Closed for System Disposition','Completed','Pending Verification')
group by m.poam_id,cast(m.LAST_UPDATED as datetime),S.Acronym,s.Component_Acronym,s.Group_Acronym,Weakness_Risk_Level,Overall_Status, REPORTNAME;
create or replace view V_SYSTEMSUMMARY_MCRR_POAM(
	ARCHER_TRACKING_ID,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	DAYS_OPEN,
	WEAKNESS_RISK_LEVEL,
	POAM_ID,
	OVERALL_STATUS,
	REPORT_DATE,
	RANKK,
	REPORTNAME
) COMMENT='Used for Tableau in Monthly Cyber Risk Report dashboard: View for monthly Cyber Risk Reporting with POAM related to System information (Poam Risk Level/Poam ID/Weakness Score)'
 as
select ph.Archer_Tracking_ID
,Acronym
,Component_Acronym
,Group_Acronym
,days_open
,WEAKNESS_RISK_LEVEL
,poam_id
,OVERALL_STATUS
,a.report_date
,dense_rank()over(order by a.report_date desc) as rankk
  ,Report_Name.ReportName 
from core.VW_POAMHIST ph
join (select top 2 report_id, report_date, rank()over(order by report_date desc) as rankk from core.REPORT_IDS where is_endofmonth =1 
order by REPORT_DATE desc)a on a.report_id = ph.report_id
inner join (select Archer_Tracking_ID,Component_Acronym,Acronym,Group_Acronym from CORE.VW_SYSTEMS
where TLC_Phase<>'Retire')syst on (ph.Archer_Tracking_ID = syst.Archer_Tracking_ID)
LEFT JOIN 
  rpt.CRR_Component_Params Report_Name ON ((syst.Acronym = Report_Name.systems) AND (syst.Component_Acronym = Report_Name.COMPONENT) AND (syst.Group_Acronym = Report_Name.GROUPS))
where Overall_Status not in ('Completed','Pending Verification');
create or replace view V_SYSTEMSUMMARY_MCRR_SYSTEMS(
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	GROUP_NAME,
	DIVISION_ACRONYM,
	DIVISIONNAME,
	AUTHORIZATION_PACKAGE,
	BUSINESS_OWNER,
	CONTINGENCYEXPIRATIONDATE,
	NEXT_REQUIRED_CP_TEST_DATE,
	CP_TEST_DATE,
	AUTH_DECISION,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	HVASTATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	TLC_PHASE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SDM,
	ISSO,
	CRA,
	CFACTS_UID,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	REPORTDATE,
	ASSETS,
	VULCRITICAL,
	VULCRITICAL_GT30_LTE60DAYS,
	VULCRITICAL_GT60DAYS,
	VULCRITICAL_GTE15DAYS,
	VULCRITICAL_LTE15DAYS,
	VULCRITICAL_LTE30DAYS,
	VULHIGH,
	VULHIGH_GT30_LTE60DAYS,
	VULHIGH_GT60DAYS,
	VULHIGH_LTE30DAYS,
	VULRAW,
	VULRAW_CRITICAL,
	VULRAW_HIGH,
	VULRAW_LOW,
	VULRAW_MEDIUM,
	VULUNIQUECRITICAL_GT15_LTE60DAYS,
	VULUNIQUECRITICAL_GT30_LTE60DAYS,
	VULUNIQUECRITICAL_GT60DAYS,
	VULUNIQUECRITICAL_GTE15DAYS,
	VULUNIQUEHIGH_GT30_LTE60DAYS,
	VULUNIQUEHIGH_GT60DAYS,
	HWAMRAWAWS,
	HWAMRAWBIGFIX,
	HWAMRAWFORESCOUT,
	VULDELETED,
	VULMEDIUM,
	VULLOW,
	VULUNIQUEMEDIUM,
	VULUNIQUELOW,
	ASSETRISKTOLERANCE,
	RESIDUALRISK,
	RESILIENCYSCORE,
	PREVASSETS,
	VULNRISKTOLERANCE,
	TOTALVRT,
	VULCRITICAL_GT15_LTE60DAYS,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_TODAY,
	KEV_FIXED_MONTHTODATE,
	REPORT_ID,
	SYSTEM_ID,
	SYSTEMSUMMARYPRIMARYKEY,
	VULCRITICALREMEDIATED,
	VULHIGHREMEDIATED,
	OVER_DUE,
	PENTEST_COUNT,
	RANKK,
	COMPONENT,
	GROUPS,
	SYSTEMS,
	REPORTNAME
) COMMENT='Used for Tableau in Monthly Cyber Risk Report dashboard: View for monthly Cyber Risk Reporting with system related information (OA Status/VRT/ART/CP Expiry/ATO/Business Owner etc)'
 as
select
  systems.Acronym
  ,systems.Component_Acronym
  ,systems.Group_Acronym
  ,systems.group_name
  ,systems.Division_Acronym
  ,systems.Division_Name DivisionName
  ,systems.Authorization_Package
  ,systems.Business_Owner
  ,systems.ContingencyExpirationDate
  ,systems.Next_Required_CP_Test_Date
  ,systems.CP_Test_Date
  ,systems.Auth_Decision
  ,systems.Date_Auth_Memo_Expires
  ,systems.Is_OA_Ready
  ,systems.OA_Status
  ,systems.HVAStatus
  ,systems.MEFStatus
  ,systems.Is_MarketPlace
  ,systems.TLC_Phase
  ,systems.Primary_ISSO
  ,systems.Primary_Operating_Location
  ,systems.sdm
  ,systems.isso
  ,systems.cra
  ,systems.cfacts_uid
  ,systems.Control_Set_Version_Number_System_Provid
  ,snap.REPORT_DATE as ReportDate
  ,Summary.assets
  ,Summary.vulcritical
  ,Summary.vulcritical_gt30_lte60days
  ,Summary.vulcritical_gt60days
  ,Summary.VulCritical_gte15days
  ,Summary.VulCritical_lte15days
  ,Summary.VulCritical_lte30days
  ,Summary.VulHigh
  ,Summary.VulHigh_gt30_lte60days
  ,Summary.VulHigh_gt60days
  ,Summary.VulHigh_lte30days
  ,Summary.VulRaw
  ,Summary.VulRaw_Critical
  ,Summary.VulRaw_High
  ,Summary.VulRaw_Low
  ,Summary.VulRaw_Medium
  ,Summary.VulUniqueCritical_gt15_lte60days
  ,Summary.VulUniqueCritical_gt30_lte60days
  ,Summary.VulUniqueCritical_gt60days
  ,Summary.VulUniqueCritical_gte15days
  ,Summary.VulUniqueHigh_gt30_lte60days
  ,Summary.VulUniqueHigh_gt60days
  ,Summary.hwamrawaws
  ,Summary.HWAMRawBigFix
  ,Summary.HWAMRawForeScout
  ,Summary.VulDeleted
  ,Summary.VulMedium
  ,Summary.VulLow
  ,Summary.VulUniqueMedium
  ,Summary.VulUniqueLow
  ,Summary.AssetRiskTolerance
  ,Summary.ResidualRisk
  ,Summary.ResiliencyScore
  ,Summary.PrevAssets
  ,Summary.VulnRiskTolerance
  ,summary.VulnRiskTolerance AS TotalVRT
  ,summary.VulCritical_gt15_lte60days
  ,summary.KEV_Open
  ,summary.KEV_Reopened
  ,summary.KEV_Fixed_Today
  ,summary.KEV_Fixed_MonthToDate
  ,Summary.report_id
  ,Summary.system_id
  ,Summary.ID AS SystemSummaryPrimaryKey
  ,summary.VULCRITICALREMEDIATED
  ,summary.VULHIGHREMEDIATED
  ,COALESCE(od.Over_due, 0) as Over_due
  ,COALESCE(pentest_count, 0) pentest_count
  ,dense_rank()over(order by ReportDate desc) as rankk
  ,Report_Name.Component
  ,Report_Name.Groups
  ,Report_Name.Systems
  ,Report_Name.ReportName
  from core.VW_SYSTEMSUMMARY summary
  join (select top 2 report_id,report_date from core.REPORT_IDS where is_endofmonth =1 order by REPORT_DATE desc) snap on snap.REPORT_ID = summary.report_id
  right outer join (select system_id, Acronym, Component_Acronym, Group_Acronym, group_name, Division_Acronym, DIVISION_NAME, Authorization_Package, 
  Business_Owner, ContingencyExpirationDate, Next_Required_CP_Test_Date, CP_Test_Date, Auth_Decision, Date_Auth_Memo_Expires, Is_OA_Ready, 
  OA_Status, HVAStatus, MEFStatus, Is_MarketPlace, TLC_Phase, Primary_ISSO, Primary_Operating_Location, sdm, isso, cra, system_id cfacts_uid,
  Control_Set_Version_Number_System_Provid from CORE.VW_SYSTEMS) systems on summary.system_id = systems.system_id
  left outer join (select "Acronym","Component_Acronym", count(*) as pentest_count from rpt.V_CRMP_PENTEST where "Weakness_Risk_Level" = 'High' and "Overall_Status" in ('Delayed','Ongoing','Draft')
  group by "Acronym","Component_Acronym") pentest on (systems.Acronym = pentest."Acronym" and systems.Component_Acronym = pentest."Component_Acronym")
    left outer join (select Count(P."POA&M ID") Over_due,s.Acronym,s.Component_Acronym from rpt.V_POAMS_MONTHENDSNAPSHOT P
  JOIN (Select Acronym, Component_Acronym, ARCHER_TRACKING_ID, HVAStatus, TLC_Phase from CORE.VW_SYSTEMS) s On s.ARCHER_TRACKING_ID= p."Archer_Tracking_ID"
  
  where
  	   "Overall_Status" in ('Delayed')
  	  AND "Estimated_Completion_Date" <= (select max(report_date) from core.VW_REPORTSNAPSHOTS where datacategory = 'CFACTS' and Is_endOfMonth =1)  --Added per Teresa's request
  	  AND "Weakness_Risk_Level" = 'High'
  	  and s.HVAStatus='Yes' and s.TLC_Phase<>'Retire'
  	  group by s.Acronym,s.Component_Acronym)od on  (systems.Acronym = od.Acronym and systems.Component_Acronym = od.Component_Acronym)
  LEFT JOIN (
  select * from rpt.CRR_COMPONENT_PARAMS
) Report_Name ON ((systems.Acronym = Report_Name.SYSTEMS) AND (systems.component_Acronym = Report_Name.COMPONENT) AND (systems.Group_Acronym = Report_Name.GROUPS));
create or replace view V_SYSTEMSUMMARY_MCRR_VULCOUNT(
	REPORTNAME,
	ACRONYM,
	VULNS_CNT,
	BUCKET,
	LESSTHAN25,
	LESSTHAN50,
	GREATERTHAN50,
	GREATERTHAN75,
	CRITICALGT15,
	HIGHGT30,
	MODERATEGT90,
	LOWGT365
) COMMENT='Vuln data details related to System information (Vuln Severity/Remediated Vulns/KEV''s / Buckets for Age etc)'
 as
  SELECT REPORTNAME
       ,ACRONYM
       ,vulns_cnt
       ,bucket
       ,LessThan25
        ,LessThan50
        ,GreaterThan50
        ,GreaterThan75
        ,CriticalGT15
        ,HighGT30
        ,ModerateGT90
        ,LowGT365
FROM   (SELECT reportname
            ,s.ACRONYM
            ,vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow
            ,LessThan25
            ,LessThan50
            ,GreaterThan50
            ,GreaterThan75
            ,CriticalGT15
            ,HighGT30
            ,ModerateGT90
            ,LowGT365
        FROM CORE.VW_SYSTEMSUMMARY ss
		join CORE.VW_SYSTEMS s on ss.system_id = s.system_id
        --CR #577
        left join (select system_id, sum(Q1)+ sum(Q2) + sum(Q3) as LessThan25,sum(Q4) as LessThan50, sum(Q5) as GreaterThan50, sum(Q6) as GreaterThan75 from (SELECT system_id, 
       "'NULL'" AS Q1,
      "'<=0%'" AS Q2,
       "'> 0% and <= 25%'" AS Q3, 
       "'> 25% and <= 50%'" AS Q4, 
       "'> 50% and <= 75%'" AS Q5,
       "'> 75% and <= 100%'" AS Q6
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS
    PIVOT(count(CVE) FOR EPSS_FILTER IN (
      'NULL',
      '<=0%',
      '> 0% and <= 25%', 
      '> 25% and <= 50%', 
      '> 50% and <= 75%', 
      '> 75% and <= 100%')
    ) where lower(MitigationStatus) in ('open', 'reopened'))group by system_id)vulcur on ss.system_id = vulcur.system_id  
       left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from 
           (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))group by system_id)vulDays on ss.system_id = vulDays.system_id    
        
		 LEFT JOIN (
  select * from rpt.CRR_COMPONENT_PARAMS
) reportName ON (s.ACRONYM = reportName.Systems) AND (component_acronym = reportName.Component) AND (group_acronym = reportName.Groups)
        WHERE  report_id = (SELECT max(REPORT_ID) FROM core.report_ids where is_endofmonth = 1))data
       UNPIVOT(vulns_cnt
              FOR bucket IN ( vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow ) ) AS mrks;
create or replace view V_VULCUR_STAT(
	DW_VUL_ID,
	DATEVULCREATED,
	DATACENTERACRONYM,
	SNAPSHOT_DATE,
	SYSTEMACRONYM,
	DATACENTERID,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	DESCRIPTION,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	OS,
	PLUGINID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	DATACENTER_ID,
	FISMA_ID,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	EPSS_SCORE,
	EPSS_FILTER,
	EPSS_PERCENTILE
) COMMENT='current statistics over all vulns including EPSS metrics'
 as
SELECT 
vm.dw_vul_id 
,vm.INSERT_DATE as dateVulCreated 
,dc.Acronym as DataCenterAcronym
,(select max(report_id) from core.report_ids) as SNAPSHOT_DATE
,s.Acronym as SystemAcronym
,dc.System_ID as DataCenterID
,s.System_ID
,ah.asset_id_tattoo
,vm.cve
,vm.CVSSV2BASESCORE as CVSSv2Base
,vm.CVSSV3BASESCORE as CVSSv3Base
,vm.DaysSinceDiscovery
,0 as DAYSSINCEDISCOVERY_FILTER --added on 082124 as part of CR 959
,NULL as Description
,vm.exploitAvailable
,NULL as familyName
,vm.firstSeen
,vm.FISMAseverity
,vm.lastFound
,vm.MitigationStatus
,ah.OS
,plugs.PLUGIN_ID as pluginID -- 230808 was DW_PLUGIN_ID
,NULL as signature
,NULL as Solution
,ah.source_tool_VUL as source_tool
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.Group_Acronym
,s.Group_Name
,s.Component_Acronym 
,s.Component_Name 
,case vm.IS_KEV
	when 0 then 'No'
	Else 'Yes' 
    End as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated
,epss.epss --added on 082124 as part of CR 959
,0 as EPSS_FILTER --added on 082124 as part of CR 959
,epss.percentile --added on 082124 as part of CR 959
FROM (select max(report_id) REPORT_ID from core.report_ids) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_VUL_ID = v.dw_vul_id
JOIN CORE.VW_ASSETHIST ah on ah.Report_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_Asset_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.datacenter_id
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN (select DW_VUL_ID, listagg(DISTINCT PLUGIN_ID, ', ') WITHIN GROUP (ORDER BY PLUGIN_ID DESC) as PLUGIN_ID FROM CORE.VULPLUGIN GROUP BY DW_VUL_ID) plugs on plugs.dw_vul_id = v.dw_vul_id -- 230829
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = VM.cve --added on 082124 as part of CR 959
;
create or replace view V_VULN_COUNT_BUCKETS(
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	REPORT_ID,
	VULNS_CNT,
	BUCKET
) COMMENT='Contains count of vulnerabilities based there age for latest 2 snapshots (Current/EOM) CVE count for each system/group/component'
 as
SELECT ACRONYM
        ,component_acronym
        ,group_acronym
        ,report_id
        ,vulns_cnt
        ,bucket
FROM   (SELECT s.ACRONYM
            ,s.component_acronym
            ,s.group_acronym
            ,report_id
            ,vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow
        FROM CORE.VW_SYSTEMSUMMARY ss
		join CORE.VW_SYSTEMS s on ss.system_id = s.system_id
        WHERE  report_id in (SELECT REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))
        UNION SELECT REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1))))data
       UNPIVOT(vulns_cnt
              FOR bucket IN ( vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow ) ) AS mrks;
create or replace view V_VULN_ROLLING60DAYS(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Used for Tableau:Contains all the Vulnerabilities for latest 2 snapshots (Current/EOM) with granular CVE IDs for each system/data Center/component'
 as
SELECT * FROM RPT.TEMP_VULN_FV_ROLLING60DAYS;
create or replace schema FISMA COMMENT='Repository for views and other objects necessary to generate FISMA/Audit reporting';

create or replace view VFISMAREPORT_HVA_VUL_CVE_LIST_FOR_FISMA_2_16(
	ACRONYM,
	FIPS_199_OVERALL_IMPACT_RATING,
	CVE,
	CVSSV2BASESCORE,
	TOTAL
) COMMENT='Shows total more than 30 days open/reopen  vulnerability and has CVSSV2BASESCORE 9-10 based on system'
 as
SELECT TOP 10000
s.Acronym
,s.FIPS_199_Overall_Impact_Rating -- 231027 was sh
,v.cve
,v.CVSSV2BASESCORE
,count(1) as Total
from table(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = v.SYSTEM_ID
where v.MitigationStatus IN ('open','reopened')
--and v.Is_applicable = 1
and cast(v.CVSSV2BASESCORE as real) >= 9.0 and cast(v.CVSSV2BASESCORE as real) <= 10.0
and coalesce(s.HVAStatus,'Fake') = 'Yes' -- 231027 was sh
and v.DaysSinceDiscovery > 30
-- and v.RowDisposition = 'C'
group by S.Acronym
,s.FIPS_199_Overall_Impact_Rating -- 231027 was sh
,v.cve
,v.CVSSV2BASESCORE
order by S.Acronym
,s.FIPS_199_Overall_Impact_Rating -- 231027 was sh
,v.cve
,v.CVSSV2BASESCORE
;
create or replace view VFISMAREPORT_HVA_VUL_CVE_LIST_FOR_FISMA_2_16_1(
	ACRONYM,
	FIPS_199_OVERALL_IMPACT_RATING,
	CVE,
	CVSSV2BASE,
	TOTAL
) COMMENT='Shows total more than 60 days open/reopen  vulnerability and has CVSSV2BASESCORE 7-9 based on system'
 as
SELECT TOP 10000
s.Acronym
,s.FIPS_199_Overall_Impact_Rating
,v.cve
,v.CVSSV2BASESCORE as CVSSV2BASE
,count(1) as Total
from table(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = v.SYSTEM_ID -- and s.Is_ExcludeFromReporting = 0 -- and s.Is_PhantomSystem = 0
where v.MitigationStatus IN ('open','reopened')
-- and v.Is_applicable = 1
and cast(v.CVSSV2BASESCORE as real) >= 7.0 and cast(v.CVSSV2BASESCORE as real) <= 8.9
and coalesce(s.HVAStatus,'Fake') = 'Yes'
and v.DaysSinceDiscovery > 60
-- and v.RowDisposition = 'C'
group by S.Acronym
,s.FIPS_199_Overall_Impact_Rating
,v.cve
,v.CVSSV2BASESCORE
order by S.Acronym
,s.FIPS_199_Overall_Impact_Rating
,v.cve
,v.CVSSV2BASESCORE
;
create or replace view VW_FISMAREPORT_DCWITHTIMERANGE(
	DATACENTERACRONYM,
	REPORT_DATE,
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	GROUP_NAME,
	ID,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGIN_ID,
	REPORT_ID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='Fisma Report Vulnerability asset details some dc with specific time range'
 as
SELECT 
dc.Acronym as DATACENTERACRONYM
,r.REPORT_DATE::date as REPORT_DATE
,ah.ASSET_ID_TATTOO
,kev.BODDUEDATE::date as BODDUEDATE
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
--,vm.DATEMITIGATED -- Dont need this if only reporting (open/reopened)
,DATEDIFF(day,vm.firstseen,v.lastFound) as DAYSSINCEDISCOVERY
,NULL as DESCRIPTION
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,vm.DW_VUL_ID
,v.EXPLOITAVAILABLE
,NULL as FAMILYNAME
,vm.FIRSTSEEN::date as FIRSTSEEN
,v.FISMASEVERITY
,s.GROUP_ACRONYM -- 230623
,s.GROUP_NAME
,v.ID
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,v.LASTFOUND::date as LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,plugs.PLUGIN_ID
,r.REPORT_ID
,NULL as SIGNATURE
,NULL as SOLUTION
,'Tenable' as SOURCE_TOOL -- 230623
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM (select * from CORE.REPORT_IDS 
where 
--
-- 240320 The following dates were incorrect
--
--REPORT_DATE::DATE ='7/3/2023' -- Obtained from legacy database
--OR REPORT_DATE::DATE = '7/17/2023' -- Obtained from legacy database
--OR REPORT_DATE::DATE = '9/11/2023' -- Obtained from legacy database
--OR REPORT_DATE::DATE = '10/9/2023' -- Obtained from legacy database
--OR REPORT_DATE::DATE = '10/11/2023' -- Obtained from legacy database
--REPORT_DATE::DATE = '11/6/2023' -- SDW was rolled-out 11/01/2023
-- or REPORT_DATE::DATE = '12/18/2023' 
--
-- 240320 The following are the correct dates
--
--REPORT_DATE::DATE = '11/17/2023'
--REPORT_DATE::DATE = '12/29/2023'
--
-- 240325
report_date::date >= '2024-02-21'::date and report_date::date <= '2024-03-21'::date
) r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
where v.mitigationstatus in ('open','reopened') 
-- 240325 The following filter used in 3/20/24 request
-- 240325 and (dc.Acronym in ('EDC4', 'LMDC', 'DRaaS-CACHE', 'HIGLAS')) -- or s.Acronym = 'LMDC');
-- 240325
and (dc.acronym in ('AWS','AWS GovCloud') or s.acronym in ('AWS','AWS GovCloud','Acquia','CMS MAG','FFM','HETS','IDM'))
;
create or replace view VW_FISMAREPORT_HVA_VUL_B_ERRONEOUS(
	"FIPS 199 Category",
	"1.1.5. Total # of HVA Systems",
	"2.16. Total unique Critical CVE > 30 days",
	"2.16.1. Total unique High CVE > 60 days"
) COMMENT='Shows total HVA systems, unique total critical and high vuln for each FIPS 199 Category with EDC4 excluded. '
 as
SELECT 
fips.FIPS_199_Category as "FIPS 199 Category",coalesce(totsys.TotalHVASystems,0) as "1.1.5. Total # of HVA Systems"
,coalesce("FISMA_2.16".TotalUnqiueCVEs,0) as "2.16. Total unique Critical CVE > 30 days"
,coalesce("FISMA_2.16.1".TotalUnqiueCVEs,0) as "2.16.1. Total unique High CVE > 60 days"
FROM (
select 'High' as FIPS_199_Category, 1 as "Order"
UNION ALL
select 'Moderate' as FIPS_199_Category, 2 as "Order"
UNION ALL
select 'Low' as FIPS_199_Category, 3 as "Order"
) fips
LEFT OUTER JOIN (SELECT sh.FIPS_199_Overall_Impact_Rating,count(1) as TotalHVASystems
	FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap
	JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID 
	JOIN CORE.VW_Systems s on s.System_ID = sh.System_ID
	where coalesce(sh.HVAStatus,'Fake') = 'Yes' 
	and s.Acronym <> 'EDC4' 
	GROUP BY sh.FIPS_199_Overall_Impact_Rating) totsys on totsys.FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category

LEFT OUTER JOIN (select uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysCriticalCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,uniqueSysCriticalCVE.cve
			FROM (SELECT distinct sh.FIPS_199_Overall_Impact_Rating
			,v.cve
			FROM CORE.VW_VulHist v
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.REPORT_ID = v.REPORT_ID
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.REPORT_ID = vsnap.REPORT_ID
			JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID and sh.System_ID = v.System_ID
			JOIN CORE.VW_Systems s on s.System_ID = v.System_ID
	--		where v.RowDisposition = 'C'
			where v.MitigationStatus IN ('open','reopened')
			and cast(v.CVSSV2BASESCORE as real) >= 9.0 and cast(v.CVSSV2BASESCORE as real) <= 10.0
			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
			and s.Acronym <> 'EDC4'  
			and v.DaysSinceDiscovery > 30) uniqueSysCriticalCVE 
			) criticalCVEs
			group by criticalCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysCriticalCVE
	GROUP BY uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16" on "FISMA_2.16".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category

LEFT OUTER JOIN (select uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysHighCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,uniqueSysHighCVE.cve
			FROM (SELECT distinct sh.FIPS_199_Overall_Impact_Rating
			,v.cve
			FROM CORE.VW_VulHist v
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.REPORT_ID = v.REPORT_ID
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.REPORT_ID = vsnap.REPORT_ID
			JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID and sh.System_ID = v.System_ID
			JOIN CORE.VW_Systems s on s.System_ID = v.System_ID
	--		where v.RowDisposition = 'C'
			where v.MitigationStatus IN ('open','reopened')
			and cast(v.CVSSV2BASESCORE as real) >= 7.0 and cast(v.CVSSV2BASESCORE as real) <= 8.9
			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
			and s.Acronym <> 'EDC4'  
			and v.DaysSinceDiscovery > 60) uniqueSysHighCVE 
			) HighCVEs
			group by HighCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysHighCVE
	GROUP BY uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16.1" on "FISMA_2.16.1".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category
ORDER BY fips."Order";
create or replace view VW_FISMAREPORT_HVA_VUL_DATACENTER_BREAKOUT(
	"FIPS 199 Category",
	ACRONYM,
	"1.1.5. Total # of HVA Systems",
	"2.16. Total unique Critical CVE > 30 days",
	"2.16.1. Total unique High CVE > 60 days"
) COMMENT='Shows total HVA systems, unique total critical and high vuln for each FIPS 199 Category and datacenter.'
 as
SELECT 
fips.FIPS_199_Category as "FIPS 199 Category"
,totsys.Acronym
,coalesce(totsys.TotalHVASystems,0) as "1.1.5. Total # of HVA Systems"
,coalesce("FISMA_2.16".TotalUnqiueCVEs,0) as "2.16. Total unique Critical CVE > 30 days"
,coalesce("FISMA_2.16.1".TotalUnqiueCVEs,0) as "2.16.1. Total unique High CVE > 60 days"
FROM (
select 'High' as FIPS_199_Category, 1 as "Order"
UNION ALL
select 'Moderate' as FIPS_199_Category, 2 as "Order"
UNION ALL
select 'Low' as FIPS_199_Category, 3 as "Order"
) fips

LEFT OUTER JOIN (SELECT sh.System_ID,s.Acronym,sh.FIPS_199_Overall_Impact_Rating,count(1) as TotalHVASystems
	FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap
	JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID 
	JOIN CORE.VW_Systems s on s.System_ID = sh.System_ID
	where coalesce(sh.HVAStatus,'Fake') = 'Yes' 
	GROUP BY sh.System_ID,s.Acronym
		,sh.FIPS_199_Overall_Impact_Rating) totsys on totsys.FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category

LEFT OUTER JOIN (select uniqueSysCriticalCVE.System_ID,uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysCriticalCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT System_ID
		  ,FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysCriticalCVE.System_ID,uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,uniqueSysCriticalCVE.cve
			FROM (SELECT distinct
        			sh.System_ID
        			,sh.FIPS_199_Overall_Impact_Rating
        			,v.cve
        			FROM CORE.VW_VulHist v
        			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.REPORT_ID = v.REPORT_ID
        			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.REPORT_ID = vsnap.REPORT_ID
        			JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID and sh.System_ID = v.System_ID
   --     			where v.RowDisposition = 'C'
        			where v.MitigationStatus IN ('open','reopened')
        			and cast(v.CVSSV2BASESCORE as real) >= 9.0 and cast(v.CVSSV2BASESCORE as real) <= 10.0
        			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
        			and v.DaysSinceDiscovery > 30
                  ) uniqueSysCriticalCVE 
        	) criticalCVEs
			group by criticalCVEs.System_ID,criticalCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysCriticalCVE
	GROUP BY uniqueSysCriticalCVE.System_ID,uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16" on "FISMA_2.16".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category and "FISMA_2.16".System_ID = totsys.System_ID

LEFT OUTER JOIN (select uniqueSysHighCVE.System_ID,uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysHighCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT System_ID
		  ,FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysHighCVE.System_ID,uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,uniqueSysHighCVE.cve
			FROM (SELECT distinct
			sh.System_ID
			,sh.FIPS_199_Overall_Impact_Rating
			,v.cve
			FROM CORE.VW_VulHist v
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.REPORT_ID = v.REPORT_ID
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.REPORT_ID = vsnap.REPORT_ID
			JOIN CORE.VW_SystemsHist sh on sh.REPORT_ID = csnap.REPORT_ID and sh.System_ID = v.System_ID
	--		where v.RowDisposition = 'C'
			where v.MitigationStatus IN ('open','reopened')
			and cast(v.CVSSV2BASESCORE as real) >= 7.0 and cast(v.CVSSV2BASESCORE as real) <= 8.9
			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
			and v.DaysSinceDiscovery > 60) uniqueSysHighCVE 
			) HighCVEs
			group by HighCVEs.System_ID,HighCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysHighCVE
	GROUP BY uniqueSysHighCVE.System_ID,uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16.1" on "FISMA_2.16.1".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category and "FISMA_2.16.1".System_ID = totsys.System_ID
ORDER BY fips."Order",totsys.Acronym;
create or replace view VW_FISMAREPORT_KEV_MEANTIME(
	KEV_MEANTIME_DAYS
) COMMENT='Remediation mean time (in days) of all KEV for Quarterly FISMA Report'
 as
--
-- 250110 Teresa; Complete Rewrite of view
-- Requirement is for one number for all KEVs mitigated in the quarter
-- Use AssetHist and VulHist to obtain state of Asset and Vul during the quarter
-- Check if KEV existed during the quarter
-- Check if KEV was active during the quarter (See KEV_CATALOG.DATEDELETED) (i.e. if mitigated after KEV was deleted dont use)
-- Dont count if reopened
-- If data is present in ASSETHIST for a given REPORT_ID then the asset is considered active at that point in time
-- If data is present in VULHIST for a given REPORT_ID then the vulnerability is considered active at that point in time
--
SELECT avg(Days_To_Mitigate) as KEV_MEANTIME_DAYS
FROM (SELECT 
-- Can be used for testing: rpt.report_Id,rpt.report_date,kev.CVE,kev.datedeleted,dw_vul_id
datediff(d,vh.FIRSTSEEN,vh.datemitigated) Days_To_Mitigate
FROM (select min(REPORT_DATE)::date as MIN_REPORT_DATE,max(REPORT_DATE)::date as MAX_REPORT_DATE
    from core.REPORT_IDS 
    where REPORT_DATE::DATE >= '2024-10-01'::DATE and REPORT_DATE::DATE <= '2024-12-31'::DATE) rptRange -- 250110 Teresa
JOIN (select REPORT_ID, REPORT_DATE::date as REPORT_DATE 
    from core.REPORT_IDS
    where IS_VIABLE = 1) rpt on rpt.REPORT_DATE::DATE >= rptRange.MIN_REPORT_DATE and rpt.REPORT_DATE::DATE <= rptRange.MAX_REPORT_DATE
JOIN core.VULHIST vh on vh.REPORT_ID = rpt.REPORT_ID
JOIN core.KEV_CATALOG kev on kev.CVE = vh.CVE
JOIN core.ASSETHIST ah on ah.REPORT_ID = rpt.REPORT_ID and ah.dw_asset_id = vh.dw_asset_id
WHERE vh.MitigationStatus = 'fixed'
and vh.datemitigated >= rptRange.MIN_REPORT_DATE and vh.datemitigated <= rptRange.MAX_REPORT_DATE
and (kev.DATEDELETED is null or vh.datemitigated < kev.DATEDELETED));
create or replace view VW_FISMAREPORT_KEV_MEANTIME_V2(
	KEV_MEANTIME_DAYS
) COMMENT='Remediation mean time of all KEV for Fisma Report within Quarter'
 as
--
-- 250110 Teresa
-- Requirement is for one number for all KEVs mitigated in the quarter
-- Use AssetHist and VulHist to obtain state of Asset and Vul during the quarter
-- Check if KEV existed during the quarter
-- Check if KEV was active during the quarter (See KEV_CATALOG.DATEDELETED) (i.e. if mitigated after KEV was deleted dont use)
-- Dont count if reopened
-- If data is present in ASSETHIST for a given REPORT_ID then the asset is considered active at that point in time
-- If data is present in VULHIST for a given REPORT_ID then the vulnerability is considered active at that point in time
--
SELECT avg(Days_To_Mitigate) as KEV_MEANTIME_DAYS
FROM (SELECT 
--rpt.report_Id,rpt.report_date,kev.CVE,kev.datedeleted,dw_vul_id
datediff(d,vh.FIRSTSEEN,vh.datemitigated) Days_To_Mitigate
FROM (select min(REPORT_DATE)::date as MIN_REPORT_DATE,max(REPORT_DATE)::date as MAX_REPORT_DATE
    from core.REPORT_IDS 
    where REPORT_DATE::DATE >= '2024-10-01'::DATE and REPORT_DATE::DATE <= '2024-12-31'::DATE) rptRange -- 250110 Teresa
-- TESTING where REPORT_DATE::DATE >= '2024-12-01'::DATE and REPORT_DATE::DATE <= '2024-12-31'::DATE) rptRange
JOIN (select REPORT_ID, REPORT_DATE::date as REPORT_DATE 
    from core.REPORT_IDS
    where IS_VIABLE = 1) rpt on rpt.REPORT_DATE::DATE >= rptRange.MIN_REPORT_DATE and rpt.REPORT_DATE::DATE <= rptRange.MAX_REPORT_DATE
JOIN core.VULHIST vh on vh.REPORT_ID = rpt.REPORT_ID
--JOIN core.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN core.KEV_CATALOG kev on kev.CVE = vh.CVE
JOIN core.ASSETHIST ah on ah.REPORT_ID = rpt.REPORT_ID and ah.dw_asset_id = vh.dw_asset_id
WHERE vh.MitigationStatus = 'fixed'
-- and kev.Is_Deleted = 0
--and vh.DeletionReason IS NULL
-- 240607 and vh.INSERT_DATE> '12/01/2023' and vh.datemitigated< '2/28/2024'
-- 240826 and vh.INSERT_DATE >= '03/01/2024' and vh.datemitigated <= '05/31/2024'  -- 240607 Requested by Teresa
and vh.datemitigated >= rptRange.MIN_REPORT_DATE and vh.datemitigated <= rptRange.MAX_REPORT_DATE
and (kev.DATEDELETED is null or vh.datemitigated < kev.DATEDELETED));
create or replace view VW_FISMA_AUDIT_DECOMMISSIONED_ASSETS(
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEDELETED,
	DELETIONREASON,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_HWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	VULNRISKTOLERANCE
) COMMENT='CRITICAL; FISMA Audit request for decommissioned assets.\t'
 as
SELECT 
a.ASSET_ID_TATTOO
,a.AWS_INSTANCESTATUS
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID -- 230712
,a.COMPUTER_TYPE
,dc.ACRONYM as DATACENTER_ACRONYM
,dc.COMMONNAME as DATACENTER_COMMONNAME
,a.DATACENTER_ID
,a.DATEDELETED::date as DATEDELETED
--,a.DATEMODIFIED::date as DATEMODIFIED
,a.DELETIONREASON
,a.DEVICEMODEL
,dr.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,a.INSERT_DATE::date as INSERT_DATE
,aic.IPV4
,aic.IPV6
,a.IS_APPLICABLE
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.LAST_CONFIRMED_TIME::date as LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE::date as LASTASSETUPDATE
,a.LASTSEEN_HWAM::date as LASTSEEN_HWAM
,a.LASTSEEN_VUL::date as LASTSEEN_VUL
,aic.MACADDRESS
,a.MOTHERBOARD
,aic.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_VUL
,s.ACRONYM as SYSTEM_ACRONYM
,s.COMMONNAME as SYSTEM_COMMONNAME
,s.SYSTEM_ID
,a.TENABLEUUID
,a.TENANT_ID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join (select dw_asset_id,MAX(report_id) as Max_REPORT_ID from CORE.ASSETINTERFACECOALESCEDHIST group by dw_asset_id) maic on maic.dw_asset_id = a.dw_asset_id
left outer join CORE.ASSETINTERFACECOALESCEDHIST aic on aic.DW_ASSET_ID = a.DW_ASSET_ID and aic.report_id = maic.Max_REPORT_ID

Where a.Is_Applicable = 0 and a.datedeleted::date >= '2024-02-01'::date;
create or replace view VW_FISMA_AUDIT_VULHIST_EXCLUDE_KEV(
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DAYSSINCEDISCOVERY,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	REPORT_DATE,
	REPORT_ID,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='FISMA Audit - Vulnerability History - Exclude KEV'
 as
SELECT 
ah.ASSET_ID_TATTOO
,kev.BODDUEDATE
,s.COMPONENT_ACRONYM
,vm.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
,dc.Acronym as DATACENTERACRONYM
,DATEDIFF(day,vm.firstseen,v.lastFound) as DAYSSINCEDISCOVERY
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,vm.DW_VUL_ID
,v.EXPLOITAVAILABLE
,TO_CHAR(vm.FIRSTSEEN,'mm/dd/yyyy') as FIRSTSEEN
,v.FISMASEVERITY
,s.GROUP_ACRONYM
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,TO_CHAR(v.LASTFOUND,'mm/dd/yyyy') as LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,TO_CHAR(r.REPORT_DATE,'mm/dd/yyyy') as REPORT_DATE
,r.REPORT_ID
,'Tenable' as SOURCE_TOOL
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM CORE.REPORT_IDS r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
where r.is_endofmonth = 1 
and year(r.report_date::date) = 2024 
-- Produce output by month because of volume
and month(r.report_date::date) in (2)
--and month(r.report_date::date) in (3)
--and month(r.report_date::date) in (4)
and v.MitigationStatus IN ('open','reopened')
and kev.ID IS NULL;
create or replace view VW_FISMA_AUDIT_VULHIST_KEV(
	ASSET_ID_TATTOO,
	BODDUEDATE,
	COMPONENT_ACRONYM,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DAYSSINCEDISCOVERY,
	DNSNAME,
	DW_ASSET_ID,
	DW_VUL_ID,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	GROUP_ACRONYM,
	IP,
	IS_BOD,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	REPORT_DATE,
	REPORT_ID,
	SOURCE_TOOL,
	SYSTEM_ID,
	SYSTEMACRONYM
) COMMENT='FISMA Audit - Vulnerability History - KEV'
 as
SELECT 
ah.ASSET_ID_TATTOO
,TO_CHAR(kev.BODDUEDATE,'mm/dd/yyyy') as BODDUEDATE
,s.COMPONENT_ACRONYM
,vm.CVE
,v.CVSSV2BASESCORE
,v.CVSSV3BASESCORE
,ah.DATACENTER_ID
,dc.Acronym as DATACENTERACRONYM
,DATEDIFF(day,vm.firstseen,v.lastFound) as DAYSSINCEDISCOVERY
,ah.FQDN as DNSNAME
,ah.DW_ASSET_ID
,vm.DW_VUL_ID
,v.EXPLOITAVAILABLE
,TO_CHAR(vm.FIRSTSEEN,'mm/dd/yyyy') as FIRSTSEEN
,v.FISMASEVERITY
,s.GROUP_ACRONYM
,ah.IPv4 as IP
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_BOD
,TO_CHAR(v.LASTFOUND,'mm/dd/yyyy') as LASTFOUND
,ah.MACADDRESS
,v.MITIGATIONSTATUS
,ah.NETBIOSNAME
,ah.OS
,TO_CHAR(r.REPORT_DATE,'mm/dd/yyyy') as REPORT_DATE
,r.REPORT_ID
,'Tenable' as SOURCE_TOOL
,ah.SYSTEM_ID
,s.Acronym as SYSTEMACRONYM
FROM CORE.REPORT_IDS r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE -- Do not check IS_DELETED = 0. We want to know if it was a BOD at that point in time
JOIN CORE.VW_ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
LEFT OUTER JOIN CORE.VULPLUGINS_COALESCED plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
where r.is_endofmonth = 1 
and year(r.report_date::date) = 2024 
and month(r.report_date::date) in (2,3,4)
and v.MitigationStatus IN ('open','reopened')
and kev.insert_date::date <= r.report_date::date;
create or replace view VW_FISMA_OPERATED_BY(
	FIPS_199_OVERALL_IMPACT_RATING,
	OPERATED_BY,
	TOTALSYSTEMS
) COMMENT='Fisma Report Total Systems by FIPS and Operated By'
 as
select fips_199_overall_impact_rating,operated_by,count(1) TotalSystems 
from core.VW_SYSTEMS
where is_operationalsystem = 1 and totalassets > 0 
group by fips_199_overall_impact_rating,operated_by
order by fips_199_overall_impact_rating,operated_by
;
create or replace view VW_VFISMAREPORT_HVA_VUL(
	"FIPS 199 Category",
	"1.1.5. Total # of HVA Systems",
	"2.16. Total unique Critical CVE > 30 days",
	"2.16.1. Total unique High CVE > 60 days"
) COMMENT='Shows total HVA systems, unique total critical and high vuln for each FIPS 199 Category.'
 as
SELECT 
fips.FIPS_199_Category as "FIPS 199 Category",coalesce(totsys.TotalHVASystems,0) as "1.1.5. Total # of HVA Systems"
,coalesce("FISMA_2.16".TotalUnqiueCVEs,0) as "2.16. Total unique Critical CVE > 30 days"
,coalesce("FISMA_2.16.1".TotalUnqiueCVEs,0) as "2.16.1. Total unique High CVE > 60 days"
FROM (
select 'High' as FIPS_199_Category, 1 as "Order"
UNION ALL
select 'Moderate' as FIPS_199_Category, 2 as "Order"
UNION ALL
select 'Low' as FIPS_199_Category, 3 as "Order"
) fips
LEFT OUTER JOIN (SELECT sh.FIPS_199_Overall_Impact_Rating,count(1) as TotalHVASystems
	FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap
	JOIN CORE.VW_SystemsHist sh on sh.Report_ID = csnap.Report_ID 
	JOIN CORE.VW_Systems s on s.SYSTEM_ID = sh.SYSTEM_ID
	where coalesce(sh.HVAStatus,'Fake') = 'Yes' 
	GROUP BY sh.FIPS_199_Overall_Impact_Rating) totsys on totsys.FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category

LEFT OUTER JOIN (select uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysCriticalCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT SYSTEM_ID
		  ,FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysCriticalCVE.SYSTEM_ID,uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating,uniqueSysCriticalCVE.cve
			FROM (SELECT distinct
			sh.SYSTEM_ID
			,sh.FIPS_199_Overall_Impact_Rating
			,v.cve
			FROM CORE.VW_VulHist v
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.Report_ID = v.Report_ID
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.Report_ID = vsnap.Report_ID
			JOIN CORE.VW_SystemsHist sh on sh.Report_ID = csnap.Report_ID and sh.SYSTEM_ID = v.SYSTEM_ID
	--		where v.RowDisposition = 'C'
			where v.MitigationStatus IN ('open','reopened')
			and cast(v.CVSSV2BASESCORE as real) >= 9.0 and cast(v.CVSSV2BASESCORE as real) <= 10.0
			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
			and v.DaysSinceDiscovery > 30) uniqueSysCriticalCVE 
			) criticalCVEs
			group by criticalCVEs.SYSTEM_ID
		,criticalCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysCriticalCVE
	GROUP BY uniqueSysCriticalCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16" on "FISMA_2.16".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category

LEFT OUTER JOIN (select uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,SUM(uniqueSysHighCVE.TotalUnqiueCVEs) as TotalUnqiueCVEs
	FROM (SELECT SYSTEM_ID
		  ,FIPS_199_Overall_Impact_Rating
		  ,count(1) TotalUnqiueCVEs
		FROM (SELECT uniqueSysHighCVE.SYSTEM_ID,uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating,uniqueSysHighCVE.cve
			FROM (SELECT distinct
			sh.SYSTEM_ID
			,sh.FIPS_199_Overall_Impact_Rating
			,v.cve
			FROM CORE.VW_VulHist v
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) vsnap on vsnap.Report_ID = v.Report_ID
			join TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) csnap on csnap.Report_ID = vsnap.Report_ID
			JOIN CORE.VW_SystemsHist sh on sh.Report_ID = csnap.Report_ID and sh.SYSTEM_ID = v.SYSTEM_ID
--			where v.RowDisposition = 'C'
			where v.MitigationStatus IN ('open','reopened')
			and cast(v.CVSSV2BASESCORE as real) >= 7.0 and cast(v.CVSSV2BASESCORE as real) <= 8.9
			and coalesce(sh.HVAStatus,'Fake') = 'Yes'
			and v.DaysSinceDiscovery > 60) uniqueSysHighCVE 
			) HighCVEs
			group by HighCVEs.SYSTEM_ID
		,HighCVEs.FIPS_199_Overall_Impact_Rating) uniqueSysHighCVE
	GROUP BY uniqueSysHighCVE.FIPS_199_Overall_Impact_Rating) "FISMA_2.16.1" on "FISMA_2.16.1".FIPS_199_Overall_Impact_Rating = fips.FIPS_199_Category
ORDER BY fips."Order";
create or replace schema HHS;

create or replace secure view SEC_VW_CRM_MDR_EXPORT(
	ASSET_ID_TATTOO,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	FISMA_ID,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	MDR_FIRST_SEEN,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	VENDOR
) COMMENT='Export CRM MDR TO HHS'
 as
SELECT 
a.ASSET_ID_TATTOO
,a.DEVICEMODEL
,dr.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,s.SYSTEM_ID as FISMA_ID
,aic.FQDN
,aic.HOSTNAME
,aic.IPV4
,aic.IPV6
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.LAST_CONFIRMED_TIME as LAST_SEEN
,aic.MACADDRESS
,a.INSERT_DATE as MDR_FIRST_SEEN
,a.MOTHERBOARD
,aic.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.SOURCE_TOOL_LASTSEEN as VENDOR
FROM CORE.ASSET a
--join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DEVICETYPES dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DEVICEROLES dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID
Where a.IS_APPLICABLE = 1;
create or replace schema MONITOR;

create or replace TABLE AD_CRM_TRAINING_DATASET_ASSETS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(6),
	ASSETS NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_CRM_TRAINING_DATASET_ASSETS_AWS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(10),
	ASSETS_AWS NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_CRM_TRAINING_DATASET_ASSETS_AWS_GOVCLOUD (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(19),
	ASSETS_AWS_GOVCLOUD NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_CRM_TRAINING_DATASET_ASSETS_PCT_AWS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(14),
	ASSETS_PCT_AWS NUMBER(38,6),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_ASSETS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	ASSETS NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_ASSETS_FISMA (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	DISTINCT_FISMA NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_ASSET_SOFTWARE (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	SWAM_ID NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_BOD_FISMA (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	DISTINCT_FISMA NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_CFACTS_USERMAPPINGS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	TOTAL_MAPPINGS NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_ROW_COUNTS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	ROW_COUNTS NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_V_CRMP_OATO_SYSTEMS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	STATUS_COUNT NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_POAM (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	PHASE_COUNT NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_SYSTEMS (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	PHASE_COUNT NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_VULN (
	DATE TIMESTAMP_NTZ(9),
	TARGET VARCHAR(16777216),
	PHASE_COUNT NUMBER(38,0),
	IS_ANOMALY BOOLEAN
);
create or replace TABLE CRM_ANOMALY_DETECTION_ASSETS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE CRM_ANOMALY_DETECTION_ASSETS_AWS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE CRM_ANOMALY_DETECTION_ASSETS_AWS_GOVCLOUD (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE CRM_ANOMALY_DETECTION_ASSETS_PCT_AWS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE RDI_ANOMALY_DETECTION_ASSETS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE RDI_ANOMALY_DETECTION_DASHBOARD_ROW_COUNTS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE RDI_ANOMALY_DETECTION_VW_VULN_ROLLING60DAYS (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE RDI_ANOMALY_DETECTION_V_BOD_SUMMARY (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace TABLE RDI_ANOMALY_DETECTION_V_CFACTS_USERMAPPING (
	SERIES VARIANT,
	TS TIMESTAMP_NTZ(9),
	Y FLOAT,
	FORECAST FLOAT,
	LOWER_BOUND FLOAT,
	UPPER_BOUND FLOAT,
	IS_ANOMALY BOOLEAN,
	PERCENTILE FLOAT,
	DISTANCE FLOAT
);
create or replace view VW_AD_CRM_TRAINING_DATASET_SUP_ASSETS(
	DATE,
	TARGET,
	ASSETS,
	IS_ANOMALY
) as
    SELECT
        TO_TIMESTAMP_NTZ(DATE) AS DATE,
        TARGET,
        ASSETS,
        IS_ANOMALY
    FROM 
        BUS_CYBER_RISK_MANAGEMENT.MONITOR.AD_CRM_TRAINING_DATASET_ASSETS
    WHERE 
        DATE >= DATE_TRUNC('WEEK', CURRENT_DATE) - INTERVAL '12 WEEKS'
        AND DATE < DATE_TRUNC('DAY', CURRENT_DATE)
    ORDER BY 
        DATE;
create or replace view VW_AD_CRM_TRAINING_DATASET_SUP_ASSETS_AWS(
	DATE,
	TARGET,
	ASSETS_AWS,
	IS_ANOMALY
) as
    SELECT
        TO_TIMESTAMP_NTZ(DATE) AS DATE,
        TARGET,
        ASSETS_AWS,
        IS_ANOMALY
    FROM 
        BUS_CYBER_RISK_MANAGEMENT.MONITOR.AD_CRM_TRAINING_DATASET_ASSETS_AWS
    WHERE 
        DATE >= DATE_TRUNC('WEEK', CURRENT_DATE) - INTERVAL '12 WEEKS'
        AND DATE < DATE_TRUNC('DAY', CURRENT_DATE)
    ORDER BY 
        DATE;
create or replace view VW_AD_CRM_TRAINING_DATASET_SUP_ASSETS_AWS_GOVCLOUD(
	DATE,
	TARGET,
	ASSETS_AWS_GOVCLOUD,
	IS_ANOMALY
) as
    SELECT
        TO_TIMESTAMP_NTZ(DATE) AS DATE,
        TARGET,
        ASSETS_AWS_GOVCLOUD,
        IS_ANOMALY
    FROM 
        BUS_CYBER_RISK_MANAGEMENT.MONITOR.AD_CRM_TRAINING_DATASET_ASSETS_AWS_GOVCLOUD
    WHERE 
        DATE >= DATE_TRUNC('WEEK', CURRENT_DATE) - INTERVAL '12 WEEKS'
        AND DATE < DATE_TRUNC('DAY', CURRENT_DATE)
    ORDER BY 
        DATE;
create or replace view VW_AD_CRM_TRAINING_DATASET_SUP_ASSETS_PCT_AWS(
	DATE,
	TARGET,
	ASSETS_PCT_AWS,
	IS_ANOMALY
) as
    SELECT
        TO_TIMESTAMP_NTZ(DATE) AS DATE,
        TARGET,
        ASSETS_PCT_AWS,
        IS_ANOMALY
    FROM 
        BUS_CYBER_RISK_MANAGEMENT.MONITOR.AD_CRM_TRAINING_DATASET_ASSETS_PCT_AWS
    WHERE 
        DATE >= DATE_TRUNC('WEEK', CURRENT_DATE) - INTERVAL '12 WEEKS'
        AND DATE < DATE_TRUNC('DAY', CURRENT_DATE)
    ORDER BY 
        DATE;
create or replace view VW_REPORT_IDS(
	REPORT_ID,
	IS_VIABLE,
	IS_ENDOFMONTH,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	ASSETS_AWS_GOVCLOUD,
	ASSETS_PCT_AWS,
	ASSETS_CREATED_TODAY,
	ASSETS_DELETED_TODAY,
	ASSETS_NEVER_SCANNED,
	ASSETS_NOT_SCANNED_LAST3DAYS,
	ASSETS_UNKNOWN_DEVICETYPE,
	DUPLICATE_DATACENTER_TATTOO_PAIR,
	PLUGINS_CREATED_TODAY,
	PLUGINS_CRITICAL,
	PLUGINS_DELETED_TODAY,
	PLUGINS_FIXED_TODAY,
	PLUGINS_HIGH,
	PLUGINS_INACTIVE_ASSET_TODAY,
	PLUGINS_LOW,
	PLUGINS_MEDIUM,
	PLUGINS_OPEN,
	PLUGINS_REOPENED,
	SYSTEMS_DEVELOP,
	SYSTEMS_INITIATE,
	SYSTEMS_OPERATE,
	SYSTEMS_RETIRE,
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID,
	VUL_AWS,
	VUL_PCT_AWS,
	VUL_CRITICAL,
	VUL_DELETED_TODAY,
	VUL_FIXED_TODAY,
	VUL_GOVCLOUD,
	VUL_HIGH,
	VUL_INACTIVE_ASSET_TODAY,
	VUL_LOW,
	VUL_MEDIUM,
	VUL_OPEN,
	VUL_REOPENED,
	COMMENTS
) COMMENT='Enterprise level view of basic daily totals (Systems,Assets,Vulnerbilities, etc.)\t'
 as
select
REPORT_ID
,IS_VIABLE -- 240416 CR873
,IS_ENDOFMONTH
,substring(REPORT_DATE::varchar,1,10) as REPORT_DATE
,ASSETS
,ASSETS_AWS -- 240103
,ASSETS_AWS_GOVCLOUD -- 240103
,((ASSETS_AWS + ASSETS_AWS_GOVCLOUD) / ASSETS) * 100.0 as ASSETS_PCT_AWS -- 240103
,ASSETS_CREATED_TODAY -- 231207
,ASSETS_DELETED_TODAY -- 231207
,ASSETS_NEVER_SCANNED
,ASSETS_NOT_SCANNED_LAST3DAYS
,ASSETS_UNKNOWN_DEVICETYPE
,DUPLICATE_DATACENTER_TATTOO_PAIR
,PLUGINS_CREATED_TODAY -- 240118
,PLUGINS_CRITICAL -- 240118
,PLUGINS_DELETED_TODAY -- 240118
,PLUGINS_FIXED_TODAY -- 240118
,PLUGINS_HIGH -- 240118
,PLUGINS_INACTIVE_ASSET_TODAY -- 240118
,PLUGINS_LOW -- 240118
,PLUGINS_MEDIUM -- 240118
,PLUGINS_OPEN -- 240118
,PLUGINS_REOPENED -- 240118
,SYSTEMS_DEVELOP
,SYSTEMS_INITIATE
,SYSTEMS_OPERATE
,SYSTEMS_RETIRE
,TEMP_HWAM_UNASSIGNED_DW_ASSET_ID
,VUL_AWS -- 240103
,(VUL_AWS + VUL_GOVCLOUD) / (VUL_CRITICAL + VUL_HIGH + VUL_MEDIUM + VUL_LOW) * 100.0 as VUL_PCT_AWS -- 240103
,VUL_CRITICAL
,VUL_DELETED_TODAY
,VUL_FIXED_TODAY
,VUL_GOVCLOUD -- 240103
,VUL_HIGH
,VUL_INACTIVE_ASSET_TODAY
,VUL_LOW
,VUL_MEDIUM
,VUL_OPEN
,VUL_REOPENED
,COMMENTS
FROM CORE.REPORT_IDS
order by REPORT_ID DESC;
CREATE OR REPLACE PROCEDURE "ANOMALY_DETECTION_ALERT"("TABLE_NAME" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS CALLER
AS '
var result = snowflake.execute(
    {
        sqlText: `
        WITH last_week_averages AS (
            SELECT
                SERIES AS SERIES_v1,
                AVG(max_y_per_day) AS average_count
            FROM (
                SELECT
                    SERIES,
                    DATE_TRUNC(''day'', TS) AS day,
                    MAX(Y) AS max_y_per_day
                FROM
                    IDENTIFIER(:1)
                WHERE
                    TS >= DATE_TRUNC(''week'', CURRENT_DATE()) - INTERVAL ''1 week''
                    AND TS < DATE_TRUNC(''week'', CURRENT_DATE())
                GROUP BY
                    SERIES, DATE_TRUNC(''day'', TS)
            ) AS max_y_per_day_table
            GROUP BY
                SERIES
        )
        
        SELECT
            TS AS date,
            Y AS count,
            FORECAST AS expected_count,
            SERIES AS target,
            IS_ANOMALY AS anomaly,
            DISTANCE AS z_score,
            avg_count.average_count
        FROM
            IDENTIFIER(:1) adt
        JOIN
            last_week_averages avg_count ON adt.SERIES = avg_count.SERIES_v1
        WHERE
            DATE_TRUNC(''day'', TS) = CURRENT_DATE()
            AND IS_ANOMALY = TRUE
            AND DISTANCE < -3;
        `,
        binds: [TABLE_NAME]
    }
);


var date = [];
var target = [];
var z_score = [];
var expected_count = [];
var current_count = [];
var metadata_table = [];
var table_name = [];
var average_count = [];
table_name.push(TABLE_NAME);
metadata_table.push(''MONITOR.VW_REPORT_IDS'');

while (result.next()) {
    date.push(result.getColumnValue(''DATE''))
    target.push(result.getColumnValue(''TARGET''))
    z_score.push(result.getColumnValue(''Z_SCORE''))
    expected_count.push(result.getColumnValue(''EXPECTED_COUNT''))
    current_count.push(result.getColumnValue(''COUNT''))
    average_count.push(result.getColumnValue(''AVERAGE_COUNT''))
}

if (date.length > 0) {
    var final_msg = {"metadata_table":metadata_table, "table_name":table_name, "date":date, "target":target, "z_score":z_score, "expected_count":expected_count, "current_count":current_count, "average_count":average_count};
    var stmt = snowflake.createStatement(
          {
            sqlText: `SELECT FN_CRM_SEND_SLACK_MESSAGE_ANOMALY_DETECTION(:1, ''CRM_SDW'');`,
            binds: [JSON.stringify(final_msg)]
          }
       );
    var result = stmt.execute();
    result.next();
}
';
CREATE OR REPLACE FUNCTION "FN_CRM_SEND_SLACK_MESSAGE_ANOMALY_DETECTION"("MSG" VARCHAR(16777216), "ENV" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION_CRM)
SECRETS = ('crm_sdw_url'=BUS_CYBER_RISK_MANAGEMENT.CORE.SLACK_CRM_SDW_WEBHOOK_URL)
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import datetime
import json

def main(msg, env): 
    # Retrieve the Webhook URL from the SECRET object
    if env == ''CRM_SDW'':
        webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    else:
        raise Exception(''Invalid Slack Webhook'')

    # check for JSON, but allow a string
    try:
        json.loads(msg)
    except ValueError as e:
        # programmer did not send valid JSON, so just display msg as a string
        slack_data = {
         "text": f"Snowflake says: {msg}"
        }
    else:
        # assuming if msg contains these strings and is valid JSON, then the programmer has built the Slack payload themselves
        if (''"attachments":'' in msg) and (''"mrkdwn_in":'' in msg): 
            slack_data = json.loads(msg)
        else:
        # else format the Slack payload based on msg
            slack_data = load_msg_to_slack(msg)

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"

def load_msg_to_slack(msg):
    blocks = []
    msg = json.loads(msg)

    for i in range(len(msg["target"])):
        block = {
            "type": "section",
            "text": {
                "type": "mrkdwn",
                "text": f''Anomaly Alert in {msg["metadata_table"][0]}\\nTarget: {msg["target"][i]}\\nDate: {msg["date"][i].split(" ")[0]}\\nCounts Today: {msg["current_count"][i]}\\nCounts Since Last Week: {msg["average_count"][i]}\\n(BETA) Expected Count: {msg["expected_count"][i]}\\n(BETA) Z-score: {msg["z_score"][i]}''
            }
        }
        blocks.append(block)

    new_msg = {
        "blocks": blocks
    }    
    return new_msg
';
create or replace task TSK_CRM_AD_ASSETS
	schedule='USING CRON 0 7 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=99999
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_CRM_ASSETS AS
        SELECT
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) AS date,
            'ASSETS' as target,
            COALESCE(ASSETS,0) as assets,
        FROM
            BUS_CYBER_RISK_MANAGEMENT.MONITOR.VW_REPORT_IDS
        WHERE
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) = current_date()
        ORDER BY
            date;

        -- Keeps training data up to date
        INSERT INTO AD_CRM_TRAINING_DATASET_ASSETS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_CRM_ASSETS;
        
        -- This is the step that creates your predictions.
        CALL anomaly_detection_crm_assets!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_CRM_ASSETS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ASSETS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS CRM_ANOMALY_DETECTION_ASSETS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO CRM_ANOMALY_DETECTION_ASSETS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_CRM_ASSETS;
    END;
create or replace task TSK_CRM_AD_ASSETS_ALERT
	warehouse=COMPUTE_WH
	after BUS_CYBER_RISK_MANAGEMENT.MONITOR.TSK_CRM_AD_ASSETS
	as CALL ANOMALY_DETECTION_ALERT('CRM_ANOMALY_DETECTION_ASSETS');
create or replace task TSK_CRM_AD_ASSETS_AWS
	schedule='USING CRON 0 7 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=99999
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_CRM_ASSETS_AWS AS
        SELECT
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) AS date,
            'ASSETS_AWS' as target, 
            COALESCE(ASSETS_AWS,0) as assets_aws,
        FROM
            BUS_CYBER_RISK_MANAGEMENT.MONITOR.VW_REPORT_IDS
        WHERE
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) = current_date()
        ORDER BY
            date;

        -- Keeps training data up to date
        INSERT INTO AD_CRM_TRAINING_DATASET_ASSETS_AWS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_CRM_ASSETS_AWS;
        
        -- This is the step that creates your predictions.
        CALL anomaly_detection_crm_assets_aws!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_CRM_ASSETS_AWS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ASSETS_AWS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS CRM_ANOMALY_DETECTION_ASSETS_AWS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO CRM_ANOMALY_DETECTION_ASSETS_AWS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_CRM_ASSETS_AWS;
    END;
create or replace task TSK_CRM_AD_ASSETS_AWS_ALERT
	warehouse=COMPUTE_WH
	after BUS_CYBER_RISK_MANAGEMENT.MONITOR.TSK_CRM_AD_ASSETS_AWS
	as CALL ANOMALY_DETECTION_ALERT('CRM_ANOMALY_DETECTION_ASSETS_AWS');
create or replace task TSK_CRM_AD_ASSETS_AWS_GOVCLOUD
	schedule='USING CRON 0 7 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=99999
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_CRM_ASSETS_AWS_GOVCLOUD AS
        SELECT
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) AS date,
            'ASSETS_AWS_GOVCLOUD' as target,
            COALESCE(ASSETS_AWS_GOVCLOUD,0) as assets_aws_govcloud,
        FROM
            BUS_CYBER_RISK_MANAGEMENT.MONITOR.VW_REPORT_IDS
        WHERE
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) = current_date()
        ORDER BY
            date;

        -- Keeps training data up to date
        INSERT INTO AD_CRM_TRAINING_DATASET_ASSETS_AWS_GOVCLOUD
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_CRM_ASSETS_AWS_GOVCLOUD;
        
        -- This is the step that creates your predictions.
        CALL anomaly_detection_crm_assets_aws_govcloud!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_CRM_ASSETS_AWS_GOVCLOUD'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ASSETS_AWS_GOVCLOUD',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS CRM_ANOMALY_DETECTION_ASSETS_AWS_GOVCLOUD AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO CRM_ANOMALY_DETECTION_ASSETS_AWS_GOVCLOUD SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_CRM_ASSETS_AWS_GOVCLOUD;
    END;
create or replace task TSK_CRM_AD_ASSETS_AWS_GOVCLOUD_ALERT
	warehouse=COMPUTE_WH
	after BUS_CYBER_RISK_MANAGEMENT.MONITOR.TSK_CRM_AD_ASSETS_AWS_GOVCLOUD
	as CALL ANOMALY_DETECTION_ALERT('CRM_ANOMALY_DETECTION_ASSETS_AWS_GOVCLOUD');
create or replace task TSK_CRM_AD_ASSETS_PCT_AWS
	schedule='USING CRON 0 7 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=99999
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_CRM_ASSETS_PCT_AWS AS
        SELECT
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) AS date,
            'ASSETS_PCT_AWS' as target,
            COALESCE(ASSETS_PCT_AWS,0) as assets_pct_aws,
        FROM
            BUS_CYBER_RISK_MANAGEMENT.MONITOR.VW_REPORT_IDS
        WHERE
            DATE_TRUNC('day', to_timestamp_ntz(REPORT_DATE)) = current_date()
        ORDER BY
            date;

        -- Keeps training data up to date
        INSERT INTO AD_CRM_TRAINING_DATASET_ASSETS_PCT_AWS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_CRM_ASSETS_PCT_AWS;
        
        -- This is the step that creates your predictions.
        CALL anomaly_detection_crm_assets_pct_aws!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_CRM_ASSETS_PCT_AWS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ASSETS_PCT_AWS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS CRM_ANOMALY_DETECTION_ASSETS_PCT_AWS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO CRM_ANOMALY_DETECTION_ASSETS_PCT_AWS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_CRM_ASSETS_PCT_AWS;
    END;
create or replace task TSK_CRM_AD_ASSETS_PCT_AWS_ALERT
	warehouse=COMPUTE_WH
	after BUS_CYBER_RISK_MANAGEMENT.MONITOR.TSK_CRM_AD_ASSETS_PCT_AWS
	as CALL ANOMALY_DETECTION_ALERT('CRM_ANOMALY_DETECTION_ASSETS_PCT_AWS');
create or replace task TSK_RDI_AD_ASSETS
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_ASSETS AS
        SELECT
            date_trunc('day', current_date) as date,
            'VW_ASSETDETAIL_ROLLING60DAYS' as target,
            COUNT(DISTINCT(ASSET_ID_TATTOO)) as ASSETS
        FROM 
            RPT.VW_ASSETDETAIL_ROLLING60DAYS;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_ASSETS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_ASSETS;

        -- This is the step that creates your predictions.
        CALL ad_rdi_assets!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_ASSETS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ASSETS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_ASSETS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_ASSETS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_ASSETS;
    END;
create or replace task TSK_RDI_AD_ASSETS_FISMA
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_ASSETS_FISMA AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_ASSETDETAIL_ROLLING60DAYS_FISMA_COUNTS' as target,
            COUNT(DISTINCT(FK_PRIMARY_FISMA_ID)) as distinct_fisma
        FROM 
            RPT.VW_VULN_ROLLING60DAYS;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_ASSETS_FISMA
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_ASSETS_FISMA;

        -- This is the step that creates your predictions.
        CALL ad_rdi_vulnerable_fisma!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_ASSETS_FISMA'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'DISTINCT_FISMA',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_VW_VULN_ROLLING60DAYS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_DASHBOARD_VW_VULN_ROLLING60DAYS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_ASSETS_FISMA;
    END;
create or replace task TSK_RDI_AD_ASSET_SOFTWARE
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_SWAM_ASSETS AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_ASSET_SOFTWARE' as target,
            COUNT(DISTINCT(DW_SWAM_ID)) as swam_id
        FROM 
            RPT.VW_ASSET_SOFTWARE
        UNION ALL
        
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_ASSET_SOFTWARE_DETAILS' as target,
            COUNT(DISTINCT(DW_SWAM_ID)) as swam_id
        FROM 
            RPT.VW_ASSET_SOFTWARE_DETAILS;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_ASSET_SOFTWARE
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_SWAM_ASSETS;

        -- This is the step that creates your predictions.
        CALL rdi_software_assets!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_SWAM_ASSETS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'SWAM_ID',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_SOFTWARE_ASSETS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_SOFTWARE_ASSETS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_SWAM_ASSETS;
    END;
create or replace task TSK_RDI_AD_BOD_FISMA
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_BOD_FISMA AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'V_BOD_SUMMARY_FISMA_COUNTS' as target,
            COUNT(DISTINCT(FISMA_ID)) as distinct_fisma
        FROM 
            RPT.V_BOD_SUMMARY;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_BOD_FISMA
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_BOD_FISMA;

        -- This is the step that creates your predictions.
        CALL ad_rdi_bod_fisma!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_BOD_FISMA'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'DISTINCT_FISMA',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_V_BOD_SUMMARY AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_V_BOD_SUMMARY SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_BOD_FISMA;
    END;
create or replace task TSK_RDI_AD_CFACTS_USERMAPPINGS
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_CFACTS_USERMAPPINGS AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'V_CFACTS_USERMAPPING' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_CFACTS_USERMAPPING;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_CFACTS_USERMAPPINGS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_CFACTS_USERMAPPINGS;

        -- This is the step that creates your predictions.
        CALL ad_rdi_bod_fisma!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_CFACTS_USERMAPPINGS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'TOTAL_MAPPINGS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_V_CFACTS_USERMAPPING AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_V_CFACTS_USERMAPPING SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_CFACTS_USERMAPPINGS;
    END;
create or replace task TSK_RDI_AD_DCRR_POAM_PHASE
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_POAM_TLC_PHASE AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_INITIATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_POAM 
        WHERE 
            TLC_PHASE = 'Initiate' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_DEVELOP' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_POAM 
        WHERE 
            TLC_PHASE = 'Develop' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_OPERATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_POAM 
        WHERE 
            TLC_PHASE = 'Operate' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_RETIRE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_POAM 
        WHERE 
            TLC_PHASE = 'Retire' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_POAM
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_POAM_TLC_PHASE;
        DROP TABLE IF EXISTS TEMP_RDI_POAM_TLC_PHASE;
    END;
create or replace task TSK_RDI_AD_DCRR_SYSTEM_PHASE
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_SYSTEM_PHASE AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_INITIATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_SYSTEMS 
        WHERE 
            TLC_PHASE = 'Initiate' 
            AND DATE_TRUNC('day', REPORT_DATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_DEVELOP' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_SYSTEMS 
        WHERE 
            TLC_PHASE = 'Develop' 
            AND DATE_TRUNC('day', REPORT_DATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_OPERATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_SYSTEMS 
        WHERE 
            TLC_PHASE = 'Operate' 
            AND DATE_TRUNC('day', REPORT_DATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_RETIRE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_SYSTEMS 
        WHERE 
            TLC_PHASE = 'Retire' 
            AND DATE_TRUNC('day', REPORT_DATE) = current_date;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_SYSTEMS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_SYSTEM_PHASE;
        DROP TABLE IF EXISTS TEMP_RDI_SYSTEM_PHASE;
    END;
create or replace task TSK_RDI_AD_DCRR_VULN_PHASE
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_VULN_PHASE AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_INITIATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_VULN 
        WHERE 
            TLC_PHASE = 'Initiate' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_DEVELOP' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_VULN 
        WHERE 
            TLC_PHASE = 'Develop' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_OPERATE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_VULN 
        WHERE 
            TLC_PHASE = 'Operate' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'TLC_PHASE_RETIRE' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_SYSTEMSUMMARY_DCRR_VULN 
        WHERE 
            TLC_PHASE = 'Retire' 
            AND DATE_TRUNC('day', REPORTDATE) = current_date;

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_V_SYSTEMSUMMARY_DCRR_VULN
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_VULN_PHASE;
        DROP TABLE IF EXISTS TEMP_RDI_VULN_PHASE;
    END;
create or replace task TSK_RDI_AD_OA_READY
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_OA_READY AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'OA_READY_STATUS_YES' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_CRMP_OATO_SYSTEMS 
        WHERE 
            "OA Ready" = 'Yes'
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'OA_READY_STATUS_NO' as target,
            COUNT(*) as total_mappings
        FROM 
            RPT.V_CRMP_OATO_SYSTEMS 
        WHERE 
            "OA Ready" = 'No';

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_V_CRMP_OATO_SYSTEMS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_OA_READY;

        -- This is the step that creates your predictions.
        CALL ad_rdi_oa_ready_status!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_OA_READY'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'STATUS_COUNT',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_V_CRMP_OATO_SYSTEMS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_V_CRMP_OATO_SYSTEMS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_OA_READY;
    END;
create or replace task TSK_RDI_AD_ROW_COUNTS
	schedule='USING CRON 0 9 * * * America/New_York'
	SUSPEND_TASK_AFTER_NUM_FAILURES=10
	as BEGIN
        CREATE OR REPLACE TEMPORARY TABLE TEMP_RDI_ROW_COUNTS AS
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_CDM_DASHBOARD' as target,
            COUNT(*) as row_counts
        FROM 
            RPT.VW_CDM_DASHBOARD
        WHERE 
            date_trunc('day', refresh_date) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_VULN_DASHBOARD_TRENDING' as target,
            COUNT(*) as row_counts
        FROM 
            RPT.VW_VULN_DASHBOARD_TRENDING
        WHERE 
            date_trunc('day', refresh_date) = current_date
        UNION ALL
        
        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_MARKETPLACE_OVERDUE_VRAD' as target,
            COUNT(*) as row_counts
        FROM 
            RPT.VW_MARKETPLACE_OVERDUE_VRAD
        WHERE 
            date_trunc('day', refresh_date) = current_date
        UNION ALL

        SELECT
            to_timestamp_ntz(date_trunc('day', current_date)) as date,
            'VW_TRAL_RISKSEVERITYLEVEL' as target,
            COUNT(*) as row_counts
        FROM 
            RPT.VW_TRAL_RISKSEVERITYLEVEL;
            

        -- Keeps training data up to date
        INSERT INTO AD_RDI_TRAINING_DATASET_ROW_COUNTS
        SELECT *, FALSE AS IS_ANOMALY FROM TEMP_RDI_ROW_COUNTS;

        -- This is the step that creates your predictions.
        CALL ad_rdi_dashboard_row_counts!DETECT_ANOMALIES(
            INPUT_DATA => SYSTEM$REFERENCE('TABLE', 'TEMP_RDI_ROW_COUNTS'),
            TIMESTAMP_COLNAME =>'DATE',
            SERIES_COLNAME => 'TARGET',
            TARGET_COLNAME => 'ROW_COUNTS',
            -- Here we set your prediction interval.
            CONFIG_OBJECT => {'prediction_interval': 0.97}
        );
        
        -- These steps store your predictions to a table.
        LET x := SQLID;
        CREATE TABLE IF NOT EXISTS RDI_ANOMALY_DETECTION_DASHBOARD_ROW_COUNTS AS SELECT * FROM TABLE(RESULT_SCAN(:x));
        INSERT INTO RDI_ANOMALY_DETECTION_DASHBOARD_ROW_COUNTS SELECT * FROM TABLE(RESULT_SCAN(:x));
        DROP TABLE IF EXISTS TEMP_RDI_ROW_COUNTS;
    END;
create or replace schema PUBLIC;

create or replace schema RPT COMMENT='Contains views/tables needed by Reporting Team/Tableau';

create or replace TABLE ASSETDETAIL (
	ACR_ALIAS VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTIDS VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	BODDUEDATE DATE,
	COMPONENT_ACRONYM VARCHAR(16777216) NOT NULL,
	COMPUTER_TYPE VARCHAR(16777216),
	CVE VARCHAR(16777216) NOT NULL,
	CVSS2BASESCORE VARCHAR(16777216),
	CVSS3BASESCORE VARCHAR(16777216),
	DATA_CENTER_NAME VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216) NOT NULL,
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	DW_VUL_ID NUMBER(38,0) NOT NULL,
	ENVIRONMENT VARCHAR(16777216),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FAMILYNAME VARCHAR(16777216),
	FILTER NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	ID NUMBER(38,0) NOT NULL,
	IPV4 VARCHAR(16777216),
	IPV6 VARCHAR(16777216),
	IS_BOD VARCHAR(16777216) NOT NULL,
	IS_MARKETPLACE BOOLEAN,
	LASTFOUND TIMESTAMP_LTZ(9),
	MAC VARCHAR(16777216),
	MEFSTATUS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	OS VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	PLUGINID VARCHAR(16777216),
	RANKK NUMBER(38,0) NOT NULL,
	REFRESH_DATE TIMESTAMP_LTZ(9) NOT NULL,
	SENSOR_FIRSTSEEN TIMESTAMP_LTZ(9),
	SENSOR_LASTFOUND TIMESTAMP_LTZ(9),
	SIGNATURE VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	SOLUTION VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	TENABLEUUID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	CLOUD_ACCOUNT_ID VARCHAR(16777216)
)COMMENT='Contains all the Vulnerabilities and asset data for latest snapshot (Fixed Vulns population imited to rolling 60 days)'
;
create or replace TABLE CFACTS_EXCLUSIVECLUB (
	USERNAME VARCHAR(16777216),
	MEMBER BOOLEAN
)COMMENT='Contains classification of EUA IDs who have access to Cyber Risk Report Management project in Tableau'
;
create or replace TABLE CRR_ACRONYM_PARAMS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	ACRONYM VARCHAR(16777216),
	REPORTNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='Not using in tableau'
;
create or replace TABLE CRR_COMPONENT_PARAMS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	COMPONENT VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	GROUPS VARCHAR(16777216),
	REPORTNAME VARCHAR(16777216),
	SYSTEMS VARCHAR(16777216),
	primary key (ID)
)COMMENT='Look up table to get report name based on acronym and component acronym for MCRR report'
;
create or replace TABLE CRR_GROUP_ALL_PARAMS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	GROUPS VARCHAR(16777216),
	REPORTNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='Not using in tableau'
;
create or replace TABLE CRR_GROUP_PARAMS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	GROUPS VARCHAR(16777216),
	REPORTNAME VARCHAR(16777216),
	primary key (ID)
)COMMENT='Not using in tableau'
;
create or replace TABLE TEMPTABLE_MCRR (
	REPORTNAME VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	REPORT_ID NUMBER(38,0),
	REPORT_DATE VARCHAR(16777216),
	ASSETS NUMBER(38,0),
	NEXT_REQUIRED_CP_TEST_DATE VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES VARCHAR(16777216),
	IS_OA_READY BOOLEAN,
	OA_STATUS VARCHAR(16777216),
	ASSETRISKTOLERANCE NUMBER(38,0),
	RESIDUALRISK NUMBER(38,0),
	RESILIENCYSCORE NUMBER(38,0),
	VULNRISKTOLERANCE NUMBER(38,2),
	TOT_CRIT_VULNS NUMBER(38,0),
	TOT_HIGH_VULNS NUMBER(38,0),
	TLC_PHASE VARCHAR(16777216),
	VULUNIQUECRITICAL_GT60DAYS NUMBER(38,0),
	VULCRITICAL_GT60DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT60DAYS NUMBER(38,0),
	VULHIGH_GT60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT15_LTE60DAYS NUMBER(38,0),
	VULUNIQUEHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULHIGH_GT30_LTE60DAYS NUMBER(38,0),
	VULUNIQUECRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULCRITICAL_GT30_LTE60DAYS NUMBER(38,0),
	VULMEDIUM NUMBER(38,0),
	VULLOW NUMBER(38,0),
	VULUNIQUEMEDIUM NUMBER(38,0),
	VULUNIQUELOW NUMBER(38,0),
	KEV_FIXED_MONTHTODATE NUMBER(38,0),
	KEV_OPEN NUMBER(38,0),
	KEV_REOPENED NUMBER(38,0),
	POAMCOUNT VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	OVERDUE_COUNT NUMBER(38,0),
	OVERDUE_FILTER VARCHAR(16777216),
	EPSS_COUNT NUMBER(38,0),
	EPSS_FILTER VARCHAR(16777216)
);
create or replace TABLE TEMP_DAILYDATACHECK (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	TABLENAME VARCHAR(16777216),
	DASHBOARD VARCHAR(16777216),
	DATA_SOURCETYPE VARCHAR(16777216),
	DATA_SOURCENAME VARCHAR(16777216),
	VIEW_NAME VARCHAR(16777216),
	DB_STRUCTURE_DESC VARCHAR(16777216),
	primary key (ID)
)COMMENT='Dashboard source mapping'
;
create or replace TABLE TEMP_VULN_FV_ROLLING60DAYS (
	V_ACR VARCHAR(16777216),
	V_COMP_ACR VARCHAR(16777216),
	V_TLC_PHASE VARCHAR(16777216),
	V_HVA_STAT VARCHAR(16777216),
	V_IS_MRKT_PLC BOOLEAN,
	V_MEF_STATUS VARCHAR(16777216),
	V_ACR_DISPLAY VARCHAR(16777216),
	FILTER VARCHAR(1),
	FK_PRIMARY_FISMA_ID VARCHAR(16777216),
	FK_DATACENTER_ID VARCHAR(16777216),
	ID NUMBER(38,0),
	FK_DW_VUL_NUMBER NUMBER(38,0),
	CVE VARCHAR(16777216),
	DAYSSINCEDISCOVERY NUMBER(9,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	FK_SNAPSHOTID NUMBER(38,0),
	ACRONYM VARCHAR(16777216),
	ACR_ALIAS VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	IS_DATACENTER BOOLEAN,
	IS_MARKETPLACE BOOLEAN,
	TLC_PHASE VARCHAR(16777216),
	IS_SCANNABLE BOOLEAN,
	BODDUEDATE TIMESTAMP_TZ(9),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	HVASTATUS VARCHAR(16777216),
	MEFSTATUS VARCHAR(16777216),
	DATA_CENTER_NAME VARCHAR(16777216),
	DELETIONREASON VARCHAR(16777216),
	FK_PLUGINID VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	FAMILYNAME VARCHAR(16777216),
	SIGNATURE VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	RANKK NUMBER(18,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	CURRENTMTDSTART DATE,
	PREVEOMSTART DATE,
	FK_ASSETID NUMBER(38,0),
	COMPUTER_TYPE VARCHAR(16777216),
	OS VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	CVSS2BASESCORE NUMBER(38,1),
	CVSS3BASESCORE NUMBER(38,1),
	VRT NUMBER(10,2),
	"POA&M ID" VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216)
)COMMENT='Contains all the Active Vulns as of today and fixed Vulns related data details for last 60 days'
;
create or replace TABLE TEMP_VULN_TRENDING (
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	"CVE Count" NUMBER(18,0),
	"Unique CVE Count" NUMBER(18,0),
	CURRENTMTDSTART VARCHAR(16777216),
	DATA_CENTER_NAME VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(21,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	IS_MARKETPLACE BOOLEAN,
	MEFSTATUS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	PREVEOMSTART VARCHAR(16777216),
	RANKK NUMBER(18,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	REPORT_DATE DATE,
	REPORT_ID NUMBER(38,0),
	TLC_PHASE VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2)
)COMMENT='Contains Vulnerabilities trending data for rolling 12 months'
;
create or replace TABLE VAT_SYSTEMUSERS (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	SYSTEM_ID VARCHAR(16777216) NOT NULL,
	USERID VARCHAR(16777216),
	primary key (ID)
)COMMENT='List of VAT provided Data Center users'
;
create or replace TABLE VULN_CRR_MONTHLY_LATEST (
	ID NUMBER(38,0) NOT NULL,
	ASSET_ID_TATTOO VARCHAR(16777216),
	BODDUEDATE DATE,
	COMPONENT_ACRONYM VARCHAR(16777216) NOT NULL,
	COMPONENT_NAME VARCHAR(16777216),
	CVE VARCHAR(16777216),
	CVSSV2BASE VARCHAR(16777216),
	CVSSV3BASE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216) NOT NULL,
	DATACENTERACRONYM VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	DESCRIPTION NUMBER(38,0),
	DNSNAME VARCHAR(16777216),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FAMILYNAME NUMBER(38,0),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMA_ID VARCHAR(16777216) NOT NULL,
	FISMASEVERITY VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IS_BOD VARCHAR(16777216) NOT NULL,
	LASTFOUND TIMESTAMP_LTZ(9),
	MACADDRESS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	OS VARCHAR(16777216),
	PLUGINID VARCHAR(16777216),
	SIGNATURE NUMBER(38,0),
	SNAPSHOTDATE TIMESTAMP_LTZ(9),
	SOLUTION NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216),
	SYSTEMACRONYM VARCHAR(16777216)
);
create or replace secure view SV_CORE_ASSETHIST(
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	ASSETHIST_ID,
	ASSET_DATECREATED,
	IPV4,
	IPV6,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	REPORT_DATE,
	REPORT_ID,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) COMMENT='asset history'
 as select * from BUS_CYBER_RISK_MANAGEMENT.CORE.VW_ASSETHIST;
create or replace view VW_ASSETDETAIL_ROLLING60DAYS(
	ACR,
	COM_ACR,
	ACR_ALIAS,
	ACRONYM,
	ASSET_ID_TATTOO,
	AWS_ACCOUNTIDS,
	BIOS_GUID,
	BODDUEDATE,
	CLOUD_ACCOUNT_ID,
	COMPONENT_ACRONYM,
	COMPUTER_TYPE,
	CVE,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	DATA_CENTER_NAME,
	DATACENTER_ID,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	OVERDUE_FILTER,
	DELETIONREASON,
	DEVICETYPE,
	DW_ASSET_ID,
	DW_VUL_ID,
	ENVIRONMENT,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FILTER,
	FIRSTSEEN,
	FISMASEVERITY,
	FQDN,
	HOSTNAME,
	HVASTATUS,
	ID,
	IPV4,
	IPV6,
	IS_BOD,
	IS_MARKETPLACE,
	LASTFOUND,
	MAC,
	MEFSTATUS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OATO_CATEGORY,
	OS,
	OS_VERSION,
	PLUGINID,
	RANKK,
	REFRESH_DATE,
	SENSOR_FIRSTSEEN,
	SENSOR_LASTFOUND,
	SIGNATURE,
	SNAPSHOT_ID,
	SOLUTION,
	SOURCE_TOOL,
	SYSTEM_ID,
	FISMA_ID,
	TENABLEUUID,
	TLC_PHASE,
	VULNRISKTOLERANCE,
	EPSS,
	EPSS_FILTER,
	PERCENTILE,
	FIPS_199_OVERALL_IMPACT_RATING,
	OPERATED_BY
) COMMENT='Contains all the Vulnerabilities and asset for latest snapshots with granular CVE IDs/Asset ID/Plug in ID/IPV4/EPSS etc for each system/data Center/component (Fixed Vulns population imited to rolling 60 days)'
 as
select 
    s.Acronym as ACR,
    s.Component_Acronym as COM_ACR,
	substring(s.Acronym,1,1) || '***' as ACR_ALIAS,
	s.ACRONYM,
	Asst.ASSET_ID_TATTOO,
	s.AWS_ACCOUNTIDS,
	Asst.BIOS_GUID,
	Asst.BODDUEDATE,
    Asst.CLOUD_ACCOUNT_ID, -- 241125 CR1038
	Asst.COMPONENT_ACRONYM,
	Asst.COMPUTER_TYPE,
	Asst.CVE,
	Asst.CVSS2BASESCORE,
	Asst.CVSS3BASESCORE,
    IFNULL(Asst.DATA_CENTER_NAME,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name, --Datacenter from assets or primary oploc CR #850.
    IFNULL(Asst.DATACENTER_ID,s.primary_operating_location_id) as DATACENTER_ID, --Datacenter id from assets or primary oploc CR #850.
	Asst.DATECREATED,
	Asst.DATEMITIGATED,
	Asst.DAYSSINCEDISCOVERY,
    case 
    when Asst.DAYSSINCEDISCOVERY <= 15 then '<= 15 days'
    when Asst.DAYSSINCEDISCOVERY > 15 and Asst.DAYSSINCEDISCOVERY <= 30 then '> 15 and <= 30 days'
    when Asst.DAYSSINCEDISCOVERY > 30 and Asst.DAYSSINCEDISCOVERY <= 45 then '> 30 and <= 45 days'
    when Asst.DAYSSINCEDISCOVERY > 45 and Asst.DAYSSINCEDISCOVERY <= 60 then '> 45 and <= 60 days'
    when Asst.DAYSSINCEDISCOVERY > 60 and Asst.DAYSSINCEDISCOVERY <= 90 then '> 60 and <= 90 days'
    when Asst.DAYSSINCEDISCOVERY > 90 then '> 90 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER,
    case 
    when Asst.FISMASEVERITY = 'Critical' and Asst.DAYSSINCEDISCOVERY > 15 then 'OVERDUE CRITICAL'
    when Asst.FISMASEVERITY = 'High' and Asst.DAYSSINCEDISCOVERY > 30 then 'OVERDUE HIGH'
    when Asst.FISMASEVERITY = 'Medium' and Asst.DAYSSINCEDISCOVERY > 90 then 'OVERDUE MODERATE'
    when Asst.FISMASEVERITY = 'Low' and Asst.DAYSSINCEDISCOVERY > 365 then 'OVERDUE LOW'
    ELSE 'NOT OVERDUE'
    end as OVERDUE_FILTER, 
	Asst.DELETIONREASON,
	Asst.DEVICETYPE,
	Asst.DW_ASSET_ID,
	Asst.DW_VUL_ID,
    --Asst.DW_ASSET_ID as "FK_AssetID",
    --Asst.DW_VUL_ID as "FK_dw_vul_number",
	Asst.ENVIRONMENT,
	Asst.EXPLOITAVAILABLE,
	Asst.FAMILYNAME,
	Asst.FILTER,
	Asst.FIRSTSEEN,
	Asst.FISMASEVERITY,
	Asst.FQDN,
	Asst.HOSTNAME,
	s.HVASTATUS,
	Asst.ID,
	Asst.IPV4,
	Asst.IPV6,
	Asst.IS_BOD,
	s.IS_MARKETPLACE,
	Asst.LASTFOUND,
	Asst.MAC,
	s.MEFSTATUS,
	Asst.MITIGATIONSTATUS,
	Asst.NETBIOSNAME,
	Asst.OATO_CATEGORY,
	Asst.OS,
	Asst.OS_VERSION,
	Asst.PLUGINID,
	Asst.RANKK,
	Asst.REFRESH_DATE,
	Asst.SENSOR_FIRSTSEEN,
	Asst.SENSOR_LASTFOUND,
	Asst.SIGNATURE,
	Asst.SNAPSHOT_ID,
	Asst.SOLUTION,
	Asst.SOURCE_TOOL,
	Asst.SYSTEM_ID,
    Asst.SYSTEM_ID FISMA_ID,
	Asst.TENABLEUUID,
	s.TLC_PHASE,
	Asst.VULNRISKTOLERANCE
    ,epss.epss
    ,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    end as epss_FILTER
    ,epss.percentile
    ,s.FIPS_199_OVERALL_IMPACT_RATING -- 250103 CR1059
    ,s.OPERATED_BY, -- 250103 CR1059
 from (select * from RPT.AssetDetail where lower(MitigationStatus) in ('open', 'reopened') or (lower(MitigationStatus) = 'fixed' and datemitigated > (current_date() - 60)))asst
 right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_MarketPlace,HVAStatus,MEFStatus,TLC_Phase,aws_accountids, PRIMARY_OPERATING_LOCATION_ACRONYM, primary_operating_location_id
 ,OPERATED_BY,FIPS_199_OVERALL_IMPACT_RATING -- 250103 CR1059
 from CORE.vw_Systems) s ON s.SYSTEM_ID = asst.SYSTEM_ID 
 LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = Asst.cve
;
create or replace view VW_ASSET_SOFTWARE(
	ASSET_ID_TATTOO,
	DW_SWAM_ID,
	COMPONENT_ACRONYM,
	DATACENTER_ID,
	DATEINSTALLED,
	DEVICETYPE,
	DW_ASSET_ID,
	FIRSTSEEN,
	IS_FROM_AWS_FEED,
	IS_FORESCOUT_MANAGED,
	IS_SCANNABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SWAM_SUBCATEGORY,
	ACRONYM,
	GROUP_ACRONYM,
	MEFSTATUS,
	TLC_PHASE,
	IS_MARKETPLACE,
	HVASTATUS,
	OATO_CATEGORY,
	SYSTEM_ID,
	VENDOR,
	VERSION,
	DATACENTER_ACRONYM
) COMMENT='View reports software related to assets and dimentional values for dashboard\t'
 as
SELECT 
sw.ASSET_ID_TATTOO
,sw.DW_SWAM_ID
,dlookup.COMPONENT_ACRONYM
,sw.DATACENTER_ID
,sw.DATEINSTALLED
,sw.DEVICETYPE
,sw.DW_ASSET_ID
,sw.FIRSTSEEN
,sw.IS_FROM_AWS_FEED -- 240709 CR931
,sw.IS_FORESCOUT_MANAGED -- 240709 CR931
,sw.IS_SCANNABLE -- 240709 CR931
,sw.IS_TENABLE_CREDENTIALED_SCAN -- 240709 CR931
,sw.LASTSEEN
,sw.MAJOR
,sw.MINOR
,sw.SOFTWARENAME
,sw.SOURCE_TOOL
,sw.SWAM_CATEGORY
,sw.SWAM_SUBCATEGORY -- 240709 CR931
,dlookup.ACRONYM
,dlookup.GROUP_ACRONYM
,dlookup.mefstatus
,dlookup.tlc_phase
,dlookup.is_marketplace
,dlookup.hvastatus
,dlookup.oato_category
,dlookup.ID SYSTEM_ID
,sw.VENDOR
,sw.VERSION
,IFNULL(sw.datacenter_acronym, s.primary_operating_location_acronym) as datacenter_acronym
from RPT.V_DIMENSIONAL_LOOKUP dlookup
join CORE.VW_SYSTEMS s on dlookup.ID = s.system_id
left outer join CORE.VW_ASSET_SOFTWARE sw on dlookup.id = sw.system_id
;
create or replace view VW_ASSET_SOFTWARE_DETAILS(
	ACRONYM,
	DATACENTERACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	TLC_PHASE,
	SOURCE_TOOL_LASTSEEN,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	INSERT_DATE,
	LASTSEEN_HWAM,
	IS_APPLICABLE,
	DEVICEROLE,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	AWS_INSTANCESTATUS,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN,
	FIRSTSEEN,
	DATEINSTALLED,
	DW_SWAM_ID,
	SOFTWARENAME
) COMMENT='This view contains Master Device records data along with Sofware name for SWAM details'
 as
select
sys.Acronym
,dc.Acronym as DatacenterAcronym
,substring(sys.Acronym,1,1) || '***' as Acr_Alias
,sys.Component_Acronym
,sys.Group_Acronym
,sys.Is_DataCenter
,sys.Is_MarketPlace
,sys.HVAStatus
,sys.MEFStatus
,sys.TLC_Phase
,a.SOURCE_TOOL_LASTSEEN
,upper(a.environment) as environment
,a.asset_id_tattoo
,a.os_version
,a.TenableUUID
,a.DeviceType
,a.INSERT_DATE
,a.LastSeen_HWAM
,a.IS_APPLICABLE
,a.DeviceRole
,a.fqdn
,a.hostname
,a.IPv4
,a.IPv6
,a.Macaddress
,a.netbiosname 
,a.AWS_INSTANCESTATUS
,asw.is_tenable_credentialed_scan
,asw.LASTSEEN
,asw.FIRSTSEEN
,ASW.DATEINSTALLED
,asw.DW_SWAM_ID
,asw.SOFTWARENAME
from CORE.VW_ASSETS a
JOIN CORE.VW_ASSET_SOFTWARE asw on a.dw_asset_id = asw.dw_asset_id
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,Group_Acronym,TLC_Phase,aws_accountids,IS_EXCLUDEFROMREPORTING from CORE.vw_Systems) sys ON sys.SYSTEM_ID = a.SYSTEM_ID 
left join (select SYSTEM_ID,acronym from CORE.vw_Systems) dc ON dc.SYSTEM_ID = a.DATACENTER_ID
;
create or replace view VW_CDM_DASHBOARD(
	SYSTEM_ID,
	DATACENTER_ID,
	ASSETHIST_ID,
	DW_ASSET_ID,
	REPORT_ID,
	IS_SCANNABLE,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	TLC_PHASE,
	IS_EXCLUDEFROMREPORTING,
	RANKK,
	REFRESH_DATE,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL_LASTSEEN,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	INSERT_DATE,
	DATEDELETED,
	IS_APPLICABLE,
	DEVICEROLE,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	AWS_INSTANCESTATUS,
	NETBIOS_HN,
	DATACENTER,
	VRT,
	SNAPSHOTS,
	ENDOFMONTH,
	REPORT_DATE,
	STARTOFMONTH,
	LASTSEEN_HWAM,
	REFRESHDATE,
	TENANT_ID,
	IS_TENABLE_CREDENTIALED_SCAN,
	IS_FORESCOUT_MANAGED,
	CLOUD_ACCOUNT_ID,
	IS_ENDPOINT
) COMMENT='This view contains Master Device records data along with Vuln risk tolerance calculated at each asset level'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union --CR#822 changed Union All to Union to avoid duplicate records on monthend snapshot date
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=3)),
    
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) = 1 then 'Current' when dense_rank()over(order by Report_ID desc) ='2' then 'LastMonth' when  dense_rank()over(order by Report_ID desc) ='3' then 'PrevMonth' when  dense_rank()over(order by Report_ID desc) ='4' then  'PrevPrevMonth' end as SnapshotsRank,
	case when dense_rank()over(order by Report_ID desc) =1 then LAST_DAY(current_date()) else LAST_DAY(ADD_MONTHS(Report_Date,-1)) end as EndofMonth,
	r.Report_Date,
	case when dense_rank()over(order by Report_ID desc) =1 then DATE_TRUNC('MONTH',current_date()) else (DATE_TRUNC('MONTH',ADD_MONTHS(Report_Date,-1))) End as StartOfMonth
	from ReportIDs r)
    
select
ah.SYSTEM_ID 
,ah.DATACENTER_ID 
,ah.ASSETHIST_ID 
,ah.dw_Asset_ID 
,ah.Report_ID
,a.Is_Scannable 
,sys.Acronym 
,substring(sys.Acronym,1,1) || '***' as Acr_Alias
,sys.Component_Acronym 
,sys.Group_Acronym 
,sys.Is_DataCenter 
,sys.Is_MarketPlace 
,sys.HVAStatus 
,sys.MEFStatus 
,sys.TLC_Phase 
,sys.IS_EXCLUDEFROMREPORTING 
,dense_rank()over(order by ah.REPORT_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,a.computer_type 
,a.os 
,a.bios_guid 
,a.SOURCE_TOOL_LASTSEEN 
,upper(a.environment) as environment
,a.asset_id_tattoo 
,a.os_version 
,a.TenableUUID 
,a.DeviceType 
,a.INSERT_DATE 
,NULL as dateDeleted
,a.IS_APPLICABLE 
,a.DeviceRole 
,a.fqdn 
,a.hostname 
,a.IPv4
,a.IPv6 
,a.Macaddress 
,a.netbiosname 
,upper(ah.AWS_INSTANCESTATUS) AWS_INSTANCESTATUS 
,ah.BIOS_GUID as netbios_hn
,dc.Acronym as Datacenter
,ah.VulnRiskTolerance as VRT
,snap.SnapshotsRank as Snapshots
,snap.EndofMonth 
,snap.Report_Date 
,snap.StartOfMonth 
,a.LastSeen_HWAM 
,current_date() as RefreshDate
,a.tenant_id 
,ah.is_tenable_credentialed_scan --cr#968
,ah.is_forescout_managed --cr#968
,a.CLOUD_ACCOUNT_ID -- 241125 CR1038
,ah.IS_ENDPOINT --241219 CR968
from CORE.VW_Assets a
RIGHT JOIN CORE.VW_ASSETHIST ah on ah.DW_ASSET_ID = a.DW_ASSET_ID 
--join CORE.reportsnapshots RC on ah.report_id = RC.REPORT_ID
JOIN Snapshots snap on snap.REPORT_ID = ah.REPORT_ID
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,Group_Acronym,TLC_Phase,aws_accountids,IS_EXCLUDEFROMREPORTING from CORE.vw_Systems) sys ON sys.SYSTEM_ID = ah.SYSTEM_ID 
left join (select SYSTEM_ID,acronym from CORE.vw_Systems) dc ON dc.SYSTEM_ID = ah.DATACENTER_ID
--left join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID;
;
create or replace view VW_CONFIGURATION_COMPLIANCE(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	DAYSSINCEDISCOVERY,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FIRST_SEEN,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SEVERITY_NAME,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.COMPONENT_ACRONYM
,a.DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.DAYSSINCEDISCOVERY
,comp.Finding_Description
,comp.Finding_ID
,comp.FIRST_SEEN
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.IS_TENABLE_CREDENTIALED_SCAN
,comp.LAST_SEEN as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity

,case coalesce(upper(comp.Severity),'ITSNULL')
    when 'I' then 'High'
    when 'II' then 'Medium'
    when 'III' then 'Low'
    Else 'Unknown'
End as Severity_Name

,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 20),(CompInfoEnd - CompInfoStart - 20)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,DATEDIFF(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.FIRST_SEEN
,r.LAST_SEEN

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
left outer join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CRM_PORTAL(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	ACRONYM,
	NEXT_REQUIRED_CP_TEST_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	TLC_PHASE,
	ASSETS,
	VUL_OPEN,
	VUL_REOPENED,
	RESILIENCYSCORE,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_MONTHTODATE,
	VULNRISKTOLERANCE,
	POAM_COUNT,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TOTAL_ASSET,
	TIMELINESS_PCT,
	COUNT_SOFTWAREINSTALLED,
	VULN_OVERDUE,
	COUNT_FINDINGS,
	COUNT_PHISHING_RES_LOGIN,
	COUNT_TOTALLOGIN
) COMMENT='View reports hwam, vuln and software data for dashboard\t'
 as
select 
    rids.report_id,
    rids.report_date,
    sys.system_id,
    sys.acronym,
    sys.next_required_cp_test_date,
    sys.DATE_AUTH_MEMO_EXPIRES,
    sys.is_oa_ready,
    sys.oa_status,
    Sys.tlc_phase,
    ss.assets, 
    vulopen.vul_open, 
    vulopen.vul_reopened,
    ss.resiliencyscore,
    ss.KEV_OPEN,
    ss.KEV_REOPENED,
    ss.KEV_FIXED_MONTHTODATE,
    ss.vulnrisktolerance,
    p.POAM_COUNT,
    Count_less72Hrs,
    Count_greater72Hrs,
    total_asset,
    case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
    end as Timeliness_PCT,
    Count_SoftwareInstalled,
    CRITICALGT15+HIGHGT30+MODERATEGT90+LOWGT365 as VULN_OVERDUE,
    COUNT_FINDINGS,
    (select sum(piv+fido2+zscaler) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS 
where date(authndate) >= dateadd('month', -1, date_trunc('month', current_date)) and date(authndate) < date_trunc('month', current_date)) as COUNT_PHISHING_RES_LOGIN, --CR#1054
    (select sum(EMAIL+FIDO2+OKTAOTP+OKTAPUSH+OTP+PHONE+PIV+SMS+ZSCALER) from BUS_ZEROTRUST.PUBLIC.AUTHNCOUNTS 
where date(authndate) >= dateadd('month', -1, date_trunc('month', current_date)) and date(authndate) < date_trunc('month', current_date)) as COUNT_TOTALLOGIN --CR#1054
from (select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 0 UNION select max(report_id) report_id, max(report_date) report_date from core.report_ids where is_endofmonth = 1) rids
JOIN (select report_id, system_id, sum(vul_high_open +vul_critical_open+vul_medium_open+vul_low_open) vul_open, sum(vul_high_reopened + vul_critical_reopened + vul_medium_reopened + vul_low_reopened) vul_reopened from core.vw_systemsummary group by all) vulopen on vulopen.report_id = rids.report_id
left outer join (select report_id, system_id, acronym, assets, resiliencyscore, kev_open KEV_OPEN, kev_reopened kev_reopened, kev_fixed_monthtodate kev_fixed_monthtodate, vulnrisktolerance vulnrisktolerance from core.vw_systemsummary where assets <> 0) ss on vulopen.system_id = ss.system_id and ss.report_id = rids.report_id
left outer join (select report_id, system_id, count(poam_id) POAM_COUNT from core.vw_poamhist where overall_status not in ('Completed', 'Pending Verification') 
group by all) p on vulopen.system_id = p.system_id and p.report_id = rids.report_id
left outer JOIN (select distinct
report_id, system_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah 
group by all) tl on vulopen.system_id = tl.system_id and tl.report_id = rids.report_id
join core.vw_systems sys on sys.system_id = vulopen.system_id
left outer join (SELECT system_id, count(distinct sw.DW_ASSET_ID) Count_SoftwareInstalled from CORE.VW_ASSET_SOFTWARE sw where date(sw.dateinstalled) >= (select max(date(report_date)) from core.report_ids where is_endofmonth = 1) and date(sw.dateinstalled) <= current_date group by all) sw on sw.system_id = sys.system_id
left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by ALL)vulDays on ss.system_id = vulDays.system_id
 left join (select system_acronym, count(ID) COUNT_FINDINGS from APP_AWS_SECURITY_HUB.PUBLIC.SEC_VW_AWS_SECURITYHUB_ALL where PRODUCTNAME in ('config','Security Hub') and WORKFLOW_STATUS = 'NEW' group by all) sh on sh.system_acronym = ss.ACRONYM --CR#1054
;
create or replace view VW_DAILYDATACHECK(
	TABLENAME,
	REPORT_ID,
	REFRESH_DATE
) COMMENT='This view used to check the accuracy on populating data in core tables used for tableau dashboards'
 as
select 'RPT.ASSETDETAIL' as TableName, max(r.report_id) report_id, max(refresh_date) as Refresh_date from RPT.ASSETDETAIL ad
join core.report_ids r on date(r.report_date) = date(ad.refresh_date)
UNION
select 'RPT.TEMP_VULN_TRENDING' as TableName, max(report_id) report_id, max(refresh_date) as Refresh_date from rpt.TEMP_VULN_TRENDING
UNION
select 'RPT.TEMP_VULN_FV_ROLLING60DAYS' as TableName, max(r.report_id) report_id, max(refresh_date) as Refresh_date from rpt.TEMP_VULN_FV_ROLLING60DAYS vr
join core.report_ids r on date(r.report_date) = date(vr.refresh_date)
UNION
select 'CORE.SYSTEMSUMMARY' as TableName, max(ss.report_id) report_id, max(report_date) as Refresh_date from core.systemsummary ss
join core.report_ids r on r.report_id = ss.report_id
UNION
select 'CORE.VULHIST' as TableName, max(vh.report_id) report_id, max(report_date) as Refresh_date from core.vulhist vh
join core.report_ids r on r.report_id = vh.report_id
UNION
select 'CORE.ASSETHIST' as TableName, max(ah.report_id) report_id, max(report_date) as Refresh_date from core.assethist ah
join core.report_ids r on r.report_id = ah.report_id
UNION
select 'CORE.POAMHIST' as TableName, max(ph.report_id) report_id, max(report_date) as Refresh_date from core.poamhist ph
join core.report_ids r on r.report_id = ph.report_id
UNION
select 'CORE.ALLOCATEDCONTROL' as TableName, max(AC.report_id) report_id, max(report_date) as Refresh_date from core.allocatedcontrol AC
join core.report_ids r on r.report_id = AC.report_id
;
create or replace view VW_DAILYDATACHECK_DB(
	TABLENAME,
	DASHBOARD,
	DATA_SOURCENAME,
	VIEW_NAME,
	REPORT_ID,
	REFRESH_DATE
) COMMENT='This view used to check the accuracy on populating data in core tables used for tableau dashboards'
 as
select tdaily.TABLENAME, DASHBOARD, DATA_SOURCENAME, VIEW_NAME, report_id, refresh_date from BUS_CYBER_RISK_MANAGEMENT.RPT.TEMP_DAILYDATACHECK tdaily
join BUS_CYBER_RISK_MANAGEMENT.RPT.VW_DAILYDATACHECK vdaily on vdaily.tablename = tdaily.tablename
;
create or replace view VW_DATAQUALITY_6M(
	DATACENTER_ID,
	SYSTEM_ID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	ACRONYM,
	ACR_ALIAS,
	DATACENTER,
	DCACR_ALIAS,
	TATOO_COUNT,
	TOTAL_ASSET,
	ASSET_ID_TATTOO_PCT,
	DC_ID_DERIVED_COUNT,
	DATACENTER_ID_DERIVED_PCT,
	P_FISMA_ID_TATTOO_COUNT,
	PRIMARY_FISMA_ID_TATTOO_PCT,
	P_FISMA_ID_DERIVED_COUNT,
	PRIMARY_FISMA_ID_DERIVED_PCT,
	FQDN_COUNT,
	FQDN_PCT,
	HOSTNAME_COUNT,
	HOSTNAME_PCT,
	MAC_COUNT,
	MAC_PCT,
	MOTHERBOARD_SN_COUNT,
	MOTHERBOARD_SN_PCT,
	NETBIOS_HN_COUNT,
	NETBIOS_HN_PCT,
	OS_COUNT,
	TOTAL_OS,
	OS_PCT,
	TLC_PHASE,
	IS_MARKETPLACE,
	MEFSTATUS,
	HVASTATUS,
	COUNT_LESS72HRS,
	COUNT_GREATER72HRS,
	TIMELINESS_PCT,
	BIGFIX_ASSET_ID_COUNT,
	BIGFIX_ASSET_ID_PCT,
	OS_CPE_COUNT,
	OS_CPE_PCT,
	BIOS_GUID_COUNT,
	BIOS_GUID_PCT,
	INSTANCESTATUS_COUNT,
	INSTANCESTATUS_PCT,
	IPV4_COUNT,
	IPV4_PCT,
	IPV6_COUNT,
	IPV6_PCT,
	REPORT_ID,
	REPORT_DATE
) COMMENT='Used for Tableau in Data Quality Dashboard:  Showing HWAM data based on completeness and Timeliness'
 as
with
ReportIDs as ((select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union
	select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap<=6)),
    
Snapshots as (select Report_ID,
	r.Report_Date
	from ReportIDs r) 
 --  select * from  Snapshots
    
select distinct
ah.datacenter_id,
ah.System_Id,
S.Component_Acronym as Component_Acronym
,S.Group_Acronym as Group_Acronym
,S.Acronym as Acronym
,CONCAT(SUBSTR(S.Acronym, 1, 1), '***') as Acr_Alias
,data_center.Acronym DataCenter
,CONCAT(SUBSTR(data_center.Acronym, 1, 1), '***') as DCAcr_Alias
--,dense_rank()over(order by report_id desc) as rankk,
,tatoo.tatoo_count
,tl.total_asset total_asset
,asset_id_tattoo_PCT
,dc_id_derived_count
,datacenter_id_derived_PCT
,p_fisma_id_tattoo_count
,primary_fisma_id_tattoo_PCT
,p_fisma_id_derived_count
,primary_fisma_id_derived_PCT
,fqdn_count
,fqdn_PCT
,hostname_count
,hostname_PCT
,Mac_count
,Mac_PCT
,motherboard_sn_count
,motherboard_sn_PCT
,netbios_hn_count
,netbios_hn_PCT
,os.os_count
,os.total_os
,os.os_PCT
--,s.AWS_accountIds CR #1044 241209
,s.TLC_Phase
,s.Is_MarketPlace
,s.MEFStatus
,s.HVAStatus
,tl.Count_less72Hrs
,tl.Count_greater72Hrs
,case when tl.Count_less72Hrs is not null then ROUND(Count_less72Hrs*100.0/tl.total_asset,1) 
end as Timeliness_PCT
,bigfix_asset_id_count
,bigfix_asset_id_PCT
,os_cpe_count
,os_cpe_PCT
,bios_guid_count
,bios_guid_PCT
,InstanceStatus_count
,InstanceStatus_PCT
,ipv4_count
,ipv4_PCT
,ipv6_count
,ipv6_PCT
,snap.report_id
,snap.report_date
--,coalesce(ah.AWS_ACCOUNTID,ah.AZURE_SUBSCRIPTION_ID) as CLOUD_ACCOUNT_ID -- 241125 CR1038 CR#1044 241209
--,getdate() as RefreshDate
from core.Asset a
JOIN core.ASSETHIST ah on ah.dw_asset_id = a.dw_asset_id --and a.Is_Applicable = 1 and ah.Is_Applicable = 1
join Snapshots snap on snap.report_id = ah.report_id
left join (select System_Id, datacenter_id, report_id, sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id) total_asset, count(asset_id_tattoo) tatoo_count 
,case when count(a.dw_asset_id) != 0 then
ROUND(count(asset_id_tattoo)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as asset_id_tattoo_PCT
,count(datacenter_id) dc_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(datacenter_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  datacenter_id_derived_PCT
,count(system_id) p_fisma_id_tattoo_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  primary_fisma_id_tattoo_PCT
,count(system_id) p_fisma_id_derived_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(system_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  primary_fisma_id_derived_PCT
,count(motherboard) motherboard_sn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(motherboard)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  motherboard_sn_PCT
,count(bigfix_asset_id) bigfix_asset_id_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bigfix_asset_id)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  bigfix_asset_id_PCT
,count(bios_guid) bios_guid_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(bios_guid)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  bios_guid_PCT
,count(os_cpe) os_cpe_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(os_cpe)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  os_cpe_PCT
from core.VW_ASSETHIST a
where a.devicetype in (select devicetype from core.DEVICETYPES dv where dv.devicetype in ('Server', 'Workstation', 'Computer','Laptop'))
Group by System_Id, datacenter_id, a.report_id) tatoo on tatoo.System_Id = ah.System_Id
and tatoo.datacenter_id = ah.datacenter_id and tatoo.report_id = snap.report_id
left join (select a.System_Id, a.datacenter_id, ac.report_id
,count(fqdn) fqdn_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(fqdn)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  fqdn_PCT
,count(hostname) hostname_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(hostname)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  hostname_PCT
,count(MACADDRESS) Mac_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(MACADDRESS)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  Mac_PCT
,count(ipv4) ipv4_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv4)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  ipv4_PCT
,count(ipv6) ipv6_count
,case when count(a.dw_asset_id) != 0 then
ROUND(count(ipv6)*100.0/sum(count(a.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  ipv6_PCT
from core.AssetInterfaceCoalescedHist ac
join core.Asset a on a.dw_asset_id = ac.dw_asset_id group by a.System_Id, datacenter_id, ac.report_id
) aic on aic.System_Id = ah.System_Id and aic.datacenter_id = ah.datacenter_id
and aic.report_id = snap.report_id

--added to limit the count to Windows OS 1/13/2024
left join (select aah.System_Id, aah.datacenter_id, aah.report_id,count(NETBIOSNAME) netbios_hn_count
,case when count(aah.dw_asset_id) != 0 then
ROUND(count(NETBIOSNAME)*100.0/sum(count(aah.dw_asset_id)) OVER(PARTITION BY datacenter_id,System_Id, report_id),1) 
else null end as  netbios_hn_PCT
from core.VW_ASSETHIST aah
where aah.os is not null and aah.os like '%Windows%'
group by System_Id, datacenter_id, aah.report_id
) netbios on netbios.System_Id = ah.System_Id
and netbios.datacenter_id  = ah.datacenter_id and netbios.report_id = snap.report_id
/***********************/

left join (select aah.System_Id, aah.datacenter_id, aah.report_id, count(os) os_count, sum(count(os)) over(PARTITION BY aah.datacenter_id,aah.System_Id, aah.report_id) total_os
,ROUND(count(os)*100.0/sum(count(dw_asset_id)) over(PARTITION BY aah.datacenter_id,aah.System_Id, aah.report_id),1) as  os_PCT
from core.VW_ASSETHIST aah
where aah.os is not null
group by System_Id, datacenter_id, aah.report_id
) os on os.System_Id = ah.System_Id
and os.datacenter_id  = ah.datacenter_id and os.report_id = snap.report_id
left join (select ah.System_Id, ah.datacenter_id, report_id,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) < 3 then 1 end)
else null
end as Count_less72Hrs,
CASE when count(ah.dw_asset_id) > 1 then
count(case when DATEDIFF(day, ah.last_confirmed_time, current_date()) > 3 then 1 end) 
else null end as Count_greater72Hrs,
sum(count(ah.dw_asset_id)) over(PARTITION BY ah.datacenter_id,ah.System_Id, report_id) total_asset
from core.VW_ASSETHIST ah
group by System_Id, datacenter_id, ah.report_id
) tl on tl.System_Id = ah.System_Id
and tl.datacenter_id  = ah.datacenter_id and tl.report_id = snap.report_id
left join (
select 
System_Id, datacenter_id, ah.report_id, count(aws_instancestatus) InstanceStatus_count 
,case when count(aws_instancestatus) != 0 then
ROUND(count(aws_instancestatus)*100.0/sum(count(aws_instancestatus)) over(PARTITION BY datacenter_id, System_Id, ah.report_id),1) 
else null end as InstanceStatus_PCT
from core.VW_ASSETHIST ah
--join Snapshots snap on snap.report_id = ah.report_id
where source_tool_hwam = 'AWS HWAM'
group by System_Id, datacenter_id, ah.report_id
)IStat on IStat.System_Id = ah.System_Id and IStat.datacenter_id  = ah.datacenter_id and IStat.report_id = snap.report_id
right outer join (select System_Id, Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,
	Group_Acronym,TLC_Phase, Is_ExcludeFromReporting,
	--cast(substring(AWS_accountIds,1,2000) as varchar(2000)) as AWS_accountIds CR #1044
    from CORE.VW_SYSTEMS 
	where Is_PhantomSystem=0 and Is_ExcludeFromReporting =0) S ON S.System_Id = ah.System_Id --and Is_ExcludeFromReporting = 0
left join (select System_Id, Acronym, AWS_accountIds from CORE.VW_SYSTEMS) data_center ON data_center.System_Id = ah.datacenter_id
where ah.System_Id is not null;
create or replace view VW_HRS_COMPLIANCE(
	ACRONYM,
	COMPONENT_ACRONYM,
	FIPS_199_OVERALL_IMPACT_RATING,
	AUTH_DECISION,
	HVASTATUS,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	OA_STATUS,
	OATO_CATEGORY,
	OATO_CATEGORY_DESC,
	TLC_PHASE,
	TOTALASSETS,
	REPORT_DATE,
	DATE_AUTH_MEMO_EXPIRES,
	RANKK
) COMMENT='System and Ongoing Auth details at Component level'
 as
SELECT 
s.Acronym
,s.COMPONENT_ACRONYM
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.AUTH_DECISION
,s.HVASTATUS
,IFF(s.IS_OA_READY=1,'Yes','No') Is_OA_Ready
,s.IS_OPERATIONALSYSTEM
,s.OA_STATUS
,s.OATO_CATEGORY
,src.DESCRIPTION OATO_Category_desc
,s.TLC_PHASE
,ss.Assets as TotalAssets
,vsnap.Report_Date Report_Date
,s.DATE_AUTH_MEMO_EXPIRES
,dense_rank()over(order by ss.report_id desc) as rankk
FROM CORE.VW_SYSTEMS s
JOIN (select report_id, system_id, assets  from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join (select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap on vsnap.Report_ID = ss.report_id
JOIN CORE.SystemRiskCategory src on s.oato_category = src.systemriskcategory_id;
create or replace view VW_HRS_HWAMCOUNT(
	COMPONENTACRONYM,
	HWAM_PCT
) COMMENT='Contains summarized Asset details at component level'
 as
select ComponentAcronym,
cast ( Y / (Y + N ) as DECIMAL(18, 4))*100   hwam_pct
from
(
select "Component_Acronym" ComponentAcronym, cast(sum(case when (HWAM_CNT)<>0 then 1 else 0 end)as DECIMAL(18, 4)) as Y,
cast(sum(case when (HWAM_CNT)=0 then 1 else 0 end)as DECIMAL(18, 4))  as N
 from(
select  "Component_Acronym","System", sum("Total Assets") HWAM_CNT
from  rpt.V_CyberRisk_System_Summary
group by "Component_Acronym","System" ) A
group by "Component_Acronym"
)B;
create or replace view VW_HRS_POAM(
	COMPONENT_ACRONYM,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_DECISION,
	AVG_DAYS_OPEN,
	WEAKNESS_RISK_LEVEL
) COMMENT='Contains summarized POAM related metrics data'
 as
SELECT  Component_Acronym ,Acronym,syst.Archer_Tracking_ID,Auth_Decision,(cast(days_open as numeric)) as avg_days_open,weakness_risk_level
FROM	CORE.VW_SYSTEMS syst
		left outer join CORE.VW_POAMS poam 
		on (syst.Archer_Tracking_ID =poam.archer_tracking_id 
		and Poam.overall_status in ('Delayed','Ongoing','Draft')
		and  weakness_risk_level in ('Critical','High','Low','Moderate'))
where	Component_Acronym IS NOT NULL
		and syst.TLC_Phase = 'Operate';
create or replace view VW_HRS_VULNDATA(
	SYSTEM_ID,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_PACKAGE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	COUNT,
	ISSO,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SCA,
	SCA_DATE,
	SDM,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD,
	NEXT_REQUIRED_CP_TEST_DATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	AWS_ACCOUNTIDS,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	CISO_REVIEW_DATE,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	CRA_REVIEW_DATE,
	DIVISION_DESCRIPTION,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	FIRST_PUBLISHED_DATE,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	PIA_014,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SOP_REVIEW_DATE,
	REMEDIATED_VULN,
	DELAYED_VUL,
	FISMASEVERITY,
	CNT
) COMMENT='Contains Summarized Vulnerability data at Component level'
 as
select 
	main.SYSTEM_ID,
	main.Acronym,
	main.Archer_Tracking_ID,
	main.Auth_Comments,
	main.Auth_Decision,
	main.Authorization_Package,
	main.Business_Owner,
	main.CIO,
	main.CISO,
	main.Cloud_Service_Provider,
	main.CommonName,
	main.Component_Acronym,
	main.Component_Risk_Reports_Oversight,
	main.ContingencyExpirationDate,
	main.CP_Test_Date,
	main.CP_Test_Results,
	main.CRA,
	main.CyberVet,
	main.Date_Auth_Memo_Expires,
	main.Date_Auth_Memo_Signed,
	main.dateDeleted,
	main.dateModified,
	main.DCISO,
	main.Division_Acronym,
	--main.DivisionName,
	main.E_AUTH_EXP_DATE,
	main.E_AUTH_LEVEL,
	main.E_AUTH_RISK_ASSESSMENT_DATE,
	main.Financial_System,
	main.FIPS_199_Availability_Rating,
	main.FIPS_199_Confidentiality_Rating,
	main.FIPS_199_Integrity_Rating,
	main.FIPS_199_Overall_Impact_Rating,
	main.FISMA_System,
	main.Group_Acronym,
	main.HVA_Score,
	main.HVAStatus,
	main.In_CMS_Cloud,
	main.Information_System_Type,
	main.Is_DataCenter,
	main.Is_ExcludeFromReporting,
	main.Is_HighRiskSystem,
	main.Is_MarketPlace,
	main.Is_OA_Ready,
	main.Is_OperationalSystem,
	main.Is_PhantomSystem,
	main.Is_SecurityHub_Enabled,
	main.ISRA_REVIEW_DATE,
	main.ISRA_Status,
	main.ISSO Count,
	main.ISSO,
	main.ISSOCS,
	main.Last_ACT_Date,
	main.Last_Pentest_Date,
	main.MEF,
	main.MEF_Context,
	main.MEFStatus,
	main.OA_Status,
	main.OATO_Category,
	main.Package_Type,
	main.PIA_Expiration_Date,
	main.PII_PHI,
	main.Primary_ISSO,
	main.Primary_Operating_Location,
	main.SCA,
	main.SCA_Date,
	main.SDM,
	main.STE_DATE,
	main.System_Description,
	main.TLC_Phase,
	main.TotalAssets,
	main.TotalPOAMwithApprovedRBD,
	main.Next_Required_CP_Test_Date,
	main.Control_Set_Version_Number_System_Provid,
	main.AWS_accountIds,
	main.ATO_EXPIRATION_DATE,
	main.ATO_REVIEW_DATE,
	main.AUTHORIZATION_MEMO_SIGNED_DATE,
	main.BO_RECOMMENDATION_REVIEW_DATE,
	main.BO_REVIEW_DATE,
	main.CISO_REVIEW_DATE,
	main.COMPONENT_DESCRIPTION,
	main.COMPONENT_NAME,
	main.CRA_REVIEW_DATE,
	main.DIVISION_DESCRIPTION,
	main.DSPC_REVIEW_DATE,
	main.DSPPO_REVIEW_DATE,
	main.FIRST_PUBLISHED_DATE,
	main.GROUP_DESCRIPTION,
	main.GROUP_NAME,
	main.ISSO_REVIEW_DATE,
	main.ISSO_SUBMISSION_DATE,
	main.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	main.LAST_ACT_SCA_FINAL_REPORT_DATE,
	main.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	main.PIA_014,
	main.PRIMARY_OPERATING_LOCATION_ACRONYM,
	main.PRIMARY_OPERATING_LOCATION_ID,
	main.REASON_FOR_ATO_REQUEST,
	main.SOP_REVIEW_DATE

,a.REMEDIATED_VULN
,a.DELAYED_VUL
,a.FISMAseverity
,cnt  from CORE.VW_SYSTEMS main

left outer join (select
s.Component_Acronym,
s.Acronym,
v.FISMAseverity,
vm.datemitigated,
SUM(case when v.MitigationStatus = 'Fixed' and vm.datemitigated between DATEADD(day, -(day(CURRENT_DATE()-2)), dateadd(month, -1, CURRENT_DATE()-1)) and 
DATEADD(day, -(day(CURRENT_DATE())), CURRENT_DATE())   then 1 else 0 end) as Remediated_Vuln,
SUM(case when v.MitigationStatus <> 'Fixed' and  v.DaysSinceDiscovery > 90 then 1 else 0 end) as Delayed_Vul,
count(*) as cnt
-- Delayed should be based on this DaysSinceDiscovery
FROM CORE.VW_VULHIST v 
join (select Report_ID,Report_Date, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1) vsnap
on v.report_id = vsnap.Report_ID
JOIN (select dw_vul_id, datemitigated from CORE.VW_VULMASTER) vm on vm.dw_vul_id = v.dw_vul_id
JOIN (select system_id, component_acronym, acronym from CORE.VW_SYSTEMS) s on s.system_id = v.system_id
where v.FISMAseverity in ('Critical','High') 
GROUP BY s.Component_Acronym
,v.FISMAseverity,Acronym,vm.datemitigated)a

on (a.Component_Acronym = main.Component_Acronym and a.Acronym=main.Acronym)
where TLC_Phase = 'Operate';
create or replace view VW_MARKETPLACE_OVERDUE_VRAD(
	COMPONENT_ACRONYM,
	SYSTEM_ID,
	FISMA_ID,
	ACRONYM,
	TLC_PHASE,
	OATO_CATEGORY,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DATACENTER_ID,
	AWS_ACCOUNTIDS,
	CVE,
	DW_VUL_ID,
	TENABLEUUID,
	PLUGINID,
	FAMILYNAME,
	SIGNATURE,
	SOLUTION,
	FISMASEVERITY,
	CVSS3BASESCORE,
	EPSS,
	EPSS_FILTER,
	EPSS_PERCENTILE,
	MITIGATIONSTATUS,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	OVERDUE_FILTER,
	IS_BOD,
	BODDUEDATE,
	SENSOR_FIRSTSEEN,
	SENSOR_LASTFOUND,
	EXPLOITAVAILABLE,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	ENVIRONMENT,
	COMPUTER_TYPE,
	DEVICETYPE,
	IPV4,
	IPV6,
	HOSTNAME,
	FQDN,
	OS,
	OS_VERSION,
	MAC,
	NETBIOSNAME,
	BIOS_GUID,
	SOURCE_TOOL,
	VULNRISKTOLERANCE,
	REFRESH_DATE,
	CLOUD_ACCOUNT_ID
) COMMENT='provides overdue vulns and related asset details for Marketplace Systems only'
 as
select 
	COMPONENT_ACRONYM,
    SYSTEM_ID,
    FISMA_ID,
    ACRONYM,
    TLC_PHASE,
    OATO_CATEGORY,
    IS_MARKETPLACE,
    HVASTATUS,
    MEFSTATUS,
    DATA_CENTER_NAME,
    DATACENTER_ID,
    AWS_ACCOUNTIDS,
    CVE,
    DW_VUL_ID,
    TENABLEUUID,
    PLUGINID,
    FAMILYNAME,
    SIGNATURE,
    SOLUTION,
    FISMASEVERITY,
    CVSS3BASESCORE,
    EPSS,
    EPSS_FILTER,
    PERCENTILE EPSS_PERCENTILE,
    MITIGATIONSTATUS,
    DATEMITIGATED,
    DAYSSINCEDISCOVERY,
    DAYSSINCEDISCOVERY_FILTER,
    OVERDUE_FILTER,
    IS_BOD,
    BODDUEDATE,
    SENSOR_FIRSTSEEN,
    SENSOR_LASTFOUND,
    EXPLOITAVAILABLE,
    DW_ASSET_ID,
    ASSET_ID_TATTOO,
    ENVIRONMENT,
    COMPUTER_TYPE,
    DEVICETYPE,
    IPV4,
    IPV6,
    HOSTNAME,
    FQDN,
    OS,
    OS_VERSION,
    MAC,
    NETBIOSNAME,
    BIOS_GUID,
    SOURCE_TOOL,
    VULNRISKTOLERANCE,
    REFRESH_DATE,
    CLOUD_ACCOUNT_ID -- 241127 0846 CR1038
 from RPT.VW_ASSETDETAIL_ROLLING60DAYS asst
where is_marketplace = 1 and lower(MitigationStatus) in ('open', 'reopened')
and ((Asst.FISMASEVERITY = 'Critical' and Asst.DAYSSINCEDISCOVERY > 15) OR
    (Asst.FISMASEVERITY = 'High' and Asst.DAYSSINCEDISCOVERY > 30) OR
    (Asst.FISMASEVERITY = 'Medium' and Asst.DAYSSINCEDISCOVERY > 90) OR
    (Asst.FISMASEVERITY = 'Low' and Asst.DAYSSINCEDISCOVERY > 365))
;
create or replace view VW_SEC_USERSYSMAPPING_VATDC(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ACRONYM,
	SYSTEM_ID,
	USERID
) COMMENT='Security view for specifically crated for Data center users (Details provided by VAT team)'
 as
select distinct
 A.DATACENTER_ACRONYM --as "DataCenter Acronym"
,A.DATACENTER_ID --as "DataCenterUID"
,S.Acronym --as "System Acronym"
,S.SYSTEM_ID --as "SystemUID"
,SU.UserId --as "UserName"
from CORE.VW_SYSTEMS S
join CORE.VW_ASSETS A on A.system_id = S.system_id
join rpt.VAT_SYSTEMUSERS SU on S.SYSTEM_ID = SU.SYSTEM_ID
where S.Is_ExcludeFromReporting = 0 and S.Is_PhantomSystem=0 and SU.UserId is not null
;
create or replace view VW_TRAL_RISKSEVERITYLEVEL(
	SYSTEMRISKCATEGORY,
	DESCRIPTION,
	METRICID,
	METRICNAME,
	TRIGGERDESCRIPTION,
	THRESHOLDDISPLAY,
	THRESHOLD,
	POTENTIALTHREATSOURCES,
	IMPACT,
	LIKELIHOODINITIATION,
	LIKELIHOODADVERSEIMPACT,
	OVERALLLIKELIHOOD,
	RISKSEVERITYLEVEL,
	IMPACTEDCONTROLS,
	RISKRESPONSE
) COMMENT='Trigger Accountability Log: Contains system information, impacted controls, Threshold and Impact'
 as
SELECT * FROM CORE.VW_TRAL_RISKSEVERITYLEVEL;
create or replace view VW_VATOPS_WKLY_SYSTEMS_STATUS(
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	SYSTEM_ACRONYM,
	ASSETS,
	ASSETS_SCANNED
) COMMENT='Data used for VAT weekly systems status'
 as
SELECT t.REPORT_ID
    ,t.REPORT_DATE
    ,t.SYSTEM_ID
    ,t.SYSTEM_ACRONYM
    ,t.ASSETS
    ,t.ASSETS ASSETS_SCANNED
FROM (
(select REPORT_ID, REPORT_DATE, SYSTEM_ID, SYSTEM_ACRONYM, count(1) ASSETS 
from CORE.VW_ASSETHIST group by REPORT_ID, SYSTEM_ACRONYM, REPORT_DATE, SYSTEM_ID order by count(1) DESC)
) t
Join (select top 31 REPORT_ID, REPORT_DATE from CORE.REPORT_IDS order by REPORT_ID desc) RI on RI.REPORT_ID = t.REPORT_ID 
order by t.REPORT_ID DESC
;
create or replace view VW_VULCURR_DETAIL(
	REPORT_ID,
	SYSTEM_ID,
	SYSTEMACRONYM,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	EPSS,
	EPSS_FILTER,
	PERCENTILE
) COMMENT='current statistics over all vulns including EPSS metrics for CR#959'
 as
SELECT 
r.REPORT_ID
,s.SYSTEM_ID
,s.Acronym as SystemAcronym
,s.GROUP_ACRONYM
,s.GROUP_NAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.cve
,v.CVSSV2BASESCORE as CVSSV2BASE 
,v.CVSSV3BASESCORE as CVSSV3Base
,v.DaysSinceDiscovery
,case 
    when v.FISMAseverity = 'Critical' and v.DAYSSINCEDISCOVERY > 15 then 'Critical >15 days'
    when v.FISMAseverity = 'High' and v.DAYSSINCEDISCOVERY > 30 then 'high >30 days'
    when v.FISMAseverity = 'Medium' and v.DAYSSINCEDISCOVERY > 90 then 'moderate > 90 days'
    when v.FISMAseverity = 'Low' and v.DAYSSINCEDISCOVERY > 365 then 'low > 365 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER 
,v.exploitAvailable
,vm.firstSeen
,v.FISMAseverity
,v.lastFound
,v.MitigationStatus
,vm.IS_KEV as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated 
,epss.epss 
,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    End as EPSS_FILTER 
,epss.percentile 
FROM (Select max(REPORT_ID) REPORT_ID from core.report_ids) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_VUL_ID = v.dw_vul_id
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = v.SYSTEM_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = v.cve
where v.MitigationStatus IN ('open','reopened');
create or replace view VW_VULCURR_DETAIL_MCRR(
	REPORT_ID,
	SYSTEM_ID,
	SYSTEMACRONYM,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	EPSS,
	EPSS_FILTER,
	PERCENTILE
) COMMENT='current statistics over all vulns including EPSS and FISMAseverity metrics for CR#977'
 as
SELECT 
r.REPORT_ID
,s.SYSTEM_ID
,s.Acronym as SystemAcronym
,s.GROUP_ACRONYM
,s.GROUP_NAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_NAME
,vm.cve
,v.CVSSV2BASESCORE as CVSSV2BASE 
,v.CVSSV3BASESCORE as CVSSV3Base
,v.DaysSinceDiscovery
,case 
    when v.FISMAseverity = 'Critical' and v.DAYSSINCEDISCOVERY > 15 then 'Critical >15 days'
    when v.FISMAseverity = 'High' and v.DAYSSINCEDISCOVERY > 30 then 'high >30 days'
    when v.FISMAseverity = 'Medium' and v.DAYSSINCEDISCOVERY > 90 then 'moderate > 90 days'
    when v.FISMAseverity = 'Low' and v.DAYSSINCEDISCOVERY > 365 then 'low > 365 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER 
,v.exploitAvailable
,vm.firstSeen
,v.FISMAseverity
,v.lastFound
,v.MitigationStatus
,vm.IS_KEV as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated 
,epss.epss 
,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    End as EPSS_FILTER 
,epss.percentile 
FROM (Select max(REPORT_ID) REPORT_ID from core.report_ids where is_endofmonth = 1) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_VUL_ID = v.dw_vul_id
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = v.SYSTEM_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = v.cve
where v.MitigationStatus IN ('open','reopened');
create or replace view VW_VULN_DASHBOARD_TRENDING(
	ACRONYM,
	COMPONENT_ACRONYM,
	CVE_COUNT,
	UNIQUE_CVE_COUNT,
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Contains all the summarized Vulnerabilities for latest 12 month end and current day snapshots at Org Hierarchy level'
 as
SELECT 
ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count" CVE_Count,
    "Unique CVE Count" Unique_CVE_Count,
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
    FROM RPT.TEMP_VULN_TRENDING;
create or replace view VW_VULN_ROLLING60DAYS(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS,
	EPSS,
	PERCENTILE
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (FK_PRIMARY_FISMA_ID)
 COMMENT='Contains all the Vulnerabilities for latest 2 snapshots (Current/EOM) with granular CVE IDs for each system/data Center/component'
 as
SELECT 	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
    FK_PRIMARY_FISMA_ID FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID" as POAM_ID,
	OVERALL_STATUS 
    ,epss.epss
    ,epss.percentile
    FROM RPT.TEMP_VULN_FV_ROLLING60DAYS vuln
    LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vuln.cve
;
create or replace view V_ASSETDETAIL(
	"dw_asset_id",
	"asset_id_derived",
	"asset_id_tattoo",
	"bigfix_asset_id",
	"bios_guid",
	"cms_asset_uid",
	"computer_type",
	"DataCenter_Acronym",
	"Is_DataCenter",
	"DataCenter_Is_Phantom",
	"datacenter_id",
	"datecreated",
	"dateModified",
	"DeviceRole",
	"DeviceType",
	"environment",
	FQDN,
	"hostname",
	"last_confirmed_time",
	"motherboard_sn",
	"netbios_hn",
	"os",
	"os_cpe",
	"os_version",
	"primary_fisma_id_derived",
	"System_Acronym",
	"System_Is_Phantom",
	"primary_fisma_id",
	"primary_fisma_id_tattoo",
	"IPv4",
	"IPv6",
	"Mac",
	"source_tool",
	"source_tool_create",
	"datacenter_id_derived",
	"dependent_fisma_id",
	"VulnRiskTolerance"
) COMMENT='Contains all the asset data and Vuln risk tolerance of each asset for current snapshot'
 as
SELECT 
a.DW_ASSET_ID as "dw_asset_id"
,null as "asset_id_derived"
,a.asset_id_tattoo as "asset_id_tattoo"
,a.bigfix_asset_id as "bigfix_asset_id"
,a.bios_guid as "bios_guid"
,a.asset_id_tattoo as "cms_asset_uid"
,a.computer_type as "computer_type"
,dc.Acronym as "DataCenter_Acronym"
,dc.Is_DataCenter as "Is_DataCenter"
,dc.IS_PHANTOMSYSTEM as "DataCenter_Is_Phantom"
,a.DATACENTER_ID as "datacenter_id"
,a.INSERT_DATE as "datecreated"
,a.dateModified as "dateModified"
,dt.DeviceRole as "DeviceRole"
,dt.DeviceType as "DeviceType"
,a.environment as "environment"
,a.FQDN as "FQDN"
,a.hostname as "hostname"
,a.last_confirmed_time as "last_confirmed_time"
,a.motherboard as "motherboard_sn"
,a.netbiosname as "netbios_hn"
,a.os as "os"
,a.os_cpe as "os_cpe"
,a.os_version as "os_version"
,s.SYSTEM_ID as "primary_fisma_id_derived"
,s.Acronym as "System_Acronym"
,s.IS_PHANTOMSYSTEM as "System_Is_Phantom"
,s.SYSTEM_ID as "primary_fisma_id"
,s.SYSTEM_ID as "primary_fisma_id_tattoo"
,a.IPv4 as "IPv4"
,a.IPv6 as "IPv6"
,a.Macaddress as "Mac"
,a.source_tool_lastseen as "source_tool"
,a.source_tool_create as "source_tool_create"
,dc.SYSTEM_ID as "datacenter_id_derived"
,null as "dependent_fisma_id"
,a.VulnRiskTolerance as "VulnRiskTolerance"
FROM CORE.VW_Assets a
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.DEVICETYPES dt on dt.DEVICETYPE = a.DEVICETYPE
;
create or replace view V_ASSETDETAIL_DASHBOARD(
	"filter",
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	"id",
	"FK_dw_vul_number",
	"cve",
	"daysSinceDiscovery",
	"exploitavailable",
	"firstseen",
	"fismaseverity",
	"lastfound",
	"mitigationstatus",
	"fk_snapshotid",
	"BODDueDate",
	"datecreated",
	"datemitigated",
	"DeletionReason",
	"Acronym",
	"Acr_Alias",
	"Component_Acronym",
	"is_bod",
	"rankk",
	"refresh_date",
	"solution",
	"familyname",
	"HVAStatus",
	"MEFStatus",
	"Is_MarketPlace",
	"signature",
	"pluginid",
	"data_center_name",
	"FK_AssetID",
	"computer_type",
	"os",
	"bios_guid",
	"source_tool",
	"environment",
	"asset_id_tattoo",
	"os_version",
	"TenableUUID",
	"DeviceType",
	"fqdn",
	"hostname",
	"ipv4",
	"ipv6",
	"Mac",
	"netbiosname",
	"VulnRiskTolerance",
	"cvss2basescore",
	"OATO_Category",
	"Sensor_firstseen",
	"Sensor_lastfound",
	"cvss3basescore",
	"dw_asset_id",
	"datacenter_id_derived",
	"AWS_accountIds",
	"TLC_Phase",
	CLOUD_ACCOUNT_ID
) COMMENT='Not using in tableau'
 as
--with 
--ReportIDs as ((select REPORT_ID,REPORT_DATE,SNAPSHOT_ID 
--    from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE,SNAPSHOT_ID from CORE.VW_ReportSnapshots
--	where DataCategory= 'VUL')a where rankkForSnap =1)),
--AssetSnapshots as (select REPORT_ID,SNAPSHOT_ID from ReportIDs r)
select 1 as filter,
s.SYSTEM_ID as FK_PRIMARY_FISMA_ID,
dc.SYSTEM_ID as FK_DATACENTER_ID,
vm.DW_VUL_ID as id,
vm.DW_VUL_ID as FK_DW_VUL_NUMBER,
vm.cve,
vm.daysSinceDiscovery,
vm.exploitavailable,
vm.firstseen,
vm.fismaseverity,
vm.lastfound,
--vm.cve,
vm.mitigationstatus,
--(select REPORT_ID FROM AssetSnapshots) as FK_SNAPSHOTID,
vm.FK_SNAPSHOTID,
vm.BODDueDate,
vm.insert_date as datecreated,
vm.datemitigated,
null as DELETIONREASON,
s.Acronym,
substring(s.Acronym, 1, 1) || '***' as Acr_Alias,
s.Component_Acronym,
vm.IS_KEV as is_bod,
dense_rank()over(order by FK_SNAPSHOTID ASC) as rankk, -- Reenabled 230622
CURRENT_TIMESTAMP() as refresh_date,
p.solution,
p.FAMILY_NAME as familyname, -- 230818 1433
s.HVAStatus,
s.MEFStatus,
s.Is_MarketPlace,
p.SOLUTION as signature, -- 230818 1433
p.PLUGIN_ID as pluginid,  -- 230818 1433
dc.acronym as data_center_name,
a.dw_Asset_ID as FK_AssetID,
a.computer_type,
a.os,
a.bios_guid,
a.source_tool_lastseen as source_tool,
a.environment,
a.asset_id_tattoo,
a.os_version,
a.TenableUUID,
a.DeviceType,
aic.fqdn,
aic.hostname,
aic.ipv4,
aic.ipv6,
aic.MACADDRESS as Mac,
aic.netbiosname,
a.VulnRiskTolerance,
vm.CVSSV2BASESCORE as cvss2basescore,
s.OATO_Category,
vm.FIRSTSEEN as Sensor_firstseen,
vm.LASTFOUND as Sensor_lastfound,
vm.CVSSV3BASESCORE as cvss3basescore,
vm.dw_asset_id,
dc.SYSTEM_ID as datacenter_id_derived,
SUBSTRING(s.AWS_ACCOUNTIDS,1,2000) as AWS_ACCOUNTIDS, -- 230328 1646 EBF add substring to AWS_accountIds because varchar(max) causes Tableau to fail
s.TLC_Phase,
a.CLOUD_ACCOUNT_ID -- 241125 CR1038
from CORE.VW_ASSETS a
JOIN (select (select REPORT_ID from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as FK_SNAPSHOTID
,* FROM CORE.VW_VULMASTER) vm on vm.dw_asset_id = a.dw_asset_id

RIGHT OUTER JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
left outer JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = a.DATACENTER_ID

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VULPLUGIN group by DW_VUL_ID) plugs on plugs.DW_VUL_ID = vm.dw_vul_id -- 230818 1433
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID -- 230818 1433
    
-- 230818 1433 left outer join (select dw_vul_id,max(DW_PLUGIN_ID) as pluginID FROM CORE.VulPlugin group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.DW_VUL_ID)
-- 230818 1433 left outer join (select DW_PLUGIN_ID,solution,familyname,DW_PLUGIN_ID as pluginid,signature from CORE.Plugins) p on (p.DW_PLUGIN_ID = plugs.pluginID)

left join (select i.DW_ASSET_ID,i.fqdn,i.hostname,i.ipv4,i.ipv6,i.MacADDRESS,i.netbiosname
    from CORE.ASSETINTERFACECOALESCED i
    JOIN (select DW_ASSET_ID, Max(ID) as AssetInterfaceID
    FROM CORE.ASSETINTERFACECOALESCED group by DW_ASSET_ID) as InterFaceMax ON InterFaceMax.AssetInterfaceID=i.ID) aic on aic.DW_ASSET_ID = a.DW_ASSET_ID
;
create or replace view V_BOD_DETAIL(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	FISMA_ID,
	IS_MARKETPLACE,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	CVE,
	"Vendor/Project",
	PRODUCT,
	VULNERABILITYNAME,
	DATEADDEDTOCATALOG,
	SHORTDESCRIPTION,
	BODDUEDATE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (FISMA_ID)
 COMMENT='Contains previous days details related to the KEV Vuln data population '
 as
SELECT a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,a.system_id FISMA_ID
,s.IS_MARKETPLACE
,a.asset_id_tattoo
,a.fqdn
,a.hostname
,vm.CVE
,kev.VendorProject as "Vendor/Project"
,kev.Product
,kev.VulnerabilityName
,kev.DateAddedToCatalog
,kev.ShortDescription
,kev.BODDueDate
,vm.DaysSinceDiscovery
,kev.exploitAvailable
,kev.FISMAseverity
FROM CORE.VW_VulMaster vm
join CORE.VW_Assets a on a.dw_asset_id = vm.DW_ASSET_ID
join core.vw_systems s on a.system_id = s.system_id
JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.cve and kev.Is_Deleted = 0
where vm.MitigationStatus <> 'fixed'
;
create or replace view V_BOD_SUMMARY(
	DATACENTER,
	FISMA_ID,
	SYSTEM_ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	IS_MARKETPLACE,
	CVE,
	"Vendor/Project",
	PRODUCT,
	VULNERABILITYNAME,
	DATEADDEDTOCATALOG,
	SHORTDESCRIPTION,
	BODDUEDATE,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	"POA&M ID",
	TOTAL,
	OVERALL_STATUS
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (FISMA_ID)
 COMMENT='Contains previous days Summary level data related to the Known & exploited Vuln population'
 as
SELECT 
dc.Acronym as DataCenter
,s.SYSTEM_ID as FISMA_ID
,s.Acronym as System_Acronym
,substring(s.Acronym, 1, 1) || '***' as Acr_Alias
,s.Component_Acronym
,s.Group_Acronym
,s.IS_MARKETPLACE
,vm.CVE
,bod.VendorProject as "Vendor/Project"
,bod.Product
,bod.VulnerabilityName
,bod.DateAddedToCatalog
,bod.ShortDescription
,bod.BODDueDate
,bod.exploitAvailable
,bod.FISMAseverity
,p.POAM_ID as "POA&M ID"
,vm.Total
,p.Overall_Status
FROM CORE.KEV_Catalog bod 
join (SELECT DATACENTER_ID,SYSTEM_ID,cve,count(1) as Total
    FROM CORE.VW_VULMASTER where IS_KEV = 1 and MitigationStatus <> 'fixed'
    group by DATACENTER_ID,SYSTEM_ID,cve) vm on vm.CVE = bod.cve
join CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = vm.DATACENTER_ID
right outer join CORE.VW_SYSTEMS s on s.SYSTEM_ID = vm.SYSTEM_ID

left join (SELECT SYSTEM_ID, POAM_ID, Overall_Status,CVE
    FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.VW_POAMHIST p on p.REPORT_ID = r.REPORT_ID
    WHERE p.CVE IS NOT NULL) p on p.SYSTEM_ID = vm.SYSTEM_ID and p.CVE = vm.CVE

order by dc.Acronym,s.Acronym,vm.CVE;
create or replace view V_CAATHIST(
	ID,
	"ReportID",
	"ReportDate",
	"Archer_Tracking_ID",
	"Assessment_Audit_Company",
	"Authorization_Package",
	CAAT_ID,
	"Date_Identified",
	"Finding_Description",
	"Finding_ID",
	"Finding_Title",
	"Related_POA&Ms",
	"Source",
	"Test_Method",
	"Test_Objective",
	"Test_Result",
	"Weakness_Description",
	"FK_SystemID",
	CFACTS_UID
) COMMENT='CAAT related History information sourced from CFACTS '
 as
SELECT 
caat.ID as "ID"
,caat.REPORT_ID as "ReportID"
,r.report_date as "ReportDate"
,s.Archer_Tracking_ID as "Archer_Tracking_ID"
,caat.Assessment_Audit_Company as "Assessment_Audit_Company"
,s.Authorization_Package as "Authorization_Package"
,caat.CAAT_ID as "CAAT_ID"
,caat.Date_Identified as "Date_Identified"
,caat.Finding_Description as "Finding_Description"
,caat.Finding_ID as "Finding_ID"
,caat.Finding_Title as "Finding_Title"
,caat.Related_POAMS as "Related_POA&Ms"
,caat.SOURCE_AUDIT_TYPE as "Source"
,caat.Test_Method as "Test_Method"
,caat.Test_Objective as "Test_Objective"
,caat.Test_Result as "Test_Result"
,caat.Weakness_Description as "Weakness_Description"
,caat.SYSTEM_ID as "FK_SystemID"
,caat.SYSTEM_ID as "CFACTS_UID"
FROM CORE.CAATHist caat
JOIN CORE.REPORT_IDS r on r.REPORT_ID = caat.REPORT_ID
LEFT OUTER JOIN CORE.VW_Systems s on s.SYSTEM_ID = caat.SYSTEM_ID;
create or replace view V_CAATMONTHENDSNAPSHOT(
	ID,
	"ReportID",
	"ReportDate",
	"Archer_Tracking_ID",
	"Assessment_Audit_Company",
	"Authorization_Package",
	CAAT_ID,
	"Date_Identified",
	"Finding_Description",
	"Finding_ID",
	"Finding_Title",
	"Related_POA&Ms",
	"Source",
	"Test_Method",
	"Test_Objective",
	"Test_Result",
	"Weakness_Description",
	"FK_SystemID",
	CFACTS_UID
) COMMENT='CAAT related information for the previous month end snapshot (generated on first working day of every month) sourced from CFACTS'
 as
SELECT 
caat.ID as "ID"
,caat.REPORT_ID as "ReportID"
,r.report_date as "ReportDate"
,s.Archer_Tracking_ID as "Archer_Tracking_ID"
,caat.Assessment_Audit_Company as "Assessment_Audit_Company"
,s.Authorization_Package as "Authorization_Package"
,caat.CAAT_ID as "CAAT_ID"
,caat.Date_Identified as "Date_Identified"
,caat.Finding_Description as "Finding_Description"
,caat.Finding_ID as "Finding_ID"
,caat.Finding_Title as "Finding_Title"
,caat.Related_POAMS as "Related_POA&Ms"
,caat.SOURCE_AUDIT_TYPE as "Source"
,caat.Test_Method as "Test_Method"
,caat.Test_Objective as "Test_Objective"
,caat.Test_Result as "Test_Result"
,caat.Weakness_Description as "Weakness_Description"
,caat.SYSTEM_ID as "FK_SystemID"
,caat.SYSTEM_ID as "CFACTS_UID"
FROM CORE.CAATHIST caat
JOIN CORE.REPORT_IDS r on r.REPORT_ID = caat.REPORT_ID and r.IS_ENDOFMONTH = 1
LEFT OUTER JOIN CORE.VW_Systems s on s.SYSTEM_ID = caat.SYSTEM_ID;
create or replace view V_CAPM(
	"Component",
	"Component Acronym",
	"Primary CRA",
	"TLC Phase",
	"FISMA System",
	"FISMA System Acronym",
	"CFACTS Creation Date",
	"Pen Test Final Report Date",
	"ACT Final Report Date",
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	"Reason for ATO Request",
	"ISSO Submission",
	"SOP Review Date",
	"BO Review Date",
	"ATO Review Date",
	"CRA Review Date",
	"ISSO Review Date",
	"BO Recommendation Review Date",
	"DSPPO Review Date",
	"DSPC Review Date",
	"CISO Review Date",
	"Authorization Memo Signed Date",
	DATE_AUTH_MEMO_EXPIRES,
	"ATO Expiration Date",
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	"Workflow Plase"
) COMMENT='Contains data related to CMS ATO performance metrics including ATO approval process along with important dates'
 as 
SELECT 
s.COMPONENT_NAME as "Component"
,s.COMPONENT_ACRONYM as "Component Acronym"
,CRA as "Primary CRA"
,TLC_Phase as "TLC Phase"
,FISMA_System as "FISMA System"
,s.Acronym as "FISMA System Acronym"
,s.First_Published_Date as "CFACTS Creation Date"
,s.Last_Pentest_Date as "Pen Test Final Report Date"
,s.Last_ACT_Date as "ACT Final Report Date"
,s.Last_ACT_SCA_CAAT_Processed_File_Date
,s.Last_Pentest_CAAT_Processed_File_Date
,Reason_for_ATO_Request as "Reason for ATO Request"
,ISSO_SUBMISSION_DATE as "ISSO Submission"
,SOP_Review_Date as "SOP Review Date"
,BO_Review_Date as "BO Review Date"
,ATO_Review_Date as "ATO Review Date"
,CRA_Review_Date as "CRA Review Date"
,ISSO_Review_Date as "ISSO Review Date"
,BO_Recommendation_Review_Date as "BO Recommendation Review Date"
,DSPPO_Review_Date as "DSPPO Review Date"
,DSPC_Review_Date as "DSPC Review Date"
,CISO_Review_Date as "CISO Review Date"
,Authorization_Memo_Signed_Date as "Authorization Memo Signed Date"
,s.Date_Auth_Memo_Expires
,ATO_Expiration_Date as "ATO Expiration Date"
,s.Business_Owner
,s.Primary_ISSO
,IFF( Authorization_Memo_Signed_Date is not null ,'Approve',
IFF(SOP_Review_Date is not null
OR BO_Review_Date is not null
OR ATO_Review_Date is not null
OR CRA_Review_Date is not null
OR ISSO_Review_Date is not null
OR BO_Recommendation_Review_Date is not null
OR DSPPO_Review_Date is not null
OR DSPC_Review_Date is not null
OR CISO_Review_Date is not null, 'Review',
IFF(ISSO_SUBMISSION_DATE is not null ,'Validate',
IFF(s.Last_Pentest_Date is not null 
OR s.Last_ACT_Date is not null,'Assessment',
NULL)))) as "Workflow Plase"
FROM CORE.VW_Systems s
;
create or replace view V_CFACTS_USERLIST(
	USER_ID
) COMMENT='Simple list of distinct CFACTS user IDs'
 as
SELECT DISTINCT USER_ID FROM CORE.CFACTS_USERMAPPING order by USER_ID
;
create or replace view V_CFACTS_USERMAPPING(
	ID,
	"Component_Acronym",
	"EntryType",
	"Group_Acronym",
	"Role",
	"Acronym",
	"FK_userID",
	"UserName",
	"FK_SystemID",
	CFACTS_UID
) COMMENT='User/System mapping structure for permissions'
 as
SELECT 
um.ID as "ID"
,s.COMPONENT_ACRONYM as "Component_Acronym"
,null as "EntryType"
,s.GROUP_ACRONYM as "Group_Acronym"
,um.ROLE as "Role"
,um.ACRONYM as "Acronym"
,um.USER_ID as "FK_userID"
,um.USER_ID as "UserName"
,um.SYSTEM_ID as "FK_SystemID"
,um.SYSTEM_ID as "CFACTS_UID"
FROM CORE.CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID;
create or replace view V_CRMP_AUTHORIZATIONPACKAGE(
	"SnapshotDate",
	ACRONYM,
	TLC_PHASE,
	PACKAGE_TYPE,
	INFORMATIONTYPE,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	DIVISION_ACRONYM,
	FISMA_SYSTEM,
	HVASTATUS
) COMMENT='Auth package level details data'
 as
SELECT 
(select top 1 REPORT_DATE from CORE.REPORT_IDS ORDER BY REPORT_ID DESC) as SnapshotDate
,s.Acronym
,s.TLC_Phase
,s.Package_Type 
,s.Information_System_Type as InformationType
,s.Component_Acronym
,s.Group_Acronym
,s.Division_Acronym
,s.FISMA_System
,s.HVAStatus
FROM CORE.VW_SYSTEMS s
;
create or replace view V_CRMP_MEANTIMETOREMEDIATE(
	ID,
	"dateCreated",
	"DataCenterAcronym",
	"SnapshotDate",
	"SystemAcronym",
	"asset_id_tattoo",
	"cve",
	"CVSSv2Base",
	"CVSSv3Base",
	"DaysSinceDiscovery",
	"exploitAvailable",
	"firstSeen",
	"FISMAseverity",
	"lastFound",
	"MitigationStatus",
	OS,
	"source_tool",
	"Datacenter_id",
	"FISMA_id",
	"Group Acronym",
	"Component Acronym",
	"Is_Legacy"
) COMMENT='FIXED and CRITICAL/HIGH vulns'
 as
SELECT 
v.ID as "ID"
,r.REPORT_DATE as "dateCreated"
,dc.Acronym as "DataCenterAcronym"
,r.REPORT_DATE as "SnapshotDate"
,s.Acronym as "SystemAcronym"
,a.asset_id_tattoo as "asset_id_tattoo"
,vm.cve as "cve"
,v.CVSSV2BASESCORE as "CVSSv2Base"
,v.CVSSV3BASESCORE as "CVSSv3Base"
,vm.DaysSinceDiscovery as "DaysSinceDiscovery"
,v.exploitAvailable as "exploitAvailable"
,vm.firstSeen as "firstSeen"
,v.FISMAseverity as "FISMAseverity"
,v.lastFound as "lastFound"
,v.MitigationStatus as "MitigationStatus"
,a.OS as "OS"
,'Tenable' as "source_tool"
,dc.SYSTEM_ID as "Datacenter_id"
,s.SYSTEM_ID as "FISMA_id"
,s.Group_Acronym  as "Group Acronym"
,s.Component_Acronym  as "Component Acronym"
,vm.Is_Legacy as "Is_Legacy"
from TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VULHIST v on v.REPORT_ID = r.REPORT_ID -- 230718 was VW_VULHIST which only returns open/reopen
join CORE.VW_VulMaster vm on vm.DW_VUL_ID = v.DW_VUL_ID
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
where s.Is_OperationalSystem = 1 and s.Is_HighRiskSystem = 1
and upper(v.MitigationStatus) IN ('FIXED')
and upper(v.FISMAseverity) IN ('CRITICAL','HIGH')
;
create or replace view V_CRMP_OATO_SYSTEMS(
	"Acronym",
	FISMA_ID,
	"OA Ready",
	"OA_Status",
	"ResidualRisk",
	"Asset Risk Tolerance",
	"TotalAssets",
	"OATO_Category",
	"HVAStatus",
	"MEFStatus",
	"FIPS_199_Overall_Impact_Rating",
	PII_PHI,
	"Financial_System",
	"Component",
	"DevSecOPS / CSM",
	"Group_Acronym",
	"In_CMS_Cloud",
	"Last_ACT_Date",
	"Last_ACT_SCA_Final_Report_Date",
	"Last_Pentest_Date",
	"Is_SecurityHub_Enabled",
	"System",
	"TLC_Phase",
	"Vuln Risk Tolerance",
	"Resiliency Score",
	"Primary_Operating_Location",
	"Is_MarketPlace"
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (FISMA_ID)
 COMMENT='Contains System level Ongoing \"Authorization information\" and related metrics like Asset Risk Tolerance, Vuln Risk tolernace, System resiliency etc'
 as
SELECT 
s.Acronym as "Acronym"
,s.system_id FISMA_ID
,IFF(s.Is_OA_Ready=1,'Yes','No') as "OA Ready"
,s.OA_Status as "OA_Status"
,s.TotalPOAMwithApprovedRBD as "ResidualRisk"
,ss.AssetRiskTolerance as "Asset Risk Tolerance"
,ss.Assets as "TotalAssets"
,s.OATO_Category as "OATO_Category"
,s.HVAStatus as "HVAStatus"
,s.MEFStatus as "MEFStatus"
,s.FIPS_199_Overall_Impact_Rating as "FIPS_199_Overall_Impact_Rating"
,s.PII_PHI as "PII_PHI"
,s.Financial_System as "Financial_System"
,s.Component_Acronym as "Component"
,'TBD' as "DevSecOPS / CSM"
,s.Group_Acronym as "Group_Acronym"
,coalesce(s.In_CMS_Cloud,'No') as "In_CMS_Cloud"
,s.Last_ACT_Date as "Last_ACT_Date"
,s.Last_ACT_SCA_Final_Report_Date  as "Last_ACT_SCA_Final_Report_Date"
,s.Last_Pentest_Date as "Last_Pentest_Date"
,IFF(s.Is_SecurityHub_Enabled=1,'Yes','No') as "Is_SecurityHub_Enabled"
,s.AUTHORIZATION_PACKAGE as "System"
,s.TLC_Phase as "TLC_Phase"
,ss.VulnRiskTolerance  as "Vuln Risk Tolerance"
,ss.ResiliencyScore as "Resiliency Score"
,s.PRIMARY_OPERATING_LOCATION as "Primary_Operating_Location"
,s.IS_MARKETPLACE as "Is_MarketPlace" -- 231108 1545 added
FROM CORE.VW_Systems  s
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
JOIN CORE.VW_SYSTEMSUMMARY ss on ss.SYSTEM_ID = s.SYSTEM_ID and ss.REPORT_ID = (select max(REPORT_ID) FROM CORE.VW_SYSTEMSUMMARY)
where s.Is_OperationalSystem = 1;
create or replace view V_CRMP_PCTSYSTEMSAUTHORIZED(
	ACRONYM,
	AUTH_DECISION
) COMMENT='ATO system acronyms'
 as
SELECT s.Acronym
,s.Auth_Decision
FROM CORE.VW_Systems  s
where s.Is_OperationalSystem = 1 and s.Auth_Decision = 'ATO';
create or replace view V_CRMP_PENTEST(
	"Acronym",
	"Component_Acronym",
	CAAT_ID,
	"Related_POA&Ms",
	"Source",
	"Test_Result",
	"SnapshotDate",
	"POA&M ID",
	"Days_Open",
	"Overall_Status",
	"Actual_Completion_Date",
	CAAT,
	"POA&M_Closed_Date",
	"Target",
	"Weakness_ID",
	"Weakness_Creation_Date",
	"Weakness_Risk_Level",
	"Weakness_Severity",
	"Date_Identified",
	SYSTEM_ID
) COMMENT='Used in other views to get Pentest data'
 as
SELECT 
s.Acronym as "Acronym"
,s.Component_Acronym as "Component_Acronym"
,caat.CAAT_ID as "CAAT_ID"
,caat.Related_POAMS as "Related_POA&Ms"
,caat.SOURCE_AUDIT_TYPE as "Source"
,caat.Test_Result as "Test_Result"
,r.REPORT_DATE as "SnapshotDate"
,ph.POAM_ID as "POA&M ID"
,ph.Days_Open as "Days_Open"
,ph.Overall_Status as "Overall_Status"
,ph.Actual_Completion_Date as "Actual_Completion_Date"
,ph.CAAT as "CAAT"
,ph.POAM_Closed_Date as "POA&M_Closed_Date"
,ph.Target as "Target"
,ph.Weakness_ID as "Weakness_ID"
,ph.Weakness_Creation_Date as "Weakness_Creation_Date"
,ph.Weakness_Risk_Level as "Weakness_Risk_Level"
,ph.Weakness_Severity as "Weakness_Severity"
,caat.Date_Identified as "Date_Identified" -- 230623 new in SDL
,s.SYSTEM_ID as "SYSTEM_ID" -- 230623 new in SDL
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.CAATHist caat on caat.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = caat.SYSTEM_ID
LEFT OUTER JOIN CORE.VW_POAMHist ph on ph.REPORT_ID = r.REPORT_ID and ph.SYSTEM_ID = caat.SYSTEM_ID and ph.POAM_ID = caat.Related_POAMS
where caat.SOURCE_AUDIT_TYPE = 'Pentest';
create or replace view V_CRMP_TOTALHVASYSTEMS(
	COMPONENT_ACRONYM,
	TOTALHVASYSTEMS
) COMMENT='component acronyms for HVA systems'
 as
SELECT  s.Component_Acronym
,count(1) as TotalHVASystems
FROM CORE.VW_CRMP_OperationalSystems s
WHERE s.HVAStatus IS NOT NULL and s.HVAStatus = 'Yes'
GROUP BY s.Component_Acronym
ORDER BY s.Component_Acronym;
create or replace view V_CRMP_TOTALSYSTEMS(
	COMPONENT_ACRONYM,
	TOTALSYSTEMS
) COMMENT='component acronyms for active systems'
 as
SELECT s.COMPONENT_ACRONYM as Component_Acronym
,count(1) as TotalSystems
FROM CORE.VW_Systems  s
where s.Is_OperationalSystem = 1
GROUP BY s.COMPONENT_ACRONYM
ORDER BY s.COMPONENT_ACRONYM;
create or replace view V_CVE_SUMMARY_CURVULN(
	"FK_dw_vul_number",
	ID,
	"dateCreated",
	"DataCenterAcronym",
	"SnapshotDate",
	"SystemAcronym",
	"asset_id_tattoo",
	"cve",
	"CVSSv2Base",
	"CVSSv3Base",
	"DaysSinceDiscovery",
	"Description",
	"dnsName",
	"exploitAvailable",
	"familyName",
	"firstSeen",
	"FISMAseverity",
	"ip",
	"lastFound",
	"macAddress",
	"MitigationStatus",
	"netbiosname",
	OS,
	"pluginID",
	"signature",
	"Solution",
	"source_tool",
	"Datacenter_id",
	"FISMA_id",
	"Group Acronym",
	"Group Name",
	"Component Acronym",
	"Component Name",
	"Is_BOD",
	"BODDueDate",
	"datemitigated"
) COMMENT='open and reopened for HVA'
 as
SELECT 
vm.DW_VUL_ID as "FK_dw_vul_number"
,vm.DW_VUL_ID as "ID"
,vm.INSERT_DATE as "dateCreated"
,dc.Acronym as "DataCenterAcronym"
,(select REPORT_DATE from TABLE(CORE.FN_CRM_GET_REPORT_ID(0)))  as "SnapshotDate"
,s.Acronym as "SystemAcronym"
,a.asset_id_tattoo as "asset_id_tattoo"
,vm.cve as "cve"
,vm.CVSSV2BASESCORE as "CVSSv2Base"
,vm.CVSSV3BASESCORE as "CVSSv3Base"
,vm.DaysSinceDiscovery as "DaysSinceDiscovery"
,NULL as "Description"
,a.FQDN as "dnsName"
,vm.exploitAvailable as "exploitAvailable"
,NULL as "familyName"
,vm.firstSeen as "firstSeen"
,vm.FISMAseverity as "FISMAseverity"
,a.IPv4 as "ip"
,vm.lastFound as "lastFound"
,a.macAddress as "macAddress"
,vm.MitigationStatus as "MitigationStatus"
,a.netbiosname as "netbiosname"
,a.OS as "OS"
,plugs.PLUGIN_ID as "pluginID"
,NULL as "signature"
,NULL as "Solution"
,'Tenable' as "source_tool"
,dc.SYSTEM_ID as "Datacenter_id"
,s.SYSTEM_ID as "FISMA_id"
,s.Group_Acronym as "Group Acronym"
,s.Group_Name as "Group Name"
,s.Component_Acronym as "Component Acronym"
,s.Component_Name as "Component Name"
,case coalesce(cast(vm.IS_KEV as varchar),'No')
    when 'No' then 'No'
    Else 'Yes'
End as "Is_BOD"
,vm.BODDueDate as "BODDueDate"
,vm.datemitigated as "datemitigated"
FROM CORE.VW_Assets a
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
where vm.MitigationStatus IN ('open','reopened') and s.HVAStatus = 'Yes'
;
create or replace view V_CVE_SUMMARY_CURVULN1(
	"FK_dw_vul_number",
	ID,
	"dateCreated",
	"DataCenterAcronym",
	"SnapshotDate",
	"SystemAcronym",
	"asset_id_tattoo",
	"cve",
	"CVSSv2Base",
	"CVSSv3Base",
	"DaysSinceDiscovery",
	"Description",
	"dnsName",
	"exploitAvailable",
	"familyName",
	"firstSeen",
	"FISMAseverity",
	"ip",
	"lastFound",
	"macAddress",
	"MitigationStatus",
	"netbiosname",
	OS,
	"pluginID",
	"signature",
	"Solution",
	"source_tool",
	"Datacenter_id",
	"FISMA_id",
	"Group Acronym",
	"Group Name",
	"Component Acronym",
	"Component Name",
	"Is_BOD",
	"BODDueDate",
	"datemitigated"
) COMMENT='open and reopened for HVA'
 as
SELECT
vm.DW_VUL_ID as "FK_dw_vul_number"
,vm.DW_VUL_ID as "ID"
,vm.INSERT_DATE as "dateCreated"
,dc.Acronym as "DataCenterAcronym"
,(select REPORT_DATE from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as "SnapshotDate"
,s.Acronym as "SystemAcronym"
,a.asset_id_tattoo as "asset_id_tattoo"
,vm.cve as "cve"
,vm.CVSSV2BASESCORE as "CVSSv2Base"
,vm.CVSSV3BASESCORE as "CVSSv3Base"
,vm.DaysSinceDiscovery as "DaysSinceDiscovery"
,NULL as "Description"
,a.FQDN as "dnsName"
,vm.exploitAvailable as "exploitAvailable"
,NULL as "familyName"
,vm.firstSeen as "firstSeen"
,vm.FISMAseverity as "FISMAseverity"
,a.IPv4 as "ip"
,vm.lastFound as "lastFound"
,a.macAddress as "macAddress"
,vm.MitigationStatus as "MitigationStatus"
,a.netbiosname as "netbiosname"
,a.OS as "OS"
,plugs.PLUGIN_ID as "pluginID"
,NULL as "signature"
,NULL as "Solution"
,'Tenable' as "source_tool"
,dc.SYSTEM_ID as "Datacenter_id"
,s.SYSTEM_ID as "FISMA_id"
,s.Group_Acronym as "Group Acronym"
,s.Group_Name as "Group Name"
,s.Component_Acronym as "Component Acronym"
,s.Component_Name as "Component Name"
,case coalesce(cast(vm.IS_KEV as varchar),'No')
    when 'No' then 'No'
    Else 'Yes'
End as "Is_BOD"
,vm.BODDueDate as "BODDueDate"
,vm.datemitigated as "datemitigated"
FROM CORE.VW_Assets a
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
where vm.MitigationStatus IN ('open','reopened') and s.HVAStatus = 'Yes'
;
create or replace view V_CVE_SUMMARY_CURVULN2(
	"pluginID",
	"signature",
	"Solution",
	"FK_dw_vul_number",
	"cve",
	"CVSSv2Base",
	"CVSSv3Base",
	"MitigationStatus",
	"SystemAcronym",
	"DaysSinceDiscovery",
	"ip",
	"macAddress",
	"dnsName",
	"netbiosname"
) COMMENT='open and reopened for HVA'
 as 
select
plugs.plugin_ID as "pluginID"
,null as "signature"
,null as "Solution"
,vm.DW_VUL_ID as "FK_dw_vul_number"
,vm.CVE as "cve"
,vm.CVSSV2BASESCORE as "CVSSv2Base"
,vm.CVSSV3BASESCORE as "CVSSv3Base"
,vm.MITIGATIONSTATUS as "MitigationStatus"
,s.ACRONYM as "SystemAcronym"
,vm.DAYSSINCEDISCOVERY as "DaysSinceDiscovery"
,a.IPV4 as "ip"
,a.MACADDRESS as "macAddress"
,a.FQDN as "dnsName"
,a.NETBIOSNAME as "netbiosname"
from CORE.VW_ASSETS a
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
where upper(s.TLC_PHASE) = 'OPERATE' AND HVAStatus='Yes' AND MitigationStatus IN ('open','reopened') 
;
create or replace view V_CYBERRISK_DATACENTER_SUMMARY(
	"DataCenterAcronym",
	"CommonName",
	"TotalSystems",
	"TotalAdjSystems",
	"TotalAssets",
	"TotalAdjAssets",
	"TotalCritical+High",
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulMedium",
	"VulLow",
	"datacenter_id",
	"VulCritical_gte15days"
) COMMENT='Contains Summarized data for various data categories at Data Center level'
 as
select 
dc.acronym as "DataCenterAcronym"
,dc.CommonName as "CommonName"
,dcs.Systems as "TotalSystems"
,dcs.Systems as "TotalAdjSystems"
,dcs.Assets as "TotalAssets"
,dcs.Assets as "TotalAdjAssets"
,(dcs.VulCritical + dcs.VulHigh) as "TotalCritical+High"
,dcs.VulCritical as "Critical Vulnerabilities"
,dcs.VulCritical_lte15days as "Critical: <= 15 days"
,dcs.VulUniqueCritical_gt15_lte60days as "Unique Critical: > 15 <= 60 days"
,dcs.VulCritical_lte30days as "Critical: <= 30 days"
,dcs.VulUniqueCritical_gt30_lte60days as "Unique Critical: > 30 <= 60 days"
,dcs.VulCritical_gt30_lte60days as "Critical: > 30 <= 60 days"
,dcs.VulUniqueCritical_gt60days as "Unique Critical: > 60 days"
,dcs.VulCritical_gt60days as "Critical: > 60 days"
,dcs.VulHigh as "High Vulnerabilities"
,dcs.VulHigh_lte30days as "High: <= 30 days"
,dcs.VulUniqueHigh_gt30_lte60days as "Unique High: > 30 <= 60 days"
,dcs.VulHigh_gt30_lte60days as "High: > 30 <= 60 days"
,dcs.VulUniqueHigh_gt60days as "Unique High: > 60 days"
,dcs.VulHigh_gt60days as "High: > 60 days"
,dcs.VulMedium as "VulMedium"
,dcs.VulLow as "VulLow"
,dc.SYSTEM_ID as "datacenter_id"
,dcs.VULCRITICAL_GTE15DAYS as "VulCritical_gte15days" -- 230829
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
JOIN CORE.DataCenterSummary dcs on dcs.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = dcs.DATACENTER_ID
ORDER BY dc.CommonName
;
create or replace view V_CYBERRISK_HWAM_DETAIL(
	DATECREATED,
	ASSET_ID_TATTOO,
	DATACENTER_ID,
	DATACENTERACRONYM,
	DATACENTER_AUTHORIZATION_PACKAGE,
	PRIMARY_FISMA_ID,
	PRIMARY_FISMA_ID_ACRONYM,
	PRIMARY_FISMA_ID_AUTHORIZATION_PACKAGE,
	COMPUTER_TYPE,
	DEVICEROLE,
	DEVICETYPE,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	MOTHERBOARD_SN,
	NETBIOS_HN,
	OS,
	OS_CPE,
	BIOS_GUID,
	SOURCE_TOOL,
	LAST_CONFIRMED_TIME,
	IPV4,
	IPV6,
	MAC,
	FK_DATACENTER_ID,
	DATACENTER_COMMONNAME,
	FK_PRIMARY_FISMA_ID,
	PRIMARY_FISMA_ID_COMMONNAME,
	TLC_PHASE
) COMMENT='Used in other views to get the Asset details.'
 as
SELECT
a.INSERT_DATE as dateCreated -- datecreated as dateCreated
,a.asset_id_tattoo
,a.datacenter_id
,dc.Acronym as DataCenterAcronym
,dHist.Authorization_Package as datacenter_Authorization_Package
,s.SYSTEM_ID as primary_fisma_id
,s.ACRONYM as primary_fisma_id_Acronym
,dHist.Authorization_Package as primary_fisma_id_Authorization_Package
,a.computer_type as Computer_Type
,a.DeviceRole as DeviceRole
,a.DeviceType
,a.environment as Environment
,a.FQDN
,a.HostName
,a.Motherboard as Motherboard_SN
,a.netbiosname as NetBios_hn
,a.OS as OS
,a.OS_CPE
,a.bios_guid as bios_guid
,NULL as Source_Tool -- a.source_tool as Source_Tool
,a.last_confirmed_time
,a.IPv4 as IPv4
,a.IPv6 as IPv6
,a.Macaddress as Mac
,dc.SYSTEM_ID as FK_datacenter_id 
,dc.CommonName as datacenter_CommonName 
,dc.SYSTEM_ID as FK_primary_fisma_id 
,dc.CommonName as primary_fisma_id_CommonName
,dHist.TLC_Phase
FROM CORE.VW_ASSETS a
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
-- 	(select SYSTEM_ID FROM CORE.VW_SYSTEMS where SYSTEM_ID =
-- 	CASE a.SYSTEM_ID
-- 		when '0000000-NotValid-0000000' then a.datacenter_id
--		Else a.SYSTEM_ID
-- 	END
-- 	)
JOIN CORE.SystemsHist dHist on dHist.System_ID = dc.SYSTEM_ID and dHist.REPORT_ID = (SELECT TOP 1 REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) 
JOIN CORE.SystemsHist sHist on sHist.System_ID = s.SYSTEM_ID and sHist.REPORT_ID = dHist.REPORT_ID
;
create or replace view V_CYBERRISK_MONTH_TREND(
	"ReportDate",
	"Is_endOfMonth",
	"OperationalSystems",
	"TotalSystems",
	"TotalAdjSystems",
	"Assets",
	"AdjAssets",
	"TotalCritical+High",
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulCritical_gte15days",
	"VulRaw",
	"VulRaw_Critical",
	"VulRaw_High",
	"VulRaw_Low",
	"VulRaw_Medium",
	"VulUniqueCritical_gte15days",
	"HWAMRawAWS",
	"HWAMRawBigFix",
	"HWAMRawForeScout"
) COMMENT='Used in other views to get trending data for Vuln data category'
 as
select 
cast(r.REPORT_DATE as date) as "ReportDate"
,r.Is_endOfMonth as "Is_endOfMonth"
,dcs."OperationalSystems"
,dcs."TotalSystems"
,dcs."TotalAdjSystems"
,dcs."Assets"
,dcs."AdjAssets"
,dcs."TotalCritical+High"
,dcs."Critical Vulnerabilities"
,dcs."Critical: <= 15 days"
,dcs."Unique Critical: > 15 <= 60 days"
,dcs."Critical: <= 30 days"
,dcs."Unique Critical: > 30 <= 60 days"
,dcs."Critical: > 30 <= 60 days"
,dcs."Unique Critical: > 60 days"
,dcs."Critical: > 60 days"
,dcs."High Vulnerabilities"
,dcs."High: <= 30 days"
,dcs."Unique High: > 30 <= 60 days"
,dcs."High: > 30 <= 60 days"
,dcs."Unique High: > 60 days"
,dcs."High: > 60 days"
,dcs."VulCritical_gte15days"
,dcs."VulRaw"
,dcs."VulRaw_Critical"
,dcs."VulRaw_High"
,dcs."VulRaw_Low"
,dcs."VulRaw_Medium"
,dcs."VulUniqueCritical_gte15days"
,dcs."HWAMRawAWS"
,dcs."HWAMRawBigFix"
,dcs."HWAMRawForeScout"
FROM CORE.REPORT_IDS r
JOIN (SELECT REPORT_ID
    ,SUM(OperationalSystems) as "OperationalSystems"
	,SUM(Systems) as "TotalSystems"
	,SUM(Systems) as "TotalAdjSystems"
	,SUM(Assets) as "Assets"
	,SUM(Assets) as "AdjAssets"
	,SUM((VulCritical + VulHigh)) as "TotalCritical+High"
	,SUM(VulCritical) as "Critical Vulnerabilities"
	,SUM(VulCritical_lte15days) as "Critical: <= 15 days"
	,SUM(VulUniqueCritical_gt15_lte60days) as "Unique Critical: > 15 <= 60 days"
	,SUM(VulCritical_lte30days) as "Critical: <= 30 days"
	,SUM(VulUniqueCritical_gt30_lte60days) as "Unique Critical: > 30 <= 60 days"
	,SUM(VulCritical_gt30_lte60days) as "Critical: > 30 <= 60 days"
	,SUM(VulUniqueCritical_gt60days) as "Unique Critical: > 60 days"
	,SUM(VulCritical_gt60days) as "Critical: > 60 days"
	,SUM(VulHigh) as "High Vulnerabilities"
	,SUM(VulHigh_lte30days) as "High: <= 30 days"
	,SUM(VulUniqueHigh_gt30_lte60days) as "Unique High: > 30 <= 60 days"
	,SUM(VulHigh_gt30_lte60days) as "High: > 30 <= 60 days"
	,SUM(VulUniqueHigh_gt60days) as "Unique High: > 60 days"
	,SUM(VulHigh_gt60days) as "High: > 60 days"
	,SUM(VulCritical_gte15days) as "VulCritical_gte15days"
	,SUM(VulRaw) as "VulRaw"
	,SUM(VulRaw_Critical) as "VulRaw_Critical"
	,SUM(VulRaw_High) as "VulRaw_High"
	,SUM(VulRaw_Low) as "VulRaw_Low"
	,SUM(VulRaw_Medium) as "VulRaw_Medium"
	,SUM(VulUniqueCritical_gte15days) as "VulUniqueCritical_gte15days"
	,SUM(HWAMRawAWS) as "HWAMRawAWS"
	,SUM(HWAMRawBigFix) as "HWAMRawBigFix"
	,SUM(HWAMRawForeScout) as "HWAMRawForeScout"
	FROM CORE.DATACENTERSUMMARY
    GROUP BY REPORT_ID) dcs on dcs.REPORT_ID = r.REPORT_ID
ORDER BY cast(r.REPORT_DATE as date) desc
;
create or replace view V_CYBERRISK_SYSTEM_DEVICES(
	GROUP_ACRONYM,
	COMPONENT_ACRONYM,
	"System",
	ACRONYM,
	TLC_PHASE,
	DEVICETYPE,
	TOTALASSETS,
	DATACENTER_ID,
	PRIMARY_FISMA_ID
) COMMENT='Used in other views to get the Asset details'
 as
select 
s.Group_Acronym 
,s.Component_Acronym 
,s.Acronym as "System"
,dc.Acronym
,s.TLC_Phase
,dt.DeviceType
,coalesce(sa.TotalAssets,0) as TotalAssets
,dc.SYSTEM_ID as datacenter_id
,s.SYSTEM_ID as primary_fisma_id
FROM (select a.DATACENTER_ID,a.SYSTEM_ID,a.DEVICETYPE,COUNT(1) TotalAssets
	FROM CORE.VW_Assets a
	GROUP BY a.DATACENTER_ID,a.SYSTEM_ID,a.DEVICETYPE) sa 
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = sa.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = sa.SYSTEM_ID
JOIN CORE.DEVICETYPES dt on dt.DEVICETYPE = sa.DEVICETYPE
order by dc.Acronym
,s.Acronym 
,dt.DeviceType
;
create or replace view V_CYBERRISK_SYSTEM_SUMMARY(
	"Group_Acronym",
	"Component_Acronym",
	"System",
	"DataCenterAcronym",
	"CommonName",
	"System_DateCreated",
	"TLC_Phase",
	"PriorCRR_Assets",
	"Total Assets",
	"Delta_Assets",
	"TotalAdjAssets",
	"Total Vulnerabilites",
	"PriorCRR_VulCritical",
	"Critical Vulnerabilities",
	"Delta_VulCritical",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"PriorCRR_VulHigh",
	"High Vulnerabilities",
	"Delta_VulHigh",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulMedium",
	"VulUniqueMedium",
	"VulLow",
	"VulUniqueLow",
	"KEV_Open",
	"KEV_Reopened",
	"KEV_Fixed_MonthToDate",
	"datacenter_id",
	"primary_fisma_id",
	"FK_DataCenter_ID",
	"FK_primary_fisma_id",
	"Primary_Operating_Location",
	"VulCritical_gte15days"
) COMMENT='Contains Summarized data for various data categories at FISMA SYSTEM level'
 as
select 
s.Group_Acronym as "Group_Acronym"
,s.Component_Acronym as "Component_Acronym"
,s.Acronym as "System"
,dc.Acronym as "DataCenterAcronym"
,s.CommonName as "CommonName"
,s.INSERT_DATE::VARCHAR as "System_DateCreated"
,sHist.TLC_Phase as "TLC_Phase"
,coalesce(PriorSS.Assets,0) as "PriorCRR_Assets"
,ss.Assets as "Total Assets"
,(ss.Assets - coalesce(PriorSS.Assets,0)) as "Delta_Assets"
,ss.Assets as "TotalAdjAssets"
,(ss.VulCritical + ss.VulHigh) as "Total Vulnerabilites"
,coalesce(PriorSS.VulCritical,0) as "PriorCRR_VulCritical"
,ss.VulCritical as "Critical Vulnerabilities"
,(ss.VulCritical - coalesce(PriorSS.VulCritical,0)) as "Delta_VulCritical"
,ss.VulCritical_lte15days as "Critical: <= 15 days"
,ss.VulUniqueCritical_gt15_lte60days as "Unique Critical: > 15 <= 60 days"
,ss.VulCritical_gt15_lte60days as "Critical: > 15 <= 60 days"
,ss.VulCritical_lte30days as "Critical: <= 30 days"
,ss.VulUniqueCritical_gt30_lte60days as "Unique Critical: > 30 <= 60 days"
,ss.VulCritical_gt30_lte60days as "Critical: > 30 <= 60 days"
,ss.VulUniqueCritical_gt60days as "Unique Critical: > 60 days"
,ss.VulCritical_gt60days as "Critical: > 60 days"
,coalesce(PriorSS.VulHigh,0) as "PriorCRR_VulHigh"
,ss.VulHigh as "High Vulnerabilities"
,(ss.VulHigh - coalesce(PriorSS.VulHigh,0)) as "Delta_VulHigh"
,ss.VulHigh_lte30days as "High: <= 30 days"
,ss.VulUniqueHigh_gt30_lte60days as "Unique High: > 30 <= 60 days"
,ss.VulHigh_gt30_lte60days as "High: > 30 <= 60 days"
,ss.VulUniqueHigh_gt60days as "Unique High: > 60 days"
,ss.VulHigh_gt60days as "High: > 60 days"
,ss.VulMedium as "VulMedium"
,ss.VulUniqueMedium as "VulUniqueMedium"
,ss.VulLow as "VulLow"
,ss.VulUniqueLow as "VulUniqueLow"
,ss.KEV_Open as "KEV_Open"
,ss.KEV_Reopened as "KEV_Reopened"
,ss.KEV_Fixed_MonthToDate as "KEV_Fixed_MonthToDate"
,dc.SYSTEM_ID as "datacenter_id"
,s.SYSTEM_ID as "primary_fisma_id"
,dc.SYSTEM_ID as "FK_DataCenter_ID"
,s.SYSTEM_ID as "FK_primary_fisma_id"
,s.Primary_Operating_Location as "Primary_Operating_Location"
,ss.VULCRITICAL_GTE15DAYS as "VulCritical_gte15days" -- 230829
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
JOIN CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = ss.SYSTEM_ID
JOIN CORE.SystemsHist sHist on sHist.REPORT_ID = r.REPORT_ID and sHist.SYSTEM_ID = s.SYSTEM_ID
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
LEFT OUTER JOIN CORE.VW_SYSTEMSUMMARY PriorSS on PriorSS.SYSTEM_ID = s.SYSTEM_ID and PriorSS.REPORT_ID = (select MAX(REPORT_ID) PriorCRR from CORE.REPORT_IDS where IS_ENDOFMONTH = 1 and REPORT_ID < (select REPORT_ID from TABLE(CORE.FN_CRM_GET_REPORT_ID(1))))
LEFT OUTER JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID 
WHERE (ss.Assets > 0 or s.TLC_Phase <> 'Retire') 
ORDER BY s.Acronym
;
create or replace view V_CYBERRISK_UNAUTHORIZED_ASSETS(
	"DataCenter_Acronym",
	"datacenter_id",
	"System_Acronym",
	"primary_fisma_id",
	"TLC_Phase",
	"Primary_Operating_Location",
	ISSO,
	CRA,
	"dw_asset_id",
	"asset_id_tattoo",
	"bigfix_asset_id",
	"computer_type",
	"datecreated",
	"dateModified",
	"DeviceRole",
	"DeviceType",
	"environment",
	"fqdn",
	"hostname",
	"last_confirmed_time",
	"motherboard_sn",
	"netbiosname",
	"os",
	"os_cpe",
	"os_version",
	"IPv4",
	"IPv6",
	"Mac",
	"TenableUUID",
	"source_tool",
	"source_tool_create"
) COMMENT='Assets that are being reported and belong to retired systems'
 as
select 
cd.Acronym as "DataCenter_Acronym"
,cd.SYSTEM_ID as "datacenter_id"
,cf.Acronym as "System_Acronym"
,cf.SYSTEM_ID as "primary_fisma_id"
,cf.TLC_Phase as "TLC_Phase"
,cf.Primary_Operating_Location as "Primary_Operating_Location"
,cf.ISSO as "ISSO"
,cf.CRA as "CRA"
,a.DW_ASSET_ID as "dw_asset_id"
,a.asset_id_tattoo as "asset_id_tattoo"
,a.bigfix_asset_id as "bigfix_asset_id"
,a.computer_type as "computer_type"
,a.INSERT_DATE as "datecreated"
,a.dateModified as "dateModified"
,a.DeviceRole as "DeviceRole"
,a.DeviceType as "DeviceType"
,a.environment as "environment"
,a.fqdn as "fqdn"
,a.hostname as "hostname"
,a.last_confirmed_time as "last_confirmed_time"
,a.motherboard as "motherboard_sn"
,a.netbiosname as "netbiosname"
,a.os as "os"
,a.os_cpe as "os_cpe"
,a.os_version as "os_version"
,a.IPv4 as "IPv4"
,a.IPv6 as "IPv6"
,a.Macaddress as "Mac"
,a.TenableUUID as "TenableUUID"
,a.source_tool_lastseen as "source_tool"
,a.source_tool_create as "source_tool_create"
FROM CORE.VW_Assets a
JOIN CORE.VW_Systems cd on cd.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems cf on cf.SYSTEM_ID = a.SYSTEM_ID
Where (cd.TLC_Phase = 'Retire' or cf.TLC_Phase = 'Retire') 
order by cd.Acronym
,cf.Acronym
,a.DW_ASSET_ID;
create or replace view V_CYBERRISK_VUL_DETAIL(
	ID,
	DATECREATED,
	DATACENTERACRONYM,
	SNAPSHOTDATE,
	SYSTEMACRONYM,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	IP,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGINID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	DATACENTER_ID,
	FISMA_ID,
	"Group Acronym",
	"Group Name",
	"Component Acronym",
	"Component Name",
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED
) COMMENT='Used to test data for Month end Cyber risk data'
 as
SELECT 
v.ID
,r.REPORT_DATE as dateCreated
,dc.Acronym as DataCenterAcronym
,r.REPORT_DATE as SnapshotDate
,s.Acronym as SystemAcronym
,ah.asset_id_tattoo
,vm.cve
,v.CVSSV2BASESCORE as CVSSV2BASE 
,v.CVSSV3BASESCORE as CVSSV3Base
,v.DaysSinceDiscovery
,NULL as Description
,ah.FQDN as dnsName
,v.exploitAvailable
,NULL as familyName
,vm.firstSeen
,v.FISMAseverity
,ah.IPv4 as ip
,v.lastFound
,ah.MacAddress
,v.MitigationStatus
,ah.netbiosname
,ah.OS
,plugs.PLUGIN_ID as pluginID
,NULL as signature
,NULL as Solution
,ah.SOURCE_TOOL_LASTSEEN as source_tool -- column not found in CYBER_RISK_MANAGEMENT
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.GROUP_ACRONYM as "Group Acronym" 
,s.GROUP_NAME as "Group Name" 
,s.COMPONENT_ACRONYM as "Component Acronym" 
,s.COMPONENT_NAME as "Component Name"
,vm.IS_KEV as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated 
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_VULMASTER vm on vm.DW_VUL_ID = v.dw_vul_id
JOIN CORE.VW_ASSETHIST ah on ah.Report_ID = r.REPORT_ID and ah.DW_ASSET_ID = vm.DW_Asset_ID
--230602 CMR; LEFT OUTER JOIN CORE.ASSETINTERFACECOALESCEDHIST aic on aic.REPORT_ID = r.REPORT_ID and aic.DW_ASSET_ID = v.DW_Asset_ID
JOIN CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.datacenter_id
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID

LEFT OUTER JOIN (select DW_VUL_ID, listagg(DISTINCT PLUGIN_ID, ', ') WITHIN GROUP (ORDER BY PLUGIN_ID DESC) as PLUGIN_ID FROM CORE.VULPLUGIN GROUP BY DW_VUL_ID) plugs on plugs.dw_vul_id = v.dw_vul_id -- 230829 2100
-- 230829 2100 LEFT OUTER JOIN CORE.VULPLUGIN plugs on plugs.dw_vul_id = v.dw_vul_id

where v.MitigationStatus IN ('open','reopened');
create or replace view V_DAILY_CRR_DATACENTER_SUMMARY(
	"DataCenterAcronym",
	"CommonName",
	"TotalSystems",
	"TotalAdjSystems",
	"TotalAssets",
	"TotalAdjAssets",
	"TotalCritical+High",
	"Critical Vulnerabilities",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"High Vulnerabilities",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"datacenter_id"
) COMMENT='Daily wise Summarized Cyber risk data by data center '
 as
select  
dc.acronym as "DataCenterAcronym"
,dc.CommonName as "CommonName"
,dcs.Systems as "TotalSystems"
,dcs.Systems as "TotalAdjSystems"
,dcs.Assets as "TotalAssets"
,dcs.Assets as "TotalAdjAssets"
,(dcs.VulCritical + dcs.VulHigh) as "TotalCritical+High"
,dcs.VulCritical  as "Critical Vulnerabilities"
,dcs.VulCritical_lte15days  as "Critical: <= 15 days"
,dcs.VulUniqueCritical_gt15_lte60days as "Unique Critical: > 15 <= 60 days"
,dcs.VulCritical_lte30days  as "Critical: <= 30 days"
,dcs.VulUniqueCritical_gt30_lte60days  as "Unique Critical: > 30 <= 60 days"
,dcs.VulCritical_gt30_lte60days  as "Critical: > 30 <= 60 days"
,dcs.VulUniqueCritical_gt60days  as "Unique Critical: > 60 days"
,dcs.VulCritical_gt60days  as "Critical: > 60 days"
,dcs.VulHigh  as "High Vulnerabilities"
,dcs.VulHigh_lte30days  as "High: <= 30 days"
,dcs.VulUniqueHigh_gt30_lte60days  as "Unique High: > 30 <= 60 days"
,dcs.VulHigh_gt30_lte60days  as "High: > 30 <= 60 days"
,dcs.VulUniqueHigh_gt60days  as "Unique High: > 60 days"
,dcs.VulHigh_gt60days  as "High: > 60 days"
,dc.SYSTEM_ID as "datacenter_id"
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.DataCenterSummary dcs on dcs.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = dcs.DATACENTER_ID
ORDER BY dc.CommonName;
create or replace view V_DAILY_CRR_SYSTEM_SUMMARY(
	"Group_Acronym",
	"Component_Acronym",
	"System",
	"DataCenterAcronym",
	"CommonName",
	"System_DateCreated",
	"TLC_Phase",
	"PriorCRR_Assets",
	"Total Assets",
	"Delta_Assets",
	"TotalAdjAssets",
	"Total Vulnerabilites",
	"PriorCRR_VulCritical",
	"Critical Vulnerabilities",
	"Delta_VulCritical",
	"Critical: <= 15 days",
	"Unique Critical: > 15 <= 60 days",
	"Critical: <= 30 days",
	"Unique Critical: > 30 <= 60 days",
	"Critical: > 30 <= 60 days",
	"Unique Critical: > 60 days",
	"Critical: > 60 days",
	"PriorCRR_VulHigh",
	"High Vulnerabilities",
	"Delta_VulHigh",
	"High: <= 30 days",
	"Unique High: > 30 <= 60 days",
	"High: > 30 <= 60 days",
	"Unique High: > 60 days",
	"High: > 60 days",
	"VulMedium",
	"VulLow",
	"datacenter_id",
	"primary_fisma_id",
	"FK_DataCenter_ID",
	"FK_primary_fisma_id",
	"Primary_Operating_Location",
	"KEV_Open",
	"KEV_Reopened",
	"KEV_Fixed_MonthToDate"
) COMMENT='Daily wise Summarized Cyber risk data by FISMA SYSTEM '
 as
select
s.Group_Acronym as "Group_Acronym"
,s.Component_Acronym as "Component_Acronym"
,s.Acronym as "System"
,dc.Acronym as "DataCenterAcronym"
,s.CommonName as "CommonName"
,s.INSERT_DATE::Date as "System_DateCreated"
,s.TLC_Phase as "TLC_Phase"
,coalesce(PriorSS.Assets,0) as "PriorCRR_Assets"
,ss.Assets as "Total Assets"
,(ss.Assets - coalesce(PriorSS.Assets,0)) as "Delta_Assets"
,ss.Assets as "TotalAdjAssets"
,(ss.VulCritical + ss.VulHigh) as "Total Vulnerabilites"
,coalesce(PriorSS.VulCritical,0) as "PriorCRR_VulCritical"
,ss.VulCritical as "Critical Vulnerabilities"
,(ss.VulCritical - coalesce(PriorSS.VulCritical,0)) as "Delta_VulCritical"
,ss.VulCritical_lte15days as "Critical: <= 15 days"
,ss.VulUniqueCritical_gt15_lte60days as "Unique Critical: > 15 <= 60 days"
,ss.VulCritical_lte30days as "Critical: <= 30 days"
,ss.VulUniqueCritical_gt30_lte60days as "Unique Critical: > 30 <= 60 days"
,ss.VulCritical_gt30_lte60days as "Critical: > 30 <= 60 days"
,ss.VulUniqueCritical_gt60days as "Unique Critical: > 60 days"
,ss.VulCritical_gt60days as "Critical: > 60 days"
,coalesce(PriorSS.VulHigh,0) as "PriorCRR_VulHigh"
,ss.VulHigh as "High Vulnerabilities"
,(ss.VulHigh - coalesce(PriorSS.VulHigh,0)) as "Delta_VulHigh"
,ss.VulHigh_lte30days as "High: <= 30 days"
,ss.VulUniqueHigh_gt30_lte60days as "Unique High: > 30 <= 60 days"
,ss.VulHigh_gt30_lte60days as "High: > 30 <= 60 days"
,ss.VulUniqueHigh_gt60days as "Unique High: > 60 days"
,ss.VulHigh_gt60days as "High: > 60 days"
,ss.VulMedium as "VulMedium"
,ss.VulLow as "VulLow"
,dc.SYSTEM_ID as "datacenter_id"
,s.SYSTEM_ID as "primary_fisma_id"
,dc.SYSTEM_ID as "FK_DataCenter_ID"
,s.SYSTEM_ID as "FK_primary_fisma_id"
,s.Primary_Operating_Location as "Primary_Operating_Location"
,ss.KEV_Open as "KEV_Open"
,ss.KEV_Reopened as "KEV_Reopened"
,ss.KEV_Fixed_MonthToDate as "KEV_Fixed_MonthToDate"
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
JOIN CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = ss.SYSTEM_ID
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
LEFT OUTER JOIN CORE.VW_SYSTEMSUMMARY PriorSS on PriorSS.SYSTEM_ID = s.SYSTEM_ID and PriorSS.REPORT_ID = (select MAX(REPORT_ID) PriorCRR from CORE.REPORT_IDS where REPORT_ID < (select REPORT_ID from TABLE(CORE.FN_CRM_GET_REPORT_ID(0))))
LEFT OUTER JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
WHERE (ss.Assets > 0 or s.TLC_Phase <> 'Retire')
ORDER BY s.Acronym
;
create or replace view V_DCRR_DASHBOARD(
	ACRONYM,
	COMPONENT_ACRONYM,
	HVASTATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	UNIQ_CRIT_15_60,
	TOT_CRIT_15_60,
	UNIQ_CRIT_60,
	TOT_CRIT_60,
	UNIQ_IGH_15_60,
	TOT_HIGH_15_60,
	UNIQ_HIGH_60,
	TOT_HIGH_60,
	HWAM_COUNT,
	CONTINGENCYEXPIRATIONDATE,
	DATE_AUTH_MEMO_EXPIRES,
	GROUP_ACRONYM,
	TLC_PHASE,
	OVER_DUE,
	PENTEST_COUNT,
	ASSETRISKTOLERANCE,
	RESIDUALRISK,
	VULNRISKTOLERANCE,
	RESILIENCYSCORE,
	OA_STATUS,
	TOT_CRIT_VULNS,
	TOT_HIGH_VULNS,
	REM_CNT,
	OPN_CNT,
	REFRESHDATE
) COMMENT='DCRR dashboard data'
 as
SELECT s.acronym,s.component_acronym,s.HVAStatus,s.MEFStatus,s.Is_MarketPlace,
  ss."Unique Critical: > 15 <= 60 days" as uniq_crit_15_60,
  ss."Critical: > 15 <= 60 days" as tot_crit_15_60,
  ss."Unique Critical: > 60 days" as uniq_crit_60,
  ss."Critical: > 60 days" as tot_crit_60,
  ss."Unique High: > 30 <= 60 days" as uniq_igh_15_60,
  ss."High: > 30 <= 60 days" as tot_high_15_60,
  ss."Unique High: > 60 days" as uniq_high_60,
  ss."High: > 60 days" as tot_high_60,
  0 as HWAM_COUNT,  --ss.Total_Assets as HWAM_COUNT,
  s.Next_Required_CP_Test_Date ContingencyExpirationDate,
  s.Date_Auth_Memo_Expires,
  s.Group_Acronym,
  ss."TLC_Phase",
  COALESCE(od.Over_due, 0) as Over_due,
  COALESCE(pentest_count, 0) pentest_count,
  summ.AssetRiskTolerance,
  summ.ResidualRisk,
  summ.VulnRiskTolerance,
  summ.resiliencyscore,
  s.OA_Status,
  ss."Critical Vulnerabilities" as tot_crit_vulns,
  ss."High Vulnerabilities" as tot_high_vulns,
  coalesce(summ.KEV_Open,0)+coalesce(summ.KEV_Reopened,0) as rem_cnt,
  summ.KEV_Fixed_MonthToDate as Opn_cnt,
current_date() as refreshdate
  
FROM rpt.V_CyberRisk_System_Summary ss 
left outer join CORE.VW_SYSTEMS s on s.SYSTEM_ID = ss."primary_fisma_id"
  
left outer join (select SYSTEM_ID,ResidualRisk,VulnRiskTolerance,AssetRiskTolerance,resiliencyscore, KEV_Open, KEV_Reopened, KEV_Fixed_MonthToDate 
    from CORE.VW_SYSTEMSUMMARY
    where REPORT_ID in (select REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)))) summ on summ.SYSTEM_ID = ss."primary_fisma_id"
      
left outer join (select SYSTEM_ID, count(*) as pentest_count 
    from rpt.V_CRMP_Pentest where "Weakness_Risk_Level" = 'High' and "Overall_Status" in ('Delayed','Ongoing','Draft') -- 230928 quoted "Weakness_Risk_Level" and "Overall_Status"
  group by SYSTEM_ID) pentest on pentest.SYSTEM_ID = ss."primary_fisma_id"

left outer join (select p."CFACTS_UID" as SYSTEM_ID, Count(p."POA&M ID") Over_due -- 230928 replaced SYSTEM_ID with "CFACTS_UID" and POAM_ID with "POA&M ID"
    from rpt.V_POAMS_MonthEndSnapshot p
    join CORE.VW_SYSTEMS s on s.SYSTEM_ID = p."CFACTS_UID"
    WHERE p."Overall_Status" in ('Delayed') -- 230928 quoted "Overall_Status"
        AND p."Estimated_Completion_Date" <= (select REPORT_DATE FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1))) -- 230928 quoted "Estimated_Completion_Date"
        AND p."Weakness_Risk_Level" = 'High' AND s.HVAStatus='Yes' AND s.TLC_Phase<>'Retire' -- 230928 quoted "Weakness_Risk_Level"
    GROUP BY p."CFACTS_UID") od on od.SYSTEM_ID = ss."primary_fisma_id"
;
create or replace view V_DIMENSIONAL_LOOKUP(
	ID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY
) COMMENT='FISMA System related hierarchy look up details'
 as
SELECT distinct 
s.SYSTEM_ID as ID, 
s.acronym, 
substring(s.Acronym, 1, 1) || '***' as Acr_Alias,
s.Component_Acronym, 
s.Group_Acronym, 
TLC_Phase, 
HVAStatus, 
Is_MarketPlace, 
MEFStatus,
OATO_Category
FROM CORE.VW_SYSTEMS s 
Where s.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
create or replace view V_DIMENSIONAL_LOOKUP1(
	ID,
	DCID,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	TLC_PHASE,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	DATACENTER_ACRONYM
) COMMENT='FISMA System related hierarchy look up details'
 as
SELECT distinct 
s.SYSTEM_ID as ID, 
dc.SYSTEM_ID as DCID, 
s.acronym, 
s.Component_Acronym, 
s.Group_Acronym, 
s.TLC_Phase, 
s.HVAStatus, 
s.Is_MarketPlace, 
s.MEFStatus,
s.OATO_Category,
IFNULL(dc.Acronym, s.primary_operating_location_acronym) as datacenter_acronym
FROM CORE.VW_Systems s  
left outer JOIN CORE.VW_assets a on a.SYSTEM_ID = s.SYSTEM_ID 
left outer JOIN CORE.VW_Systems DC on DC.SYSTEM_ID = a.datacenter_id
Where s.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
create or replace view "V_ISPG-DIR_ALLOCATED CONTROLS"(
	CONTROL_NUMBER,
	CONTROL_NAME
) COMMENT='Allocated Controls related data'
 as
SELECT DISTINCT
 accs.Control_Number
,accs.Control_Name
FROM CORE.VW_ALLOCATEDCONTROL accs;
create or replace view "V_ISPG-DIR_AUTH_PACKAGES"(
	"Information System or Program Name",
	ACRONYM,
	"Component Acronym",
	"FIPS 199 Overall Impact Rating",
	"Authorization Decision",
	"Is this system on the HVA list for the current year?"
) COMMENT='ISPG-DIR AUTH PACKAGES'
 as
SELECT 	
ap.Authorization_Package_Name as "Information System or Program Name"
,ap.Acronym as Acronym
,ap.Component_Acronym as "Component Acronym"
,enum_FIPS_Overall.Value as "FIPS 199 Overall Impact Rating"
,eAD.Value as "Authorization Decision"
,eHVATrackingList.Value as "Is this system on the HVA list for the current year?"
FROM APP_CFACTS.SHARED.SEC_VW_Authorization_Package ap

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Recommended_Security_Category ap_FIPS_Overall on ap_FIPS_Overall.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Security_Category enum_FIPS_Overall on enum_FIPS_Overall.ID = ap_FIPS_Overall.Value

-- 230526 VW_Authorization_Package_Helper_FIPS_199_Overall_Impact_Rating_ IS NOT AVAILABLE
--LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Helper_FIPS_199_Overall_Impact_Rating_ aOverall on aOverall.ParentContentId = ap.ContentId
--LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Helper_FIPS_199_Overall_Impact_Rating_ eOverall on eOverall.ID = aOverall.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Is_this_system_on_the_HVA_tracking_list aHVATrackingList on aHVATrackingList.ParentContentId = ap.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_GVL_YesNo eHVATrackingList on eHVATrackingList.ID = aHVATrackingList.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package_Authorization_Decision AD on ap.ContentId=AD.ParentContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Authorization_Decision eAD on AD.Value=eAd.Id;
create or replace view "V_ISPG-DIR_POAM"(
	"Authorization Package",
	POAM_ID,
	"Overall Status",
	"Weakness Risk Level",
	POAM_CLOSED_DATE,
	"Allocated Control",
	DAYS_OPEN
) COMMENT='POAMs related data '
 as
SELECT 
 a.Authorization_Package_Name as "Authorization Package"
,p.POAM_ID
,eOverallStatus.Value as "Overall Status" 
,eRiskLevel.Value as "Weakness Risk Level"
,P.POAM_Closed_Date
,Alloc.Control_Number as "Allocated Control"
,P.Days_Open
FROM APP_CFACTS.SHARED.SEC_VW_POAMS p 
INNER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Authorization_Package_x_Authorization_Package_POAMs pa  ON p.ContentId=pa.POAMs_Authorization_Package_ContentId
INNER JOIN APP_CFACTS.SHARED.SEC_VW_Authorization_Package a  ON a.ContentId=pa.Authorization_Package_POAMs_ContentId

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Overall_Status pOverallStatus  on pOverallStatus.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Status_9 eOverallStatus  on eOverallStatus.Id =  pOverallStatus.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1 pRiskLevel  on pRiskLevel.ParentContentId = p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1 eRiskLevel  on eRiskLevel.ID = pRiskLevel.Value

LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards_POAM_x_POAMs_Allocated_Control pAlloc  on pAlloc.POAMs_Allocated_Control_ContentId= p.ContentId
LEFT OUTER JOIN APP_CFACTS.SHARED.SEC_VW_Allocated_Controls_Control_Standards Alloc  on Alloc.ContentId = pAlloc.Allocated_Controls_POAM_ContentId;
create or replace view "V_ISPG-DIR_RBD"(
	"Risk Acceptance ID",
	"Information System or Program Name",
	"Submit Date",
	"Weakness Risk Level",
	"POA&Ms",
	"Days to Expiration",
	"Expiration Date"
) COMMENT='ISPG-DIR RBD'
 as
SELECT RBD.Risk_Acceptance_ID as "Risk Acceptance ID"
	  ,RBD.Authorization_Package_Name as "Information System or Program Name"
      ,RBD.Submit_Date as "Submit Date"
	  ,enumRiskLevel.Value as "Weakness Risk Level"
	  ,POAM.POAM_ID as "POA&Ms"
	  ,RBD.Days_to_Expiration as "Days to Expiration"
      ,RBD.Expiration_Date as "Expiration Date"
	  FROM APP_CFACTS.SHARED.SEC_VW_Risk_Acceptance_RBD RBD  
      join APP_CFACTS.SHARED.SEC_VW_POAMs_Risk_Acceptance_RBD_POAMs_x_Risk_Acceptance_RBD_POAMs RBDXPOAM 
	        on RBD.ContentId= RBDXPOAM.Risk_Acceptance_RBD_POAMs_ContentId
	  join APP_CFACTS.SHARED.SEC_VW_POAMs POAM  on RBDXPOAM.POAMs_Risk_Acceptance_RBD_POAMs_ContentId=POAM.ContentId
	  join APP_CFACTS.SHARED.SEC_VW_POAMs_Weakness_Risk_Level_1 RiskLevel on RiskLevel.ParentContentId=POAM.ContentId
	  join APP_CFACTS.SHARED.SEC_VW_enum_Risk_Level_1 enumRiskLevel  on enumRiskLevel.Id=RiskLevel.Value;
create or replace view V_MILESTONEUPDATE_MONTHLY(
	"POA&M ID",
	"POA&M ID#",
	LATESTMILESTONEUPDATEDATE,
	SCHEDULED_COMPLETION_DATE,
	OVERALL_STATUS,
	WEAKNESS_RISK_LEVEL,
	SYSACRONYM,
	POAMCOUNT,
	ACRONYM,
	DAYS_OPEN,
	TLC_PHASE,
	COMPONENT_ACRONYM
) COMMENT='Updated Milestone data for the month end snapshot'
 as
select  
drv1.POAM_ID as "POA&M ID",  
substring(drv1.POAM_ID,CHARINDEX('-',drv1.POAM_ID) + 1, LEN(drv1.POAM_ID)-CHARINDEX('-', drv1.POAM_ID)) as "POA&M ID#",  
drv1.LatestMilestoneUpdateDate, 
drv1.Scheduled_Completion_Date,
drv1.Overall_Status,
drv1.Weakness_Risk_Level,
case when drv1.POAM_ID is NULL then NULL else s.Acronym end as SysAcronym,
case when drv1.POAM_ID is NULL then NULL else 1 end as POAMCount,
s.Acronym,
drv1.Days_Open, 
S.TLC_Phase,
s.component_acronym
from CORE.VW_Systems s
Left outer join
(select drv.* from
 
    (SELECT distinct m.POAM_ID,Last_Updated LatestMilestoneUpdateDate,P.Scheduled_Completion_Date,P.Overall_Status,P.Weakness_Risk_Level,P.Days_Open,P.SYSTEM_ID
	    FROM rpt.V_Milestone_MonthEndSnapshot m
        INNER JOIN (SELECT POAM_ID, MAX(Last_Updated) AS LatestdateTime 
            FROM rpt.V_Milestone_MonthEndSnapshot m GROUP BY POAM_ID) drv_m on m.POAM_ID = drv_m.POAM_ID AND m.Last_Updated = drv_m.LatestdateTime	
        INNER JOIN (select "POA&M ID" as POAM_ID,"Overall_Status" as OVERALL_STATUS,"Weakness_Risk_Level" as WEAKNESS_RISK_LEVEL,"Days_Open" as DAYS_OPEN,"CFACTS_UID" as SYSTEM_ID,"Scheduled_Completion_Date" as SCHEDULED_COMPLETION_DATE from rpt.V_POAMS_MonthEndSnapshot) P on m.POAM_ID = P.POAM_ID
	 where datediff(day,LAST_DAY(ADD_MONTHS(current_date(),-1)),Last_Updated::datetime) < -24 and P.Overall_Status not in ('Closed for System Disposition','Completed','Pending Verification')
	group by m.POAM_ID,Last_Updated,p.Scheduled_Completion_Date,Overall_Status,Weakness_Risk_Level,Days_Open,p.SYSTEM_ID
    order by
      CASE Weakness_Risk_Level
        WHEN 'High' THEN 1
        WHEN 'Moderate' THEN 2
        WHEN 'Low' THEN 3
        WHEN 'Not Rated' THEN 4
        ELSE 5
       END 
       ASC, Days_Open DESC
        --  OFFSET 0 ROWs
 	) drv
) drv1 on drv1.SYSTEM_ID = s.SYSTEM_ID;
create or replace view V_MILESTONE_CURRSNAPSHOT(
	"ReportDate",
	ID,
	"datecreated",
	"Actual_Completion_Date",
	"Authorization_Package",
	"Changes_To_Milestone",
	"Estimated_Completion_Date",
	"Last_Updated",
	"Milestone_Description",
	"Milestone_Name",
	"Milestone_Status",
	"MilestoneID",
	POAM_ID,
	"Scheduled_Completion_Date",
	"FK_SystemID",
	CFACTS_UID
) COMMENT='Latest snapshot of Milestones related data details'
 as
SELECT 
r.REPORT_DATE as "ReportDate"
,m.ID as "ID"
, r.REPORT_DATE as "datecreated"
,m.Actual_Completion_Date as "Actual_Completion_Date"
,s.Authorization_Package as "Authorization_Package"
,m.Changes_To_Milestone as "Changes_To_Milestone"
,m.Estimated_Completion_Date as "Estimated_Completion_Date"
,m.Last_Updated as "Last_Updated"
,m.Milestone_Description as "Milestone_Description"
,m.Milestone_Name as "Milestone_Name"
,m.Milestone_Status as "Milestone_Status"
,m.MILESTONE_ID as "MilestoneID"
,m.POAM_ID as "POAM_ID"
,m.Scheduled_Completion_Date as "Scheduled_Completion_Date"
,m.SYSTEM_ID as "FK_SystemID"
,m.SYSTEM_ID as "CFACTS_UID"
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.MILESTONEHIST m on m.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = m.SYSTEM_ID
;
create or replace view V_MILESTONE_MONTHENDSNAPSHOT(
	REPORTDATE,
	ID,
	DATECREATED,
	ACTUAL_COMPLETION_DATE,
	AUTHORIZATION_PACKAGE,
	CHANGES_TO_MILESTONE,
	ESTIMATED_COMPLETION_DATE,
	LAST_UPDATED,
	MILESTONE_DESCRIPTION,
	MILESTONE_NAME,
	MILESTONE_STATUS,
	MILESTONEID,
	POAM_ID,
	SCHEDULED_COMPLETION_DATE,
	FK_SYSTEMID,
	CFACTS_UID
) COMMENT='Latest Month end snapshot of Milestones related data details'
 as
SELECT 
r.REPORT_DATE as ReportDate
,m.ID
,r.REPORT_DATE as datecreated
,m.Actual_Completion_Date
,s.Authorization_Package
,m.Changes_To_Milestone
,m.Estimated_Completion_Date
,m.Last_Updated
,m.Milestone_Description
,m.Milestone_Name
,m.Milestone_Status
,m.MILESTONE_ID as MilestoneID
,m.POAM_ID
,m.Scheduled_Completion_Date
,m.SYSTEM_ID as FK_SystemID
,m.SYSTEM_ID as CFACTS_UID
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
JOIN CORE.MILESTONEHIST m on m.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = m.SYSTEM_ID;
create or replace view V_MONTHLY_CRR_OA(
	"join_ID",
	"acronym",
	"Archer_Tracking_ID",
	"auth_decision",
	"Component_Acronym",
	"Group_Acronym",
	"HVAStatus",
	"In_CMS_Cloud",
	"ISSO Count",
	"OA_Status",
	"fk_prim_id",
	"cve",
	"cve_count",
	"MitigationStatus",
	"FISMAseverity",
	"snapshotdate"
) COMMENT='Using legacy V_ standard naming to expediate migration'
 as
select
s.SYSTEM_ID as "join_ID"
,s.ACRONYM as "acronym"
,s.ARCHER_TRACKING_ID as "Archer_Tracking_ID"
,s.AUTH_DECISION as "auth_decision"
,s.COMPONENT_ACRONYM as "Component_Acronym"
,s.GROUP_ACRONYM as "Group_Acronym"
,s.HVASTATUS as "HVAStatus"
,s.IN_CMS_CLOUD as "In_CMS_Cloud"
,s.ISSO_COUNT as "ISSO Count"
,s.OA_STATUS as "OA_Status"
,v.SYSTEM_ID as "fk_prim_id"
,v.CVE as "cve"
,v.CVE_COUNT as "cve_count"
,v.MITIGATIONSTATUS as "MitigationStatus"
,v.FISMASEVERITY as "FISMAseverity"
,v.REPORT_DATE as "snapshotdate"
FROM (select SYSTEM_ID
    ,ACRONYM
    ,ARCHER_TRACKING_ID
    ,AUTH_DECISION
    ,COMPONENT_ACRONYM
    ,GROUP_ACRONYM
    ,HVASTATUS
    ,IN_CMS_CLOUD
    ,ISSO_COUNT
    ,OA_STATUS
    FROM CORE.VW_SYSTEMS
    WHERE TLC_PHASE <> 'Retire') s
left outer join (select a.SYSTEM_ID,vh.CVE,count(vh.CVE) as CVE_COUNT,vh.MITIGATIONSTATUS,vh.FISMASEVERITY,r.REPORT_DATE
    FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
    join CORE.VW_VULHIST vh on vh.REPORT_ID = r.REPORT_ID
    join CORE.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID
    join CORE.ASSET a on a.DW_ASSET_ID = vm.DW_ASSET_ID
    where vh.FISMASEVERITY is not null
    group by a.SYSTEM_ID,vh.CVE,vh.MITIGATIONSTATUS,vh.FISMASEVERITY,r.REPORT_DATE) v on v.SYSTEM_ID = s.SYSTEM_ID
;
create or replace view V_MONTHLY_CRR_VULNCOUNT(
	ACRONYM,
	COMPONENT_ACRONYM,
	FISMASEVERITY,
	GROUP_ACRONYM,
	UNIQ_CNT,
	BUCKETS,
	DELETIONREASON,
	TOT_CNT
) COMMENT='Not using in tableau'
 as
select 
s.acronym
,s.Component_Acronym
,FISMAseverity
,s.Group_Acronym
,count(distinct v.cve) uniq_cnt
,v.buckets
,null as DeletionReason
,count(v.CVE) tot_cnt
from CORE.VW_SYSTEMS s

left outer join (select 
    SYSTEM_ID
    ,cve
    --,DaysSinceDiscovery
    --,MitigationStatus
    ,FISMAseverity
    --,r.REPORT_DATE as snapshotdate
    ,DW_VUL_ID
    --,FK_AssetID
    ,case 
        when FISMAseverity = 'Critical' and DaysSinceDiscovery >15 and  DaysSinceDiscovery <=60 then 'Unique Critical >15 and <=60 Days'
        when FISMAseverity = 'Critical' and DaysSinceDiscovery >60  then 'Unique Critical >60 Days'
        when FISMAseverity = 'High' and DaysSinceDiscovery >30 and  DaysSinceDiscovery <=60 then 'Unique High >30 and <=60 Days'
        when FISMAseverity = 'High' and DaysSinceDiscovery >60 then 'Unique High >60 Days'
    end as buckets 
    from TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
    JOIN CORE.VW_VULHIST vh on vh.REPORT_ID = r.REPORT_ID
    where vh.FISMAseverity is not null and vh.MitigationStatus in ('open','reopened')) v on v.SYSTEM_ID = s.SYSTEM_ID
    
--left outer join (select id,datemitigated,DeletionReason,datecreated from dbo.VulMaster where DeletionReason is null) vm on (vm.ID = v.DW_VUL_ID)
--left outer join CORE.VW_ASSETHIST ah on ah,REPORT_ID = r.REPORT_ID and ah.DW_ASSET_ID = v.DW_ASSET_ID

WHERE s.TLC_PHASE <> 'Retire' and s.Component_Acronym not in ('Not specified','FCHCO','CMCHO')
group by s.acronym,s.Component_Acronym,FISMAseverity, s.Group_Acronym,buckets
;
create or replace view V_POAMHIST(
	ID,
	"ReportID",
	"ReportDate",
	"Archer_Tracking_ID",
	"Authorization_Package",
	"POA&M ID",
	"Days_Open",
	"Overall_Status",
	"Estimated_Completion_Date",
	"Scheduled_Completion_Date",
	"Actual_Completion_Date",
	CAAT_ID,
	CAAT,
	"Cost",
	"Labor_Estimate",
	"Funding_Source",
	"POA&M_Closed_Date",
	"POA&M_Owner",
	"POA&M_Reviewer",
	"Review_Status",
	"Review_Date",
	"Review_Comments",
	"Target",
	"Submission_Status",
	"Weakness_ID",
	"Weakness_Creation_Date",
	"Weakness_Risk_Level",
	"Weakness_Severity",
	"Weakness_POC",
	"FK_SystemID",
	CFACTS_UID
) COMMENT='Used in other RPT view to get historical POA&M related information'
 as
SELECT 
p.ID as "ID"
,p.REPORT_ID as "ReportID"
,p.REPORT_DATE as "ReportDate"
,p.ARCHER_TRACKING_ID as "Archer_Tracking_ID"
,p.AUTHORIZATION_PACKAGE as "Authorization_Package"
,p.POAM_ID as "POA&M ID"
,p.DAYS_OPEN as "Days_Open"
,p.OVERALL_STATUS as "Overall_Status"
,p.ESTIMATED_COMPLETION_DATE as "Estimated_Completion_Date"
,p.SCHEDULED_COMPLETION_DATE as "Scheduled_Completion_Date"
,p.ACTUAL_COMPLETION_DATE as "Actual_Completion_Date"
,p.CAAT_ID as "CAAT_ID"
,p.CAAT as "CAAT"
,p.COST as "Cost"
,p.LABOR_ESTIMATE as "Labor_Estimate"
,p.FUNDING_SOURCE as "Funding_Source"
,p.POAM_CLOSED_DATE as "POA&M_Closed_Date"
,p.POAM_OWNER as "POA&M_Owner"
,p.POAM_REVIEWER as "POA&M_Reviewer"
,p.REVIEW_STATUS as "Review_Status"
,p.REVIEW_DATE as "Review_Date"
,p.REVIEW_COMMENTS as "Review_Comments"
,p.TARGET as "Target"
,p.SUBMISSION_STATUS as "Submission_Status"
,p.WEAKNESS_ID as "Weakness_ID"
,p.WEAKNESS_CREATION_DATE as "Weakness_Creation_Date"
,p.WEAKNESS_RISK_LEVEL as "Weakness_Risk_Level"
,p.WEAKNESS_SEVERITY as "Weakness_Severity"
,p.WEAKNESS_POC as "Weakness_POC"
,p.SYSTEM_ID as "FK_SystemID"
,p.SYSTEM_ID as "CFACTS_UID"
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHIST p on p.REPORT_ID = r.REPORT_ID
;
create or replace view V_POAMS(
	ID,
	REPORTDATE,
	ARCHER_TRACKING_ID,
	SYSTEM_ID,
	FISMA_ID,
	IS_MARKETPLACE,
	POAM_ID,
	DAYS_OPEN,
	OVERALL_STATUS,
	AUTHORIZATION_PACKAGE,
	ESTIMATED_COMPLETION_DATE,
	SCHEDULED_COMPLETION_DATE,
	ACTUAL_COMPLETION_DATE,
	CAAT_ID,
	CAAT,
	COST,
	LABOR_ESTIMATE,
	FUNDING_SOURCE,
	POAM_CLOSED_DATE,
	POAM_OWNER,
	POAM_REVIEWER,
	REVIEW_STATUS,
	REVIEW_DATE,
	REVIEW_COMMENTS,
	TARGET,
	SUBMISSION_STATUS,
	WEAKNESS_ID,
	WEAKNESS_CREATION_DATE,
	WEAKNESS_RISK_LEVEL,
	WEAKNESS_SEVERITY,
	WEAKNESS_POC
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (SYSTEM_ID)
 COMMENT='Used in Other RPT view to get current POA&M related information'
 as
SELECT 
p.ID,
p.REPORT_DATE as REPORTDATE,
p.ARCHER_TRACKING_ID,
p.SYSTEM_ID,
p.SYSTEM_ID FISMA_ID,
S.IS_MARKETPLACE,
p.POAM_ID,
p.DAYS_OPEN,
p.OVERALL_STATUS,
p.AUTHORIZATION_PACKAGE,
p.ESTIMATED_COMPLETION_DATE,
p.SCHEDULED_COMPLETION_DATE,
p.ACTUAL_COMPLETION_DATE,
p.CAAT_ID,
p.CAAT,
p.COST,
p.LABOR_ESTIMATE,
p.FUNDING_SOURCE,
p.POAM_CLOSED_DATE,
p.POAM_OWNER,
p.POAM_REVIEWER,
p.REVIEW_STATUS,
p.REVIEW_DATE,
p.REVIEW_COMMENTS,
p.TARGET,
p.SUBMISSION_STATUS,
p.WEAKNESS_ID,
p.WEAKNESS_CREATION_DATE,
p.WEAKNESS_RISK_LEVEL,
p.WEAKNESS_SEVERITY,
p.WEAKNESS_POC
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
JOIN CORE.VW_POAMHIST p on p.REPORT_ID = r.REPORT_ID
JOIN CORE.VW_SYSTEMS S on P.SYSTEM_ID = S.SYSTEM_ID
;
create or replace view V_POAMS_MONTHENDSNAPSHOT(
	ID,
	"ReportDate",
	"Archer_Tracking_ID",
	CFACTS_UID,
	"POA&M ID",
	"Days_Open",
	"Overall_Status",
	"Authorization_Package",
	"Estimated_Completion_Date",
	"Scheduled_Completion_Date",
	"Actual_Completion_Date",
	CAAT_ID,
	CAAT,
	"Cost",
	"Labor_Estimate",
	"Funding_Source",
	"POA&M_Closed_Date",
	"POA&M_Owner",
	"POA&M_Reviewer",
	"Review_Status",
	"Review_Date",
	"Review_Comments",
	"Target",
	"Submission_Status",
	"Weakness_ID",
	"Weakness_Creation_Date",
	"Weakness_Risk_Level",
	"Weakness_Severity",
	"Weakness_POC"
) COMMENT='Latest Month end snapshot of POA&Ms related data details '
 as
SELECT p.ID as "ID"
,p.REPORT_DATE as "ReportDate"
,p.ARCHER_TRACKING_ID as "Archer_Tracking_ID"
,p.SYSTEM_ID as "CFACTS_UID"
,p.POAM_ID as "POA&M ID"
,p.DAYS_OPEN as "Days_Open"
,p.OVERALL_STATUS as "Overall_Status"
,p.AUTHORIZATION_PACKAGE as "Authorization_Package"
,p.ESTIMATED_COMPLETION_DATE as "Estimated_Completion_Date"
,p.SCHEDULED_COMPLETION_DATE as "Scheduled_Completion_Date"
,p.ACTUAL_COMPLETION_DATE as "Actual_Completion_Date"
,p.CAAT_ID as "CAAT_ID"
,p.CAAT as "CAAT"
,p.COST as "Cost"
,p.LABOR_ESTIMATE as "Labor_Estimate"
,p.FUNDING_SOURCE as "Funding_Source"
,p.POAM_CLOSED_DATE as "POA&M_Closed_Date"
,p.POAM_OWNER as "POA&M_Owner"
,p.POAM_REVIEWER as "POA&M_Reviewer"
,p.REVIEW_STATUS as "Review_Status"
,p.REVIEW_DATE as "Review_Date"
,p.REVIEW_COMMENTS as "Review_Comments"
,p.TARGET as "Target"
,p.SUBMISSION_STATUS as "Submission_Status"
,p.WEAKNESS_ID as "Weakness_ID"
,p.WEAKNESS_CREATION_DATE as "Weakness_Creation_Date"
,p.WEAKNESS_RISK_LEVEL as "Weakness_Risk_Level"
,p.WEAKNESS_SEVERITY as "Weakness_Severity"
,p.WEAKNESS_POC as "Weakness_POC"
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1)) r
JOIN CORE.VW_POAMHIST p on p.REPORT_ID = r.REPORT_ID
;
create or replace view V_SEC_USERSYSMAPPING_ALL(
	ACRONYM,
	USERNAME,
	MEMBER
) COMMENT='Security view with role-based access levels and users'
 as
SELECT distinct
um.ACRONYM
,um.USER_ID as USERNAME
,FALSE as MEMBER
FROM CORE.CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID
where um.role not in ( 'ISPG Fed Staff', 'ISPG Contractor Staff', 'CMS Read Only')
--and TLC_Phase <> 'Retire' --231122_1130  CR 788
Union All
select distinct
syst.ACRONYM
,EC.USERNAME
,EC.MEMBER
from RPT.CFACTS_EXCLUSIVECLUB EC 
LEFT JOIN CORE.VW_SYSTEMS syst on 1=1
where Member = 1
--and TLC_Phase <> 'Retire'; --231122_1130 CR 788
;
create or replace view V_SEC_USERSYSMAPPING_VATDC(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ACRONYM,
	SYSTEM_ID,
	USERID
) COMMENT='Security view for specifically crated for Data center users (Details provided by VAT team)'
 as
select distinct
 A.DATACENTER_ACRONYM --as "DataCenter Acronym"
,A.DATACENTER_ID --as "DataCenterUID"
,S.Acronym --as "System Acronym"
,S.SYSTEM_ID --as "SystemUID"
,SU.UserId --as "UserName"
from CORE.VW_SYSTEMS S
join CORE.VW_ASSETS A on A.system_id = S.system_id
join rpt.VAT_SYSTEMUSERS SU on S.SYSTEM_ID = SU.SYSTEM_ID
where S.Is_ExcludeFromReporting = 0 and S.Is_PhantomSystem=0 and SU.UserId is not null;
create or replace view V_SYSTEMS(
	ID,
	FISMA_ID,
	"dateCreated",
	"FK_SnapshotID",
	"Acronym",
	"Archer_Tracking_ID",
	"Auth_Comments",
	"Auth_Decision",
	"Authorization_Package",
	"Business_Owner",
	CFACTS_UID,
	CIO,
	CISO,
	"Cloud_Service_Provider",
	"CommonName",
	"Component_Acronym",
	"Component_Risk_Reports_Oversight",
	"ContingencyExpirationDate",
	"CP_Test_Date",
	"CP_Test_Results",
	CRA,
	"CyberVet",
	"Date_Auth_Memo_Expires",
	"Date_Auth_Memo_Signed",
	"dateDeleted",
	"dateModified",
	DCISO,
	"Division_Acronym",
	"DivisionName",
	"E-Auth_Exp_Date",
	"E-Auth_Level",
	"E-Auth_Risk_Assessment_Date",
	"Financial_System",
	"FIPS_199_Availability_Rating",
	"FIPS_199_Confidentiality_Rating",
	"FIPS_199_Integrity_Rating",
	"FIPS_199_Overall_Impact_Rating",
	"FISMA_System",
	"Group_Acronym",
	"HVA_Score",
	"HVAStatus",
	"In_CMS_Cloud",
	"Information_System_Type",
	"Is_DataCenter",
	"Is_ExcludeFromReporting",
	"Is_HighRiskSystem",
	"Is_MarketPlace",
	"Is_OA_Ready",
	"Is_OperationalSystem",
	"Is_PhantomSystem",
	"Is_SecurityHub_Enabled",
	"ISRA_Review_Date",
	"ISRA_Status",
	"ISSO Count",
	ISSO,
	ISSOCS,
	"Last_ACT_Date",
	"Last_Pentest_Date",
	MEF,
	"MEF_Context",
	"MEFStatus",
	"OA_Status",
	"OATO_Category",
	"Package_Type",
	"PIA_Expiration_Date",
	PII_PHI,
	"Primary_ISSO",
	"Primary_Operating_Location",
	SCA,
	"SCA_Date",
	SDM,
	"ST&E_Date",
	"System_Description",
	"TLC_Phase",
	"TotalAssets",
	"TotalPOAMwithApprovedRBD",
	"VATName",
	"Next_Required_CP_Test_Date",
	"Control_Set_Version_Number_System_Provid",
	"AWS_accountIds",
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	CISO_REVIEW_DATE,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	CRA_REVIEW_DATE,
	DIVISION_DESCRIPTION,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	FIRST_PUBLISHED_DATE,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	PIA_014,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SOP_REVIEW_DATE
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (CFACTS_UID)
 COMMENT='Dimensional view for referencing the Org hierarchy data (similar to CORE.VW_SYSTEMS)'
 as
SELECT
SYSTEM_ID as "ID"
,SYSTEM_ID as FISMA_ID
,INSERT_DATE as "dateCreated"
,(SELECT TOP 1 REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as "FK_SnapshotID"
,ACRONYM as "Acronym"
,ARCHER_TRACKING_ID as "Archer_Tracking_ID"
,AUTH_COMMENTS as "Auth_Comments"
,AUTH_DECISION as "Auth_Decision"
,AUTHORIZATION_PACKAGE as "Authorization_Package"
,BUSINESS_OWNER as "Business_Owner"
,SYSTEM_ID as "CFACTS_UID"
,CIO as "CIO"
,CISO as "CISO"
,CLOUD_SERVICE_PROVIDER as "Cloud_Service_Provider"
,COMMONNAME as "CommonName"
,COMPONENT_ACRONYM as "Component_Acronym"
,COMPONENT_RISK_REPORTS_OVERSIGHT as "Component_Risk_Reports_Oversight"
,CONTINGENCYEXPIRATIONDATE as "ContingencyExpirationDate"
,CP_TEST_DATE as "CP_Test_Date"
,CP_TEST_RESULTS as "CP_Test_Results"
,CRA as "CRA"
,CYBERVET as "CyberVet"
,DATE_AUTH_MEMO_EXPIRES as "Date_Auth_Memo_Expires"
,DATE_AUTH_MEMO_SIGNED as "Date_Auth_Memo_Signed"
,DATEDELETED as "dateDeleted"
,DATEMODIFIED as "dateModified"
,DCISO as "DCISO"
,DIVISION_ACRONYM as "Division_Acronym"
,DIVISION_NAME as "DivisionName"
,E_AUTH_EXP_DATE as "E-Auth_Exp_Date"
,E_AUTH_LEVEL as "E-Auth_Level"
,E_AUTH_RISK_ASSESSMENT_DATE as "E-Auth_Risk_Assessment_Date"
,FINANCIAL_SYSTEM as "Financial_System"
,FIPS_199_AVAILABILITY_RATING as "FIPS_199_Availability_Rating"
,FIPS_199_CONFIDENTIALITY_RATING as "FIPS_199_Confidentiality_Rating"
,FIPS_199_INTEGRITY_RATING as "FIPS_199_Integrity_Rating"
,FIPS_199_OVERALL_IMPACT_RATING as "FIPS_199_Overall_Impact_Rating"
,FISMA_SYSTEM as "FISMA_System"
,GROUP_ACRONYM as "Group_Acronym"
,HVA_SCORE as "HVA_Score"
,HVASTATUS as "HVAStatus"
,IN_CMS_CLOUD as "In_CMS_Cloud"
,INFORMATION_SYSTEM_TYPE as "Information_System_Type"
,IS_DATACENTER as "Is_DataCenter"
,IS_EXCLUDEFROMREPORTING as "Is_ExcludeFromReporting"
,IS_HIGHRISKSYSTEM as "Is_HighRiskSystem"
,IS_MARKETPLACE as "Is_MarketPlace"
,IS_OA_READY as "Is_OA_Ready"
,IS_OPERATIONALSYSTEM as "Is_OperationalSystem"
,IS_PHANTOMSYSTEM as "Is_PhantomSystem"
,IS_SECURITYHUB_ENABLED as "Is_SecurityHub_Enabled"
,ISRA_REVIEW_DATE as "ISRA_Review_Date"
,ISRA_STATUS as "ISRA_Status"
,ISSO_COUNT as "ISSO Count"
,ISSO as "ISSO"
,ISSOCS as "ISSOCS"
,LAST_ACT_DATE as "Last_ACT_Date"
,LAST_PENTEST_DATE as "Last_Pentest_Date"
,MEF as "MEF"
,MEF_CONTEXT as "MEF_Context"
,MEFSTATUS as "MEFStatus"
,OA_STATUS as "OA_Status"
,OATO_CATEGORY as "OATO_Category"
,PACKAGE_TYPE as "Package_Type"
,PIA_EXPIRATION_DATE as "PIA_Expiration_Date"
,PII_PHI as "PII_PHI"
,PRIMARY_ISSO as "Primary_ISSO"
,PRIMARY_OPERATING_LOCATION as "Primary_Operating_Location"
,SCA as "SCA"
,SCA_DATE as "SCA_Date"
,SDM as "SDM"
,STE_DATE as "ST&E_Date"
,SYSTEM_DESCRIPTION as "System_Description"
,TLC_PHASE as "TLC_Phase"
,TOTALASSETS as "TotalAssets"
,TOTALPOAMWITHAPPROVEDRBD as "TotalPOAMwithApprovedRBD"
,null as "VATName"
,NEXT_REQUIRED_CP_TEST_DATE as "Next_Required_CP_Test_Date"
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as "Control_Set_Version_Number_System_Provid"
,AWS_ACCOUNTIDS as "AWS_accountIds"
,ATO_EXPIRATION_DATE as ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE as ATO_REVIEW_DATE
,AUTHORIZATION_MEMO_SIGNED_DATE as AUTHORIZATION_MEMO_SIGNED_DATE
,BO_RECOMMENDATION_REVIEW_DATE as BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE as BO_REVIEW_DATE
,CISO_REVIEW_DATE as CISO_REVIEW_DATE
,COMPONENT_DESCRIPTION as COMPONENT_DESCRIPTION
,COMPONENT_NAME as COMPONENT_NAME
,CRA_REVIEW_DATE as CRA_REVIEW_DATE
,DIVISION_DESCRIPTION as DIVISION_DESCRIPTION
,DSPC_REVIEW_DATE as DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE as DSPPO_REVIEW_DATE
,FIRST_PUBLISHED_DATE as FIRST_PUBLISHED_DATE
,GROUP_DESCRIPTION as GROUP_DESCRIPTION
,GROUP_NAME as GROUP_NAME
,ISSO_REVIEW_DATE as ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE as ISSO_SUBMISSION_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE as LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE as LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE as LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,PIA_014 as PIA_014
,PRIMARY_OPERATING_LOCATION_ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID as PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST as REASON_FOR_ATO_REQUEST
,SOP_REVIEW_DATE as SOP_REVIEW_DATE
FROM CORE.VW_SYSTEMS;
create or replace view V_SYSTEMSUMMARY(
	"ReportDate",
	"Is_endOfMonth",
	"ComponentAcronym",
	"DivisionAcronym",
	"GroupAcronym",
	"PrimaryOperatingLocation",
	"SystemAcronym",
	"SystemCommonName",
	CFACTS_UID,
	IS_MARKETPLACE,
	"Assets",
	"VulCritical",
	"VulCritical_gt30_lte60days",
	"VulCritical_gt60days",
	"VulCritical_gte15days",
	"VulCritical_lte15days",
	"VulCritical_lte30days",
	"VulHigh",
	"VulHigh_gt30_lte60days",
	"VulHigh_gt60days",
	"VulHigh_lte30days",
	"VulRaw",
	"VulRaw_Critical",
	"VulRaw_High",
	"VulRaw_Low",
	"VulRaw_Medium",
	"VulUniqueCritical_gt15_lte60days",
	"VulUniqueCritical_gt30_lte60days",
	"VulUniqueCritical_gt60days",
	"VulUniqueCritical_gte15days",
	"VulUniqueHigh_gt30_lte60days",
	"VulUniqueHigh_gt60days",
	"HWAMRawAWS",
	"HWAMRawBigFix",
	"HWAMRawForeScout",
	"VulDeleted",
	"VulMedium",
	"VulLow",
	"VulUniqueMedium",
	"VulUniqueLow",
	"AssetRiskTolerance",
	"ResidualRisk",
	"ResiliencyScore",
	"PrevAssets",
	"VulnRiskTolerance",
	"FK_ReportID",
	"FK_SystemID",
	FISMA_ID,
	"SystemSummaryPrimaryKey",
	"Control_Set_Version_Number_System_Provid",
	"KEV_Open",
	"KEV_Reopened",
	"KEV_Fixed_MonthToDate",
	AUTHORIZATION_PACKAGE,
	KEV_FIXED_TODAY,
	SCANNABLEASSETS,
	VULCRITICALREMEDIATED,
	VULHIGHREMEDIATED,
	VULUNIQUECRITICAL_GT15_LTE60DAYS
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (CFACTS_UID)
 COMMENT='System level summary data for all report_id to show history of system changes.'
 as
select ss.REPORT_DATE as "ReportDate"
,ss.IS_ENDOFMONTH as "Is_endOfMonth"
,s.COMPONENT_ACRONYM as "ComponentAcronym"
,s.DIVISION_ACRONYM as "DivisionAcronym"
,s.GROUP_ACRONYM as "GroupAcronym"
,s.PRIMARY_OPERATING_LOCATION_ACRONYM as "PrimaryOperatingLocation"
,s.ACRONYM as "SystemAcronym"
,s.COMMONNAME as "SystemCommonName"
,ss.SYSTEM_ID as "CFACTS_UID"
,s.IS_MARKETPLACE
,ss.ASSETS as "Assets"
,ss.VULCRITICAL as "VulCritical"
,ss.VULUNIQUECRITICAL_GT30_LTE60DAYS as "VulCritical_gt30_lte60days"
,ss.VULCRITICAL_GT60DAYS as "VulCritical_gt60days"
,ss.VULCRITICAL_GTE15DAYS as "VulCritical_gte15days"
,ss.VULCRITICAL_LTE15DAYS as "VulCritical_lte15days"
,ss.VULCRITICAL_LTE30DAYS as "VulCritical_lte30days"
,ss.VULHIGH as "VulHigh"
,ss.VULHIGH_GT30_LTE60DAYS as "VulHigh_gt30_lte60days"
,ss.VULHIGH_GT60DAYS as "VulHigh_gt60days"
,ss.VULHIGH_LTE30DAYS as "VulHigh_lte30days"
,ss.VULRAW as "VulRaw"
,ss.VULRAW_CRITICAL as "VulRaw_Critical"
,ss.VULRAW_HIGH as "VulRaw_High"
,ss.VULRAW_LOW as "VulRaw_Low"
,ss.VULRAW_MEDIUM as "VulRaw_Medium"
,ss.VULCRITICAL_GT15_LTE60DAYS as "VulUniqueCritical_gt15_lte60days"
,ss.VULCRITICAL_GT30_LTE60DAYS as "VulUniqueCritical_gt30_lte60days"
,ss.VULUNIQUECRITICAL_GT60DAYS as "VulUniqueCritical_gt60days"
,ss.VULUNIQUECRITICAL_GTE15DAYS as "VulUniqueCritical_gte15days"
,ss.VULUNIQUEHIGH_GT30_LTE60DAYS as "VulUniqueHigh_gt30_lte60days"
,ss.VULUNIQUEHIGH_GT60DAYS as "VulUniqueHigh_gt60days"
,ss.HWAMRAWAWS as "HWAMRawAWS"
,ss.HWAMRAWBIGFIX as "HWAMRawBigFix"
,ss.HWAMRAWFORESCOUT as "HWAMRawForeScout"
,ss.VULDELETED as "VulDeleted"
,ss.VULMEDIUM as "VulMedium"
,ss.VULLOW as "VulLow"
,ss.VULUNIQUEMEDIUM as "VulUniqueMedium"
,ss.VULUNIQUELOW as "VulUniqueLow"
,ss.ASSETRISKTOLERANCE as "AssetRiskTolerance"
,ss.RESIDUALRISK as "ResidualRisk"
,ss.RESILIENCYSCORE as "ResiliencyScore"
,ss.PREVASSETS as "PrevAssets"
,ss.VULNRISKTOLERANCE as "VulnRiskTolerance"
,ss.REPORT_ID as "FK_ReportID"
,ss.SYSTEM_ID as "FK_SystemID"
,ss.SYSTEM_ID as FISMA_ID
,ss.ID as "SystemSummaryPrimaryKey"
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID as "Control_Set_Version_Number_System_Provid"
,ss.KEV_OPEN as "KEV_Open"
,ss.KEV_REOPENED as "KEV_Reopened"
,ss.KEV_FIXED_MONTHTODATE as "KEV_Fixed_MonthToDate"
,s.AUTHORIZATION_PACKAGE as AUTHORIZATION_PACKAGE
,ss.KEV_FIXED_TODAY as KEV_FIXED_TODAY
,ss.SCANNABLEASSETS as SCANNABLEASSETS
,0 as VULCRITICALREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this field. It was never populated.
,0 as VULHIGHREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this 
,ss.VULUNIQUECRITICAL_GT15_LTE60DAYS as VULUNIQUECRITICAL_GT15_LTE60DAYS
FROM CORE.VW_SYSTEMSUMMARY ss
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ss.SYSTEM_ID
;
create or replace view V_SYSTEMSUMMARY_DCRR_POAM(
	ACRONYM,
	CFACTS_UID,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	TLC_PHASE,
	WEAKNESS_RISK_LEVEL,
	REPORTDATE,
	WEAKNESS_WEIGHT,
	POAM_CNT
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains POAM related information(POAM count, Weakness Risk Level)'
 as
select distinct
Acronym, 
p.system_id CFACTS_UID,
s.Component_Acronym
,s.Group_Acronym
,s.HVAStatus
,s.Is_MarketPlace
,s.MEFStatus
,s.TLC_Phase
,WEAKNESS_RISK_LEVEL as Weakness_Risk_Level
,reportdate as reportdate
,case when WEAKNESS_RISK_LEVEL= 'Low' then 10
when (WEAKNESS_RISK_LEVEL)= 'Moderate' then 15
when (WEAKNESS_RISK_LEVEL)= 'High' then 30
when (WEAKNESS_RISK_LEVEL)= 'Critical' then 45 else 0 end weakness_weight,
count(distinct POAM_ID) as POAM_CNT
from CORE.VW_POAMS_OPEN p --CR#1074
join CORE.VW_SYSTEMS s on p.system_id = s.system_id 
group by ALL;
create or replace view V_SYSTEMSUMMARY_DCRR_SYSTEMS(
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CFACTS_UID,
	COMPONENT_ACRONYM,
	ACRONYM,
	BUSINESS_OWNER,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SDM,
	TLC_PHASE,
	ISSO,
	CRA,
	GROUP_NAME,
	DIVISION_NAME,
	GROUP_ACRONYM,
	IS_MARKETPLACE,
	HVASTATUS,
	MEFSTATUS,
	AUTHORIZATION_PACKAGE,
	CONTINGENCYEXPIRATIONDATE,
	NEXT_REQUIRED_CP_TEST_DATE,
	CP_TEST_DATE,
	AUTH_DECISION,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	REM_CNT,
	KEV_OPEN,
	KEV_REOPENED,
	UNIQ_CRIT_15_60,
	UNIQ_CRIT_60,
	TOT_CRIT_60,
	UNIQ_IGH_15_60,
	TOT_HIGH_15_60,
	UNIQ_HIGH_60,
	TOT_HIGH_60,
	HWAM_COUNT,
	ASSETRISKTOLERANCE,
	RESIDUALRISK,
	VULNRISKTOLERANCE,
	RESILIENCYSCORE,
	TOT_CRIT_VULNS,
	TOT_HIGH_VULNS,
	REPORT_ID,
	REPORT_DATE,
	RANKK
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains System related information.'
 as
select
systems.Control_Set_Version_Number_System_Provid
,systems.system_id cfacts_uid
,systems.COMPONENT_ACRONYM
,systems.acronym
,systems.BUSINESS_OWNER
,systems.primary_isso
,systems.primary_operating_location
,systems.sdm
,systems.tlc_phase
,systems.isso
,systems.cra
,systems.GROUP_NAME
,systems.DIVISION_NAME
,systems.Group_Acronym
,systems.Is_MarketPlace
,systems.HVAStatus
,systems.MEFStatus
,systems.Authorization_Package
,systems.ContingencyExpirationDate
,systems.Next_Required_CP_Test_Date
,systems.cp_test_date
,systems.Auth_Decision
,systems.Date_Auth_Memo_Expires
,systems.Is_OA_Ready
,systems.OA_Status
,summary.KEV_Fixed_MonthToDate rem_cnt
,summary.KEV_Open
,summary.KEV_Reopened 
,summary.VulUniqueCritical_gt15_lte60days as uniq_crit_15_60
,summary.VulUniqueCritical_gt60days as uniq_crit_60
,summary.VulCritical_gt60days  as tot_crit_60
,summary.VulUniqueHigh_gt30_lte60days  as uniq_igh_15_60
,summary.VulHigh_gt30_lte60days as tot_high_15_60
,summary.VulUniqueHigh_gt60days as uniq_high_60
,summary.VulHigh_gt60days as tot_high_60
,summary.Assets HWAM_COUNT
,summary.AssetRiskTolerance
,summary.ResidualRisk
,summary.VulnRiskTolerance
,summary.resiliencyscore
,summary.VulCritical as tot_crit_vulns
,summary.VulHigh as tot_high_vulns
,snap.REPORT_ID
,snap.Report_Date
,dense_rank()over(order by snap.REPORT_ID desc) as rankk
 from CORE.VW_SYSTEMSUMMARY summary
join (SELECT REPORT_ID,Report_Date FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))
UNION
SELECT REPORT_ID,Report_Date FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1))) snap on snap.REPORT_ID=summary.REPORT_ID
right outer join CORE.vw_systems systems on (summary.system_id = systems.system_id) 
where systems.IS_PHANTOMSYSTEM = 0 and systems.IS_EXCLUDEFROMREPORTING = 0;
create or replace view V_SYSTEMSUMMARY_DCRR_VULN(
	JOIN_ID,
	ACRONYM,
	ARCHER_TRACKING_ID,
	AUTH_DECISION,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IN_CMS_CLOUD,
	ISSO_COUNT,
	OA_STATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	TLC_PHASE,
	UNIQ_CVE_COUNT,
	CVE_COUNT,
	FISMASEVERITY,
	LESSTHAN25,
	LESSTHAN50,
	GREATERTHAN50,
	GREATERTHAN75,
	CRITICALGT15,
	HIGHGT30,
	MODERATEGT90,
	LOWGT365,
	REPORTDATE
) COMMENT='Used for Tableau in Dynamic Cyber Risk Dashboard : \nView contains vuln related information(CVE count, Fisma Severity)'
 as
 with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'HWAM')a where rankkForSnap =1
	union --CR#822 changed Union All to Union to avoid duplicate records on monthend snapshot date
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'HWAM')a where rankkForSnap = 1)),  
Snapshots as (select Report_ID,Report_Date, snapshot_ID,Is_endOfMonth from ReportIDs r)
select s.system_id as join_ID
,acronym
,Archer_Tracking_ID
,auth_decision
,Component_Acronym
,Group_Acronym
,HVAStatus
,In_CMS_Cloud
,isso_count
,OA_Status
,MEFStatus
,Is_MarketPlace
,tlc_phase
,Uniq_cve_count
,cve_count
,FISMAseverity
,LessThan25
,LessThan50
,GreaterThan50
,GreaterThan75
,CriticalGT15
,HighGT30
,ModerateGT90
,LowGT365
,Report_Date ReportDate
from CORE.VW_SYSTEMS s
right outer JOIN (select system_id, Report_ID from CORE.VW_SYSTEMSUMMARY) ss on ss.system_id = s.system_id
join Snapshots snap on snap.Report_ID = ss.Report_ID
left outer join (select system_id,count(distinct cve) Uniq_cve_count, count(cve) cve_count, FISMAseverity, Report_ID from CORE.VW_VULHIST where MitigationStatus in ('open', 'reopened')
group by system_id, FISMAseverity, Report_ID) vul on vul.system_id = ss.system_id and 
vul.Report_ID = snap.Report_ID
--Below lines are added for CR #959
left join (select system_id, sum(Q2) + sum(Q3) as LessThan25,sum(Q4) as LessThan50, sum(Q5) as GreaterThan50, sum(Q6) as GreaterThan75 from (SELECT system_id, 
       "'NULL'" AS Q1,
      "'<=0%'" AS Q2,
       "'> 0% and <= 25%'" AS Q3, 
       "'> 25% and <= 50%'" AS Q4, 
       "'> 50% and <= 75%'" AS Q5,
       "'> 75% and <= 100%'" AS Q6
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS
    PIVOT(count(CVE) FOR EPSS_FILTER IN (
      'NULL',
      '<=0%',
      '> 0% and <= 25%', 
      '> 25% and <= 50%', 
      '> 50% and <= 75%', 
      '> 75% and <= 100%')
    ) where lower(MitigationStatus) in ('open', 'reopened')) group by system_id)vulcur on ss.system_id = vulcur.system_id  
 left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))  group by system_id)vulDays on ss.system_id = vulDays.system_id
  ;
create or replace view V_SYSTEMSUMMARY_MCRR_MILESTONE(
	POAM_ID,
	LATESTMILESTONEUPDATEDATE,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	WEAKNESS_RISK_LEVEL,
	OVERALL_STATUS,
	REPORTNAME
) COMMENT='Contains Milestone data details related to Systems (POA&M Risk Level / Milestone last updated)'
 as
SELECT  distinct m.POAM_ID
,cast(m.LAST_UPDATED as datetime) as LatestMilestoneUpdateDate
,S.Acronym
,s.Component_Acronym
,s.Group_Acronym
,p."Weakness_Risk_Level" Weakness_Risk_Level
,p."Overall_Status" Overall_Status
,reportName
FROM rpt.V_MILESTONE_MONTHENDSNAPSHOT m
INNER JOIN
(SELECT POAM_ID, MAX(cast (LAST_UPDATED as datetime)) AS LatestdateTime
FROM rpt.V_MILESTONE_MONTHENDSNAPSHOT
GROUP BY POAM_ID) drv_m
ON (m.POAM_ID = drv_m.POAM_ID
AND cast(m.LAST_UPDATED as datetime) = drv_m.LatestdateTime)
INNER JOIN (select "Weakness_Risk_Level", "Overall_Status", "POA&M ID", "Archer_Tracking_ID" from
rpt.V_POAMS_MONTHENDSNAPSHOT) P on (m.POAM_ID=P."POA&M ID")
INNER JOIN (select Archer_Tracking_ID, Acronym,Component_Acronym,Group_Acronym from CORE.VW_SYSTEMS) S
on S.Archer_Tracking_ID = P."Archer_Tracking_ID"
 LEFT JOIN rpt.CRR_Component_Params reportName ON ((Acronym = reportName.systems) AND (Component_Acronym = reportName.component) AND (Group_Acronym = reportName.groups))
where datediff(day,(select max(report_date) from core.VW_REPORTSNAPSHOTS where DataCategory = 'CFACTS' and Is_endOfMonth =1),cast(LAST_UPDATED as  datetime)) <-24
and P."Overall_Status" not in ('Closed for System Disposition','Completed','Pending Verification')
group by m.poam_id,cast(m.LAST_UPDATED as datetime),S.Acronym,s.Component_Acronym,s.Group_Acronym,Weakness_Risk_Level,Overall_Status, REPORTNAME;
create or replace view V_SYSTEMSUMMARY_MCRR_POAM(
	ARCHER_TRACKING_ID,
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	DAYS_OPEN,
	WEAKNESS_RISK_LEVEL,
	POAM_ID,
	OVERALL_STATUS,
	REPORT_DATE,
	RANKK,
	REPORTNAME
) COMMENT='Contains POA&M data details related to Systems (POA&M Risk Level/POA&M ID/Weakness Score)'
 as
select ph.Archer_Tracking_ID
,Acronym
,Component_Acronym
,Group_Acronym
,days_open
,WEAKNESS_RISK_LEVEL
,poam_id
,OVERALL_STATUS
,a.report_date
,dense_rank()over(order by a.report_date desc) as rankk
  ,Report_Name.ReportName 
from core.VW_POAMHIST ph
join (select top 2 report_id, report_date, rank()over(order by report_date desc) as rankk from core.REPORT_IDS where is_endofmonth =1 
order by REPORT_DATE desc)a on a.report_id = ph.report_id
inner join (select Archer_Tracking_ID,Component_Acronym,Acronym,Group_Acronym from CORE.VW_SYSTEMS
where TLC_Phase<>'Retire')syst on (ph.Archer_Tracking_ID = syst.Archer_Tracking_ID)
LEFT JOIN 
  rpt.CRR_Component_Params Report_Name ON ((syst.Acronym = Report_Name.systems) AND (syst.Component_Acronym = Report_Name.COMPONENT) AND (syst.Group_Acronym = Report_Name.GROUPS))
where Overall_Status not in (
'Closed for System Retired'
,'Completed'
,'Pending Verification'
,'Risk Accepted'
);
create or replace view V_SYSTEMSUMMARY_MCRR_SYSTEMS(
	ACRONYM,
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	GROUP_NAME,
	DIVISION_ACRONYM,
	DIVISIONNAME,
	AUTHORIZATION_PACKAGE,
	BUSINESS_OWNER,
	CONTINGENCYEXPIRATIONDATE,
	NEXT_REQUIRED_CP_TEST_DATE,
	CP_TEST_DATE,
	AUTH_DECISION,
	DATE_AUTH_MEMO_EXPIRES,
	IS_OA_READY,
	OA_STATUS,
	HVASTATUS,
	MEFSTATUS,
	IS_MARKETPLACE,
	TLC_PHASE,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	SDM,
	ISSO,
	CRA,
	CFACTS_UID,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	REPORTDATE,
	ASSETS,
	VULCRITICAL,
	VULCRITICAL_GT30_LTE60DAYS,
	VULCRITICAL_GT60DAYS,
	VULCRITICAL_GTE15DAYS,
	VULCRITICAL_LTE15DAYS,
	VULCRITICAL_LTE30DAYS,
	VULHIGH,
	VULHIGH_GT30_LTE60DAYS,
	VULHIGH_GT60DAYS,
	VULHIGH_LTE30DAYS,
	VULRAW,
	VULRAW_CRITICAL,
	VULRAW_HIGH,
	VULRAW_LOW,
	VULRAW_MEDIUM,
	VULUNIQUECRITICAL_GT15_LTE60DAYS,
	VULUNIQUECRITICAL_GT30_LTE60DAYS,
	VULUNIQUECRITICAL_GT60DAYS,
	VULUNIQUECRITICAL_GTE15DAYS,
	VULUNIQUEHIGH_GT30_LTE60DAYS,
	VULUNIQUEHIGH_GT60DAYS,
	HWAMRAWAWS,
	HWAMRAWBIGFIX,
	HWAMRAWFORESCOUT,
	VULDELETED,
	VULMEDIUM,
	VULLOW,
	VULUNIQUEMEDIUM,
	VULUNIQUELOW,
	ASSETRISKTOLERANCE,
	RESIDUALRISK,
	RESILIENCYSCORE,
	PREVASSETS,
	VULNRISKTOLERANCE,
	TOTALVRT,
	VULCRITICAL_GT15_LTE60DAYS,
	KEV_OPEN,
	KEV_REOPENED,
	KEV_FIXED_TODAY,
	KEV_FIXED_MONTHTODATE,
	REPORT_ID,
	SYSTEM_ID,
	SYSTEMSUMMARYPRIMARYKEY,
	VULCRITICALREMEDIATED,
	VULHIGHREMEDIATED,
	OVER_DUE,
	PENTEST_COUNT,
	RANKK,
	COMPONENT,
	GROUPS,
	SYSTEMS,
	REPORTNAME
) COMMENT='Contains system related information (OA Status/VRT/ART/CP Expiry/ATO/Business Owner etc)'
 as
select
  systems.Acronym
  ,systems.Component_Acronym
  ,systems.Group_Acronym
  ,systems.group_name
  ,systems.Division_Acronym
  ,systems.Division_Name DivisionName
  ,systems.Authorization_Package
  ,systems.Business_Owner
  ,systems.ContingencyExpirationDate
  ,systems.Next_Required_CP_Test_Date
  ,systems.CP_Test_Date
  ,systems.Auth_Decision
  ,systems.Date_Auth_Memo_Expires
  ,systems.Is_OA_Ready
  ,systems.OA_Status
  ,systems.HVAStatus
  ,systems.MEFStatus
  ,systems.Is_MarketPlace
  ,systems.TLC_Phase
  ,systems.Primary_ISSO
  ,systems.Primary_Operating_Location
  ,systems.sdm
  ,systems.isso
  ,systems.cra
  ,systems.cfacts_uid
  ,systems.Control_Set_Version_Number_System_Provid
  ,snap.REPORT_DATE as ReportDate
  ,Summary.assets
  ,Summary.vulcritical
  ,Summary.vulcritical_gt30_lte60days
  ,Summary.vulcritical_gt60days
  ,Summary.VulCritical_gte15days
  ,Summary.VulCritical_lte15days
  ,Summary.VulCritical_lte30days
  ,Summary.VulHigh
  ,Summary.VulHigh_gt30_lte60days
  ,Summary.VulHigh_gt60days
  ,Summary.VulHigh_lte30days
  ,Summary.VulRaw
  ,Summary.VulRaw_Critical
  ,Summary.VulRaw_High
  ,Summary.VulRaw_Low
  ,Summary.VulRaw_Medium
  ,Summary.VulUniqueCritical_gt15_lte60days
  ,Summary.VulUniqueCritical_gt30_lte60days
  ,Summary.VulUniqueCritical_gt60days
  ,Summary.VulUniqueCritical_gte15days
  ,Summary.VulUniqueHigh_gt30_lte60days
  ,Summary.VulUniqueHigh_gt60days
  ,Summary.hwamrawaws
  ,Summary.HWAMRawBigFix
  ,Summary.HWAMRawForeScout
  ,Summary.VulDeleted
  ,Summary.VulMedium
  ,Summary.VulLow
  ,Summary.VulUniqueMedium
  ,Summary.VulUniqueLow
  ,Summary.AssetRiskTolerance
  ,Summary.ResidualRisk
  ,Summary.ResiliencyScore
  ,Summary.PrevAssets
  ,Summary.VulnRiskTolerance
  ,summary.VulnRiskTolerance AS TotalVRT
  ,summary.VulCritical_gt15_lte60days
  ,summary.KEV_Open
  ,summary.KEV_Reopened
  ,summary.KEV_Fixed_Today
  ,summary.KEV_Fixed_MonthToDate
  ,Summary.report_id
  ,Summary.system_id
  ,Summary.ID AS SystemSummaryPrimaryKey
  ,0 as VULCRITICALREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this field. It was never populated.
  ,0 as VULHIGHREMEDIATED -- 240222 CR840 VW_SYSTEMSUMMARY no longer has this field. It was never populated.
  ,COALESCE(od.Over_due, 0) as Over_due
  ,COALESCE(pentest_count, 0) pentest_count
  ,dense_rank()over(order by ReportDate desc) as rankk
  ,Report_Name.Component
  ,Report_Name.Groups
  ,Report_Name.Systems
  ,Report_Name.ReportName
  from core.VW_SYSTEMSUMMARY summary
  join (select top 2 report_id,report_date from core.REPORT_IDS where is_endofmonth =1 order by REPORT_DATE desc) snap on snap.REPORT_ID = summary.report_id
  right outer join (select system_id, Acronym, Component_Acronym, Group_Acronym, group_name, Division_Acronym, DIVISION_NAME, Authorization_Package, 
  Business_Owner, ContingencyExpirationDate, Next_Required_CP_Test_Date, CP_Test_Date, Auth_Decision, Date_Auth_Memo_Expires, Is_OA_Ready, 
  OA_Status, HVAStatus, MEFStatus, Is_MarketPlace, TLC_Phase, Primary_ISSO, Primary_Operating_Location, sdm, isso, cra, system_id cfacts_uid,
  Control_Set_Version_Number_System_Provid from CORE.VW_SYSTEMS) systems on summary.system_id = systems.system_id
  left outer join (select "Acronym","Component_Acronym", count(*) as pentest_count from rpt.V_CRMP_PENTEST where "Weakness_Risk_Level" = 'High' and "Overall_Status" in ('Delayed','Ongoing','Draft')
  group by "Acronym","Component_Acronym") pentest on (systems.Acronym = pentest."Acronym" and systems.Component_Acronym = pentest."Component_Acronym")
    left outer join (select Count(P."POA&M ID") Over_due,s.Acronym,s.Component_Acronym from rpt.V_POAMS_MONTHENDSNAPSHOT P
  JOIN (Select Acronym, Component_Acronym, ARCHER_TRACKING_ID, HVAStatus, TLC_Phase from CORE.VW_SYSTEMS) s On s.ARCHER_TRACKING_ID= p."Archer_Tracking_ID"
  
  where
  	   "Overall_Status" in ('Delayed')
  	  AND "Estimated_Completion_Date" <= (select max(report_date) from core.VW_REPORTSNAPSHOTS where datacategory = 'CFACTS' and Is_endOfMonth =1)  --Added per Teresa's request
  	  AND "Weakness_Risk_Level" = 'High'
  	  and s.HVAStatus='Yes' and s.TLC_Phase<>'Retire'
  	  group by s.Acronym,s.Component_Acronym)od on  (systems.Acronym = od.Acronym and systems.Component_Acronym = od.Component_Acronym)
  LEFT JOIN (
  select * from rpt.CRR_COMPONENT_PARAMS
) Report_Name ON ((systems.Acronym = Report_Name.SYSTEMS) AND (systems.component_Acronym = Report_Name.COMPONENT) AND (systems.Group_Acronym = Report_Name.GROUPS));
create or replace view V_SYSTEMSUMMARY_MCRR_VULCOUNT(
	REPORTNAME,
	ACRONYM,
	VULNS_CNT,
	BUCKET,
	LESSTHAN25,
	LESSTHAN50,
	GREATERTHAN50,
	GREATERTHAN75,
	CRITICALGT15,
	HIGHGT30,
	MODERATEGT90,
	LOWGT365
) COMMENT='Vuln data details related to System information (Vuln Severity/Remediated Vulns/KEV''s / Buckets for Age etc)'
 as
  SELECT REPORTNAME
       ,ACRONYM
       ,vulns_cnt
       ,bucket
       ,LessThan25
        ,LessThan50
        ,GreaterThan50
        ,GreaterThan75
        ,CriticalGT15
        ,HighGT30
        ,ModerateGT90
        ,LowGT365
FROM   (SELECT reportname
            ,s.ACRONYM
            ,vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow
            ,LessThan25
            ,LessThan50
            ,GreaterThan50
            ,GreaterThan75
            ,CriticalGT15
            ,HighGT30
            ,ModerateGT90
            ,LowGT365
        FROM CORE.VW_SYSTEMSUMMARY ss
		join CORE.VW_SYSTEMS s on ss.system_id = s.system_id
        --CR #577
        left join (select system_id, sum(Q1)+ sum(Q2) + sum(Q3) as LessThan25,sum(Q4) as LessThan50, sum(Q5) as GreaterThan50, sum(Q6) as GreaterThan75 from (SELECT system_id, 
       "'NULL'" AS Q1,
      "'<=0%'" AS Q2,
       "'> 0% and <= 25%'" AS Q3, 
       "'> 25% and <= 50%'" AS Q4, 
       "'> 50% and <= 75%'" AS Q5,
       "'> 75% and <= 100%'" AS Q6
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS
    PIVOT(count(CVE) FOR EPSS_FILTER IN (
      'NULL',
      '<=0%',
      '> 0% and <= 25%', 
      '> 25% and <= 50%', 
      '> 50% and <= 75%', 
      '> 75% and <= 100%')
    ) where lower(MitigationStatus) in ('open', 'reopened'))group by system_id)vulcur on ss.system_id = vulcur.system_id  
       left join (select system_id, sum(Q1) CriticalGT15,sum(Q2) as HighGT30, sum(Q3) as ModerateGT90, sum(Q4) as LowGT365 from 
           (SELECT system_id, 
       "'OVERDUE CRITICAL'" AS Q1,
       "'OVERDUE HIGH'" AS Q2,
       "'OVERDUE MODERATE'" AS Q3, 
       "'OVERDUE LOW'" AS Q4
  FROM RPT.VW_ASSETDETAIL_ROLLING60DAYS 
    PIVOT(count(CVE) FOR OVERDUE_FILTER IN (
      'OVERDUE CRITICAL',
      'OVERDUE HIGH',
      'OVERDUE MODERATE', 
      'OVERDUE LOW')
    )where lower(MitigationStatus) in ('open', 'reopened'))group by system_id)vulDays on ss.system_id = vulDays.system_id    
        
		 LEFT JOIN (
  select * from rpt.CRR_COMPONENT_PARAMS
) reportName ON (s.ACRONYM = reportName.Systems) AND (component_acronym = reportName.Component) AND (group_acronym = reportName.Groups)
        WHERE  report_id = (SELECT max(REPORT_ID) FROM core.report_ids where is_endofmonth = 1))data
       UNPIVOT(vulns_cnt
              FOR bucket IN ( vuluniquecritical_gt15_lte60days
            ,vuluniquecritical_gt30_lte60days
            ,vuluniquecritical_gt60days
            ,vuluniquecritical_gte15days
            ,vuluniquehigh_gt30_lte60days
            ,vuluniquehigh_gt60days
            ,vulcritical_gt60days
            ,vulhigh_gt30_lte60days
            ,vulcritical_gt15_lte60days
			,vulhigh_gt60days
			,vuluniquemedium
			,vuluniquelow
			,vulmedium
			,vullow ) ) AS mrks;
create or replace view V_TRAL_LOG(
	DATE_IDENTIFIED,
	ACRONYM,
	FISMA_SYSTEM,
	TLC_PHASE,
	SYSTEM_RISK_LEVEL,
	DESCRIPTION,
	OA_READY,
	OA_STATUS,
	SEVERITY,
	IMPACTED_CONTROLS,
	RISK_RESPONSE,
	THRESHOLD,
	INITIALSCORE,
	DATEMITIGATED,
	SUBSEQUENTSCORE
) COMMENT='Trigger Accountability Log related information used in conjunction with Ongoing Auth related metrics'
 as
--
-- Author: Chris Rollman, IronVine
-- Date created: 4/5/22
SELECT 
tl.dateIdentified::date as Date_Identified
,s.Acronym
,s.Authorization_Package as FISMA_System
,s.TLC_Phase 
,src.Description || '(' || cast(src.SYSTEMRISKCATEGORY_ID as varchar) || ')' as System_Risk_Level
,tm.TriggerDescription as Description
,coalesce(s.Is_OA_Ready=1,'Yes','No') OA_Ready
,s.OA_Status
,case tsl.RiskSeverityLevel
	when 'High' then tsl.RiskSeverityLevel || '(3)'
	when 'Moderate' then tsl.RiskSeverityLevel || '(2)'
	when 'Low' then tsl.RiskSeverityLevel || '(1)'
	Else tsl.RiskSeverityLevel
End as Severity
,tsl.ImpactedControls as Impacted_Controls
,tsl.RiskResponse as Risk_Response
,tsl.ThresholdDisplay as Threshold
,tl.InitialScore
,tl.dateMitigated
,tl.SubsequentScore
FROM CORE.VW_SYSTEMS s 
JOIN CORE.SystemRiskCategory src on src.SYSTEMRISKCATEGORY_ID = s.OATO_Category
JOIN CORE.TRAL_Log tl on tl.System_ID = s.System_ID
JOIN CORE.TRAL_Metric tm on tm.TRAL_Metric_ID = tl.TRAL_Metric_ID
JOIN CORE.TRAL_RiskSeverityLevel tsl  on tsl.SystemRiskCategory_ID = src.SYSTEMRISKCATEGORY_ID and tsl.TRAL_Metric_ID = tl.TRAL_Metric_ID
where s.TLC_Phase <> 'Retire'
ORDER BY s.Acronym, tl.dateIdentified;
create or replace view V_USERMAPPING_BV(
	"Component_Acronym",
	"Group_Acronym",
	"Acronym",
	"UserName",
	SYSTEM_ID
) COMMENT='Security view with conditional access levels'
 as
select distinct 
s.COMPONENT_ACRONYM as "Component_Acronym"
,s.GROUP_ACRONYM as "Group_Acronym"
,s.ACRONYM as "Acronym"
,um.USER_ID as"UserName"
,s.SYSTEM_ID
from CORE.VW_CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID
where um.role not in ('Component Report POC', 'ISPG Fed Staff', 'ISPG Contractor Staff', 'CMS Read Only') 
;
create or replace view V_USERMAPPING_BV_ISPGISSO(
	COMPONENT_ACRONYM,
	ACRONYM,
	USERNAME,
	SYSTEM_ID
) COMMENT='Security view with conditional access levels specific to ISSO'
 as
select s.COMPONENT_ACRONYM,s.ACRONYM,um.USER_ID as USERNAME,s.SYSTEM_ID
FROM CORE.VW_CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID
WHERE um.role in ('ISPG Fed Staff', 'ISPG Contractor Staff', 'CMS Read Only')
;
create or replace view V_USERSYSMAPPING(
	"Component_Acronym",
	"Group_Acronym",
	"Acronym",
	"UserName"
) COMMENT='System / User mapping details'
 as
SELECT distinct
s.COMPONENT_ACRONYM as "Component_Acronym"
,s.GROUP_ACRONYM as "Group_Acronym"
,um.ACRONYM as "Acronym"
,um.USER_ID as "UserName"
FROM CORE.CFACTS_USERMAPPING um
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = um.SYSTEM_ID
where um.role not in ( 'ISPG Fed Staff', 'ISPG Contractor Staff', 'CMS Read Only');
create or replace view V_VULCUR(
	DW_VUL_ID,
	DATEVULCREATED,
	DATACENTERACRONYM,
	SNAPSHOT_DATE,
	SYSTEMACRONYM,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	DNSNAME,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	IP,
	LASTFOUND,
	MACADDRESS,
	MITIGATIONSTATUS,
	NETBIOSNAME,
	OS,
	PLUGINID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	DATACENTER_ID,
	FISMA_ID,
	"GROUP ACRONYM",
	"GROUP NAME",
	"COMPONENT ACRONYM",
	"COMPONENT NAME",
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	DW_ASSET_ID,
	SNAPSHOT_ID
) COMMENT='current open or reopened vulns'
 as
SELECT 
vm.dw_vul_id 
,vm.INSERT_DATE as dateVulCreated 
,dc.Acronym as DataCenterAcronym
,(SELECT TOP 1 REPORT_DATE FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as SNAPSHOT_DATE
,s.Acronym as SystemAcronym
,a.asset_id_tattoo
,vm.cve
,vm.CVSSV2BASESCORE as CVSSv2Base
,vm.CVSSV3BASESCORE as CVSSv3Base
,vm.DaysSinceDiscovery
,NULL as Description
,a.FQDN as dnsName
,vm.exploitAvailable
,NULL as familyName
,vm.firstSeen
,vm.FISMAseverity
,a.IPv4 as ip
,vm.lastFound
,a.macAddress
,vm.MitigationStatus
,a.netbiosname
,a.OS
,plugs.PLUGIN_ID as pluginID
,NULL as signature
,NULL as Solution
,a.source_tool_VUL as source_tool
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.Group_Acronym
,s.Group_Name
,s.Component_Acronym 
,s.Component_Name 
,vm.IS_KEV as Is_BOD 
,vm.BODDueDate
,vm.datemitigated 
,vm.DW_ASSET_ID -- needed for V_Monthly_CRR_VulnCount
,((SELECT TOP 1 REPORT_ID FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)))) as SNAPSHOT_ID -- needed for V_Monthly_CRR_VulnCount
from CORE.VW_VulMaster vm
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID 
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
where vm.MitigationStatus IN ('open','reopened')
;
create or replace view V_VULCUR_STAT(
	DW_VUL_ID,
	DATEVULCREATED,
	DATACENTERACRONYM,
	SNAPSHOT_DATE,
	SYSTEMACRONYM,
	DATACENTERID,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DAYSSINCEDISCOVERY_FILTER,
	DESCRIPTION,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	OS,
	PLUGINID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	DATACENTER_ID,
	FISMA_ID,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED,
	EPSS_SCORE,
	EPSS_FILTER,
	EPSS_PERCENTILE
) COMMENT='current statistics over all vulns including EPSS metrics'
 as
SELECT 
vm.dw_vul_id 
,vm.INSERT_DATE as dateVulCreated 
,dc.Acronym as DataCenterAcronym
,(SELECT max(REPORT_DATE) FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as SNAPSHOT_DATE
,s.Acronym as SystemAcronym
,dc.System_ID as DataCenterID
,s.System_ID
,a.asset_id_tattoo
,vm.cve
,vm.CVSSV2BASESCORE as CVSSv2Base
,vm.CVSSV3BASESCORE as CVSSv3Base
,vm.DaysSinceDiscovery
,case 
    when vm.DAYSSINCEDISCOVERY <= 15 then '<= 15 days'
    when vm.DAYSSINCEDISCOVERY > 15 and vm.DAYSSINCEDISCOVERY <= 30 then '> 15 and <= 30 days'
    when vm.DAYSSINCEDISCOVERY > 30 and vm.DAYSSINCEDISCOVERY <= 45 then '> 30 and <= 45 days'
    when vm.DAYSSINCEDISCOVERY > 45 and vm.DAYSSINCEDISCOVERY <= 60 then '> 45 and <= 60 days'
    when vm.DAYSSINCEDISCOVERY > 60 and vm.DAYSSINCEDISCOVERY <= 90 then '> 60 and <= 90 days'
    when vm.DAYSSINCEDISCOVERY > 90 then '> 90 days'
    ELSE 'NULL'
    end as DAYSSINCEDISCOVERY_FILTER --added on 082124 as part of CR 959
,NULL as Description
,vm.exploitAvailable
,NULL as familyName
,vm.firstSeen
,vm.FISMAseverity
,vm.lastFound
,vm.MitigationStatus
,a.OS
,plugs.PLUGIN_ID as pluginID -- 230808 was DW_PLUGIN_ID
,NULL as signature
,NULL as Solution
,a.source_tool_VUL as source_tool
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.Group_Acronym
,s.Group_Name
,s.Component_Acronym 
,s.Component_Name 
,case vm.IS_KEV
	when 0 then 'No'
	Else 'Yes' 
    End as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated
,epss.epss --added on 082124 as part of CR 959
,case 
    when epss.epss <= 0 then '<=0%'
    when epss.epss > 0 and epss.epss <= 0.25 then '> 0% and <= 25%'
    when epss.epss > 0.25 and epss.epss <= 0.50 then '> 25% and <= 50%'
    when epss.epss > 0.50 and epss.epss <= 0.75 then '> 50% and <= 75%'
    when epss.epss > 0.75 and epss.epss <= 1 then '> 75% and <= 100%'
    ELSE 'NULL'
    End as EPSS_FILTER --added on 082124 as part of CR 959
,epss.percentile --added on 082124 as part of CR 959
from CORE.VW_VulMaster vm
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = VM.cve --added on 082124 as part of CR 959
;
create or replace view V_VULCUR_STAT_240821_1458(
	DW_VUL_ID,
	DATEVULCREATED,
	DATACENTERACRONYM,
	SNAPSHOT_DATE,
	SYSTEMACRONYM,
	DATACENTERID,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	CVE,
	CVSSV2BASE,
	CVSSV3BASE,
	DAYSSINCEDISCOVERY,
	DESCRIPTION,
	EXPLOITAVAILABLE,
	FAMILYNAME,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	OS,
	PLUGINID,
	SIGNATURE,
	SOLUTION,
	SOURCE_TOOL,
	DATACENTER_ID,
	FISMA_ID,
	GROUP_ACRONYM,
	GROUP_NAME,
	COMPONENT_ACRONYM,
	COMPONENT_NAME,
	IS_BOD,
	BODDUEDATE,
	DATEMITIGATED
) COMMENT='current statistics over all vulns'
 as
SELECT 
vm.dw_vul_id 
,vm.INSERT_DATE as dateVulCreated 
,dc.Acronym as DataCenterAcronym
,(SELECT max(REPORT_DATE) FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))) as SNAPSHOT_DATE
,s.Acronym as SystemAcronym
,dc.System_ID as DataCenterID
,s.System_ID
,a.asset_id_tattoo
,vm.cve
,vm.CVSSV2BASESCORE as CVSSv2Base
,vm.CVSSV3BASESCORE as CVSSv3Base
,vm.DaysSinceDiscovery
,NULL as Description
,vm.exploitAvailable
,NULL as familyName
,vm.firstSeen
,vm.FISMAseverity
,vm.lastFound
,vm.MitigationStatus
,a.OS
,plugs.PLUGIN_ID as pluginID -- 230808 was DW_PLUGIN_ID
,NULL as signature
,NULL as Solution
,a.source_tool_VUL as source_tool
,dc.SYSTEM_ID as Datacenter_id
,s.SYSTEM_ID as FISMA_id
,s.Group_Acronym
,s.Group_Name
,s.Component_Acronym 
,s.Component_Name 
,case vm.IS_KEV
	when 0 then 'No'
	Else 'Yes' 
End as Is_BOD 
,vm.BODDueDate 
,vm.datemitigated 
from CORE.VW_VulMaster vm
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID
LEFT OUTER JOIN CORE.VulPlugin plugs on plugs.DW_VUL_ID = vm.DW_VUL_ID
;
create or replace view V_VULHIST(
	ID,
	"dateCreated",
	"DataCenterAcronym",
	"SnapshotDate",
	"SystemAcronym",
	"asset_id_tattoo",
	"cve",
	"CVSSv2Base",
	"CVSSv3Base",
	"DaysSinceDiscovery",
	"Description",
	"dnsName",
	"exploitAvailable",
	"familyName",
	"firstSeen",
	"FISMAseverity",
	"ip",
	"lastFound",
	"macAddress",
	"MitigationStatus",
	"netbiosname",
	OS,
	"pluginID",
	"signature",
	"Solution",
	"source_tool",
	"Datacenter_id",
	"FISMA_id",
	"Group Acronym",
	"Group Name",
	"Component Acronym",
	"Component Name",
	"Is_BOD",
	"BODDueDate",
	"datemitigated",
	REPORT_ID,
	DW_ASSET_ID,
	DW_VUL_ID
) COMMENT='Return open/reopened historical vulnerability for all report_id'
 as
SELECT 
ID as "ID"
,REPORT_DATE as "dateCreated"
,DATACENTERACRONYM as "DataCenterAcronym"
,REPORT_DATE as "SnapshotDate"
,SYSTEMACRONYM as "SystemAcronym"
,ASSET_ID_TATTOO as "asset_id_tattoo"
,CVE as "cve"
,CVSSV2BASESCORE as "CVSSv2Base"
,CVSSV3BASESCORE as "CVSSv3Base"
,DAYSSINCEDISCOVERY as "DaysSinceDiscovery"
,DESCRIPTION as "Description"
,DNSNAME as "dnsName"
,EXPLOITAVAILABLE as "exploitAvailable"
,FAMILYNAME as "familyName"
,FIRSTSEEN as "firstSeen"
,FISMASEVERITY as "FISMAseverity"
,IP as "ip"
,LASTFOUND as "lastFound"
,MACADDRESS as "macAddress"
,MITIGATIONSTATUS as "MitigationStatus"
,NETBIOSNAME as "netbiosname"
,OS as "OS"
,PLUGIN_ID as "pluginID"
,SIGNATURE as "signature"
,SOLUTION as "Solution"
,SOURCE_TOOL as "source_tool"
,DATACENTER_ID as "Datacenter_id"
,SYSTEM_ID as "FISMA_id"
,GROUP_ACRONYM as "Group Acronym"
,GROUP_NAME as "Group Name"
,COMPONENT_ACRONYM as "Component Acronym"
,COMPONENT_NAME as "Component Name"
,case IS_BOD
    when TRUE then 'Yes'
    Else 'No'
End as "Is_BOD"
,BODDUEDATE as "BODDueDate"
,DATEMITIGATED as "datemitigated"
,REPORT_ID as REPORT_ID -- New under SDL
,DW_ASSET_ID as DW_ASSET_ID -- New under SDL
,DW_VUL_ID as DW_VUL_ID -- New under SDL
FROM CORE.VW_VULHIST;
create or replace view V_VULN_2MONTHDATA(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Return open/reopened historical vulnerability for rolling 2 months'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)),
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r)
select  v.Acronym as v_acr,v.Component_Acronym as v_comp_acr ,v.TLC_Phase v_tlc_phase,v.HVAStatus as v_hva_stat,v.Is_MarketPlace as v_is_mrkt_plc,v.MEFStatus as v_mef_status,
case when vuln.acronym is null then concat(v.Acronym,'*') else v.Acronym end as v_acr_display,
vuln.* from CORE.vw_systems v
left outer join
(
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,V.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.ID as FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,snap.snapshot_ID as fk_snapshotID
,dc.Acronym
,substring(dc.Acronym, 1, 1) || '***' as Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.dateCreated as datecreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym as data_center_name
,vm.DeletionReason
,p.plugin_ID as fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by snap.SNAPSHOT_ID desc) as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,v.dw_asset_id as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,NULL as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,A.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,cast(SUM(IFF(vm.dw_vul_ID is null,0,daysSinceDiscovery*cast(vm.cvss2basescore as float)* dc.OATO_Category*IFF(exploitAvailable='Yes',2,1)))/IFF(count(1)=0,1,count(1)) as decimal(10,2)) as VRT
,pom.POAM_ID as "POA&M ID"
,pom.Overall_Status
from CORE.vw_vulhist v 
JOIN (select Report_ID,Report_Date, snapshot_ID,case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID from CORE.VW_ReportSnapshots
                where DataCategory= 'VUL' and Is_endOfMonth='1'
                union
                select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID from CORE.VW_ReportSnapshots
                where DataCategory= 'VUL' and Is_endOfMonth='0'
                )a where rankkForSnap =1
) snap on v.Report_ID = snap.Report_ID
left outer JOIN CORE.VW_Assets A  ON V.dw_Asset_ID = A.dw_Asset_ID
left outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus, tlc_phase, OATO_Category from CORE.VW_Systems) DC ON DC.SYSTEM_ID = V.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog ) bodcat  on bodcat.CVE = V.cve
left join (select dw_vul_id,datemitigated,NULL as DeletionReason,FIRSTSEEN as datecreated, CVSSV2BASESCORE as cvss2basescore, CVSSV3BASESCORE as cvss3basescore from CORE.VW_VulMaster)vm on vm.dw_vul_id = v.dw_vul_id
left outer join (select system_id,acronym from CORE.VW_Systems) data_center ON data_center.system_id = V.datacenter_id
left outer join (select dw_vul_id,max(PLUGIN_ID) as pluginID FROM CORE.VulPlugin vp  group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.dw_vul_id)
left outer join (select PLUGIN_ID,solution,familyname,signature from CORE.Plugins ) p on (p.PLUGIN_ID = plugs.pluginID)
left outer join (SELECT System_ID,POAM_ID,Overall_Status
FROM CORE.POAMHist
where REPORT_ID = (select REPORT_ID from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID from CORE.VW_ReportSnapshots
                where DataCategory= 'CFACTS')a where rankkForSnap =1)) pom on pom.System_ID=v.system_id
where MitigationStatus in ('open', 'reopened') or (lower(MitigationStatus) = 'fixed' and vm.datemitigated > (current_date() - 60))
group by
FK_PRIMARY_FISMA_ID
,FK_DATACENTER_ID
,v.id
,FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,fk_snapshotID
,dc.Acronym
,Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.dateCreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym
,vm.DeletionReason
,fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end
,FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,A.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,"POA&M ID"
,pom.Overall_Status
) vuln on (vuln.acronym = v.Acronym and vuln.Component_Acronym = v.Component_Acronym )
where v.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
create or replace view V_VULN_DASHBOARD(
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Not using in tableau'
 as
with
CTE_ReportIDs as (
    SELECT top 1 REPORT_ID, REPORT_DATE, 'MTD' as MTDvsEOM FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0))
    UNION ALL
    SELECT top 1 REPORT_ID, REPORT_DATE, 'EOM' as MTDvsEOM FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(1))    
),
Poam as (
    SELECT SYSTEM_ID,POAM_ID,Overall_Status,CVE
    FROM TABLE(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.VW_POAMHIST ph on ph.REPORT_ID = r.REPORT_ID AND CVE IS NOT NULL
)
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,v.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.DW_VUL_ID as FK_dw_vul_number
,v.cve
,v.daysSinceDiscovery
,v.exploitavailable
,v.firstseen
,v.fismaseverity
,v.lastfound
,v.mitigationstatus
,r.REPORT_ID as fk_snapshotid
,s.Acronym
,substring(dc.Acronym, 1, 1) || '***' as Acr_Alias
,s.Component_Acronym
,s.Is_DataCenter
,s.Is_MarketPlace
,s.tlc_phase
,a.Is_Scannable
,v.BODDueDate
,v.FIRSTSEEN as datecreated
,v.datemitigated
,s.HVAStatus
,s.MEFStatus
,dc.acronym as data_center_name
,NULL as DeletionReason
,pluginID as fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when v.IS_BOD = 1 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by r.REPORT_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,v.DW_ASSET_ID as FK_AssetID
,a.computer_type
,a.os
,a.bios_guid
,NULL as source_tool
,a.environment
,a.asset_id_tattoo
,a.os_version
,a.TenableUUID
,a.DeviceType
,r.MTDvsEOM
,s.OATO_Category
,v.CVSSV2BASESCORE as cvss2basescore
,v.CVSSV3BASESCORE as cvss3basescore
,a.VulnRiskTolerance as VRT
,pom.POAM_ID as "POA&M ID"
,pom.Overall_Status
from CTE_ReportIDs r
JOIN CORE.VW_VULHIST v on v.REPORT_ID = r.REPORT_ID
left outer JOIN CORE.Asset a on a.dw_Asset_ID = v.dw_Asset_ID
right outer join CORE.VW_SYSTEMS s ON s.SYSTEM_ID = v.SYSTEM_ID
left outer join CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = v.DATACENTER_ID
left outer join (select DW_VUL_ID,max(PLUGIN_ID) as pluginID FROM CORE.VulPlugin group by DW_VUL_ID) plugs on plugs.DW_VUL_ID = v.DW_VUL_ID
left outer join (select DW_PLUGIN_ID,solution,familyname,PLUGIN_ID,signature from CORE.Plugins) p on p.DW_PLUGIN_ID = plugs.pluginID
left outer join poam pom on pom.SYSTEM_ID = v.SYSTEM_ID;
create or replace view V_VULN_DASHBOARD1(
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Not using in tableau'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)),
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r),
Poam as (
SELECT ID as System_ID,"POA&M ID" as POAM_ID,"Overall_Status" as Overall_Status -- 231027 use ID, "POA&M ID", "Overall_Status"
FROM RPT.V_POAMHist -- 231027 was VW_POAMHist
where "ReportID" = (select Report_ID from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID from CORE.VW_ReportSnapshots
	where DataCategory= 'CFACTS')a where rankkForSnap =1)
)
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,V.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.ID as FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,snap.snapshot_ID as FK_snapshotID
,dc.Acronym
,substring(dc.Acronym, 1, 1) + '***' as Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.dateCreated as datecreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym as data_center_name
,vm.DeletionReason
,p.dw_plugin_ID as fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by snap.snapshot_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,a.dw_asset_id as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,NULL as source_tool -- where is source_tool?
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,A.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,a.VulnRiskTolerance VRT
,pom.poam_id as "POA&M ID"
,pom.Overall_Status
from CORE.vw_vulhist v 
join CORE.reportsnapshots RC on v.report_id = RC.REPORT_ID
JOIN SnapShots snap on RC.Snapshot_ID = snap.snapshot_ID
left outer JOIN CORE.VW_Assets A ON V.dw_Asset_ID = A.dw_Asset_ID
right outer join (select ID as SYSTEM_ID,"Acronym" as Acronym,"Component_Acronym" as Component_Acronym,"Is_DataCenter" as Is_DataCenter,"Is_MarketPlace" as Is_MarketPlace,"HVAStatus" as HVAStatus,"MEFStatus" as MEFStatus, "TLC_Phase" as tlc_phase, "OATO_Category" as OATO_Category from rpt.V_Systems) DC ON DC.SYSTEM_ID = V.SYSTEM_ID -- 231017 was VW_Systems
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog) bodcat on bodcat.CVE = V.cve
left join (select dw_vul_id,datemitigated,NULL as DeletionReason,FIRSTSEEN as datecreated, CVSSV2BASESCORE as cvss2basescore, CVSSV3BASESCORE as cvss3basescore from CORE.VW_VulMaster) vm on vm.dw_vul_id = v.dw_vul_id
left outer join (select ID as system_id,"Acronym" as acronym from rpt.V_Systems) data_center ON data_center.SYSTEM_ID = V.datacenter_id -- 231017 was VW_Systems
left outer join (select dw_vul_id,max(PLUGIN_ID)  as pluginID FROM CORE.VulPlugin vp group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.dw_vul_id)
left outer join (select DW_PLUGIN_ID,solution,familyname,plugin_id,signature from CORE.Plugins) p on (p.DW_PLUGIN_ID = plugs.pluginID)
left outer join Poam pom on pom.System_ID=v.System_ID
where lower(MitigationStatus) in ('open', 'repoened') or (lower(MitigationStatus) = 'fixed' and vm.datemitigated > (current_date() - 60));
create or replace view V_VULN_DASHBOARD2(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Not using in tableau'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)),
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r)

select  v.Acronym as v_acr,v.Component_Acronym as v_comp_acr ,v.TLC_Phase v_tlc_phase,v.HVAStatus as v_hva_stat,v.Is_MarketPlace as v_is_mrkt_plc,v.MEFStatus as v_mef_status,
case when vuln.acronym is null then concat(v.Acronym,'*') else v.Acronym end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS v
left outer join
(
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,v.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.ID as FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,snap.snapshot_id as snapshotid
,dc.Acronym
,substring(dc.Acronym, 1, 1) || '***' as Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.dateCreated as datecreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym as data_center_name
,vm.DeletionReason
,p.dw_plugin_ID as fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by SNAPSHOTID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,a.dw_asset_id as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,NULL as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,cast(SUM(IFF(vm.dw_vul_id is null,0,daysSinceDiscovery*cast(vm.cvss2basescore as float)* dc.OATO_Category*IFF(exploitAvailable='Yes',2,1)))/IFF(count(1)=0,1,count(1)) as decimal(10,2)) as VRT
,pom.POAM_ID as "POA&M ID"
,pom.Overall_Status
from CORE.VW_VULHIST v 
join CORE.reportsnapshots RC on v.report_id = RC.REPORT_ID
JOIN SnapShots snap on RC.Snapshot_ID = snap.snapshot_ID
left outer JOIN CORE.Asset A ON V.DW_Asset_ID = A.DW_Asset_ID
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DeviceType
left outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus,TLC_Phase,OATO_Category from CORE.VW_Systems) DC ON DC.SYSTEM_ID = V.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog) bodcat  on bodcat.CVE = V.cve
left join (select dw_vul_id,datemitigated,DeletionReason,firstseen as datecreated,  CVSSV2BASESCORE as cvss2basescore, CVSSV3BASESCORE as cvss3basescore from CORE.VulMaster)vm on vm.dw_vul_id = v.dw_vul_id
left outer join (select SYSTEM_ID,Acronym from CORE.VW_Systems) data_center ON data_center.SYSTEM_ID = V.datacenter_id
left outer join (select dw_vul_id,max(PLUGIN_ID)  as pluginID FROM CORE.VulPlugin vp group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.dw_vul_id)
left outer join (select DW_PLUGIN_ID,solution,familyname,plugin_id,signature from CORE.Plugins) p on (p.DW_PLUGIN_ID = plugs.pluginID)
left outer join (SELECT System_ID,POAM_ID,Overall_Status FROM CORE.POAMHist
                 where Report_ID = (select Report_ID from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID from CORE.VW_ReportSnapshots 
                                    where DataCategory= 'CFACTS')a where rankkForSnap =1)
                ) pom on pom.System_ID=v.System_ID
where MitigationStatus in ('open', 'repoened') or (MitigationStatus = 'FIXED' and vm.datemitigated > (current_date() - 60))
group by
FK_PRIMARY_FISMA_ID
,FK_DATACENTER_ID
,v.id
,FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,snapshotid
,dc.Acronym
,Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,datecreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center_name
,vm.DeletionReason
,fk_pluginID
,p.solution
,p.familyname
,p.signature
,bodcat.Is_Deleted 
,FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,"POA&M ID"
,pom.Overall_Status
) vuln on vuln.acronym = v.Acronym and vuln.Component_Acronym = v.Component_Acronym 
where v.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
create or replace view V_VULN_DASHBOARD_SYSTEMVRT(
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Not using in tableau'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)),
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r),
Poam as (
SELECT "FK_SystemID" as System_ID,"POA&M ID" as POAM_ID,"Overall_Status" as Overall_Status
FROM RPT.V_POAMHist
where "ReportID" = (select Report_ID from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID from CORE.VW_ReportSnapshots
	where DataCategory= 'CFACTS')a where rankkForSnap =1)
)
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,v.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.ID as FK_dw_vul_number
,v.cve
,v.daysSinceDiscovery
,v.exploitavailable
,vm.firstseen
,v.fismaseverity
,v.lastfound
,v.mitigationstatus
,snap.snapshot_ID as FK_snapshotID
,sys.Acronym
,substring(sys.Acronym, 1, 1) || '***' as Acr_Alias
,sys.Component_Acronym
,sys.Is_DataCenter
,sys.Is_MarketPlace
,tlc_phase
,a.Is_Scannable
,vm.BODDueDate
,vm.FIRSTSEEN as datecreated
,vm.datemitigated
,sys.HVAStatus
,sys.MEFStatus
,dc.acronym as data_center_name
,vm.DeletionReason
,PI.dw_plugin_ID as fk_pluginID
,PI.solution
,PI.familyname
,PI.signature
,case when vm.IS_KEV = 1 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by snap.snapshot_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,a.dw_asset_id as FK_AssetID
,a.computer_type
,a.os
,a.bios_guid
,NULL as source_tool -- where is source_tool?
,a.environment
,a.asset_id_tattoo
,a.os_version
,a.TenableUUID
,a.DeviceType
,snap.MTDvsEOM
,sys.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,ss.VulnRiskTolerance VRT
,pom.poam_id as "POA&M ID"
,pom.Overall_Status
from CORE.VW_VULHIST v 
--join CORE.reportsnapshots RC on v.report_id = RC.REPORT_ID
JOIN SnapShots snap on snap.REPORT_ID = v.REPORT_ID
left outer JOIN CORE.VW_Assets a ON V.dw_Asset_ID = a.dw_Asset_ID

right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus, tlc_phase, OATO_Category from CORE.VW_Systems) sys ON sys.SYSTEM_ID = V.SYSTEM_ID
-- 240222 CR840 chg from table SYSTEMSUMMARY to view VW_SYSTEMSUMMARY
LEFT JOIN (select SYSTEM_ID, VulnRiskTolerance from CORE.VW_SYSTEMSUMMARY where REPORT_ID = (select max(REPORT_ID) from ReportIDs)) SS ON SS.System_ID = sys.System_ID

--LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog) bodcat on bodcat.CVE = V.cve
left join (select BODDUEDATE,dw_vul_id,datemitigated,NULL as DeletionReason,FIRSTSEEN, CVSSV2BASESCORE as cvss2basescore, CVSSV3BASESCORE as cvss3basescore, IS_KEV from CORE.VW_VulMaster) vm on vm.dw_vul_id = v.dw_vul_id
left outer join (select system_id,acronym from CORE.VW_Systems) dc ON dc.SYSTEM_ID = V.datacenter_id

left outer join (select dw_vul_id,max(PLUGIN_ID) as pluginID FROM CORE.VulPlugin vp group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.dw_vul_id)
left outer join (select DW_PLUGIN_ID,solution,familyname,plugin_id,signature from CORE.Plugins) PI on (PI.DW_PLUGIN_ID = plugs.pluginID)
left outer join Poam pom on pom.System_ID = v.System_ID;
create or replace view V_VULN_DASHBOARD_TRENDING(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Contains all the summarized Vulnerabilities for latest 12 month end and current day snapshots at Org Hierarchy level'
 as
SELECT * FROM RPT.TEMP_VULN_TRENDING;
create or replace view V_VULN_DATASET(
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Not using in tableau'
 as
with
ReportIDs as ((select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select Report_ID,Report_Date, snapshot_ID, Is_endOfMonth from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date, Snapshot_ID, Is_endOfMonth from CORE.VW_ReportSnapshots
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)),
Snapshots as (select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r),
Poam as (
SELECT System_ID,POAM_ID,Overall_Status,CVE
FROM CORE.VW_POAMHIST
where Report_ID = (select Report_ID from (select rank()over(partition by DataCategory order by Report_Date desc) rankkForSnap,Report_ID,Report_Date,Snapshot_ID from CORE.VW_ReportSnapshots
	where DataCategory= 'CFACTS')a where rankkForSnap =1)
AND CVE IS NOT NULL
)
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,V.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.ID as FK_dw_vul_number
,v.cve
,daysSinceDiscovery
,exploitavailable
,firstseen
,fismaseverity
,lastfound
,mitigationstatus
,snap.snapshot_ID as snapshotID
,dc.Acronym
,substring(dc.Acronym, 1, 1) || '***' as Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.dateCreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym as data_center_name
,vm.DeletionReason
,p.dw_plugin_ID as fk_pluginID
,p.solution
,p.familyname
,p.signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by snap.snapshot_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM ReportIDs where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,a.dw_asset_id as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,NULL as source_tool -- where is source_tool?
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.cvss2basescore
,vm.cvss3basescore
,a.VulnRiskTolerance as VRT
,pom.POAM_ID as "POA&M ID"
,pom.Overall_Status
from CORE.vw_vulhist v 
join CORE.reportsnapshots RC on v.report_id = RC.REPORT_ID
JOIN SnapShots snap on RC.Snapshot_ID = snap.snapshot_ID
left outer JOIN CORE.VW_Assets A ON V.dw_Asset_ID = A.dw_Asset_ID
left outer JOIN CORE.VW_DEVICETYPES D ON a.DeviceType=D.DeviceType
right outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus, tlc_phase, OATO_Category from CORE.VW_SYSTEMS) DC ON DC.SYSTEM_ID = V.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog) bodcat on bodcat.CVE = V.cve
left join (select dw_vul_id,datemitigated,NULL as DeletionReason,FIRSTSEEN as datecreated, CVSSV2BASESCORE as cvss2basescore, CVSSV3BASESCORE as cvss3basescore from CORE.VW_VulMaster) vm on vm.dw_vul_id = v.dw_vul_id
left outer join (select system_id,acronym from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = V.datacenter_id
left outer join (select dw_vul_id,max(PLUGIN_ID) as pluginID FROM CORE.VulPlugin vp group by dw_vul_id) plugs on (plugs.dw_vul_id = vm.dw_vul_id) -- 231027 had DW_PLUGIN_ID
left outer join (select DW_PLUGIN_ID,solution,familyname,plugin_id,signature from CORE.Plugins) p on (p.DW_PLUGIN_ID = plugs.pluginID)
left outer join Poam pom on pom.System_ID=v.System_ID -- pom.CVE=v.CVE and
where lower(MitigationStatus) in ('open', 'reopened') or (lower(MitigationStatus) = 'fixed' and vm.datemitigated > (current_date() - 60));
create or replace view V_VULN_ROLLING60DAYS(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) COMMENT='Contains all the Vulnerabilities for latest 2 snapshots (Current/EOM) with granular CVE IDs for each system/data Center/component'
 as
SELECT * FROM RPT.TEMP_VULN_FV_ROLLING60DAYS;
create or replace view V_VULREMEDIATED(
	DATACENTERACRONYM,
	SYSTEMACRONYM,
	REMEDIATEDCURMONTH,
	REMEDIATEDPRIORMONTH
) COMMENT='Returns remediated CVE count for current and previous month'
 as
WITH
dateFilters as (select cast(cast(MONTH(CURRENT_TIMESTAMP) as varchar) || '/01/' || cast(year(CURRENT_TIMESTAMP) as varchar) as date) as startOfcurMonth
,cast(cast(MONTH(DATEADD(M,-1,CURRENT_TIMESTAMP)) as varchar) || '/01/' || cast(year(DATEADD(M,-1,CURRENT_TIMESTAMP)) as varchar) as date) as startOfprevMonth
),
prevMonth as (select a.DATACENTER_ID,count(1) remediatedPriorMonth
	from CORE.VW_VulMaster vm
	JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
	where vm.datemitigated >= (select startOfprevMonth from dateFilters)
	and vm.datemitigated < (select startOfcurMonth from dateFilters)
	GROUP BY a.DATACENTER_ID
),
curMonth as (select a.DATACENTER_ID,count(1) remediatedCurMonth
	from CORE.VW_VulMaster vm
	JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
	where vm.datemitigated >= (select startOfcurMonth from dateFilters)
	and vm.datemitigated < CURRENT_TIMESTAMP
	GROUP BY a.DATACENTER_ID
)
select 
s.PRIMARY_OPERATING_LOCATION_ACRONYM DataCenterAcronym
,s.Acronym as SystemAcronym
,coalesce(cm.remediatedCurMonth,0) as remediatedCurMonth
,coalesce(pm.remediatedPriorMonth,0) as remediatedPriorMonth
FROM CORE.VW_SYSTEMS s
left outer join prevMonth pm on pm.DATACENTER_ID = s.SYSTEM_ID
left outer join curMonth cm on cm.DATACENTER_ID = s.SYSTEM_ID
where pm.DATACENTER_ID is not null OR cm.DATACENTER_ID IS NOT NULL
;
CREATE OR REPLACE FUNCTION "SF_SEND_SLACK_MESSAGE"("MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION_CRM)
SECRETS = ('crm_sdw_url'=SLACK_CRM_SDW_WEBHOOK_URL)
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import date

def main(msg): 
    # Retrieve the Webhook URL from the SECRET object
    webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    
    slack_data = {
     "text": f"Snowflake alert: {msg}"
    }

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
CurSnap number;
PreSnap number;
CurReportId number;
PreReportId number;
CurReportDate datetime;
PreReportDate datetime;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Snap (REPORTSNAPSHOTID number,
	DATACATEGORY varchar,
	REPORT_ID number,
	REPORT_DATE timestamp,
	IS_ENDOFMONTH boolean,
	SNAPSHOT_ID number,
	SNAPSHOT_DATE timestamp,
	MIN_DATE timestamp,
	MAX_DATE timestamp);
    
select * into temp_Snap from
CORE.VW_REPORTSNAPSHOTS where DATACATEGORY = ''CFACTS'' order by Report_ID desc; 

CurSnap := (select max(Snapshot_ID) from temp_Snap);
PreSnap := (select min(Snapshot_ID) from temp_Snap);

CurReportId := (select max(Snapshot_ID) from temp_Snap);
PreReportId := (select min(Snapshot_ID) from temp_Snap);

CurReportDate := (select Report_Date from temp_Snap where Snapshot_ID = CurSnap);
PreReportDate := (select Report_Date from temp_Snap where Snapshot_ID = PreSnap);

-- Checking acronyms
select Component_Acronym, Group_Acronym, Acronym, TLC_Phase, s.dateCreated into temp_Validate from Systems s
join Components c on c.COMPONENTNAME = s.COMPONENT_NAME
join Groups g on g.GROUPNAME = s.GROUP_NAME
where Acronym not in (select Systems from rpt.CRR_Component_Params) and TLC_Phase <> ''Retire'' and Component_Acronym <> ''Not specified'';

delete from temp_Validate where GroupAcronym not in (
Select distinct g.Groups from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.ComponentAcronym
join rpt.CRR_Group_Params G on g.ReportName = C.ReportName 
) and ComponentAcronym not in (
Select distinct C.Component from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.ComponentAcronym
join rpt.CRR_Group_All_Params G on g.ReportName = C.ReportName 
);

select * from temp_Validate;
drop table temp_Validate;

--Checking for component name changes 
select DISTINCT a.SystemID, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=CurSnap) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=PreSnap) B
ON a.SystemID = B.SystemID
AND A.Component_Acronym<>b.Component_Acronym;

--Checking for Group name changes 
select DISTINCT a.SystemID, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=CurSnap) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=PreSnap) B
ON a.SystemID = B.SystemID
WHERE  A.Group_Acronym<>B.Group_Acronym;

--Checking for XLC Phase changes 
select DISTINCT a.SystemID,a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=CurSnap) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE SnapshotID=PreSnap) B
ON a.SystemID = B.SystemID
WHERE  A.TLC_Phase<>B.TLC_Phase;

-- Removed Systems 
select  Acronym from V_SystemsSummary where ReportID=PreReportId 
except
select  Acronym from V_SystemsSummary where ReportID=CurReportId;

-- Added Systems 
select  Acronym from V_SystemsSummary where ReportID=CurReportId 
except
select  Acronym from V_SystemsSummary where ReportID=PreReportId;

/*DW Data file egenrated is checked for counts and compared with counts below from the views and they have to match*/
select count(*), FISMAseverity from rpt.V_CyberRisk_VUL_Detail  group by FISMAseverity;
select count(*), FISMAseverity from rpt.V_VulCur group by FISMAseverity;

Select top 3 * from SnapShotIDs order by SnapshotDate desc;
Select ''System'', max(SnapshotID) SnapshotID, Count(SnapshotID) as Ssystem FROM CORE.SystemsHist union all
Select ''CAA'', max(SnapshotID) SnapshotID, Count(SnapshotID) as CAAT from CAATHist union all
Select ''POAM'', max(SnapshotID) SnapshotID, Count(SnapshotID) as POAM from POAMHist union all
Select ''PIA'', max(SnapshotID) SnapshotID, Count(SnapshotID) as PIA from PIAHist union all
Select ''Milestone'', max(SnapshotID) SnapshotID, Count(SnapshotID) as MS from MilestoneHist ;

drop table temp_Snap;
  
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_ACRONYM"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
res RESULTSET;


BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

-- Checking acronyms
CREATE TEMPORARY TABLE temp_Validate (
	COMPONENT_ACRONYM varchar,
	GROUP_ACRONYM varchar,
	ACRONYM varchar,
    TLC_PHASE varchar,
    FIRST_PUBLISHED_DATE Date
	);
INSERT INTO temp_Validate select Component_Acronym, Group_Acronym, Acronym, TLC_Phase, first_published_date from CORE.SYSTEMS s
where Acronym not in (select Systems from rpt.CRR_Component_Params) and TLC_Phase <> ''Retire'' and Component_Acronym <> ''Not specified'';

delete from temp_Validate where Group_Acronym not in (
Select distinct c.groups from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.Component_Acronym
) and Component_Acronym not in (
Select distinct C.Component from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.Component_Acronym
);

res := (select * from temp_Validate);
drop table temp_Validate;
  
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

RETURN TABLE(res);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_ASSETVULCOUNT"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
CurSnap number;
PreSnap number;
CurReportId number;
PreReportId number;
CurReportDate datetime;
PreReportDate datetime;
res RESULTSET;
res1 RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

res:= (select acronym, mcrr."Total Assets" MCRR_Total_Assets, VULN.assets Total_Assets, mcrr."Total Vulnerabilites" + mcrr."VulMedium" + mcrr."VulLow" as mcrr_Total_Vulnerabilites, VULN.vulcritical + VULN.vulhigh + VULN.vulmedium + VULN.vullow Total_Vulnerabilites, mcrr."Critical Vulnerabilities" MCRR_Critical_Vulnerabilities, VULN.vulcritical Critical_Vulnerabilities, mcrr."High Vulnerabilities" MCRR_High_Vulnerabilities, VULN.vulhigh High_Vulnerabilities, mcrr."VulMedium" mcrr_vulmedium, VULN.vulmedium, mcrr."VulLow" mcrr_vullow, VULN.vullow 
from rpt.V_CyberRisk_System_Summary mcrr
JOIN CORE.VW_SYSTEMSUMMARY VULN on VULN.acronym = mcrr."System" where 
VULN.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1)
UNION
select ''Total'' as acronym, sum(mcrr."Total Assets") MCRR_Total_Assets, sum(VULN.assets) Total_Assets, sum(mcrr."Total Vulnerabilites" + mcrr."VulMedium" + mcrr."VulLow") as mcrr_Total_Vulnerabilites, sum(VULN.vulcritical + VULN.vulhigh + VULN.vulmedium + VULN.vullow) Total_Vulnerabilites, sum(mcrr."Critical Vulnerabilities") MCRR_CRITICAL_VULNERABILITIES, sum(VULN.vulcritical) CRITICAL_VULNERABILITIES, sum(mcrr."High Vulnerabilities") MCRR_HIGH_VULNERABILITIES, sum(VULN.vulhigh) HIGH_VULNERABILITIES, sum(mcrr."VulMedium") mcrr_vulmedium, sum(VULN.vulmedium) vulmedium, sum(mcrr."VulLow") mcrr_vullow, sum(VULN.vullow) vullow from rpt.V_CyberRisk_System_Summary mcrr JOIN CORE.VW_SYSTEMSUMMARY VULN on VULN.acronym = mcrr."System" where VULN.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1)
);


CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

RETURN TABLE(res);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_COMPONENT"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
CurSnap number;
PreSnap number;
CurReportId number;
PreReportId number;
CurReportDate datetime;
PreReportDate datetime;
res RESULTSET;
res1 RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Snap (
	REPORT_ID number,
	REPORT_DATE timestamp,
	IS_ENDOFMONTH boolean
	);
    
INSERT into temp_Snap SELECT REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM core.report_ids;

CurSnap := (select max(Report_ID) from temp_Snap);
PreSnap := (select max(Report_ID) - 30 from temp_Snap where is_endofmonth = 1);

CurReportId := (select max(Report_ID) from temp_Snap);
PreReportId := (select max(Report_ID) - 30 from temp_Snap where is_endofmonth = 1);

--Checking for component name changes 
res := (select DISTINCT a.System_ID, a.ACRONYM NEWACRONYM, b.ACRONYM OLDACRONYM, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE Report_ID = (select max(Report_ID) from temp_Snap)) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) - 30 from temp_Snap)) B
ON a.System_ID = B.System_ID
AND A.Component_Acronym<>b.Component_Acronym);

drop table temp_Snap;
  
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

RETURN TABLE(res);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_GROUP"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
CurSnap number;
PreSnap number;
CurReportId number;
PreReportId number;
CurReportDate datetime;
PreReportDate datetime;
res RESULTSET;
res1 RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Snap (
	REPORT_ID number,
	REPORT_DATE timestamp,
	IS_ENDOFMONTH boolean
	);
    
INSERT into temp_Snap SELECT REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM core.report_ids;

CurSnap := (select max(Report_ID) from temp_Snap);
PreSnap := (select max(Report_ID) from temp_Snap where is_endofmonth = 1);

CurReportId := (select max(Report_ID) from temp_Snap);
PreReportId := (select max(Report_ID) from temp_Snap where is_endofmonth = 1);

--Checking for Group name changes 
res := (select DISTINCT a.System_ID, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap)) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1)) B
ON a.System_ID = B.System_ID
WHERE  A.Group_Acronym<>B.Group_Acronym);

drop table temp_Snap;
  
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

RETURN TABLE(res);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_NEW"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
CurSnap number;
PreSnap number;
CurReportId number;
PreReportId number;
CurReportDate datetime;
PreReportDate datetime;
res RESULTSET;
res1 RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Snap (
	REPORT_ID number,
	REPORT_DATE timestamp,
	IS_ENDOFMONTH boolean
	);
    
INSERT into temp_Snap SELECT REPORT_ID, REPORT_DATE, IS_ENDOFMONTH FROM core.report_ids;

CurSnap := (select max(Report_ID) from temp_Snap);
PreSnap := (select max(Report_ID) from temp_Snap where is_endofmonth = 1);

CurReportId := (select max(Report_ID) from temp_Snap);
PreReportId := (select max(Report_ID) from temp_Snap where is_endofmonth = 1);

-- Checking acronyms
CREATE TEMPORARY TABLE temp_Validate (
	COMPONENT_ACRONYM varchar,
	GROUP_ACRONYM varchar,
	ACRONYM varchar,
    TLC_PHASE varchar,
    FIRST_PUBLISHED_DATE Date
	);
INSERT INTO temp_Validate select Component_Acronym, Group_Acronym, Acronym, TLC_Phase, first_published_date from CORE.SYSTEMS s
where Acronym not in (select Systems from rpt.CRR_Component_Params) and TLC_Phase <> ''Retire'' and Component_Acronym <> ''Not specified'';

delete from temp_Validate where Group_Acronym not in (
Select distinct c.groups from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.Component_Acronym
) and Component_Acronym not in (
Select distinct C.Component from temp_Validate temp
join rpt.CRR_Component_Params C on C.Component = temp.Component_Acronym
);

select * from temp_Validate;
drop table temp_Validate;

--Checking for component name changes 
res := (select DISTINCT a.System_ID, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap)) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1)) B
ON a.System_ID = B.System_ID
AND A.Component_Acronym<>b.Component_Acronym);

--Checking for Group name changes 
res1 := (select DISTINCT a.System_ID, a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap)) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1)) B
ON a.System_ID = B.System_ID
WHERE  A.Group_Acronym<>B.Group_Acronym);

--Checking for XLC Phase changes 
select DISTINCT a.System_ID,a.Group_Acronym AS NEWGROUP,b.Group_Acronym  AS OLDGROUP
,A.TLC_Phase AS NEWPHASE,B.TLC_Phase AS OLDPHASE,A.Component_Acronym AS NEWCOMPONENT,B.Component_Acronym AS OLDCOMPONENT
from (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap)) A
INNER JOIN (SELECT * FROM CORE.SystemsHist WHERE Report_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1)) B
ON a.System_ID = B.System_ID
WHERE  A.TLC_Phase<>B.TLC_Phase;

-- Removed Systems 
select  Acronym from CORE.VW_SYSTEMSUMMARY where REPORT_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1) 
except
select  Acronym from CORE.VW_SYSTEMSUMMARY where REPORT_ID=(select max(Report_ID) from temp_Snap);

-- Added Systems 
select  Acronym from CORE.VW_SYSTEMSUMMARY where REPORT_ID=(select max(Report_ID) from temp_Snap) 
except
select  Acronym from CORE.VW_SYSTEMSUMMARY where REPORT_ID=(select max(Report_ID) from temp_Snap where is_endofmonth = 1);

drop table temp_Snap;
  
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);

RETURN TABLE(res);
RETURN TABLE(res1);

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_ROWBYROWCHECK"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
accumulator number;
accumulator1 number;
res RESULTSET DEFAULT (select mcrr."System", mcrr."Total Assets", hwam.assets from rpt.V_CyberRisk_System_Summary mcrr join CORE.VW_SYSTEMSUMMARY HWAM on hwam.acronym = mcrr."System" where HWAM.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1) and mcrr."Total Assets" != hwam.assets);
cur1 CURSOR FOR res;

res1 RESULTSET DEFAULT (select acronym, mcrr."Total Vulnerabilites" + mcrr."VulMedium" + mcrr."VulLow" as mcrr_Total_Vulnerabilites, VULN.vulcritical + VULN.vulhigh + VULN.vulmedium + VULN.vullow Total_Vulnerabilites, VULN.vulcritical, VULN.vulhigh, mcrr."VulMedium" mcrr_vulmedium, VULN.vulmedium, mcrr."VulLow" mcrr_vullow, VULN.vullow from rpt.V_CyberRisk_System_Summary mcrr JOIN CORE.VW_SYSTEMSUMMARY VULN on VULN.acronym = mcrr."System" where VULN.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1) and mcrr_Total_Vulnerabilites != Total_Vulnerabilites);
cur2 CURSOR FOR res1;

res2 RESULTSET;
result VARCHAR(16777216);

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Assets (
	AssetMatch varchar);    

FOR row_variable IN cur1 DO
          accumulator := accumulator + row_variable.a;
      END FOR;

FOR row_variable IN cur2 DO
          accumulator1 := accumulator1 + row_variable.a;
      END FOR;    

if (accumulator is NULL and accumulator1 is NULL) then 
    result := 0;
else 
    result := 1;

end if;
drop table temp_Assets;
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);


    
RETURN result;

   


EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CRRPRECHECKS_ROWBYROWCHECK1"()
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for CRRPreChecks'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_CRRPreChecks'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
accumulator number;
accumulator1 number;
res RESULTSET DEFAULT (select mcrr."System", mcrr."Total Assets", hwam.assets from rpt.V_CyberRisk_System_Summary mcrr join CORE.VW_SYSTEMSUMMARY HWAM on hwam.acronym = mcrr."System" where HWAM.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1) and mcrr."Total Assets" != hwam.assets);
cur1 CURSOR FOR res;

res1 RESULTSET DEFAULT (select acronym, mcrr."Total Vulnerabilites" + mcrr."VulMedium" + mcrr."VulLow" as mcrr_Total_Vulnerabilites, VULN.vulcritical + VULN.vulhigh + VULN.vulmedium + VULN.vullow Total_Vulnerabilites, VULN.vulcritical, VULN.vulhigh, mcrr."VulMedium" mcrr_vulmedium, VULN.vulmedium, mcrr."VulLow" mcrr_vullow, VULN.vullow from rpt.V_CyberRisk_System_Summary mcrr JOIN CORE.VW_SYSTEMSUMMARY VULN on VULN.acronym = mcrr."System" where VULN.report_id = (select max(report_id) from core.report_ids where is_endofmonth = 1) and mcrr_Total_Vulnerabilites != Total_Vulnerabilites);
cur2 CURSOR FOR res1;

res2 RESULTSET;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE(:Appl);

CREATE TEMPORARY TABLE temp_Assets (
	AssetMatch varchar);    

FOR row_variable IN cur1 DO
          accumulator := accumulator + row_variable.a;
      END FOR;

FOR row_variable IN cur2 DO
          accumulator1 := accumulator1 + row_variable.a;
      END FOR;    

if (accumulator is NULL and accumulator1 is NULL) then 
    INSERT INTO temp_Assets (AssetMatch) VALUES (''Asset counts Matched successfully'');
    INSERT INTO temp_Assets (AssetMatch) VALUES (''Vulnerability counts Matched successfully'');
    res2 := (select * from temp_Assets);

elseif (accumulator is NULL and accumulator1 > 0) then  
    INSERT INTO temp_Assets (AssetMatch) VALUES (''Asset counts Matched successfully'');
    INSERT INTO temp_Assets (AssetMatch) VALUES (''Vulnerability counts did not Match'');
    res2 := (select * from temp_Assets);
 
elseif (accumulator > 0 and accumulator1 is NULL) then
   INSERT INTO temp_Assets (AssetMatch) VALUES (''Asset counts did not Match'');
   INSERT INTO temp_Assets (AssetMatch) VALUES (''Vulnerability counts Matched successfully'');
   res2 := (select * from temp_Assets);

else 
    INSERT INTO temp_Assets (AssetMatch) VALUES (''Both Assets and Vulnerability counts are not Matched'');
   res2 := (select * from temp_Assets);

end if;
drop table temp_Assets;
CALL CORE.SP_CRM_END_PROCEDURE(:Appl);


    
RETURN TABLE(res2);

   


EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_EXEC_MCRRPROC"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for MCRR'
EXECUTE AS OWNER
AS '

BEGIN
TRUNCATE TABLE RPT.TEMPTABLE_MCRR;
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCIIO'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCIIO [Market]'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCSQ'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CM'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CM-MCMG'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CMCS'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CMMI'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CPI'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OACT'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OAGM'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHEI'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OC'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OEDA'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OFM'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHC'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHI'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT ESSG wCM'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT-AMG'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT EADG'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT ISPG'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT IUSG'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OMH'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OPOLE'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OSFLO'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OSORA'');
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''[Market]'');
;

return ''Success'';



END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_EXEC_MCRRPROC"("MONTH" NUMBER(38,0), "YEAR" NUMBER(38,0), "PREMONTH" NUMBER(38,0), "PREYEAR" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for MCRR'
EXECUTE AS OWNER
AS '

BEGIN
TRUNCATE TABLE RPT.TEMPTABLE_MCRR;
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCIIO'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCIIO [Market]'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CCSQ'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CM'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CM-MCMG'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CMCS'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CMMI'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''CPI'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OACT'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OAGM'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHEI'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OC'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OEDA'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OFM'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHC'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OHI'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT ESSG wCM'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT-AMG'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT EADG'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT ISPG'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OIT IUSG'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OMH'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OPOLE'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OSFLO'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''OSORA'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
CALL RPT.SP_CRM_TEMPTABLE_MCRR(''[Market]'', :MONTH, :YEAR, :PREMONTH, :PREYEAR);
;

return ''Success'';



END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEMPTABLE_MCRR"("P_ACHRONYM" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for MCRR'
EXECUTE AS OWNER
AS '

BEGIN

CREATE TEMPORARY TABLE temp_CRMReport AS
 select 
	params.ReportName,
	rptsummary.acronym,
	Months.report_id,
	Months.report_date,
    rptsummary.Assets,
    s.Next_Required_CP_Test_Date,
    s.component_acronym,
    s.Auth_Decision,
    s.Date_Auth_Memo_Expires,
    s.Is_OA_Ready,
    s.OA_Status,
	rptsummary.AssetRiskTolerance,
	rptsummary.ResidualRisk,
	rptsummary.ResiliencyScore,
	rptsummary.VulnRiskTolerance,
	css."Critical Vulnerabilities" as tot_crit_vulns,
	css."High Vulnerabilities" as tot_high_vulns,
	s.TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS , 
	VULHIGH_GT60DAYS ,
	VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	VULCRITICAL_GT15_LTE60DAYS ,
	vuluniquehigh_gt30_lte60days , 
	vulhigh_gt30_lte60days ,
	VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	VULCRITICAL_GT30_LTE60DAYS ,
	vulmedium , 
	vullow ,
	vuluniquemedium , 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened
from CORE.VW_SYSTEMSUMMARY rptsummary
JOIN  (select distinct report_id,report_date from (select report_id,report_date,rank()over(order by report_date desc) as rankk from core.report_ids where Is_endOfMonth=1) a where rankk <=2) Months
ON Months.report_id=rptsummary.REPORT_ID
JOIN rpt.CRR_Component_Params params ON params.Systems=rptsummary.acronym
JOIN CORE.VW_SYSTEMS s ON s.Acronym=rptsummary.Acronym
join rpt.V_CyberRisk_System_Summary css on css."System" = s.Acronym
WHERE params.ReportName=:P_ACHRONYM;

CREATE TEMPORARY TABLE temp_CRMPOAMReport AS
Select distinct 
params.ReportName,
	s.acronym,
    Months.report_id,
	Months.REPORT_DATE,
    Count(P.poam_id) as POAMCount, 
	P.weakness_risk_level, 
	P.overall_status
from CORE.VW_POAMHIST P
JOIN  (select distinct report_id,report_date from (select report_id,report_date,rank()over(order by report_date desc) as rankk from core.report_ids where Is_endOfMonth=1) a where rankk <=2) Months
ON Months.REPORT_ID=p.REPORT_ID
inner join CORE.VW_SYSTEMS S
on P.archer_tracking_id = S.Archer_Tracking_ID
Join rpt.CRR_Component_Params params on params.systems = s.acronym where params.ReportName=:P_ACHRONYM
and overall_status not in (''Closed for System Retired'',''Completed'',''Pending Verification'',''Risk Accepted'')
group by all;


CREATE TEMPORARY TABLE temp_CRMOverDueReport AS
select 
reportname,
s.Acronym, 
(select max(report_id) from core.report_ids where is_endofmonth = 1) Report_ID, 
null report_date,
count(CVE) OVERDUE_COUNT, 
OVERDUE_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and OVERDUE_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, OVERDUE_FILTER, reportname;

CREATE TEMPORARY TABLE temp_CRMEPSSReport AS
select 
reportname,
s.acronym, 
(select max(report_id) from core.report_ids where is_endofmonth = 1) Report_ID, 
null report_date,
count(CVE) EPSS_COUNT, 
EPSS_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and EPSS_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, EPSS_FILTER, reportname;

INSERT INTO RPT.TEMPTABLE_MCRR
(
    ReportName,
	acronym,
	report_id,
	report_date,
    Assets,
    Next_Required_CP_Test_Date,
    component_acronym,
    Auth_Decision,
    Date_Auth_Memo_Expires,
    Is_OA_Ready,
    OA_Status,
	AssetRiskTolerance,
	ResidualRisk,
	ResiliencyScore,
	VulnRiskTolerance,
	tot_crit_vulns,
	tot_high_vulns,
	TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS, 
	VULHIGH_GT60DAYS,
	VULUNIQUECRITICAL_GT15_LTE60DAYS, 
	VULCRITICAL_GT15_LTE60DAYS,
	vuluniquehigh_gt30_lte60days, 
	vulhigh_gt30_lte60days,
	VULUNIQUECRITICAL_GT30_LTE60DAYS, 
	VULCRITICAL_GT30_LTE60DAYS,
	vulmedium, 
	vullow,
	vuluniquemedium, 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened,
	POAMCount, 
	weakness_risk_level, 
	Overall_Status,
    OVERDUE_COUNT, 
    OVERDUE_FILTER,
    EPSS_COUNT, 
    EPSS_FILTER
)
 select 
	crm.ReportName,
	crm.acronym,
	crm.report_id,
	report_date,
    Assets,
    Next_Required_CP_Test_Date,
    component_acronym,
    Auth_Decision,
    Date_Auth_Memo_Expires,
    Is_OA_Ready,
    OA_Status,
	AssetRiskTolerance,
	ResidualRisk,
	ResiliencyScore,
	VulnRiskTolerance,
	tot_crit_vulns,
	tot_high_vulns,
	TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS, 
	VULHIGH_GT60DAYS,
	VULUNIQUECRITICAL_GT15_LTE60DAYS, 
	VULCRITICAL_GT15_LTE60DAYS,
	vuluniquehigh_gt30_lte60days, 
	vulhigh_gt30_lte60days,
	VULUNIQUECRITICAL_GT30_LTE60DAYS, 
	VULCRITICAL_GT30_LTE60DAYS,
	vulmedium, 
	vullow,
	vuluniquemedium, 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened,
	POAMCount, 
	weakness_risk_level, 
	Overall_Status,
	OVERDUE_COUNT, 
	OVERDUE_FILTER,
	EPSS_COUNT, EPSS_FILTER
from temp_CRMReport crm
left OUTER JOIN (Select ReportName, Report_Id, acronym, POAMCount, Weakness_Risk_Level, Overall_Status from temp_CRMPOAMReport) poam on poam.ReportName = crm.ReportName and poam.Report_Id = crm.Report_Id and poam.acronym = crm.acronym
LEFT OUTER JOIN (select ReportName, Report_Id, acronym, OVERDUE_COUNT, OVERDUE_FILTER from temp_CRMOverDueReport) OD on OD.ReportName = crm.ReportName and OD.Report_Id = crm.Report_Id and OD.acronym = crm.acronym
LEFT OUTER JOIN (select ReportName, Report_Id, acronym, EPSS_COUNT, EPSS_FILTER from temp_CRMEPSSReport )EPSS on EPSS.ReportName = crm.ReportName and EPSS.Report_Id = crm.Report_Id and EPSS.acronym = crm.acronym
order by report_id, assets;
DROP table temp_CRMReport;
DROP table temp_CRMPOAMReport;
DROP table temp_CRMOverDueReport;
DROP table temp_CRMEPSSReport;
COMMIT;
return ''Success'';


END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEMPTABLE_MCRR"("P_ACHRONYM" VARCHAR(16777216), "MONTH" NUMBER(38,0), "YEAR" NUMBER(38,0), "PREMONTH" NUMBER(38,0), "PREYEAR" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='CRM stored procedure for MCRR'
EXECUTE AS OWNER
AS '

BEGIN
  INSERT INTO RPT.TEMPTABLE_MCRR
(
    ReportName,
	acronym,
	report_id,
	report_date,
    Assets,
    Next_Required_CP_Test_Date,
    component_acronym,
    Auth_Decision,
    Date_Auth_Memo_Expires,
    Is_OA_Ready,
    OA_Status,
	AssetRiskTolerance,
	ResidualRisk,
	ResiliencyScore,
	VulnRiskTolerance,
	tot_crit_vulns,
	tot_high_vulns,
	TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS , 
	VULHIGH_GT60DAYS ,
	VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	VULCRITICAL_GT15_LTE60DAYS ,
	vuluniquehigh_gt30_lte60days , 
	vulhigh_gt30_lte60days ,
	VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	VULCRITICAL_GT30_LTE60DAYS ,
	vulmedium , 
	vullow ,
	vuluniquemedium , 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened,
	POAMCount, 
	Weakness_Risk_Level, 
	Overall_Status,
    OVERDUE_COUNT, 
    OVERDUE_FILTER,
    EPSS_COUNT, 
    EPSS_FILTER
)
 select 
	params.ReportName,
	rptsummary.acronym,
	Months.report_id,
	Months.report_date,
    rptsummary.Assets,
    s.Next_Required_CP_Test_Date,
    s.component_acronym,
    s.Auth_Decision,
    s.Date_Auth_Memo_Expires,
    s.Is_OA_Ready,
    s.OA_Status,
	rptsummary.AssetRiskTolerance,
	rptsummary.ResidualRisk,
	rptsummary.ResiliencyScore,
	rptsummary.VulnRiskTolerance,
	css."Critical Vulnerabilities" as tot_crit_vulns,
	css."High Vulnerabilities" as tot_high_vulns,
	s.TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS , 
	VULHIGH_GT60DAYS ,
	VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	VULCRITICAL_GT15_LTE60DAYS ,
	vuluniquehigh_gt30_lte60days , 
	vulhigh_gt30_lte60days ,
	VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	VULCRITICAL_GT30_LTE60DAYS ,
	vulmedium , 
	vullow ,
	vuluniquemedium , 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened,
	null POAMCount, 
	null Weakness_Risk_Level, 
	null Overall_Status,
    null OVERDUE_COUNT, 
    null OVERDUE_FILTER,
    null EPSS_COUNT, 
    null EPSS_FILTER
from CORE.VW_SYSTEMSUMMARY rptsummary
JOIN  (select report_id,report_date from BUS_CYBER_RISK_MANAGEMENT.core.report_ids where Is_endOfMonth=1 and month(report_date)= :MONTH and year(report_date)= :YEAR
UNION
select report_id,report_date from BUS_CYBER_RISK_MANAGEMENT.core.report_ids where Is_endOfMonth=1 and month(report_date)= :PREMONTH and year(DATE_TRUNC(''month'', DATEADD(''month'', -1, date(report_date))))= :PREYEAR) Months
ON Months.report_id=rptsummary.REPORT_ID
JOIN rpt.CRR_Component_Params params ON params.Systems=rptsummary.acronym
JOIN CORE.VW_SYSTEMS s ON s.Acronym=rptsummary.Acronym
join rpt.V_CyberRisk_System_Summary css on css."System" = s.Acronym
WHERE params.ReportName=:P_ACHRONYM

UNION ALL

Select distinct 
params.ReportName,
	s.acronym,
	null report_id,
	null report_date,
    null Assets,
    null Next_Required_CP_Test_Date,
    null component_acronym,
    null Auth_Decision,
    null Date_Auth_Memo_Expires,
    null Is_OA_Ready,
    null OA_Status,
	null AssetRiskTolerance,
	null ResidualRisk,
	null ResiliencyScore,
	null VulnRiskTolerance,
	null tot_crit_vulns,
	null tot_high_vulns,
	null TLC_Phase,
	null VULUNIQUECRITICAL_GT60DAYS, 
	null VULCRITICAL_GT60DAYS ,
	null VULUNIQUEHIGH_GT60DAYS , 
	null VULHIGH_GT60DAYS ,
	null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	null VULCRITICAL_GT15_LTE60DAYS ,
	null vuluniquehigh_gt30_lte60days , 
	null vulhigh_gt30_lte60days ,
	null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	null VULCRITICAL_GT30_LTE60DAYS ,
	null vulmedium , 
	null vullow ,
	null vuluniquemedium , 
	null vuluniquelow,
    null KEV_Fixed_MonthToDate, 
    null KEV_Open, 
    null KEV_Reopened,
    Count(P."POA&M ID") as POAMCount, 
	P."Weakness_Risk_Level", 
	P."Overall_Status", 
    null OVERDUE_COUNT, 
    null OVERDUE_FILTER,
    null EPSS_COUNT, 
    null EPSS_FILTER
from RPT.V_POAMS_MONTHENDSNAPSHOT P
inner join CORE.VW_SYSTEMS S
on P."Archer_Tracking_ID" = S.Archer_Tracking_ID
Join rpt.CRR_Component_Params params on params.systems = s.acronym where params.ReportName=:P_ACHRONYM
and "Overall_Status" not in (''Completed'', ''Pending Verification'')
group by S.Acronym, P."Weakness_Risk_Level", P."Overall_Status", params.ReportName

UNION ALL

select 
reportname,
s.Acronym, 
null Report_ID, 
null report_date,
null Assets,
null Next_Required_CP_Test_Date,
null component_acronym,
null Auth_Decision,
null Date_Auth_Memo_Expires,
null Is_OA_Ready,
null OA_Status,
null AssetRiskTolerance,
null ResidualRisk,
null ResiliencyScore,
null VulnRiskTolerance,
null tot_crit_vulns,
null tot_high_vulns,
null TLC_Phase,
null VULUNIQUECRITICAL_GT60DAYS, 
null VULCRITICAL_GT60DAYS ,
null VULUNIQUEHIGH_GT60DAYS , 
null VULHIGH_GT60DAYS ,
null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
null VULCRITICAL_GT15_LTE60DAYS ,
null vuluniquehigh_gt30_lte60days , 
null vulhigh_gt30_lte60days ,
null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
null VULCRITICAL_GT30_LTE60DAYS ,
null vulmedium , 
null vullow ,
null vuluniquemedium , 
null vuluniquelow,
null KEV_Fixed_MonthToDate, 
null KEV_Open, 
null KEV_Reopened,
null POAMCount, 
null Weakness_Risk_Level, 
null Overall_Status,
count(CVE) OVERDUE_COUNT, 
OVERDUE_FILTER,
null EPSS_COUNT, 
null EPSS_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and OVERDUE_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, OVERDUE_FILTER, reportname

UNION ALL

select 
reportname,
s.acronym, 
null Report_ID, 
null report_date,
null Assets,
null Next_Required_CP_Test_Date,
null component_acronym,
null Auth_Decision,
null Date_Auth_Memo_Expires,
null Is_OA_Ready,
null OA_Status,
null AssetRiskTolerance,
null ResidualRisk,
null ResiliencyScore,
null VulnRiskTolerance,
null tot_crit_vulns,
null tot_high_vulns,
null TLC_Phase,
null VULUNIQUECRITICAL_GT60DAYS, 
null VULCRITICAL_GT60DAYS ,
null VULUNIQUEHIGH_GT60DAYS , 
null VULHIGH_GT60DAYS ,
null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
null VULCRITICAL_GT15_LTE60DAYS ,
null vuluniquehigh_gt30_lte60days , 
null vulhigh_gt30_lte60days ,
null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
null VULCRITICAL_GT30_LTE60DAYS ,
null vulmedium , 
null vullow ,
null vuluniquemedium , 
null vuluniquelow,
null KEV_Fixed_MonthToDate, 
null KEV_Open, 
null KEV_Reopened,
null POAMCount, 
null Weakness_Risk_Level, 
null Overall_Status,
null OVERDUE_COUNT, 
null OVERDUE_FILTER,
count(CVE) EPSS_COUNT, 
EPSS_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and EPSS_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, EPSS_FILTER, reportname
order by report_id, assets
;
COMMIT;
return ''Success'';



END;
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TESTFILES_MCRR"("P_ACHRONYM" VARCHAR(16777216))
RETURNS TABLE ()
LANGUAGE SQL
COMMENT='CRM stored procedure for MCRR'
EXECUTE AS OWNER
AS '
DECLARE
    res RESULTSET;
    res1 RESULTSET;
  BEGIN
    res := (
    select 
	params.ReportName,
	rptsummary.acronym,
	Months.report_id,
	Months.report_date,
    rptsummary.Assets,
    s.Next_Required_CP_Test_Date,
    s.component_acronym,
    s.Auth_Decision,
    s.Date_Auth_Memo_Expires,
    s.Is_OA_Ready,
    s.OA_Status,
	rptsummary.AssetRiskTolerance,
	rptsummary.ResidualRisk,
	rptsummary.ResiliencyScore,
	rptsummary.VulnRiskTolerance,
	css."Critical Vulnerabilities" as tot_crit_vulns,
	css."High Vulnerabilities" as tot_high_vulns,
	s.TLC_Phase,
	VULUNIQUECRITICAL_GT60DAYS, 
	VULCRITICAL_GT60DAYS ,
	VULUNIQUEHIGH_GT60DAYS , 
	VULHIGH_GT60DAYS ,
	VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	VULCRITICAL_GT15_LTE60DAYS ,
	vuluniquehigh_gt30_lte60days , 
	vulhigh_gt30_lte60days ,
	VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	VULCRITICAL_GT30_LTE60DAYS ,
	vulmedium , 
	vullow ,
	vuluniquemedium , 
	vuluniquelow,
    KEV_Fixed_MonthToDate, 
    KEV_Open, 
    KEV_Reopened,
	null POAMCount, 
	null Weakness_Risk_Level, 
	null Overall_Status,
    null OVERDUE_COUNT, 
    null OVERDUE_FILTER,
    null EPSS_COUNT, 
    null EPSS_FILTER
from CORE.VW_SYSTEMSUMMARY rptsummary
JOIN  (select distinct report_id,report_date from (select report_id,report_date,rank()over(order by report_date desc) as rankk from core.report_ids where Is_endOfMonth=1) a where rankk <=2) Months
ON Months.report_id=rptsummary.REPORT_ID
JOIN rpt.CRR_Component_Params params ON params.Systems=rptsummary.acronym
JOIN CORE.VW_SYSTEMS s ON s.Acronym=rptsummary.Acronym
join rpt.V_CyberRisk_System_Summary css on css."System" = s.Acronym
WHERE params.ReportName=:P_ACHRONYM

UNION ALL

Select distinct 
params.ReportName,
	s.acronym,
	null report_id,
	null report_date,
    null Assets,
    null Next_Required_CP_Test_Date,
    null component_acronym,
    null Auth_Decision,
    null Date_Auth_Memo_Expires,
    null Is_OA_Ready,
    null OA_Status,
	null AssetRiskTolerance,
	null ResidualRisk,
	null ResiliencyScore,
	null VulnRiskTolerance,
	null tot_crit_vulns,
	null tot_high_vulns,
	null TLC_Phase,
	null VULUNIQUECRITICAL_GT60DAYS, 
	null VULCRITICAL_GT60DAYS ,
	null VULUNIQUEHIGH_GT60DAYS , 
	null VULHIGH_GT60DAYS ,
	null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
	null VULCRITICAL_GT15_LTE60DAYS ,
	null vuluniquehigh_gt30_lte60days , 
	null vulhigh_gt30_lte60days ,
	null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
	null VULCRITICAL_GT30_LTE60DAYS ,
	null vulmedium , 
	null vullow ,
	null vuluniquemedium , 
	null vuluniquelow,
    null KEV_Fixed_MonthToDate, 
    null KEV_Open, 
    null KEV_Reopened,
    Count(P."POA&M ID") as POAMCount, 
	P."Weakness_Risk_Level", 
	P."Overall_Status", 
    null OVERDUE_COUNT, 
    null OVERDUE_FILTER,
    null EPSS_COUNT, 
    null EPSS_FILTER
from RPT.V_POAMS_MONTHENDSNAPSHOT P
inner join CORE.VW_SYSTEMS S
on P."Archer_Tracking_ID" = S.Archer_Tracking_ID
Join rpt.CRR_Component_Params params on params.systems = s.acronym where params.ReportName=:P_ACHRONYM
and "Overall_Status" not in (''Completed'', ''Pending Verification'')
group by S.Acronym, P."Weakness_Risk_Level", P."Overall_Status", params.ReportName

UNION ALL

select 
reportname,
s.Acronym, 
null Report_ID, 
null report_date,
null Assets,
null Next_Required_CP_Test_Date,
null component_acronym,
null Auth_Decision,
null Date_Auth_Memo_Expires,
null Is_OA_Ready,
null OA_Status,
null AssetRiskTolerance,
null ResidualRisk,
null ResiliencyScore,
null VulnRiskTolerance,
null tot_crit_vulns,
null tot_high_vulns,
null TLC_Phase,
null VULUNIQUECRITICAL_GT60DAYS, 
null VULCRITICAL_GT60DAYS ,
null VULUNIQUEHIGH_GT60DAYS , 
null VULHIGH_GT60DAYS ,
null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
null VULCRITICAL_GT15_LTE60DAYS ,
null vuluniquehigh_gt30_lte60days , 
null vulhigh_gt30_lte60days ,
null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
null VULCRITICAL_GT30_LTE60DAYS ,
null vulmedium , 
null vullow ,
null vuluniquemedium , 
null vuluniquelow,
null KEV_Fixed_MonthToDate, 
null KEV_Open, 
null KEV_Reopened,
null POAMCount, 
null Weakness_Risk_Level, 
null Overall_Status,
count(CVE) OVERDUE_COUNT, 
OVERDUE_FILTER,
null EPSS_COUNT, 
null EPSS_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and OVERDUE_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, OVERDUE_FILTER, reportname

UNION ALL

select 
reportname,
s.acronym, 
null Report_ID, 
null report_date,
null Assets,
null Next_Required_CP_Test_Date,
null component_acronym,
null Auth_Decision,
null Date_Auth_Memo_Expires,
null Is_OA_Ready,
null OA_Status,
null AssetRiskTolerance,
null ResidualRisk,
null ResiliencyScore,
null VulnRiskTolerance,
null tot_crit_vulns,
null tot_high_vulns,
null TLC_Phase,
null VULUNIQUECRITICAL_GT60DAYS, 
null VULCRITICAL_GT60DAYS ,
null VULUNIQUEHIGH_GT60DAYS , 
null VULHIGH_GT60DAYS ,
null VULUNIQUECRITICAL_GT15_LTE60DAYS , 
null VULCRITICAL_GT15_LTE60DAYS ,
null vuluniquehigh_gt30_lte60days , 
null vulhigh_gt30_lte60days ,
null VULUNIQUECRITICAL_GT30_LTE60DAYS , 
null VULCRITICAL_GT30_LTE60DAYS ,
null vulmedium , 
null vullow ,
null vuluniquemedium , 
null vuluniquelow,
null KEV_Fixed_MonthToDate, 
null KEV_Open, 
null KEV_Reopened,
null POAMCount, 
null Weakness_Risk_Level, 
null Overall_Status,
null OVERDUE_COUNT, 
null OVERDUE_FILTER,
count(CVE) EPSS_COUNT, 
EPSS_FILTER
from CORE.VW_SYSTEMS s
Join RPT.VW_ASSETDETAIL_ROLLING60DAYS vulcur on s.system_id = vulcur.system_id
join rpt.CRR_Component_Params params on params.systems = s.acronym
where params.ReportName=:P_ACHRONYM and EPSS_FILTER <> ''NULL'' and  lower(MitigationStatus) in (''open'', ''reopened'') group by s.acronym, EPSS_FILTER, reportname
order by report_id, assets
);
RETURN TABLE(res);


END;
';
CREATE OR REPLACE PROCEDURE "SP_THROW_ERROR"("MSG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE PYTHON
RUNTIME_VERSION = '3.10'
PACKAGES = ('snowflake-snowpark-python','requests')
HANDLER = 'main'
EXTERNAL_ACCESS_INTEGRATIONS = (SLACK_WEBHOOK_ACCESS_INTEGRATION)
SECRETS = ('crm_sdw_url'=SLACK_CRM_SDW_WEBHOOK_URL)
EXECUTE AS CALLER
AS '
import snowflake.snowpark as snowpark
import json
import requests
import _snowflake
from datetime import date

def main(session, msg): 
    # Retrieve the Webhook URL from the SECRET object
    webhook_url = _snowflake.get_generic_secret_string(''crm_sdw_url'')
    
    slack_data = {
     "text": f"Snowflake alert: {msg}"
    }

    response = requests.post(
        webhook_url, data=json.dumps(slack_data),
        headers={''Content-Type'': ''application/json''}
    )
    if response.status_code != 200:
        raise ValueError(
            ''Request to slack returned an error %s, the response is:\\n%s''
            % (response.status_code, response.text)
        )
    
    return "SUCCESS"
';
create or replace schema SANDBOX COMMENT='Schema for testing Snowflake changes before including in production';

create or replace TABLE ALERTLOG (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	APPL VARCHAR(16777216),
	CUSTOM_ERRMSG VARCHAR(16777216),
	ERRTYPE VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) DEFAULT CURRENT_TIMESTAMP(),
	SQLCODE VARCHAR(16777216),
	SQLERRM VARCHAR(16777216),
	SQLSTATE VARCHAR(16777216),
	primary key (ID)
);
create or replace TABLE APP_TENABLE_AWS_SYSTEMS (
	DATA_CENTER_ID VARCHAR(16777216),
	FISMA_ID VARCHAR(16777216),
	MIN_LASTSEEN TIMESTAMP_LTZ(9),
	MAX_LASTSEEN TIMESTAMP_LTZ(9)
);
create or replace TABLE APP_TENABLE_CCIC_SYSTEMS (
	DATA_CENTER_ID VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	MIN_LASTSEEN TIMESTAMP_LTZ(9),
	MAX_LASTSEEN TIMESTAMP_LTZ(9)
);
create or replace TABLE ASSETSOFTWARE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	PLUGIN_LINE VARCHAR(16777216),
	RAW_PLUGIN_TEXT VARCHAR(16777216),
	primary key (ID)
)COMMENT='Software associated with an asset\t'
;
create or replace TABLE ASSETSOFTWARE_PREPROD (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	PLUGIN_LINE VARCHAR(16777216),
	RAW_PLUGIN_TEXT VARCHAR(16777216),
	primary key (ID)
)COMMENT='Software associated with an asset, for the purpose of testing the output of associated prod table\t'
;
create or replace TABLE ASSET_241104_1029 (
	DW_ASSET_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	IS_APPLICABLE BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	SOURCE_TOOL_CREATE VARCHAR(16777216),
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216),
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	DEVICEMODEL VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	IS_FROM_AWS_FEED BOOLEAN,
	CREATEDBY_SNAPSHOT_ID NUMBER(38,0),
	CREATEDBY_RAW_ID NUMBER(38,0),
	MODIFIEDBY_SNAPSHOT_ID NUMBER(38,0),
	MODIFIEDBY_RAW_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	CREATEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	MODIFIEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	OS_BUILD_NUMBER VARCHAR(16777216),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	PREV_SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE ASSET_DEVICETYPE_241001_1419 (
	DW_ASSET_ID NUMBER(38,0),
	DEVICETYPE VARCHAR(16777216)
);
create or replace TABLE ASSET_DEVICETYPE_CHANGE_241121_1401 (
	DW_ASSET_ID NUMBER(38,0),
	DEVICETYPE VARCHAR(16777216),
	OS VARCHAR(16777216)
);
create or replace TABLE BOD240315 (
	CVE VARCHAR(16777216),
	DATEADDED DATE,
	VULNERABILITYNAME VARCHAR(16777216)
);
create or replace TABLE BODJAN31 (
	CVE VARCHAR(16777216),
	DATEADDED DATE,
	VULNERABILITYNAME VARCHAR(16777216)
);
create or replace TABLE CCSQ_REPO_NAMES_231220 (
	QUALITYNET_TENABLE_VULNERABILITY_REPO_NAMES VARCHAR(16777216),
	CFACTS_UID VARCHAR(16777216),
	DATACENTER_UID VARCHAR(16777216),
	FISMA_SYSTEM VARCHAR(16777216),
	ISPG_REPOSITORY_NAME VARCHAR(16777216),
	ISPG_REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	COMMENTS VARCHAR(16777216),
	HOW_REPOSITORY_ID_DETEREMINED VARCHAR(16777216),
	HOW_CFACTS_UID_VALIDATED VARCHAR(16777216)
);
create or replace TABLE CDS_VDC_IDS_FOR_CDS_VDC_GSS_DEE_240925 (
	NOTES VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	HOSTNAME VARCHAR(16777216),
	CDSVDCCOMMENTS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE CFACTS_SYSTEMS_240930 (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	ARCHER_TRACKING_ID VARCHAR(16777216),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(1),
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(18,0),
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CMR_ARCHER (
	THETBL VARCHAR(56),
	THECOL VARCHAR(18),
	THEVAL VARCHAR(16777216)
);
create or replace TABLE CMR_CFACTS_SYSTEMS (
	ACRONYM VARCHAR(16777216),
	ACTUAL_DECOMMISION_DATE TIMESTAMP_LTZ(9),
	ARCHER_TRACKING_ID VARCHAR(16777216),
	ATO_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	ATO_REVIEW_DATE TIMESTAMP_LTZ(9),
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE TIMESTAMP_LTZ(9),
	AUTHORIZATION_PACKAGE_NAME VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE TIMESTAMP_LTZ(9),
	BO_REVIEW_DATE TIMESTAMP_LTZ(9),
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE TIMESTAMP_LTZ(9),
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE TIMESTAMP_LTZ(9),
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE TIMESTAMP_LTZ(9),
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES TIMESTAMP_LTZ(9),
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_LTZ(9),
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE TIMESTAMP_LTZ(9),
	DSPPO_REVIEW_DATE TIMESTAMP_LTZ(9),
	E_AUTH_EXP_DATE TIMESTAMP_LTZ(9),
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE TIMESTAMP_LTZ(9),
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE TIMESTAMP_LTZ(9),
	FISMA_SYSTEM VARCHAR(16777216),
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	IS_MARKETPLACE VARCHAR(1),
	IS_OA_READY VARCHAR(1),
	ISRA_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(18,0),
	ISSO_REVIEW_DATE TIMESTAMP_LTZ(9),
	ISSO_SUBMISSION_DATE TIMESTAMP_LTZ(9),
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_ACT_SCA_FINAL_REPORT_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE TIMESTAMP_LTZ(9),
	LAST_PENTEST_DATE TIMESTAMP_LTZ(9),
	MEF VARCHAR(16777216),
	MEF_CONTEXT VARCHAR(16777216),
	NEXT_REQUIRED_CP_TEST_DATE TIMESTAMP_LTZ(9),
	OA_STATUS VARCHAR(16777216),
	OPERATED_BY VARCHAR(16777216),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 VARCHAR(16777216),
	PIA_EXPIRATION_DATE TIMESTAMP_LTZ(9),
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE TIMESTAMP_LTZ(9),
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE TIMESTAMP_LTZ(9),
	STE_DATE TIMESTAMP_LTZ(9),
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216)
);
create or replace TABLE CMR_RECAST_SAMPLE (
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CUSTOM_SEVERITY VARCHAR(16777216),
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	HAS_BEEN_MITIGATED BOOLEAN,
	MITIGATIONSTATUS VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	PLUGIN_ID VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216)
);
create or replace TABLE CRITICALSOFTWARE_HIGLAS_240715 (
	OPDIV VARCHAR(16777216),
	CATEGORYOFSOFTWARE VARCHAR(16777216),
	NAMEOFONPREMISECRITICALSOFTWARE VARCHAR(16777216),
	SOFTWAREVENDORNAME VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	OPERATINGSYSTEM VARCHAR(16777216),
	LATESTINSTALLDATE VARCHAR(16777216),
	COLUMN8 VARCHAR(16777216)
);
create or replace TABLE DEBBIE_CDS_VDC_GSS_MDRV2_241217 (
	COMPONEN_SYSTEM VARCHAR(16777216),
	DATACENTER VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	DEVICE_ROLE VARCHAR(16777216),
	DATECREATED VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	SHOULD_BE_PECOS_OR_CDS_CDS_VDC_GSS VARCHAR(16777216),
	CURRENT_FISMA_TAG_FROM_NESSUS_SCAN_DATA VARCHAR(16777216),
	FQDN VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	OS VARCHAR(16777216),
	OSVERSION VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216)
);
create or replace TABLE DEVICETYPE_DEVICEROLE_CORRECTIONS_240729 (
	DEVICETYPE VARCHAR(16777216),
	DEVICEROLE VARCHAR(16777216),
	COMMENTS VARCHAR(16777216)
);
create or replace TABLE DIRECTORCOMMENT2 (
	ACRONYM VARCHAR(16777216),
	THECOMMENT VARCHAR(16777216)
);
create or replace TABLE DIRECTORCOMMENT_230928 (
	SYSTEM_ACRONYM VARCHAR(16777216),
	THECOMMENT VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE DRAAS_ACTIVE_ASSETS_240910_DEE_TO_CHRIS_240919 (
	NOTES VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0)
);
create or replace TABLE DRAAS_CONFIGURATION_SCAN_DOCUMENTATION_250124 (
	RISKTITLE VARCHAR(16777216),
	TOOLID VARCHAR(16777216),
	FORMTYPE VARCHAR(16777216),
	DOCID NUMBER(38,0),
	POCNAME VARCHAR(16777216),
	DESCRIPTION_OF_SETTINGS_RECOMMENDED_SETTINGS VARCHAR(16777216),
	BUSINESSJUSTIFICATION VARCHAR(16777216)
);
create or replace TABLE DRAAS_SEGMENTS (
	DATACENTERACRONYM VARCHAR(16777216),
	SEGMENTNAME VARCHAR(16777216),
	STARTOFRANGE VARCHAR(16777216),
	ENDOFRANGE VARCHAR(16777216)
);
create or replace TABLE DRAAS_SEGMENTS_ENHANCED (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATACENTERACRONYM VARCHAR(16777216),
	ENDOFRANGE VARCHAR(16777216),
	SEGMENTNAME VARCHAR(16777216),
	STARTOFRANGE VARCHAR(16777216),
	primary key (ID)
);
create or replace TABLE DRAAS_SYSTEM_VULN_DETAILS_DATA (
	DRAASFISMA VARCHAR(16777216),
	DATACENTERNAME VARCHAR(16777216),
	AWSACCOUNTIDS VARCHAR(16777216),
	PLUGINID NUMBER(38,0),
	CVE VARCHAR(16777216),
	CVSS30 NUMBER(38,1),
	FISMASEVERITY VARCHAR(16777216),
	SENSORFIRSTSEEN VARCHAR(16777216),
	SENSORLASTFOUND VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0)
);
create or replace TABLE DRAAS_SYSTEM_VULN_DETAILS_DATA_240821 (
	DRAASFISMA VARCHAR(16777216),
	SYSTEMNAME VARCHAR(16777216),
	DATACENTERNAME VARCHAR(16777216),
	AWS_ACCOUNT_IDS VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	KEITH_PURPOSE VARCHAR(16777216),
	KEITH_POC VARCHAR(16777216),
	DEE_NOTES VARCHAR(16777216)
);
create or replace TABLE DRAAS_SYSTEM_VULN_DETAILS_DATA_FINDINGS_240905_LEIDOS_KEITH_240910 (
	DRAASFISMA VARCHAR(16777216),
	SYSTEMNAME VARCHAR(16777216),
	DATACENTERNAME VARCHAR(16777216),
	AWS_ACCOUNT_IDS VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	PURPOSE VARCHAR(16777216),
	POC VARCHAR(16777216),
	FISMA_ID VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	MDR_STATUS VARCHAR(16777216),
	DATACENTER_ACRONYM VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	OS VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	LAST_CONFIRMED_TIME DATE,
	DATEDELETED DATE,
	DELETIONREASON VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG VARCHAR(16777216),
	RAW_HWAM_INSERT_DATE DATE
);
create or replace TABLE EUA_LIST (
	HOSTNAME VARCHAR(16777216),
	IPV4 VARCHAR(16777216)
);
create or replace TABLE EXPECTED_CCIC_REPOSITORIES_231027 (
	THESOURCE VARCHAR(16777216),
	ACRONYM VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	COMMENTS VARCHAR(16777216),
	SECURITY_ENGINEERING_COMMENTS VARCHAR(16777216)
);
create or replace TABLE FROZEN_DRAAS_ASSETS (
	DW_ASSET_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCESTATUS VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIOS_GUID VARCHAR(16777216),
	COMPUTER_TYPE VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DELETIONREASON VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	IS_APPLICABLE BOOLEAN,
	IS_PRIMARY_FISMA_ID_DERIVED BOOLEAN,
	IS_SCANNABLE BOOLEAN,
	IS_TATTOOABLE BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LASTASSETUPDATE TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AWS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_AXONIUS TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_BIGFIX TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_FORESCOUT TIMESTAMP_LTZ(9),
	LASTMODIFIEDBY_TENABLE TIMESTAMP_LTZ(9),
	LASTSEEN_CSM TIMESTAMP_LTZ(9),
	LASTSEEN_HWAM TIMESTAMP_LTZ(9),
	LASTSEEN_SWAM TIMESTAMP_LTZ(9),
	LASTSEEN_VUL TIMESTAMP_LTZ(9),
	MOTHERBOARD VARCHAR(16777216),
	OS VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	SOURCE_TOOL_CREATE VARCHAR(16777216),
	SOURCE_TOOL_CSM VARCHAR(16777216),
	SOURCE_TOOL_HWAM VARCHAR(16777216),
	SOURCE_TOOL_LASTSEEN VARCHAR(16777216),
	SOURCE_TOOL_SWAM VARCHAR(16777216),
	SOURCE_TOOL_VUL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2),
	PREV_LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	PREV_DATEDELETED TIMESTAMP_LTZ(9),
	DEVICEMODEL VARCHAR(16777216),
	CLOUD_ID VARCHAR(16777216),
	IS_FROM_AWS_FEED BOOLEAN,
	CREATEDBY_SNAPSHOT_ID NUMBER(38,0),
	CREATEDBY_RAW_ID NUMBER(38,0),
	MODIFIEDBY_SNAPSHOT_ID NUMBER(38,0),
	MODIFIEDBY_RAW_ID NUMBER(38,0),
	TENANT_ID VARCHAR(16777216),
	CREATEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	MODIFIEDBY_TEMP_DW_ASSET_ID NUMBER(38,0),
	IS_FORESCOUT_MANAGED BOOLEAN,
	IS_TENABLE_CREDENTIALED_SCAN BOOLEAN,
	OS_BUILD_NUMBER VARCHAR(16777216),
	LASTMODIFIEDBY_CROWDSTRIKE TIMESTAMP_LTZ(9),
	IS_FREEZE_SYSTEM_ID BOOLEAN,
	PREV_SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE HIGLAS_240715 (
	AGGREGATEDPREFERREDASSETNAME VARCHAR(16777216),
	AGGREGATEDASSETUNIQUEID VARCHAR(16777216),
	CSVCSVTYPE VARCHAR(16777216),
	AGGREGATEDPREFERREDOSDISTRIBUTIONNAME VARCHAR(16777216),
	AGGREGATEDPREFERREDOSFULLSTRING VARCHAR(16777216),
	AGGREGATEDPREFERREDIPV4 VARCHAR(16777216),
	AGGREGATEDPREFERREDIPV6 VARCHAR(16777216),
	"AggregatedPreferredHostName(FQDN)" VARCHAR(16777216),
	AGGREGATEDLASTSEEN VARCHAR(16777216),
	AGGREGATEDPREFERREDMACADDRESS VARCHAR(16777216),
	GUIFISMAID VARCHAR(16777216)
);
create or replace TABLE IUSG_CUMULATIVE_VULNS (
	DATA_CENTER_ID VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	RAW_VULNS VARIANT
);
create or replace TABLE IUSG_CUMULATIVE_VULNS_STAGING (
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	RAW_VULNS VARIANT,
	FILENAME VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9)
);
create or replace TABLE IUSG_MITIGATED_VULNS (
	DATA_CENTER_ID VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	RAW_VULNS VARIANT
);
create or replace TABLE IUSG_MITIGATED_VULNS_STAGING (
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	RAW_VULNS VARIANT,
	FILENAME VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9)
);
create or replace TABLE LEGACYASSETS_231024 (
	SYSTEM_ACRONYM VARCHAR(16777216),
	LEGACYASSETS NUMBER(38,0)
);
create or replace TABLE LEGACYASSETS_WT_ASSET_ID_TATTOO (
	THESOURCE VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	INSERT_DATE DATE,
	LASTASSETUPDATE DATE,
	LAST_CONFIRMED_TIME VARCHAR(16777216),
	LASTSEEN_HWAM DATE,
	LASTSEEN_VUL DATE,
	DEVICETYPE VARCHAR(16777216),
	FQDN VARCHAR(16777216),
	IS_APPLICABLE NUMBER(38,0),
	DATEDELETED DATE
);
create or replace TABLE LEGACYASSETS_WT_ASSET_ID_TATTOO_EDC4_231117 (
	THESOURCE VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	INSERT_DATE DATE,
	LASTASSETUPDATE DATE,
	LAST_CONFIRMED_TIME VARCHAR(16777216),
	LASTSEEN_HWAM DATE,
	LASTSEEN_VUL DATE,
	DEVICETYPE VARCHAR(16777216),
	FQDN VARCHAR(16777216),
	IS_APPLICABLE NUMBER(38,0),
	DATEDELETED DATE
);
create or replace TABLE LEGACYSYSTEMS_231017 (
	ACRONYM VARCHAR(16777216),
	ARCHER_TRACKING_ID NUMBER(38,0),
	ATO_EXPIRATION_DATE DATE,
	ATO_REVIEW_DATE DATE,
	AUTH_COMMENTS VARCHAR(16777216),
	AUTH_DECISION VARCHAR(16777216),
	AUTHORIZATION_MEMO_SIGNED_DATE DATE,
	AUTHORIZATION_PACKAGE VARCHAR(16777216),
	AWS_ACCOUNTIDS VARCHAR(16777216),
	BO_RECOMMENDATION_REVIEW_DATE DATE,
	BO_REVIEW_DATE DATE,
	BUSINESS_OWNER VARCHAR(16777216),
	CIO VARCHAR(16777216),
	CISO VARCHAR(16777216),
	CISO_REVIEW_DATE DATE,
	CLOUD_SERVICE_PROVIDER VARCHAR(16777216),
	COMMONNAME VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	COMPONENT_DESCRIPTION VARCHAR(16777216),
	COMPONENT_NAME VARCHAR(16777216),
	COMPONENT_RISK_REPORTS_OVERSIGHT VARCHAR(16777216),
	CONTINGENCYEXPIRATIONDATE DATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID VARCHAR(16777216),
	CP_TEST_DATE DATE,
	CP_TEST_RESULTS VARCHAR(16777216),
	CRA VARCHAR(16777216),
	CRA_REVIEW_DATE DATE,
	CYBERVET VARCHAR(16777216),
	DATE_AUTH_MEMO_EXPIRES DATE,
	DATE_AUTH_MEMO_SIGNED TIMESTAMP_NTZ(9),
	DATEDELETED DATE,
	DATEMODIFIED DATE,
	DCISO VARCHAR(16777216),
	DIVISION_ACRONYM VARCHAR(16777216),
	DIVISION_DESCRIPTION VARCHAR(16777216),
	DIVISION_NAME VARCHAR(16777216),
	DSPC_REVIEW_DATE DATE,
	DSPPO_REVIEW_DATE DATE,
	E_AUTH_EXP_DATE DATE,
	E_AUTH_LEVEL VARCHAR(16777216),
	E_AUTH_RISK_ASSESSMENT_DATE DATE,
	FINANCIAL_SYSTEM VARCHAR(16777216),
	FIPS_199_AVAILABILITY_RATING VARCHAR(16777216),
	FIPS_199_CONFIDENTIALITY_RATING VARCHAR(16777216),
	FIPS_199_INTEGRITY_RATING VARCHAR(16777216),
	FIPS_199_OVERALL_IMPACT_RATING VARCHAR(16777216),
	FIRST_PUBLISHED_DATE DATE,
	FISMA_SYSTEM BOOLEAN,
	GROUP_ACRONYM VARCHAR(16777216),
	GROUP_DESCRIPTION VARCHAR(16777216),
	GROUP_NAME VARCHAR(16777216),
	HVA_SCORE NUMBER(38,0),
	HVASTATUS BOOLEAN,
	IN_CMS_CLOUD BOOLEAN,
	INFORMATION_SYSTEM_TYPE VARCHAR(16777216),
	INSERT_DATE DATE,
	IS_DATACENTER NUMBER(38,0),
	IS_EXCLUDEFROMREPORTING NUMBER(38,0),
	IS_HIGHRISKSYSTEM NUMBER(38,0),
	IS_MARKETPLACE NUMBER(38,0),
	IS_OA_READY NUMBER(38,0),
	IS_OPERATIONALSYSTEM NUMBER(38,0),
	IS_PHANTOMSYSTEM NUMBER(38,0),
	IS_SECURITYHUB_ENABLED NUMBER(38,0),
	ISRA_REVIEW_DATE DATE,
	ISRA_STATUS VARCHAR(16777216),
	ISSO VARCHAR(16777216),
	ISSO_COUNT NUMBER(38,0),
	ISSO_REVIEW_DATE DATE,
	ISSO_SUBMISSION_DATE DATE,
	ISSOCS VARCHAR(16777216),
	LAST_ACT_DATE DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE DATE,
	LAST_PENTEST_DATE DATE,
	MEF BOOLEAN,
	MEF_CONTEXT VARCHAR(16777216),
	MEFSTATUS BOOLEAN,
	NEXT_REQUIRED_CP_TEST_DATE DATE,
	OA_STATUS VARCHAR(16777216),
	OATO_CATEGORY NUMBER(38,0),
	PACKAGE_TYPE VARCHAR(16777216),
	PIA_014 BOOLEAN,
	PIA_EXPIRATION_DATE DATE,
	PII_PHI BOOLEAN,
	PRIMARY_ISSO VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION_ACRONYM VARCHAR(16777216),
	PRIMARY_OPERATING_LOCATION_ID VARCHAR(16777216),
	REASON_FOR_ATO_REQUEST VARCHAR(16777216),
	SCA VARCHAR(16777216),
	SCA_DATE DATE,
	SDM VARCHAR(16777216),
	SOP_REVIEW_DATE DATE,
	STE_DATE DATE,
	SYSTEM_DESCRIPTION VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	TOTALASSETS NUMBER(38,0),
	TOTALPOAMWITHAPPROVEDRBD NUMBER(38,0)
);
create or replace TABLE LEGACY_DATACENTER_SYSTEM_ASSETS_231024 (
	THESOURCE VARCHAR(16777216),
	DATACENTER_ACRONYM VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	TOTALASSETS NUMBER(38,0)
);
create or replace TABLE LEGACY_TOTAL_ASSETS_AND_VUL_231129 (
	ACRONYM VARCHAR(16777216),
	CFACTS_UID VARCHAR(16777216),
	TLC_PHASE VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	LEGACYASSETS NUMBER(38,0),
	LEGACYVULNERABIITIES NUMBER(38,0)
);
create or replace TABLE LEIDOS_DRAAS_EXTRACT_092524_KEITH_240926 (
	DRAASFISMA BOOLEAN,
	SYSTEMNAME VARCHAR(16777216),
	DATACENTERNAME VARCHAR(16777216),
	AWS_ACCOUNT_IDS VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	HOSTNAME VARCHAR(16777216),
	PURPOSE VARCHAR(16777216),
	POC VARCHAR(16777216),
	FISMA_ID VARCHAR(16777216),
	COMMENT_K VARCHAR(16777216),
	IPV4 VARCHAR(16777216),
	MDR_STATUS VARCHAR(16777216),
	DATACENTER_ACRONYM VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	DEVICETYPE VARCHAR(16777216),
	OS VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	LAST_CONFIRMED_TIME DATE,
	DATEDELETED VARCHAR(16777216),
	DELETIONREASON VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG VARCHAR(16777216),
	RAW_HWAM_INSERT_DATE DATE,
	SYSTEM_ID VARCHAR(16777216)
);
create or replace TABLE LEIDOS_DRAAS_EXTRACT_DRAAS_100724 (
	DW_ASSET_ID NUMBER(38,0),
	HOSTNAME VARCHAR(16777216),
	PURPOSE VARCHAR(16777216),
	POC VARCHAR(16777216),
	FISMA_ID_NEW VARCHAR(16777216),
	ASSET_ID_TAG VARCHAR(16777216),
	FISMA_ID_TAG VARCHAR(16777216)
);
create or replace TABLE LEIDOS_DRAAS_EXTRACT_EDC4_100724 (
	COMPUTERNAME VARCHAR(16777216),
	LOCATION VARCHAR(16777216),
	PURPOSE VARCHAR(16777216),
	POC VARCHAR(16777216),
	FISMA_ID_NEW VARCHAR(16777216),
	PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216)
);
create or replace TABLE NEW_CUM_VUL_231222_1514 (
	DATA_CENTER VARCHAR(16777216),
	FISMA VARCHAR(16777216),
	TOTAL NUMBER(18,0)
);
create or replace TABLE NEW_CUM_VUL_231222_1539 (
	THESOURCE VARCHAR(28),
	DATACENTER_ACRONYM VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	SEVERITYID VARCHAR(16777216),
	TOTAL NUMBER(18,0)
);
create or replace TABLE NEW_IUSG_CUMULATIVE (
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FILENAME VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	LAST_SEEN TIMESTAMP_LTZ(9),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RAW_VULNS VARIANT,
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	UUID VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	XREF VARCHAR(16777216)
);
create or replace TABLE NGS_VALIDATED_FORESCOUT_SEGMENTS_10_18_BEFORE (
	SEGMENTNAME VARCHAR(16777216),
	FROMRANGE VARCHAR(16777216),
	TORANGE VARCHAR(16777216)
);
create or replace TABLE NGS_VALIDATED_FORESCOUT_SEGMENTS_10_22_AFTER (
	SEGMENTNAME VARCHAR(16777216),
	FROMRANGE VARCHAR(16777216),
	TORANGE VARCHAR(16777216)
);
create or replace TABLE PROPAGATEPLUGIN (
	SNAPSHOT_ID NUMBER(38,0),
	DATACENTER_ID VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	IP VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	APPLICABILITYCODE VARCHAR(16777216),
	ROWDISPOSITION VARCHAR(16777216)
);
create or replace TABLE RAW_HWAM_AXONIUS (
	RAW_HWAM_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_DATACENTER_ID VARCHAR(16777216),
	AWS_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	AXONIUS_ADAPTER_LIST_LENGTH NUMBER(38,0),
	AXONIUS_ADAPTERS ARRAY,
	AXONIUS_ADAPTERS_UUID ARRAY,
	AXONIUS_INTERNAL_AXONIUS_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID VARCHAR(16777216),
	BIGFIX_ASSET_ID_TATTOO VARCHAR(16777216),
	BIGFIX_DATACENTER_ID VARCHAR(16777216),
	BIGFIX_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	BIOS_GUID ARRAY,
	CLOUD_ID ARRAY,
	CLOUD_PROVIDER ARRAY,
	COMPUTER_TYPE VARCHAR(16777216),
	CONNECTION_LABEL ARRAY,
	DATA_ERROR_ARRAY ARRAY,
	DATA_WARNING_ARRAY ARRAY,
	DATACENTER_ID VARCHAR(16777216),
	DATECOMPLETED TIMESTAMP_LTZ(9),
	DEVICE_MANUFACTURER ARRAY,
	DEVICE_TYPE VARCHAR(16777216),
	DOMAIN_PREFERRED VARCHAR(16777216),
	ENVIRONMENT VARCHAR(16777216),
	EVENTTIME TIMESTAMP_LTZ(9),
	FIRST_FETCH_TIME TIMESTAMP_LTZ(9),
	FORESCOUT_ASSET_ID_TATTOO VARCHAR(16777216),
	FORESCOUT_ASSIGNED_LABELS VARCHAR(16777216),
	FORESCOUT_DATACENTER_ID VARCHAR(16777216),
	FORESCOUT_PRIMARY_FISMA_ID VARCHAR(16777216),
	FQDN ARRAY,
	HOSTNAME ARRAY,
	INSERT_DATE TIMESTAMP_LTZ(9),
	INSTANCESTATUS VARCHAR(16777216),
	IPV4 ARRAY,
	IPV6 ARRAY,
	IS_FS_MANAGED VARCHAR(16777216),
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	IS_WINDOWS_SERVER_PREFERRED VARCHAR(16777216),
	LABELS ARRAY,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	LAST_USED_USERS_COMPANY_ASSOCIATION ARRAY,
	LAST_USED_USERS_DEPARTMENTS_ASSOCIATION ARRAY,
	MACADDRESS ARRAY,
	MOTHERBOARD VARCHAR(16777216),
	NETBIOSNAME ARRAY,
	OS VARCHAR(16777216),
	OS_BUILD_PREFERRED VARCHAR(16777216),
	OS_CPE VARCHAR(16777216),
	OS_DOTTED VARCHAR(16777216),
	OS_MAJOR VARCHAR(16777216),
	OS_MINOR VARCHAR(16777216),
	OS_TYPE_DISTRIBUTION_PREFERRED VARCHAR(16777216),
	OS_TYPE_PREFERRED VARCHAR(16777216),
	OS_VERSION VARCHAR(16777216),
	PRIMARY_FISMA_ID_DERIVED VARCHAR(16777216),
	PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	REPORTDATE TIMESTAMP_LTZ(9),
	ROWDISPOSITION VARCHAR(16777216),
	SITECODE_PREFERRED VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216),
	SUBNETS_PREFERRED ARRAY,
	SYSTEM_ACRONYM VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLE_ASSET_ID_TATTOO VARCHAR(16777216),
	TENABLE_ASSET_TAGS VARCHAR(16777216),
	TENABLE_DATACENTER_ID VARCHAR(16777216),
	TENABLE_PRIMARY_FISMA_ID_TATTOO VARCHAR(16777216),
	TIME_ZONE ARRAY,
	VIRTUAL_HOST ARRAY,
	WINDOWS_PATCH_VERSION ARRAY,
	BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS ARRAY,
	DEVICEMODEL VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0),
	FISMA_UUID VARCHAR(16777216),
	BIGFIX_ASSET_ID_DETAILS ARRAY,
	BIGFIX_ASSET_ID_TATTOO_DETAILS ARRAY,
	REPOSITORY_DESCRIPTION_DETAILS ARRAY,
	BIGFIX_DATACENTER_ID_DETAILS ARRAY,
	FORESCOUT_DATACENTER_ID_DETAILS ARRAY
);
create or replace TABLE REPO14_ACCOUNTID_AND_INSTANCEID (
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216)
);
create or replace TABLE RESEARCH_CFACTS_KEV (
	ACRONYM VARCHAR(16777216),
	ACTUAL_COMPLETION_DATE TIMESTAMP_LTZ(9),
	ACTUAL_LABOR_COST VARCHAR(16777216),
	CAAT VARCHAR(16777216),
	CAAT_ID VARCHAR(16777216),
	DAYS_OPEN VARCHAR(16777216),
	ESTIMATED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	FINDING_ID VARCHAR(16777216),
	FUNDING_SOURCE VARCHAR(16777216),
	LABOR_ESTIMATE VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	POAM_CLOSED_DATE TIMESTAMP_LTZ(9),
	POAM_ID VARCHAR(16777216),
	POAM_OWNER VARCHAR(16777216),
	POAM_REVIEWER VARCHAR(16777216),
	REVIEW_COMMENTS VARCHAR(16777216),
	REVIEW_DATE TIMESTAMP_LTZ(9),
	REVIEW_STATUS VARCHAR(16777216),
	SCHEDULED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	SOURCE_AUDIT_TYPE_2 VARCHAR(16777216),
	SUBMISSION_STATUS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TARGET VARCHAR(16777216),
	WEAKNESS_CREATION_DATE TIMESTAMP_LTZ(9),
	WEAKNESS_ID VARCHAR(16777216),
	WEAKNESS_POC VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216),
	WEAKNESS_SEVERITY VARCHAR(16777216)
);
create or replace TABLE SDWCOREOBJCOMMENTS_240111 (
	OBJECTTYPE VARCHAR(16777216),
	OBJECTNAME VARCHAR(16777216),
	COMMENT VARCHAR(16777216),
	FLAG NUMBER(38,0)
);
create or replace TABLE SEC_VW_AXONIUS_HWAM (
	FULL_JSON_CONTENTS VARIANT,
	FILE_LAST_MODIFIED TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	REPORTDATE_STRING VARCHAR(16777216),
	REPORTDATE DATE,
	"adapters" ARRAY,
	"adapter_list_length" NUMBER(38,0),
	"adapter_list_length_details" ARRAY,
	"adapters_data.bigfix_adapter.bigfix_Data_Center_ID_Derived" VARCHAR(16777216),
	"adapters_data.bigfix_adapter.bigfix_Primary_FISMA_ID_tattoo_details" ARRAY,
	"adapters_data.bigfix_adapter.bigfix_ASSET_ID" VARCHAR(16777216),
	"adapters_data.bigfix_adapter.bigfix_ASSET_ID_details" ARRAY,
	"adapters_data.bigfix_adapter.bigfix_Asset_ID_tattoo" VARCHAR(16777216),
	"adapters_data.bigfix_adapter.bigfix_Asset_ID_tattoo_details" ARRAY,
	"adapters_data.tenable_security_center_adapter.repository_description" VARCHAR(16777216),
	"adapters_data.tenable_security_center_adapter.repository_description_details" ARRAY,
	"adapters_data.tenable_security_center_adapter.installed_software.name_version" VARCHAR(16777216),
	"adapters_data.counter_act_adapter.assigned_labels" VARCHAR(16777216),
	"adapters_details" ARRAY,
	"has_notes" VARCHAR(16777216),
	"has_notes_details" ARRAY,
	"internal_axon_id" VARCHAR(16777216),
	"internal_axon_id_details" ARRAY,
	"labels" ARRAY,
	"meta_data.client_used" ARRAY,
	"specific_data.connection_label" ARRAY,
	"specific_data.connection_label_details" ARRAY,
	"specific_data.data.asset_entity_info" ARRAY,
	"specific_data.data.asset_entity_info_details" ARRAY,
	"specific_data.data.axonius_instance_name" ARRAY,
	"specific_data.data.axonius_instance_name_details" ARRAY,
	"specific_data.data.bios_serial" ARRAY,
	"specific_data.data.bios_serial_details" ARRAY,
	"specific_data.data.cloud_id" ARRAY,
	"specific_data.data.cloud_id_details" ARRAY,
	"specific_data.data.cloud_provider" ARRAY,
	"specific_data.data.cloud_provider_details" ARRAY,
	"specific_data.data.device_manufacturer" ARRAY,
	"specific_data.data.device_manufacturer_details" ARRAY,
	"specific_data.data.device_model_preferred" VARCHAR(16777216),
	"specific_data.data.device_model_preferred_details" ARRAY,
	"specific_data.data.domain" ARRAY,
	"specific_data.data.domain_details" ARRAY,
	"specific_data.data.domain_preferred" VARCHAR(16777216),
	"specific_data.data.domain_preferred_details" ARRAY,
	"specific_data.data.fetch_time" VARCHAR(16777216),
	"specific_data.data.fetch_time_details" ARRAY,
	"specific_data.data.first_fetch_time" VARCHAR(16777216),
	"specific_data.data.first_fetch_time_details" ARRAY,
	"specific_data.data.hostname_fqdn_preferred" VARCHAR(16777216),
	"specific_data.data.hostname_fqdn_preferred_details" ARRAY,
	"specific_data.data.hostname_preferred" VARCHAR(16777216),
	"specific_data.data.hostname_preferred_details" ARRAY,
	"specific_data.data.last_seen" VARCHAR(16777216),
	"specific_data.data.last_seen_agents" ARRAY,
	"specific_data.data.last_seen_agents_details" ARRAY,
	"specific_data.data.last_seen_details" ARRAY,
	"specific_data.data.last_used_users_company_association" ARRAY,
	"specific_data.data.last_used_users_company_association_details" ARRAY,
	"specific_data.data.last_used_users_departments_association" ARRAY,
	"specific_data.data.last_used_users_departments_association_details" ARRAY,
	"specific_data.data.name_preferred" VARCHAR(16777216),
	"specific_data.data.name_preferred_details" ARRAY,
	"specific_data.data.network_interfaces.ips_v4_preferred" ARRAY,
	"specific_data.data.network_interfaces.ips_v4_preferred_details" ARRAY,
	"specific_data.data.network_interfaces.ips_v6_preferred" ARRAY,
	"specific_data.data.network_interfaces.ips_v6_preferred_details" ARRAY,
	"specific_data.data.network_interfaces.mac_preferred" ARRAY,
	"specific_data.data.network_interfaces.mac_preferred_details" ARRAY,
	"specific_data.data.network_interfaces.subnets_preferred" ARRAY,
	"specific_data.data.network_interfaces.subnets_preferred_details" ARRAY,
	"specific_data.data.organizational_unit" ARRAY,
	"specific_data.data.organizational_unit_details" ARRAY,
	"specific_data.data.os.build_preferred" VARCHAR(16777216),
	"specific_data.data.os.build_preferred_details" ARRAY,
	"specific_data.data.os.is_windows_server_preferred" VARCHAR(16777216),
	"specific_data.data.os.is_windows_server_preferred_details" ARRAY,
	"specific_data.data.os.major_details" ARRAY,
	"specific_data.data.os.minor_details" ARRAY,
	"specific_data.data.os.os_dotted_details" ARRAY,
	"specific_data.data.os.os_str_preferred" VARCHAR(16777216),
	"specific_data.data.os.os_str_preferred_details" ARRAY,
	"specific_data.data.os.type_distribution_preferred" VARCHAR(16777216),
	"specific_data.data.os.type_distribution_preferred_details" ARRAY,
	"specific_data.data.os.type_preferred" VARCHAR(16777216),
	"specific_data.data.os.type_preferred_details" ARRAY,
	"specific_data.data.os.windows_patch_version" ARRAY,
	"specific_data.data.os.windows_patch_version_details" ARRAY,
	"specific_data.data.os.windows_version_preferred" VARCHAR(16777216),
	"specific_data.data.os.windows_version_preferred_details" ARRAY,
	"specific_data.data.os.os_dotted" VARCHAR(16777216),
	"specific_data.data.os.major" VARCHAR(16777216),
	"specific_data.data.os.minor" VARCHAR(16777216),
	"specific_data.data.serial_number_preferred" VARCHAR(16777216),
	"specific_data.data.serial_number_preferred_details" ARRAY,
	"specific_data.data.sitecode_preferred" VARCHAR(16777216),
	"specific_data.data.sitecode_preferred_details" ARRAY,
	"specific_data.data.time_zone" ARRAY,
	"specific_data.data.time_zone_details" ARRAY,
	"specific_data.data.uuid" ARRAY,
	"specific_data.data.uuid_details" ARRAY,
	"specific_data.data.virtual_host" ARRAY,
	"specific_data.data.virtual_host_details" ARRAY,
	"unique_adapter_names_details" ARRAY,
	ADAPTER_ASSET_ENTITIES_INFO ARRAY
);
create or replace TABLE SEC_VW_IUSG_CUMULATIVE_VULNS (
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	RAW_VULNS VARIANT,
	FILENAME VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9)
);
create or replace TABLE SEC_VW_IUSG_CUMULATIVE_VULNS_240109 (
	DATA_CENTER VARCHAR(16777216),
	FISMA VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	SEVERITY VARCHAR(16777216),
	SEVERITYDESCRIPTION VARCHAR(16777216),
	SEVERITYID VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOITAVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRSTSEEN VARCHAR(16777216),
	LASTSEEN VARCHAR(16777216),
	HASBEENMITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATINGSYSTEM VARCHAR(16777216),
	PLUGINID VARCHAR(16777216),
	PLUGININFO VARCHAR(16777216),
	PLUGINNAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	REPOSITORYDATAFORMAT VARCHAR(16777216),
	REPOSITORYID VARCHAR(16777216),
	REPOSITORYNAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORALSCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	RAW_VULNS VARIANT
);
create or replace TABLE SEC_VW_IUSG_CUMULATIVE_VULNS_WITH_METADATA (
	DATA_CENTER_ID VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	RAW_VULNS VARIANT
);
create or replace TABLE SEC_VW_IUSG_MITIGATED_VULNS (
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	RAW_VULNS VARIANT,
	FILENAME VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9)
);
create or replace TABLE SEC_VW_IUSG_MITIGATED_VULNS_WITH_METADATA (
	DATA_CENTER_ID VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	SYSTEM_ACRONYM VARCHAR(16777216),
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	UUID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	LAST_SEEN TIMESTAMP_LTZ(9),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	HAS_BEEN_MITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	VULNUUID VARCHAR(16777216),
	VULNUNIQUENESS VARCHAR(16777216),
	XREF VARCHAR(16777216),
	SF_FILE_LOAD TIMESTAMP_NTZ(9),
	S3_FILE_CREATE TIMESTAMP_NTZ(9),
	FILENAME VARCHAR(16777216),
	RAW_VULNS VARIANT
);
create or replace TABLE SEC_VW_VULN_AWS (
	REPORT_DATE DATE,
	ACCOUNTID VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	DATA_CENTER_ID VARCHAR(16777216),
	FISMA_ID VARCHAR(16777216),
	ACCEPTRISK VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE ARRAY,
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	EXPLOITAVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	HASBEENMITIGATED VARCHAR(16777216),
	HOSTUNIQUENESS VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	LASTSEEN TIMESTAMP_LTZ(9),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	OPERATINGSYSTEM VARCHAR(16777216),
	PATCHPUBDATE VARCHAR(16777216),
	PLUGINID VARCHAR(16777216),
	PLUGININFO VARCHAR(16777216),
	PLUGINMODDATE VARCHAR(16777216),
	PLUGINNAME VARCHAR(16777216),
	PLUGINPUBDATE VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SEVERITY VARIANT,
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORALSCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	UUID VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT ARRAY,
	VPRSCORE VARCHAR(16777216),
	VULNPUBDATE VARCHAR(16777216),
	XREF VARCHAR(16777216)
);
create or replace TABLE SEC_VW_VULN_CCIC (
	REPORTDATE DATE,
	ACCEPTRISK VARCHAR(16777216),
	ACCEPT_RISK_RULE_COMMENT VARCHAR(16777216),
	ASSET_ID_TATTOO VARCHAR(16777216),
	BASESCORE VARCHAR(16777216),
	BID VARCHAR(16777216),
	CHECKTYPE VARCHAR(16777216),
	CPE VARCHAR(16777216),
	CVE VARCHAR(16777216),
	CVSSV3BASESCORE VARCHAR(16777216),
	CVSSV3TEMPORALSCORE VARCHAR(16777216),
	CVSSV3VECTOR VARCHAR(16777216),
	CVSSVECTOR VARCHAR(16777216),
	DESCRIPTION VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	EXPLOIT_AVAILABLE VARCHAR(16777216),
	EXPLOITEASE VARCHAR(16777216),
	EXPLOITFRAMEWORKS VARCHAR(16777216),
	FAMILY_ID VARCHAR(16777216),
	FAMILY_NAME VARCHAR(16777216),
	FAMILY_TYPE VARCHAR(16777216),
	FIRST_SEEN TIMESTAMP_LTZ(9),
	HAS_BEEN_MITIGATED NUMBER(38,0),
	HOSTUNIQUENESS VARCHAR(16777216),
	IP VARCHAR(16777216),
	IPS VARCHAR(16777216),
	LAST_SEEN TIMESTAMP_LTZ(9),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	OPERATING_SYSTEM VARCHAR(16777216),
	PATCHPUB_DATE VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGIN_INFO VARCHAR(16777216),
	PLUGIN_MOD_DATE VARCHAR(16777216),
	PLUGIN_NAME VARCHAR(16777216),
	PLUGIN_PUB_DATE VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PRIMARY_FISMA_ID VARCHAR(16777216),
	SCAN_START_DATE VARCHAR(16777216),
	SCAN_POLICY_UID VARCHAR(16777216),
	SCAN_POLICY_NAME VARCHAR(16777216),
	CREDENTIALED_SCAN VARCHAR(16777216),
	PORT VARCHAR(16777216),
	PROTOCOL VARCHAR(16777216),
	RECASTRISK VARCHAR(16777216),
	RISKFACTOR VARCHAR(16777216),
	SEEALSO VARCHAR(16777216),
	SEVERITY_DESCRIPTION VARCHAR(16777216),
	SEVERITY_ID VARCHAR(16777216),
	SEVERITY_NAME VARCHAR(16777216),
	SOLUTION VARCHAR(16777216),
	STIGSEVERITY VARCHAR(16777216),
	SYNOPSIS VARCHAR(16777216),
	TEMPORAL_SCORE VARCHAR(16777216),
	UNIQUENESS VARCHAR(16777216),
	UUID VARCHAR(16777216),
	HOSTUUID VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	VPRCONTEXT VARCHAR(16777216),
	VPR_SCORE VARCHAR(16777216),
	VULN_PUB_DATE VARCHAR(16777216),
	XREF VARCHAR(16777216),
	REPOSITORY_DATAFORMAT VARCHAR(16777216),
	REPOSITORY_DESCRIPTION VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	RECASTRISKRULECOMMENT VARCHAR(16777216),
	ACRSCORE VARCHAR(16777216),
	ASSETEXPOSURESCORE VARCHAR(16777216),
	KEYDRIVERS VARCHAR(16777216)
);
create or replace TABLE SNAPSHOT_IDS (
	SNAPSHOT_ID NUMBER(38,0) NOT NULL,
	COMMENTS VARCHAR(16777216),
	DATACATEGORY VARCHAR(16777216) NOT NULL,
	ERROR_COUNT NUMBER(38,0),
	MAX_DATE TIMESTAMP_LTZ(9),
	MIN_DATE TIMESTAMP_LTZ(9),
	RECORD_COUNT NUMBER(38,0),
	RECORDS_WITH_ERRORS NUMBER(38,0),
	RECORDS_WITH_WARNINGS NUMBER(38,0),
	SNAPSHOT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	WARNING_COUNT NUMBER(38,0),
	PARENT_DATACATEGORY VARCHAR(16777216),
	REPORT_ID NUMBER(38,0),
	UNASSIGNED_DW_ASSET_ID NUMBER(38,0),
	TOTAL_DISTINCT_TENABLEUID NUMBER(38,0),
	TOTAL_NULL_CVE NUMBER(38,0),
	TOTAL_NULL_SEVERITY_NAME NUMBER(38,0),
	TOTAL_TATTOO_PLUGINS NUMBER(38,0),
	TOTAL_PLUGINS_NOT_TATTOO NUMBER(38,0),
	TOTAL_NULL_DATACENTER_ID NUMBER(38,0),
	TOTAL_DATACENTER_ID_INVALID NUMBER(38,0),
	TOTAL_ERRORS NUMBER(38,0),
	TOTAL_IS_FROM_AWS_FEED NUMBER(38,0),
	TOTAL_CVSS_IS_ZERO NUMBER(38,0),
	TOTAL_SEVERITY_NAME_INFO NUMBER(38,0),
	TOTAL_CRITICAL NUMBER(38,0),
	TOTAL_HIGH NUMBER(38,0),
	TOTAL_MEDIUM NUMBER(38,0),
	TOTAL_LOW NUMBER(38,0),
	TOTAL_VIABLE NUMBER(38,0),
	TOTAL_TENABLEUID_PLUGINID NUMBER(38,0),
	TOTAL_TENABLEUID_CVE NUMBER(38,0),
	primary key (SNAPSHOT_ID)
);
create or replace TABLE SOFTWAREMASTER (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	CATEGORY VARCHAR(16777216) NOT NULL,
	EOL_DATE TIMESTAMP_LTZ(9) NOT NULL,
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	RECOMMENDED_VERSION VARCHAR(16777216),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SUBCATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
)COMMENT='Master list of software\t'
;
create or replace TRANSIENT TABLE SOFTWARE_MANUF_LINK (
	SOFTWARE_ID NUMBER(38,0),
	SOFTWARE_KEY VARCHAR(16777216),
	SOFTWARE_NAME_VARIATIONS VARIANT,
	CREATED TIMESTAMP_NTZ(9),
	UPDATED TIMESTAMP_NTZ(9),
	MANUFACTURER VARCHAR(16777216)
);
create or replace TRANSIENT TABLE SOFTWARE_NAME_MASTER (
	SOFTWARE_ID NUMBER(38,0) autoincrement start 1000 increment 1 noorder,
	SOFTWARE_KEY VARCHAR(16777216),
	SOFTWARE_NAME_VARIATIONS VARIANT,
	CREATED TIMESTAMP_NTZ(9),
	UPDATED TIMESTAMP_NTZ(9)
);
create or replace TABLE SYSTEM_DATERETIRED (
	ACRONYM VARCHAR(16777216),
	CFACTS_UID VARCHAR(16777216),
	DATERETIRED DATE
);
create or replace TABLE TABLEAU_EUA_10_23_24 (
	IP_ADDRESS VARCHAR(16777216),
	NETBIOS_NAME VARCHAR(16777216),
	LAST_OBSERVED VARCHAR(16777216)
);
create or replace TRANSIENT TABLE TECHNO_ASSET_SOFT_JOIN (
	SOFTWARENAME VARCHAR(16777216),
	TECHNOPEDIA_SOFTWARE_PRODUCT_ID VARCHAR(16777216),
	PRODUCT_NAME VARCHAR(16777216),
	MANUFACTURER VARCHAR(16777216)
);
create or replace TRANSIENT TABLE TECNO_SOFTWARE_DIST (
	PRODUCT_NAME VARCHAR(16777216),
	MANUFACTURER VARCHAR(16777216)
);
create or replace TRANSIENT TABLE TECNO_SOFTWARE_NAME (
	PRODUCT_NAME VARCHAR(16777216)
);
create or replace TABLE TEMP_ASSETSOFTWARE (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9) NOT NULL,
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216) NOT NULL,
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216) NOT NULL,
	SWAM_CATEGORY VARCHAR(16777216) NOT NULL,
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
)COMMENT='Temporary table containing Software associated with an asset for RPT_DEV\t'
;
create or replace TABLE TEMP_ASSET_SOFTWARE_TOM (
	ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DATEINSTALLED TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	FIRSTSEEN TIMESTAMP_LTZ(9),
	LASTSEEN TIMESTAMP_LTZ(9),
	MAJOR VARCHAR(16777216),
	MINOR VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	PRODUCTNAME VARCHAR(16777216),
	RAW_DATEINSTALLED VARCHAR(16777216),
	RAW_PRODUCT VARCHAR(16777216),
	RAW_SOFTWARE VARCHAR(16777216),
	RAW_VERSION VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOFTWARENAME VARCHAR(16777216),
	SOURCE_TOOL VARCHAR(16777216),
	SWAM_CATEGORY VARCHAR(16777216),
	VENDOR VARCHAR(16777216),
	VERSION VARCHAR(16777216),
	primary key (ID)
);
create or replace TABLE TEMP_BOD_BACKUP_241106 (
	CVE VARCHAR(16777216),
	DATEADDED DATE,
	VULNERABILITYNAME VARCHAR(16777216)
);
create or replace TABLE TEMP_DUPLICATE_FQDN_3RD_PASS (
	DISPOSITION VARCHAR(4),
	MIN_INSERTDATE TIMESTAMP_LTZ(9),
	MAX_INSERTDATE TIMESTAMP_LTZ(9),
	ID NUMBER(38,0),
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	NORMALIZED_FQDN VARCHAR(16777216)
);
create or replace TABLE TEMP_DUPLICATE_FQDN_4TH_PASS (
	DISPOSITION VARCHAR(4),
	MIN_INSERTDATE TIMESTAMP_LTZ(9),
	MAX_INSERTDATE TIMESTAMP_LTZ(9),
	ID NUMBER(38,0),
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	FQDN VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	NORMALIZED_FQDN VARCHAR(16777216)
);
create or replace TABLE TEMP_DUPLICATE_HOSTNAME (
	DISPOSITION VARCHAR(4),
	MIN_INSERTDATE TIMESTAMP_LTZ(9),
	MAX_INSERTDATE TIMESTAMP_LTZ(9),
	ID NUMBER(38,0),
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	HOSTNAME VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	NORMALIZED_HOSTNAME VARCHAR(16777216)
);
create or replace TABLE TEMP_DUPLICATE_NETBIOSNAME (
	DISPOSITION VARCHAR(4),
	MIN_INSERTDATE TIMESTAMP_LTZ(9),
	MAX_INSERTDATE TIMESTAMP_LTZ(9),
	ID NUMBER(38,0),
	DATACATEGORY VARCHAR(16777216),
	DATEUSEDBYMATCHING TIMESTAMP_LTZ(9),
	DW_ASSET_ID NUMBER(38,0),
	INSERT_DATE TIMESTAMP_LTZ(9),
	NETBIOSNAME VARCHAR(16777216),
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	NORMALIZED_NETBIOSNAME VARCHAR(16777216)
);
create or replace TABLE TEMP_HWAM_TEST (
	TEST_DW_ASSET_ID NUMBER(38,0),
	ASSET_ID_TATTOO VARCHAR(16777216),
	AWS_ACCOUNTID VARCHAR(16777216),
	AWS_INSTANCE_ID VARCHAR(16777216),
	DATACENTER_ID VARCHAR(16777216),
	FQDN ARRAY,
	HOSTNAME ARRAY,
	IPV4 ARRAY,
	IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC BOOLEAN,
	CREDENTIALED_SCAN BOOLEAN,
	LAST_CONFIRMED_TIME TIMESTAMP_LTZ(9),
	MACADDRESS ARRAY,
	NETBIOSNAME ARRAY,
	OS VARCHAR(16777216),
	SNAPSHOT_ID NUMBER(38,0),
	SOURCE_TOOL VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TENABLEUUID VARCHAR(16777216),
	TENANT_ID VARCHAR(16777216)
);
create or replace TABLE TEMP_VULN_TRENDING (
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	"CVE Count" NUMBER(18,0),
	"Unique CVE Count" NUMBER(18,0),
	CURRENTMTDSTART VARCHAR(16777216),
	DATA_CENTER_NAME VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(21,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	IS_MARKETPLACE BOOLEAN,
	MEFSTATUS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	PREVEOMSTART VARCHAR(16777216),
	RANKK NUMBER(18,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	REPORT_DATE DATE,
	REPORT_ID NUMBER(38,0),
	TLC_PHASE VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2)
);
create or replace TABLE TEMP_VULN_TRENDING_TEST241107 (
	ACRONYM VARCHAR(16777216),
	COMPONENT_ACRONYM VARCHAR(16777216),
	"CVE Count" NUMBER(18,0),
	"Unique CVE Count" NUMBER(18,0),
	CURRENTMTDSTART DATE,
	DATA_CENTER_NAME VARCHAR(16777216),
	DATECREATED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(21,0),
	EXPLOITAVAILABLE VARCHAR(16777216),
	FISMASEVERITY VARCHAR(16777216),
	HVASTATUS VARCHAR(16777216),
	IS_BOD VARCHAR(3),
	IS_MARKETPLACE BOOLEAN,
	MEFSTATUS VARCHAR(16777216),
	MITIGATIONSTATUS VARCHAR(16777216),
	MTDVSEOM VARCHAR(16777216),
	PREVEOMSTART DATE,
	RANKK NUMBER(19,0),
	REFRESH_DATE TIMESTAMP_LTZ(9),
	REPORT_DATE DATE,
	REPORT_ID NUMBER(38,0),
	TLC_PHASE VARCHAR(16777216),
	VULNRISKTOLERANCE NUMBER(10,2)
);
create or replace TABLE TEST_NORMALIZED_FQDN (
	FQDN VARCHAR(16777216),
	NORMALIZED_FQDN VARCHAR(16777216),
	DATACATEGORY VARCHAR(16777216)
);
create or replace TABLE TEST_NORMALIZED_NETBIOSNAME (
	NETBIOSNAME VARCHAR(16777216),
	NORMALIZED_NETBIOSNAME VARCHAR(16777216),
	DATACATEGORY VARCHAR(16777216)
);
create or replace TABLE VSTAGE (
	ACCOUNTID VARCHAR(16777216),
	DNSNAME VARCHAR(16777216),
	INSTANCEID VARCHAR(16777216),
	IP VARCHAR(16777216),
	MACADDRESS VARCHAR(16777216),
	NETBIOSNAME VARCHAR(16777216),
	PLUGIN_ID VARCHAR(16777216),
	PLUGINTEXT VARCHAR(16777216),
	TEMP_ASSET_KEY VARCHAR(16777216),
	TEMP_DW_ASSET_ID NUMBER(38,0),
	UUID VARCHAR(16777216)
);
create or replace TABLE VULMASTER (
	DW_VUL_ID NUMBER(38,0) NOT NULL autoincrement start 1 increment 1 order,
	DW_PLUGIN_VUL_ID_CREATE NUMBER(38,0) NOT NULL,
	DW_PLUGIN_VUL_ID_MODIFY NUMBER(38,0) NOT NULL,
	CVE VARCHAR(16777216) NOT NULL,
	CVSSV2BASESCORE NUMBER(38,1),
	CVSSV3BASESCORE NUMBER(38,1),
	DATEDELETED TIMESTAMP_LTZ(9),
	DATEMITIGATED TIMESTAMP_LTZ(9),
	DATEMODIFIED TIMESTAMP_LTZ(9),
	DATEREOPENED TIMESTAMP_LTZ(9),
	DAYSSINCEDISCOVERY NUMBER(38,0),
	DELETIONREASON VARCHAR(16777216),
	DW_ASSET_ID NUMBER(38,0) NOT NULL,
	EXPLOITAVAILABLE VARCHAR(16777216),
	FIRSTSEEN TIMESTAMP_LTZ(9),
	FISMASEVERITY VARCHAR(16777216),
	INSERT_DATE TIMESTAMP_LTZ(9) NOT NULL,
	IS_FROM_AWS_FEED BOOLEAN,
	IS_LEGACY BOOLEAN,
	IS_PREV_DELETED BOOLEAN,
	LASTFOUND TIMESTAMP_LTZ(9),
	MITIGATIONSTATUS VARCHAR(16777216),
	NUMERIC_SEVERITY NUMBER(38,0),
	ORIG_FISMASEVERITY VARCHAR(16777216),
	ORIG_MITIGATIONSTATUS VARCHAR(16777216),
	PREV_FISMASEVERITY VARCHAR(16777216),
	PREV_MITIGATIONSTATUS VARCHAR(16777216),
	REPOSITORY_ID VARCHAR(16777216),
	REPOSITORY_NAME VARCHAR(16777216),
	EXTENDED_MITIGATIONSTATUS VARCHAR(16777216),
	primary key (DW_VUL_ID)
)COMMENT='Master list of the vulnerabilities by DW_ASSET_ID and CVE. Provides asset and current vuln as well as dates\t'
;
create or replace TABLE VW_CFACTS_POAM (
	ACTUAL_COMPLETION_DATE TIMESTAMP_LTZ(9),
	ACTUAL_LABOR_COST VARCHAR(16777216),
	CAAT VARCHAR(16777216),
	CAAT_ID VARCHAR(16777216),
	DAYS_OPEN VARCHAR(16777216),
	ESTIMATED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	FINDING_ID VARCHAR(16777216),
	FUNDING_SOURCE VARCHAR(16777216),
	LABOR_ESTIMATE VARCHAR(16777216),
	OVERALL_STATUS VARCHAR(16777216),
	POAM_CLOSED_DATE TIMESTAMP_LTZ(9),
	POAM_ID VARCHAR(16777216),
	POAM_OWNER VARCHAR(16777216),
	POAM_REVIEWER VARCHAR(16777216),
	REVIEW_COMMENTS VARCHAR(16777216),
	REVIEW_DATE TIMESTAMP_LTZ(9),
	REVIEW_STATUS VARCHAR(16777216),
	SCHEDULED_COMPLETION_DATE TIMESTAMP_LTZ(9),
	SOURCE_AUDIT_TYPE_2 VARCHAR(16777216),
	SUBMISSION_STATUS VARCHAR(16777216),
	SYSTEM_ID VARCHAR(16777216),
	TARGET VARCHAR(16777216),
	WEAKNESS_CREATION_DATE TIMESTAMP_LTZ(9),
	WEAKNESS_ID VARCHAR(16777216),
	WEAKNESS_POC VARCHAR(16777216),
	WEAKNESS_RISK_LEVEL VARCHAR(16777216),
	WEAKNESS_SEVERITY VARCHAR(16777216)
);
create or replace view SEC_VW_CDM_VISIBILITY_APP_CFACTS(
	SYSTEM_ID,
	HWAM_VISIBLE,
	SWAM_VISIBLE,
	VUL_VISIBLE,
	HARDWARE_DATACENTERS,
	HARDWARE_HOST_STATUS,
	AWS_SECHUB_ENABLED,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL
) as
WITH LAST_SEEN AS (
    SELECT 
        SYSTEM_ID,
        MAX(LASTSEEN_HWAM)::DATE AS LASTSEEN_HWAM,
        MAX(LASTSEEN_SWAM)::DATE AS LASTSEEN_SWAM,
        MAX(LASTSEEN_VUL)::DATE AS LASTSEEN_VUL,
        ARRAY_AGG(DISTINCT DATACENTER_ACRONYM) 
            WITHIN GROUP (ORDER BY DATACENTER_ACRONYM ASC) AS HARDWARE_DATACENTERS,
        ARRAY_AGG(DISTINCT DATACENTER_ID) AS HARDWARE_DATACENTER_IDS
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VW_ASSETS 
    GROUP BY SYSTEM_ID
    ORDER BY SYSTEM_ID
), 
HARDWARE_STATUS AS (
    SELECT 
        SYSTEM_ID, 
        ARRAY_SIZE(HARDWARE_DATACENTER_IDS) AS DATACENTER_COUNT,
        SUM(AWS_PRESENCE_ID) AS AWS_DATACENTER_COUNT
    FROM (
        SELECT 
            SYSTEM_ID,
            HARDWARE_DATACENTER_IDS,
            DC_ID.VALUE,
            CASE 
                WHEN DC_ID.VALUE IN ('56FFF52E-175B-4E48-9B38-669C8BC74899', '5d8a99a8db672340f99cfd721f96190d') 
                THEN 1 
                ELSE 0 
            END AS AWS_PRESENCE_ID
        FROM LAST_SEEN,
        LATERAL FLATTEN(INPUT => HARDWARE_DATACENTER_IDS) AS DC_ID
    ) 
    GROUP BY SYSTEM_ID, HARDWARE_DATACENTER_IDS
)
SELECT 
    L.SYSTEM_ID,
    CASE WHEN LASTSEEN_HWAM IS NOT NULL THEN 'Y' ELSE 'N' END AS HWAM_VISIBLE,
    CASE WHEN LASTSEEN_SWAM IS NOT NULL THEN 'Y' ELSE 'N' END AS SWAM_VISIBLE,
    CASE WHEN LASTSEEN_VUL IS NOT NULL THEN 'Y' ELSE 'N' END AS VUL_VISIBLE,
    HARDWARE_DATACENTERS,
    CASE
        WHEN H.AWS_DATACENTER_COUNT = 0 THEN 'Not HWAM AWS Hosted'
        WHEN H.DATACENTER_COUNT > 0 AND H.DATACENTER_COUNT = H.AWS_DATACENTER_COUNT 
            THEN 'Fully HWAM AWS Hosted'
        WHEN H.AWS_DATACENTER_COUNT > 0 AND H.AWS_DATACENTER_COUNT < H.DATACENTER_COUNT 
            THEN 'Multi HWAM AWS Hosted'
        ELSE 'Not HWAM AWS Hosted'
    END AS HARDWARE_HOST_STATUS,
    CASE WHEN S.SYSTEM_ID IS NOT NULL THEN 'Y' ELSE 'N' END AS AWS_SECHUB_ENABLED,
    LASTSEEN_HWAM,
    LASTSEEN_SWAM,
    LASTSEEN_VUL
FROM LAST_SEEN L 
JOIN HARDWARE_STATUS H 
    ON L.SYSTEM_ID = H.SYSTEM_ID 
LEFT JOIN BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS S 
    ON S.SYSTEM_ID = L.SYSTEM_ID 
    AND S.COMPONENT_ACRONYM = 'OIT' 
    AND S.AWS_ACCOUNTIDS IS NOT NULL;


;;;;
create or replace view VW_ALL_SCANS(
	COMPONENT_ACRONYM,
	ACRONYM,
	REPORT_ID,
	REPORT_DATE,
	YYMM,
	SYSTEM_ID,
	TOTAL_ASSETS,
	TOTAL_ASSETS_SCANNED
) COMMENT='Reports ALL component scans\t'
 as
select t.COMPONENT_ACRONYM,t.ACRONYM,t.REPORT_ID,t.REPORT_DATE,t.YYMM,t.SYSTEM_ID
    ,coalesce(a.TOTAL_ASSETS,0) as TOTAL_ASSETS,coalesce(scan.TOTAL_ASSETS_SCANNED,0) as TOTAL_ASSETS_SCANNED
FROM (select s.COMPONENT_ACRONYM,s.ACRONYM,s.SYSTEM_ID,r.REPORT_ID,r.REPORT_DATE,r.YYMM 
    FROM (select COMPONENT_ACRONYM,ACRONYM,SYSTEM_ID FROM CORE.VW_SYSTEMS) s

    JOIN (SELECT r1.REPORT_ID,r1.REPORT_DATE,to_char(r1.REPORT_DATE,'YYMM') as YYMM
        FROM (select rank()over(partition by REPORT_ID order by REPORT_DATE::date) TheRank,REPORT_ID,REPORT_DATE::date as REPORT_DATE
            FROM CORE.REPORT_IDS where is_viable = 1 and REPORT_DATE::date >= '2024-02-01'::date) r1 where r1.TheRank = 1) r) t

left outer join (select  r.REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    GROUP BY s.COMPONENT_ACRONYM,s.ACRONYM,r.REPORT_ID,r.REPORT_DATE::date,ah.SYSTEM_ID) a on a.REPORT_ID = t.REPORT_ID and a.SYSTEM_ID = t.SYSTEM_ID
    
left outer join (select r.REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS_SCANNED
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    where ah.LASTSEEN_VUL IS NOT NULL and ah.LASTSEEN_VUL::date = r.REPORT_DATE::date
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date,ah.SYSTEM_ID) scan on scan.REPORT_ID = a.REPORT_ID and scan.SYSTEM_ID = a.SYSTEM_ID
;
create or replace view VW_ASSETS_CHRIS(
	IS_APPLICABLE,
	INSERT_DATE,
	DATEDELETED,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) as
SELECT 
a.Is_Applicable
,a.INSERT_DATE
,a.DATEDELETED
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,a.ASSET_ID_TATTOO
,a.AWS_INSTANCESTATUS
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID -- 230712
,a.COMPUTER_TYPE
,dc.COMMONNAME as DATACENTER_COMMONNAME
,a.DATACENTER_ID
,a.DATEMODIFIED
,a.DEVICEMODEL -- 230703
,dr.DEVICEROLE
,a.DEVICETYPE -- 230703 was dt.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,aic.IPV4
,aic.IPV6
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,aic.MACADDRESS
,a.MOTHERBOARD
,aic.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,s.COMMONNAME as SYSTEM_COMMONNAME
,s.SYSTEM_ID
,a.TENABLEUUID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
LEFT OUTER join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID) -- 230629 added upper
LEFT OUTER join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID) -- 230629 added upper
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE) -- 230629 added upper
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE) -- 230629 added upper
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID;
create or replace view VW_ASSET_SOFTWARE(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	DEVICETYPE,
	ID,
	DATEINSTALLED,
	DW_ASSET_ID,
	FIRSTSEEN,
	LASTSEEN,
	MAJOR,
	MINOR,
	PRODUCTNAME,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	VENDOR,
	VERSION,
	PLUGIN_LINE,
	RAW_PLUGIN_TEXT
) COMMENT='View reports software related to assets \t'
 as
SELECT 
a.datacenter_acronym
,a.system_acronym
-- ,a.DW_ASSET_ID
,a.ASSET_ID_TATTOO
,a.DEVICETYPE 
,asoft.id
,TO_CHAR(asoft.dateinstalled,'MM/DD/YYYY') as dateinstalled
,asoft.DW_ASSET_ID
,TO_CHAR(asoft.firstseen,'MM/DD/YYYY') as firstseen
,TO_CHAR(asoft.lastseen,'MM/DD/YYYY') as lastseen
,asoft.major
,asoft.minor
,asoft.productname
,asoft.softwarename
,asoft.source_tool
,asoft.swam_category
,asoft.vendor
,asoft.version
,asoft.plugin_line
,asoft.raw_plugin_text

FROM CORE.VW_ASSETS a
JOIN sandbox.assetsoftware as asoft on asoft.dw_asset_id = a.dw_asset_id;
create or replace view VW_COMPARESYSTEMS(
	THESOURCE,
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) as
SELECT
'SDW' as THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
--,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE::DATE as FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
--,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM CORE.VW_SYSTEMS

UNION ALL

SELECT
THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
--,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
--,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM SANDBOX.VW_LEGACYSYSTEMS
;
create or replace view VW_COMPARESYSTEMS_DETAIL(
	THESOURCE,
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) as
select cs.*
FROM 

(SELECT
THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
--,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
--,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM SANDBOX.VW_LEGACYSYSTEMS) legacy

JOIN (SELECT
'SDW' as THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
--,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE::DATE as FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
--,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM CORE.VW_SYSTEMS) sdw on sdw.SYSTEM_ID = legacy.SYSTEM_ID

JOIN sandbox.vw_comparesystems cs on cs.system_id = legacy.SYSTEM_ID

WHERE
-- The following do not need to be matched or will be matched apart from the view
-- AWS_ACCOUNTIDS
-- INSERT_DATE
-- DATEDELETED
-- DATEMODIFIED
-- TOTALASSETS 
-- TOTALPOAMWITHAPPROVEDRBD 
coalesce(sdw.ACRONYM,'0') <> coalesce(legacy.ACRONYM,'0')
or coalesce(sdw.ARCHER_TRACKING_ID,'0') <> coalesce(legacy.ARCHER_TRACKING_ID,'0')
or coalesce(sdw.ATO_EXPIRATION_DATE,'1900-01-01'::date) <> coalesce(legacy.ATO_EXPIRATION_DATE,'1900-01-01'::date)
or coalesce(sdw.ATO_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.ATO_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.AUTH_COMMENTS,'0') <> coalesce(legacy.AUTH_COMMENTS,'0') -- bad characters
or coalesce(sdw.AUTH_DECISION,'0') <> coalesce(legacy.AUTH_DECISION,'0')
or coalesce(sdw.AUTHORIZATION_MEMO_SIGNED_DATE,'1900-01-01'::date) <> coalesce(legacy.AUTHORIZATION_MEMO_SIGNED_DATE,'1900-01-01'::date)
or coalesce(sdw.AUTHORIZATION_PACKAGE,'0') <> coalesce(legacy.AUTHORIZATION_PACKAGE,'0')
or coalesce(sdw.BO_RECOMMENDATION_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.BO_RECOMMENDATION_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.BO_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.BO_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.BUSINESS_OWNER,'0') <> coalesce(legacy.BUSINESS_OWNER,'0')
or coalesce(sdw.CIO,'0') <> coalesce(legacy.CIO,'0')
or coalesce(sdw.CISO,'0') <> coalesce(legacy.CISO,'0')
or coalesce(sdw.CISO_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.CISO_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.CLOUD_SERVICE_PROVIDER,'0') <> coalesce(legacy.CLOUD_SERVICE_PROVIDER,'0')
or coalesce(sdw.COMMONNAME,'0') <> coalesce(legacy.COMMONNAME,'0')
or coalesce(sdw.COMPONENT_ACRONYM,'0') <> coalesce(legacy.COMPONENT_ACRONYM,'0')
or coalesce(sdw.COMPONENT_DESCRIPTION,'0') <> coalesce(legacy.COMPONENT_DESCRIPTION,'0') -- bad characters
or coalesce(sdw.COMPONENT_NAME,'0') <> coalesce(legacy.COMPONENT_NAME,'0')
or coalesce(sdw.COMPONENT_RISK_REPORTS_OVERSIGHT,'0') <> coalesce(legacy.COMPONENT_RISK_REPORTS_OVERSIGHT,'0')
or coalesce(sdw.CONTINGENCYEXPIRATIONDATE,'1900-01-01'::date) <> coalesce(legacy.CONTINGENCYEXPIRATIONDATE,'1900-01-01'::date)
or coalesce(sdw.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,'0') <> coalesce(legacy.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,'0')
or coalesce(sdw.CP_TEST_DATE,'1900-01-01'::date) <> coalesce(legacy.CP_TEST_DATE,'1900-01-01'::date)
or coalesce(sdw.CP_TEST_RESULTS,'0') <> coalesce(legacy.CP_TEST_RESULTS,'0')
or coalesce(sdw.CRA,'0') <> coalesce(legacy.CRA,'0')
or coalesce(sdw.CRA_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.CRA_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.CYBERVET,'0') <> coalesce(legacy.CYBERVET,'0')
or coalesce(sdw.DATE_AUTH_MEMO_EXPIRES,'1900-01-01'::date) <> coalesce(legacy.DATE_AUTH_MEMO_EXPIRES,'1900-01-01'::date)
or coalesce(sdw.DATE_AUTH_MEMO_SIGNED,'1900-01-01'::date) <> coalesce(legacy.DATE_AUTH_MEMO_SIGNED,'1900-01-01'::date)
or coalesce(sdw.DCISO,'0') <> coalesce(legacy.DCISO,'0')
or coalesce(sdw.DIVISION_ACRONYM,'0') <> coalesce(legacy.DIVISION_ACRONYM,'0')
or coalesce(sdw.DIVISION_DESCRIPTION,'0') <> coalesce(legacy.DIVISION_DESCRIPTION,'0') -- bad characters
or coalesce(sdw.DIVISION_NAME,'0') <> coalesce(legacy.DIVISION_NAME,'0')
or coalesce(sdw.DSPC_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.DSPC_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.DSPPO_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.DSPPO_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.E_AUTH_EXP_DATE,'1900-01-01'::date) <> coalesce(legacy.E_AUTH_EXP_DATE,'1900-01-01'::date)
or coalesce(sdw.E_AUTH_LEVEL,'0') <> coalesce(legacy.E_AUTH_LEVEL,'0')
or coalesce(sdw.E_AUTH_RISK_ASSESSMENT_DATE,'1900-01-01'::date) <> coalesce(legacy.E_AUTH_RISK_ASSESSMENT_DATE,'1900-01-01'::date)
or coalesce(sdw.FINANCIAL_SYSTEM,'0') <> coalesce(legacy.FINANCIAL_SYSTEM,'0')
or coalesce(sdw.FIPS_199_AVAILABILITY_RATING,'0') <> coalesce(legacy.FIPS_199_AVAILABILITY_RATING,'0')
or coalesce(sdw.FIPS_199_CONFIDENTIALITY_RATING,'0') <> coalesce(legacy.FIPS_199_CONFIDENTIALITY_RATING,'0')
or coalesce(sdw.FIPS_199_INTEGRITY_RATING,'0') <> coalesce(legacy.FIPS_199_INTEGRITY_RATING,'0')
or coalesce(sdw.FIPS_199_OVERALL_IMPACT_RATING,'0') <> coalesce(legacy.FIPS_199_OVERALL_IMPACT_RATING,'0')
or coalesce(sdw.FIRST_PUBLISHED_DATE,'1900-01-01'::date) <> coalesce(legacy.FIRST_PUBLISHED_DATE,'1900-01-01'::date)
or coalesce(sdw.FISMA_SYSTEM,'0') <> coalesce(legacy.FISMA_SYSTEM,'0')
or coalesce(sdw.GROUP_ACRONYM,'0') <> coalesce(legacy.GROUP_ACRONYM,'0')
or coalesce(sdw.GROUP_DESCRIPTION,'0') <> coalesce(legacy.GROUP_DESCRIPTION,'0') -- bad characters
or coalesce(sdw.GROUP_NAME,'0') <> coalesce(legacy.GROUP_NAME,'0')
or coalesce(sdw.HVA_SCORE,'0') <> coalesce(legacy.HVA_SCORE,'0')
or coalesce(sdw.HVASTATUS,'0') <> coalesce(legacy.HVASTATUS,'0')
or coalesce(sdw.IN_CMS_CLOUD,'0') <> coalesce(legacy.IN_CMS_CLOUD,'0')
or coalesce(sdw.INFORMATION_SYSTEM_TYPE,'0') <> coalesce(legacy.INFORMATION_SYSTEM_TYPE,'0')
or coalesce(sdw.IS_DATACENTER,'0') <> coalesce(legacy.IS_DATACENTER,'0')
or coalesce(sdw.IS_EXCLUDEFROMREPORTING,'0') <> coalesce(legacy.IS_EXCLUDEFROMREPORTING,'0')
or coalesce(sdw.IS_HIGHRISKSYSTEM,'0') <> coalesce(legacy.IS_HIGHRISKSYSTEM,'0')
or coalesce(sdw.IS_MARKETPLACE,'0') <> coalesce(legacy.IS_MARKETPLACE,'0')
or coalesce(sdw.IS_OA_READY,'0') <> coalesce(legacy.IS_OA_READY,'0')
or coalesce(sdw.IS_OPERATIONALSYSTEM,'0') <> coalesce(legacy.IS_OPERATIONALSYSTEM,'0')
or coalesce(sdw.IS_PHANTOMSYSTEM,'0') <> coalesce(legacy.IS_PHANTOMSYSTEM,'0')
or coalesce(sdw.IS_SECURITYHUB_ENABLED,'0') <> coalesce(legacy.IS_SECURITYHUB_ENABLED,'0')
or coalesce(sdw.ISRA_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.ISRA_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.ISRA_STATUS,'0') <> coalesce(legacy.ISRA_STATUS,'0')
or coalesce(sdw.ISSO,'0') <> coalesce(legacy.ISSO,'0')
or coalesce(sdw.ISSO_COUNT,'0') <> coalesce(legacy.ISSO_COUNT,'0')
or coalesce(sdw.ISSO_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.ISSO_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.ISSO_SUBMISSION_DATE,'1900-01-01'::date) <> coalesce(legacy.ISSO_SUBMISSION_DATE,'1900-01-01'::date)
or coalesce(sdw.ISSOCS,'0') <> coalesce(legacy.ISSOCS,'0')
or coalesce(sdw.LAST_ACT_DATE,'1900-01-01'::date) <> coalesce(legacy.LAST_ACT_DATE,'1900-01-01'::date)
or coalesce(sdw.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,'1900-01-01'::date) <> coalesce(legacy.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,'1900-01-01'::date)
or coalesce(sdw.LAST_ACT_SCA_FINAL_REPORT_DATE,'1900-01-01'::date) <> coalesce(legacy.LAST_ACT_SCA_FINAL_REPORT_DATE,'1900-01-01'::date)
or coalesce(sdw.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,'1900-01-01'::date) <> coalesce(legacy.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,'1900-01-01'::date)
or coalesce(sdw.LAST_PENTEST_DATE,'1900-01-01'::date) <> coalesce(legacy.LAST_PENTEST_DATE,'1900-01-01'::date)
or coalesce(sdw.MEF,'0') <> coalesce(legacy.MEF,'0')
or coalesce(sdw.MEF_CONTEXT,'0') <> coalesce(legacy.MEF_CONTEXT,'0')
or coalesce(sdw.MEFSTATUS,'0') <> coalesce(legacy.MEFSTATUS,'0')
or coalesce(sdw.NEXT_REQUIRED_CP_TEST_DATE,'1900-01-01'::date) <> coalesce(legacy.NEXT_REQUIRED_CP_TEST_DATE,'1900-01-01'::date)
or coalesce(sdw.OA_STATUS,'0') <> coalesce(legacy.OA_STATUS,'0')
or coalesce(sdw.OATO_CATEGORY,'0') <> coalesce(legacy.OATO_CATEGORY,'0')
or coalesce(sdw.PACKAGE_TYPE,'0') <> coalesce(legacy.PACKAGE_TYPE,'0')
or coalesce(sdw.PIA_014,'0') <> coalesce(legacy.PIA_014,'0')
or coalesce(sdw.PIA_EXPIRATION_DATE,'1900-01-01'::date) <> coalesce(legacy.PIA_EXPIRATION_DATE,'1900-01-01'::date)
or coalesce(sdw.PII_PHI,'0') <> coalesce(legacy.PII_PHI,'0')
or coalesce(sdw.PRIMARY_ISSO,'0') <> coalesce(legacy.PRIMARY_ISSO,'0')
or coalesce(sdw.PRIMARY_OPERATING_LOCATION,'0') <> coalesce(legacy.PRIMARY_OPERATING_LOCATION,'0')
or coalesce(sdw.PRIMARY_OPERATING_LOCATION_ACRONYM,'0') <> coalesce(legacy.PRIMARY_OPERATING_LOCATION_ACRONYM,'0')
or coalesce(sdw.PRIMARY_OPERATING_LOCATION_ID,'0') <> coalesce(legacy.PRIMARY_OPERATING_LOCATION_ID,'0')
or coalesce(sdw.REASON_FOR_ATO_REQUEST,'0') <> coalesce(legacy.REASON_FOR_ATO_REQUEST,'0')
or coalesce(sdw.SCA,'0') <> coalesce(legacy.SCA,'0') -- bad characters
or coalesce(sdw.SCA_DATE,'1900-01-01'::date) <> coalesce(legacy.SCA_DATE,'1900-01-01'::date)
or coalesce(sdw.SDM,'0') <> coalesce(legacy.SDM,'0')
or coalesce(sdw.SOP_REVIEW_DATE,'1900-01-01'::date) <> coalesce(legacy.SOP_REVIEW_DATE,'1900-01-01'::date)
or coalesce(sdw.STE_DATE,'1900-01-01'::date) <> coalesce(legacy.STE_DATE,'1900-01-01'::date)
or coalesce(sdw.SYSTEM_DESCRIPTION,'0') <> coalesce(legacy.SYSTEM_DESCRIPTION,'0') -- bad characters, FN_CRM_STRIPHTML is truncating the string
or coalesce(sdw.SYSTEM_ID,'0') <> coalesce(legacy.SYSTEM_ID,'0')
or coalesce(sdw.TLC_PHASE,'0') <> coalesce(legacy.TLC_PHASE,'0')
;
create or replace view VW_COMPARESYSTEMS_DETAIL_231016_1947(
	THESOURCE,
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) as
select cs.*
FROM 

(SELECT
THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM SANDBOX.VW_LEGACYSYSTEMS) legacy

JOIN (SELECT
'SDW' as THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,AUTH_COMMENTS
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,AUTHORIZATION_PACKAGE
,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,COMPONENT_DESCRIPTION
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
--,DATEDELETED
--,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,DIVISION_DESCRIPTION
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE::DATE as FIRST_PUBLISHED_DATE
,FISMA_SYSTEM
,GROUP_ACRONYM
,GROUP_DESCRIPTION
,GROUP_NAME
,HVA_SCORE
,HVASTATUS
,IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,MEF
,MEF_CONTEXT
,MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,PIA_014
,PIA_EXPIRATION_DATE
,PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,SCA
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,SYSTEM_DESCRIPTION
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
FROM CORE.VW_SYSTEMS) sdw on sdw.SYSTEM_ID = legacy.SYSTEM_ID

JOIN sandbox.vw_comparesystems cs on cs.system_id = legacy.SYSTEM_ID

WHERE
Sdw.ACRONYM <> legacy.ACRONYM
or sdw.ARCHER_TRACKING_ID <> legacy.ARCHER_TRACKING_ID
or sdw.ATO_EXPIRATION_DATE <> legacy.ATO_EXPIRATION_DATE
or sdw.ATO_REVIEW_DATE <> legacy.ATO_REVIEW_DATE
or sdw.AUTH_COMMENTS <> legacy.AUTH_COMMENTS -- bad characters
or sdw.AUTH_DECISION <> legacy.AUTH_DECISION
or sdw.AUTHORIZATION_MEMO_SIGNED_DATE <> legacy.AUTHORIZATION_MEMO_SIGNED_DATE
or sdw.AUTHORIZATION_PACKAGE <> legacy.AUTHORIZATION_PACKAGE
--or sdw.AWS_ACCOUNTIDS <> legacy.AWS_ACCOUNTIDS
or sdw.BO_RECOMMENDATION_REVIEW_DATE <> legacy.BO_RECOMMENDATION_REVIEW_DATE
or sdw.BO_REVIEW_DATE <> legacy.BO_REVIEW_DATE
or sdw.BUSINESS_OWNER <> legacy.BUSINESS_OWNER
or sdw.CIO <> legacy.CIO
or sdw.CISO <> legacy.CISO
or sdw.CISO_REVIEW_DATE <> legacy.CISO_REVIEW_DATE
or sdw.CLOUD_SERVICE_PROVIDER <> legacy.CLOUD_SERVICE_PROVIDER
or sdw.COMMONNAME <> legacy.COMMONNAME
or sdw.COMPONENT_ACRONYM <> legacy.COMPONENT_ACRONYM
or sdw.COMPONENT_DESCRIPTION <> legacy.COMPONENT_DESCRIPTION -- bad characters
or sdw.COMPONENT_NAME <> legacy.COMPONENT_NAME
or sdw.COMPONENT_RISK_REPORTS_OVERSIGHT <> legacy.COMPONENT_RISK_REPORTS_OVERSIGHT
or sdw.CONTINGENCYEXPIRATIONDATE <> legacy.CONTINGENCYEXPIRATIONDATE
or sdw.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID <> legacy.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
or sdw.CP_TEST_DATE <> legacy.CP_TEST_DATE
or sdw.CP_TEST_RESULTS <> legacy.CP_TEST_RESULTS
or sdw.CRA <> legacy.CRA
or sdw.CRA_REVIEW_DATE <> legacy.CRA_REVIEW_DATE
or sdw.CYBERVET <> legacy.CYBERVET
or sdw.DATE_AUTH_MEMO_EXPIRES <> legacy.DATE_AUTH_MEMO_EXPIRES
or sdw.DATE_AUTH_MEMO_SIGNED <> legacy.DATE_AUTH_MEMO_SIGNED
--or sdw.DATEDELETED <> legacy.DATEDELETED
--or sdw.DATEMODIFIED <> legacy.DATEMODIFIED
or sdw.DCISO <> legacy.DCISO
or sdw.DIVISION_ACRONYM <> legacy.DIVISION_ACRONYM
or sdw.DIVISION_DESCRIPTION <> legacy.DIVISION_DESCRIPTION -- bad characters
or sdw.DIVISION_NAME <> legacy.DIVISION_NAME
or sdw.DSPC_REVIEW_DATE <> legacy.DSPC_REVIEW_DATE
or sdw.DSPPO_REVIEW_DATE <> legacy.DSPPO_REVIEW_DATE
or sdw.E_AUTH_EXP_DATE <> legacy.E_AUTH_EXP_DATE
or sdw.E_AUTH_LEVEL <> legacy.E_AUTH_LEVEL
or sdw.E_AUTH_RISK_ASSESSMENT_DATE <> legacy.E_AUTH_RISK_ASSESSMENT_DATE
or sdw.FINANCIAL_SYSTEM <> legacy.FINANCIAL_SYSTEM
or sdw.FIPS_199_AVAILABILITY_RATING <> legacy.FIPS_199_AVAILABILITY_RATING
or sdw.FIPS_199_CONFIDENTIALITY_RATING <> legacy.FIPS_199_CONFIDENTIALITY_RATING
or sdw.FIPS_199_INTEGRITY_RATING <> legacy.FIPS_199_INTEGRITY_RATING
or sdw.FIPS_199_OVERALL_IMPACT_RATING <> legacy.FIPS_199_OVERALL_IMPACT_RATING
or sdw.FIRST_PUBLISHED_DATE <> legacy.FIRST_PUBLISHED_DATE
or sdw.FISMA_SYSTEM <> legacy.FISMA_SYSTEM
or sdw.GROUP_ACRONYM <> legacy.GROUP_ACRONYM
or sdw.GROUP_DESCRIPTION <> legacy.GROUP_DESCRIPTION -- bad characters
or sdw.GROUP_NAME <> legacy.GROUP_NAME
or sdw.HVA_SCORE <> legacy.HVA_SCORE
or sdw.HVASTATUS <> legacy.HVASTATUS
or sdw.IN_CMS_CLOUD <> legacy.IN_CMS_CLOUD
or sdw.INFORMATION_SYSTEM_TYPE <> legacy.INFORMATION_SYSTEM_TYPE
--or sdw.INSERT_DATE <> legacy.INSERT_DATE
or sdw.IS_DATACENTER <> legacy.IS_DATACENTER
or sdw.IS_EXCLUDEFROMREPORTING <> legacy.IS_EXCLUDEFROMREPORTING
or sdw.IS_HIGHRISKSYSTEM <> legacy.IS_HIGHRISKSYSTEM
or sdw.IS_MARKETPLACE <> legacy.IS_MARKETPLACE
or sdw.IS_OA_READY <> legacy.IS_OA_READY
or sdw.IS_OPERATIONALSYSTEM <> legacy.IS_OPERATIONALSYSTEM
or sdw.IS_PHANTOMSYSTEM <> legacy.IS_PHANTOMSYSTEM
or sdw.IS_SECURITYHUB_ENABLED <> legacy.IS_SECURITYHUB_ENABLED
or sdw.ISRA_REVIEW_DATE <> legacy.ISRA_REVIEW_DATE
or sdw.ISRA_STATUS <> legacy.ISRA_STATUS
or sdw.ISSO <> legacy.ISSO
or sdw.ISSO_COUNT <> legacy.ISSO_COUNT
or sdw.ISSO_REVIEW_DATE <> legacy.ISSO_REVIEW_DATE
or sdw.ISSO_SUBMISSION_DATE <> legacy.ISSO_SUBMISSION_DATE
or sdw.ISSOCS <> legacy.ISSOCS
or sdw.LAST_ACT_DATE <> legacy.LAST_ACT_DATE
or sdw.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE <> legacy.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
or sdw.LAST_ACT_SCA_FINAL_REPORT_DATE <> legacy.LAST_ACT_SCA_FINAL_REPORT_DATE
or sdw.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE <> legacy.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
or sdw.LAST_PENTEST_DATE <> legacy.LAST_PENTEST_DATE
or sdw.MEF <> legacy.MEF
or sdw.MEF_CONTEXT <> legacy.MEF_CONTEXT
or sdw.MEFSTATUS <> legacy.MEFSTATUS
or sdw.NEXT_REQUIRED_CP_TEST_DATE <> legacy.NEXT_REQUIRED_CP_TEST_DATE
or sdw.OA_STATUS <> legacy.OA_STATUS
or sdw.OATO_CATEGORY <> legacy.OATO_CATEGORY
or sdw.PACKAGE_TYPE <> legacy.PACKAGE_TYPE
or sdw.PIA_014 <> legacy.PIA_014
or sdw.PIA_EXPIRATION_DATE <> legacy.PIA_EXPIRATION_DATE
or sdw.PII_PHI <> legacy.PII_PHI
or sdw.PRIMARY_ISSO <> legacy.PRIMARY_ISSO
or sdw.PRIMARY_OPERATING_LOCATION <> legacy.PRIMARY_OPERATING_LOCATION
or sdw.PRIMARY_OPERATING_LOCATION_ACRONYM <> legacy.PRIMARY_OPERATING_LOCATION_ACRONYM
or sdw.PRIMARY_OPERATING_LOCATION_ID <> legacy.PRIMARY_OPERATING_LOCATION_ID
or sdw.REASON_FOR_ATO_REQUEST <> legacy.REASON_FOR_ATO_REQUEST
or sdw.SCA <> legacy.SCA -- bad characters
or sdw.SCA_DATE <> legacy.SCA_DATE
or sdw.SDM <> legacy.SDM
or sdw.SOP_REVIEW_DATE <> legacy.SOP_REVIEW_DATE
or sdw.STE_DATE <> legacy.STE_DATE
or sdw.SYSTEM_DESCRIPTION <> legacy.SYSTEM_DESCRIPTION -- bad characters
or sdw.SYSTEM_ID <> legacy.SYSTEM_ID
or sdw.TLC_PHASE <> legacy.TLC_PHASE
--or sdw.TOTALASSETS <> legacy.TOTALASSETS
--or sdw.TOTALPOAMWITHAPPROVEDRBD <> legacy.TOTALPOAMWITHAPPROVEDRBD


;
create or replace view VW_CONFIGURATION_COMPLIANCE_BETA_V1(
	SYSTEM_ACRONYM,
	DATACENTER_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.ACRONYM as SYSTEM_ACRONYM
,a.DATACENTER_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.Finding_Description
,comp.Finding_ID
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.lastseen_vul as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity
,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CONFIGURATION_COMPLIANCE_BETA_V2(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	DAYSSINCEDISCOVERY,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FIRST_SEEN,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SEVERITY_NAME,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.COMPONENT_ACRONYM
,a.DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.DAYSSINCEDISCOVERY
,comp.Finding_Description
,comp.Finding_ID
,comp.FIRST_SEEN
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.IS_TENABLE_CREDENTIALED_SCAN
,comp.LAST_SEEN as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity

,case coalesce(upper(comp.Severity),'ITSNULL')
    when 'I' then 'High'
    when 'II' then 'Medium'
    when 'III' then 'Low'
    Else 'Unknown'
End as Severity_Name

,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,DATEDIFF(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.FIRST_SEEN
,r.LAST_SEEN

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
left outer join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CONFIGURATION_COMPLIANCE_BETA_V3(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	AUDIT_FILE_NAME,
	CHECK_ID,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	CONTROL_NAME,
	CONTROL_ELEMENT,
	DAYSSINCEDISCOVERY,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FIRST_SEEN,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SEVERITY_NAME,
	SOURCE_ID,
	SOURCE_TOOL,
	DATACENTER_ID,
	SYSTEM_ID,
	POLICY_800_53,
	IA_CONTROLS_800_53,
	POLICY_800_53R5,
	IA_CONTROLS_800_53R5
) as
select
s.COMPONENT_ACRONYM
,a.DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,aloc.allocation_status
,comp.Audit_File_Name
,comp.Check_ID
,comp.Check_Name
,comp.Compliance_Status
,aloc.control_name
,aloc.control_element
,comp.DAYSSINCEDISCOVERY
,comp.Finding_Description
,comp.Finding_ID
,comp.FIRST_SEEN
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.IS_TENABLE_CREDENTIALED_SCAN
,comp.LAST_SEEN as LAST_SEEN
,a.macaddress
,a.os
,comp.POLICY as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity

,case coalesce(upper(comp.Severity),'ITSNULL')
    when 'I' then 'High'
    when 'II' then 'Medium'
    when 'III' then 'Low'
    Else 'Unknown'
End as Severity_Name

,'TBD' as Source_ID
,'Tenable' as Source_Tool
,a.DATACENTER_ID
,a.SYSTEM_ID
,comp.POLICY_800_53
,comp.IA_CONTROLS_800_53
,comp.POLICY_800_53R5
,comp.IA_CONTROLS_800_53R5
FROM core.VW_SYSTEMS s
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,case POSITION(' - ',Check_Name,1)
    WHEN 0 then SUBSTRING(split_part(Check_Name,' ',1),1,22)
    Else SUBSTRING(split_part(Check_Name,' - ',1),1,22)      
End as Check_ID

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 20),(CompInfoEnd - CompInfoStart - 20)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,DATEDIFF(day,r.FIRST_SEEN,r.LAST_SEEN) as DAYSSINCEDISCOVERY
,r.FIRST_SEEN
,r.LAST_SEEN

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,GET(Compliance_Reference_Array,array_position('800-53'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53
,GET(Compliance_Reference_Array,array_position('800-53r5'::variant,Compliance_Reference_Array))::varchar as POLICY_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53
,REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.','')::varchar as IA_CONTROLS_800_53R5
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark
,coalesce(POLICY_800_53R5,POLICY_800_53) as POLICY -- Favor r5
,coalesce(IA_CONTROLS_800_53R5,IA_CONTROLS_800_53) as IA_CONTROLS -- Favor r5
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and POLICY LIKE '%800-53%'
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
left outer join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id and aloc.CONTROL_ELEMENT_NUMBER = comp.ia_controls
;
create or replace view VW_CONFIGURATION_JUST_COMPLIANCE_V2(
	ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	AUDIT_FILE_NAME,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SOURCE_ID,
	SOURCE_TOOL
) as
select
s.ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,comp.Audit_File_Name
,comp.Check_Name
,comp.Compliance_Status
,comp.Finding_Description
,comp.Finding_ID
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.lastseen_vul as LAST_SEEN
,a.macaddress
,a.os
,DISA_Benchmark as POLICY
,comp.Rule_ID
,'TBD' as Server_Type
,comp.Severity
,'TBD' as Source_ID
,'Tenable' as Source_Tool
FROM core.VW_SYSTEMS s
--join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,REPLACE(REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.',''),'"','') as IA_CONTROLS
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark

FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
--where a.dw_asset_id = 12993686
;
create or replace view VW_CONFIGURATION_JUST_COMPLIANCE_V3(
	ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	AUDIT_FILE_NAME,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	FINDING_DESCRIPTION,
	FINDING_ID,
	FQDN,
	HOSTNAME,
	IA_CONTROLS,
	IPV4,
	IPV6,
	LAST_SEEN,
	MACADDRESS,
	OS,
	POLICY,
	RULE_ID,
	SERVER_TYPE,
	SEVERITY,
	SOURCE_ID,
	SOURCE_TOOL
) as
select
s.ACRONYM
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,comp.dw_asset_id
,comp.Audit_File_Name
,comp.Check_Name
,comp.Compliance_Status
,comp.Finding_Description
,comp.Finding_ID
,a.FQDN
,a.HOSTNAME
,comp.IA_CONTROLS
,a.ipv4
,a.ipv6
,a.lastseen_vul as LAST_SEEN
,a.macaddress
,a.os
,DISA_Benchmark as POLICY
,comp.Rule_ID
,CASE upper(substring(CHECK_NAME,1,1))
        when 'W' then 
            CASE upper(SPLIT_PART(CHECK_NAME,'-',2))
                when 'DC' then 'DC'
                when 'MS' then 'MS'
                Else NULL
            End
        Else NULL
End as Server_Type
,comp.Severity
,'TBD' as Source_ID
,'Tenable' as Source_Tool
FROM core.VW_SYSTEMS s
--join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id
join core.vw_assets a on a.system_id = s.system_id
--
-- THE FOLLOWING SHOULD BE LEFT OUTER 
--
JOIN (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as Compliance_Reference_String
,STRTOK_TO_ARRAY(Compliance_Reference_String,',|') as Compliance_Reference_Array

,REPLACE(GET(Compliance_Reference_Array,(array_position('CAT'::variant,Compliance_Reference_Array) + 1)),'"','') as Severity
,REPLACE(GET(Compliance_Reference_Array,(array_position('Vuln-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Finding_ID
,REPLACE(GET(Compliance_Reference_Array,(array_position('Rule-ID'::variant,Compliance_Reference_Array) + 1)),'"','') as Rule_ID
,REPLACE(REPLACE(GET(Compliance_Reference_Array,(array_position('800-53r5'::variant,Compliance_Reference_Array) + 1)),'.',''),'"','') as IA_CONTROLS
,REPLACE(GET(Compliance_Reference_Array,(array_position('DISA_Benchmark'::variant,Compliance_Reference_Array) + 1)),'"','') as DISA_Benchmark

FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.plugin_id NOT IN ('1218405','1221295') -- In house plugins for retrieving 
and Check_Name not in ('Check for Empty FISMA Tattoo files.','Print out FISMA registry keys.') -- Filtering by plugin_id did not eliminate all the In-house written plugins
and r.family_type = 'compliance' 
--and position('<cm:compliance-reference>',plugintext,1) > 0
) comp on comp.dw_asset_id = a.dw_asset_id
--where a.dw_asset_id = 12993686
;
create or replace view VW_CONFIGURATION_TEST(
	ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_NUMBER,
	HYBRID_CONTROL,
	OVERALL_CONTROL_STATUS,
	RAW_TENABLE_VUL_ID,
	COMREFNAME,
	COMREFVALUE,
	COMPRESULTSTRING
) as
select 
s.ACRONYM,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
--,s.FIPS_199_OVERALL_IMPACT_RATING
,a.dw_asset_id
,aloc.allocation_status,aloc.control_element_number,aloc.control_number
--,aloc.control_set_version_number
,aloc.hybrid_control,aloc.overall_control_status
,comp.raw_tenable_vul_id
,split_part(f.value,'|',1) as ComRefName
,split_part(f.value,'|',2) as ComRefValue
,comp.CompResultString
FROM core.VW_SYSTEMS s
join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id
join core.vw_assets a on a.system_id = s.system_id
join (select top 1000
r.raw_tenable_vul_id
,r.dw_asset_id
--,plugintext
,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as CompRefString
,STRTOK_TO_ARRAY(CompRefString,',') as CompRefArray
,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as CompResultString
FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.family_type = 'compliance' 
and position('<cm:compliance-reference>',plugintext,1) > 0) comp on comp.dw_asset_id = a.dw_asset_id
join table(flatten(CompRefArray,outer=>true)) as f
where ComRefName IN ('800-53','800-53r5')
--where s.acronym = 'CFACTS-Cloud'
;
create or replace view VW_CONFIGURATION_TEST2(
	ACRONYM,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	DW_ASSET_ID,
	ALLOCATION_STATUS,
	CONTROL_ELEMENT_NUMBER,
	CONTROL_NUMBER,
	HYBRID_CONTROL,
	OVERALL_CONTROL_STATUS,
	CHECK_NAME,
	COMPLIANCE_STATUS
) as
select 
s.ACRONYM,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
--,s.FIPS_199_OVERALL_IMPACT_RATING
,a.dw_asset_id
,aloc.allocation_status,aloc.control_element_number,aloc.control_number
--,aloc.control_set_version_number
,aloc.hybrid_control,aloc.overall_control_status
,checkComp.Check_name
,coalesce(nullif(checkComp.Compliance_Status,''),'Not Found') as Compliance_Status
FROM core.VW_SYSTEMS s
join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id
join core.vw_assets a on a.system_id = s.system_id
LEFT OUTER JOIN (select 
comp.dw_asset_id
,comp.Audit_File_Name
,comp.Check_Name

,split_part(f.value,'|',1) as CompRefName
,replace(split_part(f.value,'|',2),'.','') as CompRefValue
,comp.Compliance_Status

,comp.Finding_Description

FROM (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as CompRefString
,STRTOK_TO_ARRAY(CompRefString,',') as CompRefArray

FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.dw_asset_id = 12993686
and r.family_type = 'compliance' 
and position('<cm:compliance-reference>',plugintext,1) > 0) comp
join table(flatten(CompRefArray,outer=>true)) as f
where CompRefName = '800-53r5') checkComp on checkComp.dw_asset_id = a.dw_asset_id and checkComp.CompRefValue = aloc.control_element_number
--where s.acronym = 'CFACTS-Cloud'
;
create or replace view VW_CONFIGURATION_TEST3(
	ACRONYM,
	DW_ASSET_ID,
	AUDIT_FILE_NAME,
	CHECK_NAME,
	COMPLIANCE_STATUS,
	FINDING_DESCRIPTION,
	KEY,
	COMPREFNAME,
	COMPREFVALUE
) as
select 
s.ACRONYM
,a.dw_asset_id
,checkComp.Audit_File_Name
,checkComp.Check_name
,coalesce(nullif(checkComp.Compliance_Status,''),'Not Found') as Compliance_Status
,checkComp.Finding_Description
,checkComp.KEY
,checkComp.CompRefName
,checkComp.CompRefValue


FROM core.VW_SYSTEMS s
join core.ALLOCATEDCONTROL aloc on aloc.system_id = s.system_id
join core.vw_assets a on a.system_id = s.system_id
LEFT OUTER JOIN (select 
comp.dw_asset_id
,comp.Audit_File_Name
,comp.Check_Name

,f.KEY
,split_part(f.value,'|',1) as CompRefName
,replace(split_part(f.value,'|',2),'.','') as CompRefValue
,comp.Compliance_Status

,comp.Finding_Description

FROM (select
r.dw_asset_id

,position('<cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileStart
,position('</cm:compliance-audit-file>',r.plugintext,1) as CompAuditFileEnd
,substring(r.plugintext,((CompAuditFileStart) + 26),(CompAuditFileEnd - CompAuditFileStart - 26)) as Audit_File_Name

,position('<cm:compliance-check-name>',r.plugintext,1) as CompCheckNameStart
,position('</cm:compliance-check-name>',r.plugintext,1) as CompCheckNameEnd
,substring(r.plugintext,((CompCheckNameStart) + 26),(CompCheckNameEnd - CompCheckNameStart - 26)) as Check_Name

,position('<cm:compliance-result>',r.plugintext,1) as CompResultStart
,position('</cm:compliance-result>',r.plugintext,1) as CompResultEnd
,substring(r.plugintext,((CompResultStart) + 22),(CompResultEnd - CompResultStart - 22)) as Compliance_Status

,position('<cm:compliance-info>',r.plugintext,1) as CompInfoStart
,position('</cm:compliance-info>',r.plugintext,1) as CompInfoEnd
,substring(r.plugintext,((CompInfoStart) + 22),(CompInfoEnd - CompInfoStart - 22)) as Finding_Description

,position('<cm:compliance-reference>',r.plugintext,1) as CompRefStart
,position('</cm:compliance-reference>',r.plugintext,1) as CompRefEnd
,substring(r.plugintext,((CompRefStart) + 25),(CompRefEnd - CompRefStart - 25)) as CompRefString
,STRTOK_TO_ARRAY(CompRefString,',') as CompRefArray

FROM core.SNAPSHOT_IDS snap
JOIN core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
where snap.snapshot_date::date = current_date()
and r.dw_asset_id = 12993686
and r.family_type = 'compliance' 
and position('<cm:compliance-reference>',plugintext,1) > 0) comp
join table(flatten(CompRefArray,outer=>true)) as f
) checkComp on checkComp.dw_asset_id = a.dw_asset_id
where a.dw_asset_id = 12993686
;
create or replace view VW_CREDENTIALSCAN_TEST1(
	CREDENTIALED_SCAN,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) as
with c as (
select distinct dnsname,IFF(UPPER(replace(credentialed_scan,'\n')) in ('TRUE','FALSE'),replace(credentialed_scan,'\n'),'Unknown') as credentialed_scan from app_tenable.shared.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO where reportdate >= CURRENT_DATE() and plugin_id=19506 
)
select c.credentialed_scan,a.* from core.vw_assets a join c on a.HOSTNAME=c.dnsname 
UNION ALL
select true,* from core.vw_assets where aws_instancestatus is  not null;
create or replace view VW_DRAAS_RESEARCH(
	DRAASFISMA,
	KEITH_PURPOSE,
	KEITH_POC,
	DEE_NOTES,
	ORIG_DATACENTERNAME,
	ORIG_SYSTEMNAME,
	CURRENT_DATACENTER_ACRONYM,
	CURRENT_SYSTEM_ACRONYM,
	TENANT_ID,
	AWS_ACCOUNT_IDS,
	DW_ASSET_ID,
	FQDN,
	HOSTNAME,
	IPV4,
	MDR_STATUS,
	DEVICETYPE,
	OS,
	NORMALIZED_FQDN,
	LAST_CONFIRMED_TIME,
	DATEDELETED,
	DELETIONREASON,
	ASSET_ID_TAG,
	FISMA_ID_TAG,
	RAW_HWAM_INSERT_DATE
) as
SELECT distinct 
d.DRAASFISMA,d.KEITH_PURPOSE,d.KEITH_POC,d.DEE_NOTES
,d.DATACENTERNAME as ORIG_DATACENTERNAME,d.SYSTEMNAME as ORIG_SYSTEMNAME
,dc.acronym as CURRENT_DATACENTER_ACRONYM
,s.acronym as CURRENT_SYSTEM_ACRONYM
,a.tenant_id
,d.AWS_ACCOUNT_IDS,d.dw_asset_id,d.FQDN,d.HOSTNAME,d.IPV4
,d.MDR_Status
,a.devicetype
,a.OS
,aifqdn.NORMALIZED_FQDN
,to_char(a.last_confirmed_time,'mm/dd/yyyy') as LAST_CONFIRMED_TIME
,to_char(a.datedeleted,'mm/dd/yyyy') as DATEDELETED
,a.deletionreason
,raw.asset_id_tag,raw.fisma_id_tag
,to_char(raw.insert_date,'mm/dd/yyyy') as RAW_HWAM_INSERT_DATE

--
-- Get baseline data downloaded on 240801
--
from (select t.DRAASFISMA,t.SYSTEMNAME,t.DATACENTERNAME,t.AWS_ACCOUNT_IDS,t.dw_asset_id,t.FQDN,t.HOSTNAME,t.IPV4
    ,case coalesce(NULLIF(a.is_applicable::varchar,''),'ITSNULL')
        when 'ITSNULL' then 'Asset has been physcially deleted'
        when 'false' then 'Logically deleted'
        when 'true' then 'Active'
        Else 'Unknown'
    End as MDR_Status
    ,t.KEITH_PURPOSE
    ,t.KEITH_POC
    ,t.DEE_NOTES
    FROM SANDBOX.DRAAS_SYSTEM_VULN_DETAILS_DATA_240821 t
    left outer join core.asset a on a.dw_asset_id = t.DW_ASSET_ID) d

left outer join core.asset a on a.dw_asset_id = d.dw_asset_id
left outer join core.systems dc on dc.system_id = a.datacenter_id
left outer join core.systems s on s.system_id = a.system_id

--
-- Find ASSET_ID_TAG and FISMA_ID_TAG in RAW_HWAM
--
left outer join (select r2.DW_ASSET_ID,r2.insert_date,r2.asset_id_tag,r2.fisma_id_tag
FROM (select rank()over(partition by r1.DW_ASSET_ID order by r1.insert_date desc,r1.raw_hwam_id) TheRank,r1.DW_ASSET_ID,r1.insert_date,r1.asset_id_tag,r1.fisma_id_tag
        FROM CORE.RAW_HWAM r1
        JOIN (select DW_ASSET_ID
        FROM CORE.RAW_HWAM WHERE FISMA_ID_TAG IS NOT NULL
        and DW_ASSET_ID IN (select distinct DW_ASSET_ID FROM SANDBOX.DRAAS_SYSTEM_VULN_DETAILS_DATA_240821)
        GROUP BY DW_ASSET_ID) d on d.DW_ASSET_ID = r1.DW_ASSET_ID) r2 
where r2.TheRank = 1) raw on raw.dw_asset_id = d.dw_asset_id

--
-- Get FQDN
--
left outer join (select r2.DW_ASSET_ID,r2.LAST_CONFIRMED_TIME,r2.NORMALIZED_FQDN
FROM (select rank()over(partition by r1.DW_ASSET_ID order by r1.LAST_CONFIRMED_TIME desc) TheRank,r1.DW_ASSET_ID,r1.LAST_CONFIRMED_TIME,r1.NORMALIZED_FQDN
        FROM CORE.ASSETINTERFACE_FQDN r1
        JOIN (select DW_ASSET_ID
        FROM CORE.ASSETINTERFACE_FQDN WHERE DW_ASSET_ID IN (select distinct DW_ASSET_ID FROM SANDBOX.DRAAS_SYSTEM_VULN_DETAILS_DATA_240821)
        GROUP BY DW_ASSET_ID) d on d.DW_ASSET_ID = r1.DW_ASSET_ID) r2 
where r2.TheRank = 1) aifqdn on aifqdn.dw_asset_id = d.dw_asset_id

WHERE d.MDR_Status = 'Active'
;
create or replace view VW_ENTERPRISE_SCANS_V2_LEGACY(
	REPORT_ID,
	REPORT_DATE,
	YYMM,
	TOTAL_ASSETS,
	SCANABLE_ASSETS,
	ASSETS_SCANNED_TODAY,
	ASSETS_SCANNED_WITNIN_3_DAYS,
	ASSETS_SCANNED
) COMMENT='Reports enterprise scans totals using legacy data\t'
 as
select t.REPORT_ID,t.REPORT_DATE,t.YYMM
    ,coalesce(a.TOTAL_ASSETS,0) as TOTAL_ASSETS
    ,coalesce(scanable.SCANABLE_ASSETS,0) as SCANABLE_ASSETS
    ,coalesce(scantoday.ASSETS_SCANNED_TODAY,0) as ASSETS_SCANNED_TODAY
    ,coalesce(scanwithin3.ASSETS_SCANNED_WITNIN_3_DAYS,0) as ASSETS_SCANNED_WITNIN_3_DAYS
    ,coalesce(scan.ASSETS_SCANNED,0) as ASSETS_SCANNED
FROM
(SELECT r1.REPORT_ID,r1.REPORT_DATE,to_char(r1.REPORT_DATE,'YYMM') as YYMM
        FROM (select rank()over(partition by ID order by REPORTDATE::date) TheRank,ID as REPORT_ID,REPORTDATE::date as REPORT_DATE
            FROM CORE.LEGACY_REPORTIDS where REPORTDATE::date < '2024-02-01'::date
            and ID IN (select distinct REPORT_ID FROM CORE.LEGACY_ASSETHIST)
            ) r1 where r1.TheRank = 1) t

left outer join (select  r.ID as REPORT_ID,count(1) as TOTAL_ASSETS
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    GROUP BY r.ID,r.REPORTDATE::date) a on a.REPORT_ID = t.REPORT_ID

left outer join (select r.ID as REPORT_ID,count(1) as SCANABLE_ASSETS
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    WHERE ah.is_scannable = 1
    GROUP BY r.ID,r.REPORTDATE::date) scanable on scanable.REPORT_ID = t.REPORT_ID
    
left outer join (select  r.ID as REPORT_ID,count(1) as ASSETS_SCANNED_TODAY
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL and ah.LASTSEEN_VUL::date = r.REPORTDATE::date
    GROUP BY r.ID,r.REPORTDATE::date) scantoday on scantoday.REPORT_ID = a.REPORT_ID

left outer join (select  r.ID as REPORT_ID,count(1) as ASSETS_SCANNED
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL
    GROUP BY r.ID,r.REPORTDATE::date) scan on scan.REPORT_ID = a.REPORT_ID

left outer join (select  r.ID as REPORT_ID,count(1) as ASSETS_SCANNED_WITNIN_3_DAYS
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    WHERE ah.is_scannable = 1 and ah.LASTSEEN_VUL IS NOT NULL and DATEDIFF(day, ah.LASTSEEN_VUL, r.REPORTDATE) <= 3
    GROUP BY r.ID,r.REPORTDATE::date) scanwithin3 on scanwithin3.REPORT_ID = a.REPORT_ID
    
;
create or replace view VW_LEGACYSYSTEMS(
	THESOURCE,
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) as
SELECT
'Legacy' as THESOURCE
,ACRONYM
,ARCHER_TRACKING_ID
,ATO_EXPIRATION_DATE
,ATO_REVIEW_DATE
,CORE.FN_CRM_CLEANSTRING(AUTH_COMMENTS) as AUTH_COMMENTS -- 231017
,AUTH_DECISION
,AUTHORIZATION_MEMO_SIGNED_DATE
,CORE.FN_CRM_CLEANSTRING(AUTHORIZATION_PACKAGE) as AUTHORIZATION_PACKAGE -- 231017
,AWS_ACCOUNTIDS
,BO_RECOMMENDATION_REVIEW_DATE
,BO_REVIEW_DATE
,BUSINESS_OWNER
,CIO
,CISO
,CISO_REVIEW_DATE
,CLOUD_SERVICE_PROVIDER
,COMMONNAME
,COMPONENT_ACRONYM
,CORE.FN_CRM_CLEANSTRING(COMPONENT_DESCRIPTION) as COMPONENT_DESCRIPTION -- 231017
,COMPONENT_NAME
,COMPONENT_RISK_REPORTS_OVERSIGHT
,CONTINGENCYEXPIRATIONDATE
,CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,CP_TEST_DATE
,CP_TEST_RESULTS
,CRA
,CRA_REVIEW_DATE
,CYBERVET
,DATE_AUTH_MEMO_EXPIRES
,DATE_AUTH_MEMO_SIGNED
,DATEDELETED
,DATEMODIFIED
,DCISO
,DIVISION_ACRONYM
,CORE.FN_CRM_CLEANSTRING(DIVISION_DESCRIPTION) as DIVISION_DESCRIPTION -- 231017
,DIVISION_NAME
,DSPC_REVIEW_DATE
,DSPPO_REVIEW_DATE
,E_AUTH_EXP_DATE
,E_AUTH_LEVEL
,E_AUTH_RISK_ASSESSMENT_DATE
,FINANCIAL_SYSTEM
,FIPS_199_AVAILABILITY_RATING
,FIPS_199_CONFIDENTIALITY_RATING
,FIPS_199_INTEGRITY_RATING
,FIPS_199_OVERALL_IMPACT_RATING
,FIRST_PUBLISHED_DATE
,CASE coalesce(FISMA_SYSTEM::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as FISMA_SYSTEM
,GROUP_ACRONYM
,CORE.FN_CRM_CLEANSTRING(GROUP_DESCRIPTION) as GROUP_DESCRIPTION -- 231017
,GROUP_NAME
,HVA_SCORE
,CASE coalesce(HVASTATUS::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as HVASTATUS
,CASE coalesce(IN_CMS_CLOUD::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as IN_CMS_CLOUD
,INFORMATION_SYSTEM_TYPE
,INSERT_DATE
,IS_DATACENTER
,IS_EXCLUDEFROMREPORTING
,IS_HIGHRISKSYSTEM
,IS_MARKETPLACE
,IS_OA_READY
,IS_OPERATIONALSYSTEM
,IS_PHANTOMSYSTEM
,IS_SECURITYHUB_ENABLED
,ISRA_REVIEW_DATE
,ISRA_STATUS
,ISSO
,ISSO_COUNT
,ISSO_REVIEW_DATE
,ISSO_SUBMISSION_DATE
,ISSOCS
,LAST_ACT_DATE
,LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE
,LAST_ACT_SCA_FINAL_REPORT_DATE
,LAST_PENTEST_CAAT_PROCESSED_FILE_DATE
,LAST_PENTEST_DATE
,CASE coalesce(MEF::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as MEF
,MEF_CONTEXT
,CASE coalesce(MEFSTATUS::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as MEFSTATUS
,NEXT_REQUIRED_CP_TEST_DATE
,OA_STATUS
,OATO_CATEGORY
,PACKAGE_TYPE
,CASE coalesce(PIA_014::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as PIA_014
,PIA_EXPIRATION_DATE
,CASE coalesce(PII_PHI::varchar,'ITSNULL') WHEN 'true' THEN 'Yes' WHEN 'false' THEN 'No' END as PII_PHI
,PRIMARY_ISSO
,PRIMARY_OPERATING_LOCATION
,PRIMARY_OPERATING_LOCATION_ACRONYM
,PRIMARY_OPERATING_LOCATION_ID
,REASON_FOR_ATO_REQUEST
,REPLACE(SCA,'&amp;','&') as SCA -- 231016 added replace
,SCA_DATE
,SDM
,SOP_REVIEW_DATE
,STE_DATE
,CORE.FN_CRM_CLEANSTRING(SYSTEM_DESCRIPTION) as SYSTEM_DESCRIPTION -- 231017
,SYSTEM_ID
,TLC_PHASE
,TOTALASSETS
,TOTALPOAMWITHAPPROVEDRBD
--FROM SANDBOX.LEGACYSYSTEMS
FROM SANDBOX.LEGACYSYSTEMS_231017
WHERE IS_EXCLUDEFROMREPORTING = 0 and IS_PHANTOMSYSTEM = 0
;
create or replace view VW_OFM_SCANS(
	COMPONENT_ACRONYM,
	ACRONYM,
	REPORT_ID,
	REPORT_DATE,
	YYMM,
	SYSTEM_ID,
	TOTAL_ASSETS,
	TOTAL_ASSETS_SCANNED
) COMMENT='Reports OFM component scans\t'
 as
select t.COMPONENT_ACRONYM,t.ACRONYM,t.REPORT_ID,t.REPORT_DATE,t.YYMM,t.SYSTEM_ID
    ,coalesce(a.TOTAL_ASSETS,0) as TOTAL_ASSETS,coalesce(scan.TOTAL_ASSETS_SCANNED,0) as TOTAL_ASSETS_SCANNED
FROM (select s.COMPONENT_ACRONYM,s.ACRONYM,s.SYSTEM_ID,r.REPORT_ID,r.REPORT_DATE,r.YYMM 
    FROM (select COMPONENT_ACRONYM,ACRONYM,SYSTEM_ID FROM CORE.VW_SYSTEMS where COMPONENT_ACRONYM = 'OFM') s

    JOIN (SELECT r1.REPORT_ID,r1.REPORT_DATE,to_char(r1.REPORT_DATE,'YYMM') as YYMM
        FROM (select rank()over(partition by REPORT_ID order by REPORT_DATE::date) TheRank,REPORT_ID,REPORT_DATE::date as REPORT_DATE
            FROM CORE.REPORT_IDS where is_viable = 1 and REPORT_DATE::date >= '2024-02-01'::date) r1 where r1.TheRank = 1) r) t

left outer join (select  r.REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    where s.COMPONENT_ACRONYM = 'OFM'
    GROUP BY s.COMPONENT_ACRONYM,s.ACRONYM,r.REPORT_ID,r.REPORT_DATE::date,ah.SYSTEM_ID) a on a.REPORT_ID = t.REPORT_ID and a.SYSTEM_ID = t.SYSTEM_ID
    
left outer join (select r.REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS_SCANNED
    FROM CORE.REPORT_IDS r
    JOIN CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID
    JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    where s.COMPONENT_ACRONYM = 'OFM' and ah.LASTSEEN_VUL IS NOT NULL and ah.LASTSEEN_VUL::date = r.REPORT_DATE::date
    GROUP BY r.REPORT_ID,r.REPORT_DATE::date,ah.SYSTEM_ID) scan on scan.REPORT_ID = a.REPORT_ID and scan.SYSTEM_ID = a.SYSTEM_ID
;
create or replace view VW_OFM_SCANS_LEGACY(
	COMPONENT_ACRONYM,
	ACRONYM,
	REPORT_ID,
	REPORT_DATE,
	SYSTEM_ID,
	TOTAL_ASSETS,
	TOTAL_ASSETS_SCANNED
) COMMENT='Reports OFM component scans - LEGACY DATA\t'
 as
select t.COMPONENT_ACRONYM,t.ACRONYM,t.REPORT_ID,t.REPORT_DATE,t.SYSTEM_ID,coalesce(a.TOTAL_ASSETS,0) as TOTAL_ASSETS,coalesce(scan.TOTAL_ASSETS_SCANNED,0) as TOTAL_ASSETS_SCANNED
FROM (select s.COMPONENT_ACRONYM,s.ACRONYM,s.SYSTEM_ID,r.REPORT_ID,r.REPORT_DATE 
    FROM (select COMPONENT_ACRONYM,ACRONYM,SYSTEM_ID FROM CORE.LEGACY_SYSTEMS where COMPONENT_ACRONYM = 'OFM') s

    JOIN (SELECT r1.REPORT_ID,r1.REPORT_DATE
        FROM (select rank()over(partition by ID order by REPORTDATE::date) TheRank,ID as REPORT_ID,REPORTDATE::date as REPORT_DATE
            FROM CORE.LEGACY_REPORTIDS where REPORT_DATE::date >= '2020-01-01'::date and REPORT_DATE::date < '2024-02-01'::date) r1 where r1.TheRank = 1) r) t

left outer join (select r.ID as REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    JOIN CORE.LEGACY_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    where s.COMPONENT_ACRONYM = 'OFM'
    GROUP BY s.COMPONENT_ACRONYM,s.ACRONYM,r.ID,r.REPORTDATE::date,ah.SYSTEM_ID) a on a.REPORT_ID = t.REPORT_ID and a.SYSTEM_ID = t.SYSTEM_ID
    
left outer join (select r.id as REPORT_ID,ah.SYSTEM_ID,count(1) as TOTAL_ASSETS_SCANNED
    FROM CORE.LEGACY_REPORTIDS r
    JOIN CORE.LEGACY_ASSETHIST ah on ah.REPORT_ID = r.ID
    JOIN CORE.LEGACY_SYSTEMS s on s.SYSTEM_ID = ah.SYSTEM_ID
    where s.COMPONENT_ACRONYM = 'OFM' and ah.LASTSEEN_VUL IS NOT NULL and ah.LASTSEEN_VUL::date = r.REPORTDATE::date
    GROUP BY r.ID,r.REPORTDATE::date,ah.SYSTEM_ID) scan on scan.REPORT_ID = a.REPORT_ID and scan.SYSTEM_ID = a.SYSTEM_ID
;
create or replace view VW_SDWASSETS(
	THESOURCE,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	LASTASSETUPDATE,
	LAST_CONFIRMED_TIME,
	COMPUTER_TYPE,
	INSERT_DATE,
	DEVICEROLE,
	DEVICETYPE,
	ENVIRONMENT,
	OS,
	OS_CPE,
	OS_VERSION,
	FQDN,
	NETBIOSNAME,
	HOSTNAME,
	LASTSEEN_HWAM,
	LASTSEEN_VUL,
	MOTHERBOARD,
	IPV4,
	IPV6,
	MACADDRESS,
	TENABLEUUID,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	VULNRISKTOLERANCE
) as
SELECT 
'SDW' as THESOURCE
,a.DW_ASSET_ID
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,a.ASSET_ID_TATTOO
,TO_CHAR(a.LASTASSETUPDATE,'YYYY-MM-DD HH24:MI:SS') as LASTASSETUPDATE
,TO_CHAR(a.LAST_CONFIRMED_TIME,'YYYY-MM-DD HH24:MI:SS') as LAST_CONFIRMED_TIME
,a.COMPUTER_TYPE
,TO_CHAR(a.INSERT_DATE,'YYYY-MM-DD HH24:MI:SS') as INSERT_DATE
,dr.DEVICEROLE
,a.DEVICETYPE
,a.ENVIRONMENT
,a.OS
,a.OS_CPE
,a.OS_VERSION
,aic.FQDN
,aic.NETBIOSNAME
,aic.HOSTNAME
,a.LASTSEEN_HWAM -- 231026
,a.LASTSEEN_VUL -- 231026
,a.MOTHERBOARD
,aic.IPV4
,aic.IPV6
,aic.MACADDRESS
,a.TENABLEUUID
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID
Where a.Is_Applicable = 1;
create or replace view VW_SDW_AWS_ASSETS(
	THESOURCE,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	LASTASSETUPDATE,
	LAST_CONFIRMED_TIME,
	COMPUTER_TYPE,
	INSERT_DATE,
	DEVICEROLE,
	DEVICETYPE,
	ENVIRONMENT,
	OS,
	OS_CPE,
	OS_VERSION,
	FQDN,
	NETBIOSNAME,
	HOSTNAME,
	MOTHERBOARD,
	IPV4,
	IPV6,
	MACADDRESS,
	TENABLEUUID,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	VULNRISKTOLERANCE
) as
SELECT 
'SDW' as THESOURCE
,a.DW_ASSET_ID
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,a.ASSET_ID_TATTOO
,TO_CHAR(a.LASTASSETUPDATE,'YYYY-MM-DD HH24:MI:SS') as LASTASSETUPDATE
,TO_CHAR(a.LAST_CONFIRMED_TIME,'YYYY-MM-DD HH24:MI:SS') as LAST_CONFIRMED_TIME
,a.COMPUTER_TYPE
,TO_CHAR(a.INSERT_DATE,'YYYY-MM-DD HH24:MI:SS') as INSERT_DATE
,dr.DEVICEROLE
,a.DEVICETYPE
,a.ENVIRONMENT
,a.OS
,a.OS_CPE
,a.OS_VERSION
,aic.FQDN
,aic.NETBIOSNAME
,aic.HOSTNAME
,a.MOTHERBOARD
,aic.IPV4
,aic.IPV6
,aic.MACADDRESS
,a.TENABLEUUID
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID

Where (dc.ACRONYM = 'AWS' and a.Is_Applicable = 1) or (dc.ACRONYM = 'AWS' and a.datedeleted > '2023-10-24 03:50:17.248'::datetime);
create or replace view VW_SDW_LEGACY_ASSET_ID_TATTOO_COMPARE(
	THESOURCE,
	DATACENTER_ID,
	ASSET_ID_TATTOO,
	MATCHSTATUS
) as
SELECT distinct L1.THESOURCE,L1.DATACENTER_ID,L1.ASSET_ID_TATTOO,'Not in SDW' as MatchStatus
from (
select 
THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from sandbox.LEGACYASSETS_WT_ASSET_ID_TATTOO_231117 where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') L1
left outer join (
select
'SDW' THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from core.vw_assets where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') sdw1 on sdw1.datacenter_id = l1.datacenter_id
and sdw1.asset_id_tattoo = l1.asset_id_tattoo
where sdw1.datacenter_id is null
UNION ALL
SELECT distinct SDW1.THESOURCE,SDW1.DATACENTER_ID,SDW1.ASSET_ID_TATTOO,'Not in Legacy' as MatchStatus
from (
select 
'SDW' THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from CORE.VW_ASSETS where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') SDW1
left outer join (
select
THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from sandbox.LEGACYASSETS_WT_ASSET_ID_TATTOO_231117 where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') L1 on L1.datacenter_id = SDW1.datacenter_id
and L1.asset_id_tattoo = SDW1.asset_id_tattoo
where L1.datacenter_id is null
UNION ALL
SELECT distinct SDW1.THESOURCE,SDW1.DATACENTER_ID,SDW1.ASSET_ID_TATTOO,'SDW and Legacy Match' as MatchStatus
from (
select 
'SDW' THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from CORE.VW_ASSETS where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') SDW1
join (
select
THESOURCE
,UPPER(DATACENTER_ID) as DATACENTER_ID
,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
from sandbox.LEGACYASSETS_WT_ASSET_ID_TATTOO_231117 where asset_id_tattoo IS NOT NULL and datacenter_acronym ='EDC4' and system_acronym = 'EDC4') L1 on L1.datacenter_id = SDW1.datacenter_id
and L1.asset_id_tattoo = SDW1.asset_id_tattoo;
create or replace view VW_SDW_LEGACY_ASSET_ID_TATTOO_MATCH(
	THESOURCE,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ASSET_ID_TATTOO,
	MATCHSTATUS
) as
SELECT m.THESOURCE,dc.acronym as DATACENTER_ACRONYM,m.DATACENTER_ID,m.ASSET_ID_TATTOO,m.MATCHSTATUS
FROM 
(SELECT distinct L1.THESOURCE,L1.DATACENTER_ID,L1.ASSET_ID_TATTOO,'Not in SDW' as MatchStatus
    from (select THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from SANDBOX.LEGACYASSETS_WT_ASSET_ID_TATTOO where asset_id_tattoo IS NOT NULL) L1
    left outer join (select 'SDW' THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from core.vw_assets where asset_id_tattoo IS NOT NULL) sdw1 on sdw1.datacenter_id = l1.datacenter_id and sdw1.asset_id_tattoo = l1.asset_id_tattoo
    where sdw1.datacenter_id is null
UNION ALL
SELECT distinct SDW1.THESOURCE,SDW1.DATACENTER_ID,SDW1.ASSET_ID_TATTOO,'Not in Legacy' as MatchStatus
    from (select 'SDW' THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from CORE.VW_ASSETS where asset_id_tattoo IS NOT NULL) SDW1
    left outer join (select THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from SANDBOX.LEGACYASSETS_WT_ASSET_ID_TATTOO where asset_id_tattoo IS NOT NULL) L1 on L1.datacenter_id = SDW1.datacenter_id and L1.asset_id_tattoo = SDW1.asset_id_tattoo
    where L1.datacenter_id is null
UNION ALL
SELECT distinct SDW1.THESOURCE,SDW1.DATACENTER_ID,SDW1.ASSET_ID_TATTOO,'SDW and Legacy Match' as MatchStatus
    from (select 'SDW' THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from CORE.VW_ASSETS where asset_id_tattoo IS NOT NULL) SDW1
    join (select THESOURCE,UPPER(DATACENTER_ID) as DATACENTER_ID,UPPER(ASSET_ID_TATTOO) as ASSET_ID_TATTOO
    from SANDBOX.LEGACYASSETS_WT_ASSET_ID_TATTOO where asset_id_tattoo IS NOT NULL) L1 on L1.datacenter_id = SDW1.datacenter_id and L1.asset_id_tattoo = SDW1.asset_id_tattoo) m
JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = m.DATACENTER_ID;
create or replace view VW_SDW_LEGACY_ASSET_ID_TATTOO_REPORT(
	THESOURCE,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DATACENTER_ID,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	MATCHSTATUS,
	INSERT_DATE,
	LASTASSETUPDATE,
	LAST_CONFIRMED_TIME,
	LASTSEEN_HWAM,
	LASTSEEN_VUL,
	DEVICETYPE,
	FQDN,
	IS_APPLICABLE,
	DATEDELETED
) as
select 
a.THESOURCE
,a.DW_ASSET_ID
,dc.ACRONYM as DATACENTER_ACRONYM
,s.ACRONYM as SYSTEM_ACRONYM
,a.DATACENTER_ID
,a.SYSTEM_ID
,a.ASSET_ID_TATTOO
,c.MATCHSTATUS
,substring(a.INSERT_DATE::varchar,1,10) as INSERT_DATE
,substring(a.LASTASSETUPDATE::varchar,1,10) as LASTASSETUPDATE
,substring(a.LAST_CONFIRMED_TIME::varchar,1,16) as LAST_CONFIRMED_TIME
,substring(a.LASTSEEN_HWAM::varchar,1,10) as LASTSEEN_HWAM
,substring(a.LASTSEEN_VUL::varchar,1,10) as LASTSEEN_VUL
,a.DEVICETYPE
,a.FQDN
,a.IS_APPLICABLE
,a.DATEDELETED
from SANDBOX.LEGACYASSETS_WT_ASSET_ID_TATTOO a
JOIN CORE.SYSTEMS dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
LEFT OUTER JOIN sandbox.VW_SDW_LEGACY_ASSET_ID_TATTOO_MATCH c on UPPER(c.datacenter_id) = UPPER(a.datacenter_id) and UPPER(c.asset_id_tattoo) = UPPER(a.asset_id_tattoo)
where a.asset_id_tattoo IS NOT NULL
UNION ALL
select
'SDW' THESOURCE
,a.DW_ASSET_ID
,a.DATACENTER_ACRONYM
,a.SYSTEM_ACRONYM
,a.DATACENTER_ID
,a.SYSTEM_ID
,a.ASSET_ID_TATTOO
,c.MATCHSTATUS
,substring(a.INSERT_DATE::varchar,1,10) as INSERT_DATE
,substring(a.LASTASSETUPDATE::varchar,1,10) as LASTASSETUPDATE
,substring(a.LAST_CONFIRMED_TIME::varchar,1,16) as LAST_CONFIRMED_TIME
,substring(a.LASTSEEN_HWAM::varchar,1,10) as LASTSEEN_HWAM
,substring(a.LASTSEEN_VUL::varchar,1,10) as LASTSEEN_VUL
,a.DEVICETYPE
,a.FQDN
,1 as IS_APPLICABLE
,NULL DATEDELETED
from core.vw_assets a
LEFT OUTER JOIN sandbox.VW_SDW_LEGACY_ASSET_ID_TATTOO_MATCH c on UPPER(c.datacenter_id) = UPPER(a.datacenter_id) and UPPER(c.asset_id_tattoo) = UPPER(a.asset_id_tattoo)
where a.asset_id_tattoo IS NOT NULL;
create or replace view VW_SDW_VULNERABILITIES(
	THESOURCE,
	DW_VUL_ID,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	FQDN,
	CVE,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	ASSET_LAST_CONFIRMED_TIME,
	ASSET_DATECREATED,
	VM_DATECREATED,
	DATEMITIGATED,
	LASTFOUND
) as
SELECT 'SDW' as TheSource
,vm.dw_vul_id
,a.dw_asset_id
,a.DataCenter_Acronym
,a.System_Acronym
,a.asset_id_tattoo
,a.fqdn
,vm.cve
,vm.FISMAseverity
,vm.MitigationStatus
,substring(a.last_confirmed_time::varchar,1,16) as Asset_last_confirmed_time
,a.insert_date::date as Asset_datecreated
,vm.insert_date::date as VM_datecreated
,vm.datemitigated::date as datemitigated
,substring(vm.lastfound::varchar,1,16) as lastfound
FROM CORE.VW_ASSETS a
JOIN CORE.VW_VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
--where vm.[DeletionReason] IS NULL  VW_VULMASTER already filters-out deleted
;
create or replace view VW_SDW_VULNERABILITIES_TEST(
	THESOURCE,
	DW_VUL_ID,
	DW_ASSET_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	FQDN,
	CVE,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	ASSET_LAST_CONFIRMED_TIME,
	ASSET_DATECREATED,
	VM_DATECREATED,
	DATEMITIGATED,
	LASTFOUND
) as
SELECT 'SDW' as TheSource
,vm.dw_vul_id
,a.dw_asset_id
,a.DataCenter_Acronym
,a.System_Acronym
,a.asset_id_tattoo
,a.fqdn
,vm.cve
,vm.FISMAseverity
,vm.MitigationStatus
,substring(a.last_confirmed_time::varchar,1,16) as Asset_last_confirmed_time
,a.insert_date::date as Asset_datecreated
,vm.insert_date::date as VM_datecreated
,vm.datemitigated::date as datemitigated
,substring(vm.lastfound::varchar,1,16) as lastfound
FROM CORE.VW_ASSETS a
JOIN CORE.VW_VULMASTER vm on vm.dw_asset_id = a.dw_asset_id
--where vm.[DeletionReason] IS NULL  VW_VULMASTER already filters-out deleted
;
create or replace view VW_SYSTEMS_VISIBILITY(
	ACRONYM,
	COMMONNAME,
	IS_CCSQ,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	TLC_PHASE,
	TOTALASSETS,
	DIRECTOR_COMMENT,
	DIRECTOR_COMMENT2,
	MOST_RECENT_REPORT_DATE
) as
SELECT
s.ACRONYM
,c.COMMONNAME
,s.is_ccsq
,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID
,s.TLC_PHASE
,coalesce(a.TOTALASSETS,0) as TOTALASSETS
,s.director_comment
,s.director_comment2
--,ss.Assets
,ss.Most_Recent_Report_Date
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN (select s.system_id,coalesce(ss.assets::varchar,'Never reported') as Assets,r.report_date::date as Most_Recent_Report_Date
from CORE.VW_SYSTEMS s
left outer join (select system_id,max(report_id) as Max_Report_ID
    from core.systemsummary
    where assets > 0
    group by system_id) m1 on m1.system_id = s.system_id
left outer join core.systemsummary ss on ss.system_id = m1.system_id and ss.report_id = m1.Max_Report_ID
left outer join core.report_ids r on r.report_id = ss.report_id
where s.is_phantomsystem = 0) ss on ss.system_id = s.system_id


WHERE s.IS_PHANTOMSYSTEM = 0;
create or replace view VW_VALIDATE_SEC_VW_IUSG_CUMULATIVE_VULNS_INSTANCEID(
	ACRONYM,
	THESOURCE,
	FISMA_ID,
	INSTANCEID,
	PROD_MAX_LASTSEEN,
	DEV_MAX_LASTSEEN,
	MSG
) as
select s.ACRONYM,t.THESOURCE,t.FISMA_ID,t.INSTANCEID,substring(t.PROD_MAX_LASTSEEN::varchar,1,16) as PROD_MAX_LASTSEEN,substring(t.DEV_MAX_LASTSEEN::varchar,1,16) as DEV_MAX_LASTSEEN,t.MSG
FROM 
(
select 'Prod-View' as TheSource, x.FISMA_ID, x.INSTANCEID, x.PROD_MAX_LASTSEEN, NULL as DEV_MAX_LASTSEEN, 'In Prod-View but not in Dev-View' as MSG
FROM
(select p.FISMA_ID,p.INSTANCEID,p.PROD_MAX_LASTSEEN
    FROM (select r.fisma_id as FISMA_ID, r.instanceid, max(r.lastseen) as PROD_MAX_LASTSEEN
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    WHERE CASE CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1)
    WHEN 0 THEN NULL
    ELSE SUBSTRING(r.severity,(CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1) + 6),1)
    END  > 0
    group by r.fisma_id, r.instanceid) p

LEFT OUTER JOIN (select distinct r.fisma as FISMA_ID, replace(r.instanceid,char(10),'') as instanceid
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)) d on d.FISMA_ID = p.FISMA_ID and d.INSTANCEID = p.INSTANCEID
where d.FISMA_ID IS NULL) x

UNION ALL

select 'Dev-View' as TheSource, x.FISMA_ID, x.INSTANCEID, NULL as PROD_MAX_LASTSEEN, x.DEV_MAX_LASTSEEN,'In Dev-View but not in Prod-View' as MSG
FROM
(select d.FISMA_ID,d.INSTANCEID,d.DEV_MAX_LASTSEEN
FROM
(select r.fisma as FISMA_ID, replace(r.instanceid,char(10),'') as instanceid, max(r.lastseen) as DEV_MAX_LASTSEEN
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)
    group by r.fisma, r.instanceid) d 

LEFT OUTER JOIN (select r.fisma_id as FISMA_ID, r.instanceid
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    WHERE CASE CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1)
    WHEN 0 THEN NULL
    ELSE SUBSTRING(r.severity,(CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1) + 6),1)
    END  > 0
    
    ) p on p.FISMA_ID = d.FISMA_ID and p.INSTANCEID = d.INSTANCEID

where p.FISMA_ID IS NULL) x

UNION ALL

select 'Both' as TheSource, s.system_id as FISMA_ID, p.INSTANCEID, p.PROD_MAX_LASTSEEN, d.DEV_MAX_LASTSEEN,'Check LastSeen' as MSG
FROM CORE.SYSTEMS s
JOIN 
(select r.fisma_id as FISMA_ID, r.instanceid, max(r.lastseen) as Prod_Max_Lastseen
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    WHERE CASE CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1)
    WHEN 0 THEN NULL
    ELSE SUBSTRING(r.severity,(CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1) + 6),1)
    END  > 0
    group by r.fisma_id, r.instanceid) p on p.FISMA_ID = s.SYSTEM_ID

JOIN (select r.fisma as FISMA_ID, replace(r.instanceid,char(10),'') as InstanceID, max(r.lastseen) as Dev_Max_Lastseen
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)
    group by r.fisma, r.instanceid) d on d.FISMA_ID = p.FISMA_ID and d.INSTANCEID = p.INSTANCEID

) t

LEFT OUTER JOIN CORE.SYSTEMS s on s.system_id = t.FISMA_ID;
create or replace view VW_VALIDATE_SEC_VW_IUSG_CUMULATIVE_VULNS_PLUGINS(
	ACRONYM,
	THESOURCE,
	FISMA_ID,
	INSTANCEID,
	PLUGINID,
	MSG
) as
select s.ACRONYM,t.THESOURCE,t.FISMA_ID,t.INSTANCEID,t.PLUGINID,t.MSG
FROM 
(
select 'Prod-View' as TheSource, x.FISMA_ID, x.INSTANCEID, x.PLUGINID, 'In Prod-View but not in Dev-View' as MSG
FROM
(select p.FISMA_ID,p.INSTANCEID,p.PLUGINID
    FROM (select r.fisma_id as FISMA_ID, r.instanceid, r.PLUGINID
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    WHERE CASE CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1)
    WHEN 0 THEN NULL
    ELSE SUBSTRING(r.severity,(CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1) + 6),1)
    END  > 0
    group by r.fisma_id, r.instanceid, r.PLUGINID) p

LEFT OUTER JOIN (select distinct r.fisma as FISMA_ID, replace(r.instanceid,char(10),'') as instanceid, r.PLUGINID
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)) d on d.FISMA_ID = p.FISMA_ID and d.INSTANCEID = p.INSTANCEID and d.PLUGINID = p.PLUGINID
where d.FISMA_ID IS NULL) x

UNION ALL

select 'Dev-View' as TheSource, x.FISMA_ID, x.INSTANCEID, x.PLUGINID,'In Dev-View but not in Prod-View' as MSG
FROM
(select d.FISMA_ID,d.INSTANCEID,d.PLUGINID
FROM
(select r.fisma as FISMA_ID, replace(r.instanceid,char(10),'') as instanceid, r.PLUGINID
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)
    group by r.fisma, r.instanceid, r.PLUGINID) d 

LEFT OUTER JOIN (select r.fisma_id as FISMA_ID, r.instanceid, r.PLUGINID
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    WHERE CASE CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1)
    WHEN 0 THEN NULL
    ELSE SUBSTRING(r.severity,(CHARINDEX((char(34)||'id'||char(34)||':'),r.severity,1) + 6),1)
    END  > 0
    
    ) p on p.FISMA_ID = d.FISMA_ID and p.INSTANCEID = d.INSTANCEID and p.PLUGINID = d.PLUGINID

where p.FISMA_ID IS NULL) x

) t

LEFT OUTER JOIN CORE.SYSTEMS s on s.system_id = t.FISMA_ID;
create or replace view VW_VALIDATE_SEC_VW_IUSG_CUMULATIVE_VULNS_SYSTEMS(
	ACRONYM,
	THESOURCE,
	FISMA_ID,
	MSG
) as
select s.ACRONYM,t.*
FROM 
(
select distinct 'Prod-View' as TheSource, coalesce(NULLIF(r.fisma_id,''),'Null FISMA_ID') as FISMA_ID, 'Not a valid FISMA ID' as MSG
from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
left outer join core.systems s on upper(s.system_id) = upper(r.fisma_id)
WHERE s.system_id is null

UNION ALL

select distinct 'Dev-View' as TheSource, coalesce(NULLIF(r.fisma,''),'Null FISMA_ID') as FISMA_ID, 'Not a valid FISMA ID' as MSG
from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
left outer join core.systems s on upper(s.system_id) = upper(r.fisma)
WHERE s.system_id is null

UNION ALL

select 'Prod-View' as TheSource, x.FISMA_ID,'In Prod-View but not in Dev-View' as MSG
FROM
(select p.FISMA_ID
    FROM (select distinct r.fisma_id as FISMA_ID
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    ) p

LEFT OUTER JOIN (select distinct r.fisma as FISMA_ID
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)) d on d.FISMA_ID = p.FISMA_ID
where d.FISMA_ID IS NULL) x

UNION ALL

select 'Dev-View' as TheSource, x.FISMA_ID,'In Dev-View but not in Prod-View' as MSG
FROM
( select d.FISMA_ID
FROM
(select distinct r.fisma as FISMA_ID
    from APP_TENABLE.SHARED.SEC_VW_IUSG_CUMULATIVE_VULNS r
    join core.systems s on upper(s.system_id) = upper(r.fisma)) d 

LEFT OUTER JOIN (select distinct r.fisma_id as FISMA_ID
    from APP_TENABLE.SHARED.SEC_VW_VULN_AWS r
    join core.systems s on upper(s.system_id) = upper(r.fisma_id)
    ) p on p.FISMA_ID = d.FISMA_ID
where p.FISMA_ID IS NULL) x


) t
LEFT OUTER JOIN CORE.SYSTEMS s on s.system_id = t.FISMA_ID;
create or replace view VW_VULN_DASHBOARD_TRENDING_TEST1(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Used to populate RPT.Temp_Vuln_Trending from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
with ReportIDs as(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS ORDER BY REPORT_ID DESC)
UNION ALL
(SELECT TOP 12 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE,  IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
),
snap as (
select a.RANKK,a.REPORT_ID,a.REPORT_DATE,a.IS_ENDOFMONTH
,IFF(a.RANKK=1,'MTD',IFF(a.RANKK=2,'EOM','EOM-' || (a.RANKK-2)::VARCHAR )) as MTDVSEOM 
,IFF(a.RANKK=1,b.REPORT_DATE,a.REPORT_DATE) as CurrentMTDStart 
,IFF(a.RANKK in (1,2),(Select REPORT_DATE from ReportIDs  where RANKK=3 ),IFNULL(b.REPORT_DATE,a.REPORT_DATE))  as PrevEOMStart
from ReportIDs a left join ReportIDs b on a.RANKK=b.RANKK-1 
),
vulh as (
select  
s.SYSTEM_ID
,s.Component_Acronym
,count(vh.cve) as cvecount
,count(Distinct vh.cve) as UniqueCVECount
,a.DATACENTER_ID   
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,IFF(bodcat.Is_Deleted = 0,'Yes','No') as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vm.MitigationStatus
,s.TLC_PHASE
,snap.REPORT_ID
from snap
join CORE.VW_VULHIST vh on vh.REPORT_ID = snap.REPORT_ID 
join CORE.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID
join CORE.ASSET a on a.DW_ASSET_ID = vm.DW_ASSET_ID
join CORE.VW_SYSTEMS s on s.system_id=a.system_id
left join CORE.KEV_CATALOG bodcat on bodcat.CVE=vm.CVE
group by
snap.REPORT_ID
,s.SYSTEM_ID
,s.Component_Acronym
,a.DATACENTER_ID 
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vm.MitigationStatus
,s.TLC_PHASE
)
select distinct
s.Acronym
,s.Component_Acronym
,vh.cvecount as "CVE Count"
,vh.UniqueCVECount as "Unique CVE Count"
,snap.CurrentMTDStart
,IFNULL(dc.datacenter_acronym,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name
,vh.datecreated
,vh.DATEMITIGATED
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,vh.HVASTATUS
,vh.is_bod
,vh.IS_MARKETPLACE
,vh.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,snap.PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,vh.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
right join CORE.VW_SYSTEMS s on s.system_id=ss.system_id
left join (select distinct system_id,datacenter_id,datacenter_acronym  from CORE.VW_ASSETS) dc on dc.system_id=s.system_id
left join vulh vh on vh.REPORT_ID=ss.REPORT_ID and vh.SYSTEM_ID=ss.SYSTEM_ID and vh.datacenter_id=dc.datacenter_id


;
create or replace view VW_VULN_DASHBOARD_TRENDING_TEST2(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Used to populate RPT.Temp_Vuln_Trending from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
with ReportIDs as(
(SELECT TOP 1 1 as RANKK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE, IS_ENDOFMONTH FROM CORE.REPORT_IDS ORDER BY REPORT_ID DESC) 
UNION ALL
(SELECT TOP 12 dense_rank()over(order by REPORT_ID desc) + 1 as RANNK, REPORT_ID, REPORT_DATE::DATE as REPORT_DATE,  IS_ENDOFMONTH FROM CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 ORDER BY REPORT_ID DESC)
),
snap as (
select a.RANKK,a.REPORT_ID,a.REPORT_DATE,a.IS_ENDOFMONTH
,IFF(a.RANKK=1,'MTD',IFF(a.RANKK=2,'EOM','EOM-' || (a.RANKK-2)::VARCHAR )) as MTDVSEOM 
,IFF(a.RANKK=1,b.REPORT_DATE,a.REPORT_DATE) as CurrentMTDStart 
,IFF(a.RANKK in (1,2),(Select REPORT_DATE from ReportIDs  where RANKK=3 ),IFNULL(b.REPORT_DATE,a.REPORT_DATE))  as PrevEOMStart
from ReportIDs a left join ReportIDs b on a.RANKK=b.RANKK-1 
),
vulh as (
select  
 upper(s.SYSTEM_ID) as SYSTEM_ID
,s.Component_Acronym
,count(vm.cve) as cvecount
,count(Distinct vm.cve) as UniqueCVECount
,upper(a.DATACENTER_ID) DATACENTER_ID  
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vm.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,IFF(bodcat.Is_Deleted = 0,'Yes','No') as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
,snap.REPORT_ID
from snap
join CORE.VULHIST vh on vh.REPORT_ID = snap.REPORT_ID 
join CORE.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID
join CORE.ASSET a on a.DW_ASSET_ID = vm.DW_ASSET_ID
join CORE.VW_SYSTEMS s on  upper(s.system_id)= upper(a.system_id)
left join CORE.KEV_CATALOG bodcat on bodcat.CVE=vm.CVE
group by
snap.REPORT_ID
,upper(s.SYSTEM_ID)
,s.Component_Acronym
,upper(a.DATACENTER_ID) 
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,s.TLC_PHASE
)
select distinct
s.Acronym
,s.Component_Acronym
,vh.cvecount as "CVE Count"
,vh.UniqueCVECount as "Unique CVE Count"
,snap.CurrentMTDStart
,IFNULL(dc.datacenter_acronym,s.PRIMARY_OPERATING_LOCATION_ACRONYM) as data_center_name --Datacenter from assets or primary oploc.
,vh.datecreated
,vh.DATEMITIGATED
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,vh.HVASTATUS
,vh.is_bod
,vh.IS_MARKETPLACE
,vh.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,snap.PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,vh.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
right join CORE.VW_SYSTEMS s on  upper(s.system_id)= upper(ss.system_id)
left join (
select a.system_id,a.datacenter_id,b.acronym as datacenter_acronym from
(select distinct  upper(system_id) as system_id, upper(datacenter_id) as datacenter_id from CORE.VW_ASSETS --All datacenters for active assets.
union
select distinct  upper(system_id) as system_id, upper(datacenter_id) as datacenter_id from vulh) a  -- Datacenters for some inactive assets
join CORE.VW_SYSTEMS b on a.datacenter_id=upper(b.system_id)
) dc on  dc.system_id= upper(s.system_id)
left join vulh vh on vh.REPORT_ID=ss.REPORT_ID and vh.SYSTEM_ID=dc.SYSTEM_ID and  vh.datacenter_id= dc.datacenter_id


;
create or replace view VW_VULN_DASHBOARD_TRENDING_TEST_CR1(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) COMMENT='Used to populate RPT.Temp_Vuln_Trending from within CORE.SP_CRM_WRITE_REPORTINGTABLES'
 as
select 
s.Acronym
,s.Component_Acronym
,count(vh.cve) "CVE Count"
,count(Distinct vh.cve) "Unique CVE Count"

,case when snap.RANKK = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)
	when snap.RANKK = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)

	when snap.RANKK = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)    
end as CurrentMTDStart
,IFNULL(data_center.acronym,s.primary_operating_location_acronym) as data_center_name  --20240102 shows datacenters that does not have any vul
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,case when snap.RANKK = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
-- 231104 WHY IS THE NEXT LINE ALSO USING TOP 2
	when snap.RANKK = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 13 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)   
end as PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID_VULN_DASHBOARD_TRENDING()) snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY,primary_operating_location_acronym from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,IFNULL(data_center.acronym,s.primary_operating_location_acronym) --20240102 shows datacenters that does not have any vul
--,snap.REPORT_ID
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM
,snap.Rankk
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
;
create or replace view V_SEC_USERSYSMAPPING_VATDC_AC1(
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	ACRONYM,
	SYSTEM_ID,
	USERID
) COMMENT='Security view for specifically crated for Data center users (Details provided by VAT team)'
 as
select distinct 
 A.DATACENTER_ACRONYM --as "DataCenter Acronym"
,A.DATACENTER_ID --as "DataCenterUID"
,A.SYSTEM_ACRONYM --as "System Acronym"
,S.SYSTEM_ID --as "SystemUID"
,SU.UserId --as "UserName"
from CORE.VW_SYSTEMS S
join (select 
 A.DATACENTER_ACRONYM 
,A.DATACENTER_ID 
,A.SYSTEM_ACRONYM 
,A.SYSTEM_ID from CORE.VW_ASSETS A 
group by  A.DATACENTER_ACRONYM 
,A.DATACENTER_ID
,A.SYSTEM_ACRONYM 
,A.SYSTEM_ID ) A on A.system_id = S.system_id
join rpt.VAT_SYSTEMUSERS SU on S.SYSTEM_ID = SU.SYSTEM_ID
where S.Is_ExcludeFromReporting = 0 and S.Is_PhantomSystem=0 and SU.UserId is not null;
create or replace view V_VULN_DASHBOARD_TRENDING_CHRIS(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) as
SELECT * FROM SANDBOX.TEMP_VULN_TRENDING;
create or replace view V_VULN_DASHBOARD_TRENDING_LEGACY_TESTV1(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	PREVEOMSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	RANKK,
	TLC_PHASE,
	REFRESH_DATE,
	VULNRISKTOLERANCE,
	REPORT_ID,
	REPORT_DATE
) as
with
REPORT_IDs as ((select REPORT_ID,REPORT_DATE, SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE, SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select REPORT_ID,REPORT_DATE, SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE, SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap <= 12)),
Snapshots as (select REPORT_ID, REPORT_DATE, SNAPSHOT_ID,
	case when dense_rank()over(order by REPORT_ID desc) =1 then 'MTD' when dense_rank()over(order by REPORT_ID desc) = 2 then 'EOM' 
	when dense_rank()over(order by REPORT_ID desc) = 3 then 'EOM-1' when dense_rank()over(order by REPORT_ID desc) = 4 then 'EOM-2' 
	when dense_rank()over(order by REPORT_ID desc) = 5 then 'EOM-3' when dense_rank()over(order by REPORT_ID desc) = 6 then 'EOM-4' 
	when dense_rank()over(order by REPORT_ID desc) = 7 then 'EOM-5' when dense_rank()over(order by REPORT_ID desc) = 8 then 'EOM-6' 
	when dense_rank()over(order by REPORT_ID desc) = 9 then 'EOM-7' when dense_rank()over(order by REPORT_ID desc) = 10 then 'EOM-8' 
	when dense_rank()over(order by REPORT_ID desc) = 11 then 'EOM-9' when dense_rank()over(order by REPORT_ID desc) = 12 then 'EOM-10' 
	when dense_rank()over(order by REPORT_ID desc) = 13 then 'EOM-11'
	end as MTDvsEOM
	from REPORT_IDs r
)
select 
s.Acronym
,s.Component_Acronym
,count(vh.cve) "CVE Count"
,count(Distinct vh.cve) "Unique CVE Count"

,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)

	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)    
end as CurrentMTDStart
    
,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
-- 231104 WHY IS THE NEXT LINE ALSO USING TOP 2
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 13 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)   
end as PrevEOMStart

,data_center.acronym as data_center_name
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,dense_rank()over(order by snap.REPORT_ID desc) as rankk
,s.TLC_PHASE
,CURRENT_TIMESTAMP as refresh_date
,ss.VULNRISKTOLERANCE
,snap.REPORT_ID
,snap.REPORT_DATE
FROM SnapShots snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,data_center.acronym
--,snap.REPORT_ID
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.SNAPSHOT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
,snap.REPORT_ID
,snap.REPORT_DATE
;
create or replace view V_VULN_DASHBOARD_TRENDING_LEGACY_TESTV2(
	ACRONYM,
	COMPONENT_ACRONYM,
	VULNRISKTOLERANCE,
	REPORT_ID,
	REPORT_DATE,
	NEWRANK
) as
with
REPORT_IDs as ((select REPORT_ID,REPORT_DATE, SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE, SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select REPORT_ID,REPORT_DATE, SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE, SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap <= 12)),
Snapshots as (select REPORT_ID, REPORT_DATE, SNAPSHOT_ID,dense_rank()over(order by REPORT_ID desc) NewRank,
	case when dense_rank()over(order by REPORT_ID desc) =1 then 'MTD' when dense_rank()over(order by REPORT_ID desc) = 2 then 'EOM' 
	when dense_rank()over(order by REPORT_ID desc) = 3 then 'EOM-1' when dense_rank()over(order by REPORT_ID desc) = 4 then 'EOM-2' 
	when dense_rank()over(order by REPORT_ID desc) = 5 then 'EOM-3' when dense_rank()over(order by REPORT_ID desc) = 6 then 'EOM-4' 
	when dense_rank()over(order by REPORT_ID desc) = 7 then 'EOM-5' when dense_rank()over(order by REPORT_ID desc) = 8 then 'EOM-6' 
	when dense_rank()over(order by REPORT_ID desc) = 9 then 'EOM-7' when dense_rank()over(order by REPORT_ID desc) = 10 then 'EOM-8' 
	when dense_rank()over(order by REPORT_ID desc) = 11 then 'EOM-9' when dense_rank()over(order by REPORT_ID desc) = 12 then 'EOM-10' 
	when dense_rank()over(order by REPORT_ID desc) = 13 then 'EOM-11'
	end as MTDvsEOM
	from REPORT_IDs r
)
select 
s.Acronym
,s.Component_Acronym
--,dense_rank()over(order by REPORT_ID desc) as rankk
,ss.VULNRISKTOLERANCE
,snap.REPORT_ID
,snap.REPORT_DATE
,snap.Newrank
FROM SnapShots snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,ss.VULNRISKTOLERANCE
,snap.REPORT_ID
,snap.REPORT_DATE
,snap.Newrank
;
create or replace view V_VULN_DASHBOARD_TRENDING_LEGACY_TESTV3(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) as
select 
s.Acronym
,s.Component_Acronym
,count(vh.cve) "CVE Count"
,count(Distinct vh.cve) "Unique CVE Count"

,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)

	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)    
end as CurrentMTDStart
,data_center.acronym as data_center_name
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
-- 231104 WHY IS THE NEXT LINE ALSO USING TOP 2
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 13 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)   
end as PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID_VULN_DASHBOARD_TRENDING()) snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,data_center.acronym
--,snap.REPORT_ID
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.Rankk
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
;
create or replace view V_VULN_DASHBOARD_TRENDING_LEGACY_TESTV4(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) as
select 
s.Acronym
,s.Component_Acronym
,count(vh.cve) "CVE Count"
,count(Distinct vh.cve) "Unique CVE Count"

,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)

	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)    
end as CurrentMTDStart
,data_center.acronym as data_center_name
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,case when dense_rank()over(order by snap.REPORT_ID desc) = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
-- 231104 WHY IS THE NEXT LINE ALSO USING TOP 2
	when dense_rank()over(order by snap.REPORT_ID desc) = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when dense_rank()over(order by snap.REPORT_ID desc) = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 13 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)   
end as PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID_VULN_DASHBOARD_TRENDING()) snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,data_center.acronym
--,snap.REPORT_ID
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM
,snap.Rankk
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
;
create or replace view V_VULN_DASHBOARD_TRENDING_LEGACY_TESTV5(
	ACRONYM,
	COMPONENT_ACRONYM,
	"CVE Count",
	"Unique CVE Count",
	CURRENTMTDSTART,
	DATA_CENTER_NAME,
	DATECREATED,
	DATEMITIGATED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	HVASTATUS,
	IS_BOD,
	IS_MARKETPLACE,
	MEFSTATUS,
	MITIGATIONSTATUS,
	MTDVSEOM,
	PREVEOMSTART,
	RANKK,
	REFRESH_DATE,
	REPORT_DATE,
	REPORT_ID,
	TLC_PHASE,
	VULNRISKTOLERANCE
) as
select 
s.Acronym
,s.Component_Acronym
,count(vh.cve) "CVE Count"
,count(Distinct vh.cve) "Unique CVE Count"

,case when snap.RANKK = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)
	when snap.RANKK = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 1 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by r.REPORT_ID asc)

	when snap.RANKK = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)    
end as CurrentMTDStart
,data_center.acronym as data_center_name
,vm.INSERT_DATE as datecreated
,vm.DATEMITIGATED
,sum(vh.daysSinceDiscovery) as daysSinceDiscovery
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM -- 231106
,case when snap.RANKK = 1 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
-- 231104 WHY IS THE NEXT LINE ALSO USING TOP 2
	when snap.RANKK = 2 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 2 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 3 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 3 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 4 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 4 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 5 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 5 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 6 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 6 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 7 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 7 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 8 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 8 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 9 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 9 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 10 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 10 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 11 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 11 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 12 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 12 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)
	when snap.RANKK = 13 then (SELECT top 1 REPORT_DATE::date as REPORT_DATE FROM (SELECT top 13 REPORT_ID,REPORT_DATE FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by REPORT_ID desc) r order by REPORT_ID asc)   
end as PrevEOMStart
,snap.Rankk
,CURRENT_TIMESTAMP as refresh_date
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
FROM TABLE(CORE.FN_CRM_GET_REPORT_ID_VULN_DASHBOARD_TRENDING()) snap
join CORE.VW_SYSTEMSUMMARY ss on ss.REPORT_ID = snap.REPORT_ID
join CORE.VW_VULHIST_UNFILTERED vh on vh.REPORT_ID = snap.REPORT_ID and vh.SYSTEM_ID = ss.SYSTEM_ID
left join (select DW_ASSET_ID,DW_VUL_ID,DATEMITIGATED,INSERT_DATE, CVE, CVSSV2BASESCORE, CVSSV3BASESCORE from CORE.VW_VULMASTER) vm on vm.DW_VUL_ID = vh.DW_VUL_ID
LEFT JOIN (select CVE,BODDUEDATE,IS_DELETED from CORE.KEV_CATALOG) bodcat on bodcat.CVE = vm.CVE
left outer join (select DW_ASSET_ID, DATACENTER_ID from CORE.VW_ASSETS) a on a.DW_ASSET_ID = vm.DW_ASSET_ID
left outer join (select SYSTEM_ID,ACRONYM from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = a.DATACENTER_ID
right outer join (select SYSTEM_ID,ACRONYM,COMPONENT_ACRONYM,IS_DATACENTER,IS_MARKETPLACE,HVASTATUS,MEFSTATUS,TLC_PHASE, OATO_CATEGORY from CORE.VW_SYSTEMS) s ON s.SYSTEM_ID = ss.SYSTEM_ID
group by
s.Acronym
,s.Component_Acronym
,data_center.acronym
--,snap.REPORT_ID
,vm.INSERT_DATE
,vm.datemitigated
,vh.exploitavailable
,vh.fismaseverity
,s.HVASTATUS
,bodcat.Is_Deleted
,s.IS_MARKETPLACE
,s.MEFSTATUS
,vh.MitigationStatus
,snap.MTDVSEOM
,snap.Rankk
,snap.REPORT_DATE
,snap.REPORT_ID
,s.TLC_PHASE
,ss.VULNRISKTOLERANCE
;
create or replace view V_VULN_ROLLING60DAYS_LEGACY_TEST(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	"Acronym",
	ACR_ALIAS,
	"Component_Acronym",
	"Is_DataCenter",
	"Is_MarketPlace",
	"TLC_Phase",
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	"HVAStatus",
	"MEFStatus",
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	"OATO_Category",
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) as
with ReportIDs as (
	(select REPORT_ID,REPORT_DATE,SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE,SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where DataCategory= 'VUL')a where rankkForSnap =1
	union all
	select REPORT_ID,REPORT_DATE,SNAPSHOT_ID
    from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE,SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
	where Is_endOfMonth =1 and DataCategory= 'VUL')a where rankkForSnap = 1)
),
Snapshots as (
	select Report_ID, snapshot_ID,
	case when dense_rank()over(order by Report_ID desc) =1 then 'MTD' when dense_rank()over(order by Report_ID desc) =2 then 'EOM' end as MTDvsEOM
	from ReportIDs r
)
select v."Acronym" as v_acr,v."Component_Acronym" as v_comp_acr ,v."TLC_Phase" v_tlc_phase,v."HVAStatus" as v_hva_stat,v."Is_MarketPlace" as v_is_mrkt_plc,v."MEFStatus" as v_mef_status,
case when vuln."Acronym" is null then concat(v."Acronym",'*') else v."Acronym" end as v_acr_display,
vuln.* from rpt.v_systems v
left outer join
(
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,V.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,v.DW_VUL_ID as FK_dw_vul_number
,v.cve
,v.daysSinceDiscovery
,v.exploitavailable
,v.firstseen
,v.fismaseverity
,v.lastfound
,v.mitigationstatus
,v.REPORT_ID as fk_snapshotid
,dc."Acronym"
,substring(dc."Acronym", 1, 1) + '***' as Acr_Alias
,dc."Component_Acronym"
,dc."Is_DataCenter"
,dc."Is_MarketPlace"
,dc."TLC_Phase" --,tlc_phase
,A.Is_Scannable
--,v.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,dc."HVAStatus"
,dc."MEFStatus"
,data_center."Acronym" as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by FK_SNAPSHOTID desc) as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,v.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,dc."OATO_Category"
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED v on vm.DW_VUL_ID = v.DW_VUL_ID
JOIN SnapShots snap on v.REPORT_ID = snap.snapshot_ID and 
(vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'FIXED' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON V.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join (select ID,"Acronym","Component_Acronym","Is_DataCenter","Is_MarketPlace","HVAStatus","MEFStatus", "TLC_Phase", "OATO_Category" from rpt.V_Systems where "Is_PhantomSystem"=0 and "Is_ExcludeFromReporting" =0) DC ON DC.ID = V.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat  on bodcat.CVE = V.cve

left outer join (select id,"Acronym" from rpt.V_Systems) data_center ON data_center.ID = V.datacenter_id
left outer join (select DW_VUL_ID,max(PLUGIN_ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT SYSTEM_ID,POAM_ID,CVE, Overall_Status
FROM CORE.POAMHist
where REPORT_ID = (select SNAPSHOT_ID from (select rank()over(partition by DataCategory order by REPORT_DATE desc) rankkForSnap,REPORT_ID,REPORT_DATE,SNAPSHOT_ID from CORE.VW_REPORTSNAPSHOTS
                where DataCategory= 'CFACTS')a where rankkForSnap =1)
AND CVE IS NOT NULL) pom on pom.CVE=v.CVE and pom.SYSTEM_ID=v.SYSTEM_ID
--where MitigationStatus in ('open', 'reopened') or (MitigationStatus = 'FIXED' and datemitigated > dateadd(month, -1, datefromparts(year(getdate()), month(getdate()), 1)))
) vuln on (vuln."Acronym" = v."Acronym" and vuln."Component_Acronym" = v."Component_Acronym" )
where v."Component_Acronym" not in ('Not specified','FCHCO','CMCHO') and "Is_ExcludeFromReporting" = 0
;
create or replace view V_VULN_ROLLING60DAYS_LEGACY_TESTV5(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) as
--
-- V5 replace Snapshots CTE and POAMHIST REPORT_ID (using FN_CRM_GET_REPORT_ID(0)) and mitigation filter at bottom not at join
--
--
-- The only difference between rpt.v_systems and core.rpt.wv_systems is alias names
--
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(0))
    UNION ALL
    select 2 as RANKK, REPORT_ID, 'EOM' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(1))
)
select sys.ACRONYM as v_acr,sys.COMPONENT_ACRONYM as v_comp_acr ,sys.TLC_Phase v_tlc_phase,sys.HVAStatus as v_hva_stat,sys.IS_MARKETPLACE as v_is_mrkt_plc,sys.MEFSTATUS as v_mef_status,
case when vuln.ACRONYM is null then concat(sys.ACRONYM,'*') else sys.ACRONYM end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS sys

left outer join
(
select
'1' as filter
,vh.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,vh.DATACENTER_ID as FK_DATACENTER_ID
,vh.id
,vh.DW_VUL_ID as FK_dw_vul_number
,vh.cve
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.firstseen
,vh.fismaseverity
,vh.lastfound
,vh.mitigationstatus
,vh.REPORT_ID as fk_snapshotid
,s.ACRONYM
,substring(s.ACRONYM, 1, 1) || '***' as Acr_Alias -- 231103 changed from + to ||
,s.COMPONENT_ACRONYM
,s.IS_DATACENTER
,s.IS_MARKETPLACE
,s.TLC_PHASE
,A.Is_Scannable
--,vh.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,s.HVASTATUS
,s.MEFSTATUS
,data_center.ACRONYM as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by FK_SNAPSHOTID desc) as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,vh.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,s.OATO_CATEGORY
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED vh on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN SnapShots snap on vh.REPORT_ID = snap.REPORT_ID
--and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON vh.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join CORE.VW_SYSTEMS data_center ON data_center.SYSTEM_ID = vh.datacenter_id
left outer JOIN CORE.VW_SYSTEMS s ON s.SYSTEM_ID = vh.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat on bodcat.CVE = vh.cve

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT p.SYSTEM_ID,p.POAM_ID,CVE,p.Overall_Status
    FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.POAMHist p on p.REPORT_ID = r.REPORT_ID
    where p.CVE IS NOT NULL) pom on pom.CVE=vh.CVE and pom.SYSTEM_ID=vh.SYSTEM_ID
    
where (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
) vuln on vuln.FK_PRIMARY_FISMA_ID = sys.SYSTEM_ID   -- 231103 (vuln."Acronym" = vh."Acronym" and vuln."Component_Acronym" = vh."Component_Acronym" )

where sys.COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO') -- 231103 and "Is_ExcludeFromReporting" = 0
;
create or replace view V_VULN_ROLLING60DAYS_LEGACY_TESTV6(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) as
--
-- V5 replace Snapshots CTE and POAMHIST REPORT_ID (using FN_CRM_GET_REPORT_ID(0)) and mitigation filter at bottom not at join
--
--
-- The only difference between rpt.v_systems and core.rpt.wv_systems is alias names
--
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(0))
    UNION ALL
    select 2 as RANKK, REPORT_ID, 'EOM' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(1))
)
select sys.ACRONYM as v_acr,sys.COMPONENT_ACRONYM as v_comp_acr ,sys.TLC_Phase v_tlc_phase,sys.HVAStatus as v_hva_stat,sys.IS_MARKETPLACE as v_is_mrkt_plc,sys.MEFSTATUS as v_mef_status,
case when vuln.ACRONYM is null then concat(sys.ACRONYM,'*') else sys.ACRONYM end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS sys

left outer join
(
select
'1' as filter
,vh.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,vh.DATACENTER_ID as FK_DATACENTER_ID
,vh.id
,vh.DW_VUL_ID as FK_dw_vul_number
,vh.cve
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.firstseen
,vh.fismaseverity
,vh.lastfound
,vh.mitigationstatus
,vh.REPORT_ID as fk_snapshotid
,s.ACRONYM
,substring(s.ACRONYM, 1, 1) || '***' as Acr_Alias -- 231103 changed from + to ||
,s.COMPONENT_ACRONYM
,s.IS_DATACENTER
,s.IS_MARKETPLACE
,s.TLC_PHASE
,A.Is_Scannable
--,vh.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,s.HVASTATUS
,s.MEFSTATUS
,data_center.ACRONYM as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
--,dense_rank()over(order by vh.REPORT_ID desc) as rankk -- 231201
,snap.RANKK as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,vh.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,s.OATO_CATEGORY
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED vh on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN SnapShots snap on vh.REPORT_ID = snap.REPORT_ID
--and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON vh.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join CORE.VW_SYSTEMS data_center ON data_center.SYSTEM_ID = vh.datacenter_id
left outer JOIN CORE.VW_SYSTEMS s ON s.SYSTEM_ID = vh.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat on bodcat.CVE = vh.cve

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT p.SYSTEM_ID,p.POAM_ID,CVE,p.Overall_Status
    FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.POAMHist p on p.REPORT_ID = r.REPORT_ID
    where p.CVE IS NOT NULL) pom on pom.CVE=vh.CVE and pom.SYSTEM_ID=vh.SYSTEM_ID
    
where (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
) vuln on vuln.FK_PRIMARY_FISMA_ID = sys.SYSTEM_ID   -- 231103 (vuln."Acronym" = vh."Acronym" and vuln."Component_Acronym" = vh."Component_Acronym" )

where sys.COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO') -- 231103 and "Is_ExcludeFromReporting" = 0
;
create or replace view V_VULN_ROLLING60DAYS_LEGACY_TESTV6_TRASH(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILY_NAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	VRT,
	POAM_ID,
	OVERALL_STATUS
) as
--
-- V5 replace Snapshots CTE and POAMHIST REPORT_ID (using FN_CRM_GET_REPORT_ID(0)) and mitigation filter at bottom not at join
--
--
-- The only difference between rpt.v_systems and core.rpt.wv_systems is alias names
--
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(0))
)
select sys.ACRONYM as v_acr,sys.COMPONENT_ACRONYM as v_comp_acr ,sys.TLC_Phase v_tlc_phase,sys.HVAStatus as v_hva_stat,sys.IS_MARKETPLACE as v_is_mrkt_plc,sys.MEFSTATUS as v_mef_status,
case when vuln.ACRONYM is null then concat(sys.ACRONYM,'*') else sys.ACRONYM end as v_acr_display,
vuln.* from CORE.VW_SYSTEMS sys

left outer join
(
select
'1' as filter
,vh.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,vh.DATACENTER_ID as FK_DATACENTER_ID
,vh.id
,vh.DW_VUL_ID as FK_dw_vul_number
,vh.cve
,vh.daysSinceDiscovery
,vh.exploitavailable
,vh.firstseen
,vh.fismaseverity
,vh.lastfound
,vh.mitigationstatus
,vh.REPORT_ID as fk_snapshotid
,s.ACRONYM
,substring(s.ACRONYM, 1, 1) || '***' as Acr_Alias -- 231103 changed from + to ||
,s.COMPONENT_ACRONYM
,s.IS_DATACENTER
,s.IS_MARKETPLACE
,s.TLC_PHASE
,A.Is_Scannable
--,vh.cvss2basescore
,bodcat.BODDueDate
,vm.insert_date as datecreated
,vm.datemitigated
,s.HVASTATUS
,s.MEFSTATUS
,data_center.ACRONYM as data_center_name
,vm.DeletionReason
,p.ID as fk_pluginID
,p.solution
,p.family_name
,p.synopsis as signature
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
--,dense_rank()over(order by vh.REPORT_ID desc) as rankk -- 231201
,snap.RANKK as rankk
,CURRENT_TIMESTAMP as refresh_date
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (1) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) CurrentMTDStart
--,(SELECT top (1) convert(date,reportdate) FROM (SELECT top (2) ID,ReportDate FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by ID desc) r order by ID asc) PrevEOMStart
,vh.DW_ASSET_ID as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,A.source_tool_lastseen as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,D.DeviceType
,snap.MTDvsEOM
,s.OATO_CATEGORY
,vm.cvssv2basescore
,vm.cvssv3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID
,pom.Overall_Status
from CORE.VulMaster vm 
left join CORE.VW_VULHIST_UNFILTERED vh on vm.DW_VUL_ID = vh.DW_VUL_ID
JOIN SnapShots snap on vh.REPORT_ID = snap.REPORT_ID
--and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
left outer JOIN CORE.Asset A ON vh.DW_ASSET_ID = A.DW_ASSET_ID  and A.is_applicable=1
left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join CORE.VW_SYSTEMS data_center ON data_center.SYSTEM_ID = vh.datacenter_id
left outer JOIN CORE.VW_SYSTEMS s ON s.SYSTEM_ID = vh.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_CATALOG ) bodcat on bodcat.CVE = vh.cve

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VulPlugin vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vm.DW_VUL_ID)
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID
--left outer join (select id,solution,familyname,pluginid,signature from CORE.Plugins ) p on (p.ID = plugs.fk_pluginID)
left outer join (SELECT p.SYSTEM_ID,p.POAM_ID,CVE,p.Overall_Status
    FROM table(CORE.FN_CRM_GET_REPORT_ID(0)) r
    JOIN CORE.POAMHist p on p.REPORT_ID = r.REPORT_ID
    where p.CVE IS NOT NULL) pom on pom.CVE=vh.CVE and pom.SYSTEM_ID=vh.SYSTEM_ID
    
where (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
) vuln on vuln.FK_PRIMARY_FISMA_ID = sys.SYSTEM_ID   -- 231103 (vuln."Acronym" = vh."Acronym" and vuln."Component_Acronym" = vh."Component_Acronym" )

where sys.COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO') -- 231103 and "Is_ExcludeFromReporting" = 0
;
create or replace view V_VULN_ROLLING60DAYS_SDW_TEST(
	V_ACR,
	V_COMP_ACR,
	V_TLC_PHASE,
	V_HVA_STAT,
	V_IS_MRKT_PLC,
	V_MEF_STATUS,
	V_ACR_DISPLAY,
	FILTER,
	FK_PRIMARY_FISMA_ID,
	FK_DATACENTER_ID,
	ID,
	FK_DW_VUL_NUMBER,
	CVE,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	LASTFOUND,
	MITIGATIONSTATUS,
	FK_SNAPSHOTID,
	ACRONYM,
	ACR_ALIAS,
	COMPONENT_ACRONYM,
	IS_DATACENTER,
	IS_MARKETPLACE,
	TLC_PHASE,
	IS_SCANNABLE,
	BODDUEDATE,
	DATECREATED,
	DATEMITIGATED,
	HVASTATUS,
	MEFSTATUS,
	DATA_CENTER_NAME,
	DELETIONREASON,
	FK_PLUGINID,
	SOLUTION,
	FAMILYNAME,
	SIGNATURE,
	IS_BOD,
	RANKK,
	REFRESH_DATE,
	CURRENTMTDSTART,
	PREVEOMSTART,
	FK_ASSETID,
	COMPUTER_TYPE,
	OS,
	BIOS_GUID,
	SOURCE_TOOL,
	ENVIRONMENT,
	ASSET_ID_TATTOO,
	OS_VERSION,
	TENABLEUUID,
	DEVICETYPE,
	MTDVSEOM,
	OATO_CATEGORY,
	CVSS2BASESCORE,
	CVSS3BASESCORE,
	VRT,
	"POA&M ID",
	OVERALL_STATUS
) as
with
Snapshots as (
    select 1 as RANKK, REPORT_ID, 'MTD' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(0))
    UNION ALL
    select 2 as RANKK, REPORT_ID, 'EOM' as MTDVSEOM from table(CORE.FN_CRM_GET_REPORT_ID(1))
)
select v.Acronym as v_acr
,v.Component_Acronym as v_comp_acr 
,v.TLC_Phase v_tlc_phase
,v.HVAStatus as v_hva_stat
,v.Is_MarketPlace as v_is_mrkt_plc
,v.MEFStatus as v_mef_status
,case when vuln.acronym is null then concat(v.Acronym,'*') else v.Acronym end as v_acr_display
,vuln.* 
from CORE.VW_SYSTEMS v
left outer join
(
select
'1' as filter
,v.SYSTEM_ID as FK_PRIMARY_FISMA_ID
,V.DATACENTER_ID as FK_DATACENTER_ID
,v.id
,vm.dw_vul_id as fk_dw_vul_number
,v.cve
,v.daysSinceDiscovery
,v.exploitavailable
,v.firstseen
,v.fismaseverity
,v.lastfound
,vm.mitigationstatus
,snap.REPORT_ID as fk_snapshotid
,dc.Acronym
,substring(dc.Acronym, 1, 1) || '***' as Acr_Alias
,dc.Component_Acronym
,dc.Is_DataCenter
,dc.Is_MarketPlace
,tlc_phase
,A.Is_Scannable
,bodcat.BODDueDate
,vm.firstseen as datecreated
,vm.datemitigated
,dc.HVAStatus
,dc.MEFStatus
,data_center.acronym as data_center_name
,NULL as DeletionReason
,p.PLUGIN_ID as fk_pluginID -- 230802
,p.solution
,p.FAMILY_NAME as familyname -- 230802
,p.synopsis as signature -- 230802
,case when bodcat.Is_Deleted = 0 then 'Yes' else 'No' end as is_bod
,dense_rank()over(order by snap.REPORT_ID desc) as rankk
,CURRENT_TIMESTAMP() as refresh_date
-- 231031 Next 2 subqueries were referencing ReportIDs from WITH (above)
,(SELECT top 1 report_date::DATE FROM (SELECT top 1 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) CurrentMTDStart
,(SELECT top 1 report_date::DATE FROM (SELECT top 2 Report_ID,Report_Date FROM CORE.REPORT_IDS where Is_endOfMonth=1 order by Report_ID desc) r order by Report_ID asc) PrevEOMStart
,A.dw_asset_id as FK_AssetID
,A.computer_type
,A.os
,A.bios_guid
,NULL as source_tool
,A.environment
,A.asset_id_tattoo
,A.os_version
,A.TenableUUID
,A.DeviceType
,snap.MTDvsEOM
,dc.OATO_Category
,vm.CVSSV2BASESCORE as cvss2basescore
,vm.CVSSV3BASESCORE as cvss3basescore
,a.VulnRiskTolerance VRT
,pom.POAM_ID as "POA&M ID"
,pom.Overall_Status
from CORE.VW_VulMaster vm 
left join CORE.VW_VulHist v on vm.dw_vul_id = v.dw_vul_id and (vm.MitigationStatus in ('open', 'reopened') or (vm.MitigationStatus = 'fixed' and vm.datemitigated > (current_date() - 60)))
JOIN SnapShots snap on v.report_id = snap.REPORT_ID 
left outer JOIN CORE.VW_Assets A ON V.DW_ASSET_ID = A.DW_ASSET_ID
--231031 left outer JOIN CORE.DeviceTypes D ON a.DeviceType=D.DEVICETYPE
left outer join (select SYSTEM_ID,Acronym,Component_Acronym,Is_DataCenter,Is_MarketPlace,HVAStatus,MEFStatus, tlc_phase, OATO_Category from CORE.VW_SYSTEMS) DC ON DC.SYSTEM_ID = V.SYSTEM_ID
LEFT JOIN (select cve,bodDueDate,Is_Deleted from CORE.KEV_Catalog ) bodcat  on bodcat.CVE = V.cve
left outer join (select SYSTEM_ID,acronym from CORE.VW_SYSTEMS) data_center ON data_center.SYSTEM_ID = V.datacenter_id

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VULPLUGIN group by DW_VUL_ID) plugs on plugs.DW_VUL_ID = vm.dw_vul_id -- 230802 modified
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID -- 230802 modified

left outer join CORE.VW_POAMHIST pom on pom.SYSTEM_ID = v.SYSTEM_ID and pom.REPORT_ID = (select REPORT_ID from Snapshots where RANKK = 1)

) vuln on vuln.acronym = v.Acronym and vuln.Component_Acronym = v.Component_Acronym 

where v.Component_Acronym not in ('Not specified','FCHCO','CMCHO');
CREATE OR REPLACE FUNCTION "CMR_JS_TEST"("ARR" ARRAY, "TAG" VARCHAR(16777216))
RETURNS ARRAY
LANGUAGE JAVASCRIPT
AS '
--CDM.HWAM_AWS.EXTRACT_ARRAY
    var result=[];
    for (i in ARR)
    {
    if(typeof(ARR[i][TAG])==''object'')
    {
      if(ARR[i][TAG].length==0)
    {
     continue;
    }
    else{
     result.push(ARR[i][TAG]);
    }
    }
    else{
     result.push(ARR[i][TAG]);
    }
    }
    return result;
  ';
CREATE OR REPLACE FUNCTION "CMR_PARSE_TAG"("TAG" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
AS '
    var result=[];

    result.push(split_part(TAG,'','',1));

    return result;
  ';
CREATE OR REPLACE FUNCTION "FN_CRM_DISCOVER_PATTERN_RM"("P_STRING" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Replace alphas and numbers with $ to yield adata pattern'
AS '
--
-- Replace alphas and numbers with $
-- remaining characters represent a format pattern when special
-- characters are included in the string
--
REGEXP_REPLACE(REGEXP_REPLACE(upper(P_STRING),''[A-Z]+'',''$'') ,''[0-9]+'',''#'')    
  
';
CREATE OR REPLACE PROCEDURE "GET_PROCEDURE_SOURCE"("PROC_FULL_NAME" VARCHAR(16777216), "ARGUMENT_SIGNATURE" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE JAVASCRIPT
EXECUTE AS OWNER
AS '
    // Parse proc_full_name into database_name, schema_name, and procedure_name
    var parts = PROC_FULL_NAME.split(''.'');
    if (parts.length !== 3) {
        throw ''Invalid procedure name format. Expected format: database.schema.procedure'';
    }
    var database_name = parts[0];
    var schema_name = parts[1];
    var procedure_name = parts[2];

    // Prepare the SQL query to find the procedure in INFORMATION_SCHEMA.PROCEDURES
    var sql_command = `
        SELECT *
        FROM ${database_name}.INFORMATION_SCHEMA.PROCEDURES
        WHERE PROCEDURE_SCHEMA = ? AND PROCEDURE_NAME = ?
    `;
    var binds = [schema_name, procedure_name];

    if (ARGUMENT_SIGNATURE && ARGUMENT_SIGNATURE.trim() !== '''') {
        sql_command += '' AND ARGUMENT_SIGNATURE = ?'';
        binds.push(ARGUMENT_SIGNATURE);
    }

    // Execute the query
    var stmt = snowflake.createStatement({
        sqlText: sql_command,
        binds: binds
    });
    var result = stmt.execute();

    // Fetch the results
    var procedures = [];
    while (result.next()) {
        var proc = {
            procedure_name: result.getColumnValue(''PROCEDURE_NAME''),
            procedure_schema: result.getColumnValue(''PROCEDURE_SCHEMA''),
            procedure_catalog: result.getColumnValue(''PROCEDURE_CATALOG''),
            argument_signature: result.getColumnValue(''ARGUMENT_SIGNATURE''),
            procedure_definition: result.getColumnValue(''PROCEDURE_DEFINITION''),
            comment: result.getColumnValue(''COMMENT'')
        };
        procedures.push(proc);
    }

    if (procedures.length === 0) {
        throw ''Procedure not found.'';
    } else if (procedures.length > 1 && (!ARGUMENT_SIGNATURE || ARGUMENT_SIGNATURE.trim() === '''')) {
        throw ''Multiple procedures found. Please specify the argument signature.'';
    } else {
        var proc = procedures[0];
    }

    // Construct the fully qualified procedure name with argument signature
    var full_proc_name_with_signature = `${database_name}.${schema_name}.${procedure_name}`;
    
    if (proc.argument_signature && proc.argument_signature.trim() !== '''') {
        let s = proc.argument_signature.slice(1, -1); // Remove the outer parentheses
        let items = s.split('',''); // Split the string into individual items
        items = items.map(item => item.trim()); // Trim whitespace from each item

        let datatypes = items.map(item => {
            let parts = item.split(/\\s+/); // Split on one or more spaces
            parts.shift(); // Remove the variable name
            return parts.join('' ''); // Rejoin the remaining parts (datatype)
        });

        let arg_result = ''('' + datatypes.join('', '') + '')'';
        
        
        full_proc_name_with_signature += arg_result;
    }

    // Get the DDL of the procedure using GET_DDL
    var ddl_sql = `SELECT GET_DDL(''PROCEDURE'', ''${full_proc_name_with_signature}'') AS DDL_TEXT`;
    var ddl_stmt = snowflake.createStatement({
        sqlText: ddl_sql
    });
    var ddl_result = ddl_stmt.execute();

    if (ddl_result.next()) {
        var ddl_text = ddl_result.getColumnValue(''DDL_TEXT'');
    } else {
        throw ''Unable to retrieve DDL of the procedure.'';
    }

    // Parse the DDL text by splitting on '' AS '' and take the first element (header)
    var ddl_parts = ddl_text.split("AS ''");
    if (ddl_parts.length >= 2) {
        var header = ddl_parts[0].trim().replace(/;$/, '''').replaceAll(''"'','''');
    } else {
        throw ''Unable to parse the DDL header.'';
    }

    // Get the procedure_definition and comment from the proc variable
    var procedure_definition = proc.procedure_definition;
    var comment = proc.comment;

    
     var final_text = `${header}
AS
${procedure_definition}
                        `;
    // if (comment && comment.trim() !== '''') {
    //     final_text += `\\nCOMMENT=''${comment}''`;
    // }

    // Return the concatenated text
    return final_text;
';
CREATE OR REPLACE FUNCTION "GET_SOFTWARE_KEY"("INPUT" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
AS '
    TRIM(REGEXP_REPLACE(
      REGEXP_REPLACE(
        REGEXP_REPLACE(
          REGEXP_REPLACE(
            REGEXP_REPLACE(
              REGEXP_REPLACE(
                UPPER(REPLACE(REPLACE(REPLACE(REPLACE(input, ''"'', ''''),''-'','' ''),''  '','' ''),''.'',''''))
              ,''\\\\[[^\\\\]]*\\\\]'', '''')         -- Remove all bracketed values: [ ... ]
            ,''\\\\b\\\\d+(\\\\.\\\\d+)*\\\\b'', '''')    -- Remove all versions like 1.0 or 2.5.3
            ,''[^\\x00-\\x7F]'', '''')            -- Remove all non-ASCII characters
          ,''{^\\x00-\\x7F}'', '''')              -- Remove patterns that might contain braces or non-ASCII
        ,''\\\\s*\\\\([^)]*\\\\)'', '''')             -- Remove text in parentheses ( ... )
      ,''\\\\s*\\\\{[^}]*\\\\}'', '''')               -- Remove text in curly braces { ... }
      )
';
CREATE OR REPLACE PROCEDURE "SP_CRM_AWS_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_AWS_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_AWS_HWAM'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_HWAM'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_BACKUP"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Backup of CRM code into files'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_TEMPLATE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');  

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

show views;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''view'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

-- will need to build the create statement from cursor + show columns
-- show tables;
-- insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
-- update SANDBOX.TEST_CODE_BACKUP set object_type = ''table'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

show pipes;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''pipe'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

show procedures;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''procedure'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

show user functions;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''function'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

show FILE FORMATS;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''FILE FORMATS'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

show STREAMS;
insert into SANDBOX.TEST_CODE_BACKUP(database_name, schema_name, name, text) select "database_name", "schema_name", "name", "text" from table(result_scan(LAST_QUERY_ID())) ;
update SANDBOX.TEST_CODE_BACKUP set object_type = ''STREAMS'', insert_date = current_timestamp() where object_type is NULL and insert_date is NULL;

  
CALL CORE.SP_CRM_END_PROCEDURE (:Appl);

return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CCIC_TENABLE_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_CCIC_TENABLE_VUL'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_CCIC_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_VULPLUGINS_MASTER'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_VULPLUGIN'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_CCIC_VUL_MITIGATED'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_VULPLUGINS_MASTER'');


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_CONCLUDE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_CONCLUDE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_VULCVE_MASTER'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_KEV_CATALOG'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_ASSETAGING'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_DETERMINE_DEVICETYPE'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_CALCULATE_ASSET'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_WRITE_ASSETINTERFACECOALESCED'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_WRITE_SUMMARY_TABLES'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_CRMP_METRICS'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_TRAL_EVALUATION'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''UPDATE REPORT_IDS. Is_EndOfMonth'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_WRITE_ASSETHIST'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_WRITE_VULHIST'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_REPORT_IDS'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_HEALTH_CHECKER'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''UPDATE REPORT_IDS. IS_VIABLE'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_WRITE_REPORTINGTABLES'');

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_FORESCOUT_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_FORSCOUT_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_FORESCOUT'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_HWAM'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_INITIATE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_INITIATE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_GENERATE_REPORT_ID'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_CFACTS'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_PRIMARY_OP_LOC'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_SYSTEMSAWSACCOUNTS'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''UPDATE ASSET.PREV_LAST_CONFIRMED_TIME'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''TRUNCATE TABLE CORE.TEMP_HWAM'');

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_IUSG_TENABLE_VUL"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_IUSG_TENABLE_VUL'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_IUSG_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_VULPLUGINS_MASTER'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_VULPLUGIN'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_IUSG_VUL_MITIGATED'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PREP_RAW_TENABLE_VUL'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_LOAD_ASSET'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_VULPLUGINS_MASTER'');


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_KEV_CATALOG"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='TBD'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SANDBOX.SP_CRM_KEV_CATALOG'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_PULL_KEV_CATALOG'');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''CALL CORE.SP_CRM_UPDATE_KEV_CATALOG'');

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_LINK_METADATA"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Link metadata to each related vulnerability record within snapshot'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_LINK_METADATA'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
TheRowCount NUMBER := 0;
RECORD_COUNT number;
BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

/***********************************************************************************************************************************

CCIC (On-prem) Tenable Vulnerability data does not contain ASSET_ID_TATTOO or PRIMARY_FISMA_ID_TATTOO values.
In order to provide these two tag values there are two Plugin_IDs (i.e. Scripts) that read the tag data from the asset.
These plugin results are part of the vulnerability data stream but are not in-themseleves vulnerabilities.
The plugin results are stored in the Tenable field PLUGINTEXT and are parsed using CORE.FN_CRM_PARSE_PLUGIN_TAGS.

PluginID    PluginName                            Operating System
1218405     Check for Empty FISMA Tattoo files.   Linux
1221295     Print out FISMA registry keys.        Windows

The purpose of this stored procedure is to enhance the actual vulnerability record with the tag values for proper identification
of the asset.

Although the plugins are supposed to return the ASSET_ID_TATTOO or PRIMARY_FISMA_ID_TATTOO values this is not always the case.
One factor for this failure is that a credentialed scan was not done.


TATTOO PLUGINS ALWAYS HAVE THE FOLLOWING (SOMTIMES MACADDRESS IS NULL)
DATACENTER_ID	DNSNAME	IP	MACADDRESS	NETBIOSNAME	TENABLEUUID

************************************************************************************************************************************/

BEGIN TRANSACTION;
--
-- Initialize CMR_ID
--
UPDATE CORE.RAW_TENABLE_VUL
set CMR_ID = 0
WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;

UPDATE CORE.RAW_TENABLE_VUL  upd
set CMR_ID = seq.SEQ_TEMP_DW_ASSET_ID
FROM (select d.DATACENTER_ID,d.REPOSITORY_ID,d.IP,d.DNSNAME,SEQ_TEMP_DW_ASSET_ID.NEXTVAL as SEQ_TEMP_DW_ASSET_ID
    FROM (select DISTINCT DATACENTER_ID,REPOSITORY_ID,IP,DNSNAME
        FROM CORE.RAW_TENABLE_VUL where SNAPSHOT_ID = :P_SNAPSHOT_ID and CMR_ID = 0) d) seq
        
WHERE upd.SNAPSHOT_ID = :P_SNAPSHOT_ID
and coalesce(seq.DATACENTER_ID,''Fake'') = coalesce(upd.DATACENTER_ID,''Fake'')
and seq.REPOSITORY_ID = upd.REPOSITORY_ID
and coalesce(seq.IP,''Fake'') = coalesce(upd.IP,''Fake'')
and coalesce(seq.DNSNAME,''Fake'') = coalesce(upd.DNSNAME,''Fake'')
and upd.CMR_ID = 0;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Assigned CMR_ID to REPOSITORY_ID,IP,DNSNAME='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;

select count(1) into :RECORD_COUNT FROM CORE.RAW_TENABLE_VU WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and CMR_ID = 0;
If (:RECORD_COUNT > 0) THEN -- 230918
    BEGIN
    Msg := ''WARNING: CMR_ID Unassigned ='' || :RECORD_COUNT;
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
    END;
END IF;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SANDBOX.SP_CRM_PULL_FORESCOUT'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
FORESCOUT varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousForescoutPull TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);
False boolean := 0;
DEFAULT_CPE varchar := ''default_cpe'';
IRRESOLVABLE varchar := ''Irresolvable'';
UNKNOWN varchar := ''Unknown'';
True boolean := 1;
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:FORESCOUT);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:FORESCOUT);
--SNAPSHOT_ID := 1587;

PreviousForescoutPull := (select PARMDATE FROM CORE.CONFIG where PARMNAME = ''PreviousForescoutPull'');
Msg := ''PreviousForescoutPull='' || :PreviousForescoutPull;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into SANDBOX.RAW_FORESCOUT (
ASSET_ID_TATTOO,
AWS_ACCOUNTID,
AWS_DATACENTER_ID,
AWS_INSTANCE_ID,
AWS_PRIMARY_FISMA_ID_TATTOO,
AXONIUS_ADAPTER_LIST_LENGTH,
AXONIUS_ADAPTERS,
AXONIUS_ADAPTERS_UUID,
AXONIUS_INTERNAL_AXONIUS_ID,
BIGFIX_ASSET_ID,
BIGFIX_ASSET_ID_DETAILS,
BIGFIX_ASSET_ID_TATTOO,
BIGFIX_ASSET_ID_TATTOO_DETAILS,
BIGFIX_DATACENTER_ID,
BIGFIX_DATACENTER_ID_DETAILS,
BIGFIX_PRIMARY_FISMA_ID_TATTOO,
BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
BIOS_GUID,
CLOUD_ID,
CLOUD_PROVIDER,
COMPUTER_TYPE,
CONNECTION_LABEL,
DATA_ERROR_ARRAY,
DATA_WARNING_ARRAY,
DATACENTER_ID,
DATECOMPLETED,
DEVICE_MANUFACTURER,
DEVICE_TYPE,
DEVICEMODEL,
DOMAIN_PREFERRED,
DW_ASSET_ID,
ENVIRONMENT,
EVENTTIME,
FIRST_FETCH_TIME,
FISMA_UUID,
FORESCOUT_ASSET_ID_TATTOO,
FORESCOUT_ASSIGNED_LABELS,
FORESCOUT_DATACENTER_ID,
FORESCOUT_DATACENTER_ID_DETAILS,
FORESCOUT_PRIMARY_FISMA_ID,
FQDN,
FS_APPLIANCE_IP,
FS_GROUPS,
FS_HWI_MOTHERBOARD,
FS_HWI_PROCESSOR,
FS_LABEL_LIST,
FS_LINUX_ASSET_ID,
FS_LINUX_FISMA_ID,
FS_LINUX_HOSTNAME,
FS_LINUX_OPERATING_SYSTEM,
FS_LINUX_RUNNING_PROCESSES,
FS_NETBIOS_DOMAIN,
FS_SENDER_INFO,
FS_SENDER_INFO_DATE,
FS_VA_OS,
FS_VA_OS_CPE,
FS_WINDOWS_APPLICATIONS_INSTALLED,
HOSTNAME,
INSERT_DATE,
INSTANCESTATUS,
IPV4,
IPV6,
IS_FS_MANAGED,
IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
IS_WINDOWS_SERVER_PREFERRED,
LABELS,
LAST_CONFIRMED_TIME,
LAST_USED_USERS_COMPANY_ASSOCIATION,
LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
MACADDRESS,
MOTHERBOARD,
NETBIOSNAME,
OS,
OS_BUILD_PREFERRED,
OS_CPE,
OS_DOTTED,
OS_MAJOR,
OS_MINOR,
OS_TYPE_DISTRIBUTION_PREFERRED,
OS_TYPE_PREFERRED,
OS_VERSION,
PRIMARY_FISMA_ID_DERIVED,
PRIMARY_FISMA_ID_TATTOO,
REPORTDATE,
REPOSITORY_DESCRIPTION_DETAILS,
ROWDISPOSITION,
SITECODE_PREFERRED,
SNAPSHOT_ID,
SOURCE_TOOL,
SUBNETS_PREFERRED,
SYSTEM_ACRONYM,
SYSTEM_ID,
TENABLE_ASSET_ID_TATTOO,
TENABLE_ASSET_TAGS,
TENABLE_DATACENTER_ID,
TENABLE_PRIMARY_FISMA_ID_TATTOO,
TIME_ZONE,
VIRTUAL_HOST,
WINDOWS_PATCH_VERSION
)
SELECT 
-- FILE_NAME and RAW fields in view are not used
NULL -- ASSET_ID_TATTOO
,NULL -- AWS_ACCOUNTID
,NULL -- AWS_DATACENTER_ID
,NULL -- AWS_INSTANCE_ID
,NULL -- AWS_PRIMARY_FISMA_ID_TATTOO
,NULL -- AXONIUS_ADAPTER_LIST_LENGTH
,NULL -- AXONIUS_ADAPTERS
,NULL -- AXONIUS_ADAPTERS_UUID
,NULL -- AXONIUS_INTERNAL_AXONIUS_ID
,NULL -- BIGFIX_ASSET_ID
,NULL -- BIGFIX_ASSET_ID_DETAILS
,NULL -- BIGFIX_ASSET_ID_TATTOO
,NULL -- BIGFIX_ASSET_ID_TATTOO_DETAILS
,NULL -- BIGFIX_DATACENTER_ID
,NULL -- BIGFIX_DATACENTER_ID_DETAILS
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS
,NULL -- BIOS_GUID
,NULL -- CLOUD_ID
,NULL -- CLOUD_PROVIDER
,NULL -- COMPUTER_TYPE
,NULL -- CONNECTION_LABEL
,NULL -- DATA_ERROR_ARRAY
,NULL -- DATA_WARNING_ARRAY
,NULL -- DATACENTER_ID
,NULL -- DATECOMPLETED
,NULL -- DEVICE_MANUFACTURER
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(ASSET_FUNCTION) as DEVICE_TYPE
,NULL -- DEVICEMODEL
,NULL -- DOMAIN_PREFERRED
,NULL -- DW_ASSET_ID
,NULL -- ENVIRONMENT
,NULL -- EVENTTIME
,NULL -- FIRST_FETCH_TIME
,NULL -- FISMA_UUID
,NULL -- FORESCOUT_ASSET_ID_TATTOO
,NULL -- FORESCOUT_ASSIGNED_LABELS
,NULL -- FORESCOUT_DATACENTER_ID
,NULL -- FORESCOUT_DATACENTER_ID_DETAILS
,NULL -- FORESCOUT_PRIMARY_FISMA_ID
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(DNS_NAME),'','') as FQDN
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(APPLIANCE_IP) as FS_APPLIANCE_IP
,GROUPS -- FS_GROUPS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_MOTHERBOARD) as FS_HWI_MOTHERBOARD
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_PROCESSOR) as FS_HWI_PROCESSOR
,LABEL_LIST -- FS_LABEL_LIST
,TRIM(REPLACE(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_ASSET_ID),''/var/CMS/FISMA/Asset_ID/'','''')) as FS_LINUX_ASSET_ID
,TRIM(REPLACE(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_FISMA_ID),''/var/CMS/FISMA/Primary_FISMA_ID/'','''')) as FS_LINUX_FISMA_ID
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_HOSTNAME) as FS_LINUX_HOSTNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_OPERATING_SYSTEM) as FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES -- FS_LINUX_RUNNING_PROCESSES
,NETBIOS_DOMAIN -- FS_NETBIOS_DOMAIN
,SENDER_INFO -- FS_SENDER_INFO
,NULL -- FS_SENDER_INFO_DATE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS) as FS_VA_OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS_CPE) as FS_VA_OS_CPE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(WINDOWS_APPLICATIONS_INSTALLED) as FS_WINDOWS_APPLICATIONS_INSTALLED
,NULL -- HOSTNAME
,CURRENT_TIMESTAMP() -- INSERT_DATE
,NULL -- INSTANCESTATUS
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV4),'','') as IPV4
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV6),'','') as IPV6
,NULL -- IS_FS_MANAGED
,NULL -- IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,NULL -- IS_WINDOWS_SERVER_PREFERRED
,NULL -- LABELS
,NULL -- LAST_CONFIRMED_TIME
,NULL -- LAST_USED_USERS_COMPANY_ASSOCIATION
,NULL -- LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,STRTOK_TO_ARRAY(MAC_ADDRESS,'','') -- MACADDRESS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MOTHERBOARD_SN) as MOTHERBOARD
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_HOSTNAME),'','') as NETBIOSNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OPERATING_SYSTEM) as OS
,NULL -- OS_BUILD_PREFERRED
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OS_CPE) as OS_CPE
,NULL -- OS_DOTTED
,NULL -- OS_MAJOR
,NULL -- OS_MINOR
,NULL -- OS_TYPE_DISTRIBUTION_PREFERRED
,NULL -- OS_TYPE_PREFERRED
,NULL -- OS_VERSION
,NULL -- PRIMARY_FISMA_ID_DERIVED
,NULL -- PRIMARY_FISMA_ID_TATTOO
,S3_FILE_TS -- REPORTDATE
,NULL -- REPOSITORY_DESCRIPTION_DETAILS
,NULL -- ROWDISPOSITION
,NULL -- SITECODE_PREFERRED
,:SNAPSHOT_ID -- SNAPSHOT_ID
,''Forescout'' -- SOURCE_TOOL
,NULL -- SUBNETS_PREFERRED
,NULL -- SYSTEM_ACRONYM
,NULL -- SYSTEM_ID
,NULL -- TENABLE_ASSET_ID_TATTOO
,NULL -- TENABLE_ASSET_TAGS
,NULL -- TENABLE_DATACENTER_ID
,NULL -- TENABLE_PRIMARY_FISMA_ID_TATTOO
,NULL -- TIME_ZONE
,NULL -- VIRTUAL_HOST
,NULL -- WINDOWS_PATCH_VERSION
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = ''PreviousForescoutPull'' and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;


CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''START'');

BEGIN TRANSACTION;

UPDATE SANDBOX.RAW_FORESCOUT
set FS_SENDER_INFO_DATE = (date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(FS_SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END
|| ''-'' || substring(FS_SENDER_INFO,5,11)
)::datetime
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
--
-- Initialize
--
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionViable
,DATACENTER_ID = NULL
,SYSTEM_ID = NULL
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :False
,DATA_ERROR_ARRAY = ARRAY_CONSTRUCT()
,DATA_WARNING_ARRAY = ARRAY_CONSTRUCT()
FROM SANDBOX.RAW_FORESCOUT r
where r.RAW_HWAM_ID = SANDBOX.RAW_FORESCOUT.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
-- Parse FS_GROUPS field to obtain DATACENTER_ID

/*
UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = split_part(substring(FS_GROUPS,(charindex(''DC-'',FS_GROUPS,1) + 3),100),'','',1)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;
*/

UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(FS_GROUPS)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID is Null or Empty
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID does not exist
UPDATE SANDBOX.RAW_FORESCOUT upd
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;

COMMIT;

/*****
-- Validate SYSTEM_ACRONYM as an FYI. For the present time we also check to see if the acronym is a CommonName (not found in CFACTS)
UPDATE SANDBOX.RAW_FORESCOUT upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ACRONYM does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ACRONYM IS NOT NULL and (s.SYSTEM_ID IS NULL and c.SYSTEM_ID IS NULL);
***********/

BEGIN TRANSACTION;
-- Clean FS_LINUX_HOSTNAME
UPDATE SANDBOX.RAW_FORESCOUT
set FS_LINUX_HOSTNAME = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_LINUX_HOSTNAME LIKE ''Last login:%'');
COMMIT;


/*
BEGIN TRANSACTION;
-- Clean FS_WINDOWS_APPLICATIONS_INSTALLED
UPDATE SANDBOX.RAW_FORESCOUT
set FS_WINDOWS_APPLICATIONS_INSTALLED = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and FS_WINDOWS_APPLICATIONS_INSTALLED = :IRRESOLVABLE;
COMMIT;
*/

BEGIN TRANSACTION;
-- Extract ASSET_ID_TATTOO
UPDATE SANDBOX.RAW_FORESCOUT
set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2(FS_WINDOWS_APPLICATIONS_INSTALLED)
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''Version: Asset_ID'',FS_WINDOWS_APPLICATIONS_INSTALLED,1) > 0;
COMMIT;
/*
BEGIN TRANSACTION;
-- Clean FQDN
UPDATE SANDBOX.RAW_FORESCOUT
set FQDN = ARRAY_REMOVE(FQDN,:IRRESOLVABLE::variant)
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_CONTAINS(:IRRESOLVABLE::variant,FQDN);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean IPv6
UPDATE SANDBOX.RAW_FORESCOUT
set IPV6 = ARRAY_REMOVE(IPV6,:UNKNOWN::variant)
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_CONTAINS(:UNKNOWN::variant,IPV6);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean OS
UPDATE SANDBOX.RAW_FORESCOUT
set OS = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (OS = '''' or OS = :UNKNOWN or OS =:IRRESOLVABLE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Clean OS'');
*/
/*
BEGIN TRANSACTION;
-- Clean FS_LINUX_OPERATING_SYSTEM
UPDATE SANDBOX.RAW_FORESCOUT
set FS_LINUX_OPERATING_SYSTEM = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_LINUX_OPERATING_SYSTEM = '''' or FS_LINUX_OPERATING_SYSTEM = :UNKNOWN or FS_LINUX_OPERATING_SYSTEM =:IRRESOLVABLE);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean FS_VA_OS
UPDATE SANDBOX.RAW_FORESCOUT
set FS_VA_OS = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_VA_OS = '''' or FS_VA_OS = :UNKNOWN or FS_VA_OS =:IRRESOLVABLE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''FS_VA_OS'');
*/
BEGIN TRANSACTION;
-- Set OS
UPDATE SANDBOX.RAW_FORESCOUT
set OS = coalesce(OS,FS_VA_OS,FS_LINUX_OPERATING_SYSTEM)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Set OS'');
/*
BEGIN TRANSACTION;
-- Clean OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set OS_CPE = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (OS_CPE = '''' or OS_CPE = :UNKNOWN or OS_CPE =:IRRESOLVABLE or OS_CPE = :DEFAULT_CPE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Clean OS_CPE'');
*/
/*
BEGIN TRANSACTION;
-- Clean FS_VA_OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set FS_VA_OS_CPE = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_VA_OS_CPE = '''' or FS_VA_OS_CPE = :UNKNOWN or FS_VA_OS_CPE = :IRRESOLVABLE or FS_VA_OS_CPE = :DEFAULT_CPE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''FS_VA_OS_CPE'');
*/
BEGIN TRANSACTION;
-- Set OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set OS_CPE = coalesce(OS_CPE,FS_VA_OS_CPE)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;



CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_240311"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SANDBOX.SP_CRM_PULL_FORESCOUT'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
FORESCOUT varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousForescoutPull TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:FORESCOUT);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:FORESCOUT);

PreviousForescoutPull := (select PARMDATE FROM CORE.CONFIG where PARMNAME = ''PreviousForescoutPull'');
Msg := ''PreviousForescoutPull='' || :PreviousForescoutPull;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into SANDBOX.RAW_FORESCOUT (
APPLIANCE_IP,
ASSET_FUNCTION,
DNS_NAME,
GROUPS,
HWI_MOTHERBOARD,
HWI_PROCESSOR,
IPV4,
IPV6,
LABEL_LIST,
LINUX_ASSET_ID,
LINUX_FISMA_ID,
LINUX_HOSTNAME,
LINUX_OPERATING_SYSTEM,
LINUX_RUNNING_PROCESSES,
MAC_ADDRESS,
MOTHERBOARD_SN,
NETBIOS_DOMAIN,
NETBIOS_HOSTNAME,
OPERATING_SYSTEM,
OS_CPE,
REPORTDATE,
SENDER_INFO,
SENDER_INFO_DATE,
SNAPSHOT_ID,
VA_OS,
VA_OS_CPE,
WINDOWS_APPLICATIONS_INSTALLED
)
SELECT 
APPLIANCE_IP,
ASSET_FUNCTION,
DNS_NAME,
GROUPS,
HWI_MOTHERBOARD,
HWI_PROCESSOR,
IPV4,
IPV6,
LABEL_LIST,
LINUX_ASSET_ID,
LINUX_FISMA_ID,
LINUX_HOSTNAME,
LINUX_OPERATING_SYSTEM,
LINUX_RUNNING_PROCESSES,
MAC_ADDRESS,
MOTHERBOARD_SN,
NETBIOS_DOMAIN,
NETBIOS_HOSTNAME,
OPERATING_SYSTEM,
OS_CPE,
S3_FILE_TS as REPORTDATE,
SENDER_INFO,
(date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END
|| ''-'' || substring(SENDER_INFO,5,11)
)::datetime as SENDER_INFO_DATE,
:SNAPSHOT_ID,
VA_OS,
VA_OS_CPE,
WINDOWS_APPLICATIONS_INSTALLED
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull;

RECORD_COUNT := SQLROWCOUNT;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = ''PreviousForescoutPull'' and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_240320"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SANDBOX.SP_CRM_PULL_FORESCOUT'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
FORESCOUT varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousForescoutPull TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);
False boolean := 0;
True boolean := 1;
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:FORESCOUT);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:FORESCOUT);

PreviousForescoutPull := (select PARMDATE FROM CORE.CONFIG where PARMNAME = ''PreviousForescoutPull'');
Msg := ''PreviousForescoutPull='' || :PreviousForescoutPull;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into SANDBOX.RAW_FORESCOUT (
ASSET_ID_TATTOO,
AWS_ACCOUNTID,
AWS_DATACENTER_ID,
AWS_INSTANCE_ID,
AWS_PRIMARY_FISMA_ID_TATTOO,
AXONIUS_ADAPTER_LIST_LENGTH,
AXONIUS_ADAPTERS,
AXONIUS_ADAPTERS_UUID,
AXONIUS_INTERNAL_AXONIUS_ID,
BIGFIX_ASSET_ID,
BIGFIX_ASSET_ID_DETAILS,
BIGFIX_ASSET_ID_TATTOO,
BIGFIX_ASSET_ID_TATTOO_DETAILS,
BIGFIX_DATACENTER_ID,
BIGFIX_DATACENTER_ID_DETAILS,
BIGFIX_PRIMARY_FISMA_ID_TATTOO,
BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
BIOS_GUID,
CLOUD_ID,
CLOUD_PROVIDER,
COMPUTER_TYPE,
CONNECTION_LABEL,
DATA_ERROR_ARRAY,
DATA_WARNING_ARRAY,
DATACENTER_ID,
DATECOMPLETED,
DEVICE_MANUFACTURER,
DEVICE_TYPE,
DEVICEMODEL,
DOMAIN_PREFERRED,
DW_ASSET_ID,
ENVIRONMENT,
EVENTTIME,
FIRST_FETCH_TIME,
FISMA_UUID,
FORESCOUT_ASSET_ID_TATTOO,
FORESCOUT_ASSIGNED_LABELS,
FORESCOUT_DATACENTER_ID,
FORESCOUT_DATACENTER_ID_DETAILS,
FORESCOUT_PRIMARY_FISMA_ID,
FQDN,
FS_APPLIANCE_IP,
FS_GROUPS,
FS_HWI_MOTHERBOARD,
FS_HWI_PROCESSOR,
FS_LABEL_LIST,
FS_LINUX_ASSET_ID,
FS_LINUX_FISMA_ID,
FS_LINUX_HOSTNAME,
FS_LINUX_OPERATING_SYSTEM,
FS_LINUX_RUNNING_PROCESSES,
FS_NETBIOS_DOMAIN,
FS_SENDER_INFO,
FS_SENDER_INFO_DATE,
FS_VA_OS,
FS_VA_OS_CPE,
FS_WINDOWS_APPLICATIONS_INSTALLED,
HOSTNAME,
INSERT_DATE,
INSTANCESTATUS,
IPV4,
IPV6,
IS_FS_MANAGED,
IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
IS_WINDOWS_SERVER_PREFERRED,
LABELS,
LAST_CONFIRMED_TIME,
LAST_USED_USERS_COMPANY_ASSOCIATION,
LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
MACADDRESS,
MOTHERBOARD,
NETBIOSNAME,
OS,
OS_BUILD_PREFERRED,
OS_CPE,
OS_DOTTED,
OS_MAJOR,
OS_MINOR,
OS_TYPE_DISTRIBUTION_PREFERRED,
OS_TYPE_PREFERRED,
OS_VERSION,
PRIMARY_FISMA_ID_DERIVED,
PRIMARY_FISMA_ID_TATTOO,
REPORTDATE,
REPOSITORY_DESCRIPTION_DETAILS,
ROWDISPOSITION,
SITECODE_PREFERRED,
SNAPSHOT_ID,
SOURCE_TOOL,
SUBNETS_PREFERRED,
SYSTEM_ACRONYM,
SYSTEM_ID,
TENABLE_ASSET_ID_TATTOO,
TENABLE_ASSET_TAGS,
TENABLE_DATACENTER_ID,
TENABLE_PRIMARY_FISMA_ID_TATTOO,
TIME_ZONE,
VIRTUAL_HOST,
WINDOWS_PATCH_VERSION
)
SELECT 
-- FILE_NAME and RAW fields in view are not used
NULL -- ASSET_ID_TATTOO
,NULL -- AWS_ACCOUNTID
,NULL -- AWS_DATACENTER_ID
,NULL -- AWS_INSTANCE_ID
,NULL -- AWS_PRIMARY_FISMA_ID_TATTOO
,NULL -- AXONIUS_ADAPTER_LIST_LENGTH
,NULL -- AXONIUS_ADAPTERS
,NULL -- AXONIUS_ADAPTERS_UUID
,NULL -- AXONIUS_INTERNAL_AXONIUS_ID
,NULL -- BIGFIX_ASSET_ID
,NULL -- BIGFIX_ASSET_ID_DETAILS
,NULL -- BIGFIX_ASSET_ID_TATTOO
,NULL -- BIGFIX_ASSET_ID_TATTOO_DETAILS
,NULL -- BIGFIX_DATACENTER_ID
,NULL -- BIGFIX_DATACENTER_ID_DETAILS
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS
,NULL -- BIOS_GUID
,NULL -- CLOUD_ID
,NULL -- CLOUD_PROVIDER
,NULL -- COMPUTER_TYPE
,NULL -- CONNECTION_LABEL
,NULL -- DATA_ERROR_ARRAY
,NULL -- DATA_WARNING_ARRAY
,NULL -- DATACENTER_ID
,NULL -- DATECOMPLETED
,NULL -- DEVICE_MANUFACTURER
,ASSET_FUNCTION -- DEVICE_TYPE
,NULL -- DEVICEMODEL
,NULL -- DOMAIN_PREFERRED
,NULL -- DW_ASSET_ID
,NULL -- ENVIRONMENT
,NULL -- EVENTTIME
,NULL -- FIRST_FETCH_TIME
,NULL -- FISMA_UUID
,NULL -- FORESCOUT_ASSET_ID_TATTOO
,NULL -- FORESCOUT_ASSIGNED_LABELS
,NULL -- FORESCOUT_DATACENTER_ID
,NULL -- FORESCOUT_DATACENTER_ID_DETAILS
,NULL -- FORESCOUT_PRIMARY_FISMA_ID
,STRTOK_TO_ARRAY(DNS_NAME,'','') -- FQDN
,APPLIANCE_IP -- FS_APPLIANCE_IP
,GROUPS -- FS_GROUPS
,HWI_MOTHERBOARD -- FS_HWI_MOTHERBOARD
,HWI_PROCESSOR -- FS_HWI_PROCESSOR
,LABEL_LIST -- FS_LABEL_LIST
,LINUX_ASSET_ID -- FS_LINUX_ASSET_ID
,LINUX_FISMA_ID -- FS_LINUX_FISMA_ID
,LINUX_HOSTNAME -- FS_LINUX_HOSTNAME
,LINUX_OPERATING_SYSTEM -- FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES -- FS_LINUX_RUNNING_PROCESSES
,NETBIOS_DOMAIN -- FS_NETBIOS_DOMAIN
,SENDER_INFO -- FS_SENDER_INFO
,NULL -- FS_SENDER_INFO_DATE
,VA_OS -- FS_VA_OS
,VA_OS_CPE -- FS_VA_OS_CPE
,WINDOWS_APPLICATIONS_INSTALLED -- FS_WINDOWS_APPLICATIONS_INSTALLED
,NULL -- HOSTNAME
,CURRENT_TIMESTAMP() -- INSERT_DATE
,NULL -- INSTANCESTATUS
,STRTOK_TO_ARRAY(IPV4,'','') -- IPV4
,STRTOK_TO_ARRAY(IPV6,'','') -- IPV6
,NULL -- IS_FS_MANAGED
,NULL -- IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,NULL -- IS_WINDOWS_SERVER_PREFERRED
,NULL -- LABELS
,NULL -- LAST_CONFIRMED_TIME
,NULL -- LAST_USED_USERS_COMPANY_ASSOCIATION
,NULL -- LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,STRTOK_TO_ARRAY(MAC_ADDRESS,'','') -- MACADDRESS
,MOTHERBOARD_SN -- MOTHERBOARD
,STRTOK_TO_ARRAY(NETBIOS_HOSTNAME,'','') -- NETBIOSNAME
,OPERATING_SYSTEM -- OS
,NULL -- OS_BUILD_PREFERRED
,OS_CPE -- OS_CPE
,NULL -- OS_DOTTED
,NULL -- OS_MAJOR
,NULL -- OS_MINOR
,NULL -- OS_TYPE_DISTRIBUTION_PREFERRED
,NULL -- OS_TYPE_PREFERRED
,NULL -- OS_VERSION
,NULL -- PRIMARY_FISMA_ID_DERIVED
,NULL -- PRIMARY_FISMA_ID_TATTOO
,S3_FILE_TS -- REPORTDATE
,NULL -- REPOSITORY_DESCRIPTION_DETAILS
,NULL -- ROWDISPOSITION
,NULL -- SITECODE_PREFERRED
,:SNAPSHOT_ID -- SNAPSHOT_ID
,''Forescout'' -- SOURCE_TOOL
,NULL -- SUBNETS_PREFERRED
,NULL -- SYSTEM_ACRONYM
,NULL -- SYSTEM_ID
,NULL -- TENABLE_ASSET_ID_TATTOO
,NULL -- TENABLE_ASSET_TAGS
,NULL -- TENABLE_DATACENTER_ID
,NULL -- TENABLE_PRIMARY_FISMA_ID_TATTOO
,NULL -- TIME_ZONE
,NULL -- VIRTUAL_HOST
,NULL -- WINDOWS_PATCH_VERSION
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = ''PreviousForescoutPull'' and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;

UPDATE SANDBOX.RAW_FORESCOUT
set FS_SENDER_INFO_DATE = (date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(FS_SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END
|| ''-'' || substring(FS_SENDER_INFO,5,11)
)::datetime
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
--
-- Initialize
--
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionViable
,DATACENTER_ID = NULL
,SYSTEM_ID = NULL
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :False
,DATA_ERROR_ARRAY = ARRAY_CONSTRUCT()
,DATA_WARNING_ARRAY = ARRAY_CONSTRUCT()
FROM SANDBOX.RAW_FORESCOUT r
where r.RAW_HWAM_ID = SANDBOX.RAW_FORESCOUT.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
-- Parse FS_GROUPS field to obtain DATACENTER_ID

/*
UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = split_part(substring(FS_GROUPS,(charindex(''DC-'',FS_GROUPS,1) + 3),100),'','',1)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;
*/

UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(FS_GROUPS)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID is Null or Empty
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID does not exist
UPDATE SANDBOX.RAW_FORESCOUT upd
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;

COMMIT;

/*****
-- Validate SYSTEM_ACRONYM as an FYI. For the present time we also check to see if the acronym is a CommonName (not found in CFACTS)
UPDATE SANDBOX.RAW_FORESCOUT upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ACRONYM does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ACRONYM IS NOT NULL and (s.SYSTEM_ID IS NULL and c.SYSTEM_ID IS NULL);
***********/

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_240322"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SANDBOX.SP_CRM_PULL_FORESCOUT'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
FORESCOUT varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousForescoutPull TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);
False boolean := 0;
IRRESOLVABLE varchar := ''Irresolvable'';
True boolean := 1;
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

-- 24031 TEMPORARY CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:FORESCOUT);
-- 24031 TEMPORARY SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:FORESCOUT);
SNAPSHOT_ID := 1587;

PreviousForescoutPull := (select PARMDATE FROM CORE.CONFIG where PARMNAME = ''PreviousForescoutPull'');
Msg := ''PreviousForescoutPull='' || :PreviousForescoutPull;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

/*************************************************

BEGIN TRANSACTION;

insert into SANDBOX.RAW_FORESCOUT (
ASSET_ID_TATTOO,
AWS_ACCOUNTID,
AWS_DATACENTER_ID,
AWS_INSTANCE_ID,
AWS_PRIMARY_FISMA_ID_TATTOO,
AXONIUS_ADAPTER_LIST_LENGTH,
AXONIUS_ADAPTERS,
AXONIUS_ADAPTERS_UUID,
AXONIUS_INTERNAL_AXONIUS_ID,
BIGFIX_ASSET_ID,
BIGFIX_ASSET_ID_DETAILS,
BIGFIX_ASSET_ID_TATTOO,
BIGFIX_ASSET_ID_TATTOO_DETAILS,
BIGFIX_DATACENTER_ID,
BIGFIX_DATACENTER_ID_DETAILS,
BIGFIX_PRIMARY_FISMA_ID_TATTOO,
BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
BIOS_GUID,
CLOUD_ID,
CLOUD_PROVIDER,
COMPUTER_TYPE,
CONNECTION_LABEL,
DATA_ERROR_ARRAY,
DATA_WARNING_ARRAY,
DATACENTER_ID,
DATECOMPLETED,
DEVICE_MANUFACTURER,
DEVICE_TYPE,
DEVICEMODEL,
DOMAIN_PREFERRED,
DW_ASSET_ID,
ENVIRONMENT,
EVENTTIME,
FIRST_FETCH_TIME,
FISMA_UUID,
FORESCOUT_ASSET_ID_TATTOO,
FORESCOUT_ASSIGNED_LABELS,
FORESCOUT_DATACENTER_ID,
FORESCOUT_DATACENTER_ID_DETAILS,
FORESCOUT_PRIMARY_FISMA_ID,
FQDN,
FS_APPLIANCE_IP,
FS_GROUPS,
FS_HWI_MOTHERBOARD,
FS_HWI_PROCESSOR,
FS_LABEL_LIST,
FS_LINUX_ASSET_ID,
FS_LINUX_FISMA_ID,
FS_LINUX_HOSTNAME,
FS_LINUX_OPERATING_SYSTEM,
FS_LINUX_RUNNING_PROCESSES,
FS_NETBIOS_DOMAIN,
FS_SENDER_INFO,
FS_SENDER_INFO_DATE,
FS_VA_OS,
FS_VA_OS_CPE,
FS_WINDOWS_APPLICATIONS_INSTALLED,
HOSTNAME,
INSERT_DATE,
INSTANCESTATUS,
IPV4,
IPV6,
IS_FS_MANAGED,
IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
IS_WINDOWS_SERVER_PREFERRED,
LABELS,
LAST_CONFIRMED_TIME,
LAST_USED_USERS_COMPANY_ASSOCIATION,
LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
MACADDRESS,
MOTHERBOARD,
NETBIOSNAME,
OS,
OS_BUILD_PREFERRED,
OS_CPE,
OS_DOTTED,
OS_MAJOR,
OS_MINOR,
OS_TYPE_DISTRIBUTION_PREFERRED,
OS_TYPE_PREFERRED,
OS_VERSION,
PRIMARY_FISMA_ID_DERIVED,
PRIMARY_FISMA_ID_TATTOO,
REPORTDATE,
REPOSITORY_DESCRIPTION_DETAILS,
ROWDISPOSITION,
SITECODE_PREFERRED,
SNAPSHOT_ID,
SOURCE_TOOL,
SUBNETS_PREFERRED,
SYSTEM_ACRONYM,
SYSTEM_ID,
TENABLE_ASSET_ID_TATTOO,
TENABLE_ASSET_TAGS,
TENABLE_DATACENTER_ID,
TENABLE_PRIMARY_FISMA_ID_TATTOO,
TIME_ZONE,
VIRTUAL_HOST,
WINDOWS_PATCH_VERSION
)
SELECT 
-- FILE_NAME and RAW fields in view are not used
NULL -- ASSET_ID_TATTOO
,NULL -- AWS_ACCOUNTID
,NULL -- AWS_DATACENTER_ID
,NULL -- AWS_INSTANCE_ID
,NULL -- AWS_PRIMARY_FISMA_ID_TATTOO
,NULL -- AXONIUS_ADAPTER_LIST_LENGTH
,NULL -- AXONIUS_ADAPTERS
,NULL -- AXONIUS_ADAPTERS_UUID
,NULL -- AXONIUS_INTERNAL_AXONIUS_ID
,NULL -- BIGFIX_ASSET_ID
,NULL -- BIGFIX_ASSET_ID_DETAILS
,NULL -- BIGFIX_ASSET_ID_TATTOO
,NULL -- BIGFIX_ASSET_ID_TATTOO_DETAILS
,NULL -- BIGFIX_DATACENTER_ID
,NULL -- BIGFIX_DATACENTER_ID_DETAILS
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS
,NULL -- BIOS_GUID
,NULL -- CLOUD_ID
,NULL -- CLOUD_PROVIDER
,NULL -- COMPUTER_TYPE
,NULL -- CONNECTION_LABEL
,NULL -- DATA_ERROR_ARRAY
,NULL -- DATA_WARNING_ARRAY
,NULL -- DATACENTER_ID
,NULL -- DATECOMPLETED
,NULL -- DEVICE_MANUFACTURER
,ASSET_FUNCTION -- DEVICE_TYPE
,NULL -- DEVICEMODEL
,NULL -- DOMAIN_PREFERRED
,NULL -- DW_ASSET_ID
,NULL -- ENVIRONMENT
,NULL -- EVENTTIME
,NULL -- FIRST_FETCH_TIME
,NULL -- FISMA_UUID
,NULL -- FORESCOUT_ASSET_ID_TATTOO
,NULL -- FORESCOUT_ASSIGNED_LABELS
,NULL -- FORESCOUT_DATACENTER_ID
,NULL -- FORESCOUT_DATACENTER_ID_DETAILS
,NULL -- FORESCOUT_PRIMARY_FISMA_ID
,STRTOK_TO_ARRAY(NULLIF(DNS_NAME,''''),'','') -- FQDN
,APPLIANCE_IP -- FS_APPLIANCE_IP
,GROUPS -- FS_GROUPS
,HWI_MOTHERBOARD -- FS_HWI_MOTHERBOARD
,HWI_PROCESSOR -- FS_HWI_PROCESSOR
,LABEL_LIST -- FS_LABEL_LIST
,LINUX_ASSET_ID -- FS_LINUX_ASSET_ID
,LINUX_FISMA_ID -- FS_LINUX_FISMA_ID
,LINUX_HOSTNAME -- FS_LINUX_HOSTNAME
,LINUX_OPERATING_SYSTEM -- FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES -- FS_LINUX_RUNNING_PROCESSES
,NETBIOS_DOMAIN -- FS_NETBIOS_DOMAIN
,SENDER_INFO -- FS_SENDER_INFO
,NULL -- FS_SENDER_INFO_DATE
,VA_OS -- FS_VA_OS
,VA_OS_CPE -- FS_VA_OS_CPE
,WINDOWS_APPLICATIONS_INSTALLED -- FS_WINDOWS_APPLICATIONS_INSTALLED
,NULL -- HOSTNAME
,CURRENT_TIMESTAMP() -- INSERT_DATE
,NULL -- INSTANCESTATUS
,STRTOK_TO_ARRAY(IPV4,'','') -- IPV4
,STRTOK_TO_ARRAY(IPV6,'','') -- IPV6
,NULL -- IS_FS_MANAGED
,NULL -- IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,NULL -- IS_WINDOWS_SERVER_PREFERRED
,NULL -- LABELS
,NULL -- LAST_CONFIRMED_TIME
,NULL -- LAST_USED_USERS_COMPANY_ASSOCIATION
,NULL -- LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,STRTOK_TO_ARRAY(MAC_ADDRESS,'','') -- MACADDRESS
,MOTHERBOARD_SN -- MOTHERBOARD
,STRTOK_TO_ARRAY(NETBIOS_HOSTNAME,'','') -- NETBIOSNAME
,OPERATING_SYSTEM -- OS
,NULL -- OS_BUILD_PREFERRED
,OS_CPE -- OS_CPE
,NULL -- OS_DOTTED
,NULL -- OS_MAJOR
,NULL -- OS_MINOR
,NULL -- OS_TYPE_DISTRIBUTION_PREFERRED
,NULL -- OS_TYPE_PREFERRED
,NULL -- OS_VERSION
,NULL -- PRIMARY_FISMA_ID_DERIVED
,NULL -- PRIMARY_FISMA_ID_TATTOO
,S3_FILE_TS -- REPORTDATE
,NULL -- REPOSITORY_DESCRIPTION_DETAILS
,NULL -- ROWDISPOSITION
,NULL -- SITECODE_PREFERRED
,:SNAPSHOT_ID -- SNAPSHOT_ID
,''Forescout'' -- SOURCE_TOOL
,NULL -- SUBNETS_PREFERRED
,NULL -- SYSTEM_ACRONYM
,NULL -- SYSTEM_ID
,NULL -- TENABLE_ASSET_ID_TATTOO
,NULL -- TENABLE_ASSET_TAGS
,NULL -- TENABLE_DATACENTER_ID
,NULL -- TENABLE_PRIMARY_FISMA_ID_TATTOO
,NULL -- TIME_ZONE
,NULL -- VIRTUAL_HOST
,NULL -- WINDOWS_PATCH_VERSION
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = ''PreviousForescoutPull'' and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

*************************************************/



BEGIN TRANSACTION;

UPDATE SANDBOX.RAW_FORESCOUT
set FS_SENDER_INFO_DATE = (date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(FS_SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END
|| ''-'' || substring(FS_SENDER_INFO,5,11)
)::datetime
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
--
-- Initialize
--
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionViable
,DATACENTER_ID = NULL
,SYSTEM_ID = NULL
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :False
,DATA_ERROR_ARRAY = ARRAY_CONSTRUCT()
,DATA_WARNING_ARRAY = ARRAY_CONSTRUCT()
FROM SANDBOX.RAW_FORESCOUT r
where r.RAW_HWAM_ID = SANDBOX.RAW_FORESCOUT.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
-- Parse FS_GROUPS field to obtain DATACENTER_ID

/*
UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = split_part(substring(FS_GROUPS,(charindex(''DC-'',FS_GROUPS,1) + 3),100),'','',1)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;
*/

UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(FS_GROUPS)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID is Null or Empty
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID does not exist
UPDATE SANDBOX.RAW_FORESCOUT upd
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;

COMMIT;

/*****
-- Validate SYSTEM_ACRONYM as an FYI. For the present time we also check to see if the acronym is a CommonName (not found in CFACTS)
UPDATE SANDBOX.RAW_FORESCOUT upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ACRONYM does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ACRONYM IS NOT NULL and (s.SYSTEM_ID IS NULL and c.SYSTEM_ID IS NULL);
***********/

BEGIN TRANSACTION;
-- Clean FS_WINDOWS_APPLICATIONS_INSTALLED
UPDATE SANDBOX.RAW_FORESCOUT
set FS_WINDOWS_APPLICATIONS_INSTALLED = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and FS_WINDOWS_APPLICATIONS_INSTALLED = :IRRESOLVABLE;
COMMIT;

BEGIN TRANSACTION;
-- Extract ASSET_ID_TATTOO
UPDATE SANDBOX.RAW_FORESCOUT
set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2(FS_WINDOWS_APPLICATIONS_INSTALLED)
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''Version: Asset_ID'',FS_WINDOWS_APPLICATIONS_INSTALLED,1) > 0;
COMMIT;

BEGIN TRANSACTION;
-- Clean FQDN
UPDATE SANDBOX.RAW_FORESCOUT
set FQDN = ARRAY_REMOVE(FQDN,:IRRESOLVABLE::variant)
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_CONTAINS(:IRRESOLVABLE::variant,FQDN);
COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_FORESCOUT_240325"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull FORESCOUT HWAM and SWAM data into BUS_CYBER_RISK_MANAGEMENT'
EXECUTE AS OWNER
AS '
--
-- 
--
declare
Appl varchar := ''SANDBOX.SP_CRM_PULL_FORESCOUT'';
ExceptionMsg varchar;
Msg varchar;
StartOfProgram datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
FORESCOUT varchar := ''FORESCOUT'';
SNAPSHOT_ID number;
RECORD_COUNT number;
PreviousForescoutPull TIMESTAMP_LTZ(9);
MIN_DATE TIMESTAMP_LTZ(9);
MAX_DATE TIMESTAMP_LTZ(9);
False boolean := 0;
DEFAULT_CPE varchar := ''default_cpe'';
IRRESOLVABLE varchar := ''Irresolvable'';
UNKNOWN varchar := ''Unknown'';
True boolean := 1;
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;

begin
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

CALL CORE.SP_CRM_GENERATE_SNAPSHOT_ID(:FORESCOUT);
SNAPSHOT_ID := CORE.FN_CRM_GET_SNAPSHOT_ID(:FORESCOUT);
--SNAPSHOT_ID := 1587;

PreviousForescoutPull := (select PARMDATE FROM CORE.CONFIG where PARMNAME = ''PreviousForescoutPull'');
Msg := ''PreviousForescoutPull='' || :PreviousForescoutPull;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

BEGIN TRANSACTION;

insert into SANDBOX.RAW_FORESCOUT (
ASSET_ID_TATTOO,
AWS_ACCOUNTID,
AWS_DATACENTER_ID,
AWS_INSTANCE_ID,
AWS_PRIMARY_FISMA_ID_TATTOO,
AXONIUS_ADAPTER_LIST_LENGTH,
AXONIUS_ADAPTERS,
AXONIUS_ADAPTERS_UUID,
AXONIUS_INTERNAL_AXONIUS_ID,
BIGFIX_ASSET_ID,
BIGFIX_ASSET_ID_DETAILS,
BIGFIX_ASSET_ID_TATTOO,
BIGFIX_ASSET_ID_TATTOO_DETAILS,
BIGFIX_DATACENTER_ID,
BIGFIX_DATACENTER_ID_DETAILS,
BIGFIX_PRIMARY_FISMA_ID_TATTOO,
BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS,
BIOS_GUID,
CLOUD_ID,
CLOUD_PROVIDER,
COMPUTER_TYPE,
CONNECTION_LABEL,
DATA_ERROR_ARRAY,
DATA_WARNING_ARRAY,
DATACENTER_ID,
DATECOMPLETED,
DEVICE_MANUFACTURER,
DEVICE_TYPE,
DEVICEMODEL,
DOMAIN_PREFERRED,
DW_ASSET_ID,
ENVIRONMENT,
EVENTTIME,
FIRST_FETCH_TIME,
FISMA_UUID,
FORESCOUT_ASSET_ID_TATTOO,
FORESCOUT_ASSIGNED_LABELS,
FORESCOUT_DATACENTER_ID,
FORESCOUT_DATACENTER_ID_DETAILS,
FORESCOUT_PRIMARY_FISMA_ID,
FQDN,
FS_APPLIANCE_IP,
FS_GROUPS,
FS_HWI_MOTHERBOARD,
FS_HWI_PROCESSOR,
FS_LABEL_LIST,
FS_LINUX_ASSET_ID,
FS_LINUX_FISMA_ID,
FS_LINUX_HOSTNAME,
FS_LINUX_OPERATING_SYSTEM,
FS_LINUX_RUNNING_PROCESSES,
FS_NETBIOS_DOMAIN,
FS_SENDER_INFO,
FS_SENDER_INFO_DATE,
FS_VA_OS,
FS_VA_OS_CPE,
FS_WINDOWS_APPLICATIONS_INSTALLED,
HOSTNAME,
INSERT_DATE,
INSTANCESTATUS,
IPV4,
IPV6,
IS_FS_MANAGED,
IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC,
IS_WINDOWS_SERVER_PREFERRED,
LABELS,
LAST_CONFIRMED_TIME,
LAST_USED_USERS_COMPANY_ASSOCIATION,
LAST_USED_USERS_DEPARTMENTS_ASSOCIATION,
MACADDRESS,
MOTHERBOARD,
NETBIOSNAME,
OS,
OS_BUILD_PREFERRED,
OS_CPE,
OS_DOTTED,
OS_MAJOR,
OS_MINOR,
OS_TYPE_DISTRIBUTION_PREFERRED,
OS_TYPE_PREFERRED,
OS_VERSION,
PRIMARY_FISMA_ID_DERIVED,
PRIMARY_FISMA_ID_TATTOO,
REPORTDATE,
REPOSITORY_DESCRIPTION_DETAILS,
ROWDISPOSITION,
SITECODE_PREFERRED,
SNAPSHOT_ID,
SOURCE_TOOL,
SUBNETS_PREFERRED,
SYSTEM_ACRONYM,
SYSTEM_ID,
TENABLE_ASSET_ID_TATTOO,
TENABLE_ASSET_TAGS,
TENABLE_DATACENTER_ID,
TENABLE_PRIMARY_FISMA_ID_TATTOO,
TIME_ZONE,
VIRTUAL_HOST,
WINDOWS_PATCH_VERSION
)
SELECT 
-- FILE_NAME and RAW fields in view are not used
NULL -- ASSET_ID_TATTOO
,NULL -- AWS_ACCOUNTID
,NULL -- AWS_DATACENTER_ID
,NULL -- AWS_INSTANCE_ID
,NULL -- AWS_PRIMARY_FISMA_ID_TATTOO
,NULL -- AXONIUS_ADAPTER_LIST_LENGTH
,NULL -- AXONIUS_ADAPTERS
,NULL -- AXONIUS_ADAPTERS_UUID
,NULL -- AXONIUS_INTERNAL_AXONIUS_ID
,NULL -- BIGFIX_ASSET_ID
,NULL -- BIGFIX_ASSET_ID_DETAILS
,NULL -- BIGFIX_ASSET_ID_TATTOO
,NULL -- BIGFIX_ASSET_ID_TATTOO_DETAILS
,NULL -- BIGFIX_DATACENTER_ID
,NULL -- BIGFIX_DATACENTER_ID_DETAILS
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO
,NULL -- BIGFIX_PRIMARY_FISMA_ID_TATTOO_DETAILS
,NULL -- BIOS_GUID
,NULL -- CLOUD_ID
,NULL -- CLOUD_PROVIDER
,NULL -- COMPUTER_TYPE
,NULL -- CONNECTION_LABEL
,NULL -- DATA_ERROR_ARRAY
,NULL -- DATA_WARNING_ARRAY
,NULL -- DATACENTER_ID
,NULL -- DATECOMPLETED
,NULL -- DEVICE_MANUFACTURER
,ASSET_FUNCTION -- DEVICE_TYPE
,NULL -- DEVICEMODEL
,NULL -- DOMAIN_PREFERRED
,NULL -- DW_ASSET_ID
,NULL -- ENVIRONMENT
,NULL -- EVENTTIME
,NULL -- FIRST_FETCH_TIME
,NULL -- FISMA_UUID
,NULL -- FORESCOUT_ASSET_ID_TATTOO
,NULL -- FORESCOUT_ASSIGNED_LABELS
,NULL -- FORESCOUT_DATACENTER_ID
,NULL -- FORESCOUT_DATACENTER_ID_DETAILS
,NULL -- FORESCOUT_PRIMARY_FISMA_ID
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(DNS_NAME),'','') as FQDN
,APPLIANCE_IP -- FS_APPLIANCE_IP
,GROUPS -- FS_GROUPS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(HWI_MOTHERBOARD) as FS_HWI_MOTHERBOARD
,HWI_PROCESSOR -- FS_HWI_PROCESSOR
,LABEL_LIST -- FS_LABEL_LIST
,LINUX_ASSET_ID -- FS_LINUX_ASSET_ID
,LINUX_FISMA_ID -- FS_LINUX_FISMA_ID
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_HOSTNAME) as FS_LINUX_HOSTNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(LINUX_OPERATING_SYSTEM) as FS_LINUX_OPERATING_SYSTEM
,LINUX_RUNNING_PROCESSES -- FS_LINUX_RUNNING_PROCESSES
,NETBIOS_DOMAIN -- FS_NETBIOS_DOMAIN
,SENDER_INFO -- FS_SENDER_INFO
,NULL -- FS_SENDER_INFO_DATE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS) as FS_VA_OS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(VA_OS_CPE) as FS_VA_OS_CPE
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(WINDOWS_APPLICATIONS_INSTALLED) as FS_WINDOWS_APPLICATIONS_INSTALLED
,NULL -- HOSTNAME
,CURRENT_TIMESTAMP() -- INSERT_DATE
,NULL -- INSTANCESTATUS
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV4),'','') as IPV4
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(IPV6),'','') as IPV6
,NULL -- IS_FS_MANAGED
,NULL -- IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC
,NULL -- IS_WINDOWS_SERVER_PREFERRED
,NULL -- LABELS
,NULL -- LAST_CONFIRMED_TIME
,NULL -- LAST_USED_USERS_COMPANY_ASSOCIATION
,NULL -- LAST_USED_USERS_DEPARTMENTS_ASSOCIATION
,STRTOK_TO_ARRAY(MAC_ADDRESS,'','') -- MACADDRESS
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(MOTHERBOARD_SN) as MOTHERBOARD
,STRTOK_TO_ARRAY(CORE.FN_CRM_CLEAN_FORESCOUT_STRING(NETBIOS_HOSTNAME),'','') as NETBIOSNAME
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OPERATING_SYSTEM) as OS
,NULL -- OS_BUILD_PREFERRED
,CORE.FN_CRM_CLEAN_FORESCOUT_STRING(OS_CPE) as OS_CPE
,NULL -- OS_DOTTED
,NULL -- OS_MAJOR
,NULL -- OS_MINOR
,NULL -- OS_TYPE_DISTRIBUTION_PREFERRED
,NULL -- OS_TYPE_PREFERRED
,NULL -- OS_VERSION
,NULL -- PRIMARY_FISMA_ID_DERIVED
,NULL -- PRIMARY_FISMA_ID_TATTOO
,S3_FILE_TS -- REPORTDATE
,NULL -- REPOSITORY_DESCRIPTION_DETAILS
,NULL -- ROWDISPOSITION
,NULL -- SITECODE_PREFERRED
,:SNAPSHOT_ID -- SNAPSHOT_ID
,''Forescout'' -- SOURCE_TOOL
,NULL -- SUBNETS_PREFERRED
,NULL -- SYSTEM_ACRONYM
,NULL -- SYSTEM_ID
,NULL -- TENABLE_ASSET_ID_TATTOO
,NULL -- TENABLE_ASSET_TAGS
,NULL -- TENABLE_DATACENTER_ID
,NULL -- TENABLE_PRIMARY_FISMA_ID_TATTOO
,NULL -- TIME_ZONE
,NULL -- VIRTUAL_HOST
,NULL -- WINDOWS_PATCH_VERSION
FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull;

RECORD_COUNT := SQLROWCOUNT;

IF (:RECORD_COUNT = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no HWAM data for this snapshot'';
	CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;

MIN_DATE := (select MIN(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);
MAX_DATE := (select MAX(S3_FILE_TS) FROM APP_FORESCOUT.SHARED.SEC_VW_SDL_FORESCOUT_ASSETS WHERE S3_FILE_TS > :PreviousForescoutPull);

If (RECORD_COUNT > 0) THEN
    BEGIN
    update CORE.CONFIG
    set PARMDATE = :MAX_DATE
    where PARMNAME = ''PreviousForescoutPull'' and :MAX_DATE IS NOT NULL;
    END;
End if;

UPDATE CORE.SNAPSHOT_IDS
set MIN_DATE = :MIN_DATE
,MAX_DATE = :MAX_DATE
,RECORD_COUNT = coalesce(:RECORD_COUNT,0)
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;


CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''START'');

BEGIN TRANSACTION;

UPDATE SANDBOX.RAW_FORESCOUT
set FS_SENDER_INFO_DATE = (date_part(year,current_date())::varchar || ''-''
|| case UPPER(substring(FS_SENDER_INFO,1,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09''
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
END
|| ''-'' || substring(FS_SENDER_INFO,5,11)
)::datetime
where SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
--
-- Initialize
--
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionViable
,DATACENTER_ID = NULL
,SYSTEM_ID = NULL
,IS_PRIMARY_FISMA_ID_DEFAULTED_TO_DC = :False
,DATA_ERROR_ARRAY = ARRAY_CONSTRUCT()
,DATA_WARNING_ARRAY = ARRAY_CONSTRUCT()
FROM SANDBOX.RAW_FORESCOUT r
where r.RAW_HWAM_ID = SANDBOX.RAW_FORESCOUT.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID;

COMMIT;

BEGIN TRANSACTION;
-- Parse FS_GROUPS field to obtain DATACENTER_ID

/*
UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = split_part(substring(FS_GROUPS,(charindex(''DC-'',FS_GROUPS,1) + 3),100),'','',1)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;
*/

UPDATE SANDBOX.RAW_FORESCOUT
set DATACENTER_ID = CORE.FN_CRM_PARSE_FORESCOUT_DATACENTER_ID(FS_GROUPS)
where SNAPSHOT_ID = :SNAPSHOT_ID and charindex(''DC-'',FS_GROUPS,1) > 0;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID is Null or Empty
UPDATE SANDBOX.RAW_FORESCOUT
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(DATA_ERROR_ARRAY,''Empty DATACENTER_ID'')
where SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(DATACENTER_ID,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;
-- DATACENTER_ID does not exist
UPDATE SANDBOX.RAW_FORESCOUT upd
set ROWDISPOSITION = :RowDispositionError
,DATA_ERROR_ARRAY = ARRAY_APPEND(r.DATA_ERROR_ARRAY,''DATACENTER_ID does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS dc on upper(dc.system_id) = upper(r.DATACENTER_ID)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL;

COMMIT;

/*****
-- Validate SYSTEM_ACRONYM as an FYI. For the present time we also check to see if the acronym is a CommonName (not found in CFACTS)
UPDATE SANDBOX.RAW_FORESCOUT upd
set DATA_WARNING_ARRAY = ARRAY_APPEND(r.DATA_WARNING_ARRAY,''SYSTEM_ACRONYM does not exist'')
FROM SANDBOX.RAW_FORESCOUT r
LEFT OUTER JOIN CORE.SYSTEMS s on upper(s.acronym) = upper(r.SYSTEM_ACRONYM)
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on upper(c.COMMONNAME) = upper(r.system_acronym)
where r.RAW_HWAM_ID = upd.RAW_HWAM_ID and r.SNAPSHOT_ID = :SNAPSHOT_ID and r.SYSTEM_ACRONYM IS NOT NULL and (s.SYSTEM_ID IS NULL and c.SYSTEM_ID IS NULL);
***********/
/*
BEGIN TRANSACTION;
-- Clean FS_WINDOWS_APPLICATIONS_INSTALLED
UPDATE SANDBOX.RAW_FORESCOUT
set FS_WINDOWS_APPLICATIONS_INSTALLED = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and FS_WINDOWS_APPLICATIONS_INSTALLED = :IRRESOLVABLE;
COMMIT;
*/

BEGIN TRANSACTION;
-- Extract ASSET_ID_TATTOO
UPDATE SANDBOX.RAW_FORESCOUT
set ASSET_ID_TATTOO = CORE.FN_CRM_PARSE_FORESCOUT_ASSET_ID_V2(FS_WINDOWS_APPLICATIONS_INSTALLED)
where SNAPSHOT_ID = :SNAPSHOT_ID and POSITION(''Version: Asset_ID'',FS_WINDOWS_APPLICATIONS_INSTALLED,1) > 0;
COMMIT;
/*
BEGIN TRANSACTION;
-- Clean FQDN
UPDATE SANDBOX.RAW_FORESCOUT
set FQDN = ARRAY_REMOVE(FQDN,:IRRESOLVABLE::variant)
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_CONTAINS(:IRRESOLVABLE::variant,FQDN);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean IPv6
UPDATE SANDBOX.RAW_FORESCOUT
set IPV6 = ARRAY_REMOVE(IPV6,:UNKNOWN::variant)
where SNAPSHOT_ID = :SNAPSHOT_ID and ARRAY_CONTAINS(:UNKNOWN::variant,IPV6);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean OS
UPDATE SANDBOX.RAW_FORESCOUT
set OS = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (OS = '''' or OS = :UNKNOWN or OS =:IRRESOLVABLE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Clean OS'');
*/
/*
BEGIN TRANSACTION;
-- Clean FS_LINUX_OPERATING_SYSTEM
UPDATE SANDBOX.RAW_FORESCOUT
set FS_LINUX_OPERATING_SYSTEM = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_LINUX_OPERATING_SYSTEM = '''' or FS_LINUX_OPERATING_SYSTEM = :UNKNOWN or FS_LINUX_OPERATING_SYSTEM =:IRRESOLVABLE);
COMMIT;
*/
/*
BEGIN TRANSACTION;
-- Clean FS_VA_OS
UPDATE SANDBOX.RAW_FORESCOUT
set FS_VA_OS = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_VA_OS = '''' or FS_VA_OS = :UNKNOWN or FS_VA_OS =:IRRESOLVABLE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''FS_VA_OS'');
*/
BEGIN TRANSACTION;
-- Set OS
UPDATE SANDBOX.RAW_FORESCOUT
set OS = coalesce(OS,FS_VA_OS,FS_LINUX_OPERATING_SYSTEM)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Set OS'');
/*
BEGIN TRANSACTION;
-- Clean OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set OS_CPE = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (OS_CPE = '''' or OS_CPE = :UNKNOWN or OS_CPE =:IRRESOLVABLE or OS_CPE = :DEFAULT_CPE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''Clean OS_CPE'');
*/
/*
BEGIN TRANSACTION;
-- Clean FS_VA_OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set FS_VA_OS_CPE = NULL
where SNAPSHOT_ID = :SNAPSHOT_ID and (FS_VA_OS_CPE = '''' or FS_VA_OS_CPE = :UNKNOWN or FS_VA_OS_CPE = :IRRESOLVABLE or FS_VA_OS_CPE = :DEFAULT_CPE);
COMMIT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,''FS_VA_OS_CPE'');
*/
BEGIN TRANSACTION;
-- Set OS_CPE
UPDATE SANDBOX.RAW_FORESCOUT
set OS_CPE = coalesce(OS_CPE,FS_VA_OS_CPE)
where SNAPSHOT_ID = :SNAPSHOT_ID;
COMMIT;



CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_TENABLE_SOFTWARE"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull software from Tenable using Plugins 20811 and 22869'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_PULL_TENABLE_SOFTWARE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
-- 240121 ApplicabilityCode_Actionable varchar := ''Actionable'';
ApplicabilityCode_Initial varchar := ''Initial'';
MitigationStatus_Open varchar := ''open'';
MitigationStatus_ReOpened varchar := ''reopened'';
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RowDispositionCleaned varchar := ''Cleaned''; -- Data has been cleaned
RowDispositionNotNeeded varchar := ''Not Needed''; -- various reasons e.g. Null CVE
AWS_VulnerabilityDataStream varchar := ''AWS VUL'';
CCIC_VulnerabilityDataStream varchar := ''CCIC VUL'';
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED''; -- 240118
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED''; -- 240118
RECORD_COUNT NUMBER;
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;

-- Plugin 22869	Software Enumeration (SSH)
-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE SANDBOX.ASSETSOFTWARE;

INSERT INTO SANDBOX.ASSETSOFTWARE 
(
DATEINSTALLED
,DW_ASSET_ID
,FIRSTSEEN
,LASTSEEN
,MAJOR
,MINOR
,PRODUCTNAME
,SOFTWARENAME
,SOURCE_TOOL
,SWAM_CATEGORY
,VENDOR
,VERSION
)
select 
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(CORE.FN_CRM_FORMAT_VARCHAR_DATE(substring(f.value::string,(position(CHR(11),f.value::string) + 1),24))) as DATEINSTALLED
,t.dw_asset_id as DW_ASSET_ID
,CURRENT_TIMESTAMP() as FIRSTSEEN
,CURRENT_TIMESTAMP() as LASTSEEN
,NULL as MAJOR
,NULL as MINOR
,substring(f.value::string,1,(position(CHR(11),f.value::string) - 1)) as PRODUCTNAME
, NULL as SOFTWARENAME
,''Tenable'' as SOURCE_TOOL
,''Unknown'' as SWAM_CATEGORY
,NULL as VENDOR
,''TBD'' as VERSION
FROM (select top 100
a.dw_asset_id,
STRTOK_TO_ARRAY(
REPLACE(REPLACE(
substring(plugintext,(position('':   '',plugintext) + 4), (position(''</plugin_output>'',plugintext) - position('':   '',plugintext) - 4))
,''      '',CHR(11)),''  '',CHR(10))
,CHR(10)
) as SWAM_String_Array
from core.raw_tenable_vul r
JOIN core.vw_assets a on a.asset_id_tattoo = r.asset_id_tattoo and a.datacenter_id = r.datacenter_id
where r.plugin_id in (''22869'') and r.snapshot_id = :P_SNAPSHOT_ID) t
join table(flatten(t.SWAM_String_Array,outer=>true)) as f
where NULLIF(substring(f.value::string,1,(position(CHR(11),f.value::string) - 1)),'''') IS NOT NULL;

-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)

INSERT INTO SANDBOX.ASSETSOFTWARE 
(
DATEINSTALLED
,DW_ASSET_ID
,FIRSTSEEN
,LASTSEEN
,MAJOR
,MINOR
,PRODUCTNAME
,SOFTWARENAME
,SOURCE_TOOL
,SWAM_CATEGORY
,VENDOR
,VERSION
)

select 
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(CORE.FN_CRM_FORMAT_VARCHAR_DATE(substring(wf.value::string,(position(''[installed on '',wf.value::string) + 13), position('']'', wf.value::string)-1))) as DATEINSTALLED
,wt.dw_asset_id as DW_ASSET_ID
,CURRENT_TIMESTAMP() as FIRSTSEEN
,CURRENT_TIMESTAMP() as LASTSEEN
,NULLIF(SPLIT_PART(substring(wf.value::string,(position(''[version '',wf.value::string) + 9), position('']'', wf.value::string)-1), ''.'', 1),'''') as MAJOR
,NULLIF(SPLIT_PART(substring(wf.value::string,(position(''[version '',wf.value::string) + 9), position('']'', wf.value::string)-1), ''.'', 2),'''') as MINOR 
,substring(wf.value::string,1,(position(''['',wf.value::string) - 1)) as PRODUCTNAME
,NULL as SOFTWARENAME
,''Tenable'' as SOURCE_TOOL
,''Unknown'' as SWAM_CATEGORY
,''TBD'' as VENDOR
,substring(wf.value::string,(position(''[version '', wf.value::string) + 9), (position('']'', wf.value::string) - 1)) as VERSION

FROM ( select top 100
a.dw_asset_id,
replace(substring(plugintext, 
position('':'', plugintext)+1, (position(''</plugin_output>'',plugintext) - position('':'', plugintext)-1 )), ''The following updates are installed :'', '''') as FilteredText,

case
    when position(''
'' in plugintext) > 0 
    then strtok_to_array(FilteredText, CHR(10))

    else
    regexp_substr_all(FilteredText,''[^\\[]+?(\\[[^\\]]*\\])?\\s*(\\[[^\\]]*\\])?'')
end as WIN_SWAM_String_array

from core.raw_tenable_vul wr
JOIN core.vw_assets a on a.asset_id_tattoo = wr.asset_id_tattoo and a.datacenter_id = wr.datacenter_id
where wr.plugin_id in (''20811'') and wr.snapshot_id = :P_SNAPSHOT_ID
) wt

join table(flatten(wt.WIN_SWAM_String_Array,outer=>true)) as wf
where NULLIF(wf.value::string,'''') IS NOT NULL and wf.value IS NOT NULL;



RECORD_COUNT := SQLROWCOUNT;
Msg := ''Software Written='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_TENABLE_SOFTWARE_TOM"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Stored procedure used to populate SANDBOX.ASSET_SOFTWARE table'
EXECUTE AS OWNER
AS 'DECLARE
Appl varchar := ''SP_CRM_PULL_TENABLE_SOFTWARE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;
SOURCETOOL varchar := ''Tenable'';
PLUGIN_20811_COUNT NUMBER := 0;
PLUGIN_22869_COUNT NUMBER := 0;
PLUGIN_45590_COUNT NUMBER := 0;

-- Plugin 22869	Software Enumeration (SSH)
-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)
-- Plugin 45590 Common Platform Enumeration (CPE)

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL SANDBOX.SP_CRM_START_PROCEDURE (:Appl);


IF (:DATACATEGORY = ''AWS VUL'') THEN
	BEGIN
	Msg := ''WARNING: Temporary disable AWS VUL'';
	CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL SANDBOX.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;


/*****************************************************************************************************
BEGIN TRANSACTION;
INSERT INTO SANDBOX.TEMP_ASSET_SOFTWARE
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
SELECT t.DW_ASSET_ID,t.PLUGIN_ID
,coalesce(NULLIF(split_part(t.RAW_SOFTWARE,''      '',2),''''),''NO INSTALLATION DATE'') as RAW_DATEINSTALLED
,t.RAW_SOFTWARE
,NULL as THEVERSION -- RAW_VERSION
,split_part(THEVERSION,''.'',1) as THEMAJOR
,split_part(split_part(THEVERSION,''.'',2),''.'',1) as THEMINOR
,TRIM(split_part(t.RAW_SOFTWARE,''      '',1)) as THESOFTWARENAME
,:SOURCETOOL as SOURCE_TOOL
,REPLACE(THEVERSION,''NO VERSION'','''') as VERSION
,:P_SNAPSHOT_ID
FROM (
select r.dw_asset_id,r.PLUGIN_ID
,(position(('': '' || CHR(10) || CHR(10)),r.PLUGINTEXT) + 4) as STARTOFSOFTLIST
,(position(''</plugin_output>'',r.PLUGINTEXT)) as ENDOFSOFTLIST
,STRTOK_TO_ARRAY(SUBSTRING(r.PLUGINTEXT,STARTOFSOFTLIST,(ENDOFSOFTLIST - STARTOFSOFTLIST - 4)),CHR(10)) as SOFTARRAY
,TRIM(f.value::string) as RAW_SOFTWARE
FROM SANDBOX.RAW_TENABLE_VUL r
JOIN SANDBOX.VW_ASSETS a on a.DW_ASSET_ID = r.DW_ASSET_ID -- We only want active assets
join table(flatten(SOFTARRAY,outer=>true)) as f
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and r.DW_ASSET_ID IS NOT NULL 
and r.PLUGIN_ID = ''22869'' -- Software Enumeration (SSH)
and NULLIF(TRIM(RAW_SOFTWARE),'''') IS NOT NULL -- Must be non-null
and RAW_SOFTWARE NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Asset_ID%'' -- Exclude asset tags
--  NOT SURE and raw_software NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
) t
;

PLUGIN_22869_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 22869) Written='' || :PLUGIN_22869_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*****************************************************************************************************/


BEGIN TRANSACTION;
INSERT INTO SANDBOX.TEMP_ASSET_SOFTWARE
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
SELECT t.DW_ASSET_ID,t.PLUGIN_ID
,coalesce(NULLIF(split_part(split_part(t.RAW_SOFTWARE,''[installed on '',2),'']'',1),''''),''NO INSTALLATION DATE'') as RAW_DATEINSTALLED
,t.RAW_SOFTWARE
,coalesce(NULLIF(split_part(split_part(t.RAW_SOFTWARE,''[version '',2),'']'',1),''''),''NO VERSION'') as THEVERSION -- RAW_VERSION
,split_part(THEVERSION,''.'',1) as THEMAJOR
,split_part(split_part(THEVERSION,''.'',2),''.'',1) as THEMINOR
,TRIM(split_part(RAW_SOFTWARE,''[version '',1)) as THESOFTWARENAME
,:SOURCETOOL as SOURCE_TOOL
,REPLACE(THEVERSION,''NO VERSION'','''') as VERSION
,:P_SNAPSHOT_ID
FROM (
select r.dw_asset_id,r.PLUGIN_ID
,(position(('':'' || CHR(10)),r.PLUGINTEXT) + 4) as STARTOFSOFTLIST
,(position(''</plugin_output>'',r.PLUGINTEXT)) as ENDOFSOFTLIST
,STRTOK_TO_ARRAY(SUBSTRING(r.PLUGINTEXT,STARTOFSOFTLIST,(ENDOFSOFTLIST - STARTOFSOFTLIST - 4)),CHR(10)) as SOFTARRAY
,TRIM(f.value::string) as RAW_SOFTWARE
FROM CORE.RAW_TENABLE_VUL r
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = r.DW_ASSET_ID -- We only want active assets
join table(flatten(SOFTARRAY,outer=>true)) as f
where r.SNAPSHOT_ID = :P_SNAPSHOT_ID 
and r.DW_ASSET_ID IS NOT NULL 
and r.PLUGIN_ID = ''20811'' -- Microsoft Windows Installed Software Enumeration (credentialed check)
and NULLIF(TRIM(RAW_SOFTWARE),'''') IS NOT NULL -- Must be non-null
and RAW_SOFTWARE NOT like ''%version Primary_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Dependent_FISMA_ID%'' -- Exclude asset tags
and RAW_SOFTWARE NOT like ''%version Asset_ID%'' -- Exclude asset tags
and raw_software NOT REGEXP ''.*KB[0-9]{1,7}.*'' -- Exclude Windows KB; Note: In the future these might be included
) t;

PLUGIN_20811_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 20811) Written='' || :PLUGIN_20811_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
INSERT INTO SANDBOX.TEMP_ASSET_SOFTWARE 
(
DW_ASSET_ID,
PLUGIN_ID,
RAW_DATEINSTALLED,
RAW_SOFTWARE,
RAW_VERSION,
MAJOR,
MINOR,
SOFTWARENAME,
VENDOR,
SOURCE_TOOL,
VERSION,
SNAPSHOT_ID
)
WITH CPE_LIST AS (
    SELECT
        RTV.DW_ASSET_ID
        ,RTV.PLUGIN_ID
        ,RTV.SNAPSHOT_ID
        ,SPLIT(RTV.PLUGINTEXT, CHAR(10)) AS CPE_ARRAY
    FROM 
    CORE.RAW_TENABLE_VUL RTV
    JOIN CORE.VW_ASSETS A ON A.DW_ASSET_ID = RTV.DW_ASSET_ID
    WHERE RTV.PLUGIN_ID = ''45590'' AND RTV.SNAPSHOT_ID = :P_SNAPSHOT_ID
    ),
    EXPLODED AS (
    SELECT 
         C.DW_ASSET_ID
        ,PLUGIN_ID
        ,TRIM(T.value) AS CPE_STRING
        ,SPLIT(CPE_STRING,'':'') AS CPE_ARRAY
    FROM CPE_LIST C,
    LATERAL FLATTEN(INPUT => C.CPE_ARRAY) t
),
FINAL_SPLIT AS (
SELECT 
     EXPLODED.*
    ,REGEXP_SUBSTR(cpe_array[4],''\\\\b\\\\d+(\\\\.\\\\d+)*\\\\b[\\\\sA-Za-z]?'') as RAW_VERSION
    ,split(RAW_VERSION,''.'') AS VERSION_ARRAY
FROM EXPLODED
)
SELECT
    DW_ASSET_ID,
    PLUGIN_ID,
    ''NO INSTALLATION DATE'' AS RAW_DATEINSTALLED,
    CPE_STRING AS RAW_SOFTWARE,
    RAW_VERSION,
    VERSION_ARRAY[0]::string as MAJOR,
    VERSION_ARRAY[1]::string as MINOR,
    CPE_ARRAY[3]::string as SOFTWARE,
    CPE_ARRAY[2]::string as VENDOR,
    :SOURCETOOL AS SOURCE_TOOL,
    RAW_VERSION AS VERSION,
    SNAPSHOT_ID
FROM FINAL_SPLIT
WHERE LEFT(CPE_STRING, 5) = ''cpe:/'';
-- END INSERT

-- LOG RESULT
PLUGIN_45590_COUNT := SQLROWCOUNT;
Msg := ''TEMP_ASSET_SOFTWARE(pluginid 45590) Written='' || :PLUGIN_45590_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

COMMIT;



--------------------------------------------------------------------------
--
-- TEST TO SEE IF THERE IS ANYTHING TO PROCESS, IF NOT, EXIT
--
--------------------------------------------------------------------------

IF ((PLUGIN_20811_COUNT + PLUGIN_22869_COUNT + PLUGIN_45590_COUNT) = 0) THEN
	BEGIN
	Msg := ''WARNING: There is no SWAM data for this snapshot'';
	CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
    CALL SANDBOX.SP_CRM_END_PROCEDURE (:Appl);
	RETURN :Msg;
	END;
END IF;



--------------------------------------------------------------------------
--
-- CHECK FOR VARIOUS DATEINSTALLED FORMATS AND NORMALIZE
--
--------------------------------------------------------------------------

BEGIN TRANSACTION;
-- 
-- 9/9/99
-- 9/9/9999
-- 9/99/99
-- 9/99/9999
-- 99.99.9999
-- 99/9/99
-- 99/9/9999
-- 99/99/99
-- 99/99/9999
-- 9999/99/
-- 9999/99/99
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = REPLACE(REPLACE(REGEXP_SUBSTR(RAW_DATEINSTALLED,''[0-9]{1,4}[(/|\\-|.)][0-9]{1,2}[(/|\\-|.)][0-9]{1,4}''),''/'',''-''),''.'',''-'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,4}[(/|\\-|.)][0-9]{1,2}[(/|\\-|.)][0-9]{1,4}.*'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(wide net)='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Thu Apr 26 11:20:02 EDT 2018
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,25,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,9,2) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][0-9]{2}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(TZ-1))='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
-- Format found in Plugin 22869
-- Fri 01 Apr 2022 01:55:38 PM CDT
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,12,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,8,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,5,2) || '' '' || substring(RAW_DATEINSTALLED,17,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID 
and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][A-Za-z]{2}[ ][A-Za-z]{3}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(TZ-2))='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Tue Feb 28 12:29:52 2023
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,21,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || substring(RAW_DATEINSTALLED,9,2) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][0-9]{2}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(1)='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Sun Jun  2 08:09:28 2024
-- 1234567890123456789012345
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,21,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,10,1)) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ][ ][0-9]{1}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(2))='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Sun 02 Jun 2024 03:02:53 AM
-- Mon 08 Feb 2016 12:13:52 PM
-- 1234567890123456789012345
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = substring(RAW_DATEINSTALLED,12,4) || ''-''
|| case upper(substring(RAW_DATEINSTALLED,8,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,5,2)) || '' '' || substring(RAW_DATEINSTALLED,17,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][0-9]{2}[ ][A-Za-z]{3}[ ][0-9]{4}[ ][0-9]{2}:[0-9]{2}:[0-9]{2}[ ](AM|PM)'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(AMPM))='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- Format found in Plugin 22869
-- Thu Sep 13 12:15:09
-- Sun Jun  2 00:35:19
-- 1234567890123456789012345
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = ''2000-'' -- DEFAULT YEAR TO 2000
|| case upper(substring(RAW_DATEINSTALLED,5,3))
    WHEN ''JAN'' THEN ''01''
    WHEN ''FEB'' THEN ''02''
    WHEN ''MAR'' THEN ''03''
    WHEN ''APR'' THEN ''04''
    WHEN ''MAY'' THEN ''05''
    WHEN ''JUN'' THEN ''06''
    WHEN ''JUL'' THEN ''07''
    WHEN ''AUG'' THEN ''08''
    WHEN ''SEP'' THEN ''09'' 
    WHEN ''OCT'' THEN ''10''
    WHEN ''NOV'' THEN ''11''
    WHEN ''DEC'' THEN ''12''
End || ''-'' || TRIM(substring(RAW_DATEINSTALLED,9,2)) || '' '' || substring(RAW_DATEINSTALLED,12,8)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[A-Za-z]{3}[ ][A-Za-z]{3}[ ]([0-9]{2}|[ ][0-9]{1})[ ][0-9]{2}:[0-9]{2}:[0-9]{2}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999-99-99 hh:mm:ss(NoYear))='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- 2012/11/
-- Add 1st day of month
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = REPLACE(REGEXP_SUBSTR(RAW_DATEINSTALLED,''[0-9]{4}/[0-9]{2}/'') || ''01'',''/'',''-'')
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{4}/[0-9]{2}/'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''REGEXP_LIKE(9999/99/)='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

/*
BEGIN TRANSACTION;
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE
set RAW_DATEINSTALLED = ''LEFTOVER:'' || NULLIF(TRIM(REPLACE(RAW_DATEINSTALLED,'']'','''')),'''')
where RAW_SOFTWARE like ''%[installed on%''
and RAW_DATEINSTALLED IS NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Windows InstalledDate leftovers='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
*/


--
-- CLEAN AND NORMALIZE RAW_DATEINSTALLED FOR CONVERTION TO TIMESTAMP_LTZ
--

BEGIN TRANSACTION;
--
-- 99-99-9999 to 9999-99-99
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = right(RAW_DATEINSTALLED,4) || ''-'' || substring(RAW_DATEINSTALLED,1,LEN(RAW_DATEINSTALLED) - 5)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,2}[-][0-9]{1,2}[-][0-9]{4}'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Reverse year='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

BEGIN TRANSACTION;
--
-- 99-99-20 to 2020-99-99
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set RAW_DATEINSTALLED = ''2020-'' || substring(RAW_DATEINSTALLED,1,LEN(RAW_DATEINSTALLED) - 3)
where SNAPSHOT_ID = :P_SNAPSHOT_ID and REGEXP_LIKE(RAW_DATEINSTALLED,''[0-9]{1,2}[-][0-9]{1,2}[-]20'');

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Year(20)='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

select count(1) INTO :RECORD_COUNT FROM TEMP_ASSET_SOFTWARE WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID and NULLIF(RAW_DATEINSTALLED,'''') IS NULL;
Msg := ''Windows InstalledDate TOBE RESOLVED='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);


BEGIN TRANSACTION;
--
-- Convert RAW_DATEINSTALLED to actual datetime column DATEINSTALLED
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE
set DATEINSTALLED = RAW_DATEINSTALLED::datetime
where SNAPSHOT_ID = :P_SNAPSHOT_ID and TRY_TO_DATE(SUBSTRING(RAW_DATEINSTALLED,1,10),''YYYY-MM-DD'') IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''ActualDatetime='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


/************************************
BEGIN TRANSACTION;
--
-- Confirmed future dates found in data
-- 2040/12/19
--
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE
set RAW_DATEINSTALLED = NULL
where RAW_DATEINSTALLED IS NOT NULL
and (RAW_DATEINSTALLED = '''' -- Empty string
or RAW_DATEINSTALLED::DATE > CURRENT_DATE());

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Future dateinstalled set to null='' || :RECORD_COUNT;
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;
************************************/


BEGIN TRANSACTION;
UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set VENDOR = ''Citrix''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%CITRIX%'';

UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set VENDOR = ''Cisco''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%CISCO%'';

UPDATE SANDBOX.TEMP_ASSET_SOFTWARE 
set VENDOR = ''Microsoft''
where SNAPSHOT_ID = :P_SNAPSHOT_ID and UPPER(SOFTWARENAME) LIKE ''%MICROSOFT%'';

Msg := ''Vendor has been set'';
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;

--------------------------------------------------------------------------
--
-- INSERT/UPDATE SANDBOX.ASSET_SOFTWARE USING SANDBOX.TEMP_ASSET_SOFTWARE
--
--------------------------------------------------------------------------
BEGIN TRANSACTION;
MERGE INTO SANDBOX.ASSET_SOFTWARE as target
USING 
(SELECT MAX(DATEINSTALLED) as DATEINSTALLED,DW_ASSET_ID,MAJOR,MINOR,SOFTWARENAME,SOURCE_TOOL,''TBD'' as SWAM_CATEGORY,''TBD'' as SWAM_SUBCATEGORY,VENDOR,VERSION
    FROM SANDBOX.TEMP_ASSET_SOFTWARE
    WHERE SNAPSHOT_ID = :P_SNAPSHOT_ID
    GROUP BY DW_ASSET_ID,MAJOR,MINOR,SOFTWARENAME,SOURCE_TOOL,SWAM_CATEGORY,SWAM_SUBCATEGORY,VENDOR,VERSION
) as src 

ON (src.DW_ASSET_ID = target.DW_ASSET_ID and src.SOFTWARENAME = target.SOFTWARENAME and src.VERSION = target.VERSION)

WHEN MATCHED THEN UPDATE SET 
    target.LASTSEEN = CURRENT_TIMESTAMP()

WHEN NOT MATCHED THEN INSERT (
    DATEINSTALLED
    ,DW_ASSET_ID
    ,FIRSTSEEN
    ,INSERT_DATE
    ,LASTSEEN
    ,MAJOR
    ,MINOR
    ,SOFTWARENAME
    ,SOURCE_TOOL
    ,SWAM_CATEGORY
    ,SWAM_SUBCATEGORY
    ,VENDOR
    ,VERSION
)
VALUES (
    src.DATEINSTALLED
    ,src.DW_ASSET_ID
    ,CURRENT_TIMESTAMP() -- FIRSTSEEN
    ,CURRENT_TIMESTAMP() -- INSERT_DATE
    ,CURRENT_TIMESTAMP() -- LASTSEEN
    ,src.MAJOR
    ,src.MINOR
    ,src.SOFTWARENAME
    ,src.SOURCE_TOOL
    ,src.SWAM_CATEGORY
    ,src.SWAM_SUBCATEGORY
    ,src.VENDOR
    ,src.VERSION
);

Msg := ''SANDBOX.ASSET_SOFTWARE updated'';
CALL SANDBOX.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
COMMIT;


BEGIN TRANSACTION;
--
-- Update ASSET LASTSEEN_SWAM and SOURCE_TOOL_SWAM
--
UPDATE SANDBOX.ASSET upd
set LASTSEEN_SWAM = sft.LASTSEEN
,SOURCE_TOOL_SWAM = :SOURCETOOL
FROM SANDBOX.ASSET a
JOIN (select DW_ASSET_ID,MAX(LASTSEEN) as LASTSEEN
    from ASSET_SOFTWARE group by DW_ASSET_ID) sft on sft.DW_ASSET_ID = a.DW_ASSET_ID
WHERE upd.DW_ASSET_ID = a.DW_ASSET_ID;
COMMIT;

CALL SANDBOX.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END';
CREATE OR REPLACE PROCEDURE "SP_CRM_PULL_TENABLE_SOFTWARE_TRASH"("P_SNAPSHOT_ID" NUMBER(38,0))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Pull software from Tenable using Plugins 20811 and 22869'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_PULL_TENABLE_SOFTWARE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
-- 240121 ApplicabilityCode_Actionable varchar := ''Actionable'';
ApplicabilityCode_Initial varchar := ''Initial'';
MitigationStatus_Open varchar := ''open'';
MitigationStatus_ReOpened varchar := ''reopened'';
RowDispositionError varchar := ''Error''; 
RowDispositionViable varchar := ''Viable''; -- This is the population being worked on this run. We consider the data innocent until proven guility
RowDispositionCleaned varchar := ''Cleaned''; -- Data has been cleaned
RowDispositionNotNeeded varchar := ''Not Needed''; -- various reasons e.g. Null CVE
AWS_VulnerabilityDataStream varchar := ''AWS VUL'';
CCIC_VulnerabilityDataStream varchar := ''CCIC VUL'';
AWS_VUL_MITIGATED varchar := ''AWS VUL MITIGATED''; -- 240118
CCIC_VUL_MITIGATED varchar := ''CCIC VUL MITIGATED''; -- 240118
RECORD_COUNT NUMBER;
RECORDS_WITH_ERRORS NUMBER;
RECORDS_WITH_WARNINGS NUMBER;
ERROR_COUNT NUMBER;
WARNING_COUNT NUMBER;
DATACATEGORY VARCHAR;
IS_FROM_AWS_FEED BOOLEAN;

-- Plugin 22869	Software Enumeration (SSH)
-- Plugin 20811	Microsoft Windows Installed Software Enumeration (credentialed check)

BEGIN
select DATACATEGORY,IS_FROM_AWS_FEED into :DATACATEGORY,:IS_FROM_AWS_FEED FROM CORE.SNAPSHOT_IDS where SNAPSHOT_ID = :P_SNAPSHOT_ID;
Appl := :Appl || ''('' || DATACATEGORY || '')''; -- This helps to clarify which VUL we are processing
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

TRUNCATE TABLE SANDBOX.ASSETSOFTWARE;

INSERT INTO SANDBOX.ASSETSOFTWARE 
(
DATEINSTALLED
,DW_ASSET_ID
,FIRSTSEEN
,LASTSEEN
,MAJOR
,MINOR
,PRODUCTNAME
,SOURCE_TOOL
,SWAM_CATEGORY
,VENDOR
,VERSION
)
select 
REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(CORE.FN_CRM_FORMAT_VARCHAR_DATE(substring(f.value::string,(position(CHR(11),f.value::string) + 1),24))) as DATEINSTALLED
,0 as DW_ASSET_ID
,CURRENT_TIMESTAMP() as FIRSTSEEN
,CURRENT_TIMESTAMP() as LASTSEEN
,NULL as MAJOR
,NULL as MINOR
,substring(f.value::string,1,(position(CHR(11),f.value::string) - 1)) as PRODUCTNAME
,''Tenable'' as SOURCE_TOOL
,''Unknown'' as SWAM_CATEGORY
,NULL as VENDOR
,NULL as VERSION
FROM (select top 100
STRTOK_TO_ARRAY(
REPLACE(REPLACE(
substring(plugintext,(position('':   '',plugintext) + 4), (position(''</plugin_output>'',plugintext) - position('':   '',plugintext) - 4))
,''      '',CHR(11)),''  '',CHR(10))
,CHR(10)
) as SWAM_String_Array
from raw_tenable_vul r
where r.plugin_id in (''22869'') and r.snapshot_id = :P_SNAPSHOT_ID) t
join table(flatten(t.SWAM_String_Array,outer=>true)) as f
where NULLIF(substring(f.value::string,1,(position(CHR(11),f.value::string) - 1)),'''') IS NOT NULL;

RECORD_COUNT := SQLROWCOUNT;
Msg := ''Software Written='' || :RECORD_COUNT;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_START_PROCEDURE"("P_APPL" VARCHAR(16777216))
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Write Start of Application message to CYBER_RISK_MANAGEMENT Msglog'
EXECUTE AS OWNER
AS 'DECLARE
Appl varchar := ''SP_CRM_START_PROCEDURE'';
ExceptionMsg varchar := ''Default'';
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
BEGIN

BEGIN TRANSACTION;
insert into SANDBOX.MSGLOG (APPL,MSG) VALUES(:P_APPL,''Starting Application'');
COMMIT;

return ''Success'';

EXCEPTION
  when statement_error then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into SANDBOX.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEST_PULL_AWS_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Cron parallel process test: SANDBOX.SP_CRM_TEST_PULL_AWS_HWAM'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_TEST_PULL_AWS_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

select system$wait(67);

Msg := ''Just waited 67 seconds'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEST_PULL_FORESCOUT_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Cron parallel process test: SANDBOX.SP_CRM_TEST_PULL_FORESCOUT_HWAM'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_TEST_PULL_FORESCOUT_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

select system$wait(150);

Msg := ''Just waited 150 seconds'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEST_PULL_HWAM"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Cron parallel process test: SANDBOX.SP_CRM_TEST_PULL_HWAM'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_TEST_PULL_HWAM'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

select system$wait(5);

Msg := ''Just waited 5 seconds'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_TEST_TIMEOUT"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Test: SANDBOX.SP_CRM_TEST_TIMEOUT'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SANDBOX.SP_CRM_TEST_TIMEOUT'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

Msg := ''About to wait 300 secondss'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

select system$wait(300);


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_SNAPSHOT_IDS"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Check CYBER_RISK_MANAGEMENT DB for various inconsistencies'
EXECUTE AS OWNER
AS '
DECLARE
Appl varchar := ''SP_CRM_UPDATE_SNAPSHOT_IDS'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
False boolean := 0;
True boolean := 1;
CURRENT_REPORT_ID NUMBER := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS);
RECORD_COUNT NUMBER;

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);


--
-- INSERT any newer snapshots from CORE table
--
INSERT INTO SANDBOX.SNAPSHOT_IDS (
SNAPSHOT_ID
,COMMENTS
,DATACATEGORY
,ERROR_COUNT
,MAX_DATE
,MIN_DATE
,RECORD_COUNT
,RECORDS_WITH_ERRORS
,RECORDS_WITH_WARNINGS
,SNAPSHOT_DATE
,WARNING_COUNT
,PARENT_DATACATEGORY
,REPORT_ID
,UNASSIGNED_DW_ASSET_ID)
SELECT 
snap.SNAPSHOT_ID
,snap.COMMENTS
,snap.DATACATEGORY
,snap.ERROR_COUNT
,snap.MAX_DATE
,snap.MIN_DATE
,snap.RECORD_COUNT
,snap.RECORDS_WITH_ERRORS
,snap.RECORDS_WITH_WARNINGS
,snap.SNAPSHOT_DATE
,snap.WARNING_COUNT
,snap.PARENT_DATACATEGORY
,snap.REPORT_ID
,snap.UNASSIGNED_DW_ASSET_ID
FROM CORE.SNAPSHOT_IDS snap
LEFT OUTER JOIN SANDBOX.SNAPSHOT_IDS target on target.SNAPSHOT_ID = snap.SNAPSHOT_ID
WHERE target.SNAPSHOT_ID IS NULL;

--
-- INITIALIZE
--
UPDATE SANDBOX.SNAPSHOT_IDS
set TOTAL_DISTINCT_TENABLEUID = 0
,TOTAL_NULL_CVE = 0
,TOTAL_NULL_SEVERITY_NAME = 0
,TOTAL_TATTOO_PLUGINS = 0
,TOTAL_PLUGINS_NOT_TATTOO = 0
,TOTAL_NULL_DATACENTER_ID = 0
,TOTAL_DATACENTER_ID_INVALID = 0
,TOTAL_ERRORS = 0
,TOTAL_IS_FROM_AWS_FEED = 0
,TOTAL_CVSS_IS_ZERO = 0
,TOTAL_SEVERITY_NAME_INFO = 0
,TOTAL_CRITICAL = 0
,TOTAL_HIGH = 0
,TOTAL_MEDIUM = 0
,TOTAL_LOW = 0
,TOTAL_VIABLE = 0
,TOTAL_TENABLEUID_PLUGINID = 0
,TOTAL_TENABLEUID_CVE = 0
;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_DISTINCT_TENABLEUID = t.Total
FROM (select snapshot_id,count(distinct snapshot_id,tenableuuid) as Total from core.raw_tenable_vul group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_NULL_CVE = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where array_size(cve) = 0 group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_NULL_SEVERITY_NAME = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where NULLIF(SEVERITY_NAME,'''') IS NULL group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_TATTOO_PLUGINS = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where PLUGIN_ID IN (''1218405'',''1221295'')  group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_PLUGINS_NOT_TATTOO = t.Total
FROM (select snapshot_id,count(distinct snapshot_id,PLUGIN_ID) as Total from core.raw_tenable_vul where PLUGIN_ID NOT IN (''1218405'',''1221295'') group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_NULL_DATACENTER_ID = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where NULLIF(DATACENTER_ID,'''') IS NULL group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_DATACENTER_ID_INVALID = t.Total
FROM (select r.snapshot_id,count(1) as Total 
    from core.raw_tenable_vul r
    left outer join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    where NULLIF(r.DATACENTER_ID,'''') IS NOT NULL and dc.SYSTEM_ID IS NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

--update SANDBOX.SNAPSHOT_IDS upd
--set TOTAL_ERRORS = t.Total
--FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where array_size(data_error_array) > 0 group by snapshot_id) t
--where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_IS_FROM_AWS_FEED = t.Total
FROM (select r.snapshot_id,count(1) as Total 
    from core.raw_tenable_vul r
    join CORE.SNAPSHOT_IDS snap on snap.snapshot_id = r.snapshot_id
    where snap.datacategory = ''AWS VUL''
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_CVSS_IS_ZERO = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where CVSSV3BASESCORE = 0 group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_SEVERITY_NAME_INFO = t.Total
FROM (select snapshot_id,count(1) as Total from core.raw_tenable_vul where UPPER(SEVERITY_NAME) = ''INFO'' group by snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_CRITICAL = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total 
    from core.raw_tenable_vul r 
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) = ''CRITICAL''
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_HIGH = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total 
    from core.raw_tenable_vul r 
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) = ''HIGH''
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_MEDIUM = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total 
    from core.raw_tenable_vul r
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) = ''MEDIUM''
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_LOW = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total
    from core.raw_tenable_vul r
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) = ''LOW''
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_VIABLE = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total 
    from core.raw_tenable_vul r
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) IN (''CRITICAL'',''HIGH'',''MEDIUM'',''LOW'')
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_TENABLEUID_PLUGINID = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,r.PLUGIN_ID) as Total 
    from core.raw_tenable_vul r 
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) IN (''CRITICAL'',''HIGH'',''MEDIUM'',''LOW'')
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;

update SANDBOX.SNAPSHOT_IDS upd
set TOTAL_TENABLEUID_CVE = t.Total
FROM (select r.snapshot_id,count(distinct r.snapshot_id,r.tenableuuid,f.value::string) as Total 
    from core.raw_tenable_vul r 
    join table(flatten(r.cve,outer=>true)) as f
    join core.systems dc on dc.SYSTEM_ID = r.DATACENTER_ID
    WHERE r.DATACENTER_ID IS NOT NULL 
    and array_size(r.cve) > 0
    and r.PLUGIN_ID NOT IN (''1218405'',''1221295'')
    and array_size(r.data_error_array) = 0
    and r.CVSSV3BASESCORE > 0
    and r.SEVERITY_NAME IS NOT NULL and UPPER(r.SEVERITY_NAME) IN (''CRITICAL'',''HIGH'',''MEDIUM'',''LOW'')
   --  and r.DW_ASSET_ID IS NOT NULL
    group by r.snapshot_id) t
where upd.snapshot_id = t.snapshot_id;


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';
CREATE OR REPLACE PROCEDURE "WINDOWS_SWAM_TABLE_FUNCTION_TEST"()
RETURNS TABLE ("DATEINSTALLED" TIMESTAMP_LTZ(9), "DW_ASSET_ID" NUMBER(38,0), "FIRSTSEEN" TIMESTAMP_LTZ(9), "LASTSEEN" TIMESTAMP_LTZ(9), "MAJOR" VARCHAR(16777216), "MINOR" VARCHAR(16777216), "PRODUCTNAME" VARCHAR(16777216), "SOFTWARENAME" VARCHAR(16777216), "SOURCE_TOOL" VARCHAR(16777216), "SWAM_CATEGORY" VARCHAR(16777216), "VENDOR" VARCHAR(16777216), "VERSION" VARCHAR(16777216), "PLUGIN_LINE" VARCHAR(16777216), "RAW_PLUGIN_TEXT" VARCHAR(16777216), "CATEGORY" VARCHAR(16777216), "EOL_DATE" TIMESTAMP_LTZ(9), "INSERT_DATE" TIMESTAMP_LTZ(9), "RECOMMENDED_VERSION" VARCHAR(16777216), "SUBCATEGORY" VARCHAR(16777216))
LANGUAGE SQL
EXECUTE AS OWNER
AS 'select 
        -- top 100
        REF_LOOKUPS.SHARED.FN_PUB_ANY_TO_TIMESTAMP_LTZ(CORE.FN_CRM_FORMAT_VARCHAR_DATE(substring(wf.value::string,(position(''[installed on '',wf.value::string) + 13), position('']'', wf.value::string)-1))) as DATEINSTALLED
        ,wt.dw_asset_id as DW_ASSET_ID
        ,CURRENT_TIMESTAMP() as FIRSTSEEN
        ,CURRENT_TIMESTAMP() as LASTSEEN
        ,NULLIF(SPLIT_PART(substring(wf.value::string,(position(''[version '',wf.value::string) + 9), position('']'', wf.value::string)-1), ''.'', 1),'''') as MAJOR
        ,NULLIF(SPLIT_PART(substring(wf.value::string,(position(''[version '',wf.value::string) + 9), position('']'', wf.value::string)-1), ''.'', 2),'''') as MINOR 
        ,substring(wf.value::string,1,(position(''['',wf.value::string) - 1)) as PRODUCTNAME
        ,regexp_replace(
            regexp_replace(
                regexp_replace(substring(wf.value::string,1,(position(''['',wf.value::string) - 1)) , ''[v]?[0-9]+([.][0-9]+){1,4}'', '''')
            ,''([(][0-9]{1,2}[/][0-9]{1,2}[/][0-9]{2,4}[)])'','''') 
        ,''( - )'','' '') as SOFTWARENAME
        ,''Tenable'' as SOURCE_TOOL
        ,''Unknown'' as SWAM_CATEGORY --this is datacategory, correct?
        ,''TBD'' as VENDOR
        ,substring(substring(wf.value::string,(position(''[version '', wf.value::string) + 9)), 1,(position('']'', substring(wf.value::string,(position(''[version '', wf.value::string) + 9))) - 1)) as VERSION
        ,''Unknown'' as CATEGORY
        ,CURRENT_TIMESTAMP() as INSERT_DATE
        ,CURRENT_TIMESTAMP() as EOL_DATE
        ,''1'' as RECOMMENDED_VERSION
        ,''Unknown'' as SUBCATEGORY 
        ,wf.value as PLUGIN_LINE
        ,wt.plugintext as RAW_PLUGIN_TEXT

        FROM ( select top 100
            a.dw_asset_id,
            wr.plugintext,
            replace(substring(plugintext, position('':'', plugintext)+1, (position(''</plugin_output>'',plugintext) - position('':'', plugintext)-1 )), ''The following updates are installed :'', '''') as FilteredText,
            
            case
                when position(''
'' in plugintext) > 0 
                then strtok_to_array(FilteredText, CHR(10))
            
                else
                regexp_substr_all(FilteredText,''[^\\[]+?(\\[[^\\]]*\\])?\\s*(\\[[^\\]]*\\)]?'')
            end as WIN_SWAM_String_array
            
            from core.raw_tenable_vul wr
            JOIN core.vw_assets a on a.asset_id_tattoo = wr.asset_id_tattoo and a.datacenter_id = wr.datacenter_id
            where wr.plugin_id in (''20811'') and wr.snapshot_id = 1927
            ) wt
        
        join table(flatten(wt.WIN_SWAM_String_Array,outer=>true)) as wf
        where NULLIF(wf.value::string, '''') IS NOT NULL and wf.value IS NOT NULL
;
';
create or replace schema SHARED;

create or replace secure view SEC_VW_MARKETPLACE_VUL_BUS_MARKETPLACE_MSI(
	COMPONENT_ACRONYM,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	TLC_PHASE,
	REPORT_ID,
	REPORT_DATE,
	IS_ENDOFMONTH,
	DW_VUL_ID,
	CVE,
	DAYSSINCEDISCOVERY,
	IS_BOD,
	BODDUEDATE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	EPSS,
	EPSS_PERCENTILE,
	EXPLOITAVAILABLE,
	FISMASEVERITY,
	MITIGATIONSTATUS,
	DATEMITIGATED,
	FIRSTSEEN,
	LASTFOUND,
	VUL_DATECREATED,
	PLUGIN_ID,
	FAMILY_NAME,
	SIGNATURE,
	SOLUTION,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	BIOS_GUID,
	COMPUTER_TYPE,
	DEVICETYPE,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	MACADDRESS,
	NETBIOSNAME,
	OS,
	OS_VERSION,
	SOURCE_TOOL_LASTSEEN,
	TENABLEUUID,
	VULNRISKTOLERANCE,
	POAM_ID,
	OVERALL_STATUS
) COMMENT='Provides overdue vulns and related asset details for Marketplace Systems only (Historical)'
 as
--
-- Modeled after CORE.VW_VULN_ROLLING60DAYS which is used to create RPT.TEMP_VULN_FV_ROLLING60DAYS which is then
-- used by RPT.VW_VULN_ROLLING60DAYS
--
with 
w_mkpl_systems as (select 
    COMPONENT_ACRONYM
    ,ACRONYM as SYSTEM_ACRONYM
    ,SYSTEM_ID
    ,HVASTATUS
    ,IS_MARKETPLACE
    ,MEFSTATUS
    ,OATO_CATEGORY
    ,TLC_PHASE
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS where IS_MARKETPLACE = true and COMPONENT_ACRONYM not in ('Not specified','FCHCO','CMCHO')),
w_report_ids as (-- Obtain REPORT_ID for the most recent end-of-month data and REPORT_ID for todays data
    (SELECT TOP 1 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH 
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 1 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)
    UNION ALL
    (SELECT TOP 1 REPORT_ID, REPORT_DATE, IS_ENDOFMONTH 
    FROM BUS_CYBER_RISK_MANAGEMENT.CORE.REPORT_IDS WHERE IS_ENDOFMONTH = 0 and IS_VIABLE = 1 ORDER BY REPORT_ID DESC)
    ),
w_assethist as (select 
    ah.DW_ASSET_ID
    ,ah.ASSET_ID_TATTOO
    ,ah.BIOS_GUID
    ,ah.COMPUTER_TYPE
    ,ah.DATACENTER_ID
    ,ah.DEVICETYPE
    ,ah.ENVIRONMENT
    ,r.IS_ENDOFMONTH
    ,ah.OS
    ,ah.OS_VERSION
    ,r.REPORT_DATE
    ,ah.REPORT_ID
    ,ah.SOURCE_TOOL_LASTSEEN
    ,ah.SYSTEM_ID
    ,ah.TENABLEUUID
    ,ah.VULNRISKTOLERANCE
    FROM w_report_ids r
    join BUS_CYBER_RISK_MANAGEMENT.CORE.ASSETHIST ah on ah.REPORT_ID = r.REPORT_ID)
SELECT
--
-- SYSTEM
--
sys.COMPONENT_ACRONYM
,dc.ACRONYM as DATACENTER_ACRONYM
,ah.DATACENTER_ID
,sys.SYSTEM_ACRONYM
,sys.SYSTEM_ID
,sys.HVASTATUS
,sys.IS_MARKETPLACE
,sys.MEFSTATUS
,sys.OATO_CATEGORY
,sys.TLC_PHASE
--
-- REPORT_DATE (Snapshot)
--
,ah.REPORT_ID
,ah.REPORT_DATE
,ah.IS_ENDOFMONTH
--
-- VUL
--
,vh.DW_VUL_ID
,vh.CVE
,DATEDIFF(day,vh.FIRSTSEEN,vh.LASTFOUND) as DAYSSINCEDISCOVERY
,case when coalesce(bodcat.Is_Deleted,1) = 0 then 'Yes' else 'No' end as IS_BOD
,bodcat.BODDUEDATE
,vh.CVSSV2BASESCORE
,vh.CVSSV3BASESCORE
,epss.EPSS
--,case 
--    when epss.EPSS <= 0 then '<=0%'
--    when epss.EPSS > 0 and epss.EPSS <= 0.25 then '> 0% and <= 25%'
--    when epss.EPSS > 0.25 and epss.EPSS <= 0.50 then '> 25% and <= 50%'
--    when epss.EPSS > 0.50 and epss.EPSS <= 0.75 then '> 50% and <= 75%'
--    when epss.EPSS > 0.75 and epss.EPSS <= 1 then '> 75% and <= 100%'
--    ELSE 'NULL'
--    end as EPSS_FILTER
,epss.PERCENTILE as EPSS_PERCENTILE
,vh.EXPLOITAVAILABLE
,vh.FISMASEVERITY
,vh.MITIGATIONSTATUS
,vh.DATEMITIGATED
,vh.FIRSTSEEN
,vh.LASTFOUND
,vh.VUL_DATECREATED
--
-- PLUGIN
--
,plug.PLUGIN_ID
,plug.FAMILY_NAME
,plug.SYNOPSIS as SIGNATURE
,plug.SOLUTION
--
-- ASSET
--
,ah.DW_ASSET_ID
,ah.ASSET_ID_TATTOO
,ah.BIOS_GUID
,ah.COMPUTER_TYPE
,ah.DEVICETYPE
,ah.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,aic.IPV4
,aic.IPV6
,aic.MACADDRESS
,aic.NETBIOSNAME
,ah.OS
,ah.OS_VERSION
,ah.SOURCE_TOOL_LASTSEEN
,ah.TENABLEUUID
,ah.VULNRISKTOLERANCE
--
-- POAM
--
,pom.POAM_ID
,pom.OVERALL_STATUS
FROM w_mkpl_systems sys
join w_assethist ah on ah.SYSTEM_ID = sys.SYSTEM_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.ASSETINTERFACECOALESCEDHIST aic on aic.REPORT_ID = ah.REPORT_ID and aic.DW_ASSET_ID = ah.DW_ASSET_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VW_SYSTEMS dc on dc.SYSTEM_ID = ah.DATACENTER_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VULHIST vh on vh.REPORT_ID = ah.REPORT_ID and vh.DW_ASSET_ID = ah.DW_ASSET_ID
join BUS_CYBER_RISK_MANAGEMENT.CORE.VULMASTER vm on vm.DW_VUL_ID = vh.DW_VUL_ID and vm.DELETIONREASON IS NULL
left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.KEV_CATALOG bodcat on bodcat.CVE = vh.CVE and bodcat.IS_DELETED = 0
--
-- There can be/are multiple PLUGIN_IDs per CVE but only one has traditionally been displayed
--
left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM BUS_CYBER_RISK_MANAGEMENT.CORE.VULPLUGIN vp group by DW_VUL_ID) plugs on (plugs.DW_VUL_ID = vh.DW_VUL_ID)
left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.VULPLUGIN plug on plug.ID = plugs.MAX_VULPLUGIN_ID

left outer join BUS_CYBER_RISK_MANAGEMENT.CORE.POAMHIST pom on pom.REPORT_ID = ah.REPORT_iD and pom.CVE = vh.CVE and pom.SYSTEM_ID = ah.SYSTEM_ID
left outer join REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vh.CVE
WHERE (vh.MitigationStatus in ('open', 'reopened') or (vh.MitigationStatus = 'fixed' 
    and vh.datemitigated > DATEADD(day,-60, ah.REPORT_DATE) and vh.datemitigated <= ah.REPORT_DATE))
;
create or replace view VW_ASSET_SOFTWARE_BUS_MARKETPLACE_MSI(
	COMPONENT_ACRONYM,
	GROUP_ACRONYM,
	HVASTATUS,
	IS_MARKETPLACE,
	MEFSTATUS,
	OATO_CATEGORY,
	TLC_PHASE,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	DATE_ASSET_CREATED,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	IPV4,
	IPV6,
	IS_SCANNABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LASTSEEN_HWAM,
	MACADDRESS,
	NETBIOSNAME,
	OS,
	OS_VERSION,
	SOURCE_TOOL_LASTSEEN,
	DATE_SOFTWARE_CREATED,
	DATE_INSTALLED,
	DW_SWAM_ID,
	FIRSTSEEN,
	LASTSEEN,
	MAJOR,
	MINOR,
	SOFTWARENAME,
	SOURCE_TOOL,
	SWAM_CATEGORY,
	SWAM_SUBCATEGORY,
	VENDOR,
	VERSION
) WITH ROW ACCESS POLICY ACCESS_CONTROL.SECURITY.CRM_RPT_FISMA_POLICY ON (SYSTEM_ID)
 COMMENT='Software associated with each Marketplace asset\t'
 as
select
--
-- System identifying data
--
s.COMPONENT_ACRONYM
,s.GROUP_ACRONYM
,s.HVASTATUS
,s.IS_MARKETPLACE
,s.MEFSTATUS
,s.OATO_CATEGORY
,s.TLC_PHASE
,a.SYSTEM_ACRONYM
,a.SYSTEM_ID
--
-- Asset identifying data
--
,a.ASSET_ID_TATTOO
,a.AWS_INSTANCESTATUS
,TO_CHAR(a.INSERT_DATE,'MM/DD/YYYY') as DATE_ASSET_CREATED
,a.DATACENTER_ACRONYM
,a.DATACENTER_ID
,a.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,upper(a.environment) as ENVIRONMENT
,a.FQDN
,a.HOSTNAME
,a.IPV4
,a.IPV6
,a.IS_SCANNABLE
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.LASTSEEN_HWAM
,a.MACADDRESS
,a.NETBIOSNAME
,a.OS
,a.OS_VERSION
,a.SOURCE_TOOL_LASTSEEN
--
-- Software
--
,TO_CHAR(soft.INSERT_DATE,'MM/DD/YYYY') as DATE_SOFTWARE_CREATED
,TO_CHAR(soft.DATEINSTALLED,'MM/DD/YYYY') as DATE_INSTALLED
,soft.DW_SWAM_ID -- Unique ID representing one Asset/Software
,TO_CHAR(soft.FIRSTSEEN,'MM/DD/YYYY') as FIRSTSEEN
,TO_CHAR(soft.LASTSEEN,'MM/DD/YYYY') as LASTSEEN
,soft.MAJOR
,soft.MINOR
--,soft.PRODUCTNAME
,soft.SOFTWARENAME
,soft.SOURCE_TOOL
,soft.SWAM_CATEGORY
,soft.SWAM_SUBCATEGORY
,soft.VENDOR
,soft.VERSION
FROM CORE.VW_ASSETS a
JOIN CORE.VW_SYSTEMS s on s.SYSTEM_ID = a.SYSTEM_ID
JOIN CORE.ASSET_SOFTWARE soft on soft.DW_ASSET_ID = a.DW_ASSET_ID
;
create or replace view VW_SYSTEMS_BUS_OSORA_CUIOS(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='CRITICAL; View reports FISMA system/datacenter information from CFACTS. It is used throughout CRM\t'
 as
SELECT
s.ACRONYM
,s.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,s.AUTH_COMMENTS
,s.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,s.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
--,(select substring(LISTAGG(distinct ', ' || acc.AWS_ACCOUNTID , ''),2) FROM CORE.SYSTEMSAWSACCOUNTS acc WHERE acc.SYSTEM_ID = s.SYSTEM_ID) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,s.BUSINESS_OWNER
,s.CIO
,s.CISO
,s.CISO_REVIEW_DATE
,s.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_DESCRIPTION
,s.COMPONENT_NAME
,s.COMPONENT_RISK_REPORTS_OVERSIGHT
,s.CONTINGENCYEXPIRATIONDATE
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,s.CP_TEST_DATE
,s.CP_TEST_RESULTS
,s.CRA
,s.CRA_REVIEW_DATE
,s.CYBERVET
,s.DATE_AUTH_MEMO_EXPIRES
,s.DATE_AUTH_MEMO_SIGNED
,s.DATEDELETED
,s.DATEMODIFIED
,s.DCISO
,s.DIVISION_ACRONYM
,s.DIVISION_DESCRIPTION
,s.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,s.E_AUTH_EXP_DATE
,s.E_AUTH_LEVEL
,s.E_AUTH_RISK_ASSESSMENT_DATE
,s.FINANCIAL_SYSTEM
,s.FIPS_199_AVAILABILITY_RATING
,s.FIPS_199_CONFIDENTIALITY_RATING
,s.FIPS_199_INTEGRITY_RATING
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.FIRST_PUBLISHED_DATE
,s.FISMA_SYSTEM
,s.GROUP_ACRONYM
,s.GROUP_DESCRIPTION
,s.GROUP_NAME
,s.HVA_SCORE
,s.HVASTATUS
,s.IN_CMS_CLOUD
,s.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,s.IS_DATACENTER
,s.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_HIGHRISKSYSTEM
,s.IS_MARKETPLACE
,s.IS_OA_READY
,s.IS_OPERATIONALSYSTEM
,s.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_SECURITYHUB_ENABLED
,s.ISRA_REVIEW_DATE
,s.ISRA_STATUS
,s.ISSO
,s.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,s.ISSOCS
,s.LAST_ACT_DATE
,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_ACT_SCA_FINAL_REPORT_DATE
,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_PENTEST_DATE
,s.MEF
,s.MEF_CONTEXT
,s.MEFSTATUS
,s.NEXT_REQUIRED_CP_TEST_DATE
,s.OA_STATUS
,s.OATO_CATEGORY
,s.PACKAGE_TYPE
,s.PIA_014 -- 230621
,s.PIA_EXPIRATION_DATE
,s.PII_PHI
,s.PRIMARY_ISSO
,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,s.SCA
,s.SCA_DATE
,s.SDM
,s.SOP_REVIEW_DATE
,s.STE_DATE
,s.SYSTEM_DESCRIPTION
,s.SYSTEM_ID
,s.TLC_PHASE
,coalesce(a.TOTALASSETS,0) -- 231017 added coalesce
,s.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
WHERE s.IS_PHANTOMSYSTEM = 0 and (s.IS_EXCLUDEFROMREPORTING = 0 or (s.Is_ExcludeFromReporting = 1 and s.Acronym = 'HVA' and a.TotalAssets > 0));
create or replace schema VAT COMMENT='A new Tableau dashboard is expected to replace the views so this is not currently used.';

create or replace view VW_ASSETS(
	ASSET_ID_TATTOO,
	AWS_ACCOUNTID,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_FORESCOUT_MANAGED,
	IS_FROM_AWS_FEED,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	TENANT_ID,
	VULNRISKTOLERANCE
) COMMENT='CRITICAL; View reports active assets from ASSET (MDR) table. It is used throughout CRM\t'
 as
SELECT 
a.ASSET_ID_TATTOO
,a.AWS_ACCOUNTID -- 240530 CR902
,a.AWS_INSTANCESTATUS
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID
,a.COMPUTER_TYPE
,dc.ACRONYM as DATACENTER_ACRONYM
,dc.COMMONNAME as DATACENTER_COMMONNAME
,a.DATACENTER_ID
,a.DATEMODIFIED
,a.DEVICEMODEL
,dr.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,aic.FQDN
,aic.HOSTNAME
,a.INSERT_DATE
,aic.IPV4
,aic.IPV6
,a.IS_APPLICABLE
,a.IS_FORESCOUT_MANAGED -- 240709 CR931
,a.IS_FROM_AWS_FEED -- 240709 CR931
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.IS_TENABLE_CREDENTIALED_SCAN -- 240709 CR931
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,aic.MACADDRESS
,a.MOTHERBOARD
,aic.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,s.ACRONYM as SYSTEM_ACRONYM
,s.COMMONNAME as SYSTEM_COMMONNAME
,s.SYSTEM_ID
,a.TENABLEUUID
,a.TENANT_ID -- CR880 DRaaS Tenant_ID
,a.VULNRISKTOLERANCE
FROM CORE.Asset a
join CORE.VW_SYSTEMS dc on upper(dc.SYSTEM_ID) = upper(a.DATACENTER_ID)
join CORE.VW_SYSTEMS s on upper(s.SYSTEM_ID) = upper(a.SYSTEM_ID)
left outer join CORE.DeviceTypes dt on upper(dt.DEVICETYPE) = upper(a.DEVICETYPE)
left outer join CORE.DeviceRoles dr on upper(dr.DEVICEROLE) = upper(dt.DEVICEROLE)
left outer join CORE.AssetInterfaceCoalesced aic on aic.DW_ASSET_ID = a.DW_ASSET_ID

Where a.Is_Applicable = 1;
create or replace view VW_CREDENTIALSCAN(
	CREDENTIALED_SCAN,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) as
with c as (
select distinct dnsname,IFF(UPPER(replace(credentialed_scan,'\n')) in ('TRUE','FALSE'),replace(credentialed_scan,'\n'),'Unknown') as credentialed_scan from app_tenable.shared.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO where reportdate >= CURRENT_DATE() and plugin_id=19506 
)
select c.credentialed_scan
,a.ASSET_ID_TATTOO
,a.AWS_INSTANCESTATUS
,a.BIGFIX_ASSET_ID
,a.BIOS_GUID
,a.CLOUD_ID
,a.COMPUTER_TYPE
,a.DATACENTER_ACRONYM
,a.DATACENTER_COMMONNAME
,a.DATACENTER_ID
,a.DATEMODIFIED
,a.DEVICEMODEL
,a.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,a.FQDN
,a.HOSTNAME
,a.INSERT_DATE
,a.IPV4
,a.IPV6
,a.IS_APPLICABLE
,a.IS_SCANNABLE
,a.IS_TATTOOABLE
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,a.MACADDRESS
,a.MOTHERBOARD
,a.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CREATE
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,a.SYSTEM_ACRONYM
,a.SYSTEM_COMMONNAME
,a.SYSTEM_ID
,a.TENABLEUUID
,a.VULNRISKTOLERANCE
from core.vw_assets a join c on a.fqdn=c.dnsname or a.hostname=c.dnsname
UNION ALL
select true,
ASSET_ID_TATTOO
,AWS_INSTANCESTATUS
,BIGFIX_ASSET_ID
,BIOS_GUID
,CLOUD_ID
,COMPUTER_TYPE
,DATACENTER_ACRONYM
,DATACENTER_COMMONNAME
,DATACENTER_ID
,DATEMODIFIED
,DEVICEMODEL
,DEVICEROLE
,DEVICETYPE
,DW_ASSET_ID
,ENVIRONMENT
,FQDN
,HOSTNAME
,INSERT_DATE
,IPV4
,IPV6
,IS_APPLICABLE
,IS_SCANNABLE
,IS_TATTOOABLE
,LAST_CONFIRMED_TIME
,LASTASSETUPDATE
,LASTSEEN_CSM
,LASTSEEN_HWAM
,LASTSEEN_SWAM
,LASTSEEN_VUL
,MACADDRESS
,MOTHERBOARD
,NETBIOSNAME
,OS
,OS_CPE
,OS_VERSION
,SOURCE_TOOL_CREATE
,SOURCE_TOOL_CSM
,SOURCE_TOOL_HWAM
,SOURCE_TOOL_LASTSEEN
,SOURCE_TOOL_SWAM
,SOURCE_TOOL_VUL
,SYSTEM_ACRONYM
,SYSTEM_COMMONNAME
,SYSTEM_ID
,TENABLEUUID
,VULNRISKTOLERANCE
from core.vw_assets where aws_instancestatus is not null;
create or replace view VW_CREDENTIALSCAN_OBSOLETE_241024(
	CREDENTIALED_SCAN,
	ASSET_ID_TATTOO,
	AWS_INSTANCESTATUS,
	BIGFIX_ASSET_ID,
	BIOS_GUID,
	CLOUD_ID,
	COMPUTER_TYPE,
	DATACENTER_ACRONYM,
	DATACENTER_COMMONNAME,
	DATACENTER_ID,
	DATEMODIFIED,
	DEVICEMODEL,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_APPLICABLE,
	IS_SCANNABLE,
	IS_TATTOOABLE,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CREATE,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_COMMONNAME,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE
) as
with c as (
select distinct dnsname,IFF(UPPER(replace(credentialed_scan,'\n')) in ('TRUE','FALSE'),replace(credentialed_scan,'\n'),'Unknown') as credentialed_scan from app_tenable.shared.SEC_VW_CCIC_TENABLE_CUMULATIVE_INFO where reportdate >= CURRENT_DATE() and plugin_id=19506 
)
select c.credentialed_scan,a.* from core.vw_assets a join c on a.fqdn=c.dnsname or a.hostname=c.dnsname
UNION ALL
select true,* from core.vw_assets where aws_instancestatus is  not null;
create or replace view VW_CREDENTIALSCAN_V3(
	DATACATEGORY,
	SNAPSHOT_DATE,
	CREDENTIALED_SCAN,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	RAW_DATACENTER_ACRONYM,
	RAW_SYSTEM_ACRONYM,
	IP,
	DNSNAME,
	MDR_PRESENT,
	ASSET_ID_TATTOO,
	CLOUD_ACCOUNT_ID,
	DATACENTER_ACRONYM,
	DATACENTER_ID,
	DEVICEROLE,
	DEVICETYPE,
	DW_ASSET_ID,
	ENVIRONMENT,
	FQDN,
	HOSTNAME,
	INSERT_DATE,
	IPV4,
	IPV6,
	IS_ENDPOINT,
	IS_TENABLE_CREDENTIALED_SCAN,
	LAST_CONFIRMED_TIME,
	LASTASSETUPDATE,
	LASTSEEN_CSM,
	LASTSEEN_HWAM,
	LASTSEEN_SWAM,
	LASTSEEN_VUL,
	MACADDRESS,
	MOTHERBOARD,
	NETBIOSNAME,
	OS,
	OS_CPE,
	OS_VERSION,
	SOURCE_TOOL_CSM,
	SOURCE_TOOL_HWAM,
	SOURCE_TOOL_LASTSEEN,
	SOURCE_TOOL_SWAM,
	SOURCE_TOOL_VUL,
	SYSTEM_ACRONYM,
	SYSTEM_ID,
	TENABLEUUID,
	VULNRISKTOLERANCE,
	CREDENTIALED_FLAG_DIFF,
	DATA_ERROR_ARRAY
) COMMENT='Current Tenable Credentialed Check from plugin 19506'
 as
SELECT snap.DATACATEGORY
,snap.SNAPSHOT_DATE
,CORE.FN_CRM_PARSE_TENABLE_CREDENTIALED_SCAN_V2(PLUGINTEXT) as CREDENTIALED_SCAN
,r.REPOSITORY_ID
,r.REPOSITORY_NAME
,dc.acronym as RAW_DATACENTER_ACRONYM
,s.acronym as RAW_SYSTEM_ACRONYM
,r.IP
,r.DNSNAME
,case when a.dw_asset_id::varchar is null then 'FALSE' else 'TRUE' end as MDR_PRESENT
,a.ASSET_ID_TATTOO
,a.CLOUD_ACCOUNT_ID
,a.DATACENTER_ACRONYM
,a.DATACENTER_ID
,a.DEVICEROLE
,a.DEVICETYPE
,a.DW_ASSET_ID
,a.ENVIRONMENT
,a.FQDN
,a.HOSTNAME
,a.INSERT_DATE
,a.IPV4
,a.IPV6
,a.IS_ENDPOINT
,a.IS_TENABLE_CREDENTIALED_SCAN
,a.LAST_CONFIRMED_TIME
,a.LASTASSETUPDATE
,a.LASTSEEN_CSM
,a.LASTSEEN_HWAM
,a.LASTSEEN_SWAM
,a.LASTSEEN_VUL
,a.MACADDRESS
,a.MOTHERBOARD
,a.NETBIOSNAME
,a.OS
,a.OS_CPE
,a.OS_VERSION
,a.SOURCE_TOOL_CSM
,a.SOURCE_TOOL_HWAM
,a.SOURCE_TOOL_LASTSEEN
,a.SOURCE_TOOL_SWAM
,a.SOURCE_TOOL_VUL
,a.SYSTEM_ACRONYM
,a.SYSTEM_ID
,a.TENABLEUUID
,a.VULNRISKTOLERANCE
,case coalesce(a.dw_asset_id::varchar,'ITSNULL')
    when 'ITSNULL' then 'No MDR, see DATA_ERROR_ARRAY'
    Else case when coalesce(a.IS_TENABLE_CREDENTIALED_SCAN,0) = coalesce(CREDENTIALED_SCAN,0) then 'Same' Else 'Diff' end 
End as Credentialed_Flag_Diff
,array_to_string(data_error_array,',') as DATA_ERROR_ARRAY
FROM core.SNAPSHOT_IDS snap
join core.RAW_TENABLE_VUL r on r.SNAPSHOT_ID = snap.SNAPSHOT_ID
left outer join core.SYSTEMS dc on dc.system_id = r.datacenter_id
left outer join core.SYSTEMS s on s.system_id = r.system_id
left outer join core.VW_ASSETS a on a.dw_asset_id = r.dw_asset_id
where snap.SNAPSHOT_DATE >= current_date() and r.plugin_id = '19506'
;
create or replace view VW_CVE_VULNERABILITIES(
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	ASSET_ID_TATTOO,
	FQDN,
	IPV4,
	DEVICETYPE,
	OS,
	BODDUEDATE,
	CVE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATEMITIGATED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	DW_ASSET_ID,
	DW_VUL_ID,
	EPSS,
	EPSS_PERCENTILE,
	EPSS_CVE_DATE,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_KEV,
	IS_LEGACY,
	LASTFOUND,
	MITIGATIONSTATUS,
	EXTENDED_MITIGATIONSTATUS,
	NUMERIC_SEVERITY,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	DATACENTER_ID,
	SYSTEM_ID
) COMMENT='CVE based vulnerabilities along with EPSS score\t'
 as
SELECT
a.datacenter_acronym
,a.system_acronym
,a.asset_id_tattoo
,a.fqdn
,a.ipv4
,a.devicetype
,a.OS
,TO_CHAR(kev.BODDUEDATE,'MM/DD/YYYY') as BODDUEDATE
,vm.CVE
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,TO_CHAR(vm.DATEMITIGATED,'MM/DD/YYYY') as DATEMITIGATED
,TO_CHAR(vm.DATEREOPENED,'MM/DD/YYYY') as DATEREOPENED
,vm.DAYSSINCEDISCOVERY
,vm.DW_ASSET_ID
,vm.DW_VUL_ID
,epss.EPSS
,epss.PERCENTILE as EPSS_PERCENTILE
,epss.CVE_DATE as EPSS_CVE_DATE
,vm.EXPLOITAVAILABLE
,TO_CHAR(vm.FIRSTSEEN,'MM/DD/YYYY') as FIRSTSEEN
,vm.FISMASEVERITY
,TO_CHAR(vm.INSERT_DATE,'MM/DD/YYYY') as INSERT_DATE
,vm.IS_FROM_AWS_FEED
,case coalesce(kev.ID,0)
    WHEN 0 THEN 0
    ELSE 1
end::boolean as IS_KEV
,vm.IS_LEGACY
,TO_CHAR(vm.LASTFOUND,'MM/DD/YYYY') as LASTFOUND
,vm.MITIGATIONSTATUS
,vm.EXTENDED_MITIGATIONSTATUS
,vm.NUMERIC_SEVERITY
,vm.REPOSITORY_ID
,TO_CHAR(trh.REPOSITORY_LASTSEEN,'MM/DD/YYYY') as REPOSITORY_LASTSEEN
,vm.REPOSITORY_NAME
,a.DATACENTER_ID
,a.SYSTEM_ID
FROM CORE.VULMASTER vm
JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
LEFT OUTER JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE and kev.IS_DELETED = 0
LEFT OUTER JOIN (select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
    FROM CORE.TENABLE_REPOSITORYHIST 
    GROUP BY DATACENTER_ID,REPOSITORY_ID) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vm.REPOSITORY_ID
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = vm.cve
WHERE vm.DELETIONREASON IS NULL;
create or replace view VW_OPEN_PLUGINS(
	DW_VUL_ID,
	DATACENTER_ACRONYM,
	SYSTEM_ACRONYM,
	DW_ASSET_ID,
	ASSET_ID_TATTOO,
	FQDN,
	HOSTNAME,
	IPV4,
	PLUGIN_ID,
	PLUGIN_CVE,
	CVE,
	PLUGIN_MITIGATIONSTATUS,
	CVE_MITIGATIONSTATUS,
	EXTENDED_MITIGATIONSTATUS,
	TOTAL_PLUGIN_COUNT,
	OPEN_PLUGIN_COUNT,
	DELETED_PLUGIN_COUNT,
	FIXED_PLUGIN_COUNT,
	BODDUEDATE,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	DATACENTER_ID,
	DATEMITIGATED,
	DATEMODIFIED,
	DATEREOPENED,
	DAYSSINCEDISCOVERY,
	EXPLOITAVAILABLE,
	FIRSTSEEN,
	FISMASEVERITY,
	INSERT_DATE,
	IS_FROM_AWS_FEED,
	IS_KEV,
	IS_LEGACY,
	LASTFOUND,
	NUMERIC_SEVERITY,
	REPOSITORY_ID,
	REPOSITORY_LASTSEEN,
	REPOSITORY_NAME,
	SYSTEM_ID
) COMMENT='Shows open Tenable vulnerabilities from VULPLUGINS_MASTER and VULMASTER table.\t'
 as
SELECT
vm.dw_vul_id
,a.datacenter_acronym
,a.system_acronym
,vm.DW_ASSET_ID
,a.ASSET_ID_TATTOO
,a.FQDN
,a.HOSTNAME
,a.IPV4
,vpm.PLUGIN_ID
,vpm.PLUGIN_CVE
,vm.CVE
,vpm.mitigationstatus as Plugin_MitigationStatus
,vm.MITIGATIONSTATUS as CVE_Mitigationstatus
,vm.extended_mitigationstatus
,vm.total_plugin_count
,vm.open_plugin_count
,vm.deleted_plugin_count
,vm.fixed_plugin_count
,kev.BODDUEDATE
,vm.CVSSV2BASESCORE
,vm.CVSSV3BASESCORE
,a.DATACENTER_ID
,vm.DATEMITIGATED
,vm.DATEMODIFIED
,vm.DATEREOPENED
,vm.DAYSSINCEDISCOVERY
,vm.EXPLOITAVAILABLE
,vm.FIRSTSEEN
,vm.FISMASEVERITY
,vm.INSERT_DATE
,vm.IS_FROM_AWS_FEED 
,IFF(kev.ID IS NULL,FALSE,TRUE) as IS_KEV
,vm.IS_LEGACY
,vm.LASTFOUND
,vm.NUMERIC_SEVERITY
,vm.REPOSITORY_ID 
,trh.REPOSITORY_LASTSEEN 
,vm.REPOSITORY_NAME 
,a.SYSTEM_ID
FROM (SELECT f.value::string as CVE,v.cve as Plugin_CVE,v.* exclude CVE  FROM CORE.VULPLUGINS_MASTER v, LATERAL flatten(cve) f 
WHERE v.DELETIONREASON IS NULL and UPPER(v.MITIGATIONSTATUS)<>'FIXED') vpm
LEFT JOIN CORE.VULMASTER vm on vpm.DW_ASSET_ID = vm.DW_ASSET_ID and vpm.CVE = vm.CVE and vm.DELETIONREASON IS NULL
LEFT JOIN CORE.VW_ASSETS a on a.DW_ASSET_ID = vm.DW_ASSET_ID
LEFT JOIN CORE.KEV_CATALOG kev on kev.CVE = vm.CVE and kev.IS_DELETED = 0
LEFT JOIN (
select DATACENTER_ID,REPOSITORY_ID,MAX(INSERT_DATE) as REPOSITORY_LASTSEEN
FROM CORE.TENABLE_REPOSITORYHIST GROUP BY DATACENTER_ID,REPOSITORY_ID
) trh on trh.DATACENTER_ID = a.DATACENTER_ID and trh.REPOSITORY_ID = vm.REPOSITORY_ID
;
create or replace view VW_REPORT_IDS(
	REPORT_ID,
	IS_VIABLE,
	IS_ENDOFMONTH,
	REPORT_DATE,
	ASSETS,
	ASSETS_AWS,
	ASSETS_AWS_GOVCLOUD,
	ASSETS_PCT_AWS,
	ASSETS_CREATED_TODAY,
	ASSETS_DELETED_TODAY,
	ASSETS_FORESCOUT_MANAGED,
	ASSETS_NEVER_SCANNED,
	ASSETS_NOT_SCANNED_LAST3DAYS,
	ASSETS_SCANNABLE,
	ASSETS_TENABLE_CREDENTIALED_SCAN,
	ASSETS_UNKNOWN_DEVICETYPE,
	DUPLICATE_DATACENTER_TATTOO_PAIR,
	PCT_TENABLE_CREDENTIALED_SCAN,
	PLUGINS_CREATED_TODAY,
	PLUGINS_CRITICAL,
	PLUGINS_DELETED_TODAY,
	PLUGINS_FIXED_TODAY,
	PLUGINS_HIGH,
	PLUGINS_INACTIVE_ASSET_TODAY,
	PLUGINS_LOW,
	PLUGINS_MEDIUM,
	PLUGINS_OPEN,
	PLUGINS_REOPENED,
	SYSTEMS_DEVELOP,
	SYSTEMS_INITIATE,
	SYSTEMS_OPERATE,
	SYSTEMS_RETIRE,
	TEMP_HWAM_UNASSIGNED_DW_ASSET_ID,
	VUL_AWS,
	VUL_PCT_AWS,
	VUL_CRITICAL,
	VUL_DELETED_TODAY,
	VUL_FIXED_TODAY,
	VUL_GOVCLOUD,
	VUL_HIGH,
	VUL_INACTIVE_ASSET_TODAY,
	VUL_LOW,
	VUL_MEDIUM,
	VUL_OPEN,
	VUL_REOPENED,
	COMMENTS
) COMMENT='Enterprise level view of basic daily totals (Systems,Assets,Vulnerbilities, etc.)\t'
 as
select
REPORT_ID
,IS_VIABLE
,IS_ENDOFMONTH
,substring(REPORT_DATE::varchar,1,10) as REPORT_DATE
,ASSETS
,ASSETS_AWS
,ASSETS_AWS_GOVCLOUD
,((ASSETS_AWS + ASSETS_AWS_GOVCLOUD) / ASSETS) * 100.0 as ASSETS_PCT_AWS
,ASSETS_CREATED_TODAY
,ASSETS_DELETED_TODAY
,ASSETS_FORESCOUT_MANAGED -- 241011
,ASSETS_NEVER_SCANNED
,ASSETS_NOT_SCANNED_LAST3DAYS
,ASSETS_SCANNABLE -- 241011
,ASSETS_TENABLE_CREDENTIALED_SCAN -- 241011
,ASSETS_UNKNOWN_DEVICETYPE
,DUPLICATE_DATACENTER_TATTOO_PAIR
,DIV0(ASSETS_TENABLE_CREDENTIALED_SCAN,ASSETS_SCANNABLE) * 100.0 as PCT_TENABLE_CREDENTIALED_SCAN -- 241011
,PLUGINS_CREATED_TODAY
,PLUGINS_CRITICAL
,PLUGINS_DELETED_TODAY
,PLUGINS_FIXED_TODAY
,PLUGINS_HIGH
,PLUGINS_INACTIVE_ASSET_TODAY
,PLUGINS_LOW
,PLUGINS_MEDIUM
,PLUGINS_OPEN
,PLUGINS_REOPENED
,SYSTEMS_DEVELOP
,SYSTEMS_INITIATE
,SYSTEMS_OPERATE
,SYSTEMS_RETIRE
,TEMP_HWAM_UNASSIGNED_DW_ASSET_ID
,VUL_AWS
,(VUL_AWS + VUL_GOVCLOUD) / (VUL_CRITICAL + VUL_HIGH + VUL_MEDIUM + VUL_LOW) * 100.0 as VUL_PCT_AWS
,VUL_CRITICAL
,VUL_DELETED_TODAY
,VUL_FIXED_TODAY
,VUL_GOVCLOUD
,VUL_HIGH
,VUL_INACTIVE_ASSET_TODAY
,VUL_LOW
,VUL_MEDIUM
,VUL_OPEN
,VUL_REOPENED
,COMMENTS
FROM CORE.REPORT_IDS
where IS_VIABLE = 1 and REPORT_DATE::date >= '2024-02-01'::date -- The date SDW was rolled-out
order by REPORT_ID DESC;
create or replace view VW_SYSTEMS(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='CRITICAL; View reports FISMA system/datacenter information from CFACTS. It is used throughout CRM\t'
 as
SELECT
s.ACRONYM
,s.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,s.AUTH_COMMENTS
,s.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,s.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
--,(select substring(LISTAGG(distinct ', ' || acc.AWS_ACCOUNTID , ''),2) FROM CORE.SYSTEMSAWSACCOUNTS acc WHERE acc.SYSTEM_ID = s.SYSTEM_ID) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,s.BUSINESS_OWNER
,s.CIO
,s.CISO
,s.CISO_REVIEW_DATE
,s.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,s.COMPONENT_ACRONYM
,s.COMPONENT_DESCRIPTION
,s.COMPONENT_NAME
,s.COMPONENT_RISK_REPORTS_OVERSIGHT
,s.CONTINGENCYEXPIRATIONDATE
,s.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,s.CP_TEST_DATE
,s.CP_TEST_RESULTS
,s.CRA
,s.CRA_REVIEW_DATE
,s.CYBERVET
,s.DATE_AUTH_MEMO_EXPIRES
,s.DATE_AUTH_MEMO_SIGNED
,s.DATEDELETED
,s.DATEMODIFIED
,s.DCISO
,s.DIVISION_ACRONYM
,s.DIVISION_DESCRIPTION
,s.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,s.E_AUTH_EXP_DATE
,s.E_AUTH_LEVEL
,s.E_AUTH_RISK_ASSESSMENT_DATE
,s.FINANCIAL_SYSTEM
,s.FIPS_199_AVAILABILITY_RATING
,s.FIPS_199_CONFIDENTIALITY_RATING
,s.FIPS_199_INTEGRITY_RATING
,s.FIPS_199_OVERALL_IMPACT_RATING
,s.FIRST_PUBLISHED_DATE
,s.FISMA_SYSTEM
,s.GROUP_ACRONYM
,s.GROUP_DESCRIPTION
,s.GROUP_NAME
,s.HVA_SCORE
,s.HVASTATUS
,s.IN_CMS_CLOUD
,s.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,s.IS_DATACENTER
,s.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_HIGHRISKSYSTEM
,s.IS_MARKETPLACE
,s.IS_OA_READY
,s.IS_OPERATIONALSYSTEM
,s.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,s.IS_SECURITYHUB_ENABLED
,s.ISRA_REVIEW_DATE
,s.ISRA_STATUS
,s.ISSO
,s.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,s.ISSOCS
,s.LAST_ACT_DATE
,s.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_ACT_SCA_FINAL_REPORT_DATE
,s.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,s.LAST_PENTEST_DATE
,s.MEF
,s.MEF_CONTEXT
,s.MEFSTATUS
,s.NEXT_REQUIRED_CP_TEST_DATE
,s.OA_STATUS
,s.OATO_CATEGORY
,s.PACKAGE_TYPE
,s.PIA_014 -- 230621
,s.PIA_EXPIRATION_DATE
,s.PII_PHI
,s.PRIMARY_ISSO
,s.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,s.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,s.SCA
,s.SCA_DATE
,s.SDM
,s.SOP_REVIEW_DATE
,s.STE_DATE
,s.SYSTEM_DESCRIPTION
,s.SYSTEM_ID
,s.TLC_PHASE
,coalesce(a.TOTALASSETS,0) -- 231017 added coalesce
,s.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
WHERE s.IS_PHANTOMSYSTEM = 0 and (s.IS_EXCLUDEFROMREPORTING = 0 or (s.Is_ExcludeFromReporting = 1 and s.Acronym = 'HVA' and a.TotalAssets > 0));
create or replace view VW_TOP_10_CVE(
	FISMASEVERITY,
	CVE,
	EPSS,
	TOTALASSETS
) COMMENT='Top 10 CVEs for Critical, High, Medium\t'
 as
SELECT t.FISMASEVERITY,t.CVE,epss.epss,t.TOTALASSETS
FROM (
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'Critical' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'High' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,cve,count(1) TOTALASSETS 
from CORE.VW_VULMASTER where fismaseverity = 'Medium' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,cve order by count(1) DESC)
) t
LEFT OUTER JOIN REF_LOOKUPS.PUBLIC.SEC_MV_EPSS_SCORES epss on epss.cve_id = t.cve
order by t.FISMASEVERITY, t.TOTALASSETS DESC
;
create or replace view VW_TOP_10_PLUGIN(
	FISMASEVERITY,
	PLUGIN_ID,
	TOTALASSETS
) COMMENT='Top 10 PLUGIN_IDs for Critical, High, Medium\t'
 as
SELECT t.*
FROM (
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'Critical' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'High' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
UNION ALL
(select top 10 FISMASEVERITY,PLUGIN_ID,count(1) TOTALASSETS 
from CORE.VULPLUGINS_MASTER where DELETIONREASON IS NULL and fismaseverity = 'Medium' and MITIGATIONSTATUS <> 'fixed' group by FISMASEVERITY,PLUGIN_ID order by count(1) DESC)
) t
order by t.FISMASEVERITY, t.TOTALASSETS DESC
;
create or replace view VW_VAT_REPORT(
	FIRSTSEEN,
	LASTFOUND,
	DAYSSINCEDISCOVERY,
	IPV4,
	OS,
	DNSNAME,
	NETBIOSNAME,
	MACADDRESS,
	CVE,
	PLUGIN_ID,
	FAMILYNAME,
	SIGNATURE,
	DESCRIPTION,
	CVSSV2BASESCORE,
	CVSSV3BASESCORE,
	FISMASEVERITY,
	SOLUTION,
	MITIGATIONSTATUS,
	EXPLOITAVAILABLE,
	DATACENTER_ID_DERIVED,
	DW_ASSET_ID,
	DW_VUL_ID,
	DATACENTERACRONYM,
	DATACENTERCOMMONNAME,
	SYSTEMACRONYM,
	SYSTEMCOMMONNAME,
	PRIMARY_FISMA_ID,
	ASSET_ID_TATTOO
) as
SELECT 
vm.firstSeen	-- Orig VAT name: firstSeen
,vm.lastfound	-- Orig VAT name: last_found
,vm.DaysSinceDiscovery	-- Orig VAT name: Days Since Discovery
,a.IPv4 -- Orig VAT name: ip
,a.OS	-- Orig VAT name: OS
,a.FQDN as dnsName -- Orig VAT name: dnsName
,a.netbiosname -- Orig VAT name: netbiosName
,a.macAddress
,vm.CVE	-- Orig VAT name: CVE
,p.plugin_ID --Vplug.pluginid	-- Orig VAT name: pluginID
,p.FAMILY_NAME as familyName	-- Orig VAT name: Family Name
,p.SOLUTION as signature	-- Orig VAT name: Signature
,p.Description -- Orig VAT name: Description
,vm.cvssV2basescore	-- Orig VAT name: CVSSv2 BASE
,vm.cvssV3basescore	-- Orig VAT name: CVSSv3 BASE
,vm.FISMAseverity	-- Orig VAT name: FISMA Severity
,p.solution	-- Orig VAT name: Solution
,vm.MitigationStatus	-- Orig VAT name: state
,vm.exploitAvailable	-- Orig VAT name: Exploit Available
,dc.SYSTEM_ID as datacenter_id_derived	-- Orig VAT name: datacenter_id_derived
,a.DW_ASSET_ID -- NEW Charles Rush approved this for research into issues
,vm.dw_vul_id -- NEW Charles Rush approved this for research into issues
,dc.Acronym as DatacenterAcronym -- 220329 1518
,dc.CommonName as DatacenterCommonName -- 220622 1640 new alias; 220329 1518
,s.Acronym as SystemAcronym -- 220913 1106 CR545
,s.CommonName as SystemCommonName -- 220913 1106 CR545
,s.SYSTEM_ID as primary_fisma_id -- 220913 1106 CR545
,a.asset_id_tattoo -- 220913 1106 CR545
from CORE.VW_VulMaster vm
JOIN CORE.VW_Assets a on a.DW_ASSET_ID = vm.DW_ASSET_ID
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = a.DATACENTER_ID
JOIN CORE.VW_Systems s on s.SYSTEM_ID = a.SYSTEM_ID -- 220622 1640

left outer join (select DW_VUL_ID,max(ID) as MAX_VULPLUGIN_ID FROM CORE.VULPLUGIN group by DW_VUL_ID) plugs on plugs.DW_VUL_ID = vm.dw_vul_id -- 230818
left outer join CORE.VULPLUGIN p on p.ID = plugs.MAX_VULPLUGIN_ID -- 230818

-- 230818 JOIN (select DW_VUL_ID,max(DW_PLUGIN_ID) as plugin_ID -- Desc for plugins change over time and create new master records
-- 230818	FROM CORE.VulPlugin
-- 230818	group by DW_VUL_ID) vsp  on vsp.DW_VUL_ID = vm.DW_VUL_ID
-- 230818 JOIN CORE.Plugins plugs on plugs.DW_PLUGIN_ID = vsp.plugin_ID

WHERE cast(cvssV2basescore as real) >= 7.0 -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL
and vm.MitigationStatus <> 'fixed';
create or replace view VW_VAT_REPORT_SUMMARY(
	SNAPSHOT_DATE,
	DATACENTERACRONYM,
	COMMONNAME,
	ASSETS,
	CRITICALFIXEDINLAST15DAYS,
	CRITICALOPEN,
	CRITICALREOPENED,
	HIGHFIXEDINLAST15DAYS,
	HIGHOPEN,
	HIGHREOPENED,
	RECENTOPENORREOPENCRITCAL,
	RECENTOPENORREOPENHIGH,
	RECENTRAWANYVUL,
	RECENTRAWCRITICAL,
	RECENTRAWHIGH,
	RECENTRAWMEDIUM,
	RECENTRAWLOW
) as
with
q_Datacenters as (select DISTINCT DATACENTER_ID
	FROM CORE.VW_Assets a
),
q_Assets as (select qdc.DATACENTER_ID,count(1) as Total
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
--	where a.Is_Applicable = 1
	group by qdc.DATACENTER_ID
),
q_CriticalFixedInLast15days as (select qdc.DATACENTER_ID,count(1) as Total 
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'Critical' and vm.MitigationStatus = 'fixed'-- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and 
	and datediff(d,vm.datemitigated,CURRENT_TIMESTAMP) <= 15
	group by qdc.DATACENTER_ID
),
q_HighFixedInLast15days as (select qdc.DATACENTER_ID,count(1) as Total 
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where  vm.FISMAseverity = 'High' and vm.MitigationStatus = 'fixed' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and
	and datediff(d,vm.datemitigated,CURRENT_TIMESTAMP) <= 15
	group by qdc.DATACENTER_ID
),
q_CriticalOpen as (select qdc.DATACENTER_ID,count(1) as Total
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'Critical' and vm.MitigationStatus = 'Open' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and 
	group by qdc.DATACENTER_ID
),
q_RecentCriticalOpenOrRepopen as (select qdc.DATACENTER_ID,max(vm.lastfound)::VARCHAR as lastFound -- 220810 1419
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'Critical' and vm.MitigationStatus <> 'fixed' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and
	group by qdc.DATACENTER_ID
),
q_RecentHighOpenOrRepopen as (select qdc.DATACENTER_ID,max(vm.lastfound)::VARCHAR as lastFound -- 220810 1419
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'High' and vm.MitigationStatus <> 'fixed' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and
	group by qdc.DATACENTER_ID
),
q_CriticalReOpened as (select qdc.DATACENTER_ID,count(1) as Total
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'Critical' and vm.MitigationStatus = 'Reopened' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and 
	group by qdc.DATACENTER_ID
),
q_HighOpen as (select qdc.DATACENTER_ID,count(1) as Total
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where  vm.FISMAseverity = 'High' and vm.MitigationStatus = 'Open' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and
	group by qdc.DATACENTER_ID
),
q_HighReOpened as (select qdc.DATACENTER_ID,count(1) as Total
	FROM q_Datacenters qdc
	JOIN CORE.VW_Assets a on a.DATACENTER_ID = qdc.DATACENTER_ID
	join CORE.VW_VulMaster vm on vm.DW_ASSET_ID = a.DW_ASSET_ID
	where vm.FISMAseverity = 'High' and vm.MitigationStatus = 'Reopened' -- a.Is_Applicable = 1 and vm.DeletionReason IS NULL and 
	group by qdc.DATACENTER_ID
),
q_RecentRawVul as (select dc.SYSTEM_ID as DATACENTER_ID, v.INSERT_DATE::VARCHAR as INSERT_DATE
	FROM CORE.VW_Systems  dc
	JOIN (select datacenter_id,max(INSERT_DATE) as INSERT_DATE
	FROM CORE.RAW_TENABLE_VUL 
	group by datacenter_id) v on v.datacenter_id = dc.SYSTEM_ID
),
q_RecentRawCritical as (select dc.SYSTEM_ID as DATACENTER_ID, v.INSERT_DATE::VARCHAR as INSERT_DATE
	FROM CORE.VW_Systems  dc
	JOIN (select datacenter_id,max(INSERT_DATE) as INSERT_DATE
	FROM CORE.RAW_TENABLE_VUL 
	where FISMAseverity = 'Critical'
	group by datacenter_id) v on v.datacenter_id = dc.SYSTEM_ID
),
q_RecentRawHigh as (select dc.SYSTEM_ID as DATACENTER_ID, v.INSERT_DATE::VARCHAR as INSERT_DATE
	FROM CORE.VW_Systems  dc
	JOIN (select datacenter_id,max(INSERT_DATE) as INSERT_DATE
	FROM CORE.RAW_TENABLE_VUL 
	where FISMAseverity = 'High'
	group by datacenter_id) v on v.datacenter_id = dc.SYSTEM_ID
),
q_RecentRawMedium as (select dc.SYSTEM_ID as DATACENTER_ID, v.INSERT_DATE::VARCHAR as INSERT_DATE 
	FROM CORE.VW_Systems  dc
	JOIN (select datacenter_id,max(INSERT_DATE) as INSERT_DATE
	FROM CORE.RAW_TENABLE_VUL 
	where FISMAseverity = 'Medium'
	group by datacenter_id) v on v.datacenter_id = dc.SYSTEM_ID
),
q_RecentRawLow as (select dc.SYSTEM_ID as DATACENTER_ID, v.INSERT_DATE::VARCHAR as INSERT_DATE 
	FROM CORE.VW_Systems  dc
	JOIN (select datacenter_id,max(INSERT_DATE) as INSERT_DATE
	FROM CORE.RAW_TENABLE_VUL 
	where FISMAseverity = 'Low'
	group by datacenter_id) v on v.datacenter_id = dc.SYSTEM_ID
)
SELECT 
(select DISTINCT substring(SNAPSHOT_DATE::VARCHAR,1,16)
	from CORE.VW_REPORTSNAPSHOTS WHERE REPORT_DATE = (SELECT max(vh.REPORT_DATE) from CORE.VW_VULHIST vh)) AS SNAPSHOT_DATE
,dc.Acronym as DatacenterAcronym
,dc.CommonName as CommonName
,qa.Total as Assets
,coalesce(qcf15.Total,0) as CriticalFixedInLast15days 
,coalesce(qco.Total,0) as CriticalOpen
,coalesce(qcr.Total,0) as CriticalReopened
,coalesce(qhf15.Total,0) as HighFixedInLast15days 
,coalesce(qho.Total,0) as HighOpen
,coalesce(qhr.Total,0) as HighReopened
,qrcOpen.lastFound as RecentOpenOrReopenCritcal 
,qrhOpen.lastFound as RecentOpenOrReopenHigh 
,qrv.INSERT_DATE as RecentRawAnyVul
,qrc.INSERT_DATE as RecentRawCritical
,qrh.INSERT_DATE as RecentRawHigh
,qrm.INSERT_DATE as RecentRawMedium
,qrl.INSERT_DATE as RecentRawLow
from q_Datacenters qdc
JOIN CORE.VW_Systems dc on dc.SYSTEM_ID = qdc.DATACENTER_ID
join q_Assets qa on qa.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_CriticalFixedInLast15days qcf15 on qcf15.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_CriticalOpen qco on qco.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_CriticalReOpened qcr on qcr.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_HighFixedInLast15days qhf15 on qhf15.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_HighOpen qho on qho.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_HighReOpened qhr on qhr.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_RecentCriticalOpenOrRepopen qrcOpen on qrcOpen.DATACENTER_ID = qdc.DATACENTER_ID 
left outer join q_RecentHighOpenOrRepopen qrhOpen on qrhOpen.DATACENTER_ID = qdc.DATACENTER_ID 
left outer join q_RecentRawVul qrv on qrv.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_RecentRawCritical qrc on qrc.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_RecentRawHigh qrh on qrh.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_RecentRawMedium qrm on qrm.DATACENTER_ID = qdc.DATACENTER_ID
left outer join q_RecentRawLow qrl on qrl.DATACENTER_ID = qdc.DATACENTER_ID
order by dc.Acronym
;