create or replace view VW_CRMP_TOTALOPENHIGHCRITICALPENTESTFINDINGS(
	ACRONYM,
	TOTALCRITICALOPEN,
	TOTALHIGHOPEN
) COMMENT='No Row'
 as
WITH OpenCritical AS (
SELECT s.Acronym,count(1) TotalOpen
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON  p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and  s.Is_OperationalSystem = 1
and P.Overall_Status IN ('Pending Verification','Ongoing','Delayed','Draft')  
and p.Weakness_Risk_Level = 'Critical'
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym
),
OpenHigh AS(
SELECT s.Acronym,count(1) as TotalOpen
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON  p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and  s.Is_OperationalSystem = 1
and P.Overall_Status IN ('Pending Verification','Ongoing','Delayed','Draft')  
and p.Weakness_Risk_Level = 'High'
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym
)
Select COALESCE(c.Acronym,h.Acronym) AS Acronym 
,coalesce(c.TotalOpen,0) AS TotalCriticalOpen 
,coalesce(h.TotalOpen,0) AS TotalHighOpen
FROM OpenCritical c FULL JOIN OpenHigh h ON c.Acronym=h.Acronym;