create or replace view VW_TENABLE_REPOSITORY_HIST(
	DATACENTER_ID,
	IS_PLUGIN_1218405_RCVD,
	IS_PLUGIN_1221295_RCVD,
	REPOSITORY_DESCRIPTION,
	REPOSITORY_ID,
	REPOSITORY_NAME,
	SNAPSHOT_DATACATEGORY,
	SNAPSHOT_DATE,
	SNAPSHOT_ID,
	TOTALROWS
) COMMENT='Returns history of total Tenable events received from every datacenter/repository with info of pluginid 1218405 and 1221295'
 as
SELECT 
r.DATACENTER_ID,
coalesce(p1218405.IS_PLUGIN_1218405_RCVD,0) as IS_PLUGIN_1218405_RCVD,
coalesce(p1221295.IS_PLUGIN_1221295_RCVD,0) as IS_PLUGIN_1221295_RCVD,
r.REPOSITORY_DESCRIPTION,
r.REPOSITORY_ID,
r.REPOSITORY_NAME,
snap.DATACATEGORY as SNAPSHOT_DATACATEGORY,
snap.SNAPSHOT_DATE,
r.SNAPSHOT_ID,
count(1) TOTALROWS
FROM CORE.RAW_TENABLE_VUL r
LEFT OUTER JOIN CORE.SNAPSHOT_IDS snap on snap.SNAPSHOT_ID = r.SNAPSHOT_ID
LEFT OUTER JOIN (select SNAPSHOT_ID,REPOSITORY_NAME,1 as IS_PLUGIN_1218405_RCVD
    FROM CORE.RAW_TENABLE_VUL where PLUGIN_ID = '1218405'
    GROUP BY SNAPSHOT_ID,REPOSITORY_NAME) as p1218405 on p1218405.SNAPSHOT_ID = r.SNAPSHOT_ID and p1218405.REPOSITORY_NAME = r.REPOSITORY_NAME
LEFT OUTER JOIN (select SNAPSHOT_ID,REPOSITORY_NAME,1 as IS_PLUGIN_1221295_RCVD
    FROM CORE.RAW_TENABLE_VUL where PLUGIN_ID = '1221295'
    GROUP BY SNAPSHOT_ID,REPOSITORY_NAME) as p1221295 on p1221295.SNAPSHOT_ID = r.SNAPSHOT_ID and p1221295.REPOSITORY_NAME = r.REPOSITORY_NAME
GROUP BY r.DATACENTER_ID,
coalesce(p1218405.IS_PLUGIN_1218405_RCVD,0),
coalesce(p1221295.IS_PLUGIN_1221295_RCVD,0),
r.REPOSITORY_DESCRIPTION,
r.REPOSITORY_ID,
r.REPOSITORY_NAME,
snap.DATACATEGORY,
snap.SNAPSHOT_DATE,
r.SNAPSHOT_ID
;