create or replace view VW_CRMP_TOTALDELAYEDHIGHCRITICALPENTESTFINDINGS(
	ACRONYM,
	WEAKNESS_RISK_LEVEL,
	TOTALDELAYED
) COMMENT='Shows total high and critical POAMs with delayed status and pentest audit type,used for CRMP.'
 as
SELECT s.Acronym, p.Weakness_Risk_Level,count(1) TotalDelayed
FROM CORE.VW_Systems s
JOIN CORE.VW_CAATHist c ON s.System_ID = c.System_ID
JOIN CORE.VW_POAMHist p ON p.Report_ID = c.ReportID
 and p.System_ID = c.System_ID	
 and p.POAM_ID = c.Related_POAMs	
WHERE c.SOURCE_AUDIT_TYPE = 'Pentest' 
and P.Overall_Status = 'Delayed' 
and p.Weakness_Risk_Level in ('Critical','High')
and c.ReportID=(SELECT Report_ID from TABLE(FN_CRM_GET_REPORT_ID(0)))
GROUP BY s.acronym,p.Weakness_Risk_Level;