create or replace view VW_SYSTEMS_WORKAROUND(
	ACRONYM,
	ARCHER_TRACKING_ID,
	ATO_EXPIRATION_DATE,
	ATO_REVIEW_DATE,
	AUTH_COMMENTS,
	AUTH_DECISION,
	AUTHORIZATION_MEMO_SIGNED_DATE,
	AUTHORIZATION_PACKAGE,
	AWS_ACCOUNTIDS,
	BO_RECOMMENDATION_REVIEW_DATE,
	BO_REVIEW_DATE,
	BUSINESS_OWNER,
	CIO,
	CISO,
	CISO_REVIEW_DATE,
	CLOUD_SERVICE_PROVIDER,
	COMMONNAME,
	COMPONENT_ACRONYM,
	COMPONENT_DESCRIPTION,
	COMPONENT_NAME,
	COMPONENT_RISK_REPORTS_OVERSIGHT,
	CONTINGENCYEXPIRATIONDATE,
	CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID,
	CP_TEST_DATE,
	CP_TEST_RESULTS,
	CRA,
	CRA_REVIEW_DATE,
	CYBERVET,
	DATE_AUTH_MEMO_EXPIRES,
	DATE_AUTH_MEMO_SIGNED,
	DATEDELETED,
	DATEMODIFIED,
	DCISO,
	DIVISION_ACRONYM,
	DIVISION_DESCRIPTION,
	DIVISION_NAME,
	DSPC_REVIEW_DATE,
	DSPPO_REVIEW_DATE,
	E_AUTH_EXP_DATE,
	E_AUTH_LEVEL,
	E_AUTH_RISK_ASSESSMENT_DATE,
	FINANCIAL_SYSTEM,
	FIPS_199_AVAILABILITY_RATING,
	FIPS_199_CONFIDENTIALITY_RATING,
	FIPS_199_INTEGRITY_RATING,
	FIPS_199_OVERALL_IMPACT_RATING,
	FIRST_PUBLISHED_DATE,
	FISMA_SYSTEM,
	GROUP_ACRONYM,
	GROUP_DESCRIPTION,
	GROUP_NAME,
	HVA_SCORE,
	HVASTATUS,
	IN_CMS_CLOUD,
	INFORMATION_SYSTEM_TYPE,
	INSERT_DATE,
	IS_DATACENTER,
	IS_EXCLUDEFROMREPORTING,
	IS_HIGHRISKSYSTEM,
	IS_MARKETPLACE,
	IS_OA_READY,
	IS_OPERATIONALSYSTEM,
	IS_PHANTOMSYSTEM,
	IS_SECURITYHUB_ENABLED,
	ISRA_REVIEW_DATE,
	ISRA_STATUS,
	ISSO,
	ISSO_COUNT,
	ISSO_REVIEW_DATE,
	ISSO_SUBMISSION_DATE,
	ISSOCS,
	LAST_ACT_DATE,
	LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE,
	LAST_ACT_SCA_FINAL_REPORT_DATE,
	LAST_PENTEST_CAAT_PROCESSED_FILE_DATE,
	LAST_PENTEST_DATE,
	MEF,
	MEF_CONTEXT,
	MEFSTATUS,
	NEXT_REQUIRED_CP_TEST_DATE,
	OA_STATUS,
	OATO_CATEGORY,
	PACKAGE_TYPE,
	PIA_014,
	PIA_EXPIRATION_DATE,
	PII_PHI,
	PRIMARY_ISSO,
	PRIMARY_OPERATING_LOCATION,
	PRIMARY_OPERATING_LOCATION_ACRONYM,
	PRIMARY_OPERATING_LOCATION_ID,
	REASON_FOR_ATO_REQUEST,
	SCA,
	SCA_DATE,
	SDM,
	SOP_REVIEW_DATE,
	STE_DATE,
	SYSTEM_DESCRIPTION,
	SYSTEM_ID,
	TLC_PHASE,
	TOTALASSETS,
	TOTALPOAMWITHAPPROVEDRBD
) COMMENT='CRITICAL; View reports FISMA system/datacenter information from CFACTS. It is used throughout CRM\t'
 as
SELECT
s.ACRONYM
,sh.ARCHER_TRACKING_ID
,s.ATO_EXPIRATION_DATE
,s.ATO_REVIEW_DATE
,sh.AUTH_COMMENTS
,sh.AUTH_DECISION
,s.AUTHORIZATION_MEMO_SIGNED_DATE
,sh.AUTHORIZATION_PACKAGE
,substring(saa.AWS_ACCOUNTIDS,2) as AWS_ACCOUNTIDS 
--,(select substring(LISTAGG(distinct ', ' || acc.AWS_ACCOUNTID , ''),2) FROM CORE.SYSTEMSAWSACCOUNTS acc WHERE acc.SYSTEM_ID = s.SYSTEM_ID) as AWS_ACCOUNTIDS 
,s.BO_RECOMMENDATION_REVIEW_DATE
,s.BO_REVIEW_DATE
,sh.BUSINESS_OWNER
,sh.CIO
,sh.CISO
,s.CISO_REVIEW_DATE
,sh.CLOUD_SERVICE_PROVIDER
,c.COMMONNAME
,sh.COMPONENT_ACRONYM
,sh.COMPONENT_DESCRIPTION
,sh.COMPONENT_NAME
,sh.COMPONENT_RISK_REPORTS_OVERSIGHT
,sh.CONTINGENCYEXPIRATIONDATE
,sh.CONTROL_SET_VERSION_NUMBER_SYSTEM_PROVID
,sh.CP_TEST_DATE
,sh.CP_TEST_RESULTS
,sh.CRA
,s.CRA_REVIEW_DATE
,sh.CYBERVET
,sh.DATE_AUTH_MEMO_EXPIRES
,sh.DATE_AUTH_MEMO_SIGNED
,sh.DATEDELETED
,sh.DATEMODIFIED
,sh.DCISO
,sh.DIVISION_ACRONYM
,sh.DIVISION_DESCRIPTION
,sh.DIVISION_NAME
,s.DSPC_REVIEW_DATE
,s.DSPPO_REVIEW_DATE
,sh.E_AUTH_EXP_DATE
,sh.E_AUTH_LEVEL
,sh.E_AUTH_RISK_ASSESSMENT_DATE
,sh.FINANCIAL_SYSTEM
,sh.FIPS_199_AVAILABILITY_RATING
,sh.FIPS_199_CONFIDENTIALITY_RATING
,sh.FIPS_199_INTEGRITY_RATING
,sh.FIPS_199_OVERALL_IMPACT_RATING
,sh.FIRST_PUBLISHED_DATE
,sh.FISMA_SYSTEM
,sh.GROUP_ACRONYM
,sh.GROUP_DESCRIPTION
,sh.GROUP_NAME
,sh.HVA_SCORE
,sh.HVASTATUS
,sh.IN_CMS_CLOUD
,sh.INFORMATION_SYSTEM_TYPE
,s.INSERT_DATE
,sh.IS_DATACENTER
,sh.IS_EXCLUDEFROMREPORTING -- 230623 added back to support RPT schema, should no longer be used by Tableau
,sh.IS_HIGHRISKSYSTEM
,sh.IS_MARKETPLACE
,sh.IS_OA_READY
,sh.IS_OPERATIONALSYSTEM
,sh.IS_PHANTOMSYSTEM -- 230623 added back to support RPT schema, should no longer be used by Tableau
,sh.IS_SECURITYHUB_ENABLED
,sh.ISRA_REVIEW_DATE
,sh.ISRA_STATUS
,sh.ISSO
,sh.ISSO_COUNT
,s.ISSO_REVIEW_DATE
,s.ISSO_SUBMISSION_DATE
,sh.ISSOCS
,sh.LAST_ACT_DATE
,sh.LAST_ACT_SCA_CAAT_PROCESSED_FILE_DATE -- 230428
,sh.LAST_ACT_SCA_FINAL_REPORT_DATE
,sh.LAST_PENTEST_CAAT_PROCESSED_FILE_DATE -- 230428
,sh.LAST_PENTEST_DATE
,sh.MEF
,sh.MEF_CONTEXT
,sh.MEFSTATUS
,sh.NEXT_REQUIRED_CP_TEST_DATE
,sh.OA_STATUS
,sh.OATO_CATEGORY
,sh.PACKAGE_TYPE
,sh.PIA_014 -- 230621
,sh.PIA_EXPIRATION_DATE
,sh.PII_PHI
,sh.PRIMARY_ISSO
,sh.PRIMARY_OPERATING_LOCATION
,pol.ACRONYM as PRIMARY_OPERATING_LOCATION_ACRONYM
,sh.PRIMARY_OPERATING_LOCATION_ID
,s.REASON_FOR_ATO_REQUEST
,sh.SCA
,sh.SCA_DATE
,sh.SDM
,s.SOP_REVIEW_DATE
,sh.STE_DATE
,sh.SYSTEM_DESCRIPTION
,sh.SYSTEM_ID
,sh.TLC_PHASE
,coalesce(a.TOTALASSETS,0) -- 231017 added coalesce
,sh.TOTALPOAMWITHAPPROVEDRBD
FROM CORE.SYSTEMS s
JOIN CORE.SYSTEMSHIST sh on sh.report_id = 593 and sh.system_id = s.system_id
LEFT OUTER JOIN CORE.SYSTEM_COMMONNAME c on c.SYSTEM_ID = s.SYSTEM_ID
LEFT OUTER JOIN CORE.SYSTEMS pol on pol.SYSTEM_ID = s.PRIMARY_OPERATING_LOCATION_ID
LEFT OUTER JOIN (select SYSTEM_ID,LISTAGG(distinct ', ' || AWS_ACCOUNTID , '') as AWS_ACCOUNTIDS FROM CORE.SYSTEMSAWSACCOUNTS group by SYSTEM_ID) saa on saa.SYSTEM_ID = s.SYSTEM_ID -- 230608
LEFT OUTER JOIN (select SYSTEM_ID,count(1) TotalAssets FROM CORE.ASSET where Is_Applicable = 1 group by SYSTEM_ID) a on a.SYSTEM_ID = s.SYSTEM_ID
WHERE s.IS_PHANTOMSYSTEM = 0 and (s.IS_EXCLUDEFROMREPORTING = 0 or (s.Is_ExcludeFromReporting = 1 and s.Acronym = 'HVA' and a.TotalAssets > 0));