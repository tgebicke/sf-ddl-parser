CREATE OR REPLACE PROCEDURE "SP_CRM_UPDATE_PRIMARY_OP_LOC"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Assign PRIMARY_OPERATING_LOCATION_ID based on first value in PRIMARY_OPERATING_LOCATION'
EXECUTE AS OWNER
AS '

DECLARE
Appl varchar := ''SP_CRM_UPDATE_PRIMARY_OP_LOC'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
DefaultID varchar := CORE.FN_CRM_GETUID_DEFAULT();

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

BEGIN TRANSACTION;

-- Set PRIMARY_OPERATING_LOCATION_ID to NULL
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = :DefaultID; -- 231012

COMMIT;

BEGIN TRANSACTION;

-- Set PRIMARY_OPERATING_LOCATION_ID to a phantom ID that indicates the primary operating location has not been assigned
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = CORE.FN_CRM_GETUID_UNASSIGNED_OPLOC() -- 231012 was hard coded
WHERE NULLIF(PRIMARY_OPERATING_LOCATION,'''') IS NULL;

COMMIT;

BEGIN TRANSACTION;

-- Search Authorization_Package 1st
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEMS dc on upper(dc.Authorization_Package) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Search Acronym 2nd
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEMS dc on upper(dc.ACRONYM) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Search CommonName 3rd
UPDATE CORE.SYSTEMS s
set PRIMARY_OPERATING_LOCATION_ID = dc.SYSTEM_ID
FROM CORE.SYSTEMS pol
JOIN CORE.SYSTEM_COMMONNAME dc on upper(dc.COMMONNAME) = upper(split_part(pol.PRIMARY_OPERATING_LOCATION,'','',1))
WHERE pol.PRIMARY_OPERATING_LOCATION_ID = :DefaultID and pol.SYSTEM_ID = s.SYSTEM_ID;

COMMIT;

BEGIN TRANSACTION;

-- Special; Does not match Autorization Package or Acronym
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = 
CASE upper(split_part(PRIMARY_OPERATING_LOCATION,'','',1))
when ''AMAZON WEB SERVICES'' then ''56FFF52E-175B-4E48-9B38-669C8BC74899'' -- 241024 CR1014
when ''AMAZON WEB SERVICES GOVCLOUD'' then ''5d8a99a8db672340f99cfd721f96190d'' -- 241024 CR1014
when ''AUTONOMIC RESOURCES CLOUD PLATFORM'' then ''B8A904E8-E126-4589-A15D-783E9F65DEE1''
when ''C2C SOLUTIONS INC.'' then ''CD15B586-0B74-4625-94EE-A74A9D0DB12E''
when ''CAHABA'' then ''32B6522E-709A-4550-A475-1476B70BC7B5''
when ''CDS DATA CENTER'' then ''04EAE4CC-6ED2-4E2F-A551-5E23B9D24340''
when ''CGI FEDERAL DATA CENTER'' then ''EDD72375-1795-4395-8B02-DB15F7EC85A0''
when ''CONNOLLY'' then ''DB8E60FE-21FA-4FFC-A3AC-02295B324D63''
when ''GDIT-NEW YORK-MSPSC'' then ''FC7C833D-C6B7-4523-8850-4A0E9958FD0D''
when ''GHI'' then ''F168F3C3-3888-4151-A044-91A16F9B12C5''
when ''HEALTH INTEGRITY'' then ''CB216460-BAEA-4BE5-916B-9B442F66D30A''
when ''IT-CNP'' then ''B4D19F4D-5C47-4E66-89C2-A1EC58027083''
when ''LEWIN GROUP DATA CENTER'' then ''79749F8A-59C7-4AE6-92A4-2F36C3382F05''
when ''MARICOM/CSC'' then ''4AB3EEB6-F7B9-4C03-8600-A937CC139264''
when ''MAXIMUS SUPPORT CENTER'' then ''8EEE4AE4-2D3E-4F74-BB83-ECF3D5D0A748''
when ''MERIDIAN KNOWLEDGE SOLUTIONS'' then ''A48BD76B-ECE3-453E-9BFA-17BB3E7B996F''
when ''MICROSOFT AZURE GOVERNMENT'' then ''FECCCA8B-8161-4E0A-ACA7-788ED45EB9EE''
when ''NATIONAL HERITAGE'' then ''42112E95-FDF1-4262-86F5-13F67165A436''
when ''NDCHEALTH DATA CENTER'' then ''55D4EC76-4917-45EA-A7CF-1DEC4EF11500''
when ''PERFORMANT FINANCIAL CORP'' then ''00A23131-F7D5-4CB0-BBA9-95D571B742CB''
when ''PERSPECTA ENTERPRISE SOLUTIONS TULSA'' then ''8EEED60A-080A-42D3-89C3-C17E2B5261B0''
when ''SALESFORCE.COM'' then ''3F9B8D09-DFEA-4C26-BB1D-81616E6B6159''
when ''SAN DIEGO SUPERCOMPUTER'' then ''933B3E39-BC98-4D67-90F2-20F7FF9C9EB8''
when ''VENTECH-ASHBURN'' then ''DB0B74DC-610A-4D35-B645-B16059B5D64A''
when ''VERIZON-CULPEPPER'' then ''3FE7D025-6CEF-48F7-B141-FB3255532A7E''
when ''VIAWEST DATA CENTER'' then ''56B016BE-FD56-48AD-89A1-2755E0C875BA''
when ''XOC DATA CENTER'' then ''2DD3E858-9229-4358-879C-ED41CB52E3BE''
-- with no Else it yields NULL
END
WHERE PRIMARY_OPERATING_LOCATION_ID = :DefaultID;

COMMIT;

BEGIN TRANSACTION;

-- Use default as safety net
UPDATE CORE.SYSTEMS
set PRIMARY_OPERATING_LOCATION_ID = :DefaultID
WHERE PRIMARY_OPERATING_LOCATION_ID is NULL;

COMMIT;

CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';