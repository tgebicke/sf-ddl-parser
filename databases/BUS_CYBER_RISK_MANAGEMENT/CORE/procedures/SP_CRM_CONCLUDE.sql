CREATE OR REPLACE PROCEDURE "SP_CRM_CONCLUDE"()
RETURNS VARCHAR(16777216)
LANGUAGE SQL
COMMENT='Complete remaining stored procedures to make CRM data ready for reporting'
EXECUTE AS CALLER
AS '

DECLARE
Appl varchar := ''SP_CRM_CONCLUDE'';
ExceptionMsg varchar := ''Default'';
Msg varchar;
StartOfProcedure datetime := current_timestamp();
CRM_logic_exception exception (-20002, ''Raised CRM_logic_exception.'');
REPORT_ID number;
SNAPSHOT_ID number;
RECORD_COUNT NUMBER;
TASK_NAME varchar;
STATE varchar;
ERROR_CODE varchar;
SCHEDULED_TIME datetime;
QUERY_START_TIME datetime;
COMPLETED_TIME datetime;
IS_ALL_TASKS_SUCCEEDED boolean := 1; -- 240607

BEGIN
CALL CORE.SP_CRM_START_PROCEDURE (:Appl);

--ExceptionMsg := ''Test Alert Monitoring''; 
--raise CRM_logic_exception;

--
-- Retrieve REPORT_ID generated by SP_CRM_INITIATE
--
REPORT_ID := (SELECT MAX(REPORT_ID) FROM CORE.REPORT_IDS);
Msg := ''REPORT_ID:'' || :REPORT_ID;
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

--------------------------------------------------------------------------------------------------------------------
--
-- Check to ensure all upstream tasks have been completed - Abort this process if the tasks were not successful
--
--------------------------------------------------------------------------------------------------------------------

TASK_NAME := ''TSK_CRM_INITIATE'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');

CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_AWS_HWAM'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' ''); 
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_FORESCOUT_HWAM'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_KEV_CATALOG'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_CCIC_TENABLE_VUL'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

-- 240828 CR-TBD
TASK_NAME := ''TSK_CRM_CROWDSTRIKE'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   
If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;

TASK_NAME := ''TSK_CRM_IUSG_TENABLE_VUL'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);

If (:STATE IS NULL OR :STATE <> ''SUCCEEDED'') THEN
    IS_ALL_TASKS_SUCCEEDED := 0;
END IF;


-- 241105 CR1024 deleted check for TSK_CRM_MAG_TENABLE_VUL
-- 241024 CR1012 added check for TSK_CRM_MAG_TENABLE_VUL


--
-- 240917 CR981 TSK_CRM_AXONIUS runs at 11:30 am after CONCLUDE so we cannot fail CONCLUDE if it didnt run yesterday
--
TASK_NAME := ''TSK_CRM_AXONIUS'';
SELECT STATE,ERROR_CODE,SCHEDULED_TIME,QUERY_START_TIME,COMPLETED_TIME INTO :STATE,:ERROR_CODE,:SCHEDULED_TIME,:QUERY_START_TIME,:COMPLETED_TIME
    FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) 
    WHERE NAME = :TASK_NAME
    and RUN_ID = (select max(RUN_ID) FROM TABLE(INFORMATION_SCHEMA.TASK_HISTORY()) WHERE NAME = :TASK_NAME and STATE <> ''SCHEDULED'');

Msg := ''TASK: '' || :TASK_NAME || '', STATE: '' || coalesce(:STATE,''Not found'') 
|| coalesce(('',Start_time: '' || TO_CHAR(QUERY_START_TIME,''MM-DD HH:MI'')
|| '',Completion_time: '' || TO_CHAR(COMPLETED_TIME,''MM-DD HH:MI'')
|| '',Elaps_time: '' || TO_CHAR(DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME)) || '':'' || TO_CHAR((DATEDIFF(SEC,QUERY_START_TIME,COMPLETED_TIME) - (DATEDIFF(MIN,QUERY_START_TIME,COMPLETED_TIME) * 60)))),'' '');
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg);
   

   
If (:IS_ALL_TASKS_SUCCEEDED = 0) THEN
    BEGIN
    ExceptionMsg := ''WARNING: One or more tasks failed to complete''; 
    raise CRM_logic_exception;
    END;
END IF;

--------------------------------------------------------------------------------------------------------------------
--
--                                  END CHECK OF UPSTREAM TASKS
--
--------------------------------------------------------------------------------------------------------------------

CALL CORE.SP_CRM_DATAFEED_CHECKER(); -- 240416 CR873

--
-- VUL (Update VULMASTER using VULPLUGINS_MASTER as the driver)
-- We do not pass the snapshot_ID because we are re-evaluating all VULPLUGINS_MASTER records
-- to update the VULMASTER table
--
CALL CORE.SP_CRM_UPDATE_VULCVE_MASTER(); -- Run only one time in the main process
 
CALL CORE.SP_CRM_UPDATE_KEV_CATALOG(); -- Must run after VULMASTER is updated
CALL CORE.SP_CRM_ASSETAGING();

CALL CORE.SP_CRM_CALCULATE_ASSET();
CALL CORE.SP_CRM_WRITE_ASSETINTERFACECOALESCED();
CALL CORE.SP_CRM_WRITE_SUMMARY_TABLES(:REPORT_ID);
CALL CORE.SP_CRM_CRMP_METRICS();
CALL CORE.SP_CRM_TRAL_EVALUATION();

-- 
-- Set REPORT_IDS.Is_EndOfMonth = 1 on the first of the month for the generation of Cyber Risk Reports
--
If (day(current_timestamp()) = 3) then -- For Feb 2025
    BEGIN
    BEGIN TRANSACTION;
    
    UPDATE REPORT_IDS
    set Is_EndOfMonth = 1  -- True
    WHERE REPORT_ID = :REPORT_ID;

    Msg := ''REPORT_IDS.IS_ENDOFMONTH set to TRUE'';
    CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 

    COMMIT;
    END; 
END IF;

CALL CORE.SP_CRM_WRITE_ASSETHIST(:REPORT_ID); -- Added 230428
CALL CORE.SP_CRM_WRITE_VULHIST(:REPORT_ID); -- Added 230424
-- 240507 Moved CALL CORE.SP_CRM_WRITE_REPORTINGTABLES(); -- Added 230606
CALL CORE.SP_CRM_ASSET_SOFTWARE(); -- 240923 CR985
CALL CORE.SP_CRM_UPDATE_REPORT_IDS(); -- Added 231130
CALL CORE.SP_CRM_HEALTH_CHECKER(); -- Added 230726

BEGIN TRANSACTION; -- 240416 CR873 Set REPORT_IDS.IS_VIABLE to TRUE indicating successful completion of all stored procedures
UPDATE CORE.REPORT_IDS
set IS_VIABLE = 1 -- TRUE
WHERE REPORT_ID = :REPORT_ID;

Msg := ''REPORT_IDS.IS_VIABLE set to TRUE'';
CALL CORE.SP_CRM_WRITE_MSGLOG (:Appl,:Msg); 
COMMIT;

CALL CORE.SP_CRM_WRITE_REPORTINGTABLES(); -- 240507

--
-- 240918 1151
-- Send success message to security-datalake-crm-sdw-alerts
--
select CORE.SF_SEND_SLACK_MESSAGE(''(SDW)SP_CRM_CONCLUDE completed successfully'');


CALL CORE.SP_CRM_END_PROCEDURE (:Appl);
return ''Success'';

EXCEPTION
  when statement_error then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Statement_Error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when CRM_logic_exception then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''CRM_logic_exception'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
  when other then
    insert into CORE.ALERTLOG (APPL,CUSTOM_ERRMSG,ERRTYPE,SQLCODE,SQLERRM,SQLSTATE) VALUES(:APPL,:ExceptionMsg,''Other error'',:SQLCODE,:SQLERRM,:SQLSTATE);
    raise;
END
';